<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>K8s浅学 | Joohwan</title><meta name="author" content="Joohwan."><meta name="copyright" content="Joohwan."><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="k8s1、安装（v.1.17.1,docker-cri）1.1 env.bash123456789101112131415161718192021222324252627282930313233343536373839404142434445#!&#x2F;bin&#x2F;bash# 在 master 节点和 worker 节点都要执行# 卸载旧版本yum remove docker \    docker-cli">
<meta property="og:type" content="article">
<meta property="og:title" content="K8s浅学">
<meta property="og:url" content="https://piwriw.github.io/2023/08/16/cloud/k8s/introduce/K8s%E6%B5%85%E5%AD%A6/index.html">
<meta property="og:site_name" content="Joohwan">
<meta property="og:description" content="k8s1、安装（v.1.17.1,docker-cri）1.1 env.bash123456789101112131415161718192021222324252627282930313233343536373839404142434445#!&#x2F;bin&#x2F;bash# 在 master 节点和 worker 节点都要执行# 卸载旧版本yum remove docker \    docker-cli">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://piwriw.github.io/img/kubernetes.png">
<meta property="article:published_time" content="2023-08-16T14:08:55.000Z">
<meta property="article:modified_time" content="2026-02-28T13:29:12.665Z">
<meta property="article:author" content="Joohwan.">
<meta property="article:tag" content="k8s">
<meta property="article:tag" content="introduce">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://piwriw.github.io/img/kubernetes.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "K8s浅学",
  "url": "https://piwriw.github.io/2023/08/16/cloud/k8s/introduce/K8s%E6%B5%85%E5%AD%A6/",
  "image": "https://piwriw.github.io/img/kubernetes.png",
  "datePublished": "2023-08-16T14:08:55.000Z",
  "dateModified": "2026-02-28T13:29:12.665Z",
  "author": [
    {
      "@type": "Person",
      "name": "Joohwan.",
      "url": "https://github.com/Piwriw"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://piwriw.github.io/2023/08/16/cloud/k8s/introduce/K8s%E6%B5%85%E5%AD%A6/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'K8s浅学',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><script src="/js/welcome.js"></script><script src="https://npm.elemecdn.com/echarts@4.9.0/dist/echarts.min.js"></script><link rel="stylesheet" href="/css/categories.css"><link rel="stylesheet" href="/css/tabs.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">259</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">76</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">60</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/charts/"><i class="fa-fw fas fa-folder-open"></i><span> 文章统计</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div><div class="menus_item"><a class="site-page" href="/wish/"><i class="fa-fw fas fa-tags"></i><span> 许愿墙</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/kubernetes.png);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Joohwan</span></a><a class="nav-page-title" href="/"><span class="site-name">K8s浅学</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/charts/"><i class="fa-fw fas fa-folder-open"></i><span> 文章统计</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div><div class="menus_item"><a class="site-page" href="/wish/"><i class="fa-fw fas fa-tags"></i><span> 许愿墙</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">K8s浅学</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-08-16T14:08:55.000Z" title="发表于 2023-08-16 22:08:55">2023-08-16</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2026-02-28T13:29:12.665Z" title="更新于 2026-02-28 21:29:12">2026-02-28</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud/">cloud</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud/k8s/">k8s</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud/k8s/introduce/">introduce</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">4.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>18分钟</span></span><span class="post-meta-separator">|</span><span id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="twikoo_visitors"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><div id="post-outdate-notice" data="{&quot;limitDay&quot;:365,&quot;messagePrev&quot;:&quot;It has been&quot;,&quot;messageNext&quot;:&quot;days since the last update, the content of the article may be outdated.&quot;,&quot;postUpdate&quot;:&quot;2026-02-28 21:29:12&quot;}" hidden></div><h2 id="k8s"><a href="#k8s" class="headerlink" title="k8s"></a>k8s</h2><h1 id="1、安装（v-1-17-1-docker-cri）"><a href="#1、安装（v-1-17-1-docker-cri）" class="headerlink" title="1、安装（v.1.17.1,docker-cri）"></a>1、安装（v.1.17.1,docker-cri）</h1><h2 id="1-1-env-bash"><a href="#1-1-env-bash" class="headerlink" title="1.1 env.bash"></a>1.1 env.bash</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 master 节点和 worker 节点都要执行</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 卸载旧版本</span></span><br><span class="line">yum remove docker \</span><br><span class="line">    docker-client \</span><br><span class="line">    docker-client-latest \</span><br><span class="line">    docker-common \</span><br><span class="line">    docker-latest \</span><br><span class="line">    docker-latest-logrotate \</span><br><span class="line">    docker-logrotate \</span><br><span class="line">    docker-engine</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装并启动 docker(cri)</span></span><br><span class="line">yum install -y docker-ce-19.03.5 docker-ce-cli-19.03.5 containerd.io</span><br><span class="line">systemctl <span class="built_in">enable</span> docker</span><br><span class="line">systemctl start docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭 防火墙</span></span><br><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭 SeLinux</span></span><br><span class="line">setenforce 0</span><br><span class="line">sed -i <span class="string">&quot;s/SELINUX=enforcing/SELINUX=disabled/g&quot;</span> /etc/selinux/config</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭 swap</span></span><br><span class="line">swapoff -a</span><br><span class="line"><span class="built_in">yes</span> | <span class="built_in">cp</span> /etc/fstab /etc/fstab_bak</span><br><span class="line"><span class="built_in">cat</span> /etc/fstab_bak |grep -v swap &gt; /etc/fstab</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改 /etc/sysctl.conf</span></span><br><span class="line"><span class="comment"># 如果有配置，则修改</span></span><br><span class="line">sed -i <span class="string">&quot;s#^net.ipv4.ip_forward.*#net.ipv4.ip_forward=1#g&quot;</span>  /etc/sysctl.conf</span><br><span class="line">sed -i <span class="string">&quot;s#^net.bridge.bridge-nf-call-ip6tables.*#net.bridge.bridge-nf-call-ip6tables=1#g&quot;</span>  /etc/sysctl.conf</span><br><span class="line">sed -i <span class="string">&quot;s#^net.bridge.bridge-nf-call-iptables.*#net.bridge.bridge-nf-call-iptables=1#g&quot;</span>  /etc/sysctl.conf</span><br><span class="line"><span class="comment"># 可能没有，追加</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;net.ipv4.ip_forward = 1&quot;</span> &gt;&gt; /etc/sysctl.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;net.bridge.bridge-nf-call-ip6tables = 1&quot;</span> &gt;&gt; /etc/sysctl.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;net.bridge.bridge-nf-call-iptables = 1&quot;</span> &gt;&gt; /etc/sysctl.conf</span><br><span class="line"><span class="comment"># 执行命令以应用</span></span><br><span class="line">sysctl -p</span><br><span class="line"></span><br><span class="line">docker version				</span><br></pre></td></tr></table></figure>

<h2 id="1-2-k8ssetup-bash"><a href="#1-2-k8ssetup-bash" class="headerlink" title="1.2 k8ssetup.bash"></a>1.2 k8ssetup.bash</h2><h3 id="1-2-1-k8ssetup-yaml"><a href="#1-2-1-k8ssetup-yaml" class="headerlink" title="1.2.1 k8ssetup.yaml"></a>1.2.1 k8ssetup.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeadm.k8s.io/v1beta2</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterConfiguration</span></span><br><span class="line"><span class="attr">kubernetesVersion:</span> <span class="string">v1.17.1</span></span><br><span class="line"><span class="attr">controlPlaneEndpoint:</span> <span class="string">&quot;apiserver.k8s.com:6443&quot;</span></span><br><span class="line"><span class="attr">networking:</span></span><br><span class="line">  <span class="attr">serviceSubnet:</span> <span class="string">&quot;10.96.0.0/16&quot;</span></span><br><span class="line">  <span class="attr">podSubnet:</span> <span class="string">&quot;10.11.10.0/16&quot;</span></span><br><span class="line">  <span class="attr">dnsDomain:</span> <span class="string">&quot;cluster.local</span></span><br></pre></td></tr></table></figure>

<h3 id="1-2-2-k8s-run-setup-single-host-Kubernetes-cluster"><a href="#1-2-2-k8s-run-setup-single-host-Kubernetes-cluster" class="headerlink" title="1.2.2 k8s run setup(single-host Kubernetes cluster)"></a>1.2.2 k8s run setup(single-host Kubernetes cluster)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 初始化k8s</span></span><br><span class="line">kubeadm init --config=k8ssetup.yaml --upload-certs </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">sudo <span class="built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">sudo <span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用calico网络</span></span><br><span class="line">kubectl apply -f https://docs.projectcalico.org/v3.10/manifests/calico.yaml</span><br></pre></td></tr></table></figure>

<h1 id="2、资源管理"><a href="#2、资源管理" class="headerlink" title="2、资源管理"></a>2、资源管理</h1><h2 id="2-1Pod"><a href="#2-1Pod" class="headerlink" title="2.1Pod"></a>2.1Pod</h2><ol>
<li>一个pod的所有容器否运行在同一个节点上；一个pod<strong>不能跨越多个节点</strong></li>
<li>pod的隔离：<ol>
<li>同一个pod的容器的部分隔离，容器上彼此完全隔离的，它们构成了容器组，<strong>拥有同一的命名空间</strong>，因此每一个容器都在相同的network和uts命名空间下，它们共享相同的主机名和网络接口，<strong>它们也在相同的IPC命名空间下运行</strong>，能够进行IPC通信</li>
<li>容器的共享相同的IP和端口空间共享相同的IP地址和端口空间</li>
</ol>
</li>
<li>pod的网络上平铺的，所以pod之间的通信不需要经过nat转换技术，就能进行通信</li>
</ol>
<h3 id="2-1-1创建容器"><a href="#2-1-1创建容器" class="headerlink" title="2.1.1创建容器"></a>2.1.1创建容器</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubecl create -f pod.yaml</span><br></pre></td></tr></table></figure>

<h3 id="2-1-2查看容器"><a href="#2-1-2查看容器" class="headerlink" title="2.1.2查看容器"></a>2.1.2查看容器</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl get po &lt;podname&gt;</span><br><span class="line">kubectl get po &lt;podname&gt; -o yaml</span><br><span class="line">kubectl get po &lt;podname&gt; -o json</span><br></pre></td></tr></table></figure>

<h3 id="2-1-3查看容器日志"><a href="#2-1-3查看容器日志" class="headerlink" title="2.1.3查看容器日志"></a>2.1.3查看容器日志</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker logs &lt;containerid]</span><br><span class="line"><span class="comment">#  --previous  可以获得容器崩溃前，上一个容器的日志</span></span><br><span class="line">kubectl logs &lt;podid&gt; | &lt;podname&gt; -n &lt;pod_namespace&gt; [ --previous]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="2-1-4向pod发送请求"><a href="#2-1-4向pod发送请求" class="headerlink" title="2.1.4向pod发送请求"></a>2.1.4向pod发送请求</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl port-forward &lt;podname&gt; &lt;localport&gt;:&lt;podport&gt;</span><br></pre></td></tr></table></figure>

<h1 id="3、标签管理"><a href="#3、标签管理" class="headerlink" title="3、标签管理"></a>3、标签管理</h1><h2 id="3-1pod"><a href="#3-1pod" class="headerlink" title="3.1pod"></a>3.1pod</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubia-manual-withlabel</span></span><br><span class="line">  <span class="comment">## 标签管理</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">env:</span> <span class="string">prod</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">kubia-manual</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kubia-manual</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">luksa/kubia</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="comment">#  restartPolicy: Always</span></span><br></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改pod标签</span></span><br><span class="line">kubectl label po  kubia-manual-withlabel &lt;<span class="built_in">env</span>=debug&gt; --overwrite</span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过标签，过滤pod</span></span><br><span class="line">kubectl get po -l <span class="built_in">env</span></span><br><span class="line"><span class="comment"># 不包含标签</span></span><br><span class="line">kubectl get po -l <span class="string">&#x27;!env&#x27;</span></span><br><span class="line"><span class="comment"># 有标签，且不为 debug</span></span><br><span class="line">kubectl get po -l <span class="built_in">env</span>!=debug</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用运算符 in|notin|exists</span></span><br><span class="line">kubectl get po -l <span class="string">&#x27;env in (prod,debug)&#x27;</span></span><br><span class="line">kubectl get po -l <span class="string">&#x27;env notin (prod,debug)&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="3-2node"><a href="#3-2node" class="headerlink" title="3.2node"></a>3.2node</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 筛选node</span></span><br><span class="line">kubectl get nodes -l gpu=<span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h3 id="指定调度到特定节点（nodeselector）"><a href="#指定调度到特定节点（nodeselector）" class="headerlink" title="指定调度到特定节点（nodeselector）"></a>指定调度到特定节点（nodeselector）</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubia-manual-label-nodeselector</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">kubia-manual</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="comment"># 标签匹配</span></span><br><span class="line">  <span class="attr">nodeSelector:</span></span><br><span class="line">      <span class="attr">env:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kubia-manual</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">luksa/kubia</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="comment">#  restartPolicy: Always</span></span><br></pre></td></tr></table></figure>



<h2 id="3-3命名空间（namespace）"><a href="#3-3命名空间（namespace）" class="headerlink" title="3.3命名空间（namespace）"></a>3.3命名空间（namespace）</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看所有ns</span></span><br><span class="line">kubectl get ns -A</span><br><span class="line"><span class="comment"># 查看一个命名空间下的pod</span></span><br><span class="line">kubectl get po -ns default</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除ns，会删除旗下所有pod</span></span><br><span class="line">kubectl delete ns &lt;joohwan-ns&gt;</span><br><span class="line"><span class="comment"># 删除ns所有pod，不删除pod</span></span><br><span class="line">kubectl delete ns &lt;joohwan-ns&gt; --all</span><br><span class="line"><span class="comment"># 删除ns几乎所有资源（部分资源比如service，删除之后会被重建）</span></span><br><span class="line">kubectl delete all -all</span><br></pre></td></tr></table></figure>

<h3 id="创建ns"><a href="#创建ns" class="headerlink" title="创建ns"></a>创建ns</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">joohwan-ns</span></span><br></pre></td></tr></table></figure>

<h1 id="4、控制器"><a href="#4、控制器" class="headerlink" title="4、控制器"></a>4、控制器</h1><h2 id="4-1探针"><a href="#4-1探针" class="headerlink" title="4.1探针"></a>4.1探针</h2><h3 id="4-1-1存活探针"><a href="#4-1-1存活探针" class="headerlink" title="4.1.1存活探针"></a>4.1.1存活探针</h3><p>三种探测容器的机制：</p>
<ol>
<li>HTTP Get探针对容器IP地址（自定义制定的端口和路径）执行Http Get请求，探测收到rsp（状态吗2xx｜3xx），容器处于正常，不然<strong>要求重启容器</strong></li>
<li>TCP套接字尝试与端口进行链接，如果连接成功建立，则探测成功，不然就<strong>重启容器</strong></li>
<li>Exce探针在容器内执行任意命令，检查命令的退出状态码，状态码为0，探测成功，不然其他状态码都是failed</li>
</ol>
<h4 id="基于Http的存活探针"><a href="#基于Http的存活探针" class="headerlink" title="基于Http的存活探针"></a>基于Http的存活探针</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubia-liveness</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">kubia-liveness</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kubia-liveness</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">luksa/kubia-unhealthy</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">      <span class="comment"># 设置存活探针</span></span><br><span class="line">      <span class="attr">livenessProbe:</span></span><br><span class="line">        <span class="attr">httpGet:</span></span><br><span class="line">          <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">initialDelaySeconds:</span> <span class="number">15</span></span><br><span class="line">        <span class="attr">timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line">        <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line">  </span><br></pre></td></tr></table></figure>

<h3 id="4-1-2就绪探针"><a href="#4-1-2就绪探针" class="headerlink" title="4.1.2就绪探针"></a>4.1.2就绪探针</h3><p>就绪探针会定期调用，并确定特定的Pod是否接受客户端请求。</p>
<p>当容易的准备就绪返回时候，标识容器准备好接收请求</p>
<p>一共有三种就绪探针：</p>
<ol>
<li><p>Exec探针，执行进程的时候吗。容器的状态由进程的退出状态码确定</p>
</li>
<li><p>Http Get探针，向容器发送HTTP Get请求，通过响应Http状态码来判断 探针是否准备好</p>
</li>
<li><p>TCP Socket探针，它打开一个TCP连接到容器的指定容器。如果连接已建立，则认为容器已准备就绪</p>
</li>
</ol>
<p>就绪探针的工作流程：</p>
<p>就绪探针会在每个一段时间调用，当Pod被报告为尚未就绪，会从服务中删除该Pod直到再次准备就绪。</p>
<p>与存活探针的不同，<strong>存活探针主要是杀死异常的，并重建新的pod</strong>，就绪探针<strong>容器不通过检查，不会被终止或重新启动</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">hellok8s-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">     <span class="attr">rollingUpdate:</span></span><br><span class="line">      <span class="attr">maxSurge:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">maxUnavailable:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">hellok8s</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">hellok8s</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">guangzhengli/hellok8s:bad</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">hellok8s-container</span></span><br><span class="line">          <span class="comment">#就绪探针</span></span><br><span class="line">          <span class="attr">readinessProbe:</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/healthz</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">3000</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">successThreshold:</span> <span class="number">5</span></span><br></pre></td></tr></table></figure>



<h2 id="4-2-ReplicationController"><a href="#4-2-ReplicationController" class="headerlink" title="4.2 ReplicationController"></a>4.2 ReplicationController</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicationController</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubia-rc</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">kubia-rc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="comment"># pod数量</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="comment">#匹配管理pod</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">kubia-rc</span></span><br><span class="line">   <span class="comment">#pod模版文件</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">kubia-rc</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kubia-rc</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">luksa/kubia</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure>



<h3 id="4-2-1将pod移入或移出ReplicationController的作用域"><a href="#4-2-1将pod移入或移出ReplicationController的作用域" class="headerlink" title="4.2.1将pod移入或移出ReplicationController的作用域"></a>4.2.1将pod移入或移出ReplicationController的作用域</h3><ol>
<li>通过修改pod的label标签来实现，达到与RC能匹配</li>
<li>如果中途pod标签被取消，它将成为一个普通的pod，但是<strong>RC会认为缺少了一个pod，会重建一个新的pod</strong></li>
<li>如果修改RC的label选择器，那么<strong>原来的pod就脱离了控制</strong>，而RC会<strong>重新新建pod</strong></li>
</ol>
<h3 id="4-2-2修改pod-模版"><a href="#4-2-2修改pod-模版" class="headerlink" title="4.2.2修改pod 模版"></a>4.2.2修改pod 模版</h3><ol>
<li><strong>修改pod模版，只会影响之后的pod，不影响已经运行的pod</strong></li>
<li>RC的pod的缩容和扩容<ol>
<li><code>kubectl edit spec.replicas</code></li>
<li><code>kubectl scale rc kubia --replicas=of 5</code></li>
</ol>
</li>
</ol>
<h3 id="4-2-3删除RC"><a href="#4-2-3删除RC" class="headerlink" title="4.2.3删除RC"></a>4.2.3删除RC</h3><ol>
<li>一般的RC删除之后pod也会随之删除，但是RC只是管理，<strong>可以删除RC不删除pod</strong></li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 --cascade=false </span></span><br><span class="line">kubectl delete rc kubia-rc --cascade=<span class="literal">false</span></span><br></pre></td></tr></table></figure>

<h2 id="4-3-ReplicaSet-RC进化版，更优秀"><a href="#4-3-ReplicaSet-RC进化版，更优秀" class="headerlink" title="4.3 ReplicaSet(RC进化版，更优秀)"></a>4.3 ReplicaSet(RC进化版，更优秀)</h2><ol>
<li>RS允许匹配缺少某个标签的pod，或者包含某个特定标签的pod</li>
</ol>
<h2 id="4-4-Job"><a href="#4-4-Job" class="headerlink" title="4.4 Job"></a>4.4 Job</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Job</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">batch-job</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">batch-app</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">OnFailure</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">main</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">luksa/batch-job</span></span><br></pre></td></tr></table></figure>

<p>运行单个任务的pod，运行完成任务之后不会重启</p>
<h3 id="4-4-1顺序运行job-pod"><a href="#4-4-1顺序运行job-pod" class="headerlink" title="4.4.1顺序运行job pod"></a>4.4.1顺序运行job pod</h3><p>一个job运行多次，设置completions</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="comment"># 会一个一个创建pod，一个pod结束再创建下一个</span></span><br><span class="line">	<span class="attr">completions:</span> <span class="number">5</span></span><br></pre></td></tr></table></figure>

<h3 id="4-4-2并行运行job-pod"><a href="#4-4-2并行运行job-pod" class="headerlink" title="4.4.2并行运行job pod"></a>4.4.2并行运行job pod</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">	<span class="attr">completions:</span> <span class="number">5</span></span><br><span class="line">	<span class="comment"># 设置最大并行数量</span></span><br><span class="line">	<span class="attr">parllelism:</span> <span class="number">2</span></span><br><span class="line">	<span class="string">...</span></span><br></pre></td></tr></table></figure>

<h3 id="4-4-3job的缩放"><a href="#4-4-3job的缩放" class="headerlink" title="4.4.3job的缩放"></a>4.4.3job的缩放</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl scale job multi-completion-batch-job --replacs 3</span><br></pre></td></tr></table></figure>

<h3 id="4-4-4限制job-pod完成任务时间"><a href="#4-4-4限制job-pod完成任务时间" class="headerlink" title="4.4.4限制job pod完成任务时间"></a>4.4.4限制job pod完成任务时间</h3><p>指定pod中的activeDeadlineSeconds</p>
<h3 id="job定期运行（Crodjob）"><a href="#job定期运行（Crodjob）" class="headerlink" title="job定期运行（Crodjob）"></a>job定期运行（Crodjob）</h3><p>Cronjob创建Job-&gt;Job创建pod</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CronJob</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cronjon</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># 在什么时候运行</span></span><br><span class="line">  <span class="attr">schedule:</span> <span class="string">&quot;0,15,30,45&quot;</span> <span class="comment">#	Run every minute</span></span><br><span class="line">  <span class="comment"># pod最迟在预定时间15s开始运行</span></span><br><span class="line">  <span class="attr">startingDeadlineSeconds:</span> <span class="number">15</span></span><br><span class="line">  <span class="attr">jobTemplate:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">template:</span></span><br><span class="line">        <span class="attr">spec:</span></span><br><span class="line">          <span class="attr">containers:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cronjon</span></span><br><span class="line">              <span class="attr">image:</span> <span class="string">busybox:latest</span></span><br><span class="line">              <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">              <span class="attr">command:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">date;</span> <span class="string">echo</span> <span class="string">Hello!</span></span><br><span class="line">          <span class="attr">restartPolicy:</span> <span class="string">OnFailure</span></span><br></pre></td></tr></table></figure>

<h1 id="5-Service"><a href="#5-Service" class="headerlink" title="5.Service"></a>5.Service</h1><p>为一组相同功能的pod提供单一的不变的接入点</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl expose 创建</span><br></pre></td></tr></table></figure>

<h3 id="5-1-如何在一个已有的pod，访问service"><a href="#5-1-如何在一个已有的pod，访问service" class="headerlink" title="5.1 如何在一个已有的pod，访问service"></a>5.1 如何在一个已有的pod，访问service</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -- 代表kubectl结束，后面是在pod中执行的参数（--不是必须，在不出现歧义的时候，可以不加）</span></span><br><span class="line">kubectl <span class="built_in">exec</span> &lt;pod&gt; -- curl -s &lt;http://serviceip&gt;</span><br></pre></td></tr></table></figure>

<h2 id="5-2配置每次请求来自于同一个pod"><a href="#5-2配置每次请求来自于同一个pod" class="headerlink" title="5.2配置每次请求来自于同一个pod"></a>5.2配置每次请求来自于同一个pod</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="comment"># 所有 同一个client ip的请求会被转发到同一个pod</span></span><br><span class="line">	<span class="attr">sessionAffinty:</span> <span class="string">ClientIP</span></span><br></pre></td></tr></table></figure>

<h2 id="5-3-同一个服务暴露多个端口"><a href="#5-3-同一个服务暴露多个端口" class="headerlink" title="5.3 同一个服务暴露多个端口"></a>5.3 同一个服务暴露多个端口</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">MyApp</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">9376</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">https</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">443</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">9377</span></span><br></pre></td></tr></table></figure>

<h2 id="5-4服务发现"><a href="#5-4服务发现" class="headerlink" title="5.4服务发现"></a>5.4服务发现</h2><ol>
<li>服务正常运行还是不能使用ping（使用的虚拟IP，只有结合端口号才有意义）</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">exec</span> &lt;pod&gt; <span class="built_in">env</span></span><br></pre></td></tr></table></figure>

<h2 id="5-5服务对外暴露"><a href="#5-5服务对外暴露" class="headerlink" title="5.5服务对外暴露"></a>5.5服务对外暴露</h2><h3 id="5-5-1使用NodePort类型的服务"><a href="#5-5-1使用NodePort类型的服务" class="headerlink" title="5.5.1使用NodePort类型的服务"></a>5.5.1使用NodePort类型的服务</h3><p>创建NodePort类型资料，让k8s在其所有节点上保留一个端口</p>
<h3 id="5-5-2使用负载均衡器"><a href="#5-5-2使用负载均衡器" class="headerlink" title="5.5.2使用负载均衡器"></a>5.5.2使用负载均衡器</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubia-lb</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">kubia-lb</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">LoadBalancer</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">kubia</span></span><br></pre></td></tr></table></figure>



<h1 id="6-k8s的卷"><a href="#6-k8s的卷" class="headerlink" title="6.k8s的卷"></a>6.k8s的卷</h1><p>卷上pod的一个部分，它不能被单独创建或者删除</p>
<p>k8s卷有以下几种：<a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/storage/volumes/#volume-types">k8s官网卷</a></p>
<ul>
<li>emptyDir:用于存储临时的简单空目录</li>
<li>hostPath：用于将目录从工作节点的文件系统挂载到pod中</li>
<li>nfs：挂载到pod中的nfs共享卷</li>
</ul>
<h2 id="6-1emptyDir卷"><a href="#6-1emptyDir卷" class="headerlink" title="6.1emptyDir卷"></a>6.1emptyDir卷</h2><p>空卷，随着pod的生命周期创建和删除</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-pd</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">registry.k8s.io/test-webserver</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">test-container</span></span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="comment"># 挂载容器的地址</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/cache</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">cache-volume</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cache-volume</span></span><br><span class="line">      <span class="attr">emptyDir:</span></span><br><span class="line">        <span class="attr">sizeLimit:</span> <span class="string">500Mi</span>		</span><br></pre></td></tr></table></figure>

<h2 id="6-2hostPath卷"><a href="#6-2hostPath卷" class="headerlink" title="6.2hostPath卷"></a>6.2hostPath卷</h2><p><strong>持久卷</strong>，但是pod要和卷在一个主机上</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-pd</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">registry.k8s.io/test-webserver</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">test-container</span></span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/test-pd</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">test-volume</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-volume</span></span><br><span class="line">      <span class="attr">hostPath:</span></span><br><span class="line">        <span class="comment"># 宿主上目录位置</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/data</span></span><br><span class="line">        <span class="comment"># 此字段为可选</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">Directory</span></span><br></pre></td></tr></table></figure>

<h2 id="6-3持久卷"><a href="#6-3持久卷" class="headerlink" title="6.3持久卷"></a>6.3持久卷</h2><p>为了实现nfs，下面引入PersistentVolume（PV，持久卷），以及在这之前需要创建的PersistentVolumeClaim（PVC，持久卷声明）</p>
<p>PVC的三种访问模式（Access Model）状态：</p>
<ul>
<li>RWO：ReadWriteOnce,仅仅允许单个节点挂载读写</li>
<li>ROX：ReadOnlyMany,允许多个节点挂载只读</li>
<li>RWX：ReadWriteMany,允许多个节点挂载读写这个卷</li>
</ul>
<p>回收策略：</p>
<ul>
<li>Retain – 手动回收</li>
<li>Recycle – 基本擦除 (<code>rm -rf /thevolume/*</code>)</li>
<li>Delete – 诸如 AWS EBS 或 GCE PD 卷这类关联存储资产也被删除</li>
</ul>
<h1 id="7-ConfigMap和Secret"><a href="#7-ConfigMap和Secret" class="headerlink" title="7.ConfigMap和Secret"></a>7.ConfigMap和Secret</h1><h2 id="7-1向容器传递命令行参数"><a href="#7-1向容器传递命令行参数" class="headerlink" title="7.1向容器传递命令行参数"></a>7.1向容器传递命令行参数</h2><h3 id="7-1-1Docker中的命令和参数"><a href="#7-1-1Docker中的命令和参数" class="headerlink" title="7.1.1Docker中的命令和参数"></a>7.1.1Docker中的命令和参数</h3><h4 id="Dockerfile中的ENTRYOINT和CMD"><a href="#Dockerfile中的ENTRYOINT和CMD" class="headerlink" title="Dockerfile中的ENTRYOINT和CMD"></a>Dockerfile中的ENTRYOINT和CMD</h4><ul>
<li>ENTRYOINT：定义容器启动的时候被调用的可执行程序</li>
<li>CMD：指定传递的ENTRYOINT的参数</li>
</ul>
<p>一些区别：</p>
<ul>
<li>如果只使用<code>CMD</code>，则<code>CMD</code>提供的命令会作为默认的可执行命令，但是可以在<code>docker run</code>命令中覆盖它。</li>
<li>如果只使用<code>ENTRYPOINT</code>，则<code>ENTRYPOINT</code>提供的命令将成为容器的默认可执行命令，不会被<code>docker run</code>命令中的参数覆盖。</li>
<li>如果同时使用了<code>ENTRYPOINT</code>和<code>CMD</code>，<code>CMD</code>提供的参数会作为<code>ENTRYPOINT</code>命令的默认参数。但是可以在<code>docker run</code>命令中提供新的参数来覆盖默认参数。</li>
</ul>
<h4 id="shell和exec形式的区别"><a href="#shell和exec形式的区别" class="headerlink" title="shell和exec形式的区别"></a>shell和exec形式的区别</h4><ol>
<li>shell形式：node app.js</li>
<li>exec形式：[“node”,”app.js”]</li>
</ol>
<p>从进程来看：</p>
<p>exec：是 node app.js</p>
<p>Shell: 多了一个&#x2F;bin&#x2F;sh -c app.js</p>
<h3 id="7-1-2k8s中覆盖命令和参数"><a href="#7-1-2k8s中覆盖命令和参数" class="headerlink" title="7.1.2k8s中覆盖命令和参数"></a>7.1.2k8s中覆盖命令和参数</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">	<span class="attr">containers:</span></span><br><span class="line">	<span class="bullet">-</span> <span class="attr">image:</span> <span class="string">some/image</span></span><br><span class="line">	<span class="comment"># command 和args 在成功创建之后无法修改</span></span><br><span class="line">		<span class="attr">command:</span> [<span class="string">&quot;/bin/command&quot;</span>]</span><br><span class="line">		<span class="attr">args:</span> [<span class="string">&quot;args1&quot;</span>,<span class="string">&quot;args2&quot;</span>,<span class="string">&quot;args3&quot;</span>]</span><br></pre></td></tr></table></figure>

<h2 id="7-2在容器定义中指定环境变量"><a href="#7-2在容器定义中指定环境变量" class="headerlink" title="7.2在容器定义中指定环境变量"></a>7.2在容器定义中指定环境变量</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">env_base</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">env_vase</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">env_base</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">luksa/fortume:env</span></span><br><span class="line">      <span class="comment"># 设置环境变量，注意 k8s会在每个容器中，自动暴露同namespace下的环境变量</span></span><br><span class="line">      <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">INIERVAL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;30&quot;</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">env_base</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">env_vase</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">env_base</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">luksa/fortume:env</span></span><br><span class="line">      <span class="comment"># 设置环境变量，注意 k8s会在每个容器中，自动暴露同namespace下的环境变量</span></span><br><span class="line">      <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">INIERVAL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;30&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SEC_VAR</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;$&#123;FIRST_VAR&#125;&quot;</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line">  </span><br></pre></td></tr></table></figure>

<h2 id="7-3ConfigMap"><a href="#7-3ConfigMap" class="headerlink" title="7.3ConfigMap"></a>7.3ConfigMap</h2><p>把配置选项配置到单独的configmap，本质就是键值对映射。</p>
<p><strong>configmap更新会自动推送更新，但是如果是作为环境变量启动的Pod，需要重启Pod才能重新获取</strong></p>
<h3 id="7-3-1创建cm"><a href="#7-3-1创建cm" class="headerlink" title="7.3.1创建cm"></a>7.3.1创建cm</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建单条记录</span></span><br><span class="line">kubectl create configmap fortune-config --from-literal=sleep-interval=25</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建多条记录</span></span><br><span class="line">kubectl create configmap myconfigmap --from-literal=bar=bars --from-literal=one=two</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从文件创建cm，键名 config-fiel.conf</span></span><br><span class="line">kubectl create configmap my-config --from-file=config-file.conf</span><br><span class="line"><span class="comment"># 指定键名</span></span><br><span class="line">kubectl create configmap my-config --from-file=customkey=config-file.conf</span><br><span class="line"><span class="comment"># 从文件夹创建cm</span></span><br><span class="line">kubectl create configmap my-config --from-file=/path/to/dir</span><br></pre></td></tr></table></figure>

<h3 id="7-3-2cm设置环境变量"><a href="#7-3-2cm设置环境变量" class="headerlink" title="7.3.2cm设置环境变量"></a>7.3.2cm设置环境变量</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">configmap-demo-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">demo</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">alpine</span></span><br><span class="line">      <span class="attr">command:</span> [<span class="string">&quot;sleep&quot;</span>, <span class="string">&quot;3600&quot;</span>]</span><br><span class="line">      <span class="attr">env:</span></span><br><span class="line">        <span class="comment"># 定义环境变量</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PLAYER_INITIAL_LIVES</span> <span class="comment"># 请注意这里和 ConfigMap 中的键名是不一样的</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">configMapKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">game-demo</span>           <span class="comment"># 这个值来自 ConfigMap</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">player_initial_lives</span> <span class="comment"># 需要取值的键</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">UI_PROPERTIES_FILE_NAME</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">configMapKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">game-demo</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">ui_properties_file_name</span></span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">        <span class="attr">mountPath:</span> <span class="string">&quot;/config&quot;</span></span><br><span class="line">        <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="comment"># 你可以在 Pod 级别设置卷，然后将其挂载到 Pod 内的容器中</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">    <span class="attr">configMap:</span></span><br><span class="line">      <span class="comment"># 提供你想要挂载的 ConfigMap 的名字</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">game-demo</span></span><br><span class="line">      <span class="comment"># 来自 ConfigMap 的一组键，将被创建为文件</span></span><br><span class="line">      <span class="attr">items:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;game.properties&quot;</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">&quot;game.properties&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;user-interface.properties&quot;</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">&quot;user-interface.properties&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="7-3-3-cm在pod中作为文件使用"><a href="#7-3-3-cm在pod中作为文件使用" class="headerlink" title="7.3.3 cm在pod中作为文件使用"></a>7.3.3 cm在pod中作为文件使用</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mypod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mypod</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">foo</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">&quot;/etc/foo&quot;</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">foo</span></span><br><span class="line">    <span class="attr">configMap:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">myconfigmap</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">	<span class="attr">containers:</span></span><br><span class="line">	<span class="bullet">-</span> <span class="attr">image:</span> <span class="string">some/images</span></span><br><span class="line">	<span class="attr">volumeMounts:</span></span><br><span class="line">	<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myvolume</span></span><br><span class="line">	<span class="comment"># 挂载某一个file 而不是一个文件夹</span></span><br><span class="line">		<span class="attr">mountPath:</span> <span class="string">/etc/someconfig.conf</span></span><br><span class="line">		<span class="comment"># 挂载其中的某一条数据</span></span><br><span class="line">		<span class="attr">subPath:</span> <span class="string">myconconfig.cong</span></span><br></pre></td></tr></table></figure>

<h2 id="7-4Secret"><a href="#7-4Secret" class="headerlink" title="7.4Secret"></a>7.4Secret</h2><p>因为cm是不能加密的，sectet提供了更好的安全性</p>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/configuration/secret/#opaque-secret">k8s-seret</a></p>
<h3 id="7-4-1在Docker"><a href="#7-4-1在Docker" class="headerlink" title="7.4.1在Docker"></a>7.4.1在Docker</h3><p>当没有Docker配置文件，又想使用secret来访问容器仓库</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl create secret docker-registry secret-tiger-docker \</span><br><span class="line">  --docker-email=tiger@acme.example \</span><br><span class="line">  --docker-username=tiger \</span><br><span class="line">  --docker-password=pass1234 \</span><br><span class="line">  --docker-server=my-registry.example:5000</span><br></pre></td></tr></table></figure>

<p>对上面的进行解码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get secret secret-tiger-docker -o jsonpath=<span class="string">&#x27;&#123;.data.*&#125;&#x27;</span> | <span class="built_in">base64</span> -d</span><br></pre></td></tr></table></figure>

<h3 id="7-4-2基本身份认证"><a href="#7-4-2基本身份认证" class="headerlink" title="7.4.2基本身份认证"></a>7.4.2基本身份认证</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">secret-basic-auth</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">kubernetes.io/basic-auth</span></span><br><span class="line"><span class="attr">stringData:</span></span><br><span class="line">  <span class="attr">username:</span> <span class="string">admin</span>      <span class="comment"># kubernetes.io/basic-auth 类型的必需字段</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">t0p-Secret</span> <span class="comment"># kubernetes.io/basic-auth 类型的必需字段</span></span><br></pre></td></tr></table></figure>

<h1 id="8-从应用访问Pod元数据以及其他资源"><a href="#8-从应用访问Pod元数据以及其他资源" class="headerlink" title="8.从应用访问Pod元数据以及其他资源"></a>8.从应用访问Pod元数据以及其他资源</h1><h2 id="8-1Downward-API传递元数据"><a href="#8-1Downward-API传递元数据" class="headerlink" title="8.1Downward API传递元数据"></a>8.1Downward API传递元数据</h2><p>通过Downward API可以在pod中运行的进程暴露pod的云数据。可以给容器传递以下的数据：</p>
<ul>
<li>pod的名称</li>
<li>pod的IP</li>
<li>pod所在的namespace</li>
<li>pod运行节点的名称</li>
<li>pod运行所属的服务账号的名称</li>
<li>每个容器请求的CPU和内存的使用量</li>
<li>每个容器可以使用的CPU和内存的限制</li>
<li>pod的标签</li>
<li>pod的注释</li>
</ul>
<h2 id="8-2K8s-的REST-API"><a href="#8-2K8s-的REST-API" class="headerlink" title="8.2K8s 的REST API"></a>8.2K8s 的REST API</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获取集群的信息</span></span><br><span class="line">kubectl cluster-info</span><br><span class="line"></span><br><span class="line"><span class="comment"># 因为https需要加密 -k 跳过验证</span></span><br><span class="line">curl https//xxx:8443 -k</span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过kubectl-proxy 会启动一个代理服务器，之后可以通过8001访问</span></span><br><span class="line">kubectl proxy</span><br></pre></td></tr></table></figure>

<h1 id="9-Deployment"><a href="#9-Deployment" class="headerlink" title="9.Deployment"></a>9.Deployment</h1><p>一个 Deployment 为 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/">Pod</a> 和 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/replicaset/">ReplicaSet</a> 提供声明式的更新能力。</p>
<ul>
<li>提供滚动升级的能力</li>
<li>Deployment由ReplicaSet组成，并且由它接管Pod</li>
</ul>
<h2 id="9-1滚动升级"><a href="#9-1滚动升级" class="headerlink" title="9.1滚动升级"></a>9.1滚动升级</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ReplicationController的滚动升级</span></span><br><span class="line">kubectl roll-update &lt;kubia-v1&gt; &lt;kubia-v2&gt; --image=luksa/kubisa:v2</span><br></pre></td></tr></table></figure>

<p>两种升级策略：</p>
<ol>
<li>Rollingupdate，滚动升级，默认策略</li>
<li>Recreate：一次性删除所有的旧版本，然后创建新的pod</li>
</ol>
<h2 id="9-2回滚升级"><a href="#9-2回滚升级" class="headerlink" title="9.2回滚升级"></a>9.2回滚升级</h2><p>这可以让deployment会滚到以前版本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 显示dm的的历史升级记录,kubecyl 创建的时候需要加上 --recored</span></span><br><span class="line">kubectl rollout <span class="built_in">history</span> deployment kubia</span><br><span class="line"></span><br><span class="line"><span class="comment"># 会滚到某一个特定的版本,其中可以通过指定revisionHistoryLimit来限制历史版本数量，默认值是10</span></span><br><span class="line">kubectl rollout undo deployment kubia --to-reviesion=1</span><br></pre></td></tr></table></figure>

<h2 id="9-3暂停滚动升级"><a href="#9-3暂停滚动升级" class="headerlink" title="9.3暂停滚动升级"></a>9.3暂停滚动升级</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 暂停滚动升级</span></span><br><span class="line">kubectl rollout pause deployment kubia</span><br><span class="line"></span><br><span class="line"><span class="comment"># 回复滚动升级</span></span><br><span class="line">kubectl rollout resume deployment kubia</span><br></pre></td></tr></table></figure>

<h1 id="10-k8s的架构"><a href="#10-k8s的架构" class="headerlink" title="10.k8s的架构"></a>10.k8s的架构</h1><p>主要分为：控制平面、节点</p>
<h2 id="10-1控制面的组件"><a href="#10-1控制面的组件" class="headerlink" title="10.1控制面的组件"></a>10.1控制面的组件</h2><ul>
<li>etcd分布式持久化存储</li>
<li>API服务器</li>
<li>调度器</li>
<li>控制器管理器</li>
</ul>
<p>这些组件用来存储、管理集群状态，不是运行应用的容器</p>
<h2 id="10-2工作节点上运行的组件"><a href="#10-2工作节点上运行的组件" class="headerlink" title="10.2工作节点上运行的组件"></a>10.2工作节点上运行的组件</h2><ul>
<li>Kubectl</li>
<li>Kubectl服务代理（kube-proxy）</li>
<li>容器运行时（Docker、rkt或者其他）</li>
</ul>
<h2 id="10-3附加组件"><a href="#10-3附加组件" class="headerlink" title="10.3附加组件"></a>10.3附加组件</h2><ul>
<li>Kubernetes DNS服务器</li>
<li>仪表器</li>
<li>Ingress控制器</li>
<li>Heapster（容器集群监控）</li>
<li>容器网络接口插件</li>
</ul>
<h1 id="11-认证方式"><a href="#11-认证方式" class="headerlink" title="11.认证方式"></a>11.认证方式</h1><p>目前认证有：</p>
<ol>
<li>客户端证书</li>
<li>传入http头中的认证token</li>
<li>基于的http认证</li>
</ol>
<h2 id="组"><a href="#组" class="headerlink" title="组"></a>组</h2><ul>
<li>system：unauthenticated组用于所有认证插件都不会认证客户端身份的请求</li>
<li>system：authenticated组自动分配一个成功通过认证的用户</li>
<li>system：service accounts组包含所有在系统中的serviceAccount</li>
</ul>
<h3 id="创建serviceAccount"><a href="#创建serviceAccount" class="headerlink" title="创建serviceAccount"></a>创建serviceAccount</h3><ul>
<li>同一个namespcae下，可以共享一个serviceAccount，但是不能夸namespace</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建，会绑定分配一个secret</span></span><br><span class="line">kubectl create serviceaccount &lt;foo&gt;</span><br></pre></td></tr></table></figure>

<h1 id="12-污点"><a href="#12-污点" class="headerlink" title="12.污点"></a>12.污点</h1><ul>
<li>NoSchedule：表示K8S将不会把Pod调度到具有该污点的Node节点上</li>
<li>PreferNoSchedule：表示K8S将尽量避免把Pod调度到具有该污点的Node节点上</li>
<li>NoExecute：表示K8S将不会把Pod调度到具有该污点的Node节点上，同时会将Node上已经存在的Pod驱逐出去</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加污点</span></span><br><span class="line">kubectl taint nodes k8s-node01 check=zhang:NoSchedule</span><br><span class="line"><span class="comment"># 删除污点</span></span><br><span class="line">kubectl taint nodes k8s-node01 check=zhang:NoSchedule-</span><br><span class="line"></span><br><span class="line"><span class="comment"># pod 污点</span></span><br><span class="line">tolerations:</span><br><span class="line">- key: <span class="string">&quot;key&quot;</span></span><br><span class="line">  operator: <span class="string">&quot;Equal&quot;</span></span><br><span class="line">  value: <span class="string">&quot;value&quot;</span></span><br><span class="line">  effect: <span class="string">&quot;NoSchedule&quot;</span></span><br><span class="line">---</span><br><span class="line">tolerations:</span><br><span class="line">- key: <span class="string">&quot;key&quot;</span></span><br><span class="line">  operator: <span class="string">&quot;Exists&quot;</span></span><br><span class="line">  effect: <span class="string">&quot;NoSchedule&quot;</span></span><br></pre></td></tr></table></figure>

<p>可以在同一个node节点上设置多个污点（Taints），在同一个pod上设置多个容忍（Tolerations）。Kubernetes处理多个污点和容忍的方式就像一个过滤器：从节点的所有污点开始，然后忽略可以被Pod容忍匹配的污点；保留其余不可忽略的污点，污点的effect对Pod具有显示效果：特别是：</p>
<ul>
<li>如果有至少一个不可忽略污点，effect为NoSchedule，那么Kubernetes将不调度Pod到该节点</li>
<li>如果没有effect为NoSchedule的不可忽视污点，但有至少一个不可忽视污点，effect为PreferNoSchedule，那么Kubernetes将尽量不调度Pod到该节点</li>
<li>如果有至少一个不可忽视污点，effect为NoExecute，那么Pod将被从该节点驱逐（如果Pod已经在该节点运行），并且不会被调度到该节点（如果Pod还未在该节点运行）</li>
</ul>
<h1 id="13-其他一些资料"><a href="#13-其他一些资料" class="headerlink" title="13.其他一些资料"></a>13.其他一些资料</h1><ul>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/kubernetes-api/">api list</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.feisky.xyz/concepts/components/apiserver">kubernetes教程</a></li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a target="_blank" rel="noopener" href="https://github.com/Piwriw">Joohwan.</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://piwriw.github.io/2023/08/16/cloud/k8s/introduce/K8s%E6%B5%85%E5%AD%A6/">https://piwriw.github.io/2023/08/16/cloud/k8s/introduce/K8s浅学/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://piwriw.github.io" target="_blank">Joohwan</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/k8s/">k8s</a><a class="post-meta__tags" href="/tags/introduce/">introduce</a></div><div class="post-share"><div class="social-share" data-image="/img/kubernetes.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>赞助</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2023/09/16/cloud/Harbor/" title="Harbor"><img class="cover" src="/img/harbor.png" onerror="onerror=null;src='/img/404.png'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">Harbor</div></div><div class="info-2"><div class="info-item-1">Harbor什么是HarborHarbor 是一个开源的企业级容器镜像注册中心，用于管理和存储 Docker 镜像以及其他容器化应用的相关资源。它允许团队或组织在内部搭建自己的容器镜像仓库，以便更好地控制镜像的分发、访问和安全性。 Harbor的安装安装最小配置最低建议配置：  CPU：2 核 内存：4 GB 存储：40 GB  通过docker-compose部署Harbor离线安装12# 下载安装包wget https://github.com/goharbor/harbor/releases/download/v2.8.4/harbor-offline-installer-v2.8.4.tgz   修改harbor.yaml中hostname为harborip，https&#x2F;certificate和private_key为  12certificate: /root/edgestack-setup/harbor/cert/cert.certprivate_key: /root/edgestack-setup/harbor/cert/key.key   生成cert....</div></div></div></a><a class="pagination-related" href="/2023/08/16/cloud/docker/Docker-%E5%BC%80%E5%90%AF%E8%BF%9C%E7%A8%8BCli/" title="Docker配置远程访问"><img class="cover" src="/img/docker.png" onerror="onerror=null;src='/img/404.png'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">Docker配置远程访问</div></div><div class="info-2"><div class="info-item-1">Docker配置远程访问暴力修改这种就很简单暴力，直接修改/lib/systemd/system/docker.service文件，注释掉默认的 ExecStart 并添加新的 ExecStart 配置： 12# ExecStart=/usr/bin/dockerd -H fd://ExecStart=/usr/bin/dockerd -H tcp://0.0.0.0:2375 -H unix:///var/run/docker.sock  然后重启 docker.service： 12$ sudo systemctl daemon-reload$ sudo systemctl restart docker.service  这样 docker 就开始监听 tcp 端口 2375 了 systemctl修改是使用 systemctl edit docker 来调用文本编辑器修改指定的单元或单元实例，ubuntu 默认调用的是 nano 编辑器，不是很好用，如果不熟悉 nano 编辑器的操作可以使用 vim 编辑器。主要也就是新建或修改 /etc/systemd/system/do...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2025/01/07/cloud/k8s/introduce/K8s%E4%B8%AD%E7%9A%84%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/" title="K8s中的垃圾回收"><img class="cover" src="/img/k8s-go.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-01-07</div><div class="info-item-2">K8s中的垃圾回收</div></div><div class="info-2"><div class="info-item-1">K8s中的垃圾回收 基于1.29  K8s的垃圾回收主要是以下的问题  结束的Pod对象 完结的Job对象 无主对象，这类的对象的Owner不存在 不再使用的容器和镜像 不再使用的动态创建的PV对象，对应的StorageClass声明了回收策略Delete 下列场景中被删除的Node 控制器的集群   Node Lease对象  Pod对象垃圾回收对于我阶段为Failed的Pod，对应的容器虽然已经停止，但是其资源对象依旧存在API Server，需要被Pod控制器或者运维人员手动删除 kube-controller-manager中有一个名为PodGC的组件专门负责自动清理“垃圾类”Pod  孤儿Pod，绑定的Node已经不存在 未调度就结束的Pod 终结中的Pod，这类Pod满足，它们被绑定到NotReady的Node，该Node有一个污点node.kubernetes.io&#x2F;out-of-service，并且NodeOutOfServiceVolumeDetach特性门控开启  对于孤儿Pod，如果它们的阶段不少终结阶段，则PodGC会把它们设置为Failed，此...</div></div></div></a><a class="pagination-related" href="/2023/12/23/cloud/k8s/introduce/K8s%5B%E5%86%85%E6%A0%B8%E4%BC%98%E5%8C%96%5D-%E5%A4%A7%E8%A7%84%E6%A8%A1%E4%B8%8B%E9%9B%86%E7%BE%A4%E4%BC%98%E5%8C%96/" title="K8s[内核优化]-大规模下集群优化"><img class="cover" src="/img/k8s-go.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-12-23</div><div class="info-item-2">K8s[内核优化]-大规模下集群优化</div></div><div class="info-2"><div class="info-item-1">K8s[内核优化]-大规模下集群优化最大线程数和文件打开数。 编辑 &#x2F;etc&#x2F;security&#x2F;limits.conf 。 12345678root soft nofile 655350root hard nofile 655350root soft nproc 655350root hard nproc 655350* soft nofile 655350* hard nofile 655350* soft nproc 655350* hard nproc 655350  内核优化，重点优化以下参数。 编辑 &#x2F;etc&#x2F;sysctl.conf  1234567891011121314151617181920212223242526272829303132333435363738# 容器环境下，优化这些参数可以避免 NAT 过的 TCP 连接带宽上不去。net.netfilter.nf_conntrack_tcp_be_liberal = 1 net.netfilter.nf_conntrack_tcp_loose = 1 net....</div></div></div></a><a class="pagination-related" href="/2023/12/02/cloud/k8s/introduce/K8s-%E5%AF%B9%E8%B1%A1/" title="K8s-对象"><img class="cover" src="/img/k8s-go.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-12-02</div><div class="info-item-2">K8s-对象</div></div><div class="info-2"><div class="info-item-1">K8s-对象对象的spec和status spec：操作员所期望的状态 status：实际上集群中的状态  必填字段在上述的 .yaml 文件中，如下字段是必须填写的：  apiVersion 用来创建对象时所使用的Kubernetes API版本 kind 被创建对象的类型 metadata 用于唯一确定该对象的元数据：包括 name 和 namespace，如果 namespace 为空，则默认值为 default spec 描述您对该对象的期望状态  名称Kubernetes REST API 中，所有的对象都是通过 name 和 UID 唯一性确定。 Names可以通过 namespace + name 唯一性地确定一个 RESTFUL 对象，例如： 1/api/v1/namespaces/&#123;namespace&#125;/pods/&#123;name&#125;  同一个名称空间下，同一个类型的对象，可以通过 name 唯一性确定。如果删除该对象之后，可以再重新创建一个同名对象。 下面是三种广泛使用的资源名称的限制类型: DNS Subdomain Name...</div></div></div></a><a class="pagination-related" href="/2023/11/07/cloud/k8s/introduce/K8s-%E6%A0%B8%E5%BF%83%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-scheme%E8%B5%84%E6%BA%90%E6%B3%A8%E5%86%8C%E8%A1%A8/" title="K8s-核心数据结构-scheme资源注册表"><img class="cover" src="/img/k8s-go.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-11-07</div><div class="info-item-2">K8s-核心数据结构-scheme资源注册表</div></div><div class="info-2"><div class="info-item-1">K8s-核心数据结构-scheme资源注册表所有的K8s资源类型都会注册到Scheme资源注册表中，有如下的特点：  支持多种资源类型，包括内部版本和外部版本 支持多种版本转换机制 支持不同资源的的序列化&#x2F;反序列化  Scheme资源注册支持俩种类型，分别是UnversionedType和KnowType资源类型。  UnversionedType:无版本资源类型，这类资源对象不需要进行转换。目前比少 KnowType：目前K8s最常用资源类型，UnversionedType通过scheme.AddUnversionedTypes方法进行注册，Knowtype通过scheme.AddKnowType	进行注册  Scheme资源注册表结构字段说明如下：  gvToType:存储GVK与Type的映射关系  typeToGVK:存储type与GVK的映射关系，一个Type会对应一个或多个GVK  unversionedTypes：存储UnversionedType与GVK的映射关系  unversionedKind:存储kind名称和UnversionedType的映射关...</div></div></div></a><a class="pagination-related" href="/2023/10/26/cloud/k8s/introduce/K8s%E7%9A%84%E4%BA%94%E7%A7%8D%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90%E5%99%A8/" title="K8s的五种代码生成器"><img class="cover" src="/img/k8s-go.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-26</div><div class="info-item-2">K8s的五种代码生成器</div></div><div class="info-2"><div class="info-item-1">K8s的五种代码生成器概述   代码生成器 说明    Conversion-gen 自动生成convert函数的代码是生成器，用于资源对象的版本转换函数   deepcopy-gen 自动生成deepcopy的函数代码生成器，用于资源对象的深复制函数   defaulter-gen 自动生成defaulter的函数代码生成器，用于资源对象的默认值函数   prerelese- lifecycle-gen 自动生成api-status.csv文件的工具   openapi-gen 自动生成openapi定义文件的代码生成器   除了上述之外，其实还支持很多，比如client-gen、lister-gen、informer-gen Conversion-gen自动生成convert函数的代码是生成器，用于资源对象的版本转换函数 常规引入tag1+k8s:conversion-gen=&lt;peer-pkg&gt;  生成规则https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/code-ge...</div></div></div></a><a class="pagination-related" href="/2025/08/24/cloud/k8s/K8s%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97-%E5%AE%A2%E6%88%B7%E7%AB%AF/" title="K8s开发指南-客户端"><img class="cover" src="/img/k8sLogo.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-08-24</div><div class="info-item-2">K8s开发指南-客户端</div></div><div class="info-2"><div class="info-item-1">K8s开发指南-客户端 基于K8s v1.29  API客户端 Ref：https://github.com/kubernetes/client-go  K8s认证方式主要一下俩类：  集群外的认证：客户端程序运行在集群外，以独立进程访问API Server 集群内的认证：客户端在K8s内以Pod形式运行，通过内部服务名访问API Server  客户端访问API Server常见的认证方式有以下的几种  数字证书方式 ServiceAccount方式 BearerToken方式  对于运行在K8s集群之外的客户端，建议使用数字证书方式连接API Server，客户端需要配置的信息包括CA根证书、客户端证书、客户段私钥以及API Server地址 对于运行在集群内的Pod，建议使用ServiceAccount认证方式，需要为Pod增加ServiceAccount资源，并为ServiceAccount配置好正确的RBAC权限 基于kubeconfig文件的配置方式有以下几种：  用户HOME目录中的约定目录，例如$HOME&#x2F;.kube&#x2F;config 在环境变量K...</div></div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Joohwan.</div><div class="author-info-description">该知道的都知道，不知道的慢慢了解</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">259</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">76</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">60</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/piwriw"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/piwriw" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:piwriw@163.com" target="_blank" title="Email"><i class="fas fa-envelope-open-text"></i></a></div></div><div class="card-widget"><div class="item-headline"><i class="iconfont icat-visitor"></i><span>来访者</span></div><div class="item-content"><div id="welcome-info"></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#k8s"><span class="toc-number">1.</span> <span class="toc-text">k8s</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1%E3%80%81%E5%AE%89%E8%A3%85%EF%BC%88v-1-17-1-docker-cri%EF%BC%89"><span class="toc-number"></span> <span class="toc-text">1、安装（v.1.17.1,docker-cri）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-env-bash"><span class="toc-number">1.</span> <span class="toc-text">1.1 env.bash</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-k8ssetup-bash"><span class="toc-number">2.</span> <span class="toc-text">1.2 k8ssetup.bash</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-1-k8ssetup-yaml"><span class="toc-number">2.1.</span> <span class="toc-text">1.2.1 k8ssetup.yaml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-2-k8s-run-setup-single-host-Kubernetes-cluster"><span class="toc-number">2.2.</span> <span class="toc-text">1.2.2 k8s run setup(single-host Kubernetes cluster)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2%E3%80%81%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86"><span class="toc-number"></span> <span class="toc-text">2、资源管理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1Pod"><span class="toc-number">1.</span> <span class="toc-text">2.1Pod</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-1%E5%88%9B%E5%BB%BA%E5%AE%B9%E5%99%A8"><span class="toc-number">1.1.</span> <span class="toc-text">2.1.1创建容器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-2%E6%9F%A5%E7%9C%8B%E5%AE%B9%E5%99%A8"><span class="toc-number">1.2.</span> <span class="toc-text">2.1.2查看容器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-3%E6%9F%A5%E7%9C%8B%E5%AE%B9%E5%99%A8%E6%97%A5%E5%BF%97"><span class="toc-number">1.3.</span> <span class="toc-text">2.1.3查看容器日志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-4%E5%90%91pod%E5%8F%91%E9%80%81%E8%AF%B7%E6%B1%82"><span class="toc-number">1.4.</span> <span class="toc-text">2.1.4向pod发送请求</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3%E3%80%81%E6%A0%87%E7%AD%BE%E7%AE%A1%E7%90%86"><span class="toc-number"></span> <span class="toc-text">3、标签管理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1pod"><span class="toc-number">1.</span> <span class="toc-text">3.1pod</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2node"><span class="toc-number">2.</span> <span class="toc-text">3.2node</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%87%E5%AE%9A%E8%B0%83%E5%BA%A6%E5%88%B0%E7%89%B9%E5%AE%9A%E8%8A%82%E7%82%B9%EF%BC%88nodeselector%EF%BC%89"><span class="toc-number">2.1.</span> <span class="toc-text">指定调度到特定节点（nodeselector）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%EF%BC%88namespace%EF%BC%89"><span class="toc-number">3.</span> <span class="toc-text">3.3命名空间（namespace）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAns"><span class="toc-number">3.1.</span> <span class="toc-text">创建ns</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4%E3%80%81%E6%8E%A7%E5%88%B6%E5%99%A8"><span class="toc-number"></span> <span class="toc-text">4、控制器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1%E6%8E%A2%E9%92%88"><span class="toc-number">1.</span> <span class="toc-text">4.1探针</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-1%E5%AD%98%E6%B4%BB%E6%8E%A2%E9%92%88"><span class="toc-number">1.1.</span> <span class="toc-text">4.1.1存活探针</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8EHttp%E7%9A%84%E5%AD%98%E6%B4%BB%E6%8E%A2%E9%92%88"><span class="toc-number">1.1.1.</span> <span class="toc-text">基于Http的存活探针</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-2%E5%B0%B1%E7%BB%AA%E6%8E%A2%E9%92%88"><span class="toc-number">1.2.</span> <span class="toc-text">4.1.2就绪探针</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-ReplicationController"><span class="toc-number">2.</span> <span class="toc-text">4.2 ReplicationController</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-1%E5%B0%86pod%E7%A7%BB%E5%85%A5%E6%88%96%E7%A7%BB%E5%87%BAReplicationController%E7%9A%84%E4%BD%9C%E7%94%A8%E5%9F%9F"><span class="toc-number">2.1.</span> <span class="toc-text">4.2.1将pod移入或移出ReplicationController的作用域</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-2%E4%BF%AE%E6%94%B9pod-%E6%A8%A1%E7%89%88"><span class="toc-number">2.2.</span> <span class="toc-text">4.2.2修改pod 模版</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-3%E5%88%A0%E9%99%A4RC"><span class="toc-number">2.3.</span> <span class="toc-text">4.2.3删除RC</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-ReplicaSet-RC%E8%BF%9B%E5%8C%96%E7%89%88%EF%BC%8C%E6%9B%B4%E4%BC%98%E7%A7%80"><span class="toc-number">3.</span> <span class="toc-text">4.3 ReplicaSet(RC进化版，更优秀)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-Job"><span class="toc-number">4.</span> <span class="toc-text">4.4 Job</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-1%E9%A1%BA%E5%BA%8F%E8%BF%90%E8%A1%8Cjob-pod"><span class="toc-number">4.1.</span> <span class="toc-text">4.4.1顺序运行job pod</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-2%E5%B9%B6%E8%A1%8C%E8%BF%90%E8%A1%8Cjob-pod"><span class="toc-number">4.2.</span> <span class="toc-text">4.4.2并行运行job pod</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-3job%E7%9A%84%E7%BC%A9%E6%94%BE"><span class="toc-number">4.3.</span> <span class="toc-text">4.4.3job的缩放</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-4%E9%99%90%E5%88%B6job-pod%E5%AE%8C%E6%88%90%E4%BB%BB%E5%8A%A1%E6%97%B6%E9%97%B4"><span class="toc-number">4.4.</span> <span class="toc-text">4.4.4限制job pod完成任务时间</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#job%E5%AE%9A%E6%9C%9F%E8%BF%90%E8%A1%8C%EF%BC%88Crodjob%EF%BC%89"><span class="toc-number">4.5.</span> <span class="toc-text">job定期运行（Crodjob）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-Service"><span class="toc-number"></span> <span class="toc-text">5.Service</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-%E5%A6%82%E4%BD%95%E5%9C%A8%E4%B8%80%E4%B8%AA%E5%B7%B2%E6%9C%89%E7%9A%84pod%EF%BC%8C%E8%AE%BF%E9%97%AEservice"><span class="toc-number">0.1.</span> <span class="toc-text">5.1 如何在一个已有的pod，访问service</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2%E9%85%8D%E7%BD%AE%E6%AF%8F%E6%AC%A1%E8%AF%B7%E6%B1%82%E6%9D%A5%E8%87%AA%E4%BA%8E%E5%90%8C%E4%B8%80%E4%B8%AApod"><span class="toc-number">1.</span> <span class="toc-text">5.2配置每次请求来自于同一个pod</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3-%E5%90%8C%E4%B8%80%E4%B8%AA%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2%E5%A4%9A%E4%B8%AA%E7%AB%AF%E5%8F%A3"><span class="toc-number">2.</span> <span class="toc-text">5.3 同一个服务暴露多个端口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-4%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0"><span class="toc-number">3.</span> <span class="toc-text">5.4服务发现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-5%E6%9C%8D%E5%8A%A1%E5%AF%B9%E5%A4%96%E6%9A%B4%E9%9C%B2"><span class="toc-number">4.</span> <span class="toc-text">5.5服务对外暴露</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-5-1%E4%BD%BF%E7%94%A8NodePort%E7%B1%BB%E5%9E%8B%E7%9A%84%E6%9C%8D%E5%8A%A1"><span class="toc-number">4.1.</span> <span class="toc-text">5.5.1使用NodePort类型的服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-5-2%E4%BD%BF%E7%94%A8%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%99%A8"><span class="toc-number">4.2.</span> <span class="toc-text">5.5.2使用负载均衡器</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-k8s%E7%9A%84%E5%8D%B7"><span class="toc-number"></span> <span class="toc-text">6.k8s的卷</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1emptyDir%E5%8D%B7"><span class="toc-number">1.</span> <span class="toc-text">6.1emptyDir卷</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2hostPath%E5%8D%B7"><span class="toc-number">2.</span> <span class="toc-text">6.2hostPath卷</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-3%E6%8C%81%E4%B9%85%E5%8D%B7"><span class="toc-number">3.</span> <span class="toc-text">6.3持久卷</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-ConfigMap%E5%92%8CSecret"><span class="toc-number"></span> <span class="toc-text">7.ConfigMap和Secret</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#7-1%E5%90%91%E5%AE%B9%E5%99%A8%E4%BC%A0%E9%80%92%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%8F%82%E6%95%B0"><span class="toc-number">1.</span> <span class="toc-text">7.1向容器传递命令行参数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-1Docker%E4%B8%AD%E7%9A%84%E5%91%BD%E4%BB%A4%E5%92%8C%E5%8F%82%E6%95%B0"><span class="toc-number">1.1.</span> <span class="toc-text">7.1.1Docker中的命令和参数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Dockerfile%E4%B8%AD%E7%9A%84ENTRYOINT%E5%92%8CCMD"><span class="toc-number">1.1.1.</span> <span class="toc-text">Dockerfile中的ENTRYOINT和CMD</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#shell%E5%92%8Cexec%E5%BD%A2%E5%BC%8F%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">1.1.2.</span> <span class="toc-text">shell和exec形式的区别</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-2k8s%E4%B8%AD%E8%A6%86%E7%9B%96%E5%91%BD%E4%BB%A4%E5%92%8C%E5%8F%82%E6%95%B0"><span class="toc-number">1.2.</span> <span class="toc-text">7.1.2k8s中覆盖命令和参数</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-2%E5%9C%A8%E5%AE%B9%E5%99%A8%E5%AE%9A%E4%B9%89%E4%B8%AD%E6%8C%87%E5%AE%9A%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="toc-number">2.</span> <span class="toc-text">7.2在容器定义中指定环境变量</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-3ConfigMap"><span class="toc-number">3.</span> <span class="toc-text">7.3ConfigMap</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-3-1%E5%88%9B%E5%BB%BAcm"><span class="toc-number">3.1.</span> <span class="toc-text">7.3.1创建cm</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-3-2cm%E8%AE%BE%E7%BD%AE%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="toc-number">3.2.</span> <span class="toc-text">7.3.2cm设置环境变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-3-3-cm%E5%9C%A8pod%E4%B8%AD%E4%BD%9C%E4%B8%BA%E6%96%87%E4%BB%B6%E4%BD%BF%E7%94%A8"><span class="toc-number">3.3.</span> <span class="toc-text">7.3.3 cm在pod中作为文件使用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-4Secret"><span class="toc-number">4.</span> <span class="toc-text">7.4Secret</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-4-1%E5%9C%A8Docker"><span class="toc-number">4.1.</span> <span class="toc-text">7.4.1在Docker</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-4-2%E5%9F%BA%E6%9C%AC%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81"><span class="toc-number">4.2.</span> <span class="toc-text">7.4.2基本身份认证</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#8-%E4%BB%8E%E5%BA%94%E7%94%A8%E8%AE%BF%E9%97%AEPod%E5%85%83%E6%95%B0%E6%8D%AE%E4%BB%A5%E5%8F%8A%E5%85%B6%E4%BB%96%E8%B5%84%E6%BA%90"><span class="toc-number"></span> <span class="toc-text">8.从应用访问Pod元数据以及其他资源</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#8-1Downward-API%E4%BC%A0%E9%80%92%E5%85%83%E6%95%B0%E6%8D%AE"><span class="toc-number">1.</span> <span class="toc-text">8.1Downward API传递元数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-2K8s-%E7%9A%84REST-API"><span class="toc-number">2.</span> <span class="toc-text">8.2K8s 的REST API</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#9-Deployment"><span class="toc-number"></span> <span class="toc-text">9.Deployment</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#9-1%E6%BB%9A%E5%8A%A8%E5%8D%87%E7%BA%A7"><span class="toc-number">1.</span> <span class="toc-text">9.1滚动升级</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-2%E5%9B%9E%E6%BB%9A%E5%8D%87%E7%BA%A7"><span class="toc-number">2.</span> <span class="toc-text">9.2回滚升级</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-3%E6%9A%82%E5%81%9C%E6%BB%9A%E5%8A%A8%E5%8D%87%E7%BA%A7"><span class="toc-number">3.</span> <span class="toc-text">9.3暂停滚动升级</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#10-k8s%E7%9A%84%E6%9E%B6%E6%9E%84"><span class="toc-number"></span> <span class="toc-text">10.k8s的架构</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#10-1%E6%8E%A7%E5%88%B6%E9%9D%A2%E7%9A%84%E7%BB%84%E4%BB%B6"><span class="toc-number">1.</span> <span class="toc-text">10.1控制面的组件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-2%E5%B7%A5%E4%BD%9C%E8%8A%82%E7%82%B9%E4%B8%8A%E8%BF%90%E8%A1%8C%E7%9A%84%E7%BB%84%E4%BB%B6"><span class="toc-number">2.</span> <span class="toc-text">10.2工作节点上运行的组件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-3%E9%99%84%E5%8A%A0%E7%BB%84%E4%BB%B6"><span class="toc-number">3.</span> <span class="toc-text">10.3附加组件</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#11-%E8%AE%A4%E8%AF%81%E6%96%B9%E5%BC%8F"><span class="toc-number"></span> <span class="toc-text">11.认证方式</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%84"><span class="toc-number">1.</span> <span class="toc-text">组</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAserviceAccount"><span class="toc-number">1.1.</span> <span class="toc-text">创建serviceAccount</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#12-%E6%B1%A1%E7%82%B9"><span class="toc-number"></span> <span class="toc-text">12.污点</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#13-%E5%85%B6%E4%BB%96%E4%B8%80%E4%BA%9B%E8%B5%84%E6%96%99"><span class="toc-number"></span> <span class="toc-text">13.其他一些资料</span></a></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2026/01/11/web/gorm/09-logger/" title="Gorm-日志系统模块原理说明"><img src="/img/go.png" onerror="this.onerror=null;this.src='/img/404.png'" alt="Gorm-日志系统模块原理说明"/></a><div class="content"><a class="title" href="/2026/01/11/web/gorm/09-logger/" title="Gorm-日志系统模块原理说明">Gorm-日志系统模块原理说明</a><time datetime="2026-01-11T11:56:27.000Z" title="发表于 2026-01-11 19:56:27">2026-01-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2026/01/11/web/gorm/08-migration/" title="Gorm-迁移功能模块原理说明"><img src="/img/go.png" onerror="this.onerror=null;this.src='/img/404.png'" alt="Gorm-迁移功能模块原理说明"/></a><div class="content"><a class="title" href="/2026/01/11/web/gorm/08-migration/" title="Gorm-迁移功能模块原理说明">Gorm-迁移功能模块原理说明</a><time datetime="2026-01-11T10:56:27.000Z" title="发表于 2026-01-11 18:56:27">2026-01-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2026/01/11/web/gorm/10-plugin/" title="Gorm-插件系统模块原理说明"><img src="/img/go.png" onerror="this.onerror=null;this.src='/img/404.png'" alt="Gorm-插件系统模块原理说明"/></a><div class="content"><a class="title" href="/2026/01/11/web/gorm/10-plugin/" title="Gorm-插件系统模块原理说明">Gorm-插件系统模块原理说明</a><time datetime="2026-01-11T10:56:27.000Z" title="发表于 2026-01-11 18:56:27">2026-01-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2026/01/11/web/gorm/07-transaction/" title="Gorm-事务处理模块原理说明"><img src="/img/go.png" onerror="this.onerror=null;this.src='/img/404.png'" alt="Gorm-事务处理模块原理说明"/></a><div class="content"><a class="title" href="/2026/01/11/web/gorm/07-transaction/" title="Gorm-事务处理模块原理说明">Gorm-事务处理模块原理说明</a><time datetime="2026-01-11T09:56:27.000Z" title="发表于 2026-01-11 17:56:27">2026-01-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2026/01/11/web/gorm/06-associations/" title="Gorm-关联关系模块原理说明"><img src="/img/go.png" onerror="this.onerror=null;this.src='/img/404.png'" alt="Gorm-关联关系模块原理说明"/></a><div class="content"><a class="title" href="/2026/01/11/web/gorm/06-associations/" title="Gorm-关联关系模块原理说明">Gorm-关联关系模块原理说明</a><time datetime="2026-01-11T08:56:27.000Z" title="发表于 2026-01-11 16:56:27">2026-01-11</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2023 - 2026 By Joohwan.</span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
  const option = null

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://piwriw-twikoo-git-main-piwriw.vercel.app/',
      region: 'ap-shanghai',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const init = (el = document, path = location.pathname) => {
    twikoo.init({
      el: el.querySelector('#twikoo-wrap'),
      envId: 'https://piwriw-twikoo-git-main-piwriw.vercel.app/',
      region: 'ap-shanghai',
      onCommentLoaded: () => {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      },
      ...option,
      path: isShuoshuo ? path : (option && option.path) || path
    })

    

    isShuoshuo && (window.shuoshuoComment.destroyTwikoo = () => {
      if (el.children.length) {
        el.innerHTML = ''
        el.classList.add('no-comment')
      }
    })
  }

  const loadTwikoo = (el, path) => {
    if (typeof twikoo === 'object') setTimeout(() => init(el, path), 0)
    else btf.getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(() => init(el, path))
  }

  if (isShuoshuo) {
    'Twikoo' === 'Twikoo'
      ? window.shuoshuoComment = { loadComment: loadTwikoo }
      : window.loadOtherComment = loadTwikoo
    return
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script></div><script src="/js/categories.js" defer></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>