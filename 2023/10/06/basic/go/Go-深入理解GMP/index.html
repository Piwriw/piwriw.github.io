<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Go-深入理解GMP | Joohwan</title><meta name="author" content="Joohwan."><meta name="copyright" content="Joohwan."><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="深入理解GMP为什么需要调度器 线程&#x2F;进程数量越多，切换成本越大  多线程 随着 同步竞争（如 锁。资源） 进程和线程内存占用大  什么是GMPG：goroutine协程 P：processor处理器 M： thread内核级线程（machine）  调度器的设计策略复用线程：避免频繁的创建、销毁线程，而是对线程的复用 1）work stealing机制 ​		当本线程无可运行的G时，尝">
<meta property="og:type" content="article">
<meta property="og:title" content="Go-深入理解GMP">
<meta property="og:url" content="https://piwriw.github.io/2023/10/06/basic/go/Go-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3GMP/index.html">
<meta property="og:site_name" content="Joohwan">
<meta property="og:description" content="深入理解GMP为什么需要调度器 线程&#x2F;进程数量越多，切换成本越大  多线程 随着 同步竞争（如 锁。资源） 进程和线程内存占用大  什么是GMPG：goroutine协程 P：processor处理器 M： thread内核级线程（machine）  调度器的设计策略复用线程：避免频繁的创建、销毁线程，而是对线程的复用 1）work stealing机制 ​		当本线程无可运行的G时，尝">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://piwriw.github.io/img/go.png">
<meta property="article:published_time" content="2023-10-06T08:08:55.000Z">
<meta property="article:modified_time" content="2026-02-28T13:29:12.657Z">
<meta property="article:author" content="Joohwan.">
<meta property="article:tag" content="go">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://piwriw.github.io/img/go.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Go-深入理解GMP",
  "url": "https://piwriw.github.io/2023/10/06/basic/go/Go-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3GMP/",
  "image": "https://piwriw.github.io/img/go.png",
  "datePublished": "2023-10-06T08:08:55.000Z",
  "dateModified": "2026-02-28T13:29:12.657Z",
  "author": [
    {
      "@type": "Person",
      "name": "Joohwan.",
      "url": "https://github.com/Piwriw"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://piwriw.github.io/2023/10/06/basic/go/Go-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3GMP/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Go-深入理解GMP',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><script src="/js/welcome.js"></script><script src="https://npm.elemecdn.com/echarts@4.9.0/dist/echarts.min.js"></script><link rel="stylesheet" href="/css/categories.css"><link rel="stylesheet" href="/css/tabs.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">259</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">76</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">60</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/charts/"><i class="fa-fw fas fa-folder-open"></i><span> 文章统计</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div><div class="menus_item"><a class="site-page" href="/wish/"><i class="fa-fw fas fa-tags"></i><span> 许愿墙</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/go.png);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Joohwan</span></a><a class="nav-page-title" href="/"><span class="site-name">Go-深入理解GMP</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/charts/"><i class="fa-fw fas fa-folder-open"></i><span> 文章统计</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div><div class="menus_item"><a class="site-page" href="/wish/"><i class="fa-fw fas fa-tags"></i><span> 许愿墙</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Go-深入理解GMP</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-10-06T08:08:55.000Z" title="发表于 2023-10-06 16:08:55">2023-10-06</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2026-02-28T13:29:12.657Z" title="更新于 2026-02-28 21:29:12">2026-02-28</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/basic/">basic</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/basic/go/">go</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">1.3k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>4分钟</span></span><span class="post-meta-separator">|</span><span id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="twikoo_visitors"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><div id="post-outdate-notice" data="{&quot;limitDay&quot;:365,&quot;messagePrev&quot;:&quot;It has been&quot;,&quot;messageNext&quot;:&quot;days since the last update, the content of the article may be outdated.&quot;,&quot;postUpdate&quot;:&quot;2026-02-28 21:29:12&quot;}" hidden></div><h1 id="深入理解GMP"><a href="#深入理解GMP" class="headerlink" title="深入理解GMP"></a>深入理解GMP</h1><h2 id="为什么需要调度器"><a href="#为什么需要调度器" class="headerlink" title="为什么需要调度器"></a>为什么需要调度器</h2><ol>
<li>线程&#x2F;进程数量越多，切换成本越大 </li>
<li>多线程 随着 同步竞争（如 锁。资源）</li>
<li>进程和线程内存占用大</li>
</ol>
<h2 id="什么是GMP"><a href="#什么是GMP" class="headerlink" title="什么是GMP"></a>什么是GMP</h2><p>G：goroutine协程</p>
<p>P：processor处理器</p>
<p>M： thread内核级线程（machine）</p>
<p><img src="https://raw.githubusercontent.com/Piwriw/PicGo/master/images/202310022204197.png"></p>
<h2 id="调度器的设计策略"><a href="#调度器的设计策略" class="headerlink" title="调度器的设计策略"></a>调度器的设计策略</h2><p><strong>复用线程</strong>：避免频繁的创建、销毁线程，而是对线程的复用</p>
<p>1）work stealing机制</p>
<p>​		当本线程无可运行的G时，尝试从其他线程绑定的P偷取G，而不是销毁线程</p>
<ul>
<li><p>先从全局队列拿，全局没有的时候，在从其他线程绑定的P的<strong>本地队列</strong>“窃取”</p>
</li>
<li><p>执行条件</p>
<p>1、当前p本地队列有待执行g<br>2、没有空闲的p和m, 全局g队列为空 (此时意味这全局繁忙)<br>3、 需要处理网络 I&#x2F;O</p>
</li>
</ul>
<p>2）hand off机制</p>
<p>​		当本线程因为G进行系统调用阻塞时，线程释放绑定的P，把P转移给其他空闲的线程执行</p>
<p>3)go func()调度过程</p>
<p><img src="https://raw.githubusercontent.com/Piwriw/PicGo/master/images/202310042013538.png"></p>
<ol>
<li>go func（）创建一个goroutine</li>
<li>有俩个存储G的本地，新建G优先放在P的本地队列，本地队列满就放在全局队列</li>
<li>G指南运行在M，一个M必须有一个P，M与P是1:1的关系。P的本地为空，M会从（先全局后其他P的本地队列）拿一个G</li>
<li>一个M一个G的不断循环的过程</li>
<li>当M执行G的时候发生syscall或者阻塞，M会阻塞，当前一些G在执行，runtime就会吧M从P的删除，创建一个新的M去绑定P（P舍弃M，绑定新的M）</li>
<li>M调用结束，拿一个新的G，拿不到，M进入休眠</li>
</ol>
<h2 id="GO的启动周期"><a href="#GO的启动周期" class="headerlink" title="GO的启动周期"></a>GO的启动周期</h2><h3 id="M0和G0"><a href="#M0和G0" class="headerlink" title="M0和G0"></a>M0和G0</h3><p>M0:</p>
<ol>
<li>启动程序后的<strong>编号为0</strong>的主线程</li>
<li>在全局变量<strong>runtime.m0</strong>中，不需要在heap上分配</li>
<li>负责执行初始化操作和<strong>启动第一个G</strong></li>
<li>启动第一个G之后，<strong>M0和其他M同等</strong></li>
</ol>
<p>G0：</p>
<ol>
<li>每次<strong>启动第一个M</strong>，都会<strong>第一个创建的gourtime</strong>，就是G0</li>
<li>G0仅用于<strong>负责调度G</strong></li>
<li>G0<strong>不指向任何可执行函数</strong><font color=red>G0就是来调度其他G，所有G得指挥所</font></li>
<li>每一个M都有一个自己的G0</li>
<li>在调度或者系统调用时候会使用M来切换到G0</li>
<li>M0的G0在全局空间中</li>
</ol>
<h2 id="GMP可视化"><a href="#GMP可视化" class="headerlink" title="GMP可视化"></a>GMP可视化</h2><h3 id="trace调试"><a href="#trace调试" class="headerlink" title="trace调试"></a>trace调试</h3><p>基本的trace：</p>
<ol>
<li>创建trace文件 f, err:&#x3D;os.Create(“trace.out”)</li>
<li>启动trace trace.Start()</li>
<li>停止trace trace.Stop()</li>
<li>Go build 并且运行之后，会得到一个trace.out文件</li>
<li>通过go tool trace 工具打开trace文件，<code>go tool trace trace.out</code></li>
</ol>
<h3 id="GMP终端GODEBUG调试"><a href="#GMP终端GODEBUG调试" class="headerlink" title="GMP终端GODEBUG调试"></a>GMP终端GODEBUG调试</h3><ul>
<li>gomaxprocess P的数量 一般默认是和CPU核心数是一样的</li>
<li>idlleprocs 处理idle状态的P数量，gomaxprocs-idlleprocs&#x3D; 目前正在执行的p的数量</li>
<li>threads 线程数量</li>
<li>spinningthreads 处于自旋的thread数量</li>
<li>idllethread 处理idle状态的thread数量</li>
<li>runqueue 全局G队列中的G的数量</li>
<li>【0，0】每个P的local  queue本地队列，目前存在G的数量</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 先go build xx.go 生成文件</span></span><br><span class="line"><span class="comment"># GODEBUG=schedtrace=1000 ./xx.go</span></span><br></pre></td></tr></table></figure>

<h2 id="GMP场景"><a href="#GMP场景" class="headerlink" title="GMP场景"></a>GMP场景</h2><h3 id="场景1-G1创建G3"><a href="#场景1-G1创建G3" class="headerlink" title="场景1:G1创建G3"></a>场景1:G1创建G3</h3><p>局部性：G3优先加入G1所在M（他们之间可能共享资源）【创建G优先在G所在M】</p>
<h3 id="场景2-G1执行完毕"><a href="#场景2-G1执行完毕" class="headerlink" title="场景2:G1执行完毕"></a>场景2:G1执行完毕</h3><p>G1在完成退出之后，拿到G0，G0优先从本地队列P中取到其他G 运行</p>
<h3 id="场景3、4、5-G2开辟过多G，全局队列满，全局队列不满"><a href="#场景3、4、5-G2开辟过多G，全局队列满，全局队列不满" class="headerlink" title="场景3、4、5:G2开辟过多G，全局队列满，全局队列不满"></a>场景3、4、5:G2开辟过多G，全局队列满，全局队列不满</h3><p>G2想要创建的G 超过了本地队列P的最大容量</p>
<p><strong>G7，G8就是还要多出来创建的G</strong></p>
<ol>
<li>先存满本地队列P，<strong>满了把G7放入全局队列</strong></li>
<li>平均分割本地队列P的一半</li>
<li>把前面一半G放入全局队列，同时如果本地队列满，不满创建G8</li>
</ol>
<h3 id="场景6-唤醒正在休眠的M"><a href="#场景6-唤醒正在休眠的M" class="headerlink" title="场景6:唤醒正在休眠的M"></a>场景6:唤醒正在休眠的M</h3><p>每次创建G，就会尝试唤醒M（前提有休眠队列中有空闲M）</p>
<ol>
<li>M寻找P绑定</li>
<li>本地队列P如果是空的，进入自旋寻找G</li>
</ol>
<h3 id="场景7-被唤醒的M从全局队列获取G"><a href="#场景7-被唤醒的M从全局队列获取G" class="headerlink" title="场景7:被唤醒的M从全局队列获取G"></a>场景7:被唤醒的M从全局队列获取G</h3><p><strong>实现了全局队列到P的负载均衡</strong></p>
<p>因为唤醒的M，此时本队队列P为空</p>
<p>n&#x3D;min（len（GQ全局队列长度）&#x2F;GOMAXPROCS+1，len（GQ）&#x2F;2）</p>
<ol>
<li>此时唤醒的M的本队P尝试从全局队列中获取n个G</li>
</ol>
<h3 id="场景8-M2从M1中偷取G"><a href="#场景8-M2从M1中偷取G" class="headerlink" title="场景8:M2从M1中偷取G"></a>场景8:M2从M1中偷取G</h3><p>当M2中的本地队列P为空的时候，并且全局队列也为空</p>
<p>此时，分割一半M1的本地队列P，</p>
<p>M2的本地队列P”偷取”后一半的G到本地队列P</p>
<h3 id="场景9-自旋线程的最大限制"><a href="#场景9-自旋线程的最大限制" class="headerlink" title="场景9:自旋线程的最大限制"></a>场景9:自旋线程的最大限制</h3><p>GOMAXPROCS是P的数量限制</p>
<p><strong>自旋线程+执行线程&lt;&#x3D;GOMAXPROCS</strong></p>
<h3 id="场景10-G发生系统调用-阻塞"><a href="#场景10-G发生系统调用-阻塞" class="headerlink" title="场景10:G发生系统调用&#x2F;阻塞"></a>场景10:G发生系统调用&#x2F;阻塞</h3><ol>
<li>阻塞｜系统调用的G，直接绑定到M上</li>
<li>此时阻塞的M的P去寻找新的P，不然只能<strong>P进入到空闲队列P</strong></li>
<li>找到新的M之后，P绑定到新的M5上</li>
</ol>
<p><img src="https://raw.githubusercontent.com/Piwriw/PicGo/master/images/202310051557098.png"></p>
<h3 id="场景11-G发生非阻塞"><a href="#场景11-G发生非阻塞" class="headerlink" title="场景11:G发生非阻塞"></a>场景11:G发生非阻塞</h3><p>G8恢复到非阻塞的状态，此时缺少P</p>
<ol>
<li>G8先寻找原配P，P2已绑定，就寻找其他空闲P</li>
<li>G8找不到空闲P，就G8进入全局队列，M2进入休眠线程队列</li>
</ol>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a target="_blank" rel="noopener" href="https://github.com/Piwriw">Joohwan.</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://piwriw.github.io/2023/10/06/basic/go/Go-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3GMP/">https://piwriw.github.io/2023/10/06/basic/go/Go-深入理解GMP/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://piwriw.github.io" target="_blank">Joohwan</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/go/">go</a></div><div class="post-share"><div class="social-share" data-image="/img/go.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>赞助</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2023/10/06/tools/homebrew%E5%AE%89%E8%A3%85redis%EF%BC%88Mac%EF%BC%89/" title="homebrew安装redis（Mac）"><img class="cover" src="/img/basic_read.png" onerror="onerror=null;src='/img/404.png'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">homebrew安装redis（Mac）</div></div><div class="info-2"><div class="info-item-1">homebrew安装redis（Mac）已经确保安装好brew12345678910# 安装redisbrew install redis# 启动redis#方式一：使用brew帮助我们启动软件brew services start redis#方式二redis-server /usr/local/etc/redis.conf#方式三 redis-server  配置文件安装位置 Homebrew安装的软件会默认在/usr/local/Cellar/路径下 redis的配置文件redis.conf存放在/usr/local/etc路径下 修改redis.conf设置密码（  # requirepass foobared ）为（  requirepass yourpassword） Redis可视化工具推荐AnotherRedisDesktopManager 2023-10 目前已经获得27K  :star: </div></div></div></a><a class="pagination-related" href="/2023/10/05/basic/go/Go-panic%E4%B8%8Erecover/" title="Go 的panic与recover"><img class="cover" src="/img/go.png" onerror="onerror=null;src='/img/404.png'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">Go 的panic与recover</div></div><div class="info-2"><div class="info-item-1">Go 的panic与recoverpanic和recover调用时机 panic 能够改变程序的控制流，函数调用panic 时会立刻停止执行函数的其他代码，并在执行结束后在当前 Goroutine 中递归执行调用方的延迟函数调用 defer； recover 可以中止 panic 造成的程序崩溃。它是一个只能在 defer 中发挥作用的函数，在其他作用域中调用不会发挥任何作用； panic 只会触发当前 Goroutine 的延迟函数调用； recover 只有在 defer 函数中调用才会生效； panic 允许在 defer 中嵌套多次调用；  panic panic不允许跨协程  panic真正的程序崩溃的过程： 编译器会将关键字 panic 转换成 runtime.gopanic，该函数的执行过程包含以下几个步骤：  创建新的 runtime._panic 结构并添加到所在 Goroutine _panic 链表的最前面； 在循环中不断从当前 Goroutine 的 _defer 中链表获取 runtime._defer 并调用 runtime.reflectcall 运...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2025/08/22/basic/go/Gorm-Open(DB%E8%BF%9E%E6%8E%A5%E4%B8%8E%E9%85%8D%E7%BD%AE)/" title="Gorm-Open（DB连接与配置）"><img class="cover" src="/img/go.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-08-22</div><div class="info-item-2">Gorm-Open（DB连接与配置）</div></div><div class="info-2"><div class="info-item-1">Gorm-Open（DB连接与配置） 基于1.31.0  工作原理graph TD     A[Open&lt;br/&gt;打开数据库连接] --&gt; B[Initialize Config&lt;br/&gt;初始化配置]     B --&gt; C[Initialize Dialector&lt;br/&gt;初始化数据库方言]     C --&gt; D[Setup Connection Pool&lt;br/&gt;设置连接池]     D --&gt; E[Setup Callbacks&lt;br/&gt;设置回调]     E --&gt; F[Ping Database&lt;br/&gt;连接数据库测试]     F --&gt; G[DB Instance Ready&lt;br/&gt;数据库实例就绪]          G --&gt; H[Session&lt;br/&gt;创建会话]     H --&gt; I[Create New Session&lt;br/&gt;创建新会话]     I --&gt; J[Apply Session ...</div></div></div></a><a class="pagination-related" href="/2025/08/20/basic/go/Gin-%E9%A1%B9%E7%9B%AE%E5%88%9D%E5%A7%8B%E5%8C%96(New)/" title="Gin-项目初始化（New）"><img class="cover" src="/img/go.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-08-20</div><div class="info-item-2">Gin-项目初始化（New）</div></div><div class="info-2"><div class="info-item-1">Gin-项目初始化（New） 基于1.10.0  工作原理Engine核心结构体graph TD     A[Engine] --&gt; B[RouterGroup]     A --&gt; C[trees: methodTrees]     A --&gt; D[pool: sync.Pool]     A --&gt; E[HTMLRender]     A --&gt; F[配置选项]          F --&gt; F1[RedirectTrailingSlash]     F --&gt; F2[RedirectFixedPath]     F --&gt; F3[HandleMethodNotAllowed]     F --&gt; F4[ForwardedByClientIP]     F --&gt; F5[UseH2C]   路由注册流程graph TD     A[AddRoute] --&gt; B&#123;检查路径和方法&#125;     B --&gt; C[获取对应method的tree]     C --&gt; D[创建新node如果...</div></div></div></a><a class="pagination-related" href="/2025/03/21/basic/go/Go-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Sort/" title="GO-深入理解Sort"><img class="cover" src="/img/go.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-03-21</div><div class="info-item-2">GO-深入理解Sort</div></div><div class="info-2"><div class="info-item-1">GO-深入理解SortGo 语言的 sort 包提供了对切片和用户自定义集合进行排序的功能。它的设计非常灵活，支持多种数据类型的排序，并且允许用户通过实现接口来自定义排序规则。以下是对 sort 包的深入解析，包括其核心接口、实现原理以及使用方法 核心接口12345678910type Interface interface &#123;    // Len 返回集合中的元素数量    Len() int    // Less 返回索引为 i 的元素是否应该排在索引为 j 的元素之前    Less(i, j int) bool    // Swap 交换索引为 i 和 j 的元素    Swap(i, j int)&#125;  排序函数sort.Sort 对实现了 sort.Interface 接口的类型进行排序  exmaple： 12345678910111213141516171819202122232425262728package mainimport (	&quot;fmt&quot;	&quot;sort&quot;)type Person struct &#1...</div></div></div></a><a class="pagination-related" href="/2024/10/15/basic/go/%E5%AE%B9%E5%99%A8%E7%8E%AF%E5%A2%83-GOMAXPROCS%E5%8F%82%E6%95%B0%E8%AE%BE%E7%BD%AE/" title="容器环境-GOMAXPROCS参数设置"><img class="cover" src="/img/golang.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-10-15</div><div class="info-item-2">容器环境-GOMAXPROCS参数设置</div></div><div class="info-2"><div class="info-item-1">容器环境-GOMAXPROCS参数设置  GOMAXPROCS通过设定 GOMAXPROCS，用户可以调整调度器中 Processor（简称P）的数量。由于每个系统线程，必须要绑定 P ，P 才能把G交给 M 执行。所以 P 的数量会很大程度上影响 Go Runtime 的并发表现。GOMAXPROCS 在版本 1.5后的默认值是机器的 CPU 核数 （runtime.NumCPU） 设置GOMAXPROCS1234567891011121314package mainimport (    &quot;fmt&quot;    &quot;runtime&quot;)func main() &#123;    n := runtime.NumCPU() // 获取机器的CPU核心数    fmt.Printf(&quot;NumCPU: %d\n&quot;, n)    if n &gt; 0 &#123;       runtime.GOMAXPROCS(n) // 设置GOMAXPROCS为CPU核心数    &#125;&#125;   容器内运行输出的是宿主机的CPU...</div></div></div></a><a class="pagination-related" href="/2024/10/11/basic/go/Go-Options%E6%A8%A1%E5%BC%8F/" title="Go-Options模式"><img class="cover" src="/img/go.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-10-11</div><div class="info-item-2">Go-Options模式</div></div><div class="info-2"><div class="info-item-1">Go-Options模式Options模式Options模式可以让具有多个可选参数的函数或者方法更整洁和好扩展，当一个函数具有五六个甚至十个以上的可选参数时使用这种模式的优势会体现的很明显 问题当我们发送一个Http请求，可能需要携带很多参数。比如： 1func HttpRequest(method string, url string, body []byte, headers map[string]string, timeout time.Duration)   有的时候又可能有些参数是不需要的,所以可能变成了： 1HttpRequest(&#x27;GET&#x27;, &#x27;https://www.baidu.com&#x27;, nil, nil, 2 * time.Second)  解决办法一:把配置全转换为结构体对象1234567type HttpClientConfig struct &#123;  timeout time.Duration  headers map[string]string  body    []byte&#125;func HttpR...</div></div></div></a><a class="pagination-related" href="/2024/09/15/basic/go/GO-%E6%B7%B1%E6%8B%B7%E8%B4%9D/" title="GO-深拷贝"><img class="cover" src="/img/go.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-09-15</div><div class="info-item-2">GO-深拷贝</div></div><div class="info-2"><div class="info-item-1">GO-深拷贝复习在 Go 语言中，所有的函数参数传递都是值传递（pass by value），当将参数传递给函数时，实际上是将参数的副本传递给函数。 然而，这并不意味着在函数内部对参数的修改都不会影响原始数据。因为在 Go 中，有些数据类型本身就是引用类型，比如切片（slice）、映射（map）、通道（channel）、接口（interface）和指针（pointer）。当这些类型作为参数传递给函数时，虽然传递的是值，但值本身就是一个引用 代码陷阱切片是结构 预期：Before和After是一样的值，因为参数传递都是值传递  123456789101112131415161718192021222324252627282930package mainimport (	&quot;fmt&quot;	&quot;strconv&quot;)type Person struct &#123;	Name    string	Age     int	Address []string&#125;func changepeople(people []Person) &#123;	people...</div></div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Joohwan.</div><div class="author-info-description">该知道的都知道，不知道的慢慢了解</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">259</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">76</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">60</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/piwriw"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/piwriw" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:piwriw@163.com" target="_blank" title="Email"><i class="fas fa-envelope-open-text"></i></a></div></div><div class="card-widget"><div class="item-headline"><i class="iconfont icat-visitor"></i><span>来访者</span></div><div class="item-content"><div id="welcome-info"></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3GMP"><span class="toc-number">1.</span> <span class="toc-text">深入理解GMP</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E8%B0%83%E5%BA%A6%E5%99%A8"><span class="toc-number">1.1.</span> <span class="toc-text">为什么需要调度器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFGMP"><span class="toc-number">1.2.</span> <span class="toc-text">什么是GMP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E5%BA%A6%E5%99%A8%E7%9A%84%E8%AE%BE%E8%AE%A1%E7%AD%96%E7%95%A5"><span class="toc-number">1.3.</span> <span class="toc-text">调度器的设计策略</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GO%E7%9A%84%E5%90%AF%E5%8A%A8%E5%91%A8%E6%9C%9F"><span class="toc-number">1.4.</span> <span class="toc-text">GO的启动周期</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#M0%E5%92%8CG0"><span class="toc-number">1.4.1.</span> <span class="toc-text">M0和G0</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GMP%E5%8F%AF%E8%A7%86%E5%8C%96"><span class="toc-number">1.5.</span> <span class="toc-text">GMP可视化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#trace%E8%B0%83%E8%AF%95"><span class="toc-number">1.5.1.</span> <span class="toc-text">trace调试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GMP%E7%BB%88%E7%AB%AFGODEBUG%E8%B0%83%E8%AF%95"><span class="toc-number">1.5.2.</span> <span class="toc-text">GMP终端GODEBUG调试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GMP%E5%9C%BA%E6%99%AF"><span class="toc-number">1.6.</span> <span class="toc-text">GMP场景</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%BA%E6%99%AF1-G1%E5%88%9B%E5%BB%BAG3"><span class="toc-number">1.6.1.</span> <span class="toc-text">场景1:G1创建G3</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%BA%E6%99%AF2-G1%E6%89%A7%E8%A1%8C%E5%AE%8C%E6%AF%95"><span class="toc-number">1.6.2.</span> <span class="toc-text">场景2:G1执行完毕</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%BA%E6%99%AF3%E3%80%814%E3%80%815-G2%E5%BC%80%E8%BE%9F%E8%BF%87%E5%A4%9AG%EF%BC%8C%E5%85%A8%E5%B1%80%E9%98%9F%E5%88%97%E6%BB%A1%EF%BC%8C%E5%85%A8%E5%B1%80%E9%98%9F%E5%88%97%E4%B8%8D%E6%BB%A1"><span class="toc-number">1.6.3.</span> <span class="toc-text">场景3、4、5:G2开辟过多G，全局队列满，全局队列不满</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%BA%E6%99%AF6-%E5%94%A4%E9%86%92%E6%AD%A3%E5%9C%A8%E4%BC%91%E7%9C%A0%E7%9A%84M"><span class="toc-number">1.6.4.</span> <span class="toc-text">场景6:唤醒正在休眠的M</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%BA%E6%99%AF7-%E8%A2%AB%E5%94%A4%E9%86%92%E7%9A%84M%E4%BB%8E%E5%85%A8%E5%B1%80%E9%98%9F%E5%88%97%E8%8E%B7%E5%8F%96G"><span class="toc-number">1.6.5.</span> <span class="toc-text">场景7:被唤醒的M从全局队列获取G</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%BA%E6%99%AF8-M2%E4%BB%8EM1%E4%B8%AD%E5%81%B7%E5%8F%96G"><span class="toc-number">1.6.6.</span> <span class="toc-text">场景8:M2从M1中偷取G</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%BA%E6%99%AF9-%E8%87%AA%E6%97%8B%E7%BA%BF%E7%A8%8B%E7%9A%84%E6%9C%80%E5%A4%A7%E9%99%90%E5%88%B6"><span class="toc-number">1.6.7.</span> <span class="toc-text">场景9:自旋线程的最大限制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%BA%E6%99%AF10-G%E5%8F%91%E7%94%9F%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8-%E9%98%BB%E5%A1%9E"><span class="toc-number">1.6.8.</span> <span class="toc-text">场景10:G发生系统调用&#x2F;阻塞</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%BA%E6%99%AF11-G%E5%8F%91%E7%94%9F%E9%9D%9E%E9%98%BB%E5%A1%9E"><span class="toc-number">1.6.9.</span> <span class="toc-text">场景11:G发生非阻塞</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2026/01/11/web/gorm/09-logger/" title="Gorm-日志系统模块原理说明"><img src="/img/go.png" onerror="this.onerror=null;this.src='/img/404.png'" alt="Gorm-日志系统模块原理说明"/></a><div class="content"><a class="title" href="/2026/01/11/web/gorm/09-logger/" title="Gorm-日志系统模块原理说明">Gorm-日志系统模块原理说明</a><time datetime="2026-01-11T11:56:27.000Z" title="发表于 2026-01-11 19:56:27">2026-01-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2026/01/11/web/gorm/08-migration/" title="Gorm-迁移功能模块原理说明"><img src="/img/go.png" onerror="this.onerror=null;this.src='/img/404.png'" alt="Gorm-迁移功能模块原理说明"/></a><div class="content"><a class="title" href="/2026/01/11/web/gorm/08-migration/" title="Gorm-迁移功能模块原理说明">Gorm-迁移功能模块原理说明</a><time datetime="2026-01-11T10:56:27.000Z" title="发表于 2026-01-11 18:56:27">2026-01-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2026/01/11/web/gorm/10-plugin/" title="Gorm-插件系统模块原理说明"><img src="/img/go.png" onerror="this.onerror=null;this.src='/img/404.png'" alt="Gorm-插件系统模块原理说明"/></a><div class="content"><a class="title" href="/2026/01/11/web/gorm/10-plugin/" title="Gorm-插件系统模块原理说明">Gorm-插件系统模块原理说明</a><time datetime="2026-01-11T10:56:27.000Z" title="发表于 2026-01-11 18:56:27">2026-01-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2026/01/11/web/gorm/07-transaction/" title="Gorm-事务处理模块原理说明"><img src="/img/go.png" onerror="this.onerror=null;this.src='/img/404.png'" alt="Gorm-事务处理模块原理说明"/></a><div class="content"><a class="title" href="/2026/01/11/web/gorm/07-transaction/" title="Gorm-事务处理模块原理说明">Gorm-事务处理模块原理说明</a><time datetime="2026-01-11T09:56:27.000Z" title="发表于 2026-01-11 17:56:27">2026-01-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2026/01/11/web/gorm/06-associations/" title="Gorm-关联关系模块原理说明"><img src="/img/go.png" onerror="this.onerror=null;this.src='/img/404.png'" alt="Gorm-关联关系模块原理说明"/></a><div class="content"><a class="title" href="/2026/01/11/web/gorm/06-associations/" title="Gorm-关联关系模块原理说明">Gorm-关联关系模块原理说明</a><time datetime="2026-01-11T08:56:27.000Z" title="发表于 2026-01-11 16:56:27">2026-01-11</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2023 - 2026 By Joohwan.</span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
  const option = null

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://piwriw-twikoo-git-main-piwriw.vercel.app/',
      region: 'ap-shanghai',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const init = (el = document, path = location.pathname) => {
    twikoo.init({
      el: el.querySelector('#twikoo-wrap'),
      envId: 'https://piwriw-twikoo-git-main-piwriw.vercel.app/',
      region: 'ap-shanghai',
      onCommentLoaded: () => {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      },
      ...option,
      path: isShuoshuo ? path : (option && option.path) || path
    })

    

    isShuoshuo && (window.shuoshuoComment.destroyTwikoo = () => {
      if (el.children.length) {
        el.innerHTML = ''
        el.classList.add('no-comment')
      }
    })
  }

  const loadTwikoo = (el, path) => {
    if (typeof twikoo === 'object') setTimeout(() => init(el, path), 0)
    else btf.getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(() => init(el, path))
  }

  if (isShuoshuo) {
    'Twikoo' === 'Twikoo'
      ? window.shuoshuoComment = { loadComment: loadTwikoo }
      : window.loadOtherComment = loadTwikoo
    return
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script></div><script src="/js/categories.js" defer></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>