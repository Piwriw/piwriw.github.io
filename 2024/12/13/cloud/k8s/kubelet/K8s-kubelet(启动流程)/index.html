<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>K8s-kubelet(Overview) | Joohwan</title><meta name="author" content="Joohwan."><meta name="copyright" content="Joohwan."><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="K8s-kubelet(Overview) 基于1.25  kubelete的启动流程主要分为5个步骤：  Cobra命令参数解析 运行环境检测和设置 Kubelet对象实例化 启动kubelet主服务 启动HTTP Server服务和gRPC Server   Cobra命令行参数解析 Ref:https:&#x2F;&#x2F;github.com&#x2F;kubernetes&#x2F;kubernetes&#x2F;blob&#x2F;88e99">
<meta property="og:type" content="article">
<meta property="og:title" content="K8s-kubelet(Overview)">
<meta property="og:url" content="https://piwriw.github.io/2024/12/13/cloud/k8s/kubelet/K8s-kubelet(%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B)/index.html">
<meta property="og:site_name" content="Joohwan">
<meta property="og:description" content="K8s-kubelet(Overview) 基于1.25  kubelete的启动流程主要分为5个步骤：  Cobra命令参数解析 运行环境检测和设置 Kubelet对象实例化 启动kubelet主服务 启动HTTP Server服务和gRPC Server   Cobra命令行参数解析 Ref:https:&#x2F;&#x2F;github.com&#x2F;kubernetes&#x2F;kubernetes&#x2F;blob&#x2F;88e99">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://piwriw.github.io/img/k8sLogo.png">
<meta property="article:published_time" content="2024-12-13T13:22:55.000Z">
<meta property="article:modified_time" content="2026-02-28T13:29:12.670Z">
<meta property="article:author" content="Joohwan.">
<meta property="article:tag" content="k8s">
<meta property="article:tag" content="cloud">
<meta property="article:tag" content="K8s源码">
<meta property="article:tag" content="kubelet">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://piwriw.github.io/img/k8sLogo.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "K8s-kubelet(Overview)",
  "url": "https://piwriw.github.io/2024/12/13/cloud/k8s/kubelet/K8s-kubelet(%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B)/",
  "image": "https://piwriw.github.io/img/k8sLogo.png",
  "datePublished": "2024-12-13T13:22:55.000Z",
  "dateModified": "2026-02-28T13:29:12.670Z",
  "author": [
    {
      "@type": "Person",
      "name": "Joohwan.",
      "url": "https://github.com/Piwriw"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://piwriw.github.io/2024/12/13/cloud/k8s/kubelet/K8s-kubelet(%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B)/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'K8s-kubelet(Overview)',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><script src="/js/welcome.js"></script><script src="https://npm.elemecdn.com/echarts@4.9.0/dist/echarts.min.js"></script><link rel="stylesheet" href="/css/categories.css"><link rel="stylesheet" href="/css/tabs.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">259</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">76</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">60</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/charts/"><i class="fa-fw fas fa-folder-open"></i><span> 文章统计</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div><div class="menus_item"><a class="site-page" href="/wish/"><i class="fa-fw fas fa-tags"></i><span> 许愿墙</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/k8sLogo.png);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Joohwan</span></a><a class="nav-page-title" href="/"><span class="site-name">K8s-kubelet(Overview)</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/charts/"><i class="fa-fw fas fa-folder-open"></i><span> 文章统计</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div><div class="menus_item"><a class="site-page" href="/wish/"><i class="fa-fw fas fa-tags"></i><span> 许愿墙</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">K8s-kubelet(Overview)</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-12-13T13:22:55.000Z" title="发表于 2024-12-13 21:22:55">2024-12-13</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2026-02-28T13:29:12.670Z" title="更新于 2026-02-28 21:29:12">2026-02-28</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud/">cloud</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud/k8s/">k8s</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud/k8s/kubelet/">kubelet</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">7.8k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>45分钟</span></span><span class="post-meta-separator">|</span><span id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="twikoo_visitors"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><div id="post-outdate-notice" data="{&quot;limitDay&quot;:365,&quot;messagePrev&quot;:&quot;It has been&quot;,&quot;messageNext&quot;:&quot;days since the last update, the content of the article may be outdated.&quot;,&quot;postUpdate&quot;:&quot;2026-02-28 21:29:12&quot;}" hidden></div><h1 id="K8s-kubelet-Overview"><a href="#K8s-kubelet-Overview" class="headerlink" title="K8s-kubelet(Overview)"></a>K8s-kubelet(Overview)</h1><blockquote>
<p>基于1.25</p>
</blockquote>
<p>kubelete的启动流程主要分为5个步骤：</p>
<ol>
<li>Cobra命令参数解析</li>
<li>运行环境检测和设置</li>
<li>Kubelet对象实例化</li>
<li>启动kubelet主服务</li>
<li>启动HTTP Server服务和gRPC Server</li>
</ol>
<p><img src="https://raw.githubusercontent.com/Piwriw/PicGo/master/image202412122250672.png"></p>
<h2 id="Cobra命令行参数解析"><a href="#Cobra命令行参数解析" class="headerlink" title="Cobra命令行参数解析"></a>Cobra命令行参数解析</h2><ul>
<li><p>Ref:<a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/88e994f6bf8fc88114c5b733e09afea339bea66d/cmd/kubelet/app/server.go#L123">https://github.com/kubernetes/kubernetes/blob/88e994f6bf8fc88114c5b733e09afea339bea66d/cmd/kubelet/app/server.go#L123</a></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NewKubeletCommand creates a *cobra.Command object with default parameters</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewKubeletCommand</span><span class="params">()</span></span> *cobra.Command &#123;</span><br><span class="line">	cleanFlagSet := pflag.NewFlagSet(componentKubelet, pflag.ContinueOnError)</span><br><span class="line">	cleanFlagSet.SetNormalizeFunc(cliflag.WordSepNormalizeFunc)</span><br><span class="line">	kubeletFlags := options.NewKubeletFlags()</span><br><span class="line"></span><br><span class="line">	kubeletConfig, err := options.NewKubeletConfiguration()</span><br><span class="line">	<span class="comment">// programmer error</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		klog.ErrorS(err, <span class="string">&quot;Failed to create a new kubelet configuration&quot;</span>)</span><br><span class="line">		os.Exit(<span class="number">1</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	cmd := &amp;cobra.Command&#123;</span><br><span class="line">		Use: componentKubelet,</span><br><span class="line">		Long: <span class="string">`The kubelet is the primary &quot;node agent&quot; that runs on each</span></span><br><span class="line"><span class="string">node. It can register the node with the apiserver using one of: the hostname; a flag to</span></span><br><span class="line"><span class="string">override the hostname; or specific logic for a cloud provider.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">The kubelet works in terms of a PodSpec. A PodSpec is a YAML or JSON object</span></span><br><span class="line"><span class="string">that describes a pod. The kubelet takes a set of PodSpecs that are provided through</span></span><br><span class="line"><span class="string">various mechanisms (primarily through the apiserver) and ensures that the containers</span></span><br><span class="line"><span class="string">described in those PodSpecs are running and healthy. The kubelet doesn&#x27;t manage</span></span><br><span class="line"><span class="string">containers which were not created by Kubernetes.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Other than from an PodSpec from the apiserver, there are three ways that a container</span></span><br><span class="line"><span class="string">manifest can be provided to the Kubelet.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">File: Path passed as a flag on the command line. Files under this path will be monitored</span></span><br><span class="line"><span class="string">periodically for updates. The monitoring period is 20s by default and is configurable</span></span><br><span class="line"><span class="string">via a flag.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">HTTP endpoint: HTTP endpoint passed as a parameter on the command line. This endpoint</span></span><br><span class="line"><span class="string">is checked every 20 seconds (also configurable with a flag).</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">HTTP server: The kubelet can also listen for HTTP and respond to a simple API</span></span><br><span class="line"><span class="string">(underspec&#x27;d currently) to submit a new manifest.`</span>,</span><br><span class="line">		<span class="comment">// The Kubelet has special flag parsing requirements to enforce flag precedence rules,</span></span><br><span class="line">		<span class="comment">// so we do all our parsing manually in Run, below.</span></span><br><span class="line">		<span class="comment">// DisableFlagParsing=true provides the full set of flags passed to the kubelet in the</span></span><br><span class="line">		<span class="comment">// `args` arg to Run, without Cobra&#x27;s interference.</span></span><br><span class="line">		DisableFlagParsing: <span class="literal">true</span>,</span><br><span class="line">		SilenceUsage:       <span class="literal">true</span>,</span><br><span class="line">		RunE: <span class="function"><span class="keyword">func</span><span class="params">(cmd *cobra.Command, args []<span class="type">string</span>)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">			<span class="comment">// initial flag parse, since we disable cobra&#x27;s flag parsing</span></span><br><span class="line">			<span class="keyword">if</span> err := cleanFlagSet.Parse(args); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to parse kubelet flag: %w&quot;</span>, err)</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// check if there are non-flag arguments in the command line</span></span><br><span class="line">			cmds := cleanFlagSet.Args()</span><br><span class="line">			<span class="keyword">if</span> <span class="built_in">len</span>(cmds) &gt; <span class="number">0</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;unknown command %+s&quot;</span>, cmds[<span class="number">0</span>])</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// short-circuit on help</span></span><br><span class="line">			help, err := cleanFlagSet.GetBool(<span class="string">&quot;help&quot;</span>)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> errors.New(<span class="string">`&quot;help&quot; flag is non-bool, programmer error, please correct`</span>)</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> help &#123;</span><br><span class="line">				<span class="keyword">return</span> cmd.Help()</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// short-circuit on verflag</span></span><br><span class="line">			verflag.PrintAndExitIfRequested()</span><br><span class="line"></span><br><span class="line">			<span class="comment">// set feature gates from initial flags-based config</span></span><br><span class="line">			<span class="keyword">if</span> err := utilfeature.DefaultMutableFeatureGate.SetFromMap(kubeletConfig.FeatureGates); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to set feature gates from initial flags-based config: %w&quot;</span>, err)</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// validate the initial KubeletFlags</span></span><br><span class="line">			<span class="keyword">if</span> err := options.ValidateKubeletFlags(kubeletFlags); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to validate kubelet flags: %w&quot;</span>, err)</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> cleanFlagSet.Changed(<span class="string">&quot;pod-infra-container-image&quot;</span>) &#123;</span><br><span class="line">				klog.InfoS(<span class="string">&quot;--pod-infra-container-image will not be pruned by the image garbage collector in kubelet and should also be set in the remote runtime&quot;</span>)</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// load kubelet config file, if provided</span></span><br><span class="line">			<span class="keyword">if</span> configFile := kubeletFlags.KubeletConfigFile; <span class="built_in">len</span>(configFile) &gt; <span class="number">0</span> &#123;</span><br><span class="line">				kubeletConfig, err = loadConfigFile(configFile)</span><br><span class="line">				<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">					<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to load kubelet config file, error: %w, path: %s&quot;</span>, err, configFile)</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="comment">// We must enforce flag precedence by re-parsing the command line into the new object.</span></span><br><span class="line">				<span class="comment">// This is necessary to preserve backwards-compatibility across binary upgrades.</span></span><br><span class="line">				<span class="comment">// See issue #56171 for more details.</span></span><br><span class="line">				<span class="keyword">if</span> err := kubeletConfigFlagPrecedence(kubeletConfig, args); err != <span class="literal">nil</span> &#123;</span><br><span class="line">					<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to precedence kubeletConfigFlag: %w&quot;</span>, err)</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="comment">// update feature gates based on new config</span></span><br><span class="line">				<span class="keyword">if</span> err := utilfeature.DefaultMutableFeatureGate.SetFromMap(kubeletConfig.FeatureGates); err != <span class="literal">nil</span> &#123;</span><br><span class="line">					<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to set feature gates from initial flags-based config: %w&quot;</span>, err)</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Config and flags parsed, now we can initialize logging.</span></span><br><span class="line">			logs.InitLogs()</span><br><span class="line">			<span class="keyword">if</span> err := logsapi.ValidateAndApplyAsField(&amp;kubeletConfig.Logging, utilfeature.DefaultFeatureGate, field.NewPath(<span class="string">&quot;logging&quot;</span>)); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;initialize logging: %v&quot;</span>, err)</span><br><span class="line">			&#125;</span><br><span class="line">			cliflag.PrintFlags(cleanFlagSet)</span><br><span class="line"></span><br><span class="line">			<span class="comment">// We always validate the local configuration (command line + config file).</span></span><br><span class="line">			<span class="comment">// This is the default &quot;last-known-good&quot; config for dynamic config, and must always remain valid.</span></span><br><span class="line">			<span class="keyword">if</span> err := kubeletconfigvalidation.ValidateKubeletConfiguration(kubeletConfig, utilfeature.DefaultFeatureGate); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to validate kubelet configuration, error: %w, path: %s&quot;</span>, err, kubeletConfig)</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (kubeletConfig.KubeletCgroups != <span class="string">&quot;&quot;</span> &amp;&amp; kubeletConfig.KubeReservedCgroup != <span class="string">&quot;&quot;</span>) &amp;&amp; (strings.Index(kubeletConfig.KubeletCgroups, kubeletConfig.KubeReservedCgroup) != <span class="number">0</span>) &#123;</span><br><span class="line">				klog.InfoS(<span class="string">&quot;unsupported configuration:KubeletCgroups is not within KubeReservedCgroup&quot;</span>)</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// The features.DynamicKubeletConfig is locked to false,</span></span><br><span class="line">			<span class="comment">// feature gate is not locked using the LockedToDefault flag</span></span><br><span class="line">			<span class="comment">// to make sure node authorizer can keep working with the older nodes</span></span><br><span class="line">			<span class="keyword">if</span> utilfeature.DefaultFeatureGate.Enabled(features.DynamicKubeletConfig) &#123;</span><br><span class="line">				<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;cannot set feature gate %v to %v, feature is locked to %v&quot;</span>, features.DynamicKubeletConfig, <span class="literal">true</span>, <span class="literal">false</span>)</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// construct a KubeletServer from kubeletFlags and kubeletConfig</span></span><br><span class="line">			kubeletServer := &amp;options.KubeletServer&#123;</span><br><span class="line">				KubeletFlags:         *kubeletFlags,</span><br><span class="line">				KubeletConfiguration: *kubeletConfig,</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// use kubeletServer to construct the default KubeletDeps</span></span><br><span class="line">			kubeletDeps, err := UnsecuredDependencies(kubeletServer, utilfeature.DefaultFeatureGate)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to construct kubelet dependencies: %w&quot;</span>, err)</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> err := checkPermissions(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				klog.ErrorS(err, <span class="string">&quot;kubelet running with insufficient permissions&quot;</span>)</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// make the kubelet&#x27;s config safe for logging</span></span><br><span class="line">			config := kubeletServer.KubeletConfiguration.DeepCopy()</span><br><span class="line">			<span class="keyword">for</span> k := <span class="keyword">range</span> config.StaticPodURLHeader &#123;</span><br><span class="line">				config.StaticPodURLHeader[k] = []<span class="type">string</span>&#123;<span class="string">&quot;&lt;masked&gt;&quot;</span>&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// log the kubelet&#x27;s config for inspection</span></span><br><span class="line">			klog.V(<span class="number">5</span>).InfoS(<span class="string">&quot;KubeletConfiguration&quot;</span>, <span class="string">&quot;configuration&quot;</span>, config)</span><br><span class="line"></span><br><span class="line">			<span class="comment">// set up signal context for kubelet shutdown</span></span><br><span class="line">			ctx := genericapiserver.SetupSignalContext()</span><br><span class="line"></span><br><span class="line">			<span class="comment">// run the kubelet</span></span><br><span class="line">			<span class="keyword">return</span> Run(ctx, kubeletServer, kubeletDeps, utilfeature.DefaultFeatureGate)</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// keep cleanFlagSet separate, so Cobra doesn&#x27;t pollute it with the global flags</span></span><br><span class="line">	kubeletFlags.AddFlags(cleanFlagSet)</span><br><span class="line">	options.AddKubeletConfigFlags(cleanFlagSet, kubeletConfig)</span><br><span class="line">	options.AddGlobalFlags(cleanFlagSet)</span><br><span class="line">	cleanFlagSet.BoolP(<span class="string">&quot;help&quot;</span>, <span class="string">&quot;h&quot;</span>, <span class="literal">false</span>, fmt.Sprintf(<span class="string">&quot;help for %s&quot;</span>, cmd.Name()))</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ugly, but necessary, because Cobra&#x27;s default UsageFunc and HelpFunc pollute the flagset with global flags</span></span><br><span class="line">	<span class="keyword">const</span> usageFmt = <span class="string">&quot;Usage:\n  %s\n\nFlags:\n%s&quot;</span></span><br><span class="line">	cmd.SetUsageFunc(<span class="function"><span class="keyword">func</span><span class="params">(cmd *cobra.Command)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">		fmt.Fprintf(cmd.OutOrStderr(), usageFmt, cmd.UseLine(), cleanFlagSet.FlagUsagesWrapped(<span class="number">2</span>))</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;)</span><br><span class="line">	cmd.SetHelpFunc(<span class="function"><span class="keyword">func</span><span class="params">(cmd *cobra.Command, args []<span class="type">string</span>)</span></span> &#123;</span><br><span class="line">		fmt.Fprintf(cmd.OutOrStdout(), <span class="string">&quot;%s\n\n&quot;</span>+usageFmt, cmd.Long, cmd.UseLine(), cleanFlagSet.FlagUsagesWrapped(<span class="number">2</span>))</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> cmd</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="运行环境检测与设置"><a href="#运行环境检测与设置" class="headerlink" title="运行环境检测与设置"></a>运行环境检测与设置</h2><ol>
<li>Run func 执行initForOS func为kubelet设置WIndowsService守护进程（仅Windows）</li>
<li>然后调用Run，执行依赖初始化环境检查和设置等工作</li>
<li>RunKubelet func启动kubelet主服务，并且启动Healthz HTTP Server</li>
</ol>
<p>主要流程如下：</p>
<ol>
<li><p>kubelet根据是否传入kubeconfig，判断运行模式</p>
<ul>
<li>首次按照启动，kubelet还没有启动，获取到集群凭证，所以进在standone模式运行下，支持启动StaticPod</li>
<li>正常运行之后，从standone切换到bootstrap模式</li>
</ul>
</li>
<li><p>依次完成Auth、cAdvisor和ContainerManaer对象的初始化，这些对象说kubelete的基础组件</p>
</li>
<li><p>通过ApplyOOOMScoreAdj跳转kubelete的OOM分数，为kubelet设置oom_socre_adj的取值。当节点内存不足的时候，操作系统会通过打分的方法选择牺牲进程，oom_socre_adj越高，越容易被杀掉，取值范围[-1000，1000]。默认地，kubelet自己的oom_score_adj&#x3D;-999,保证自己的可用</p>
<p>查看kubelete的oom_socre_adj shell</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hcss-ecs-5425 ~]# cat /proc/$(pidof kubelet)/oom_score_adj</span><br><span class="line">-999</span><br></pre></td></tr></table></figure>
</li>
<li><p>RunKubelet 正式启动kubelet服务</p>
</li>
</ol>
<ul>
<li><p>Ref:<a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/88e994f6bf8fc88114c5b733e09afea339bea66d/cmd/kubelet/app/server.go#L490">https://github.com/kubernetes/kubernetes/blob/88e994f6bf8fc88114c5b733e09afea339bea66d/cmd/kubelet/app/server.go#L490</a></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">run</span><span class="params">(ctx context.Context, s *options.KubeletServer, kubeDeps *kubelet.Dependencies, featureGate featuregate.FeatureGate)</span></span> (err <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="comment">// Set global feature gates based on the value on the initial KubeletServer</span></span><br><span class="line">	err = utilfeature.DefaultMutableFeatureGate.SetFromMap(s.KubeletConfiguration.FeatureGates)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// validate the initial KubeletServer (we set feature gates first, because this validation depends on feature gates)</span></span><br><span class="line">	<span class="keyword">if</span> err := options.ValidateKubeletServer(s); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Warn if MemoryQoS enabled with cgroups v1</span></span><br><span class="line">	<span class="keyword">if</span> utilfeature.DefaultFeatureGate.Enabled(features.MemoryQoS) &amp;&amp;</span><br><span class="line">		!isCgroup2UnifiedMode() &#123;</span><br><span class="line">		klog.InfoS(<span class="string">&quot;Warning: MemoryQoS feature only works with cgroups v2 on Linux, but enabled with cgroups v1&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Obtain Kubelet Lock File</span></span><br><span class="line">	<span class="keyword">if</span> s.ExitOnLockContention &amp;&amp; s.LockFilePath == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> errors.New(<span class="string">&quot;cannot exit on lock file contention: no lock file specified&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	done := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">	<span class="keyword">if</span> s.LockFilePath != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		klog.InfoS(<span class="string">&quot;Acquiring file lock&quot;</span>, <span class="string">&quot;path&quot;</span>, s.LockFilePath)</span><br><span class="line">		<span class="keyword">if</span> err := flock.Acquire(s.LockFilePath); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;unable to acquire file lock on %q: %w&quot;</span>, s.LockFilePath, err)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> s.ExitOnLockContention &#123;</span><br><span class="line">			klog.InfoS(<span class="string">&quot;Watching for inotify events&quot;</span>, <span class="string">&quot;path&quot;</span>, s.LockFilePath)</span><br><span class="line">			<span class="keyword">if</span> err := watchForLockfileContention(s.LockFilePath, done); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> err</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Register current configuration with /configz endpoint</span></span><br><span class="line">	err = initConfigz(&amp;s.KubeletConfiguration)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		klog.ErrorS(err, <span class="string">&quot;Failed to register kubelet configuration with configz&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(s.ShowHiddenMetricsForVersion) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		metrics.SetShowHidden()</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// About to get clients and such, detect standaloneMode</span></span><br><span class="line">	standaloneMode := <span class="literal">true</span></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(s.KubeConfig) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		standaloneMode = <span class="literal">false</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> kubeDeps == <span class="literal">nil</span> &#123;</span><br><span class="line">		kubeDeps, err = UnsecuredDependencies(s, featureGate)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> kubeDeps.Cloud == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> !cloudprovider.IsExternal(s.CloudProvider) &#123;</span><br><span class="line">			cloudprovider.DeprecationWarningForProvider(s.CloudProvider)</span><br><span class="line">			cloud, err := cloudprovider.InitCloudProvider(s.CloudProvider, s.CloudConfigFile)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> err</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> cloud != <span class="literal">nil</span> &#123;</span><br><span class="line">				klog.V(<span class="number">2</span>).InfoS(<span class="string">&quot;Successfully initialized cloud provider&quot;</span>, <span class="string">&quot;cloudProvider&quot;</span>, s.CloudProvider, <span class="string">&quot;cloudConfigFile&quot;</span>, s.CloudConfigFile)</span><br><span class="line">			&#125;</span><br><span class="line">			kubeDeps.Cloud = cloud</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	hostName, err := nodeutil.GetHostname(s.HostnameOverride)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	nodeName, err := getNodeName(kubeDeps.Cloud, hostName)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// if in standalone mode, indicate as much by setting all clients to nil</span></span><br><span class="line">	<span class="keyword">switch</span> &#123;</span><br><span class="line">	<span class="keyword">case</span> standaloneMode:</span><br><span class="line">		kubeDeps.KubeClient = <span class="literal">nil</span></span><br><span class="line">		kubeDeps.EventClient = <span class="literal">nil</span></span><br><span class="line">		kubeDeps.HeartbeatClient = <span class="literal">nil</span></span><br><span class="line">		klog.InfoS(<span class="string">&quot;Standalone mode, no API client&quot;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">case</span> kubeDeps.KubeClient == <span class="literal">nil</span>, kubeDeps.EventClient == <span class="literal">nil</span>, kubeDeps.HeartbeatClient == <span class="literal">nil</span>:</span><br><span class="line">		clientConfig, onHeartbeatFailure, err := buildKubeletClientConfig(ctx, s, kubeDeps.TracerProvider, nodeName)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> onHeartbeatFailure == <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> errors.New(<span class="string">&quot;onHeartbeatFailure must be a valid function other than nil&quot;</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		kubeDeps.OnHeartbeatFailure = onHeartbeatFailure</span><br><span class="line"></span><br><span class="line">		kubeDeps.KubeClient, err = clientset.NewForConfig(clientConfig)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to initialize kubelet client: %w&quot;</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// make a separate client for events</span></span><br><span class="line">		eventClientConfig := *clientConfig</span><br><span class="line">		eventClientConfig.QPS = <span class="type">float32</span>(s.EventRecordQPS)</span><br><span class="line">		eventClientConfig.Burst = <span class="type">int</span>(s.EventBurst)</span><br><span class="line">		kubeDeps.EventClient, err = v1core.NewForConfig(&amp;eventClientConfig)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to initialize kubelet event client: %w&quot;</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// make a separate client for heartbeat with throttling disabled and a timeout attached</span></span><br><span class="line">		heartbeatClientConfig := *clientConfig</span><br><span class="line">		heartbeatClientConfig.Timeout = s.KubeletConfiguration.NodeStatusUpdateFrequency.Duration</span><br><span class="line">		<span class="comment">// The timeout is the minimum of the lease duration and status update frequency</span></span><br><span class="line">		leaseTimeout := time.Duration(s.KubeletConfiguration.NodeLeaseDurationSeconds) * time.Second</span><br><span class="line">		<span class="keyword">if</span> heartbeatClientConfig.Timeout &gt; leaseTimeout &#123;</span><br><span class="line">			heartbeatClientConfig.Timeout = leaseTimeout</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		heartbeatClientConfig.QPS = <span class="type">float32</span>(<span class="number">-1</span>)</span><br><span class="line">		kubeDeps.HeartbeatClient, err = clientset.NewForConfig(&amp;heartbeatClientConfig)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to initialize kubelet heartbeat client: %w&quot;</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> kubeDeps.Auth == <span class="literal">nil</span> &#123;</span><br><span class="line">		auth, runAuthenticatorCAReload, err := BuildAuth(nodeName, kubeDeps.KubeClient, s.KubeletConfiguration)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">		kubeDeps.Auth = auth</span><br><span class="line">		runAuthenticatorCAReload(ctx.Done())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> cgroupRoots []<span class="type">string</span></span><br><span class="line">	nodeAllocatableRoot := cm.NodeAllocatableRoot(s.CgroupRoot, s.CgroupsPerQOS, s.CgroupDriver)</span><br><span class="line">	cgroupRoots = <span class="built_in">append</span>(cgroupRoots, nodeAllocatableRoot)</span><br><span class="line">	kubeletCgroup, err := cm.GetKubeletContainer(s.KubeletCgroups)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		klog.InfoS(<span class="string">&quot;Failed to get the kubelet&#x27;s cgroup. Kubelet system container metrics may be missing.&quot;</span>, <span class="string">&quot;err&quot;</span>, err)</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> kubeletCgroup != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		cgroupRoots = <span class="built_in">append</span>(cgroupRoots, kubeletCgroup)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> s.RuntimeCgroups != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		<span class="comment">// RuntimeCgroups is optional, so ignore if it isn&#x27;t specified</span></span><br><span class="line">		cgroupRoots = <span class="built_in">append</span>(cgroupRoots, s.RuntimeCgroups)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> s.SystemCgroups != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		<span class="comment">// SystemCgroups is optional, so ignore if it isn&#x27;t specified</span></span><br><span class="line">		cgroupRoots = <span class="built_in">append</span>(cgroupRoots, s.SystemCgroups)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> kubeDeps.CAdvisorInterface == <span class="literal">nil</span> &#123;</span><br><span class="line">		imageFsInfoProvider := cadvisor.NewImageFsInfoProvider(s.RemoteRuntimeEndpoint)</span><br><span class="line">		kubeDeps.CAdvisorInterface, err = cadvisor.New(imageFsInfoProvider, s.RootDirectory, cgroupRoots, cadvisor.UsingLegacyCadvisorStats(s.RemoteRuntimeEndpoint), s.LocalStorageCapacityIsolation)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Setup event recorder if required.</span></span><br><span class="line">	makeEventRecorder(kubeDeps, nodeName)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> kubeDeps.ContainerManager == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> s.CgroupsPerQOS &amp;&amp; s.CgroupRoot == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">			klog.InfoS(<span class="string">&quot;--cgroups-per-qos enabled, but --cgroup-root was not specified.  defaulting to /&quot;</span>)</span><br><span class="line">			s.CgroupRoot = <span class="string">&quot;/&quot;</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		machineInfo, err := kubeDeps.CAdvisorInterface.MachineInfo()</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">		reservedSystemCPUs, err := getReservedCPUs(machineInfo, s.ReservedSystemCPUs)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> reservedSystemCPUs.Size() &gt; <span class="number">0</span> &#123;</span><br><span class="line">			<span class="comment">// at cmd option validation phase it is tested either --system-reserved-cgroup or --kube-reserved-cgroup is specified, so overwrite should be ok</span></span><br><span class="line">			klog.InfoS(<span class="string">&quot;Option --reserved-cpus is specified, it will overwrite the cpu setting in KubeReserved and SystemReserved&quot;</span>, <span class="string">&quot;kubeReservedCPUs&quot;</span>, s.KubeReserved, <span class="string">&quot;systemReservedCPUs&quot;</span>, s.SystemReserved)</span><br><span class="line">			<span class="keyword">if</span> s.KubeReserved != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="built_in">delete</span>(s.KubeReserved, <span class="string">&quot;cpu&quot;</span>)</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> s.SystemReserved == <span class="literal">nil</span> &#123;</span><br><span class="line">				s.SystemReserved = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>)</span><br><span class="line">			&#125;</span><br><span class="line">			s.SystemReserved[<span class="string">&quot;cpu&quot;</span>] = strconv.Itoa(reservedSystemCPUs.Size())</span><br><span class="line">			klog.InfoS(<span class="string">&quot;After cpu setting is overwritten&quot;</span>, <span class="string">&quot;kubeReservedCPUs&quot;</span>, s.KubeReserved, <span class="string">&quot;systemReservedCPUs&quot;</span>, s.SystemReserved)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		kubeReserved, err := parseResourceList(s.KubeReserved)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">		systemReserved, err := parseResourceList(s.SystemReserved)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">var</span> hardEvictionThresholds []evictionapi.Threshold</span><br><span class="line">		<span class="comment">// If the user requested to ignore eviction thresholds, then do not set valid values for hardEvictionThresholds here.</span></span><br><span class="line">		<span class="keyword">if</span> !s.ExperimentalNodeAllocatableIgnoreEvictionThreshold &#123;</span><br><span class="line">			hardEvictionThresholds, err = eviction.ParseThresholdConfig([]<span class="type">string</span>&#123;&#125;, s.EvictionHard, <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">nil</span>)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> err</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		experimentalQOSReserved, err := cm.ParseQOSReserved(s.QOSReserved)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		devicePluginEnabled := utilfeature.DefaultFeatureGate.Enabled(features.DevicePlugins)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">var</span> cpuManagerPolicyOptions <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span></span><br><span class="line">		<span class="keyword">if</span> utilfeature.DefaultFeatureGate.Enabled(features.CPUManager) &#123;</span><br><span class="line">			<span class="keyword">if</span> utilfeature.DefaultFeatureGate.Enabled(features.CPUManagerPolicyOptions) &#123;</span><br><span class="line">				cpuManagerPolicyOptions = s.CPUManagerPolicyOptions</span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> s.CPUManagerPolicyOptions != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;CPU Manager policy options %v require feature gates %q, %q enabled&quot;</span>,</span><br><span class="line">					s.CPUManagerPolicyOptions, features.CPUManager, features.CPUManagerPolicyOptions)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		kubeDeps.ContainerManager, err = cm.NewContainerManager(</span><br><span class="line">			kubeDeps.Mounter,</span><br><span class="line">			kubeDeps.CAdvisorInterface,</span><br><span class="line">			cm.NodeConfig&#123;</span><br><span class="line">				RuntimeCgroupsName:    s.RuntimeCgroups,</span><br><span class="line">				SystemCgroupsName:     s.SystemCgroups,</span><br><span class="line">				KubeletCgroupsName:    s.KubeletCgroups,</span><br><span class="line">				KubeletOOMScoreAdj:    s.OOMScoreAdj,</span><br><span class="line">				CgroupsPerQOS:         s.CgroupsPerQOS,</span><br><span class="line">				CgroupRoot:            s.CgroupRoot,</span><br><span class="line">				CgroupDriver:          s.CgroupDriver,</span><br><span class="line">				KubeletRootDir:        s.RootDirectory,</span><br><span class="line">				ProtectKernelDefaults: s.ProtectKernelDefaults,</span><br><span class="line">				NodeAllocatableConfig: cm.NodeAllocatableConfig&#123;</span><br><span class="line">					KubeReservedCgroupName:   s.KubeReservedCgroup,</span><br><span class="line">					SystemReservedCgroupName: s.SystemReservedCgroup,</span><br><span class="line">					EnforceNodeAllocatable:   sets.NewString(s.EnforceNodeAllocatable...),</span><br><span class="line">					KubeReserved:             kubeReserved,</span><br><span class="line">					SystemReserved:           systemReserved,</span><br><span class="line">					ReservedSystemCPUs:       reservedSystemCPUs,</span><br><span class="line">					HardEvictionThresholds:   hardEvictionThresholds,</span><br><span class="line">				&#125;,</span><br><span class="line">				QOSReserved:                             *experimentalQOSReserved,</span><br><span class="line">				ExperimentalCPUManagerPolicy:            s.CPUManagerPolicy,</span><br><span class="line">				ExperimentalCPUManagerPolicyOptions:     cpuManagerPolicyOptions,</span><br><span class="line">				ExperimentalCPUManagerReconcilePeriod:   s.CPUManagerReconcilePeriod.Duration,</span><br><span class="line">				ExperimentalMemoryManagerPolicy:         s.MemoryManagerPolicy,</span><br><span class="line">				ExperimentalMemoryManagerReservedMemory: s.ReservedMemory,</span><br><span class="line">				ExperimentalPodPidsLimit:                s.PodPidsLimit,</span><br><span class="line">				EnforceCPULimits:                        s.CPUCFSQuota,</span><br><span class="line">				CPUCFSQuotaPeriod:                       s.CPUCFSQuotaPeriod.Duration,</span><br><span class="line">				ExperimentalTopologyManagerPolicy:       s.TopologyManagerPolicy,</span><br><span class="line">				ExperimentalTopologyManagerScope:        s.TopologyManagerScope,</span><br><span class="line">			&#125;,</span><br><span class="line">			s.FailSwapOn,</span><br><span class="line">			devicePluginEnabled,</span><br><span class="line">			kubeDeps.Recorder)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// TODO(vmarmol): Do this through container config.</span></span><br><span class="line">	oomAdjuster := kubeDeps.OOMAdjuster</span><br><span class="line">	<span class="keyword">if</span> err := oomAdjuster.ApplyOOMScoreAdj(<span class="number">0</span>, <span class="type">int</span>(s.OOMScoreAdj)); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		klog.InfoS(<span class="string">&quot;Failed to ApplyOOMScoreAdj&quot;</span>, <span class="string">&quot;err&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = kubelet.PreInitRuntimeService(&amp;s.KubeletConfiguration, kubeDeps, s.RemoteRuntimeEndpoint, s.RemoteImageEndpoint)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err := RunKubelet(s, kubeDeps, s.RunOnce); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> s.HealthzPort &gt; <span class="number">0</span> &#123;</span><br><span class="line">		mux := http.NewServeMux()</span><br><span class="line">		healthz.InstallHandler(mux)</span><br><span class="line">		<span class="keyword">go</span> wait.Until(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">			err := http.ListenAndServe(net.JoinHostPort(s.HealthzBindAddress, strconv.Itoa(<span class="type">int</span>(s.HealthzPort))), mux)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				klog.ErrorS(err, <span class="string">&quot;Failed to start healthz server&quot;</span>)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;, <span class="number">5</span>*time.Second, wait.NeverStop)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> s.RunOnce &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// If systemd is used, notify it that we have started</span></span><br><span class="line">	<span class="keyword">go</span> daemon.SdNotify(<span class="literal">false</span>, <span class="string">&quot;READY=1&quot;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">select</span> &#123;</span><br><span class="line">	<span class="keyword">case</span> &lt;-done:</span><br><span class="line">		<span class="keyword">break</span></span><br><span class="line">	<span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">		<span class="keyword">break</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="对象实例化"><a href="#对象实例化" class="headerlink" title="对象实例化"></a>对象实例化</h2><p>RunKubelet 主要完成：createAndInitKubelet func 创建和初始化Kubelet对象，以及使用startKubelete func启动kubelet 主函数</p>
<ul>
<li><p>Ref:<a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/88e994f6bf8fc88114c5b733e09afea339bea66d/cmd/kubelet/app/server.go#L1097">https://github.com/kubernetes/kubernetes/blob/88e994f6bf8fc88114c5b733e09afea339bea66d/cmd/kubelet/app/server.go#L1097</a></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RunKubelet</span><span class="params">(kubeServer *options.KubeletServer, kubeDeps *kubelet.Dependencies, runOnce <span class="type">bool</span>)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">	hostname, err := nodeutil.GetHostname(kubeServer.HostnameOverride)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Query the cloud provider for our node name, default to hostname if kubeDeps.Cloud == nil</span></span><br><span class="line">	nodeName, err := getNodeName(kubeDeps.Cloud, hostname)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	hostnameOverridden := <span class="built_in">len</span>(kubeServer.HostnameOverride) &gt; <span class="number">0</span></span><br><span class="line">	<span class="comment">// Setup event recorder if required.</span></span><br><span class="line">	makeEventRecorder(kubeDeps, nodeName)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> nodeIPs []net.IP</span><br><span class="line">	<span class="keyword">if</span> kubeServer.NodeIP != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		<span class="keyword">for</span> _, ip := <span class="keyword">range</span> strings.Split(kubeServer.NodeIP, <span class="string">&quot;,&quot;</span>) &#123;</span><br><span class="line">			parsedNodeIP := netutils.ParseIPSloppy(strings.TrimSpace(ip))</span><br><span class="line">			<span class="keyword">if</span> parsedNodeIP == <span class="literal">nil</span> &#123;</span><br><span class="line">				klog.InfoS(<span class="string">&quot;Could not parse --node-ip ignoring&quot;</span>, <span class="string">&quot;IP&quot;</span>, ip)</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				nodeIPs = <span class="built_in">append</span>(nodeIPs, parsedNodeIP)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(nodeIPs) &gt; <span class="number">2</span> || (<span class="built_in">len</span>(nodeIPs) == <span class="number">2</span> &amp;&amp; netutils.IsIPv6(nodeIPs[<span class="number">0</span>]) == netutils.IsIPv6(nodeIPs[<span class="number">1</span>])) &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;bad --node-ip %q; must contain either a single IP or a dual-stack pair of IPs&quot;</span>, kubeServer.NodeIP)</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="built_in">len</span>(nodeIPs) == <span class="number">2</span> &amp;&amp; kubeServer.CloudProvider != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;dual-stack --node-ip %q not supported when using a cloud provider&quot;</span>, kubeServer.NodeIP)</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="built_in">len</span>(nodeIPs) == <span class="number">2</span> &amp;&amp; (nodeIPs[<span class="number">0</span>].IsUnspecified() || nodeIPs[<span class="number">1</span>].IsUnspecified()) &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;dual-stack --node-ip %q cannot include &#x27;0.0.0.0&#x27; or &#x27;::&#x27;&quot;</span>, kubeServer.NodeIP)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	capabilities.Initialize(capabilities.Capabilities&#123;</span><br><span class="line">		AllowPrivileged: <span class="literal">true</span>,</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	credentialprovider.SetPreferredDockercfgPath(kubeServer.RootDirectory)</span><br><span class="line">	klog.V(<span class="number">2</span>).InfoS(<span class="string">&quot;Using root directory&quot;</span>, <span class="string">&quot;path&quot;</span>, kubeServer.RootDirectory)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> kubeDeps.OSInterface == <span class="literal">nil</span> &#123;</span><br><span class="line">		kubeDeps.OSInterface = kubecontainer.RealOS&#123;&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> kubeServer.KubeletConfiguration.SeccompDefault &amp;&amp; !utilfeature.DefaultFeatureGate.Enabled(features.SeccompDefault) &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;the SeccompDefault feature gate must be enabled in order to use the SeccompDefault configuration&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	k, err := createAndInitKubelet(kubeServer,</span><br><span class="line">		kubeDeps,</span><br><span class="line">		hostname,</span><br><span class="line">		hostnameOverridden,</span><br><span class="line">		nodeName,</span><br><span class="line">		nodeIPs)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to create kubelet: %w&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// NewMainKubelet should have set up a pod source config if one didn&#x27;t exist</span></span><br><span class="line">	<span class="comment">// when the builder was run. This is just a precaution.</span></span><br><span class="line">	<span class="keyword">if</span> kubeDeps.PodConfig == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to create kubelet, pod source config was nil&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	podCfg := kubeDeps.PodConfig</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err := rlimit.SetNumFiles(<span class="type">uint64</span>(kubeServer.MaxOpenFiles)); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		klog.ErrorS(err, <span class="string">&quot;Failed to set rlimit on max file handles&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// process pods and exit.</span></span><br><span class="line">	<span class="keyword">if</span> runOnce &#123;</span><br><span class="line">		<span class="keyword">if</span> _, err := k.RunOnce(podCfg.Updates()); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;runonce failed: %w&quot;</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">		klog.InfoS(<span class="string">&quot;Started kubelet as runonce&quot;</span>)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		startKubelet(k, podCfg, &amp;kubeServer.KubeletConfiguration, kubeDeps, kubeServer.EnableServer)</span><br><span class="line">		klog.InfoS(<span class="string">&quot;Started kubelet&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>通过NewMainKubelet创建Kubelet对象，同时包含对内部模式的实例化，如对Informer、各类内部的Manager</p>
<ul>
<li><p>Ref:<a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/88e994f6bf8fc88114c5b733e09afea339bea66d/pkg/kubelet/kubelet.go#L312">https://github.com/kubernetes/kubernetes/blob/88e994f6bf8fc88114c5b733e09afea339bea66d/pkg/kubelet/kubelet.go#L312</a></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NewMainKubelet instantiates a new Kubelet object along with all the required internal modules.</span></span><br><span class="line"><span class="comment">// No initialization of Kubelet and its modules should happen here.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewMainKubelet</span><span class="params">(kubeCfg *kubeletconfiginternal.KubeletConfiguration,</span></span></span><br><span class="line"><span class="params"><span class="function">	kubeDeps *Dependencies,</span></span></span><br><span class="line"><span class="params"><span class="function">	crOptions *config.ContainerRuntimeOptions,</span></span></span><br><span class="line"><span class="params"><span class="function">	hostname <span class="type">string</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">	hostnameOverridden <span class="type">bool</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">	nodeName types.NodeName,</span></span></span><br><span class="line"><span class="params"><span class="function">	nodeIPs []net.IP,</span></span></span><br><span class="line"><span class="params"><span class="function">	providerID <span class="type">string</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">	cloudProvider <span class="type">string</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">	certDirectory <span class="type">string</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">	rootDirectory <span class="type">string</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">	imageCredentialProviderConfigFile <span class="type">string</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">	imageCredentialProviderBinDir <span class="type">string</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">	registerNode <span class="type">bool</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">	registerWithTaints []v1.Taint,</span></span></span><br><span class="line"><span class="params"><span class="function">	allowedUnsafeSysctls []<span class="type">string</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">	experimentalMounterPath <span class="type">string</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">	kernelMemcgNotification <span class="type">bool</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">	experimentalNodeAllocatableIgnoreEvictionThreshold <span class="type">bool</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">	minimumGCAge metav1.Duration,</span></span></span><br><span class="line"><span class="params"><span class="function">	maxPerPodContainerCount <span class="type">int32</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">	maxContainerCount <span class="type">int32</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">	masterServiceNamespace <span class="type">string</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">	registerSchedulable <span class="type">bool</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">	keepTerminatedPodVolumes <span class="type">bool</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">	nodeLabels <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">	nodeStatusMaxImages <span class="type">int32</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">	seccompDefault <span class="type">bool</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span> (*Kubelet, <span class="type">error</span>) &#123;</span><br><span class="line">	logger := klog.TODO()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> rootDirectory == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;invalid root directory %q&quot;</span>, rootDirectory)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> kubeCfg.SyncFrequency.Duration &lt;= <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;invalid sync frequency %d&quot;</span>, kubeCfg.SyncFrequency.Duration)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> kubeCfg.MakeIPTablesUtilChains &#123;</span><br><span class="line">		<span class="keyword">if</span> kubeCfg.IPTablesMasqueradeBit &gt; <span class="number">31</span> || kubeCfg.IPTablesMasqueradeBit &lt; <span class="number">0</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;iptables-masquerade-bit is not valid. Must be within [0, 31]&quot;</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> kubeCfg.IPTablesDropBit &gt; <span class="number">31</span> || kubeCfg.IPTablesDropBit &lt; <span class="number">0</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;iptables-drop-bit is not valid. Must be within [0, 31]&quot;</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> kubeCfg.IPTablesDropBit == kubeCfg.IPTablesMasqueradeBit &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;iptables-masquerade-bit and iptables-drop-bit must be different&quot;</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> utilfeature.DefaultFeatureGate.Enabled(features.DisableCloudProviders) &amp;&amp; cloudprovider.IsDeprecatedInternal(cloudProvider) &#123;</span><br><span class="line">		cloudprovider.DisableWarningForProvider(cloudProvider)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;cloud provider %q was specified, but built-in cloud providers are disabled. Please set --cloud-provider=external and migrate to an external cloud provider&quot;</span>, cloudProvider)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> nodeHasSynced cache.InformerSynced</span><br><span class="line">	<span class="keyword">var</span> nodeLister corelisters.NodeLister</span><br><span class="line"></span><br><span class="line">	<span class="comment">// If kubeClient == nil, we are running in standalone mode (i.e. no API servers)</span></span><br><span class="line">	<span class="comment">// If not nil, we are running as part of a cluster and should sync w/API</span></span><br><span class="line">	<span class="keyword">if</span> kubeDeps.KubeClient != <span class="literal">nil</span> &#123;</span><br><span class="line">		kubeInformers := informers.NewSharedInformerFactoryWithOptions(kubeDeps.KubeClient, <span class="number">0</span>, informers.WithTweakListOptions(<span class="function"><span class="keyword">func</span><span class="params">(options *metav1.ListOptions)</span></span> &#123;</span><br><span class="line">			options.FieldSelector = fields.Set&#123;metav1.ObjectNameField: <span class="type">string</span>(nodeName)&#125;.String()</span><br><span class="line">		&#125;))</span><br><span class="line">		nodeLister = kubeInformers.Core().V1().Nodes().Lister()</span><br><span class="line">		nodeHasSynced = <span class="function"><span class="keyword">func</span><span class="params">()</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> kubeInformers.Core().V1().Nodes().Informer().HasSynced()</span><br><span class="line">		&#125;</span><br><span class="line">		kubeInformers.Start(wait.NeverStop)</span><br><span class="line">		klog.InfoS(<span class="string">&quot;Attempting to sync node with API server&quot;</span>)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// we don&#x27;t have a client to sync!</span></span><br><span class="line">		nodeIndexer := cache.NewIndexer(cache.MetaNamespaceKeyFunc, cache.Indexers&#123;&#125;)</span><br><span class="line">		nodeLister = corelisters.NewNodeLister(nodeIndexer)</span><br><span class="line">		nodeHasSynced = <span class="function"><span class="keyword">func</span><span class="params">()</span></span> <span class="type">bool</span> &#123; <span class="keyword">return</span> <span class="literal">true</span> &#125;</span><br><span class="line">		klog.InfoS(<span class="string">&quot;Kubelet is running in standalone mode, will skip API server sync&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> kubeDeps.PodConfig == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">var</span> err <span class="type">error</span></span><br><span class="line">		kubeDeps.PodConfig, err = makePodSourceConfig(kubeCfg, kubeDeps, nodeName, nodeHasSynced)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	containerGCPolicy := kubecontainer.GCPolicy&#123;</span><br><span class="line">		MinAge:             minimumGCAge.Duration,</span><br><span class="line">		MaxPerPodContainer: <span class="type">int</span>(maxPerPodContainerCount),</span><br><span class="line">		MaxContainers:      <span class="type">int</span>(maxContainerCount),</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	daemonEndpoints := &amp;v1.NodeDaemonEndpoints&#123;</span><br><span class="line">		KubeletEndpoint: v1.DaemonEndpoint&#123;Port: kubeCfg.Port&#125;,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	imageGCPolicy := images.ImageGCPolicy&#123;</span><br><span class="line">		MinAge:               kubeCfg.ImageMinimumGCAge.Duration,</span><br><span class="line">		HighThresholdPercent: <span class="type">int</span>(kubeCfg.ImageGCHighThresholdPercent),</span><br><span class="line">		LowThresholdPercent:  <span class="type">int</span>(kubeCfg.ImageGCLowThresholdPercent),</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	enforceNodeAllocatable := kubeCfg.EnforceNodeAllocatable</span><br><span class="line">	<span class="keyword">if</span> experimentalNodeAllocatableIgnoreEvictionThreshold &#123;</span><br><span class="line">		<span class="comment">// Do not provide kubeCfg.EnforceNodeAllocatable to eviction threshold parsing if we are not enforcing Evictions</span></span><br><span class="line">		enforceNodeAllocatable = []<span class="type">string</span>&#123;&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	thresholds, err := eviction.ParseThresholdConfig(enforceNodeAllocatable, kubeCfg.EvictionHard, kubeCfg.EvictionSoft, kubeCfg.EvictionSoftGracePeriod, kubeCfg.EvictionMinimumReclaim)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	evictionConfig := eviction.Config&#123;</span><br><span class="line">		PressureTransitionPeriod: kubeCfg.EvictionPressureTransitionPeriod.Duration,</span><br><span class="line">		MaxPodGracePeriodSeconds: <span class="type">int64</span>(kubeCfg.EvictionMaxPodGracePeriod),</span><br><span class="line">		Thresholds:               thresholds,</span><br><span class="line">		KernelMemcgNotification:  kernelMemcgNotification,</span><br><span class="line">		PodCgroupRoot:            kubeDeps.ContainerManager.GetPodCgroupRoot(),</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> serviceLister corelisters.ServiceLister</span><br><span class="line">	<span class="keyword">var</span> serviceHasSynced cache.InformerSynced</span><br><span class="line">	<span class="keyword">if</span> kubeDeps.KubeClient != <span class="literal">nil</span> &#123;</span><br><span class="line">		kubeInformers := informers.NewSharedInformerFactory(kubeDeps.KubeClient, <span class="number">0</span>)</span><br><span class="line">		serviceLister = kubeInformers.Core().V1().Services().Lister()</span><br><span class="line">		serviceHasSynced = kubeInformers.Core().V1().Services().Informer().HasSynced</span><br><span class="line">		kubeInformers.Start(wait.NeverStop)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		serviceIndexer := cache.NewIndexer(cache.MetaNamespaceKeyFunc, cache.Indexers&#123;cache.NamespaceIndex: cache.MetaNamespaceIndexFunc&#125;)</span><br><span class="line">		serviceLister = corelisters.NewServiceLister(serviceIndexer)</span><br><span class="line">		serviceHasSynced = <span class="function"><span class="keyword">func</span><span class="params">()</span></span> <span class="type">bool</span> &#123; <span class="keyword">return</span> <span class="literal">true</span> &#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// construct a node reference used for events</span></span><br><span class="line">	nodeRef := &amp;v1.ObjectReference&#123;</span><br><span class="line">		Kind:      <span class="string">&quot;Node&quot;</span>,</span><br><span class="line">		Name:      <span class="type">string</span>(nodeName),</span><br><span class="line">		UID:       types.UID(nodeName),</span><br><span class="line">		Namespace: <span class="string">&quot;&quot;</span>,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	oomWatcher, err := oomwatcher.NewWatcher(kubeDeps.Recorder)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> libcontaineruserns.RunningInUserNS() &#123;</span><br><span class="line">			<span class="keyword">if</span> utilfeature.DefaultFeatureGate.Enabled(features.KubeletInUserNamespace) &#123;</span><br><span class="line">				<span class="comment">// oomwatcher.NewWatcher returns &quot;open /dev/kmsg: operation not permitted&quot; error,</span></span><br><span class="line">				<span class="comment">// when running in a user namespace with sysctl value `kernel.dmesg_restrict=1`.</span></span><br><span class="line">				klog.V(<span class="number">2</span>).InfoS(<span class="string">&quot;Failed to create an oomWatcher (running in UserNS, ignoring)&quot;</span>, <span class="string">&quot;err&quot;</span>, err)</span><br><span class="line">				oomWatcher = <span class="literal">nil</span></span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				klog.ErrorS(err, <span class="string">&quot;Failed to create an oomWatcher (running in UserNS, Hint: enable KubeletInUserNamespace feature flag to ignore the error)&quot;</span>)</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	clusterDNS := <span class="built_in">make</span>([]net.IP, <span class="number">0</span>, <span class="built_in">len</span>(kubeCfg.ClusterDNS))</span><br><span class="line">	<span class="keyword">for</span> _, ipEntry := <span class="keyword">range</span> kubeCfg.ClusterDNS &#123;</span><br><span class="line">		ip := netutils.ParseIPSloppy(ipEntry)</span><br><span class="line">		<span class="keyword">if</span> ip == <span class="literal">nil</span> &#123;</span><br><span class="line">			klog.InfoS(<span class="string">&quot;Invalid clusterDNS IP&quot;</span>, <span class="string">&quot;IP&quot;</span>, ipEntry)</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			clusterDNS = <span class="built_in">append</span>(clusterDNS, ip)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	httpClient := &amp;http.Client&#123;&#125;</span><br><span class="line"></span><br><span class="line">	klet := &amp;Kubelet&#123;</span><br><span class="line">		hostname:                                hostname,</span><br><span class="line">		hostnameOverridden:                      hostnameOverridden,</span><br><span class="line">		nodeName:                                nodeName,</span><br><span class="line">		kubeClient:                              kubeDeps.KubeClient,</span><br><span class="line">		heartbeatClient:                         kubeDeps.HeartbeatClient,</span><br><span class="line">		onRepeatedHeartbeatFailure:              kubeDeps.OnHeartbeatFailure,</span><br><span class="line">		rootDirectory:                           rootDirectory,</span><br><span class="line">		resyncInterval:                          kubeCfg.SyncFrequency.Duration,</span><br><span class="line">		sourcesReady:                            config.NewSourcesReady(kubeDeps.PodConfig.SeenAllSources),</span><br><span class="line">		registerNode:                            registerNode,</span><br><span class="line">		registerWithTaints:                      registerWithTaints,</span><br><span class="line">		registerSchedulable:                     registerSchedulable,</span><br><span class="line">		dnsConfigurer:                           dns.NewConfigurer(kubeDeps.Recorder, nodeRef, nodeIPs, clusterDNS, kubeCfg.ClusterDomain, kubeCfg.ResolverConfig),</span><br><span class="line">		serviceLister:                           serviceLister,</span><br><span class="line">		serviceHasSynced:                        serviceHasSynced,</span><br><span class="line">		nodeLister:                              nodeLister,</span><br><span class="line">		nodeHasSynced:                           nodeHasSynced,</span><br><span class="line">		masterServiceNamespace:                  masterServiceNamespace,</span><br><span class="line">		streamingConnectionIdleTimeout:          kubeCfg.StreamingConnectionIdleTimeout.Duration,</span><br><span class="line">		recorder:                                kubeDeps.Recorder,</span><br><span class="line">		cadvisor:                                kubeDeps.CAdvisorInterface,</span><br><span class="line">		cloud:                                   kubeDeps.Cloud,</span><br><span class="line">		externalCloudProvider:                   cloudprovider.IsExternal(cloudProvider),</span><br><span class="line">		providerID:                              providerID,</span><br><span class="line">		nodeRef:                                 nodeRef,</span><br><span class="line">		nodeLabels:                              nodeLabels,</span><br><span class="line">		nodeStatusUpdateFrequency:               kubeCfg.NodeStatusUpdateFrequency.Duration,</span><br><span class="line">		nodeStatusReportFrequency:               kubeCfg.NodeStatusReportFrequency.Duration,</span><br><span class="line">		os:                                      kubeDeps.OSInterface,</span><br><span class="line">		oomWatcher:                              oomWatcher,</span><br><span class="line">		cgroupsPerQOS:                           kubeCfg.CgroupsPerQOS,</span><br><span class="line">		cgroupRoot:                              kubeCfg.CgroupRoot,</span><br><span class="line">		mounter:                                 kubeDeps.Mounter,</span><br><span class="line">		hostutil:                                kubeDeps.HostUtil,</span><br><span class="line">		subpather:                               kubeDeps.Subpather,</span><br><span class="line">		maxPods:                                 <span class="type">int</span>(kubeCfg.MaxPods),</span><br><span class="line">		podsPerCore:                             <span class="type">int</span>(kubeCfg.PodsPerCore),</span><br><span class="line">		syncLoopMonitor:                         atomic.Value&#123;&#125;,</span><br><span class="line">		daemonEndpoints:                         daemonEndpoints,</span><br><span class="line">		containerManager:                        kubeDeps.ContainerManager,</span><br><span class="line">		nodeIPs:                                 nodeIPs,</span><br><span class="line">		nodeIPValidator:                         validateNodeIP,</span><br><span class="line">		clock:                                   clock.RealClock&#123;&#125;,</span><br><span class="line">		enableControllerAttachDetach:            kubeCfg.EnableControllerAttachDetach,</span><br><span class="line">		makeIPTablesUtilChains:                  kubeCfg.MakeIPTablesUtilChains,</span><br><span class="line">		iptablesMasqueradeBit:                   <span class="type">int</span>(kubeCfg.IPTablesMasqueradeBit),</span><br><span class="line">		iptablesDropBit:                         <span class="type">int</span>(kubeCfg.IPTablesDropBit),</span><br><span class="line">		experimentalHostUserNamespaceDefaulting: utilfeature.DefaultFeatureGate.Enabled(features.ExperimentalHostUserNamespaceDefaultingGate),</span><br><span class="line">		keepTerminatedPodVolumes:                keepTerminatedPodVolumes,</span><br><span class="line">		nodeStatusMaxImages:                     nodeStatusMaxImages,</span><br><span class="line">		lastContainerStartedTime:                newTimeCache(),</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> klet.cloud != <span class="literal">nil</span> &#123;</span><br><span class="line">		klet.cloudResourceSyncManager = cloudresource.NewSyncManager(klet.cloud, nodeName, klet.nodeStatusUpdateFrequency)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> secretManager secret.Manager</span><br><span class="line">	<span class="keyword">var</span> configMapManager configmap.Manager</span><br><span class="line">	<span class="keyword">switch</span> kubeCfg.ConfigMapAndSecretChangeDetectionStrategy &#123;</span><br><span class="line">	<span class="keyword">case</span> kubeletconfiginternal.WatchChangeDetectionStrategy:</span><br><span class="line">		secretManager = secret.NewWatchingSecretManager(kubeDeps.KubeClient, klet.resyncInterval)</span><br><span class="line">		configMapManager = configmap.NewWatchingConfigMapManager(kubeDeps.KubeClient, klet.resyncInterval)</span><br><span class="line">	<span class="keyword">case</span> kubeletconfiginternal.TTLCacheChangeDetectionStrategy:</span><br><span class="line">		secretManager = secret.NewCachingSecretManager(</span><br><span class="line">			kubeDeps.KubeClient, manager.GetObjectTTLFromNodeFunc(klet.GetNode))</span><br><span class="line">		configMapManager = configmap.NewCachingConfigMapManager(</span><br><span class="line">			kubeDeps.KubeClient, manager.GetObjectTTLFromNodeFunc(klet.GetNode))</span><br><span class="line">	<span class="keyword">case</span> kubeletconfiginternal.GetChangeDetectionStrategy:</span><br><span class="line">		secretManager = secret.NewSimpleSecretManager(kubeDeps.KubeClient)</span><br><span class="line">		configMapManager = configmap.NewSimpleConfigMapManager(kubeDeps.KubeClient)</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;unknown configmap and secret manager mode: %v&quot;</span>, kubeCfg.ConfigMapAndSecretChangeDetectionStrategy)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	klet.secretManager = secretManager</span><br><span class="line">	klet.configMapManager = configMapManager</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> klet.experimentalHostUserNamespaceDefaulting &#123;</span><br><span class="line">		klog.InfoS(<span class="string">&quot;Experimental host user namespace defaulting is enabled&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	machineInfo, err := klet.cadvisor.MachineInfo()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Avoid collector collects it as a timestamped metric</span></span><br><span class="line">	<span class="comment">// See PR #95210 and #97006 for more details.</span></span><br><span class="line">	machineInfo.Timestamp = time.Time&#123;&#125;</span><br><span class="line">	klet.setCachedMachineInfo(machineInfo)</span><br><span class="line"></span><br><span class="line">	imageBackOff := flowcontrol.NewBackOff(backOffPeriod, MaxContainerBackOff)</span><br><span class="line"></span><br><span class="line">	klet.livenessManager = proberesults.NewManager()</span><br><span class="line">	klet.readinessManager = proberesults.NewManager()</span><br><span class="line">	klet.startupManager = proberesults.NewManager()</span><br><span class="line">	klet.podCache = kubecontainer.NewCache()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// podManager is also responsible for keeping secretManager and configMapManager contents up-to-date.</span></span><br><span class="line">	mirrorPodClient := kubepod.NewBasicMirrorClient(klet.kubeClient, <span class="type">string</span>(nodeName), nodeLister)</span><br><span class="line">	klet.podManager = kubepod.NewBasicPodManager(mirrorPodClient, secretManager, configMapManager)</span><br><span class="line"></span><br><span class="line">	klet.statusManager = status.NewManager(klet.kubeClient, klet.podManager, klet)</span><br><span class="line"></span><br><span class="line">	klet.resourceAnalyzer = serverstats.NewResourceAnalyzer(klet, kubeCfg.VolumeStatsAggPeriod.Duration, kubeDeps.Recorder)</span><br><span class="line"></span><br><span class="line">	klet.runtimeService = kubeDeps.RemoteRuntimeService</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> kubeDeps.KubeClient != <span class="literal">nil</span> &#123;</span><br><span class="line">		klet.runtimeClassManager = runtimeclass.NewManager(kubeDeps.KubeClient)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// setup containerLogManager for CRI container runtime</span></span><br><span class="line">	containerLogManager, err := logs.NewContainerLogManager(</span><br><span class="line">		klet.runtimeService,</span><br><span class="line">		kubeDeps.OSInterface,</span><br><span class="line">		kubeCfg.ContainerLogMaxSize,</span><br><span class="line">		<span class="type">int</span>(kubeCfg.ContainerLogMaxFiles),</span><br><span class="line">	)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;failed to initialize container log manager: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	klet.containerLogManager = containerLogManager</span><br><span class="line"></span><br><span class="line">	klet.reasonCache = NewReasonCache()</span><br><span class="line">	klet.workQueue = queue.NewBasicWorkQueue(klet.clock)</span><br><span class="line">	klet.podWorkers = newPodWorkers(</span><br><span class="line">		klet.syncPod,</span><br><span class="line">		klet.syncTerminatingPod,</span><br><span class="line">		klet.syncTerminatedPod,</span><br><span class="line"></span><br><span class="line">		kubeDeps.Recorder,</span><br><span class="line">		klet.workQueue,</span><br><span class="line">		klet.resyncInterval,</span><br><span class="line">		backOffPeriod,</span><br><span class="line">		klet.podCache,</span><br><span class="line">	)</span><br><span class="line"></span><br><span class="line">	runtime, err := kuberuntime.NewKubeGenericRuntimeManager(</span><br><span class="line">		kubecontainer.FilterEventRecorder(kubeDeps.Recorder),</span><br><span class="line">		klet.livenessManager,</span><br><span class="line">		klet.readinessManager,</span><br><span class="line">		klet.startupManager,</span><br><span class="line">		rootDirectory,</span><br><span class="line">		machineInfo,</span><br><span class="line">		klet.podWorkers,</span><br><span class="line">		kubeDeps.OSInterface,</span><br><span class="line">		klet,</span><br><span class="line">		httpClient,</span><br><span class="line">		imageBackOff,</span><br><span class="line">		kubeCfg.SerializeImagePulls,</span><br><span class="line">		<span class="type">float32</span>(kubeCfg.RegistryPullQPS),</span><br><span class="line">		<span class="type">int</span>(kubeCfg.RegistryBurst),</span><br><span class="line">		imageCredentialProviderConfigFile,</span><br><span class="line">		imageCredentialProviderBinDir,</span><br><span class="line">		kubeCfg.CPUCFSQuota,</span><br><span class="line">		kubeCfg.CPUCFSQuotaPeriod,</span><br><span class="line">		kubeDeps.RemoteRuntimeService,</span><br><span class="line">		kubeDeps.RemoteImageService,</span><br><span class="line">		kubeDeps.ContainerManager.InternalContainerLifecycle(),</span><br><span class="line">		klet.containerLogManager,</span><br><span class="line">		klet.runtimeClassManager,</span><br><span class="line">		seccompDefault,</span><br><span class="line">		kubeCfg.MemorySwap.SwapBehavior,</span><br><span class="line">		kubeDeps.ContainerManager.GetNodeAllocatableAbsolute,</span><br><span class="line">		*kubeCfg.MemoryThrottlingFactor,</span><br><span class="line">	)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	klet.containerRuntime = runtime</span><br><span class="line">	klet.streamingRuntime = runtime</span><br><span class="line">	klet.runner = runtime</span><br><span class="line"></span><br><span class="line">	runtimeCache, err := kubecontainer.NewRuntimeCache(klet.containerRuntime)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	klet.runtimeCache = runtimeCache</span><br><span class="line"></span><br><span class="line">	<span class="comment">// common provider to get host file system usage associated with a pod managed by kubelet</span></span><br><span class="line">	hostStatsProvider := stats.NewHostStatsProvider(kubecontainer.RealOS&#123;&#125;, <span class="function"><span class="keyword">func</span><span class="params">(podUID types.UID)</span></span> <span class="type">string</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> getEtcHostsPath(klet.getPodDir(podUID))</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">if</span> kubeDeps.useLegacyCadvisorStats &#123;</span><br><span class="line">		klet.StatsProvider = stats.NewCadvisorStatsProvider(</span><br><span class="line">			klet.cadvisor,</span><br><span class="line">			klet.resourceAnalyzer,</span><br><span class="line">			klet.podManager,</span><br><span class="line">			klet.runtimeCache,</span><br><span class="line">			klet.containerRuntime,</span><br><span class="line">			klet.statusManager,</span><br><span class="line">			hostStatsProvider)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		klet.StatsProvider = stats.NewCRIStatsProvider(</span><br><span class="line">			klet.cadvisor,</span><br><span class="line">			klet.resourceAnalyzer,</span><br><span class="line">			klet.podManager,</span><br><span class="line">			klet.runtimeCache,</span><br><span class="line">			kubeDeps.RemoteRuntimeService,</span><br><span class="line">			kubeDeps.RemoteImageService,</span><br><span class="line">			hostStatsProvider,</span><br><span class="line">			utilfeature.DefaultFeatureGate.Enabled(features.PodAndContainerStatsFromCRI))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	klet.pleg = pleg.NewGenericPLEG(klet.containerRuntime, plegChannelCapacity, plegRelistPeriod, klet.podCache, clock.RealClock&#123;&#125;)</span><br><span class="line">	klet.runtimeState = newRuntimeState(maxWaitForContainerRuntime)</span><br><span class="line">	klet.runtimeState.addHealthCheck(<span class="string">&quot;PLEG&quot;</span>, klet.pleg.Healthy)</span><br><span class="line">	<span class="keyword">if</span> _, err := klet.updatePodCIDR(kubeCfg.PodCIDR); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		klog.ErrorS(err, <span class="string">&quot;Pod CIDR update failed&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// setup containerGC</span></span><br><span class="line">	containerGC, err := kubecontainer.NewContainerGC(klet.containerRuntime, containerGCPolicy, klet.sourcesReady)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	klet.containerGC = containerGC</span><br><span class="line">	klet.containerDeletor = newPodContainerDeletor(klet.containerRuntime, integer.IntMax(containerGCPolicy.MaxPerPodContainer, minDeadContainerInPod))</span><br><span class="line"></span><br><span class="line">	<span class="comment">// setup imageManager</span></span><br><span class="line">	imageManager, err := images.NewImageGCManager(klet.containerRuntime, klet.StatsProvider, kubeDeps.Recorder, nodeRef, imageGCPolicy, crOptions.PodSandboxImage)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;failed to initialize image manager: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	klet.imageManager = imageManager</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> kubeCfg.ServerTLSBootstrap &amp;&amp; kubeDeps.TLSOptions != <span class="literal">nil</span> &amp;&amp; utilfeature.DefaultFeatureGate.Enabled(features.RotateKubeletServerCertificate) &#123;</span><br><span class="line">		klet.serverCertificateManager, err = kubeletcertificate.NewKubeletServerCertificateManager(klet.kubeClient, kubeCfg, klet.nodeName, klet.getLastObservedNodeAddresses, certDirectory)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;failed to initialize certificate manager: %v&quot;</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">		kubeDeps.TLSOptions.Config.GetCertificate = <span class="function"><span class="keyword">func</span><span class="params">(*tls.ClientHelloInfo)</span></span> (*tls.Certificate, <span class="type">error</span>) &#123;</span><br><span class="line">			cert := klet.serverCertificateManager.Current()</span><br><span class="line">			<span class="keyword">if</span> cert == <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;no serving certificate available for the kubelet&quot;</span>)</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> cert, <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> kubeDeps.ProbeManager != <span class="literal">nil</span> &#123;</span><br><span class="line">		klet.probeManager = kubeDeps.ProbeManager</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		klet.probeManager = prober.NewManager(</span><br><span class="line">			klet.statusManager,</span><br><span class="line">			klet.livenessManager,</span><br><span class="line">			klet.readinessManager,</span><br><span class="line">			klet.startupManager,</span><br><span class="line">			klet.runner,</span><br><span class="line">			kubeDeps.Recorder)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	tokenManager := token.NewManager(kubeDeps.KubeClient)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// NewInitializedVolumePluginMgr initializes some storageErrors on the Kubelet runtimeState (in csi_plugin.go init)</span></span><br><span class="line">	<span class="comment">// which affects node ready status. This function must be called before Kubelet is initialized so that the Node</span></span><br><span class="line">	<span class="comment">// ReadyState is accurate with the storage state.</span></span><br><span class="line">	klet.volumePluginMgr, err =</span><br><span class="line">		NewInitializedVolumePluginMgr(klet, secretManager, configMapManager, tokenManager, kubeDeps.VolumePlugins, kubeDeps.DynamicPluginProber)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	klet.pluginManager = pluginmanager.NewPluginManager(</span><br><span class="line">		klet.getPluginsRegistrationDir(), <span class="comment">/* sockDir */</span></span><br><span class="line">		kubeDeps.Recorder,</span><br><span class="line">	)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// If the experimentalMounterPathFlag is set, we do not want to</span></span><br><span class="line">	<span class="comment">// check node capabilities since the mount path is not the default</span></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(experimentalMounterPath) != <span class="number">0</span> &#123;</span><br><span class="line">		<span class="comment">// Replace the nameserver in containerized-mounter&#x27;s rootfs/etc/resolv.conf with kubelet.ClusterDNS</span></span><br><span class="line">		<span class="comment">// so that service name could be resolved</span></span><br><span class="line">		klet.dnsConfigurer.SetupDNSinContainerizedMounter(experimentalMounterPath)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// setup volumeManager</span></span><br><span class="line">	klet.volumeManager = volumemanager.NewVolumeManager(</span><br><span class="line">		kubeCfg.EnableControllerAttachDetach,</span><br><span class="line">		nodeName,</span><br><span class="line">		klet.podManager,</span><br><span class="line">		klet.podWorkers,</span><br><span class="line">		klet.kubeClient,</span><br><span class="line">		klet.volumePluginMgr,</span><br><span class="line">		klet.containerRuntime,</span><br><span class="line">		kubeDeps.Mounter,</span><br><span class="line">		kubeDeps.HostUtil,</span><br><span class="line">		klet.getPodsDir(),</span><br><span class="line">		kubeDeps.Recorder,</span><br><span class="line">		keepTerminatedPodVolumes,</span><br><span class="line">		volumepathhandler.NewBlockVolumePathHandler())</span><br><span class="line"></span><br><span class="line">	klet.backOff = flowcontrol.NewBackOff(backOffPeriod, MaxContainerBackOff)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// setup eviction manager</span></span><br><span class="line">	evictionManager, evictionAdmitHandler := eviction.NewManager(klet.resourceAnalyzer, evictionConfig,</span><br><span class="line">		killPodNow(klet.podWorkers, kubeDeps.Recorder), klet.podManager.GetMirrorPodByPod, klet.imageManager, klet.containerGC, kubeDeps.Recorder, nodeRef, klet.clock, kubeCfg.LocalStorageCapacityIsolation)</span><br><span class="line"></span><br><span class="line">	klet.evictionManager = evictionManager</span><br><span class="line">	klet.admitHandlers.AddPodAdmitHandler(evictionAdmitHandler)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Safe, allowed sysctls can always be used as unsafe sysctls in the spec.</span></span><br><span class="line">	<span class="comment">// Hence, we concatenate those two lists.</span></span><br><span class="line">	safeAndUnsafeSysctls := <span class="built_in">append</span>(sysctl.SafeSysctlAllowlist(), allowedUnsafeSysctls...)</span><br><span class="line">	sysctlsAllowlist, err := sysctl.NewAllowlist(safeAndUnsafeSysctls)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	klet.admitHandlers.AddPodAdmitHandler(sysctlsAllowlist)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// enable active deadline handler</span></span><br><span class="line">	activeDeadlineHandler, err := newActiveDeadlineHandler(klet.statusManager, kubeDeps.Recorder, klet.clock)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	klet.AddPodSyncLoopHandler(activeDeadlineHandler)</span><br><span class="line">	klet.AddPodSyncHandler(activeDeadlineHandler)</span><br><span class="line"></span><br><span class="line">	klet.admitHandlers.AddPodAdmitHandler(klet.containerManager.GetAllocateResourcesPodAdmitHandler())</span><br><span class="line"></span><br><span class="line">	criticalPodAdmissionHandler := preemption.NewCriticalPodAdmissionHandler(klet.GetActivePods, killPodNow(klet.podWorkers, kubeDeps.Recorder), kubeDeps.Recorder)</span><br><span class="line">	klet.admitHandlers.AddPodAdmitHandler(lifecycle.NewPredicateAdmitHandler(klet.getNodeAnyWay, criticalPodAdmissionHandler, klet.containerManager.UpdatePluginResources))</span><br><span class="line">	<span class="comment">// apply functional Option&#x27;s</span></span><br><span class="line">	<span class="keyword">for</span> _, opt := <span class="keyword">range</span> kubeDeps.Options &#123;</span><br><span class="line">		opt(klet)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> sysruntime.GOOS == <span class="string">&quot;linux&quot;</span> &#123;</span><br><span class="line">		<span class="comment">// AppArmor is a Linux kernel security module and it does not support other operating systems.</span></span><br><span class="line">		klet.appArmorValidator = apparmor.NewValidator()</span><br><span class="line">		klet.softAdmitHandlers.AddPodAdmitHandler(lifecycle.NewAppArmorAdmitHandler(klet.appArmorValidator))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	leaseDuration := time.Duration(kubeCfg.NodeLeaseDurationSeconds) * time.Second</span><br><span class="line">	renewInterval := time.Duration(<span class="type">float64</span>(leaseDuration) * nodeLeaseRenewIntervalFraction)</span><br><span class="line">	klet.nodeLeaseController = lease.NewController(</span><br><span class="line">		klet.clock,</span><br><span class="line">		klet.heartbeatClient,</span><br><span class="line">		<span class="type">string</span>(klet.nodeName),</span><br><span class="line">		kubeCfg.NodeLeaseDurationSeconds,</span><br><span class="line">		klet.onRepeatedHeartbeatFailure,</span><br><span class="line">		renewInterval,</span><br><span class="line">		v1.NamespaceNodeLease,</span><br><span class="line">		util.SetNodeOwnerFunc(klet.heartbeatClient, <span class="type">string</span>(klet.nodeName)))</span><br><span class="line"></span><br><span class="line">	<span class="comment">// setup node shutdown manager</span></span><br><span class="line">	shutdownManager, shutdownAdmitHandler := nodeshutdown.NewManager(&amp;nodeshutdown.Config&#123;</span><br><span class="line">		Logger:                           logger,</span><br><span class="line">		ProbeManager:                     klet.probeManager,</span><br><span class="line">		Recorder:                         kubeDeps.Recorder,</span><br><span class="line">		NodeRef:                          nodeRef,</span><br><span class="line">		GetPodsFunc:                      klet.GetActivePods,</span><br><span class="line">		KillPodFunc:                      killPodNow(klet.podWorkers, kubeDeps.Recorder),</span><br><span class="line">		SyncNodeStatusFunc:               klet.syncNodeStatus,</span><br><span class="line">		ShutdownGracePeriodRequested:     kubeCfg.ShutdownGracePeriod.Duration,</span><br><span class="line">		ShutdownGracePeriodCriticalPods:  kubeCfg.ShutdownGracePeriodCriticalPods.Duration,</span><br><span class="line">		ShutdownGracePeriodByPodPriority: kubeCfg.ShutdownGracePeriodByPodPriority,</span><br><span class="line">		StateDirectory:                   rootDirectory,</span><br><span class="line">	&#125;)</span><br><span class="line">	klet.shutdownManager = shutdownManager</span><br><span class="line">	klet.usernsManager, err = MakeUserNsManager(klet)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	klet.admitHandlers.AddPodAdmitHandler(shutdownAdmitHandler)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Finally, put the most recent version of the config on the Kubelet, so</span></span><br><span class="line">	<span class="comment">// people can see how it was configured.</span></span><br><span class="line">	klet.kubeletConfiguration = *kubeCfg</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Generating the status funcs should be the last thing we do,</span></span><br><span class="line">	<span class="comment">// since this relies on the rest of the Kubelet having been constructed.</span></span><br><span class="line">	klet.setNodeStatusFuncs = klet.defaultNodeStatusFuncs()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> klet, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>最后通过一个Event，标志启动</p>
<ul>
<li><p>Ref:<a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/88e994f6bf8fc88114c5b733e09afea339bea66d/pkg/kubelet/kubelet.go#L2398">https://github.com/kubernetes/kubernetes/blob/88e994f6bf8fc88114c5b733e09afea339bea66d/pkg/kubelet/kubelet.go#L2398</a></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// BirthCry sends an event that the kubelet has started up.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(kl *Kubelet)</span></span> BirthCry() &#123;</span><br><span class="line">	<span class="comment">// Make an event that kubelet restarted.</span></span><br><span class="line">	kl.recorder.Eventf(kl.nodeRef, v1.EventTypeNormal, events.StartingKubelet, <span class="string">&quot;Starting kubelet.&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p>注意在standone模式下，EventBroadcaster实际上不会被启动，因此在该模式下，Event不会被发送</p>
</blockquote>
<p>最后通过StartGrageCollection 启动垃圾回收服务，包含ConainerGC 协程和Imgae GC协程</p>
<h2 id="启动kubelet主服务"><a href="#启动kubelet主服务" class="headerlink" title="启动kubelet主服务"></a>启动kubelet主服务</h2><p>在创建kubelet对象之后，通过statKubelet启动</p>
<ul>
<li><p>Ref：<a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/88e994f6bf8fc88114c5b733e09afea339bea66d/cmd/kubelet/app/server.go#L1180">https://github.com/kubernetes/kubernetes/blob/88e994f6bf8fc88114c5b733e09afea339bea66d/cmd/kubelet/app/server.go#L1180</a></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">startKubelet</span><span class="params">(k kubelet.Bootstrap, podCfg *config.PodConfig, kubeCfg *kubeletconfiginternal.KubeletConfiguration, kubeDeps *kubelet.Dependencies, enableServer <span class="type">bool</span>)</span></span> &#123;</span><br><span class="line">	<span class="comment">// start the kubelet</span></span><br><span class="line">	<span class="keyword">go</span> k.Run(podCfg.Updates())</span><br><span class="line"></span><br><span class="line">	<span class="comment">// start the kubelet server</span></span><br><span class="line">	<span class="keyword">if</span> enableServer &#123;</span><br><span class="line">		<span class="keyword">go</span> k.ListenAndServe(kubeCfg, kubeDeps.TLSOptions, kubeDeps.Auth, kubeDeps.TracerProvider)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> kubeCfg.ReadOnlyPort &gt; <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">go</span> k.ListenAndServeReadOnly(netutils.ParseIPSloppy(kubeCfg.Address), <span class="type">uint</span>(kubeCfg.ReadOnlyPort))</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> utilfeature.DefaultFeatureGate.Enabled(features.KubeletPodResources) &#123;</span><br><span class="line">		<span class="keyword">go</span> k.ListenAndServePodResources()</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>statKubelet func使用非阻塞，启动，k.Run 负责启动kubelet的内部依赖模块</p>
<blockquote>
<p>kubelet在启动的时候，可以通过kl.initNetworkUitl func为当前节点配置iptables规则，可以通过kl.initNewworkUtil func当前节点配置iptables规则，主要是初始化与MASQUERADE和DROP相关的iptables处理链，仅适用于Linux操作系统，该功能主要是通过kubelet的 –make-iptables-utils-chains启动参数控制，默认开启该功能。</p>
<p>kl.initNewworkUtil内部启用一个协程，监听mange\nat和filter三个Table下的KUBE-KUBELET-CANRY Chain的变化事件，如果发送变化，则自动尝试重新同步规则，以保证操作系统的iptables始终存在符合kubelet要求的规则，</p>
</blockquote>
<ul>
<li><p>Ref:<a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/88e994f6bf8fc88114c5b733e09afea339bea66d/pkg/kubelet/kubelet_network_linux.go#L53">https://github.com/kubernetes/kubernetes/blob/88e994f6bf8fc88114c5b733e09afea339bea66d/pkg/kubelet/kubelet_network_linux.go#L53</a></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(kl *Kubelet)</span></span> initNetworkUtil() &#123;</span><br><span class="line">	exec := utilexec.New()</span><br><span class="line">	iptClients := []utiliptables.Interface&#123;</span><br><span class="line">		utiliptables.New(exec, utiliptables.ProtocolIPv4),</span><br><span class="line">		utiliptables.New(exec, utiliptables.ProtocolIPv6),</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i := <span class="keyword">range</span> iptClients &#123;</span><br><span class="line">		iptClient := iptClients[i]</span><br><span class="line">		<span class="keyword">if</span> kl.syncIPTablesRules(iptClient) &#123;</span><br><span class="line">			klog.InfoS(<span class="string">&quot;Initialized iptables rules.&quot;</span>, <span class="string">&quot;protocol&quot;</span>, iptClient.Protocol())</span><br><span class="line">			<span class="keyword">go</span> iptClient.Monitor(</span><br><span class="line">				utiliptables.Chain(<span class="string">&quot;KUBE-KUBELET-CANARY&quot;</span>),</span><br><span class="line">				[]utiliptables.Table&#123;utiliptables.TableMangle, utiliptables.TableNAT, utiliptables.TableFilter&#125;,</span><br><span class="line">				<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; kl.syncIPTablesRules(iptClient) &#125;,</span><br><span class="line">				<span class="number">1</span>*time.Minute, wait.NeverStop,</span><br><span class="line">			)</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			klog.InfoS(<span class="string">&quot;Failed to initialize iptables rules; some functionality may be missing.&quot;</span>, <span class="string">&quot;protocol&quot;</span>, iptClient.Protocol())</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>kubelet向操作系统写入iptables规则和相关说明（IPv4）</p>
<ol>
<li>mangle table</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">iptables模式有俩种版本，iptables-legacy和iptables-nft</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建KUBE-IPTABLES-HINT Chain以通知其他组件kubelet正在使用的iptables</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">其他组件（如iptables-wappers）可以通过检查该Chain是否存在在于对应版本（或模式）的规则列表中来判断kubelet正在使用iptables版本（或模式）</span></span><br><span class="line">-N KUBE-IPTABLES-HINT</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在监听kubelt监听iptables规则</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">当Chain发生变化，往往意味着iptables规则被flush被清空，立即触发执行iptables规则同步</span></span><br><span class="line">-N KUBE-KUBELETF-CANARY</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p>nat table</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在kubelet监听iptables变化使用</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">当Chain发生变化的时候，往往意味着iptables规则被flush清空，立即触发执行iptables规则同步</span></span><br><span class="line">-N KUBE-KUBELET_CANARY</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">KUBE-MARK-MASQ为数据包添加MARK标记0x4000/0x4000（由--iptables-masquerade-bit 控制）</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在nat table的POSTOUTING阶段，携带0x4000/0x4000 标记的数据包自动执行MASQUERADE（SNAT）</span></span><br><span class="line">-N KUBE-MARK-MASQ</span><br><span class="line">-N KUBE-MARK-MASQ -j MARK --set-xmark 0x4000/0x4000</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">KUBE-MARK-DROP为数据包添加0x8000/0x8000 （由--iptables--drop-bit参数控制）</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在filter table的INPUT/OUTPUT 0x8000/0x8000的数据包被丢弃</span></span><br><span class="line">-N KUBE-MARK-DROP</span><br><span class="line">-N KUBE-MARK-DROP -j MARK --set-xmark 0x8000/0x8000</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建KUBE-POSTOUTING Chain，并且添加到POSTOUTING执行链</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">KUBE-POSTOUTING通过检查数据包是否携带0x4000/0x4000标记，决定是否执行MASQUERADE</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">不包含0x4000/0x4000标记的数据包直接-j RETURN 返回</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
</li>
<li><p>Filter table</p>
</li>
</ol>
<blockquote>
<p>⚠️随着Dockershim移除，kubelet本身不依赖这些iptables，社区正在考虑kubelet管理的iptables交由kube-proxy管理</p>
<p>提案：KEP-3178</p>
</blockquote>
<p>Kl.syncLoop func启动kubelet的主协程程序，不断从Channel中读取Event</p>
<ul>
<li><p>Ref:<a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/88e994f6bf8fc88114c5b733e09afea339bea66d/pkg/kubelet/kubelet.go#L2009">https://github.com/kubernetes/kubernetes/blob/88e994f6bf8fc88114c5b733e09afea339bea66d/pkg/kubelet/kubelet.go#L2009</a></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// syncLoop is the main loop for processing changes. It watches for changes from</span></span><br><span class="line"><span class="comment">// three channels (file, apiserver, and http) and creates a union of them. For</span></span><br><span class="line"><span class="comment">// any new change seen, will run a sync against desired state and running state. If</span></span><br><span class="line"><span class="comment">// no changes are seen to the configuration, will synchronize the last known desired</span></span><br><span class="line"><span class="comment">// state every sync-frequency seconds. Never returns.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(kl *Kubelet)</span></span> syncLoop(updates &lt;-<span class="keyword">chan</span> kubetypes.PodUpdate, handler SyncHandler) &#123;</span><br><span class="line">	klog.InfoS(<span class="string">&quot;Starting kubelet main sync loop&quot;</span>)</span><br><span class="line">	<span class="comment">// The syncTicker wakes up kubelet to checks if there are any pod workers</span></span><br><span class="line">	<span class="comment">// that need to be sync&#x27;d. A one-second period is sufficient because the</span></span><br><span class="line">	<span class="comment">// sync interval is defaulted to 10s.</span></span><br><span class="line">	syncTicker := time.NewTicker(time.Second)</span><br><span class="line">	<span class="keyword">defer</span> syncTicker.Stop()</span><br><span class="line">	housekeepingTicker := time.NewTicker(housekeepingPeriod)</span><br><span class="line">	<span class="keyword">defer</span> housekeepingTicker.Stop()</span><br><span class="line">	plegCh := kl.pleg.Watch()</span><br><span class="line">	<span class="keyword">const</span> (</span><br><span class="line">		base   = <span class="number">100</span> * time.Millisecond</span><br><span class="line">		max    = <span class="number">5</span> * time.Second</span><br><span class="line">		factor = <span class="number">2</span></span><br><span class="line">	)</span><br><span class="line">	duration := base</span><br><span class="line">	<span class="comment">// Responsible for checking limits in resolv.conf</span></span><br><span class="line">	<span class="comment">// The limits do not have anything to do with individual pods</span></span><br><span class="line">	<span class="comment">// Since this is called in syncLoop, we don&#x27;t need to call it anywhere else</span></span><br><span class="line">	<span class="keyword">if</span> kl.dnsConfigurer != <span class="literal">nil</span> &amp;&amp; kl.dnsConfigurer.ResolverConfig != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		kl.dnsConfigurer.CheckLimitsForResolvConf()</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> err := kl.runtimeState.runtimeErrors(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			klog.ErrorS(err, <span class="string">&quot;Skipping pod synchronization&quot;</span>)</span><br><span class="line">			<span class="comment">// exponential backoff</span></span><br><span class="line">			time.Sleep(duration)</span><br><span class="line">			duration = time.Duration(math.Min(<span class="type">float64</span>(max), factor*<span class="type">float64</span>(duration)))</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// reset backoff if we have a success</span></span><br><span class="line">		duration = base</span><br><span class="line"></span><br><span class="line">		kl.syncLoopMonitor.Store(kl.clock.Now())</span><br><span class="line">		<span class="keyword">if</span> !kl.syncLoopIteration(updates, handler, syncTicker.C, housekeepingTicker.C, plegCh) &#123;</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">		kl.syncLoopMonitor.Store(kl.clock.Now())</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>Channel不断读取Event，交给对应Handle处理</p>
<ul>
<li><p>Ref:<a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/88e994f6bf8fc88114c5b733e09afea339bea66d/pkg/kubelet/kubelet.go#L2083">https://github.com/kubernetes/kubernetes/blob/88e994f6bf8fc88114c5b733e09afea339bea66d/pkg/kubelet/kubelet.go#L2083</a></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// syncLoopIteration reads from various channels and dispatches pods to the</span></span><br><span class="line"><span class="comment">// given handler.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Arguments:</span></span><br><span class="line"><span class="comment">// 1.  configCh:       a channel to read config events from</span></span><br><span class="line"><span class="comment">// 2.  handler:        the SyncHandler to dispatch pods to</span></span><br><span class="line"><span class="comment">// 3.  syncCh:         a channel to read periodic sync events from</span></span><br><span class="line"><span class="comment">// 4.  housekeepingCh: a channel to read housekeeping events from</span></span><br><span class="line"><span class="comment">// 5.  plegCh:         a channel to read PLEG updates from</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Events are also read from the kubelet liveness manager&#x27;s update channel.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// The workflow is to read from one of the channels, handle that event, and</span></span><br><span class="line"><span class="comment">// update the timestamp in the sync loop monitor.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Here is an appropriate place to note that despite the syntactical</span></span><br><span class="line"><span class="comment">// similarity to the switch statement, the case statements in a select are</span></span><br><span class="line"><span class="comment">// evaluated in a pseudorandom order if there are multiple channels ready to</span></span><br><span class="line"><span class="comment">// read from when the select is evaluated.  In other words, case statements</span></span><br><span class="line"><span class="comment">// are evaluated in random order, and you can not assume that the case</span></span><br><span class="line"><span class="comment">// statements evaluate in order if multiple channels have events.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// With that in mind, in truly no particular order, the different channels</span></span><br><span class="line"><span class="comment">// are handled as follows:</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//   - configCh: dispatch the pods for the config change to the appropriate</span></span><br><span class="line"><span class="comment">//     handler callback for the event type</span></span><br><span class="line"><span class="comment">//   - plegCh: update the runtime cache; sync pod</span></span><br><span class="line"><span class="comment">//   - syncCh: sync all pods waiting for sync</span></span><br><span class="line"><span class="comment">//   - housekeepingCh: trigger cleanup of pods</span></span><br><span class="line"><span class="comment">//   - health manager: sync pods that have failed or in which one or more</span></span><br><span class="line"><span class="comment">//     containers have failed health checks</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(kl *Kubelet)</span></span> syncLoopIteration(configCh &lt;-<span class="keyword">chan</span> kubetypes.PodUpdate, handler SyncHandler,</span><br><span class="line">	syncCh &lt;-<span class="keyword">chan</span> time.Time, housekeepingCh &lt;-<span class="keyword">chan</span> time.Time, plegCh &lt;-<span class="keyword">chan</span> *pleg.PodLifecycleEvent) <span class="type">bool</span> &#123;</span><br><span class="line">	<span class="keyword">select</span> &#123;</span><br><span class="line">	<span class="keyword">case</span> u, open := &lt;-configCh:</span><br><span class="line">		<span class="comment">// Update from a config source; dispatch it to the right handler</span></span><br><span class="line">		<span class="comment">// callback.</span></span><br><span class="line">		<span class="keyword">if</span> !open &#123;</span><br><span class="line">			klog.ErrorS(<span class="literal">nil</span>, <span class="string">&quot;Update channel is closed, exiting the sync loop&quot;</span>)</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">switch</span> u.Op &#123;</span><br><span class="line">		<span class="keyword">case</span> kubetypes.ADD:</span><br><span class="line">			klog.V(<span class="number">2</span>).InfoS(<span class="string">&quot;SyncLoop ADD&quot;</span>, <span class="string">&quot;source&quot;</span>, u.Source, <span class="string">&quot;pods&quot;</span>, klog.KObjs(u.Pods))</span><br><span class="line">			<span class="comment">// After restarting, kubelet will get all existing pods through</span></span><br><span class="line">			<span class="comment">// ADD as if they are new pods. These pods will then go through the</span></span><br><span class="line">			<span class="comment">// admission process and *may* be rejected. This can be resolved</span></span><br><span class="line">			<span class="comment">// once we have checkpointing.</span></span><br><span class="line">			handler.HandlePodAdditions(u.Pods)</span><br><span class="line">		<span class="keyword">case</span> kubetypes.UPDATE:</span><br><span class="line">			klog.V(<span class="number">2</span>).InfoS(<span class="string">&quot;SyncLoop UPDATE&quot;</span>, <span class="string">&quot;source&quot;</span>, u.Source, <span class="string">&quot;pods&quot;</span>, klog.KObjs(u.Pods))</span><br><span class="line">			handler.HandlePodUpdates(u.Pods)</span><br><span class="line">		<span class="keyword">case</span> kubetypes.REMOVE:</span><br><span class="line">			klog.V(<span class="number">2</span>).InfoS(<span class="string">&quot;SyncLoop REMOVE&quot;</span>, <span class="string">&quot;source&quot;</span>, u.Source, <span class="string">&quot;pods&quot;</span>, klog.KObjs(u.Pods))</span><br><span class="line">			handler.HandlePodRemoves(u.Pods)</span><br><span class="line">		<span class="keyword">case</span> kubetypes.RECONCILE:</span><br><span class="line">			klog.V(<span class="number">4</span>).InfoS(<span class="string">&quot;SyncLoop RECONCILE&quot;</span>, <span class="string">&quot;source&quot;</span>, u.Source, <span class="string">&quot;pods&quot;</span>, klog.KObjs(u.Pods))</span><br><span class="line">			handler.HandlePodReconcile(u.Pods)</span><br><span class="line">		<span class="keyword">case</span> kubetypes.DELETE:</span><br><span class="line">			klog.V(<span class="number">2</span>).InfoS(<span class="string">&quot;SyncLoop DELETE&quot;</span>, <span class="string">&quot;source&quot;</span>, u.Source, <span class="string">&quot;pods&quot;</span>, klog.KObjs(u.Pods))</span><br><span class="line">			<span class="comment">// DELETE is treated as a UPDATE because of graceful deletion.</span></span><br><span class="line">			handler.HandlePodUpdates(u.Pods)</span><br><span class="line">		<span class="keyword">case</span> kubetypes.SET:</span><br><span class="line">			<span class="comment">// <span class="doctag">TODO:</span> Do we want to support this?</span></span><br><span class="line">			klog.ErrorS(<span class="literal">nil</span>, <span class="string">&quot;Kubelet does not support snapshot update&quot;</span>)</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			klog.ErrorS(<span class="literal">nil</span>, <span class="string">&quot;Invalid operation type received&quot;</span>, <span class="string">&quot;operation&quot;</span>, u.Op)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		kl.sourcesReady.AddSource(u.Source)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">case</span> e := &lt;-plegCh:</span><br><span class="line">		<span class="keyword">if</span> e.Type == pleg.ContainerStarted &#123;</span><br><span class="line">			<span class="comment">// record the most recent time we observed a container start for this pod.</span></span><br><span class="line">			<span class="comment">// this lets us selectively invalidate the runtimeCache when processing a delete for this pod</span></span><br><span class="line">			<span class="comment">// to make sure we don&#x27;t miss handling graceful termination for containers we reported as having started.</span></span><br><span class="line">			kl.lastContainerStartedTime.Add(e.ID, time.Now())</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> isSyncPodWorthy(e) &#123;</span><br><span class="line">			<span class="comment">// PLEG event for a pod; sync it.</span></span><br><span class="line">			<span class="keyword">if</span> pod, ok := kl.podManager.GetPodByUID(e.ID); ok &#123;</span><br><span class="line">				klog.V(<span class="number">2</span>).InfoS(<span class="string">&quot;SyncLoop (PLEG): event for pod&quot;</span>, <span class="string">&quot;pod&quot;</span>, klog.KObj(pod), <span class="string">&quot;event&quot;</span>, e)</span><br><span class="line">				handler.HandlePodSyncs([]*v1.Pod&#123;pod&#125;)</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="comment">// If the pod no longer exists, ignore the event.</span></span><br><span class="line">				klog.V(<span class="number">4</span>).InfoS(<span class="string">&quot;SyncLoop (PLEG): pod does not exist, ignore irrelevant event&quot;</span>, <span class="string">&quot;event&quot;</span>, e)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> e.Type == pleg.ContainerDied &#123;</span><br><span class="line">			<span class="keyword">if</span> containerID, ok := e.Data.(<span class="type">string</span>); ok &#123;</span><br><span class="line">				kl.cleanUpContainersInPod(e.ID, containerID)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	<span class="keyword">case</span> &lt;-syncCh:</span><br><span class="line">		<span class="comment">// Sync pods waiting for sync</span></span><br><span class="line">		podsToSync := kl.getPodsToSync()</span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(podsToSync) == <span class="number">0</span> &#123;</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">		klog.V(<span class="number">4</span>).InfoS(<span class="string">&quot;SyncLoop (SYNC) pods&quot;</span>, <span class="string">&quot;total&quot;</span>, <span class="built_in">len</span>(podsToSync), <span class="string">&quot;pods&quot;</span>, klog.KObjs(podsToSync))</span><br><span class="line">		handler.HandlePodSyncs(podsToSync)</span><br><span class="line">	<span class="keyword">case</span> update := &lt;-kl.livenessManager.Updates():</span><br><span class="line">		<span class="keyword">if</span> update.Result == proberesults.Failure &#123;</span><br><span class="line">			handleProbeSync(kl, update, handler, <span class="string">&quot;liveness&quot;</span>, <span class="string">&quot;unhealthy&quot;</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	<span class="keyword">case</span> update := &lt;-kl.readinessManager.Updates():</span><br><span class="line">		ready := update.Result == proberesults.Success</span><br><span class="line">		kl.statusManager.SetContainerReadiness(update.PodUID, update.ContainerID, ready)</span><br><span class="line"></span><br><span class="line">		status := <span class="string">&quot;&quot;</span></span><br><span class="line">		<span class="keyword">if</span> ready &#123;</span><br><span class="line">			status = <span class="string">&quot;ready&quot;</span></span><br><span class="line">		&#125;</span><br><span class="line">		handleProbeSync(kl, update, handler, <span class="string">&quot;readiness&quot;</span>, status)</span><br><span class="line">	<span class="keyword">case</span> update := &lt;-kl.startupManager.Updates():</span><br><span class="line">		started := update.Result == proberesults.Success</span><br><span class="line">		kl.statusManager.SetContainerStartup(update.PodUID, update.ContainerID, started)</span><br><span class="line"></span><br><span class="line">		status := <span class="string">&quot;unhealthy&quot;</span></span><br><span class="line">		<span class="keyword">if</span> started &#123;</span><br><span class="line">			status = <span class="string">&quot;started&quot;</span></span><br><span class="line">		&#125;</span><br><span class="line">		handleProbeSync(kl, update, handler, <span class="string">&quot;startup&quot;</span>, status)</span><br><span class="line">	<span class="keyword">case</span> &lt;-housekeepingCh:</span><br><span class="line">		<span class="keyword">if</span> !kl.sourcesReady.AllReady() &#123;</span><br><span class="line">			<span class="comment">// If the sources aren&#x27;t ready or volume manager has not yet synced the states,</span></span><br><span class="line">			<span class="comment">// skip housekeeping, as we may accidentally delete pods from unready sources.</span></span><br><span class="line">			klog.V(<span class="number">4</span>).InfoS(<span class="string">&quot;SyncLoop (housekeeping, skipped): sources aren&#x27;t ready yet&quot;</span>)</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			start := time.Now()</span><br><span class="line">			klog.V(<span class="number">4</span>).InfoS(<span class="string">&quot;SyncLoop (housekeeping)&quot;</span>)</span><br><span class="line">			<span class="keyword">if</span> err := handler.HandlePodCleanups(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				klog.ErrorS(err, <span class="string">&quot;Failed cleaning pods&quot;</span>)</span><br><span class="line">			&#125;</span><br><span class="line">			duration := time.Since(start)</span><br><span class="line">			<span class="keyword">if</span> duration &gt; housekeepingWarningDuration &#123;</span><br><span class="line">				klog.ErrorS(fmt.Errorf(<span class="string">&quot;housekeeping took too long&quot;</span>), <span class="string">&quot;Housekeeping took longer than 15s&quot;</span>, <span class="string">&quot;seconds&quot;</span>, duration.Seconds())</span><br><span class="line">			&#125;</span><br><span class="line">			klog.V(<span class="number">4</span>).InfoS(<span class="string">&quot;SyncLoop (housekeeping) end&quot;</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="启动HTTP-Server服务和gPRC-Server服务"><a href="#启动HTTP-Server服务和gPRC-Server服务" class="headerlink" title="启动HTTP Server服务和gPRC Server服务"></a>启动HTTP Server服务和gPRC Server服务</h2><p>目前只要支持以下三种HTTP Server</p>
<ul>
<li>readonly server：默认监听10255，仅提供只读类型的接口</li>
<li>kubelet core server：默认监听10250，提供健康检查、健康采集等接口</li>
<li>healthz server：默认10248，仅健康检查</li>
</ul>
<p><img src="https://raw.githubusercontent.com/Piwriw/PicGo/master/image202412132128442.png"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a target="_blank" rel="noopener" href="https://github.com/Piwriw">Joohwan.</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://piwriw.github.io/2024/12/13/cloud/k8s/kubelet/K8s-kubelet(%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B)/">https://piwriw.github.io/2024/12/13/cloud/k8s/kubelet/K8s-kubelet(启动流程)/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://piwriw.github.io" target="_blank">Joohwan</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/k8s/">k8s</a><a class="post-meta__tags" href="/tags/cloud/">cloud</a><a class="post-meta__tags" href="/tags/K8s%E6%BA%90%E7%A0%81/">K8s源码</a><a class="post-meta__tags" href="/tags/kubelet/">kubelet</a></div><div class="post-share"><div class="social-share" data-image="/img/k8sLogo.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>赞助</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2024/12/13/cloud/k8s/kubelet/K8s-kubelet(Pod%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%AE%A1%E7%90%86)/" title="K8s-kubelet(Pod生命周期管理)"><img class="cover" src="/img/k8sLogo.png" onerror="onerror=null;src='/img/404.png'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">K8s-kubelet(Pod生命周期管理)</div></div><div class="info-2"><div class="info-item-1">K8s-kubelet(Pod生命周期管理) 基于1.25  kubelet以Pod为基本处理单元，负责Pod从创建到消亡的整个生命周期   在1.21中Unknown状态已经被标记为弃用。  CRIkubelet通过CRI RPC管理容器的生命周期，执行容器的lifecycle hook和 startup&#x2F;liveness&#x2F;readiness的健康检查，同时根据Pod的重启策略在容器失败退出后自动重启容器，CRI是kubelet管理Pod和容器的基础   Ref:https://github.com/kubernetes/cri-api/blob/2c8d015e0d408208ca8843c1d6e2e2fce1e5dd94/pkg/apis/runtime/v1/api.proto#L34 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717...</div></div></div></a><a class="pagination-related" href="/2024/12/12/cloud/k8s/kubelet/K8s-kubelet(Overview)/" title="K8s-kubelet(Overview)"><img class="cover" src="/img/k8sLogo.png" onerror="onerror=null;src='/img/404.png'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">K8s-kubelet(Overview)</div></div><div class="info-2"><div class="info-item-1">K8s-kubelet(Overview) 基于1.25  kubelet是K8s中最重要的节点代理程序，运行在集群的每个节点上。  能够自动将节点注册到集群 将节点上、Pod运行状态和资源使用情况周期性上报到控制平面 同时接受控制平面发送到工作任务、启动停止容器、维护管理Pod 也包含对cAdvusor资源用量监控、容器和镜像垃圾回收  kubelet架构设计kubelet整体架构采用了基于事件的处理模型，通过syncLoop和不断调谐Podtatus和PodSpec差距 PodSpec主要来源自三个来源，kube-apiserver、file和HTTP。  file和HTTP主要用于发现Static类型的Pod kubelet默认每隔20s执行一次检测   PodStatus实际状态主要是通过PLEG周期性扫描冗余运行时的运行状态获取。 PLEG每隔1s，从容器运行时获取Pod和Container信息，并于本地缓存进行对比，发生变更的时候，生成PLEG事件，并且发送给事件订阅者触发执行事件处理程序。  默认，当产生PLEG事件，kubelet会执行sync调谐 kubelet...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2024/12/16/cloud/k8s/kubelet/K8s-kubelet(HTTP%E6%9C%8D%E5%8A%A1%E6%8E%A5%E5%8F%A3)/" title="K8s-kubelet(HTTP服务接口)"><img class="cover" src="/img/k8sLogo.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-12-16</div><div class="info-item-2">K8s-kubelet(HTTP服务接口)</div></div><div class="info-2"><div class="info-item-1">K8s-kubelet(HTTP服务接口) 基于1.25  kubelet通过HTTP Server对外暴露API，为了确保接口安全，kubelet按照安全等级从低到高顺序支持3种HTTP Server，分别是healthz server、readonly server和kubelet core server    一级类目 二级类目 Path路径 描述    Default Handlerers healthz &#x2F;healthz 检查kubelet是否健康，重点检查syncLoop是否持续在规定时间内完成。检查syncLoop四因为其他组件故障会间接导致syncLoop不能执行成功   Default Handlerers pods &#x2F;pods 读取当前节点运行的Pod列表（通过PodManager获取）   Default Handlerers stats &#x2F;stats&#x2F;summary 读取资源使用状态   Default Handlerers metrics &#x2F;metrics 读取kubelet监控指标数据   Defaul...</div></div></div></a><a class="pagination-related" href="/2024/12/15/cloud/k8s/kubelet/K8s-kubelet(PLEG%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86)/" title="K8s-kubelet(PLEG核心原理)"><img class="cover" src="/img/k8sLogo.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-12-15</div><div class="info-item-2">K8s-kubelet(PLEG核心原理)</div></div><div class="info-2"><div class="info-item-1">K8s-kubelet(PLEG核心原理) 基于1.25  PLEG是kubelet的一个重要组件，负责监控kubelet管理的节点运行的Pod的生命周期，并生成于生命周期相关的事件 PLEG产生原因在K8s中，kubelet负责维护和管理每个节点上的Pod，不断的调谐Pod的状态以使得符合Spec。  为了实现这个目标，kubelet同时需要支持对Pod Spec和Container Status 的事件监听。对于前者kubelet通过watch不同源的对PodSpec事件实现，对于后者，PLEG之前，不断需要Pod处理协程不断的周期性拉取最新状态，尝试了大量轮询压力。 在kubeletv1.2.0版本引入了PLEG，目标是改善kubelet的可拓展性 减少不必要的处理操作（当状态为发生变化时，不执行无效的调谐操作） 减少对底层容器运行的并发请求，以减轻容器运行时的压力    PLEG架构设计PLEG主要包含俩个核心工作，一是感受容器变化，生成Pod事件，俩是维持一份最新的Pod Status Cache数据供其他组件读取。   kubelet同时接收俩个方向的事件，Pod S...</div></div></div></a><a class="pagination-related" href="/2024/12/14/cloud/k8s/kubelet/K8s-kubelet(Cgroup%E8%B5%84%E6%BA%90%E9%9A%94%E7%A6%BB%E4%BB%A5%E5%8F%8A%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%8E%9F%E7%90%86)/" title="K8s-kubelet(Cgroup资源隔离以及垃圾回收原理)"><img class="cover" src="/img/k8sLogo.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-12-14</div><div class="info-item-2">K8s-kubelet(Cgroup资源隔离以及垃圾回收原理)</div></div><div class="info-2"><div class="info-item-1">K8s-kubelet(Cgroup资源隔离以及垃圾回收原理) 基于1.25  什么是Cgroup资源隔离kubelet基于cgroup限制Pod资源使用。cgroup是Linux内核的一个重要功能，用来限制、控制和分离一个进程组的资源（CPU、内存、磁盘I&#x2F;O） kubelet在创建Pod时，会将其配置的cgroups parent目录传递给容器运行时，使容器运行时创建的进程都会限制到kubelet配置父级cgroup之下。  kubelet负责维护Pod、QoS、Node级别的cgroup配置 Container级别的cgroup直接交给容器运行时实现  cgroup的层级结构 kubelet采用了四级cgroups层级架构存储  Node Level cgroup 为了保证系统运行的稳定性，kubelet支持为系统守护进程预留资源，避免Pod占用整个系统资源，造成系统卡死或者崩溃。  默认情况下，kube-reserved和system-reserved不会启用。 但是启用之后，需要注意守护进程添加了cgroup之后，可能导致配置的上限太小，导致守护进程资源不足退...</div></div></div></a><a class="pagination-related" href="/2024/12/13/cloud/k8s/kubelet/K8s-kubelet(Pod%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%AE%A1%E7%90%86)/" title="K8s-kubelet(Pod生命周期管理)"><img class="cover" src="/img/k8sLogo.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-12-13</div><div class="info-item-2">K8s-kubelet(Pod生命周期管理)</div></div><div class="info-2"><div class="info-item-1">K8s-kubelet(Pod生命周期管理) 基于1.25  kubelet以Pod为基本处理单元，负责Pod从创建到消亡的整个生命周期   在1.21中Unknown状态已经被标记为弃用。  CRIkubelet通过CRI RPC管理容器的生命周期，执行容器的lifecycle hook和 startup&#x2F;liveness&#x2F;readiness的健康检查，同时根据Pod的重启策略在容器失败退出后自动重启容器，CRI是kubelet管理Pod和容器的基础   Ref:https://github.com/kubernetes/cri-api/blob/2c8d015e0d408208ca8843c1d6e2e2fce1e5dd94/pkg/apis/runtime/v1/api.proto#L34 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717...</div></div></div></a><a class="pagination-related" href="/2024/12/12/cloud/k8s/kubelet/K8s-kubelet(Overview)/" title="K8s-kubelet(Overview)"><img class="cover" src="/img/k8sLogo.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-12-12</div><div class="info-item-2">K8s-kubelet(Overview)</div></div><div class="info-2"><div class="info-item-1">K8s-kubelet(Overview) 基于1.25  kubelet是K8s中最重要的节点代理程序，运行在集群的每个节点上。  能够自动将节点注册到集群 将节点上、Pod运行状态和资源使用情况周期性上报到控制平面 同时接受控制平面发送到工作任务、启动停止容器、维护管理Pod 也包含对cAdvusor资源用量监控、容器和镜像垃圾回收  kubelet架构设计kubelet整体架构采用了基于事件的处理模型，通过syncLoop和不断调谐Podtatus和PodSpec差距 PodSpec主要来源自三个来源，kube-apiserver、file和HTTP。  file和HTTP主要用于发现Static类型的Pod kubelet默认每隔20s执行一次检测   PodStatus实际状态主要是通过PLEG周期性扫描冗余运行时的运行状态获取。 PLEG每隔1s，从容器运行时获取Pod和Container信息，并于本地缓存进行对比，发生变更的时候，生成PLEG事件，并且发送给事件订阅者触发执行事件处理程序。  默认，当产生PLEG事件，kubelet会执行sync调谐 kubelet...</div></div></div></a><a class="pagination-related" href="/2025/03/15/cloud/k8s/job/K8sController-Job(%E6%89%B9%E5%A4%84%E7%90%86%E4%BB%BB%E5%8A%A1)/" title="K8sController-Job(批处理任务)"><img class="cover" src="/img/k8sLogo.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-03-15</div><div class="info-item-2">K8sController-Job(批处理任务)</div></div><div class="info-2"><div class="info-item-1">K8sController-Job(批处理任务) 基于K8s 1.31  主要配置和工作机制123456789101112131415161718192021222324252627282930313233343536apiVersion: batch/v1kind: Jobmetadata:  name: hellospec:  # 可以并行任务数量，默认1  parallelism: 3  completions: 3  # Pod完成模式，NonIndexed（数量达到completions推出，默认），Indexed  # Indexed模式：会被设置为Pod服务名  # - 设置Pod名称：&lt;Job Name&gt;-&lt;索引序号&gt;-&lt;随机字符串&gt;  # - 设置Annotation &quot;batch.kubernetes.io/job-completion-index&quot;: &lt;索引序号&gt;  # - 设置Label &quot;batch.kubernetes.io/job-completion-index&quot...</div></div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Joohwan.</div><div class="author-info-description">该知道的都知道，不知道的慢慢了解</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">259</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">76</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">60</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/piwriw"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/piwriw" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:piwriw@163.com" target="_blank" title="Email"><i class="fas fa-envelope-open-text"></i></a></div></div><div class="card-widget"><div class="item-headline"><i class="iconfont icat-visitor"></i><span>来访者</span></div><div class="item-content"><div id="welcome-info"></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#K8s-kubelet-Overview"><span class="toc-number">1.</span> <span class="toc-text">K8s-kubelet(Overview)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Cobra%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%8F%82%E6%95%B0%E8%A7%A3%E6%9E%90"><span class="toc-number">1.1.</span> <span class="toc-text">Cobra命令行参数解析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E7%8E%AF%E5%A2%83%E6%A3%80%E6%B5%8B%E4%B8%8E%E8%AE%BE%E7%BD%AE"><span class="toc-number">1.2.</span> <span class="toc-text">运行环境检测与设置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%B9%E8%B1%A1%E5%AE%9E%E4%BE%8B%E5%8C%96"><span class="toc-number">1.3.</span> <span class="toc-text">对象实例化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8kubelet%E4%B8%BB%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.4.</span> <span class="toc-text">启动kubelet主服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8HTTP-Server%E6%9C%8D%E5%8A%A1%E5%92%8CgPRC-Server%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.5.</span> <span class="toc-text">启动HTTP Server服务和gPRC Server服务</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2026/01/11/web/gorm/09-logger/" title="Gorm-日志系统模块原理说明"><img src="/img/go.png" onerror="this.onerror=null;this.src='/img/404.png'" alt="Gorm-日志系统模块原理说明"/></a><div class="content"><a class="title" href="/2026/01/11/web/gorm/09-logger/" title="Gorm-日志系统模块原理说明">Gorm-日志系统模块原理说明</a><time datetime="2026-01-11T11:56:27.000Z" title="发表于 2026-01-11 19:56:27">2026-01-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2026/01/11/web/gorm/08-migration/" title="Gorm-迁移功能模块原理说明"><img src="/img/go.png" onerror="this.onerror=null;this.src='/img/404.png'" alt="Gorm-迁移功能模块原理说明"/></a><div class="content"><a class="title" href="/2026/01/11/web/gorm/08-migration/" title="Gorm-迁移功能模块原理说明">Gorm-迁移功能模块原理说明</a><time datetime="2026-01-11T10:56:27.000Z" title="发表于 2026-01-11 18:56:27">2026-01-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2026/01/11/web/gorm/10-plugin/" title="Gorm-插件系统模块原理说明"><img src="/img/go.png" onerror="this.onerror=null;this.src='/img/404.png'" alt="Gorm-插件系统模块原理说明"/></a><div class="content"><a class="title" href="/2026/01/11/web/gorm/10-plugin/" title="Gorm-插件系统模块原理说明">Gorm-插件系统模块原理说明</a><time datetime="2026-01-11T10:56:27.000Z" title="发表于 2026-01-11 18:56:27">2026-01-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2026/01/11/web/gorm/07-transaction/" title="Gorm-事务处理模块原理说明"><img src="/img/go.png" onerror="this.onerror=null;this.src='/img/404.png'" alt="Gorm-事务处理模块原理说明"/></a><div class="content"><a class="title" href="/2026/01/11/web/gorm/07-transaction/" title="Gorm-事务处理模块原理说明">Gorm-事务处理模块原理说明</a><time datetime="2026-01-11T09:56:27.000Z" title="发表于 2026-01-11 17:56:27">2026-01-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2026/01/11/web/gorm/06-associations/" title="Gorm-关联关系模块原理说明"><img src="/img/go.png" onerror="this.onerror=null;this.src='/img/404.png'" alt="Gorm-关联关系模块原理说明"/></a><div class="content"><a class="title" href="/2026/01/11/web/gorm/06-associations/" title="Gorm-关联关系模块原理说明">Gorm-关联关系模块原理说明</a><time datetime="2026-01-11T08:56:27.000Z" title="发表于 2026-01-11 16:56:27">2026-01-11</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2023 - 2026 By Joohwan.</span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
  const option = null

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://piwriw-twikoo-git-main-piwriw.vercel.app/',
      region: 'ap-shanghai',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const init = (el = document, path = location.pathname) => {
    twikoo.init({
      el: el.querySelector('#twikoo-wrap'),
      envId: 'https://piwriw-twikoo-git-main-piwriw.vercel.app/',
      region: 'ap-shanghai',
      onCommentLoaded: () => {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      },
      ...option,
      path: isShuoshuo ? path : (option && option.path) || path
    })

    

    isShuoshuo && (window.shuoshuoComment.destroyTwikoo = () => {
      if (el.children.length) {
        el.innerHTML = ''
        el.classList.add('no-comment')
      }
    })
  }

  const loadTwikoo = (el, path) => {
    if (typeof twikoo === 'object') setTimeout(() => init(el, path), 0)
    else btf.getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(() => init(el, path))
  }

  if (isShuoshuo) {
    'Twikoo' === 'Twikoo'
      ? window.shuoshuoComment = { loadComment: loadTwikoo }
      : window.loadOtherComment = loadTwikoo
    return
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script></div><script src="/js/categories.js" defer></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>