<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>K8s安装-基于二进制文件（高可用） | Joohwan</title><meta name="author" content="Joohwan."><meta name="copyright" content="Joohwan."><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="K8s安装-基于二进制文件（高可用） 基于1.29  通过kubeadm可以快速搭建一个K8s集群，但是调整K8s集群参数，以及安全设置、高可用模式，就需要二进制安装 Master高可用部署架构Master高可用需要注意几个方面：  Master的kube-apiserver、kube-controller-manager和kube-schedule服务以多实例方式部署，至少有3个节点，节点需要为">
<meta property="og:type" content="article">
<meta property="og:title" content="K8s安装-基于二进制文件（高可用）">
<meta property="og:url" content="https://piwriw.github.io/2024/12/31/cloud/k8s/install/K8s%E5%AE%89%E8%A3%85-%E5%9F%BA%E4%BA%8E%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%87%E4%BB%B6(%E9%AB%98%E5%8F%AF%E7%94%A8)/index.html">
<meta property="og:site_name" content="Joohwan">
<meta property="og:description" content="K8s安装-基于二进制文件（高可用） 基于1.29  通过kubeadm可以快速搭建一个K8s集群，但是调整K8s集群参数，以及安全设置、高可用模式，就需要二进制安装 Master高可用部署架构Master高可用需要注意几个方面：  Master的kube-apiserver、kube-controller-manager和kube-schedule服务以多实例方式部署，至少有3个节点，节点需要为">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://piwriw.github.io/img/k8sLogo.png">
<meta property="article:published_time" content="2024-12-31T14:08:55.000Z">
<meta property="article:modified_time" content="2026-02-28T13:29:12.665Z">
<meta property="article:author" content="Joohwan.">
<meta property="article:tag" content="k8s">
<meta property="article:tag" content="cloud">
<meta property="article:tag" content="install">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://piwriw.github.io/img/k8sLogo.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "K8s安装-基于二进制文件（高可用）",
  "url": "https://piwriw.github.io/2024/12/31/cloud/k8s/install/K8s%E5%AE%89%E8%A3%85-%E5%9F%BA%E4%BA%8E%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%87%E4%BB%B6(%E9%AB%98%E5%8F%AF%E7%94%A8)/",
  "image": "https://piwriw.github.io/img/k8sLogo.png",
  "datePublished": "2024-12-31T14:08:55.000Z",
  "dateModified": "2026-02-28T13:29:12.665Z",
  "author": [
    {
      "@type": "Person",
      "name": "Joohwan.",
      "url": "https://github.com/Piwriw"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://piwriw.github.io/2024/12/31/cloud/k8s/install/K8s%E5%AE%89%E8%A3%85-%E5%9F%BA%E4%BA%8E%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%87%E4%BB%B6(%E9%AB%98%E5%8F%AF%E7%94%A8)/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'K8s安装-基于二进制文件（高可用）',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><script src="/js/welcome.js"></script><script src="https://npm.elemecdn.com/echarts@4.9.0/dist/echarts.min.js"></script><link rel="stylesheet" href="/css/categories.css"><link rel="stylesheet" href="/css/tabs.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">259</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">76</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">60</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/charts/"><i class="fa-fw fas fa-folder-open"></i><span> 文章统计</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div><div class="menus_item"><a class="site-page" href="/wish/"><i class="fa-fw fas fa-tags"></i><span> 许愿墙</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/k8sLogo.png);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Joohwan</span></a><a class="nav-page-title" href="/"><span class="site-name">K8s安装-基于二进制文件（高可用）</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/charts/"><i class="fa-fw fas fa-folder-open"></i><span> 文章统计</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div><div class="menus_item"><a class="site-page" href="/wish/"><i class="fa-fw fas fa-tags"></i><span> 许愿墙</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">K8s安装-基于二进制文件（高可用）</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-12-31T14:08:55.000Z" title="发表于 2024-12-31 22:08:55">2024-12-31</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2026-02-28T13:29:12.665Z" title="更新于 2026-02-28 21:29:12">2026-02-28</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud/">cloud</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud/k8s/">k8s</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud/k8s/install/">install</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">3.9k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>18分钟</span></span><span class="post-meta-separator">|</span><span id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="twikoo_visitors"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><div id="post-outdate-notice" data="{&quot;limitDay&quot;:365,&quot;messagePrev&quot;:&quot;It has been&quot;,&quot;messageNext&quot;:&quot;days since the last update, the content of the article may be outdated.&quot;,&quot;postUpdate&quot;:&quot;2026-02-28 21:29:12&quot;}" hidden></div><h1 id="K8s安装-基于二进制文件（高可用）"><a href="#K8s安装-基于二进制文件（高可用）" class="headerlink" title="K8s安装-基于二进制文件（高可用）"></a>K8s安装-基于二进制文件（高可用）</h1><blockquote>
<p>基于1.29</p>
</blockquote>
<p>通过kubeadm可以快速搭建一个K8s集群，但是调整K8s集群参数，以及安全设置、高可用模式，就需要二进制安装</p>
<h2 id="Master高可用部署架构"><a href="#Master高可用部署架构" class="headerlink" title="Master高可用部署架构"></a>Master高可用部署架构</h2><p>Master高可用需要注意几个方面：</p>
<ul>
<li>Master的kube-apiserver、kube-controller-manager和kube-schedule服务以多实例方式部署，至少有3个节点，节点需要为奇数，至少3个节点</li>
<li>Master启用基于CA认证的HTTPS安全机制</li>
<li>etcd至少有3个节点的集群部署模式</li>
<li>etcd集群启用了基于CA认证的HTTPS安全机制</li>
<li>Master启用了RBAC授权模式</li>
</ul>
<p><img src="https://raw.githubusercontent.com/Piwriw/PicGo/master/image202412302108990.png"></p>
<h2 id="创建CA根证书"><a href="#创建CA根证书" class="headerlink" title="创建CA根证书"></a>创建CA根证书</h2><p>为了启用etcd和K8s服务基于CA认证的安全机制，首先需要配置CA证书</p>
<ul>
<li>etcd和K8s制作CA证书的时候，都需要基于CA根证书</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa -out ca.key 2048</span><br><span class="line">openssl req -x 509 -new -nodes -key ca.key -subj &quot;/CN=192.168.18.3&quot; -days 36500 -out ca.crt</span><br></pre></td></tr></table></figure>

<ul>
<li><code>-subj</code>：”&#x2F;CN”&#x3D;CA机构的名称、格式为域名或者IP</li>
<li><code>-days</code>:设置证书有效时间（天）</li>
</ul>
<h2 id="部署安全的etcd高可用集群"><a href="#部署安全的etcd高可用集群" class="headerlink" title="部署安全的etcd高可用集群"></a>部署安全的etcd高可用集群</h2><ol>
<li><p>etcd下载二进制文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/etcd-io/etcd/releases/download/v3.4.35/etcd-v3.4.35-linux-amd64.tar.gz</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">把其中的etcd和etcdctl 文件放到/usr/bin/</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>部署一个etcd的systemd文件</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=etcd key-value store</span><br><span class="line"><span class="attr">Documentation</span>=https://etcd.io/docs/</span><br><span class="line"><span class="attr">After</span>=network.target</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">EnvironmentFile</span>=/etc/etcd/etcd.conf</span><br><span class="line"><span class="attr">ExecStart</span>=/usr/local/bin/etcd </span><br><span class="line"></span><br><span class="line"><span class="attr">Restart</span>=always</span><br><span class="line"><span class="attr">RestartSec</span>=<span class="number">5</span></span><br><span class="line"><span class="attr">LimitNOFILE</span>=<span class="number">65536</span></span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建etcd的CA证书</p>
<ol>
<li>创建一个x509 v3的配置文件etcd_ssl.conf,其中subjectName参数（alt_names)包含所有的etcd主机的IP地址</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[ req ]</span><br><span class="line">distinguished_name = req_distinguished_name</span><br><span class="line">x509_extensions    = v3_req</span><br><span class="line"></span><br><span class="line">[ req_distinguished_name ]</span><br><span class="line"></span><br><span class="line">[ v3_req ]</span><br><span class="line">basicConstrains = CA:FALSE</span><br><span class="line">keyUsage = nonRepudiation ,  digitalSignature, keyEncipherment</span><br><span class="line">subjectAltName = @alt_names</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[ alt_names ]</span><br><span class="line">IP.1 = 192.168.1.1</span><br><span class="line">IP.2 = 192.168.1.2</span><br><span class="line">IP.3 = 192.168.1.3</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>创建etcd服务端的CA证书</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa -out etcd_server.key 2048</span><br><span class="line">openssl req -new -key etcd_server.key -config etcd_ssl.conf -subj &quot;/CN=etcd-server&quot; -out etcd_server.csr</span><br><span class="line">openssl x509 -req -in etcd_server.csr -CA /etc/kubernetes/pki/ca.crt -CAkey /etc/kubernetes/pki/ca.key -CAcreateserial -days 36500 -extensions v3_req -extfile etcd_ssl.conf -out etcd_server.crt</span><br></pre></td></tr></table></figure>

<ol start="3">
<li><p>创建客户端的CA证书，包含etcd_client.key和etcd_client.crt，也要保存到&#x2F;etc&#x2F;etcd&#x2F;pki目录</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa -out etcd_client.key 2048</span><br><span class="line">openssl req -new -key etcd_client.key -config etcd_ssl.conf -subj &quot;/CN=etcd-client&quot; -out etcd_client.csr</span><br><span class="line">openssl x509 -req -in etcd_client.csr -CA /etc/kubernetes/pki/ca.crt -CAkey /etc/kubernetes/pki/ca.key -CAcreateserial -days 36500 -extensions v3_req -extfile etcd_ssl.conf -out etcd_client.crt</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
<li><p>对etcd参数的说明</p>
<p>etcd节点的配置方式包含：启动参数、环境变量、配置文件，下面通过环境变量方式配置到<code>/etc/etcd/etcd.conf</code>中，提供给systemd使用</p>
<p>3个etcd节点为：192.168.18.3、192.168.18.4、192.168.18.5</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"># /etc/etcd/etcd.conf</span><br><span class="line"></span><br><span class="line"># 节点1</span><br><span class="line"># 节点名称</span><br><span class="line">ETCD_NAME=etcd1</span><br><span class="line"># etcd数据存储目录</span><br><span class="line">ETCD_DATA_DIR=/etc/etcd/data</span><br><span class="line"></span><br><span class="line"># etcd服务端CA证书路径</span><br><span class="line">ETCD_CERT_FILE=/etc/etcd/pki/etcd_server.crt</span><br><span class="line">ETCD_KEY_FILE=etc/etcd/pki/etcd_server.key</span><br><span class="line"># CA根证书路径</span><br><span class="line">ETCD_TRUSTED_CA_FILE=/etc/etcd/pki/ca.crt</span><br><span class="line"># 是否启用客户端证书认证</span><br><span class="line">ETCD_CLIENT_CERT_AUTH=true</span><br><span class="line"># 为客户端提供的监听地址</span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=https://192.168.18.3:2379</span><br><span class="line">ETCD_ADVERTISE_CLIENT_URL=https://192.168.18.3:2379</span><br><span class="line"></span><br><span class="line"># 集群各个节点互认的证书全路径</span><br><span class="line">ETCD_PEER_CERT_FILE=/etc/etcd/pki/etcd_server.crt</span><br><span class="line">ETCD_PERR_KEY_FILE=etc/etcd/pki/etcd_server.key</span><br><span class="line"># 集群各个节点的根证书路径</span><br><span class="line">ETCD_PEER_TRUSTED_CA_FILE=/etc/etcd/pki/ca.crt</span><br><span class="line"># 为本集群其他节点提供的服务监听地址</span><br><span class="line">ETCD_LISTEN_PEER_CLIENT_URLS=https://192.168.18.3:2379</span><br><span class="line">ETCD_ADVERTISE_PEE_CLIENT_URL=https://192.168.18.3:2379</span><br><span class="line"></span><br><span class="line"># 集群名称</span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=etcd-cluster</span><br><span class="line"># 集群其他节点</span><br><span class="line">ETCD_INITAL_CLUSTER=&quot;etcd1=https://192.168.18.3:2380,etcd2=https://192.168.18.4:2380,etcd4=https://192.168.18.5:2380&quot;</span><br><span class="line"># 初始化集群状态，新建的new，已经存在设置为existing</span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=new</span><br><span class="line"></span><br><span class="line"># 节点2</span><br><span class="line">ETCD_NAME=etcd2</span><br><span class="line">ETCD_DATA_DIR=/etc/etcd/data</span><br><span class="line"></span><br><span class="line">ETCD_CERT_FILE=/etc/etcd/pki/etcd_server.crt</span><br><span class="line">ETCD_KEY_FILE=etc/etcd/pki/etcd_server.key</span><br><span class="line">ETCD_TRUSTED_CA_FILE=/etc/etcd/pki/ca.crt</span><br><span class="line">ETCD_CLIENT_CERT_AUTH=true</span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=https://192.168.18.4:2379</span><br><span class="line">ETCD_ADVERTISE_CLIENT_URL=https://192.168.18.4:2379</span><br><span class="line"></span><br><span class="line">ETCD_PEER_CERT_FILE=/etc/etcd/pki/etcd_server.crt</span><br><span class="line">ETCD_PERR_KEY_FILE=etc/etcd/pki/etcd_server.key</span><br><span class="line">ETCD_PEER_TRUSTED_CA_FILE=/etc/etcd/pki/ca.crt</span><br><span class="line">ETCD_LISTEN_PEER_CLIENT_URLS=https://192.168.18.4:2379</span><br><span class="line">ETCD_ADVERTISE_PEE_CLIENT_URL=https://192.168.18.4:2379</span><br><span class="line"></span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=etcd-cluster</span><br><span class="line">ETCD_INITAL_CLUSTER=&quot;etcd1=https://192.168.18.3:2380,etcd2=https://192.168.18.4:2380,etcd4=https://192.168.18.5:2380&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=new</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 节点3</span><br><span class="line">ETCD_NAME=etcd3</span><br><span class="line">ETCD_DATA_DIR=/etc/etcd/data</span><br><span class="line"></span><br><span class="line">ETCD_CERT_FILE=/etc/etcd/pki/etcd_server.crt</span><br><span class="line">ETCD_KEY_FILE=etc/etcd/pki/etcd_server.key</span><br><span class="line">ETCD_TRUSTED_CA_FILE=/etc/etcd/pki/ca.crt</span><br><span class="line">ETCD_CLIENT_CERT_AUTH=true</span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=https://192.168.18.5:2379</span><br><span class="line">ETCD_ADVERTISE_CLIENT_URL=https://192.168.18.5:2379</span><br><span class="line"></span><br><span class="line">ETCD_PEER_CERT_FILE=/etc/etcd/pki/etcd_server.crt</span><br><span class="line">ETCD_PERR_KEY_FILE=etc/etcd/pki/etcd_server.key</span><br><span class="line">ETCD_PEER_TRUSTED_CA_FILE=/etc/etcd/pki/ca.crt</span><br><span class="line">ETCD_LISTEN_PEER_CLIENT_URLS=https://192.168.18.5:2379</span><br><span class="line">ETCD_ADVERTISE_PEE_CLIENT_URL=https://192.168.18.5:2379</span><br><span class="line"></span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=etcd-cluster</span><br><span class="line">ETCD_INITAL_CLUSTER=&quot;etcd1=https://192.168.18.3:2380,etcd2=https://192.168.18.4:2380,etcd4=https://192.168.18.5:2380&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=new</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动etcd集群</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart etcd &amp;&amp; systemctl enable etcd</span><br></pre></td></tr></table></figure>
</li>
<li><p>验证etcd集群状态监控</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">通过etcd自动的etcdctl工具可以验证集群是否都在helahty 健康</span></span><br><span class="line">etcdctl --cacert=/etc/etcd/pki/ca.crt --cert=/etc/etcd/pki/etcd_client.crt --key= /etc/etcd/pki/etcd_client.key --endpoints=https://192.168.18.3:2379,https://192.168.18.3:2379,https://192.168.18.5:2379</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="部署安全的K8s-Master高可用集群"><a href="#部署安全的K8s-Master高可用集群" class="headerlink" title="部署安全的K8s Master高可用集群"></a>部署安全的K8s Master高可用集群</h2><h3 id="下载K8s的服务二进制文件"><a href="#下载K8s的服务二进制文件" class="headerlink" title="下载K8s的服务二进制文件"></a>下载K8s的服务二进制文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://dl.k8s.io/v1.29.3/kubernetes-server-linux-amd64.tar.gz</span><br><span class="line">wget https://dl.k8s.io/v1.29.3/kubernetes-node-linux-amd64.tar.gz`</span><br></pre></td></tr></table></figure>
<p>主要的服务端程序的二进制文件列表</p>
<table>
<thead>
<tr>
<th align="center">文件名</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">kube-apiserver</td>
<td align="center">kube-apiserver主程序</td>
</tr>
<tr>
<td align="center">kube-apiserver.docker_tag</td>
<td align="center">kube-apiserver docker镜像tag</td>
</tr>
<tr>
<td align="center">kube-apiserver.tar</td>
<td align="center">kube-apiserver docker镜像文件</td>
</tr>
<tr>
<td align="center">kube-controller-manager</td>
<td align="center">kube-controller-manager主程序</td>
</tr>
<tr>
<td align="center">kube-controller-manager.docker tag</td>
<td align="center">kube-controller-manager docker镜像tag</td>
</tr>
<tr>
<td align="center">kube-controller-manager.tar</td>
<td align="center">kube-controller-manager docker镜像</td>
</tr>
<tr>
<td align="center">kube-schedule</td>
<td align="center">kube-schedule主程序</td>
</tr>
<tr>
<td align="center">kube-schedule.docker tag</td>
<td align="center">kube-schedule docker镜像tag</td>
</tr>
<tr>
<td align="center">kube-schedule.tar</td>
<td align="center">kube-schedule docker镜像</td>
</tr>
<tr>
<td align="center">kubelet</td>
<td align="center">kubelet主程序</td>
</tr>
<tr>
<td align="center">kube-proxy</td>
<td align="center">kube-proxy 主程序</td>
</tr>
<tr>
<td align="center">kube-proxy.docker tag</td>
<td align="center">kube-proxy 镜像tag</td>
</tr>
<tr>
<td align="center">kube-proxy.tar</td>
<td align="center">kube-proxy docker镜像文件</td>
</tr>
<tr>
<td align="center">kubectl</td>
<td align="center">客户端命令行工具</td>
</tr>
<tr>
<td align="center">kubeadm</td>
<td align="center">用于安装K8s集群的命令行工具</td>
</tr>
<tr>
<td align="center">apiextensions-apiserver</td>
<td align="center">提供实现自定义资源对象的拓展API Server</td>
</tr>
<tr>
<td align="center">kube-aggregator</td>
<td align="center">聚合APIServer程序</td>
</tr>
</tbody></table>
<p>把K8s的可执行文件放到&#x2F;usr&#x2F;bin目录下，然后&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system目录下为各种服务创建systemd服务的配置文件</p>
<h3 id="部署kube-apiserver服务"><a href="#部署kube-apiserver服务" class="headerlink" title="部署kube-apiserver服务"></a>部署kube-apiserver服务</h3><ol>
<li><p>设置kube-apiserver服务需要的CA相关证书</p>
<p>准备一个x509 v3版本的配置文件master_ssl.conf</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[ req ]</span></span><br><span class="line"><span class="attr">distinguished_name</span> = req_distinguished_name</span><br><span class="line"><span class="attr">req_extensions</span>    = v3_req</span><br><span class="line"></span><br><span class="line"><span class="section">[ req_distinguished_name ]</span></span><br><span class="line"></span><br><span class="line"><span class="section">[ v3_req ]</span></span><br><span class="line"><span class="attr">basicConstrains</span> = CA:<span class="literal">FALSE</span></span><br><span class="line"><span class="attr">keyUsage</span> = nonRepudiation ,  digitalSignature, keyEncipherment</span><br><span class="line"><span class="attr">subjectAltName</span> = @alt_names</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">[ alt_names ]</span></span><br><span class="line"><span class="attr">DNS.1</span> = kubernetes</span><br><span class="line"><span class="attr">DNS.2</span> = kubernetes.default</span><br><span class="line"><span class="attr">DNS.3</span> = kubernetes.default.svc</span><br><span class="line"><span class="attr">DNS.4</span> = kubernetes.default.svc.cluster.local</span><br><span class="line"><span class="attr">DNS.5</span> = k8s-<span class="number">1</span></span><br><span class="line"><span class="attr">DNS.6</span> = k8s-<span class="number">2</span></span><br><span class="line"><span class="attr">DNS.7</span> = k8s-<span class="number">3</span></span><br><span class="line"><span class="attr">IP.1</span> = <span class="number">192.168</span>.<span class="number">1.1</span></span><br><span class="line"><span class="attr">IP.2</span> = <span class="number">192.168</span>.<span class="number">1.2</span></span><br><span class="line"><span class="attr">IP.3</span> = <span class="number">192.168</span>.<span class="number">1.3</span></span><br><span class="line"><span class="attr">IP.4</span> = <span class="number">192.168</span>.<span class="number">1.4</span></span><br><span class="line"><span class="attr">IP.5</span> = <span class="number">192.168</span>.<span class="number">1.5</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>通过openssl命令创建kube-apiserver的服务端证书CA证书，包括apiserver.key 和apiserver.crt文件，将其保存到&#x2F;etc&#x2F;kubernetes&#x2F;pki目录下</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa -out apiserver.key 2048</span><br><span class="line">openssl req -new -key apiserver.key -config etcd_ssl.conf -subj &quot;/CN=192.168.1.1&quot; -out apiserver.csr</span><br><span class="line">openssl x509 -req -in apiserver.csr -CA /etc/kubernetes/pki/ca.crt -CAkey /etc/kubernetes/pki/ca.key -CAcreateserial -days 36500 -extensions v3_req -extfile master_ssl.conf -out apiserver.crt</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>为kube-apiserver服务创建systemd服务配置文件&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;kube-apiserver.service，在该环境文件中，EnvironmentFile参数指定<code>/etc/kubernetes/apiserver</code>作为环境文件，其中通过环境变量KUBE-API-ARGS设置kube-apiserver的启动参数</li>
</ol>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=Kubernetes API Server</span><br><span class="line"><span class="attr">Documentation</span>=https://kubernetes.io/zh-cn/docs/home/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">EnvironmentFile</span>=/etc/kubernetes/apiserver</span><br><span class="line"><span class="attr">ExecStart</span>=/usr/bin/kube-apiserver <span class="variable">$KUBE_API_ARGS</span></span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>在环境文件<code>/etc/kubernetes/apiserver</code>，配置变量KUBE_API_ARGS的值为kube-apiserver的全部启动参数</li>
</ol>
<ul>
<li>–secure-port:HTTPS端口号，默认值6443</li>
<li>–tls-cert-file：服务端CA证书全路径</li>
<li>–tls-private-key-file：服务端CA私钥文件</li>
<li>–client-ca-file:CA根证书路径</li>
<li>–apiserver-count：API Server实例的数量，同时需要设置参数–endpoint-reconcile-type&#x3D;master-count</li>
<li>–etcd-servers：连接etcd的URL列表</li>
<li>–etcd-cafile：etcd使用的CA根证书路径</li>
<li>–etcd-certfile：etcd客户端CA证书</li>
<li>–etcd-keyfile：etcd客户端私钥文件路径</li>
<li>–service-cluster-ip-range：Service虚拟IP地址范围，以CIDR格式表示</li>
<li>–service-node-port-range：Serice可用端口范围</li>
<li>–allow-privileged：是否允许容器以特权模式运行，默认值true</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">KUBE_API_ARGS=&quot;--secure-port=6443 \</span><br><span class="line">--tls-cert-file=/etc/kubernetes/pki/apiserver.crt \</span><br><span class="line">--tls-private-key-file=/etc/kubernetes/pki/apiserver.key \</span><br><span class="line">--client-ca-file=/etc/kubernetes/pki/ca.crt \</span><br><span class="line">--apiserver-count=3 --endpoint-reconcile-type=master-count \</span><br><span class="line">--etcd-servers=https://192.168.1.3:2379,https://192.168.1.4:2379,https://192.168.1.5:2379 \</span><br><span class="line">--etcd-cafile=/etc/kubernetes/pki/etcd/ca.crt \</span><br><span class="line">--etcd-certfile=/etc/kubernetes/pki/apiserver-etcd-client.crt \</span><br><span class="line">--etcd-keyfile=/etc/kubernetes/pki/apiserver-etcd-client.key \</span><br><span class="line">--service-cluster-ip-range=10.96.0.0/12 \</span><br><span class="line">--service-node-port-range=30000-32767 \</span><br><span class="line">--allow-privileged=true&quot;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li><p>在配置文件准备好之后，在3台主机启动kube-apiserver服务，设置为开机自启动</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start kube-apiserver &amp;&amp; systemctl enable kube-apiserver</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
</ol>
<h3 id="创建客户端CA证书"><a href="#创建客户端CA证书" class="headerlink" title="创建客户端CA证书"></a>创建客户端CA证书</h3><p>kube-controller-manager、kube-schedule、kubelet和kube-proxy服务作为客户端连接kube-apiserver服务，需要为它们创建客户端CA证书，使其能正确访问kube-apiserver</p>
<ol>
<li><p>通过openssl命令创建CA证书和私钥文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa -out client.key 2048</span><br><span class="line">openssl req -new -key client.key -config etcd_ssl.conf -subj &quot;/CN=admin&quot; -out client.csr</span><br><span class="line">openssl x509 -req -in client.csr -CA ca.crt -CAkey ca.key -CAcreateserial -days 36500  -out client.crt</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>将生成的client.key和client.crt文件保存到&#x2F;etc&#x2F;kubernetes&#x2F;pki目录下</li>
</ol>
</li>
</ol>
<h3 id="创建客户端连接kube-apiserver服务所需要kubeconfig配置文件"><a href="#创建客户端连接kube-apiserver服务所需要kubeconfig配置文件" class="headerlink" title="创建客户端连接kube-apiserver服务所需要kubeconfig配置文件"></a>创建客户端连接kube-apiserver服务所需要kubeconfig配置文件</h3><p>为kube-controller-manager、kube- schedule、kubelet和kube-proxy统一创建kubeconfig，保存到&#x2F;etc&#x2F;kubernetes目录下</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Config</span></span><br><span class="line"><span class="attr">clusters:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">cluster:</span></span><br><span class="line">  <span class="comment"># 负载均衡器的虚拟IP地址</span></span><br><span class="line">    <span class="attr">server:</span> <span class="string">https://192.168.1.1:6443</span></span><br><span class="line">    <span class="comment"># CA根证书文件</span></span><br><span class="line">    <span class="attr">certificate-authority:</span> <span class="string">/etc/kubernetes/pki/ca.crt</span></span><br><span class="line"><span class="attr">users:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">admin</span></span><br><span class="line">  <span class="attr">user:</span></span><br><span class="line">    <span class="attr">client-certificate:</span> <span class="string">/etc/kubernetes/pki/client.crt</span></span><br><span class="line">    <span class="attr">client-key:</span> <span class="string">/etc/kubernetes/pki/client.key</span></span><br><span class="line"><span class="attr">contexts:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">context:</span></span><br><span class="line">    <span class="attr">cluster:</span> <span class="string">default</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">admin</span></span><br><span class="line"><span class="attr">current-context:</span> <span class="string">example-context</span></span><br></pre></td></tr></table></figure>

<h3 id="部署kube-controller-manage服务"><a href="#部署kube-controller-manage服务" class="headerlink" title="部署kube-controller- manage服务"></a>部署kube-controller- manage服务</h3><ol>
<li><p>为kube-controller-manager服务创建systemd服务的配置文件&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;kube-controller-manager.service，其中EnvironmentFile参数指定&#x2F;etc&#x2F;kubernetes&#x2F;controller-manager文件作为环境文件，在该环境变量中通过KUBE_CONTROLLER_MANAGER_ARGS设置kube-controller-manager启动参数</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=Kubernetes Controller Manager</span><br><span class="line"><span class="attr">Documentation</span>=https://kubernetes.io/zh-cn/docs/home/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">EnvironmentFile</span>=/etc/kubernetes/controller-manager</span><br><span class="line"><span class="attr">ExecStart</span>=/usr/bin/kube-controller-manager <span class="variable">$KUBE_CONTROLLER_MANAGER_ARGS</span></span><br><span class="line"><span class="attr">Restart</span>=always</span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure>
</li>
<li><p>在环境文件<code>/etc/kubernetes/controller-manager</code>中，配置KUBE_CONTROLLER_MANAGER_ARGS全部启动参数</p>
<ul>
<li>–kubeconfig:与API Server连接的相关配置</li>
<li>–leader-elect：启用选举机制，在有3个节点下一个设置为true</li>
<li>–service-account-private-key-file：为SA自动颁发token使用的私钥文件路径</li>
<li>–root-ca-file：Service的虚拟IP地址范围</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">KUBE_CONTROLLER_MANAGER_ARGS=&quot;--kubeconfig=/etc/kubernetes/kubeconfig \</span><br><span class="line">--leader-elect=true \</span><br><span class="line">--service-cluster-ip-range=10.96.0.0/12 \</span><br><span class="line">--service-account-private-key-file=/etc/kubernetes/pki/apiserver.key \</span><br><span class="line">--root-ca-file=/etc/kubernetes/pki/ca.crt&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在配置文件准备完毕后，在三台主机上启动kube-controller-manager</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start kube-controller-manager &amp;&amp; systemctl enable kube-controller-manager </span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="部署kube-schduler服务"><a href="#部署kube-schduler服务" class="headerlink" title="部署kube-schduler服务"></a>部署kube-schduler服务</h3><ol>
<li><p>创建kube-scheduler的systemd的配置文件&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;kube-scheduler.service，其中Env文件制定到&#x2F;etc&#x2F;kubernetes&#x2F;scheduler,通过KUBE_SCHEDULER_ARGS设置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># kube-scheduler.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kube Scheduler</span><br><span class="line">Documentation=https://kubernetes.io/zh-cn/docs/home/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=/etc/kubernetes/scheduler</span><br><span class="line">ExecStart=/usr/bin/kube-scheduler $KUBE_SCHEDULER_ARGS</span><br><span class="line">Restart=always</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>
</li>
<li><p>环境配置文件<code>/etc/kubernetes/scheduler</code></p>
<ul>
<li>–kubeconfig:API Server连接的信息</li>
<li>–leader-elect&#x3D;true：启用选举机制</li>
</ul>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">KUBE_SCHEDULER_ARGS</span>=<span class="string">&quot;--kubeconfig=/etc/kubernetes/kubeconfig \</span></span><br><span class="line"><span class="string">--leader-elect=true&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在三个节点上启动kube-scheduler服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start kube-scheduler &amp;&amp; systemctl enable  kube-scheduler</span><br></pre></td></tr></table></figure>
</li>
<li><p>验证服务状态</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl status kube-sheduler</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="使用HAPorxy和keepalived部署高可用负载均衡器"><a href="#使用HAPorxy和keepalived部署高可用负载均衡器" class="headerlink" title="使用HAPorxy和keepalived部署高可用负载均衡器"></a>使用HAPorxy和keepalived部署高可用负载均衡器</h3><p>在3个kube-apiserver部署的前端部署HAProxy和keepliaved，将虚拟IP地址192.168.x.x作为Master的唯一入口，提供为客户端访问</p>
<ul>
<li>HAPorxy和keepalived部署都应该大于2，防止单点故障</li>
</ul>
<p><img src="https://raw.githubusercontent.com/Piwriw/PicGo/master/image202501011356769.png"></p>
<h4 id="部署HAProxy"><a href="#部署HAProxy" class="headerlink" title="部署HAProxy"></a>部署HAProxy</h4><p>准备HAProxy的配置文件haproxy.cfg文件</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 全局配置</span></span><br><span class="line">global</span><br><span class="line">    log 127.0.0.1 local2</span><br><span class="line">    chroot /var/lib/haproxy</span><br><span class="line">    pidfile /var/run/haproxy.pid</span><br><span class="line">    maxconn 4096</span><br><span class="line">    user haproxy</span><br><span class="line">    group haproxy</span><br><span class="line">    daemon</span><br><span class="line">    stats socket /var/lib/harproxy/stats</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 默认配置</span></span><br><span class="line">defaults</span><br><span class="line">		mode http</span><br><span class="line">    log global</span><br><span class="line">    option httplog</span><br><span class="line">    option dontlognull</span><br><span class="line">    option http-server-close</span><br><span class="line">    option forwardfor except 127.0.0.0/8</span><br><span class="line">    option redispatch</span><br><span class="line">    option 3</span><br><span class="line">    retries 10s</span><br><span class="line">    timeout http-request 10s</span><br><span class="line">    timeout queue 1m</span><br><span class="line">    timeout connect 10s</span><br><span class="line">    timeout client 1m</span><br><span class="line">    timeout server 1m</span><br><span class="line">    timeout http-keep-alive 10s</span><br><span class="line">    timeout check 10s</span><br><span class="line">    maxconn 3000</span><br><span class="line"></span><br><span class="line"><span class="comment"># 前端配置：HAProxy的监听协议和地址，使用TCP，9443</span></span><br><span class="line">frontend kube_apiserver</span><br><span class="line">    bind *:9443</span><br><span class="line">    mode tcp</span><br><span class="line">    option tcplog</span><br><span class="line">    default_backend kube_apiserver</span><br><span class="line"></span><br><span class="line"><span class="comment"># 后端配置：转发请求到 Kubernetes 服务</span></span><br><span class="line">backend kube_apiserver</span><br><span class="line">    mode tcp</span><br><span class="line">    balance roundrobin</span><br><span class="line">    server k8s-master1 192.168.1.101:6443 check</span><br><span class="line">    server k8s-master2 192.168.1.102:6443 check</span><br><span class="line">    server k8s-master3 192.168.1.103:6443 check</span><br><span class="line"></span><br><span class="line"><span class="comment"># 状态健康的服务【诶值</span></span><br><span class="line">listen stats</span><br><span class="line">		mode http</span><br><span class="line">    bind *:8888</span><br><span class="line">    stats auth admin:password</span><br><span class="line">    stats refresh 5s</span><br><span class="line">    stats realm HAProxy\ Statistics</span><br><span class="line">    stats url /stats</span><br><span class="line">    log 127.0.0.1 local3 err</span><br></pre></td></tr></table></figure>

<p>使用Docker运行HAProxy镜像,通过http:hostip:8888&#x2F;status可以访问HAProxy的管理界面</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name k8s-haporxy \</span><br><span class="line">--net-host \</span><br><span class="line">--restart=always \</span><br><span class="line">-v $&#123;PWD&#125;/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro \</span><br><span class="line">harproxytech/haproxy-debian:2.3</span><br></pre></td></tr></table></figure>

<h4 id="部署keepalived"><a href="#部署keepalived" class="headerlink" title="部署keepalived"></a>部署keepalived</h4><p>keepalived用于维护虚拟IP地址的高可用，都需要部署在节点</p>
<ul>
<li><p>当某个HAProxy实例不可用，虚拟IP会切换到另外一台主机上</p>
<p>Keepavlied.conf配置如下</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">! Configuration File for Keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line"> 	router_id LVS_1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置keepalived 虚拟机路由器组的名称</span></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line"><span class="comment"># 其他的设置为BACKUP</span></span><br><span class="line">    state MASTER</span><br><span class="line">    <span class="comment"># 设置虚拟网卡的名称</span></span><br><span class="line">    interface eth33</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    <span class="comment"># 优先级</span></span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    <span class="comment"># 访问keepalied服务鉴权信息</span></span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass password</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"># 虚拟IP地址</span></span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.1.100/24 dev ens33</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"># HAProxy的健康检查脚本</span></span><br><span class="line">    track_script &#123;</span><br><span class="line">        check_haproxy</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>check_haproxy.sh需要保存到&#x2F;usr&#x2F;bin命令下</p>
<ul>
<li>检查成功返回0，不然返回非0</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">! /bin/bash</span></span><br><span class="line"></span><br><span class="line">count=`netstat -apn |grep 9443 |wc -l`</span><br><span class="line">if [ $count -gt 0 ]; then</span><br><span class="line">	exit 0</span><br><span class="line">else </span><br><span class="line">	exit 1</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<p>第二台主机的keepalived.conf如下</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">! Configuration File for Keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line"> 	router_id LVS_1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script checkharoxy</span><br><span class="line">&#123;</span><br><span class="line"> 		script &quot;/usr/bin/check-haproxy.sh&quot;</span><br><span class="line"> 		interval 2</span><br><span class="line"> 		weight -30</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置keepalived 虚拟机路由器组的名称,和MASTER设置一样</span></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line"><span class="comment"># 其他的设置为BACKUP</span></span><br><span class="line">    state BACKUP</span><br><span class="line">    <span class="comment"># 设置虚拟网卡的名称</span></span><br><span class="line">    interface eth33</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    <span class="comment"># 优先级</span></span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    <span class="comment"># 访问keepalied服务鉴权信息</span></span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass password</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"># 虚拟IP地址</span></span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.1.100/24 dev ens33</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"># HAProxy的健康检查脚本</span></span><br><span class="line">    track_script &#123;</span><br><span class="line">        check_haproxy</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Docker部署启动keepalived</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name k8s-keepaviled \</span><br><span class="line">--restart=always \</span><br><span class="line">--net=host \</span><br><span class="line">--cap-add=NET_ADMIN --cap-add=NET_BPOADCAST --cap-add=NET_RAW \</span><br><span class="line">-v $&#123;PWD&#125;/keepavlied.conf:/container/service/keepalived/assents/keepalived.conf \</span><br><span class="line">-v $&#123;PWD&#125;/check-haproxy.sh:/usr/bin/check-harproxy.sh \</span><br><span class="line">osixia/keepavlived:2.0.20 --copy-service</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">通过ip addr可以查看ens33网卡上新增的虚拟IP地址</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">通过curl可以验证HAProxy是否可以访问kube-apiserver</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="部署各个Node的服务"><a href="#部署各个Node的服务" class="headerlink" title="部署各个Node的服务"></a>部署各个Node的服务</h2><p>在Node上部署需要容器运行时、kubelet和kube-proxy等系统组件</p>
<h3 id="容器运行时"><a href="#容器运行时" class="headerlink" title="容器运行时"></a>容器运行时</h3><p>包含contained、cri-o</p>
<p>…</p>
<h3 id="部署kubelet"><a href="#部署kubelet" class="headerlink" title="部署kubelet"></a>部署kubelet</h3><ol>
<li>为kubelet服务创建systemd服务的配置文件&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;kubelet.service</li>
</ol>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=Kubernetes Kubelet Server</span><br><span class="line"><span class="attr">Documentation</span>=https://kubernetes.io/zh-cn/docs/home/</span><br><span class="line"><span class="attr">After</span>=docker.target</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">EnvironmentFile</span>=/etc/kubernetes/kubelet</span><br><span class="line"><span class="attr">ExecStart</span>=/usr/bin/kubelet <span class="variable">$KUBELET_ARGS</span></span><br><span class="line"><span class="attr">Restart</span>=always</span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p>配置文件&#x2F;etc&#x2F;kubernetes&#x2F;kubelet内容通过环境变量KUBELET_ARGS，设置kubelet的启动参数</p>
<ul>
<li>–kubeconfig:设置kube-apiserver的访问，需要把master的相关证书放到&#x2F;etc&#x2F;kubernetes&#x2F;pki目录下，比如ca.crt、ca.key、client.crt等文件</li>
<li>–config:kubelet配置文件</li>
<li>–hostname-overide：设置本Node到集群中的名称，默认主机名</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">KUBELET_ARGS=&quot;--kubeconfig=/etc/kubernetes/kubeconfig \ </span><br><span class="line">--config=/etc/kubernetes/kubelet.config \</span><br><span class="line">--hostname-overide=192.168.18.3&quot;</span><br></pre></td></tr></table></figure>

<p>kubelet.config示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubelet.config.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KubeletConfiguration</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 基本设置</span></span><br><span class="line"><span class="attr">address:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>                     <span class="comment"># kubelet监听的IP地址</span></span><br><span class="line"><span class="attr">port:</span> <span class="number">10250</span>                         <span class="comment"># kubelet API服务的端口</span></span><br><span class="line"><span class="comment"># Cgroup 设置</span></span><br><span class="line"><span class="attr">cgroupDriver:</span> <span class="string">&quot;systemd&quot;</span>             <span class="comment"># cgroup驱动 (systemd 或 cgroupfs)</span></span><br><span class="line"><span class="comment"># 集群DNS服务IP地址</span></span><br><span class="line"><span class="attr">clusterDNS:</span> [<span class="string">&quot;169.169.0.100&quot;</span>]</span><br><span class="line"><span class="comment"># 服务的DNS服务后缀</span></span><br><span class="line"><span class="attr">clusterDomain:</span> <span class="string">cluster.local</span></span><br><span class="line"><span class="comment"># 设置是否允许匿名访问</span></span><br><span class="line"><span class="attr">authentication:</span></span><br><span class="line">	<span class="attr">anonymous:</span></span><br><span class="line">		<span class="attr">enable:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>配置文件准备好后，在节点上启动kubelet</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl statrt kubelet &amp;&amp; systemctl enable kubelet</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="部署kube-proxy服务"><a href="#部署kube-proxy服务" class="headerlink" title="部署kube-proxy服务"></a>部署kube-proxy服务</h3><ol>
<li><p>创建kube-proxy服务的systemd服务的配置文件&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;sytem&#x2F;kube-proxy.service</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=Kubernetes Kube-Porxy Server</span><br><span class="line"><span class="attr">Documentation</span>=https://kubernetes.io/zh-cn/docs/home/</span><br><span class="line"><span class="attr">After</span>=network.target</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">EnvironmentFile</span>=/etc/kubernetes/proxy</span><br><span class="line"><span class="attr">ExecStart</span>=/usr/bin/kube-proxy <span class="variable">$KUBE_PROXY_ARGS</span></span><br><span class="line"><span class="attr">Restart</span>=always</span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置文件&#x2F;etc&#x2F;kubernetes&#x2F;proxy内容通过环境变量KUBE_PROXY_ARGS设置kube-proxy启动参数</p>
<ul>
<li>–kubeconfig:设置和API Server连接的客户端身份</li>
<li>–hostname-override：本Node在集群中名称</li>
<li>–proxy-mode：代理模式，支持iptables、ipvs、kernelspace（Windows Node）</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">KUBE_PROXY_ARGS=&quot;--kubeconfig=/etc/kubernetes/kubeconfig \ </span><br><span class="line">--hostname-override=192.168.18.3 \</span><br><span class="line">--proxy-mode=iptables&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>准备完环境文件，在Node上启动kube-proxy 服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start kube-proxy &amp;&amp; systemctl enable kube-proxy</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="在Master上通过kubectl验证各个Node的信息"><a href="#在Master上通过kubectl验证各个Node的信息" class="headerlink" title="在Master上通过kubectl验证各个Node的信息"></a>在Master上通过kubectl验证各个Node的信息</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl --kubeconfig=/etc/kubernetes/kubeconfig get nodes</span><br></pre></td></tr></table></figure>

<p> Node为NotReady</p>
<ul>
<li>还需要部署CNI网络插件</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a target="_blank" rel="noopener" href="https://github.com/Piwriw">Joohwan.</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://piwriw.github.io/2024/12/31/cloud/k8s/install/K8s%E5%AE%89%E8%A3%85-%E5%9F%BA%E4%BA%8E%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%87%E4%BB%B6(%E9%AB%98%E5%8F%AF%E7%94%A8)/">https://piwriw.github.io/2024/12/31/cloud/k8s/install/K8s安装-基于二进制文件(高可用)/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://piwriw.github.io" target="_blank">Joohwan</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/k8s/">k8s</a><a class="post-meta__tags" href="/tags/cloud/">cloud</a><a class="post-meta__tags" href="/tags/install/">install</a></div><div class="post-share"><div class="social-share" data-image="/img/k8sLogo.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>赞助</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2025/01/01/cloud/k8s/kubeadm/K8s%E9%9B%86%E7%BE%A4%E7%89%88%E6%9C%AC%E6%9B%B4%E6%96%B0/" title="K8s集群版本更新"><img class="cover" src="/img/kubeadm.png" onerror="onerror=null;src='/img/404.png'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">K8s集群版本更新</div></div><div class="info-2"><div class="info-item-1">K8s集群版本更新在K8s集群更新，需要考虑不断运行的业务容器运行，通常流程，先更新Master上的K8s服务版本，在逐个更新Node的K8s服务版本 以二进制部署的K8s集群更新更新步骤一般如下：  获取官网的K8s二进制安装包 更新Master的kube-apiserver、kube-controller-manager、kube-scheduler 更新隔离Node，等待全部容器工作停止掉Pod，更新kubelet、kube-proxy 服务文件 恢复业务应用到流量到更新完成的Node上  以Kubeadm部署的K8s集群的版本更新可以通过kubeadm upgrade更新  更新kubeadm 本身 1yum install -y kubeadm-1.21.0 --disableexcludes=kubernetes  查看kubeadm版本，kubeadm version  查看K8s更新的计划，内容,会检查系统的配置 1kubeadm upgrade plan  执行升级 1kubeadm upgrade apply  Node也进行升级 1kubeadm upgra...</div></div></div></a><a class="pagination-related" href="/2024/12/31/cloud/k8s/kubeadm/K8s%E5%AE%89%E8%A3%85-%E5%9F%BA%E4%BA%8Ekubeadm/" title="K8s安装-基于kubeadm"><img class="cover" src="/img/kubeadm.png" onerror="onerror=null;src='/img/404.png'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">K8s安装-基于kubeadm</div></div><div class="info-2"><div class="info-item-1">K8s安装-基于kubeadm 基于1.29  系统要求   软硬件 最低要求 推荐配置    主机资源 若集群中有1-5个Node：Master：2c+2GB；Node：1c Master：4C和16GB；Node实际运行   Linux Kernel内核在v3.10以上 CoreOS7.9   etcd 版本v3以上 etcdv3   容器运行时 各种cri containerd v1.7   主要注意centos7默认开启防火墙，而K8s和各个Node有大量通信，推荐开启以下端口    组件 默认端口    API Server 6443   Controller Manager 10257   Scheduler 10259   Kubelet 10250；10255(只读端口)   etcd 2379（供客户端访问）；2380（etcd集群节点之间访问）   集群的DNS服务 53（UDP）；53（TCP）   对于其他组件，可能还需要开放其他端口，比如CNI Calico需要开放179端口 123# 关闭防火墙systemctl disable firewalldsy...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2024/04/23/cloud/k8s/install/%E8%B7%A8%E5%85%AC%E7%BD%91%E8%A7%A3%E5%86%B3K8s%E7%BB%84%E7%BD%91/" title="跨公网解决K8s组网"><img class="cover" src="/img/k8sLogo.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-23</div><div class="info-item-2">跨公网解决K8s组网</div></div><div class="info-2"><div class="info-item-1">跨公网解决K8s组网需要开放安全组工作节点开放组   开放端口号 开放端口类型 备注    8472 UDP Flannel vxlan 模式下的Overlay 网络通信   10250 TCP kubelet log exec 等端口   控制面开放组   开放端口号 开放端口类型 备注    8472 UDP Flannel vxlan 模式下的Overlay 网络通信   10250 TCP kubelet log exec 等端口   6443 TCP apiserver端口   2380 TCP etcd端口   安装部署Master创建虚拟网卡12345# 公网ippublic_ip=xxxsudo ip link add dummy-pub type dummysudo ip addr add $public_ip/32 dev dummy-pub  公网IP启动apiserver参考:https://piwriw.github.io/2024/01/08/cloud/k8s/K8s%E5%85%AC%E7%BD%91%E9%83%A8%E7%BD%B2/  通过输...</div></div></div></a><a class="pagination-related" href="/2024/01/08/cloud/k8s/install/K8s%E5%85%AC%E7%BD%91%E9%83%A8%E7%BD%B2/" title="K8s-公网部署集群"><img class="cover" src="/img/k8s-go.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-01-08</div><div class="info-item-2">K8s-公网部署集群</div></div><div class="info-2"><div class="info-item-1">K8s 公网部署集群BackGroud在公网环境下，或者需要跨局域网组成集群下。需要让Master以公网IP启动，而kubeadm init 参数启动，只支持局域网。 Deploy 获取配置文件kubead config default &gt; k8s-init.yaml，localAPIEndpoint.advertiseAddress就是公网IP地址  最新使用 kubeadm config print  init-defaults   &gt; k8s-init.yaml12345678910111213141516171819202122232425262728293031323334353637383940apiVersion: kubeadm.k8s.io/v1beta2bootstrapTokens:- groups:  - system:bootstrappers:kubeadm:default-node-token  token: abcdef.0123456789abcdef  ttl: 24h0m0s  usages:  - signing  - auth...</div></div></div></a><a class="pagination-related" href="/2023/09/22/cloud/k8s/install/%E9%83%A8%E7%BD%B2K8s(%E8%84%9A%E6%9C%AC%E7%89%88%E6%9C%AC)/" title="部署K8s（脚本版本）"><img class="cover" src="/img/kubernetes.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-09-22</div><div class="info-item-2">部署K8s（脚本版本）</div></div><div class="info-2"><div class="info-item-1">部署K8s（脚本版本）文件位置：https://github.com/Piwriw/k8s_base/tree/master/k8s-setup 分发文件（push-file.sh)12345678910111213141516#!/bin/bashset -e# 源文件路径source_file=&quot;../k8s-setup&quot;# 目标主机列表target_hosts=(  &quot;root@10.10.103.79:/root&quot;  &quot;root@10.10.103.80:/root&quot;  &quot;root@10.10.103.81:/root&quot;)# 循环迭代目标主机列表，并使用 scp 命令将文件复制到每个主机for target_host in &quot;$&#123;target_hosts[@]&#125;&quot;; do  scp -r &quot;$source_file&quot; &quot;$target_host&quot;done  部署包括docker（set-up.sh）⚠️注意修改12...</div></div></div></a><a class="pagination-related" href="/2023/06/10/cloud/k8s/install/K8s%E5%A6%82%E4%BD%95%E6%94%AF%E6%8C%81%E5%85%AC%E7%BD%91%E8%AE%BF%E9%97%AE/" title="K8s如何支持公网访问"><img class="cover" src="/img/kubernetes.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-06-10</div><div class="info-item-2">K8s如何支持公网访问</div></div><div class="info-2"><div class="info-item-1">K8s如何支持公网访问因为k8s默认启动支持内网ip，下面是三种 让k8s支持公网访问的模式 keadm init添加参数12# 未实践kubeadm init --apiserver-advertise-address= 内网ip  --apiserver-cert-extra-sans 公网ip --image-repository registry.aliyuncs.com/google_containers --kubernetes-version v1.19.4 --service-cidr=10.96.0.0/12 --pod-network-cidr=10.244.0.0/16  重新生成apiserver证书 删除原来的apiserver证书 12cd /etc/kubernetes/pkirm apiserver.*	  生成新的apiserver证书 1kubeadm init phase certs apiserver --apiserver-advertise-address 内网ip --apiserver-cert-extra-sans 公网ip --...</div></div></div></a><a class="pagination-related" href="/2025/08/24/cloud/k8s/K8s%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97-%E5%AE%A2%E6%88%B7%E7%AB%AF/" title="K8s开发指南-客户端"><img class="cover" src="/img/k8sLogo.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-08-24</div><div class="info-item-2">K8s开发指南-客户端</div></div><div class="info-2"><div class="info-item-1">K8s开发指南-客户端 基于K8s v1.29  API客户端 Ref：https://github.com/kubernetes/client-go  K8s认证方式主要一下俩类：  集群外的认证：客户端程序运行在集群外，以独立进程访问API Server 集群内的认证：客户端在K8s内以Pod形式运行，通过内部服务名访问API Server  客户端访问API Server常见的认证方式有以下的几种  数字证书方式 ServiceAccount方式 BearerToken方式  对于运行在K8s集群之外的客户端，建议使用数字证书方式连接API Server，客户端需要配置的信息包括CA根证书、客户端证书、客户段私钥以及API Server地址 对于运行在集群内的Pod，建议使用ServiceAccount认证方式，需要为Pod增加ServiceAccount资源，并为ServiceAccount配置好正确的RBAC权限 基于kubeconfig文件的配置方式有以下几种：  用户HOME目录中的约定目录，例如$HOME&#x2F;.kube&#x2F;config 在环境变量K...</div></div></div></a><a class="pagination-related" href="/2025/08/23/cloud/k8s/K8s%E5%BC%80%E5%8F%91-API%E8%AF%A6%E8%A7%A3/" title="K8s开发-API详解"><img class="cover" src="/img/k8sLogo.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-08-23</div><div class="info-item-2">K8s开发-API详解</div></div><div class="info-2"><div class="info-item-1">K8s开发-API详解 基于K8s v1.29  资源对象一个K8s资源对象描述一般是kind、apiVersion、metadata、spec和status五个部分 资源对象的类型资源对象的类型用Kind属性表示，总体分为3个类型：  对象（Object）、代表系统中永久资源实体，比如Pod、RC 列表（List）：资源对象的合集 简单类别（Simple）：作用于资源对象或非持久辅助实体的特定操作，比如Status、Scale、ListOptions等  资源对象的元数据metadata是资源对象的元数据定义，由一组属性来定义，在K8s中，每个资源对象都必须包含以下元数据属性：  namespec：对象所属的命名空间，如果不指定，则昔日会将对象置于名为default中 name：对象的名称、在一个ns下，唯一性 uid：系统为每个对象生成唯一的ID，符合RFC4122 labels：自定义标签 annotations：用户自定义注解，被K8s内部进程或者外部工具使用 resourceVersion：用于识别资源内部斑斑的字符串，在Watch操作，可以避免Get和下一次Watch...</div></div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Joohwan.</div><div class="author-info-description">该知道的都知道，不知道的慢慢了解</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">259</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">76</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">60</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/piwriw"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/piwriw" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:piwriw@163.com" target="_blank" title="Email"><i class="fas fa-envelope-open-text"></i></a></div></div><div class="card-widget"><div class="item-headline"><i class="iconfont icat-visitor"></i><span>来访者</span></div><div class="item-content"><div id="welcome-info"></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#K8s%E5%AE%89%E8%A3%85-%E5%9F%BA%E4%BA%8E%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%87%E4%BB%B6%EF%BC%88%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%89"><span class="toc-number">1.</span> <span class="toc-text">K8s安装-基于二进制文件（高可用）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Master%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2%E6%9E%B6%E6%9E%84"><span class="toc-number">1.1.</span> <span class="toc-text">Master高可用部署架构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BACA%E6%A0%B9%E8%AF%81%E4%B9%A6"><span class="toc-number">1.2.</span> <span class="toc-text">创建CA根证书</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E5%AE%89%E5%85%A8%E7%9A%84etcd%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4"><span class="toc-number">1.3.</span> <span class="toc-text">部署安全的etcd高可用集群</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E5%AE%89%E5%85%A8%E7%9A%84K8s-Master%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4"><span class="toc-number">1.4.</span> <span class="toc-text">部署安全的K8s Master高可用集群</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BDK8s%E7%9A%84%E6%9C%8D%E5%8A%A1%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%87%E4%BB%B6"><span class="toc-number">1.4.1.</span> <span class="toc-text">下载K8s的服务二进制文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2kube-apiserver%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.4.2.</span> <span class="toc-text">部署kube-apiserver服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%AE%A2%E6%88%B7%E7%AB%AFCA%E8%AF%81%E4%B9%A6"><span class="toc-number">1.4.3.</span> <span class="toc-text">创建客户端CA证书</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%BF%9E%E6%8E%A5kube-apiserver%E6%9C%8D%E5%8A%A1%E6%89%80%E9%9C%80%E8%A6%81kubeconfig%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.4.4.</span> <span class="toc-text">创建客户端连接kube-apiserver服务所需要kubeconfig配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2kube-controller-manage%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.4.5.</span> <span class="toc-text">部署kube-controller- manage服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2kube-schduler%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.4.6.</span> <span class="toc-text">部署kube-schduler服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8HAPorxy%E5%92%8Ckeepalived%E9%83%A8%E7%BD%B2%E9%AB%98%E5%8F%AF%E7%94%A8%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%99%A8"><span class="toc-number">1.4.7.</span> <span class="toc-text">使用HAPorxy和keepalived部署高可用负载均衡器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2HAProxy"><span class="toc-number">1.4.7.1.</span> <span class="toc-text">部署HAProxy</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2keepalived"><span class="toc-number">1.4.7.2.</span> <span class="toc-text">部署keepalived</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E5%90%84%E4%B8%AANode%E7%9A%84%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.5.</span> <span class="toc-text">部署各个Node的服务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E8%BF%90%E8%A1%8C%E6%97%B6"><span class="toc-number">1.5.1.</span> <span class="toc-text">容器运行时</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2kubelet"><span class="toc-number">1.5.2.</span> <span class="toc-text">部署kubelet</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2kube-proxy%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.5.3.</span> <span class="toc-text">部署kube-proxy服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8Master%E4%B8%8A%E9%80%9A%E8%BF%87kubectl%E9%AA%8C%E8%AF%81%E5%90%84%E4%B8%AANode%E7%9A%84%E4%BF%A1%E6%81%AF"><span class="toc-number">1.5.4.</span> <span class="toc-text">在Master上通过kubectl验证各个Node的信息</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2026/01/11/web/gorm/09-logger/" title="Gorm-日志系统模块原理说明"><img src="/img/go.png" onerror="this.onerror=null;this.src='/img/404.png'" alt="Gorm-日志系统模块原理说明"/></a><div class="content"><a class="title" href="/2026/01/11/web/gorm/09-logger/" title="Gorm-日志系统模块原理说明">Gorm-日志系统模块原理说明</a><time datetime="2026-01-11T11:56:27.000Z" title="发表于 2026-01-11 19:56:27">2026-01-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2026/01/11/web/gorm/08-migration/" title="Gorm-迁移功能模块原理说明"><img src="/img/go.png" onerror="this.onerror=null;this.src='/img/404.png'" alt="Gorm-迁移功能模块原理说明"/></a><div class="content"><a class="title" href="/2026/01/11/web/gorm/08-migration/" title="Gorm-迁移功能模块原理说明">Gorm-迁移功能模块原理说明</a><time datetime="2026-01-11T10:56:27.000Z" title="发表于 2026-01-11 18:56:27">2026-01-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2026/01/11/web/gorm/10-plugin/" title="Gorm-插件系统模块原理说明"><img src="/img/go.png" onerror="this.onerror=null;this.src='/img/404.png'" alt="Gorm-插件系统模块原理说明"/></a><div class="content"><a class="title" href="/2026/01/11/web/gorm/10-plugin/" title="Gorm-插件系统模块原理说明">Gorm-插件系统模块原理说明</a><time datetime="2026-01-11T10:56:27.000Z" title="发表于 2026-01-11 18:56:27">2026-01-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2026/01/11/web/gorm/07-transaction/" title="Gorm-事务处理模块原理说明"><img src="/img/go.png" onerror="this.onerror=null;this.src='/img/404.png'" alt="Gorm-事务处理模块原理说明"/></a><div class="content"><a class="title" href="/2026/01/11/web/gorm/07-transaction/" title="Gorm-事务处理模块原理说明">Gorm-事务处理模块原理说明</a><time datetime="2026-01-11T09:56:27.000Z" title="发表于 2026-01-11 17:56:27">2026-01-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2026/01/11/web/gorm/06-associations/" title="Gorm-关联关系模块原理说明"><img src="/img/go.png" onerror="this.onerror=null;this.src='/img/404.png'" alt="Gorm-关联关系模块原理说明"/></a><div class="content"><a class="title" href="/2026/01/11/web/gorm/06-associations/" title="Gorm-关联关系模块原理说明">Gorm-关联关系模块原理说明</a><time datetime="2026-01-11T08:56:27.000Z" title="发表于 2026-01-11 16:56:27">2026-01-11</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2023 - 2026 By Joohwan.</span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
  const option = null

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://piwriw-twikoo-git-main-piwriw.vercel.app/',
      region: 'ap-shanghai',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const init = (el = document, path = location.pathname) => {
    twikoo.init({
      el: el.querySelector('#twikoo-wrap'),
      envId: 'https://piwriw-twikoo-git-main-piwriw.vercel.app/',
      region: 'ap-shanghai',
      onCommentLoaded: () => {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      },
      ...option,
      path: isShuoshuo ? path : (option && option.path) || path
    })

    

    isShuoshuo && (window.shuoshuoComment.destroyTwikoo = () => {
      if (el.children.length) {
        el.innerHTML = ''
        el.classList.add('no-comment')
      }
    })
  }

  const loadTwikoo = (el, path) => {
    if (typeof twikoo === 'object') setTimeout(() => init(el, path), 0)
    else btf.getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(() => init(el, path))
  }

  if (isShuoshuo) {
    'Twikoo' === 'Twikoo'
      ? window.shuoshuoComment = { loadComment: loadTwikoo }
      : window.loadOtherComment = loadTwikoo
    return
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script></div><script src="/js/categories.js" defer></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>