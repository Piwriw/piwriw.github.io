<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Gorm-查询构建模块原理说明 | Joohwan</title><meta name="author" content="Joohwan."><meta name="copyright" content="Joohwan."><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="查询构建模块原理说明 基于1.31 本文档深入解析查询构建模块的设计原理和核心原理，涵盖链式 API、条件构建、执行流程等核心内容。   一、设计原理1.1 模块定位在整体架构中的位置 查询构建模块是 GORM 对外提供的主要 API 层，是用户交互的主要界面，位于回调系统之上，协调子句系统和 Schema 模块完成查询构建和执行。 12345678910111213141516171819202">
<meta property="og:type" content="article">
<meta property="og:title" content="Gorm-查询构建模块原理说明">
<meta property="og:url" content="https://piwriw.github.io/2026/01/11/web/gorm/02-query-builder/index.html">
<meta property="og:site_name" content="Joohwan">
<meta property="og:description" content="查询构建模块原理说明 基于1.31 本文档深入解析查询构建模块的设计原理和核心原理，涵盖链式 API、条件构建、执行流程等核心内容。   一、设计原理1.1 模块定位在整体架构中的位置 查询构建模块是 GORM 对外提供的主要 API 层，是用户交互的主要界面，位于回调系统之上，协调子句系统和 Schema 模块完成查询构建和执行。 12345678910111213141516171819202">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://piwriw.github.io/img/go.png">
<meta property="article:published_time" content="2026-01-11T05:56:27.000Z">
<meta property="article:modified_time" content="2026-02-28T13:29:12.677Z">
<meta property="article:author" content="Joohwan.">
<meta property="article:tag" content="web">
<meta property="article:tag" content="Gorm">
<meta property="article:tag" content="源码">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://piwriw.github.io/img/go.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Gorm-查询构建模块原理说明",
  "url": "https://piwriw.github.io/2026/01/11/web/gorm/02-query-builder/",
  "image": "https://piwriw.github.io/img/go.png",
  "datePublished": "2026-01-11T05:56:27.000Z",
  "dateModified": "2026-02-28T13:29:12.677Z",
  "author": [
    {
      "@type": "Person",
      "name": "Joohwan.",
      "url": "https://github.com/Piwriw"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://piwriw.github.io/2026/01/11/web/gorm/02-query-builder/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Gorm-查询构建模块原理说明',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><script src="/js/welcome.js"></script><script src="https://npm.elemecdn.com/echarts@4.9.0/dist/echarts.min.js"></script><link rel="stylesheet" href="/css/categories.css"><link rel="stylesheet" href="/css/tabs.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">259</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">76</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">60</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/charts/"><i class="fa-fw fas fa-folder-open"></i><span> 文章统计</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div><div class="menus_item"><a class="site-page" href="/wish/"><i class="fa-fw fas fa-tags"></i><span> 许愿墙</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/go.png);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Joohwan</span></a><a class="nav-page-title" href="/"><span class="site-name">Gorm-查询构建模块原理说明</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/charts/"><i class="fa-fw fas fa-folder-open"></i><span> 文章统计</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div><div class="menus_item"><a class="site-page" href="/wish/"><i class="fa-fw fas fa-tags"></i><span> 许愿墙</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Gorm-查询构建模块原理说明</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2026-01-11T05:56:27.000Z" title="发表于 2026-01-11 13:56:27">2026-01-11</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2026-02-28T13:29:12.677Z" title="更新于 2026-02-28 21:29:12">2026-02-28</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/web/">web</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/web/gorm/">gorm</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">5.6k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>24分钟</span></span><span class="post-meta-separator">|</span><span id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="twikoo_visitors"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><div id="post-outdate-notice" data="{&quot;limitDay&quot;:365,&quot;messagePrev&quot;:&quot;It has been&quot;,&quot;messageNext&quot;:&quot;days since the last update, the content of the article may be outdated.&quot;,&quot;postUpdate&quot;:&quot;2026-02-28 21:29:12&quot;}" hidden></div><h1 id="查询构建模块原理说明"><a href="#查询构建模块原理说明" class="headerlink" title="查询构建模块原理说明"></a>查询构建模块原理说明</h1><blockquote>
<p>基于1.31 本文档深入解析查询构建模块的设计原理和核心原理，涵盖链式 API、条件构建、执行流程等核心内容。</p>
</blockquote>
<hr>
<h2 id="一、设计原理"><a href="#一、设计原理" class="headerlink" title="一、设计原理"></a>一、设计原理</h2><h3 id="1-1-模块定位"><a href="#1-1-模块定位" class="headerlink" title="1.1 模块定位"></a>1.1 模块定位</h3><p><strong>在整体架构中的位置</strong></p>
<p>查询构建模块是 GORM 对外提供的主要 API 层，是用户交互的主要界面，位于回调系统之上，协调子句系统和 Schema 模块完成查询构建和执行。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│                    用户代码                                   │</span><br><span class="line">│  db.Model(&amp;User&#123;&#125;).Where(&quot;age &gt; ?&quot;, 18).Find(&amp;users)       │</span><br><span class="line">└────────────────────────┬────────────────────────────────────┘</span><br><span class="line">                         │</span><br><span class="line">                         ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│              链式 API (Chainable API)                        │</span><br><span class="line">│  Where() → Select() → Order() → Limit() → ...               │</span><br><span class="line">└────────────────────────┬────────────────────────────────────┘</span><br><span class="line">                         │</span><br><span class="line">                         ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│              终结 API (Finisher API)                         │</span><br><span class="line">│              Find() / First() / Create() / ...              │</span><br><span class="line">└────────────────────────┬────────────────────────────────────┘</span><br><span class="line">                         │</span><br><span class="line">                         ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│                   回调系统执行                               │</span><br><span class="line">│  Before Query → Build → Execute → After Query               │</span><br><span class="line">└────────────────────────┬────────────────────────────────────┘</span><br><span class="line">                         │</span><br><span class="line">                         ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│                   子句系统构建 SQL                            │</span><br><span class="line">│         (调用 Clause.Build() 生成 SQL 和参数)                │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<p><strong>核心价值</strong></p>
<p>查询构建模块的核心价值在于：</p>
<ol>
<li><strong>流畅性</strong>: 提供链式调用，代码读起来像自然语言</li>
<li><strong>类型安全</strong>: 通过方法重载和泛型提供类型检查</li>
<li><strong>延迟执行</strong>: 只在调用 Finisher 时才真正执行查询</li>
<li><strong>组合性</strong>: 可以任意组合查询条件</li>
</ol>
<h3 id="1-2-设计目的"><a href="#1-2-设计目的" class="headerlink" title="1.2 设计目的"></a>1.2 设计目的</h3><p><strong>问题 1: 如何提供流畅的链式调用体验？</strong></p>
<ul>
<li><strong>挑战</strong>: 每个方法需要返回合适的类型以支持继续链式调用</li>
<li><strong>挑战</strong>: 需要在链式调用中维护查询状态</li>
<li><strong>解决方案</strong>: 每个方法返回新的 DB 实例，共享或克隆 Statement</li>
</ul>
<p><strong>问题 2: 如何支持多种形式的条件输入？</strong></p>
<ul>
<li><strong>挑战</strong>: 开发者可能用字符串、map、结构体等方式表示条件</li>
<li><strong>挑战</strong>: 需要将不同形式转换为统一的内部表示</li>
<li><strong>解决方案</strong>: BuildCondition 方法统一处理各种输入</li>
</ul>
<p><strong>问题 3: 如何保证执行的时机正确？</strong></p>
<ul>
<li><strong>挑战</strong>: 需要区分配置阶段和执行阶段</li>
<li><strong>挑战</strong>: 需要在正确的时机构建 SQL</li>
<li><strong>解决方案</strong>: 链式 API 只配置，Finisher API 触发执行</li>
</ul>
<h3 id="1-3-结构安排依据"><a href="#1-3-结构安排依据" class="headerlink" title="1.3 结构安排依据"></a>1.3 结构安排依据</h3><p><strong>4 天学习时间的分配逻辑</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Day 1: 链式 API 设计</span><br><span class="line">  目标: 理解流畅调用的实现原理</span><br><span class="line">  重点: getInstance()、clone、Statement 共享</span><br><span class="line"></span><br><span class="line">Day 2: 条件构建系统</span><br><span class="line">  目标: 理解各种条件形式的处理</span><br><span class="line">  重点: BuildCondition、Expression 构建</span><br><span class="line"></span><br><span class="line">Day 3: Finisher API</span><br><span class="line">  目标: 理解查询执行的完整流程</span><br><span class="line">  重点: 回调链、SQL 构建、结果扫描</span><br><span class="line"></span><br><span class="line">Day 4: 高级特性</span><br><span class="line">  目标: 掌握 Preload、Joins、Scopes</span><br><span class="line">  重点: 预加载机制、连接查询、作用域复用</span><br></pre></td></tr></table></figure>

<p><strong>由外而内的学习路径</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">第 1 层: API 层 (用户看到的)</span><br><span class="line">  db.Where().Order().Limit().Find()</span><br><span class="line">  └─ 理解方法签名和返回值</span><br><span class="line"></span><br><span class="line">第 2 层: 机制层 (如何工作的)</span><br><span class="line">  getInstance() → clone → Statement</span><br><span class="line">  └─ 理解实例创建和状态管理</span><br><span class="line"></span><br><span class="line">第 3 层: 原理层 (为什么这样设计)</span><br><span class="line">  不变性、延迟执行、组合模式</span><br><span class="line">  └─ 理解设计决策的权衡</span><br></pre></td></tr></table></figure>

<h3 id="1-4-与其他模块的逻辑关系"><a href="#1-4-与其他模块的逻辑关系" class="headerlink" title="1.4 与其他模块的逻辑关系"></a>1.4 与其他模块的逻辑关系</h3><p><strong>依赖关系</strong></p>
<ul>
<li><strong>依赖 Schema</strong>: 获取表名、列名、字段类型</li>
<li><strong>依赖子句系统</strong>: 添加和构建子句</li>
<li><strong>依赖回调系统</strong>: 执行查询前后的钩子</li>
</ul>
<p><strong>被依赖关系</strong></p>
<ul>
<li><strong>被关联查询使用</strong>: Preload 通过查询构建实现</li>
<li>**被事务处理使用: Tx 也是一个 DB 实例</li>
</ul>
<hr>
<h2 id="二、核心原理"><a href="#二、核心原理" class="headerlink" title="二、核心原理"></a>二、核心原理</h2><h3 id="2-1-关键概念"><a href="#2-1-关键概念" class="headerlink" title="2.1 关键概念"></a>2.1 关键概念</h3><h4 id="概念-1-链式调用的实现机制"><a href="#概念-1-链式调用的实现机制" class="headerlink" title="概念 1: 链式调用的实现机制"></a>概念 1: 链式调用的实现机制</h4><p><strong>定义</strong>: 链式调用是一种编程模式，每个方法返回对象本身或相关对象，允许连续调用多个方法。</p>
<p><strong>GORM 的实现方式</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 基本模式</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> Where(query <span class="keyword">interface</span>&#123;&#125;, args ...<span class="keyword">interface</span>&#123;&#125;) *DB &#123;</span><br><span class="line">    tx := db.getInstance()  <span class="comment">// 获取实例</span></span><br><span class="line">    <span class="comment">// 配置 tx</span></span><br><span class="line">    <span class="keyword">return</span> tx  <span class="comment">// 返回实例，支持继续调用</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>getInstance() 的智能克隆</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> getInstance() *DB &#123;</span><br><span class="line">    <span class="keyword">if</span> db.clone &gt; <span class="number">0</span> &#123;</span><br><span class="line">        tx := &amp;DB&#123;Config: db.Config, Error: db.Error&#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> db.clone == <span class="number">1</span> &#123;</span><br><span class="line">            <span class="comment">// 创建新的空 Statement（浅克隆）</span></span><br><span class="line">            tx.Statement = &amp;Statement&#123;</span><br><span class="line">                DB:        tx,</span><br><span class="line">                ConnPool:  db.Statement.ConnPool,</span><br><span class="line">                Context:   db.Statement.Context,</span><br><span class="line">                Clauses:   <span class="keyword">map</span>[<span class="type">string</span>]clause.Clause&#123;&#125;,</span><br><span class="line">                Vars:      <span class="built_in">make</span>([]<span class="keyword">interface</span>&#123;&#125;, <span class="number">0</span>, <span class="number">8</span>),</span><br><span class="line">                SkipHooks: db.Statement.SkipHooks,</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 深克隆 Statement</span></span><br><span class="line">            tx.Statement = db.Statement.clone()</span><br><span class="line">            tx.Statement.DB = tx</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> tx</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> db</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>克隆策略对比</strong>:</p>
<table>
<thead>
<tr>
<th>操作</th>
<th>clone 值</th>
<th>Statement</th>
<th>Config</th>
<th>用途</th>
</tr>
</thead>
<tbody><tr>
<td>原始 DB</td>
<td>0</td>
<td>共享</td>
<td>共享</td>
<td>基础连接</td>
</tr>
<tr>
<td>首次克隆</td>
<td>1</td>
<td>新空 Statement</td>
<td>共享</td>
<td>链式调用</td>
</tr>
<tr>
<td>后续克隆</td>
<td>2</td>
<td>克隆 Statement</td>
<td>共享</td>
<td>继续链式调用</td>
</tr>
<tr>
<td>Session</td>
<td>1</td>
<td>独立</td>
<td>独立副本</td>
<td>会话隔离</td>
</tr>
<tr>
<td>NewDB</td>
<td>1</td>
<td>独立</td>
<td>独立</td>
<td>独立连接</td>
</tr>
</tbody></table>
<p><strong>学习要点</strong>:</p>
<ul>
<li>链式调用时 clone &#x3D;&#x3D; 1，创建新的空 Statement（不克隆原 Statement）</li>
<li>继续链式调用时 clone &gt; 1，才真正克隆 Statement</li>
<li>clone 值不会自动递增，而是根据创建方式决定（Session 设为 1，链式调用保持 1 或 2）</li>
<li>Config 在链式调用时共享，Session 时创建独立副本</li>
</ul>
<h4 id="概念-2-Statement-的状态管理"><a href="#概念-2-Statement-的状态管理" class="headerlink" title="概念 2: Statement 的状态管理"></a>概念 2: Statement 的状态管理</h4><p><strong>定义</strong>: Statement 是查询的执行上下文，包含了构建查询所需的所有状态。</p>
<p><strong>核心状态字段</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Statement <span class="keyword">struct</span> &#123;</span><br><span class="line">    *DB  <span class="comment">// 反向引用</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 模型信息</span></span><br><span class="line">    Model      <span class="keyword">interface</span>&#123;&#125;    <span class="comment">// 模型结构体</span></span><br><span class="line">    Table      <span class="type">string</span>         <span class="comment">// 表名</span></span><br><span class="line">    Schema     *schema.Schema <span class="comment">// Schema 元数据</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 目标信息</span></span><br><span class="line">    Dest       <span class="keyword">interface</span>&#123;&#125;    <span class="comment">// 扫描目标</span></span><br><span class="line">    ReflectValue reflect.Value <span class="comment">// 反射值</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 子句集合</span></span><br><span class="line">    Clauses      <span class="keyword">map</span>[<span class="type">string</span>]clause.Clause</span><br><span class="line">    BuildClauses []<span class="type">string</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 字段控制</span></span><br><span class="line">    Selects      []<span class="type">string</span></span><br><span class="line">    Omits        []<span class="type">string</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 关联信息</span></span><br><span class="line">    Joins        []join</span><br><span class="line">    Preloads     <span class="keyword">map</span>[<span class="type">string</span>][]<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// SQL 构建</span></span><br><span class="line">    SQL          strings.Builder</span><br><span class="line">    Vars         []<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>状态转换流程</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">初始状态</span><br><span class="line">    │</span><br><span class="line">    │ Model(&amp;User&#123;&#125;)</span><br><span class="line">    ▼</span><br><span class="line">设置 Model、Table、Schema</span><br><span class="line">    │</span><br><span class="line">    │ Where(&quot;age &gt; ?&quot;, 18)</span><br><span class="line">    ▼</span><br><span class="line">添加 WHERE 子句到 Clauses</span><br><span class="line">    │</span><br><span class="line">    │ Order(&quot;name&quot;)</span><br><span class="line">    ▼</span><br><span class="line">添加 ORDER BY 子句到 Clauses</span><br><span class="line">    │</span><br><span class="line">    │ Limit(10)</span><br><span class="line">    ▼</span><br><span class="line">添加 LIMIT 子句到 Clauses</span><br><span class="line">    │</span><br><span class="line">    │ Find(&amp;users)</span><br><span class="line">    ▼</span><br><span class="line">执行构建和查询</span><br></pre></td></tr></table></figure>

<p><strong>clone() 方法</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(stmt *Statement)</span></span> clone() *Statement &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;Statement&#123;</span><br><span class="line">        DB:          stmt.DB,</span><br><span class="line">        Table:       stmt.Table,</span><br><span class="line">        Model:       stmt.Model,</span><br><span class="line">        Clauses:     <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]clause.Clause),</span><br><span class="line">        BuildClauses: stmt.BuildClauses,</span><br><span class="line">        <span class="comment">// 共享引用</span></span><br><span class="line">        Schema:      stmt.Schema,</span><br><span class="line">        <span class="comment">// ... 复制其他字段</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>学习要点</strong>:</p>
<ul>
<li>Statement 是查询状态的容器</li>
<li>clone() 创建浅拷贝，共享 Schema</li>
<li>Clauses 是独立的，每个 DB 实例有自己的</li>
</ul>
<h4 id="概念-3-BuildCondition-条件构建"><a href="#概念-3-BuildCondition-条件构建" class="headerlink" title="概念 3: BuildCondition 条件构建"></a>概念 3: BuildCondition 条件构建</h4><p><strong>定义</strong>: BuildCondition 是统一处理各种条件形式的入口方法。</p>
<p><strong>支持的输入形式</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 形式 1: 字符串 + 参数</span></span><br><span class="line">db.Where(<span class="string">&quot;age &gt; ?&quot;</span>, <span class="number">18</span>)</span><br><span class="line"><span class="comment">// WHERE age &gt; 18</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 形式 2: map</span></span><br><span class="line">db.Where(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">    <span class="string">&quot;age &gt; ?&quot;</span>: <span class="number">18</span>,</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;John&quot;</span>,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// WHERE (age &gt; 18) AND name = &#x27;John&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 形式 3: 结构体</span></span><br><span class="line">db.Where(User&#123;Name: <span class="string">&quot;John&quot;</span>, Age: <span class="number">18</span>&#125;)</span><br><span class="line"><span class="comment">// WHERE name = &#x27;John&#x27; AND age = 18</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 形式 4: Expression</span></span><br><span class="line">db.Where(clause.Expr&#123;</span><br><span class="line">    SQL: <span class="string">&quot;age BETWEEN ? AND ?&quot;</span>,</span><br><span class="line">    Vars: []<span class="keyword">interface</span>&#123;&#125;&#123;<span class="number">18</span>, <span class="number">65</span>&#125;,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// WHERE age BETWEEN 18 AND 65</span></span><br></pre></td></tr></table></figure>

<p><strong>构建流程</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(stmt *Statement)</span></span> BuildCondition(query <span class="keyword">interface</span>&#123;&#125;, args ...<span class="keyword">interface</span>&#123;&#125;) []clause.Expression &#123;</span><br><span class="line">    <span class="keyword">switch</span> v := query.(<span class="keyword">type</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> clause.Expression:</span><br><span class="line">        <span class="keyword">return</span> []clause.Expression&#123;v&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;:</span><br><span class="line">        <span class="keyword">var</span> exprs []clause.Expression</span><br><span class="line">        <span class="keyword">for</span> key, val := <span class="keyword">range</span> v &#123;</span><br><span class="line">            exprs = <span class="built_in">append</span>(exprs, stmt.buildExpression(key, val))</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> exprs</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="type">string</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(args) &gt; <span class="number">0</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> []clause.Expression&#123;</span><br><span class="line">                clause.Expr&#123;SQL: v, Vars: args&#125;,</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 字段名 = 字段值</span></span><br><span class="line">        <span class="keyword">return</span> []clause.Expression&#123;</span><br><span class="line">            clause.NamedExpr&#123;SQL: <span class="string">&quot;? = ?&quot;</span>, Vars: []<span class="keyword">interface</span>&#123;&#125;&#123;clause.Column&#123;Name: v&#125;, v&#125;&#125;,</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="comment">// 结构体处理</span></span><br><span class="line">        <span class="keyword">return</span> stmt.buildStructCondition(v)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>学习要点</strong>:</p>
<ul>
<li>统一入口处理多种形式</li>
<li>不同形式有不同的处理逻辑</li>
<li>最终都转换为 Expression</li>
</ul>
<h4 id="概念-4-链式-API-完整实现"><a href="#概念-4-链式-API-完整实现" class="headerlink" title="概念 4: 链式 API 完整实现"></a>概念 4: 链式 API 完整实现</h4><p><strong>定义</strong>: 链式 API 是 GORM 对外提供的主要查询接口，包括 Model、Where、Select、Order、Limit 等方法。</p>
<p><strong>源码位置</strong>: <code>chainable_api.go</code></p>
<p><strong>核心方法完整解析</strong>:</p>
<h5 id="1-Model-设置模型"><a href="#1-Model-设置模型" class="headerlink" title="1. Model() - 设置模型"></a>1. Model() - 设置模型</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Model specify the model you would like to run db operations</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> Model(value <span class="keyword">interface</span>&#123;&#125;) (tx *DB) &#123;</span><br><span class="line">    tx = db.getInstance()           <span class="comment">// 获取新实例</span></span><br><span class="line">    tx.Statement.Model = value       <span class="comment">// 设置模型</span></span><br><span class="line">    <span class="keyword">return</span>                           <span class="comment">// 返回新实例</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>功能</strong>: 指定要操作的模型结构体<br><strong>使用场景</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 更新所有用户的 name</span></span><br><span class="line">db.Model(&amp;User&#123;&#125;).Update(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;hello&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果用户的主键非空，将作为条件更新</span></span><br><span class="line">db.Model(&amp;user).Update(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;hello&quot;</span>)</span><br></pre></td></tr></table></figure>

<h5 id="2-Where-添加-WHERE-条件"><a href="#2-Where-添加-WHERE-条件" class="headerlink" title="2. Where() - 添加 WHERE 条件"></a>2. Where() - 添加 WHERE 条件</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Where add where conditions</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> Where(query <span class="keyword">interface</span>&#123;&#125;, args ...<span class="keyword">interface</span>&#123;&#125;) (tx *DB) &#123;</span><br><span class="line">    tx = db.getInstance()  <span class="comment">// 获取新实例</span></span><br><span class="line">    <span class="comment">// 构建条件表达式</span></span><br><span class="line">    <span class="keyword">if</span> conds := tx.Statement.BuildCondition(query, args...); <span class="built_in">len</span>(conds) &gt; <span class="number">0</span> &#123;</span><br><span class="line">        tx.Statement.AddClause(clause.Where&#123;Exprs: conds&#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>功能</strong>: 添加 SQL WHERE 条件<br><strong>支持的形式</strong>:</p>
<ul>
<li><code>Where(&quot;age &gt; ?&quot;, 18)</code> - 字符串 + 参数</li>
<li><code>Where(map[string]interface&#123;&#125;&#123;&quot;age&quot;: 18&#125;)</code> - map</li>
<li><code>Where(User&#123;Age: 18&#125;)</code> - 结构体</li>
</ul>
<h5 id="3-Select-选择字段"><a href="#3-Select-选择字段" class="headerlink" title="3. Select() - 选择字段"></a>3. Select() - 选择字段</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Select specify fields that you want when querying, creating, updating</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> Select(query <span class="keyword">interface</span>&#123;&#125;, args ...<span class="keyword">interface</span>&#123;&#125;) (tx *DB) &#123;</span><br><span class="line">    tx = db.getInstance()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> v := query.(<span class="keyword">type</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> []<span class="type">string</span>:</span><br><span class="line">        <span class="comment">// 字符串数组：直接设置 Selects</span></span><br><span class="line">        tx.Statement.Selects = v</span><br><span class="line">    <span class="keyword">case</span> <span class="type">string</span>:</span><br><span class="line">        <span class="comment">// 单个字符串：解析为表达式</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(args) &gt; <span class="number">0</span> &#123;</span><br><span class="line">            tx.Statement.AddClause(clause.Select&#123;</span><br><span class="line">                Distinct: <span class="literal">false</span>,</span><br><span class="line">                Columns:  []clause.Column&#123;&#123;Name: v, Raw: <span class="literal">true</span>&#125;&#125;,</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> strings.Contains(v, <span class="string">&quot;??&quot;</span>) &#123;</span><br><span class="line">            <span class="comment">// 处理 ?? 占位符</span></span><br><span class="line">            tx.Statement.AddClause(clause.Select&#123;</span><br><span class="line">                Distinct: <span class="literal">false</span>,</span><br><span class="line">                Columns:  []clause.Column&#123;&#123;Raw: v&#125;&#125;,</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 普通字段名</span></span><br><span class="line">            fields := strings.Fields(v)</span><br><span class="line">            <span class="keyword">for</span> _, field := <span class="keyword">range</span> fields &#123;</span><br><span class="line">                tx.Statement.Selects = <span class="built_in">append</span>(tx.Statement.Selects, field)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="comment">// ... 其他情况处理</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="4-Order-排序"><a href="#4-Order-排序" class="headerlink" title="4. Order() - 排序"></a>4. Order() - 排序</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Order specify order when retrieving rows from database</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> Order(value <span class="keyword">interface</span>&#123;&#125;) (tx *DB) &#123;</span><br><span class="line">    tx = db.getInstance()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> v := value.(<span class="keyword">type</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> clause.OrderBy:</span><br><span class="line">        <span class="comment">// 直接使用 OrderBy 子句</span></span><br><span class="line">        tx.Statement.AddClause(v)</span><br><span class="line">    <span class="keyword">case</span> clause.OrderByColumn:</span><br><span class="line">        <span class="comment">// OrderByColumn</span></span><br><span class="line">        tx.Statement.AddClause(clause.OrderBy&#123;</span><br><span class="line">            Columns: []clause.OrderByColumn&#123;v&#125;,</span><br><span class="line">        &#125;)</span><br><span class="line">    <span class="keyword">case</span> <span class="type">string</span>:</span><br><span class="line">        <span class="comment">// 字符串：解析排序表达式</span></span><br><span class="line">        <span class="keyword">if</span> v != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">            tx.Statement.AddClause(clause.OrderBy&#123;</span><br><span class="line">                Columns: []clause.OrderByColumn&#123;</span><br><span class="line">                    &#123;Column: clause.Column&#123;Name: v&#125;, Raw: <span class="literal">true</span>&#125;,</span><br><span class="line">                &#125;,</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="5-Limit-Offset-分页"><a href="#5-Limit-Offset-分页" class="headerlink" title="5. Limit() &#x2F; Offset() - 分页"></a>5. Limit() &#x2F; Offset() - 分页</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Limit specify the number of records to be retrieved</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> Limit(limit <span class="type">int</span>) (tx *DB) &#123;</span><br><span class="line">    tx = db.getInstance()</span><br><span class="line">    tx.Statement.AddClause(clause.Limit&#123;Limit: &amp;limit&#125;)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Offset specify the number of records to skip before starting to return the records</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> Offset(offset <span class="type">int</span>) (tx *DB) &#123;</span><br><span class="line">    tx = db.getInstance()</span><br><span class="line">    tx.Statement.AddClause(clause.Limit&#123;Offset: offset&#125;)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>链式 API 调用流程图</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">db.Model(&amp;User&#123;&#125;).Where(&quot;age &gt; ?&quot;, 18).Order(&quot;name&quot;).Limit(10).Find(&amp;users)</span><br><span class="line"> │</span><br><span class="line"> ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────────────┐</span><br><span class="line">│ Model(&amp;User&#123;&#125;)                                                   │</span><br><span class="line">│ ┌─────────────────────────────────────────────────────────────┐ │</span><br><span class="line">│ │ 1. getInstance() → 创建新 DB 实例                           │ │</span><br><span class="line">│ │ 2. tx.Statement.Model = &amp;User&#123;&#125;                             │ │</span><br><span class="line">│ │ 3. 设置 Table、Schema                                        │ │</span><br><span class="line">│ └─────────────────────────────────────────────────────────────┘ │</span><br><span class="line">  │</span><br><span class="line">  ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────────────┐</span><br><span class="line">│ Where(&quot;age &gt; ?&quot;, 18)                                             │</span><br><span class="line">│ ┌─────────────────────────────────────────────────────────────┐ │</span><br><span class="line">│ │ 1. getInstance() → 创建新 DB 实例                           │ │</span><br><span class="line">│ │ 2. BuildCondition(&quot;age &gt; ?&quot;, 18) → 构建表达式              │ │</span><br><span class="line">│ │ 3. AddClause(clause.Where&#123;Exprs: ...&#125;)                     │ │</span><br><span class="line">│ └─────────────────────────────────────────────────────────────┘ │</span><br><span class="line">  │</span><br><span class="line">  ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────────────┐</span><br><span class="line">│ Order(&quot;name&quot;)                                                    │</span><br><span class="line">│ ┌─────────────────────────────────────────────────────────────┐ │</span><br><span class="line">│ │ 1. getInstance() → 创建新 DB 实例                           │ │</span><br><span class="line">│ │ 2. AddClause(clause.OrderBy&#123;Columns: ...&#125;)                 │ │</span><br><span class="line">│ └─────────────────────────────────────────────────────────────┘ │</span><br><span class="line">  │</span><br><span class="line">  ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────────────┐</span><br><span class="line">│ Limit(10)                                                        │</span><br><span class="line">│ ┌─────────────────────────────────────────────────────────────┐ │</span><br><span class="line">│ │ 1. getInstance() → 创建新 DB 实例                           │ │</span><br><span class="line">│ │ 2. AddClause(clause.Limit&#123;Limit: &amp;10&#125;)                     │ │</span><br><span class="line">│ └─────────────────────────────────────────────────────────────┘ │</span><br><span class="line">  │</span><br><span class="line">  ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────────────┐</span><br><span class="line">│ Find(&amp;users)                                                     │</span><br><span class="line">│ ┌─────────────────────────────────────────────────────────────┐ │</span><br><span class="line">│ │ 1. getInstance() → 创建新 DB 实例                           │ │</span><br><span class="line">│ │ 2. tx.Statement.Dest = &amp;users                               │ │</span><br><span class="line">│ │ 3. 触发回调链执行                                           │ │</span><br><span class="line">│ │    → Build SQL                                             │ │</span><br><span class="line">│ │    → Execute Query                                         │ │</span><br><span class="line">│ │    → Scan Results                                          │ │</span><br><span class="line">│ └─────────────────────────────────────────────────────────────┘ │</span><br><span class="line">  │</span><br><span class="line">  ▼</span><br><span class="line">返回结果</span><br></pre></td></tr></table></figure>

<h4 id="概念-5-Finisher-API-完整实现"><a href="#概念-5-Finisher-API-完整实现" class="headerlink" title="概念 5: Finisher API 完整实现"></a>概念 5: Finisher API 完整实现</h4><p><strong>定义</strong>: Finisher API 是触发查询执行的终结方法，包括 Find、First、Create、Update、Delete 等。</p>
<p><strong>源码位置</strong>: <code>finisher_api.go</code></p>
<p><strong>核心方法完整解析</strong>:</p>
<h5 id="1-Find-查询多条记录"><a href="#1-Find-查询多条记录" class="headerlink" title="1. Find() - 查询多条记录"></a>1. Find() - 查询多条记录</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Find find all records that match given conditions</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> Find(dest <span class="keyword">interface</span>&#123;&#125;, conds ...<span class="keyword">interface</span>&#123;&#125;) (tx *DB) &#123;</span><br><span class="line">    tx = db.getInstance()                    <span class="comment">// 获取新实例</span></span><br><span class="line">    tx.Statement.Dest = dest                  <span class="comment">// 设置扫描目标</span></span><br><span class="line">    tx.Statement.AddClause(clause.Where&#123;&#125;)   <span class="comment">// 初始化 WHERE 子句</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果有额外条件，添加到 WHERE</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(conds) &gt; <span class="number">0</span> &#123;</span><br><span class="line">        exprs := tx.Statement.BuildCondition(conds[<span class="number">0</span>], conds[<span class="number">1</span>:]...)</span><br><span class="line">        tx.Statement.AddClause(clause.Where&#123;Exprs: exprs&#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用查询回调执行</span></span><br><span class="line">    <span class="keyword">return</span> tx.callbacks.Query().Execute(tx)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行流程</strong>:</p>
<ol>
<li>创建新的 DB 实例</li>
<li>设置目标变量（用于扫描结果）</li>
<li>构建条件表达式</li>
<li>触发 Query 回调链执行</li>
</ol>
<h5 id="2-First-查询单条记录"><a href="#2-First-查询单条记录" class="headerlink" title="2. First() - 查询单条记录"></a>2. First() - 查询单条记录</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// First find first record that match given conditions, order by primary key</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> First(dest <span class="keyword">interface</span>&#123;&#125;, conds ...<span class="keyword">interface</span>&#123;&#125;) (tx *DB) &#123;</span><br><span class="line">    tx = db.getInstance()</span><br><span class="line">    tx.Statement.Dest = dest</span><br><span class="line">    tx.Statement.AddClause(clause.Limit&#123;Limit: clause.Expr&#123;SQL: <span class="string">&quot;1&quot;</span>&#125;&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加主键排序</span></span><br><span class="line">    tx.Statement.AddClause(clause.OrderBy&#123;</span><br><span class="line">        Columns: []clause.OrderByColumn&#123;&#123;</span><br><span class="line">            Column: clause.Column&#123;Table: tx.Statement.Table, Name: clause.PrimaryKey&#125;,</span><br><span class="line">        &#125;&#125;,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(conds) &gt; <span class="number">0</span> &#123;</span><br><span class="line">        exprs := tx.Statement.BuildCondition(conds[<span class="number">0</span>], conds[<span class="number">1</span>:]...)</span><br><span class="line">        tx.Statement.AddClause(clause.Where&#123;Exprs: exprs&#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> tx.callbacks.Query().Execute(tx)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>特点</strong>: 自动添加 <code>LIMIT 1</code> 和主键排序</p>
<h5 id="3-Create-创建记录"><a href="#3-Create-创建记录" class="headerlink" title="3. Create() - 创建记录"></a>3. Create() - 创建记录</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Create insert the value into database</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> Create(value <span class="keyword">interface</span>&#123;&#125;) (tx *DB) &#123;</span><br><span class="line">    tx = db.getInstance()</span><br><span class="line">    tx.Statement.Dest = value</span><br><span class="line">    tx.Statement.AddClause(clause.Insert&#123;&#125;)  <span class="comment">// 添加 INSERT 子句</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置表名</span></span><br><span class="line">    <span class="keyword">if</span> tx.Statement.Table == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">        tx.Statement.Table = tx.Statement.Schema.Table</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> tx.callbacks.Create().Execute(tx)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="4-Update-更新记录"><a href="#4-Update-更新记录" class="headerlink" title="4. Update() - 更新记录"></a>4. Update() - 更新记录</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Update update attributes with callbacks, refer: https://gorm.io/docs/update</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> Update(column <span class="type">string</span>, value <span class="keyword">interface</span>&#123;&#125;) (tx *DB) &#123;</span><br><span class="line">    tx = db.getInstance()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构建更新表达式</span></span><br><span class="line">    tx.Statement.AddClause(clause.Set&#123;</span><br><span class="line">        []clause.Assignment&#123;</span><br><span class="line">            &#123;Column: clause.Column&#123;Name: column&#125;, Value: value&#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    tx.Statement.AddClause(clause.Where&#123;</span><br><span class="line">        Exprs: []clause.Expression&#123;</span><br><span class="line">            tx.Statement.BuildCondition(tx.Statement.Model, tx.Statement.clauseExpression(tx.Statement.PrimaryFields)...),</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> tx.callbacks.Update().Execute(tx)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="5-Delete-删除记录"><a href="#5-Delete-删除记录" class="headerlink" title="5. Delete() - 删除记录"></a>5. Delete() - 删除记录</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Delete delete value match given conditions</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> Delete(value <span class="keyword">interface</span>&#123;&#125;, conds ...<span class="keyword">interface</span>&#123;&#125;) (tx *DB) &#123;</span><br><span class="line">    tx = db.getInstance()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> value != <span class="literal">nil</span> &#123;</span><br><span class="line">        tx.Statement.Dest = value</span><br><span class="line">        tx.Statement.AddClause(clause.Where&#123;</span><br><span class="line">            Exprs: []clause.Expression&#123;</span><br><span class="line">                tx.Statement.BuildCondition(value),</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(conds) &gt; <span class="number">0</span> &#123;</span><br><span class="line">        exprs := tx.Statement.BuildCondition(conds[<span class="number">0</span>], conds[<span class="number">1</span>:]...)</span><br><span class="line">        tx.Statement.AddClause(clause.Where&#123;Exprs: exprs&#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> tx.callbacks.Delete().Execute(tx)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Finisher API 执行流程对比</strong>:</p>
<table>
<thead>
<tr>
<th>方法</th>
<th>目标设置</th>
<th>添加子句</th>
<th>回调类型</th>
<th>返回</th>
</tr>
</thead>
<tbody><tr>
<td>Find</td>
<td>Dest</td>
<td>Where</td>
<td>Query</td>
<td>*DB</td>
</tr>
<tr>
<td>First</td>
<td>Dest</td>
<td>Limit + OrderBy + Where</td>
<td>Query</td>
<td>*DB</td>
</tr>
<tr>
<td>Create</td>
<td>Dest</td>
<td>Insert</td>
<td>Create</td>
<td>*DB</td>
</tr>
<tr>
<td>Update</td>
<td>-</td>
<td>Set + Where</td>
<td>Update</td>
<td>*DB</td>
</tr>
<tr>
<td>Delete</td>
<td>Dest</td>
<td>Where</td>
<td>Delete</td>
<td>*DB</td>
</tr>
</tbody></table>
<h3 id="2-2-理论基础"><a href="#2-2-理论基础" class="headerlink" title="2.2 理论基础"></a>2.2 理论基础</h3><h4 id="理论-1-Builder-模式"><a href="#理论-1-Builder-模式" class="headerlink" title="理论 1: Builder 模式"></a>理论 1: Builder 模式</h4><p><strong>模式定义</strong>: 将复杂对象的构建与表示分离，使得同样的构建过程可以创建不同的表示。</p>
<p><strong>在查询构建中的体现</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">传统方式:</span><br><span class="line">user := User&#123;&#125;</span><br><span class="line">db.Select(&quot;name&quot;).Where(&quot;age &gt; ?&quot;, 18).Find(&amp;user)</span><br><span class="line"></span><br><span class="line">Builder 模式:</span><br><span class="line">query := db.Model(&amp;User&#123;&#125;)</span><br><span class="line">query = query.Select(&quot;name&quot;)</span><br><span class="line">query = query.Where(&quot;age &gt; ?&quot;, 18)</span><br><span class="line">query.Find(&amp;user)</span><br></pre></td></tr></table></figure>

<p><strong>优势</strong>:</p>
<ul>
<li>分步构建，逻辑清晰</li>
<li>可以复用部分配置</li>
<li>支持条件判断添加</li>
</ul>
<h4 id="理论-2-延迟执行模式"><a href="#理论-2-延迟执行模式" class="headerlink" title="理论 2: 延迟执行模式"></a>理论 2: 延迟执行模式</h4><p><strong>模式定义</strong>: 延迟执行是指操作不会立即执行，而是在某个合适的时机才真正执行。</p>
<p><strong>在查询构建中的体现</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 配置阶段 - 不执行查询</span></span><br><span class="line">query := db.Model(&amp;User&#123;&#125;).</span><br><span class="line">    Where(<span class="string">&quot;age &gt; ?&quot;</span>, <span class="number">18</span>).</span><br><span class="line">    Order(<span class="string">&quot;name&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行阶段 - 真正执行</span></span><br><span class="line">query.Find(&amp;users)</span><br></pre></td></tr></table></figure>

<p><strong>延迟执行的好处</strong>:</p>
<ol>
<li><strong>优化</strong>: 可以在执行前收集所有配置，一次性优化</li>
<li><strong>灵活性</strong>: 可以根据条件决定是否添加某个条件</li>
<li><strong>安全性</strong>: DryRun 模式下可以不执行</li>
</ol>
<p><strong>实现机制</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 链式 API 只配置，不执行</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> Where(query <span class="keyword">interface</span>&#123;&#125;, args ...<span class="keyword">interface</span>&#123;&#125;) *DB &#123;</span><br><span class="line">    tx := db.getInstance()</span><br><span class="line">    tx.Statement.AddClause(clause.Where&#123;...&#125;)</span><br><span class="line">    <span class="keyword">return</span> tx  <span class="comment">// 只返回，不执行</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Finisher 触发执行</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> Find(dest <span class="keyword">interface</span>&#123;&#125;, conds ...<span class="keyword">interface</span>&#123;&#125;) *DB &#123;</span><br><span class="line">    tx := db.getInstance()</span><br><span class="line">    tx.Statement.Dest = dest</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">return</span> tx.callbacks.Query().Execute(tx)  <span class="comment">// 执行</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="理论-3-不可变对象模式"><a href="#理论-3-不可变对象模式" class="headerlink" title="理论 3: 不可变对象模式"></a>理论 3: 不可变对象模式</h4><p><strong>模式定义</strong>: 创建后状态不能修改的对象，每次修改返回新对象。</p>
<p><strong>在查询构建中的部分应用</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 原始 DB 不被修改</span></span><br><span class="line">db1 := db.Model(&amp;User&#123;&#125;)</span><br><span class="line">db2 := db1.Where(<span class="string">&quot;age &gt; ?&quot;</span>, <span class="number">18</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// db1 仍然保持原状态</span></span><br><span class="line"><span class="comment">// db2 有新的 Where 条件</span></span><br></pre></td></tr></table></figure>

<p><strong>优势</strong>:</p>
<ul>
<li>避免意外修改</li>
<li>支持并发使用</li>
<li>易于推理</li>
</ul>
<p><strong>权衡</strong>:</p>
<ul>
<li>创建新对象有开销</li>
<li>通过共享 Statement 优化</li>
</ul>
<h3 id="2-3-学习方法"><a href="#2-3-学习方法" class="headerlink" title="2.3 学习方法"></a>2.3 学习方法</h3><h4 id="方法-1-调用追踪法"><a href="#方法-1-调用追踪法" class="headerlink" title="方法 1: 调用追踪法"></a>方法 1: 调用追踪法</h4><p><strong>工具</strong>: IDE 的调试功能</p>
<p><strong>步骤</strong>:</p>
<ol>
<li>设置断点在 Find() 方法</li>
<li>运行查询</li>
<li>查看调用栈</li>
<li>观察每一步的状态变化</li>
</ol>
<p><strong>关键观察点</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 观察点 1: Where() 中</span></span><br><span class="line">tx.Statement.Clauses[<span class="string">&quot;WHERE&quot;</span>]  <span class="comment">// 查看 WHERE 子句</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 观察点 2: Find() 中</span></span><br><span class="line">tx.Statement.Dest             <span class="comment">// 查看目标</span></span><br><span class="line">tx.Statement.SQL.String()     <span class="comment">// 查看生成的 SQL</span></span><br><span class="line">tx.Statement.Vars             <span class="comment">// 查看参数</span></span><br></pre></td></tr></table></figure>

<h4 id="方法-2-对比实验法"><a href="#方法-2-对比实验法" class="headerlink" title="方法 2: 对比实验法"></a>方法 2: 对比实验法</h4><p><strong>对比不同调用方式的效果</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 方式 1: 链式调用</span></span><br><span class="line">users := []User&#123;&#125;</span><br><span class="line">db.Where(<span class="string">&quot;age &gt; ?&quot;</span>, <span class="number">18</span>).Order(<span class="string">&quot;name&quot;</span>).Find(&amp;users)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方式 2: 分步调用</span></span><br><span class="line">query := db.Model(&amp;User&#123;&#125;)</span><br><span class="line">query = query.Where(<span class="string">&quot;age &gt; ?&quot;</span>, <span class="number">18</span>)</span><br><span class="line">query = query.Order(<span class="string">&quot;name&quot;</span>)</span><br><span class="line">query.Find(&amp;users)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 对比: 两种方式效果相同</span></span><br></pre></td></tr></table></figure>

<p><strong>对比不同条件形式</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 字符串形式</span></span><br><span class="line">db.Where(<span class="string">&quot;age &gt; ? AND name = ?&quot;</span>, <span class="number">18</span>, <span class="string">&quot;John&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// map 形式</span></span><br><span class="line">db.Where(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">    <span class="string">&quot;age &gt; ?&quot;</span>: <span class="number">18</span>,</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;John&quot;</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 结构体形式</span></span><br><span class="line">db.Where(User&#123;Age: <span class="number">18</span>, Name: <span class="string">&quot;John&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 对比: 生成的 SQL 相同</span></span><br></pre></td></tr></table></figure>

<h3 id="2-4-实施策略"><a href="#2-4-实施策略" class="headerlink" title="2.4 实施策略"></a>2.4 实施策略</h3><h4 id="策略-1-渐进式学习"><a href="#策略-1-渐进式学习" class="headerlink" title="策略 1: 渐进式学习"></a>策略 1: 渐进式学习</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">第 1 阶段: 简单查询 (Day 1)</span><br><span class="line">  db.Find(&amp;users)</span><br><span class="line">  db.First(&amp;user)</span><br><span class="line">  db.Where(&quot;age &gt; ?&quot;, 18).Find(&amp;users)</span><br><span class="line"></span><br><span class="line">第 2 阶段: 复杂查询 (Day 2)</span><br><span class="line">  db.Joins(&quot;Company&quot;).Find(&amp;users)</span><br><span class="line">  db.Preload(&quot;Orders&quot;).Find(&amp;users)</span><br><span class="line">  db.Scopes(AgeGT(18)).Find(&amp;users)</span><br><span class="line"></span><br><span class="line">第 3 阶段: 高级查询 (Day 3-4)</span><br><span class="line">  子查询、分组、聚合</span><br><span class="line">  动态条件构建</span><br><span class="line">  性能优化</span><br></pre></td></tr></table></figure>

<h4 id="策略-2-问题驱动"><a href="#策略-2-问题驱动" class="headerlink" title="策略 2: 问题驱动"></a>策略 2: 问题驱动</h4><p><strong>问题序列</strong>:</p>
<ol>
<li><p>链式调用为什么不修改原对象？</p>
<ul>
<li>测试原对象在调用后的状态</li>
<li>理解不可变性的价值</li>
</ul>
</li>
<li><p>如何动态构建查询？</p>
<ul>
<li>实现带条件的查询构建器</li>
<li>理解延迟执行的优势</li>
</ul>
</li>
<li><p>如何优化复杂查询？</p>
<ul>
<li>分析生成的 SQL</li>
<li>测试不同写法的性能</li>
</ul>
</li>
</ol>
<h4 id="策略-3-验证反馈"><a href="#策略-3-验证反馈" class="headerlink" title="策略 3: 验证反馈"></a>策略 3: 验证反馈</h4><p><strong>验证点 1: 链式调用验证</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestChaining</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">    original := db.Model(&amp;User&#123;&#125;)</span><br><span class="line">    chained := original.Where(<span class="string">&quot;age &gt; ?&quot;</span>, <span class="number">18</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 验证原对象不变</span></span><br><span class="line">    _, ok1 := original.Statement.Clauses[<span class="string">&quot;WHERE&quot;</span>]</span><br><span class="line">    assert.False(t, ok1)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 验证新对象有条件</span></span><br><span class="line">    _, ok2 := chained.Statement.Clauses[<span class="string">&quot;WHERE&quot;</span>]</span><br><span class="line">    assert.True(t, ok2)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="四、实战代码示例"><a href="#四、实战代码示例" class="headerlink" title="四、实战代码示例"></a>四、实战代码示例</h2><h3 id="4-1-基础查询示例"><a href="#4-1-基础查询示例" class="headerlink" title="4.1 基础查询示例"></a>4.1 基础查询示例</h3><h4 id="示例-1-简单查询"><a href="#示例-1-简单查询" class="headerlink" title="示例 1: 简单查询"></a>示例 1: 简单查询</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;gorm.io/driver/mysql&quot;</span></span><br><span class="line">    <span class="string">&quot;gorm.io/gorm&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">    ID    <span class="type">uint</span></span><br><span class="line">    Name  <span class="type">string</span></span><br><span class="line">    Email <span class="type">string</span></span><br><span class="line">    Age   <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    db, _ := gorm.Open(mysql.Open(<span class="string">&quot;dsn&quot;</span>), &amp;gorm.Config&#123;&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查询所有用户</span></span><br><span class="line">    <span class="keyword">var</span> users []User</span><br><span class="line">    db.Find(&amp;users)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 条件查询</span></span><br><span class="line">    db.Where(<span class="string">&quot;age &gt; ?&quot;</span>, <span class="number">18</span>).Find(&amp;users)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 单条查询</span></span><br><span class="line">    <span class="keyword">var</span> user User</span><br><span class="line">    db.First(&amp;user, <span class="number">1</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="示例-2-链式查询"><a href="#示例-2-链式查询" class="headerlink" title="示例 2: 链式查询"></a>示例 2: 链式查询</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 复杂链式查询</span></span><br><span class="line">db.Model(&amp;User&#123;&#125;).</span><br><span class="line">    Where(<span class="string">&quot;age &gt; ?&quot;</span>, <span class="number">18</span>).</span><br><span class="line">    Where(<span class="string">&quot;status = ?&quot;</span>, <span class="string">&quot;active&quot;</span>).</span><br><span class="line">    Order(<span class="string">&quot;created_at DESC&quot;</span>).</span><br><span class="line">    Limit(<span class="number">10</span>).</span><br><span class="line">    Offset(<span class="number">20</span>).</span><br><span class="line">    Find(&amp;users)</span><br></pre></td></tr></table></figure>

<h3 id="4-2-动态查询构建"><a href="#4-2-动态查询构建" class="headerlink" title="4.2 动态查询构建"></a>4.2 动态查询构建</h3><h4 id="示例-3-条件式查询"><a href="#示例-3-条件式查询" class="headerlink" title="示例 3: 条件式查询"></a>示例 3: 条件式查询</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 动态构建查询</span></span><br><span class="line">query := db.Model(&amp;User&#123;&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据条件动态添加 WHERE</span></span><br><span class="line"><span class="keyword">if</span> name := r.URLParam(<span class="string">&quot;name&quot;</span>); name != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">    query = query.Where(<span class="string">&quot;name = ?&quot;</span>, name)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> minAge := r.URLParam(<span class="string">&quot;min_age&quot;</span>); minAge != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">    query = query.Where(<span class="string">&quot;age &gt;= ?&quot;</span>, minAge)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> status := r.URLParam(<span class="string">&quot;status&quot;</span>); status != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">    query = query.Where(<span class="string">&quot;status = ?&quot;</span>, status)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行查询</span></span><br><span class="line">query.Find(&amp;users)</span><br></pre></td></tr></table></figure>

<h3 id="4-3-高级查询示例"><a href="#4-3-高级查询示例" class="headerlink" title="4.3 高级查询示例"></a>4.3 高级查询示例</h3><h4 id="示例-4-使用-Scopes-复用查询逻辑"><a href="#示例-4-使用-Scopes-复用查询逻辑" class="headerlink" title="示例 4: 使用 Scopes 复用查询逻辑"></a>示例 4: 使用 Scopes 复用查询逻辑</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义 Scope</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">AgeGreaterThan</span><span class="params">(age <span class="type">int</span>)</span></span> <span class="function"><span class="keyword">func</span><span class="params">(db *gorm.DB)</span></span> *gorm.DB &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(db *gorm.DB)</span></span> *gorm.DB &#123;</span><br><span class="line">        <span class="keyword">return</span> db.Where(<span class="string">&quot;age &gt; ?&quot;</span>, age)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ActiveUsers</span><span class="params">(db *gorm.DB)</span></span> *gorm.DB &#123;</span><br><span class="line">    <span class="keyword">return</span> db.Where(<span class="string">&quot;status = ?&quot;</span>, <span class="string">&quot;active&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 Scope</span></span><br><span class="line">db.Scopes(AgeGreaterThan(<span class="number">18</span>), ActiveUsers).Find(&amp;users)</span><br></pre></td></tr></table></figure>

<h4 id="示例-5-子查询"><a href="#示例-5-子查询" class="headerlink" title="示例 5: 子查询"></a>示例 5: 子查询</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用子查询</span></span><br><span class="line"><span class="keyword">var</span> users []User</span><br><span class="line">db.Where(<span class="string">&quot;age &gt; (?)&quot;</span>, db.Model(&amp;User&#123;&#125;).</span><br><span class="line">    Select(<span class="string">&quot;AVG(age)&quot;</span>).</span><br><span class="line">    Where(<span class="string">&quot;status = ?&quot;</span>, <span class="string">&quot;active&quot;</span>)).</span><br><span class="line">    SubQuery()).</span><br><span class="line">Find(&amp;users)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生成 SQL:</span></span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE age &gt; (SELECT AVG(age) FROM users WHERE status = &#x27;active&#x27;)</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="五、最佳实践与故障排查"><a href="#五、最佳实践与故障排查" class="headerlink" title="五、最佳实践与故障排查"></a>五、最佳实践与故障排查</h2><h3 id="5-1-查询构建最佳实践"><a href="#5-1-查询构建最佳实践" class="headerlink" title="5.1 查询构建最佳实践"></a>5.1 查询构建最佳实践</h3><h4 id="1-使用-Model-指定表"><a href="#1-使用-Model-指定表" class="headerlink" title="1. 使用 Model 指定表"></a>1. 使用 Model 指定表</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 推荐</span></span><br><span class="line">db.Model(&amp;User&#123;&#125;).Where(<span class="string">&quot;age &gt; ?&quot;</span>, <span class="number">18</span>).Find(&amp;users)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 不推荐（容易出错）</span></span><br><span class="line">db.Table(<span class="string">&quot;users&quot;</span>).Where(<span class="string">&quot;age &gt; ?&quot;</span>, <span class="number">18</span>).Find(&amp;users)</span><br></pre></td></tr></table></figure>

<h4 id="2-避免全局更新"><a href="#2-避免全局更新" class="headerlink" title="2. 避免全局更新"></a>2. 避免全局更新</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 危险：会更新所有记录</span></span><br><span class="line">db.Model(&amp;User&#123;&#125;).Update(<span class="string">&quot;status&quot;</span>, <span class="string">&quot;inactive&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 安全：添加条件</span></span><br><span class="line">db.Model(&amp;User&#123;&#125;).Where(<span class="string">&quot;status = ?&quot;</span>, <span class="string">&quot;active&quot;</span>).Update(<span class="string">&quot;status&quot;</span>, <span class="string">&quot;inactive&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 或者使用 Session 允许全局更新</span></span><br><span class="line">db.Session(&amp;gorm.Session&#123;AllowGlobalUpdate: <span class="literal">true</span>&#125;).</span><br><span class="line">    Model(&amp;User&#123;&#125;).</span><br><span class="line">    Update(<span class="string">&quot;status&quot;</span>, <span class="string">&quot;inactive&quot;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="3-使用-Preload-预加载关联"><a href="#3-使用-Preload-预加载关联" class="headerlink" title="3. 使用 Preload 预加载关联"></a>3. 使用 Preload 预加载关联</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// N+1 查询问题</span></span><br><span class="line">users := []User&#123;&#125;</span><br><span class="line">db.Find(&amp;users)                    <span class="comment">// 1 次查询</span></span><br><span class="line"><span class="keyword">for</span> _, user := <span class="keyword">range</span> users &#123;</span><br><span class="line">    db.Model(&amp;user).Related(&amp;orders)  <span class="comment">// N 次查询</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 Preload 解决</span></span><br><span class="line">db.Preload(<span class="string">&quot;Orders&quot;</span>).Find(&amp;users)  <span class="comment">// 2 次查询（1 + 1）</span></span><br></pre></td></tr></table></figure>

<h3 id="5-2-常见问题与解决方案"><a href="#5-2-常见问题与解决方案" class="headerlink" title="5.2 常见问题与解决方案"></a>5.2 常见问题与解决方案</h3><h4 id="问题-1-查询条件不生效"><a href="#问题-1-查询条件不生效" class="headerlink" title="问题 1: 查询条件不生效"></a>问题 1: 查询条件不生效</h4><p><strong>症状</strong>: 添加的 WHERE 条件没有生效</p>
<p><strong>原因</strong>: 使用了错误的链式调用顺序</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 错误：Find() 后再调用 Where 不会生效</span></span><br><span class="line">db.Find(&amp;users).Where(<span class="string">&quot;age &gt; ?&quot;</span>, <span class="number">18</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 正确：先调用 Where，再调用 Find</span></span><br><span class="line">db.Where(<span class="string">&quot;age &gt; ?&quot;</span>, <span class="number">18</span>).Find(&amp;users)</span><br></pre></td></tr></table></figure>

<h4 id="问题-2-更新失败"><a href="#问题-2-更新失败" class="headerlink" title="问题 2: 更新失败"></a>问题 2: 更新失败</h4><p><strong>症状</strong>: Update 没有更新任何记录</p>
<p><strong>原因</strong>: 缺少主键或 WHERE 条件</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 错误：没有主键</span></span><br><span class="line">user := User&#123;Name: <span class="string">&quot;John&quot;</span>, Age: <span class="number">30</span>&#125;</span><br><span class="line">db.Model(&amp;user).Update(<span class="string">&quot;age&quot;</span>, <span class="number">31</span>)  <span class="comment">// 不会更新任何记录</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 正确：先查询再更新</span></span><br><span class="line">db.First(&amp;user, <span class="number">1</span>)</span><br><span class="line">db.Model(&amp;user).Update(<span class="string">&quot;age&quot;</span>, <span class="number">31</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 或者使用 Where</span></span><br><span class="line">db.Model(&amp;User&#123;&#125;).Where(<span class="string">&quot;name = ?&quot;</span>, <span class="string">&quot;John&quot;</span>).Update(<span class="string">&quot;age&quot;</span>, <span class="number">31</span>)</span><br></pre></td></tr></table></figure>

<h4 id="问题-3-结构体条件只查询非零值"><a href="#问题-3-结构体条件只查询非零值" class="headerlink" title="问题 3: 结构体条件只查询非零值"></a>问题 3: 结构体条件只查询非零值</h4><p><strong>症状</strong>: 使用结构体作为条件时，零值字段被忽略</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 问题：Age = 0 会被忽略</span></span><br><span class="line">db.Where(User&#123;Name: <span class="string">&quot;John&quot;</span>, Age: <span class="number">0</span>&#125;).First(&amp;user)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 解决方案 1: 使用 map</span></span><br><span class="line">db.Where(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;John&quot;</span>, <span class="string">&quot;age&quot;</span>: <span class="number">0</span>&#125;).First(&amp;user)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 解决方案 2: 使用指针</span></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">    Name <span class="type">string</span></span><br><span class="line">    Age  *<span class="type">int</span>  <span class="comment">// 使用指针</span></span><br><span class="line">&#125;</span><br><span class="line">age := <span class="number">0</span></span><br><span class="line">db.Where(User&#123;Name: <span class="string">&quot;John&quot;</span>, Age: &amp;age&#125;).First(&amp;user)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="六、学习验证"><a href="#六、学习验证" class="headerlink" title="六、学习验证"></a>六、学习验证</h2><h3 id="6-1-知识自测"><a href="#6-1-知识自测" class="headerlink" title="6.1 知识自测"></a>6.1 知识自测</h3><h4 id="基础题"><a href="#基础题" class="headerlink" title="基础题"></a>基础题</h4><ol>
<li><p><strong>以下哪个是 Finisher API？</strong></p>
<ul>
<li>A. Where()</li>
<li>B. Select()</li>
<li>C. Find()</li>
<li>D. Order()</li>
</ul>
</li>
<li><p><strong>链式 API 的返回值是什么？</strong></p>
<ul>
<li>A. *gorm.DB</li>
<li>B. error</li>
<li>C. int64</li>
<li>D. bool</li>
</ul>
</li>
<li><p><strong>First() 方法会自动添加什么？</strong></p>
<ul>
<li>A. WHERE</li>
<li>B. LIMIT 1</li>
<li>C. ORDER BY</li>
<li>D. LIMIT 1 和 ORDER BY</li>
</ul>
</li>
</ol>
<h4 id="进阶题"><a href="#进阶题" class="headerlink" title="进阶题"></a>进阶题</h4><ol start="4">
<li><p><strong>以下代码会产生几次查询？</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.Preload(<span class="string">&quot;Orders&quot;</span>).Preload(<span class="string">&quot;Profile&quot;</span>).Find(&amp;users)</span><br></pre></td></tr></table></figure>
<ul>
<li>A. 1 次</li>
<li>B. 2 次</li>
<li>C. 3 次</li>
<li>D. 4 次</li>
</ul>
</li>
<li><p><strong>如何实现动态查询？</strong></p>
<ul>
<li>使用 Scope</li>
<li>使用条件判断</li>
<li>使用 map 作为条件</li>
<li>以上都可以</li>
</ul>
</li>
</ol>
<h3 id="6-2-实践练习"><a href="#6-2-实践练习" class="headerlink" title="6.2 实践练习"></a>6.2 实践练习</h3><h4 id="练习-1-实现分页查询"><a href="#练习-1-实现分页查询" class="headerlink" title="练习 1: 实现分页查询"></a>练习 1: 实现分页查询</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 实现 Paginate 函数</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Paginate</span><span class="params">(db *gorm.DB, page, pageSize <span class="type">int</span>)</span></span> *gorm.DB &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> 实现 Limit 和 Offset</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="练习-2-实现软删除查询"><a href="#练习-2-实现软删除查询" class="headerlink" title="练习 2: 实现软删除查询"></a>练习 2: 实现软删除查询</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 实现只查询未删除记录的 Scope</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NotDeleted</span><span class="params">(db *gorm.DB)</span></span> *gorm.DB &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> 添加 deleted_at IS NULL 条件</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="三、学习路径建议"><a href="#三、学习路径建议" class="headerlink" title="三、学习路径建议"></a>三、学习路径建议</h2><h3 id="3-1-前置知识检查"><a href="#3-1-前置知识检查" class="headerlink" title="3.1 前置知识检查"></a>3.1 前置知识检查</h3><table>
<thead>
<tr>
<th>知识点</th>
<th>要求</th>
<th>检验方式</th>
</tr>
</thead>
<tbody><tr>
<td>方法链</td>
<td>理解返回值传递</td>
<td>能设计简单链式 API</td>
</tr>
<tr>
<td>SQL 基础</td>
<td>熟悉 SELECT&#x2F;INSERT&#x2F;UPDATE&#x2F;DELETE</td>
<td>能写出复杂查询</td>
</tr>
<tr>
<td>反射基础</td>
<td>理解反射获取字段值</td>
<td>能遍历结构体字段</td>
</tr>
</tbody></table>
<h3 id="3-2-学习时间分配"><a href="#3-2-学习时间分配" class="headerlink" title="3.2 学习时间分配"></a>3.2 学习时间分配</h3><table>
<thead>
<tr>
<th>内容</th>
<th>理论</th>
<th>实践</th>
<th>产出</th>
</tr>
</thead>
<tbody><tr>
<td>Day 1: 链式 API</td>
<td>2h</td>
<td>1.5h</td>
<td>调用流程图</td>
</tr>
<tr>
<td>Day 2: 条件构建</td>
<td>1.5h</td>
<td>2h</td>
<td>条件形式对比</td>
</tr>
<tr>
<td>Day 3: Finisher</td>
<td>2h</td>
<td>1.5h</td>
<td>执行流程图</td>
</tr>
<tr>
<td>Day 4: 高级特性</td>
<td>1.5h</td>
<td>2h</td>
<td>优化示例</td>
</tr>
</tbody></table>
<h3 id="3-3-学习成果验收"><a href="#3-3-学习成果验收" class="headerlink" title="3.3 学习成果验收"></a>3.3 学习成果验收</h3><p><strong>理论验收</strong>:</p>
<ul>
<li><input disabled="" type="checkbox"> 能解释链式调用的实现</li>
<li><input disabled="" type="checkbox"> 能说明 Statement 的作用</li>
<li><input disabled="" type="checkbox"> 能区分 Chainable 和 Finisher API</li>
</ul>
<p><strong>实践验收</strong>:</p>
<ul>
<li><input disabled="" type="checkbox"> 能构建复杂查询</li>
<li><input disabled="" type="checkbox"> 能优化查询性能</li>
<li><input disabled="" type="checkbox"> 能实现自定义查询方法</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a target="_blank" rel="noopener" href="https://github.com/Piwriw">Joohwan.</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://piwriw.github.io/2026/01/11/web/gorm/02-query-builder/">https://piwriw.github.io/2026/01/11/web/gorm/02-query-builder/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://piwriw.github.io" target="_blank">Joohwan</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/web/">web</a><a class="post-meta__tags" href="/tags/Gorm/">Gorm</a><a class="post-meta__tags" href="/tags/%E6%BA%90%E7%A0%81/">源码</a></div><div class="post-share"><div class="social-share" data-image="/img/go.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>赞助</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2026/01/11/web/gorm/03-schema/" title="Gorm-Schema 数据映射模块原理说明"><img class="cover" src="/img/go.png" onerror="onerror=null;src='/img/404.png'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">Gorm-Schema 数据映射模块原理说明</div></div><div class="info-2"><div class="info-item-1">Schema 数据映射模块原理说明 基于1.31 本文档深入解析 Schema 数据映射模块的设计原理和核心原理，涵盖元数据管理、类型映射、关系解析等核心概念。   一、设计原理1.1 模块定位在整体架构中的位置 Schema 模块是 GORM 的”元数据层”，位于连接管理之上、查询构建之下，承担着连接 Go 世界与数据库世界的桥梁作用。 12345678910111213141516171819┌─────────────────────────────────────────────────────────────┐│                      Go 语言世界                              ││                   type User struct &#123; ... &#125;                    │└────────────────────────┬────────────────────────────────────┘                         │ 反射解析    ...</div></div></div></a><a class="pagination-related" href="/2026/01/11/web/gorm/01-connection/" title="Gorm-连接管理模块原理说明"><img class="cover" src="/img/go.png" onerror="onerror=null;src='/img/404.png'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">Gorm-连接管理模块原理说明</div></div><div class="info-2"><div class="info-item-1">连接管理模块原理说明 基于1.31 本文档深入解析连接管理模块的设计原理和核心原理，为学习者提供系统性的理论支撑。   一、设计原理1.1 模块定位在整体架构中的位置 连接管理模块位于 GORM 架构的最底层，是整个框架与数据库交互的入口点。它在整体架构中的定位可以概括为： 123456789101112131415161718192021222324252627┌─────────────────────────────────────────────────────────────┐│                    应用层 (用户代码)                          │└────────────────────────┬────────────────────────────────────┘                         │                         ▼┌─────────────────────────────────────────────────────────────┐│              ...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2026/01/11/web/gorm/09-logger/" title="Gorm-日志系统模块原理说明"><img class="cover" src="/img/go.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-01-11</div><div class="info-item-2">Gorm-日志系统模块原理说明</div></div><div class="info-2"><div class="info-item-1">日志系统模块原理说明 基于1.31 本文档深入解析日志系统模块的设计原理和核心实现，涵盖 SQL 日志记录、性能分析、调用栈追踪等核心内容。学习完本文档后，您将能够彻底理解 GORM 日志系统的工作机制，并能够实现自定义 Logger 来满足各种日志需求。  文档目录12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394959697989910010110210310410510610710810911011111211311411511611711811912012112212312412512612712812913013113213313413513613713813914009-logger.md├── 一、设计原理│   ├── 1.1 模块定位│   ├── 1.2 设...</div></div></div></a><a class="pagination-related" href="/2026/01/11/web/gorm/08-migration/" title="Gorm-迁移功能模块原理说明"><img class="cover" src="/img/go.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-01-11</div><div class="info-item-2">Gorm-迁移功能模块原理说明</div></div><div class="info-2"><div class="info-item-1">迁移功能模块原理说明 基于1.31 本文档深入解析迁移功能模块的设计原理和核心实现，涵盖数据库结构管理、类型映射、约束管理等核心内容。学习完本文档后，您将能够彻底理解 GORM 迁移系统的工作机制，并能够在实际项目中安全高效地进行数据库迁移。  文档目录1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798991001011021031041051061071081091101111121131141151161171181191201211221231241251261271281291301311321331341351361371381391401411421431441451461471481491501511521531541551561571581591...</div></div></div></a><a class="pagination-related" href="/2026/01/11/web/gorm/10-plugin/" title="Gorm-插件系统模块原理说明"><img class="cover" src="/img/go.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-01-11</div><div class="info-item-2">Gorm-插件系统模块原理说明</div></div><div class="info-2"><div class="info-item-1">插件系统模块原理说明 基于1.31 本文档深入解析插件系统模块的设计原理和核心实现，涵盖扩展机制、插件开发、集成模式等核心内容。  目录 一、设计原理 1.1 模块定位 1.2 设计目的 1.3 结构安排依据 1.4 与其他模块的逻辑关系 1.5 插件类型分类   二、核心数据结构 2.1 Plugin 接口 2.2 Config 插件字段 2.3 Use() 方法   三、核心实现 3.1 插件注册机制 3.2 插件初始化流程 3.3 回调系统集成 3.4 插件状态管理   四、实战代码示例 4.1 基础插件开发 4.2 读写分离插件 4.3 查询缓存插件 4.4 性能监控插件 4.5 数据脱敏插件   五、可视化流程图 5.1 插件注册流程 5.2 插件初始化流程 5.3 回调集成流程 5.4 插件系统架构   六、最佳实践与故障排查 6.1 开发最佳实践 6.2 常见问题与解决方案 6.3 性能优化建议 6.4 安全建议   七、学习验证 7.1 知识自测 7.2 实践练习     一、设计原理1.1 模块定位在整体架构中的位置 插件系统是 GORM 的扩展机制，位于应用层...</div></div></div></a><a class="pagination-related" href="/2026/01/11/web/gorm/07-transaction/" title="Gorm-事务处理模块原理说明"><img class="cover" src="/img/go.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-01-11</div><div class="info-item-2">Gorm-事务处理模块原理说明</div></div><div class="info-2"><div class="info-item-1">事务处理模块原理说明 基于1.31 本文档深入解析事务处理模块的设计原理和核心实现，涵盖事务管理、嵌套事务、保存点机制等核心内容。通过阅读本文档，您将能够完全理解 GORM 事务处理模块的工作原理，无需额外阅读源码。   目录 一、设计原理 1.1 模块定位 1.2 设计目的 1.3 结构安排依据 1.4 与其他模块的逻辑关系   二、核心数据结构 2.1 事务相关接口 2.2 TxOptions 配置   三、事务核心实现 3.1 Transaction 函数完整实现 3.2 Begin 函数完整实现 3.3 Commit 和 Rollback 实现 3.4 SavePoint 和 RollbackTo 实现 3.5 事务执行流程图   四、默认事务机制 4.1 BeginTransaction 实现 4.2 CommitOrRollbackTransaction 实现 4.3 回调注册流程 4.4 默认事务流程图   五、实战代码示例 5.1 基础事务使用 5.2 嵌套事务使用 5.3 手动事务控制 5.4 保存点使用 5.5 隔离级别配置 5.6 复杂业务场景   六、最佳...</div></div></div></a><a class="pagination-related" href="/2026/01/11/web/gorm/06-associations/" title="Gorm-关联关系模块原理说明"><img class="cover" src="/img/go.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-01-11</div><div class="info-item-2">Gorm-关联关系模块原理说明</div></div><div class="info-2"><div class="info-item-1">关联关系模块原理说明  基于1.31 本文档深入解析关联关系模块的设计原理和核心实现，涵盖关系推断、预加载机制、N+1 问题解决、Association API 等核心内容。通过阅读本文档，您将能够完全理解 GORM 关联关系模块的工作原理，无需额外阅读源码。   目录 一、设计原理 1.1 模块定位 1.2 设计目的 1.3 结构安排依据 1.4 与其他模块的逻辑关系   二、核心数据结构 2.1 Relationship 结构完整解析 2.2 Relationships 结构 2.3 Reference 结构 2.4 Polymorphic 结构   三、关系推断机制 3.1 parseRelation 函数完整实现 3.2 guessRelation 函数完整实现 3.3 buildPolymorphicRelation 实现 3.4 buildMany2ManyRelation 实现 3.5 关系推断决策树   四、预加载机制 4.1 preloadEntryPoint 完整实现 4.2 preload 函数完整实现 4.3 Preload 执行流程图 4.4 嵌套预加载...</div></div></div></a><a class="pagination-related" href="/2026/01/11/web/gorm/05-callback/" title="Gorm-回调钩子模块原理说明"><img class="cover" src="/img/go.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-01-11</div><div class="info-item-2">Gorm-回调钩子模块原理说明</div></div><div class="info-2"><div class="info-item-1">回调钩子模块原理说明 基于1.31 本文档深入解析回调钩子模块的设计原理和核心原理，涵盖事件驱动机制、责任链模式、钩子注册与执行等核心内容。   一、设计原理1.1 模块定位在整体架构中的位置 回调钩子模块是 GORM 的事件驱动层，位于查询构建和 SQL 执行之间，负责在数据操作的生命周期中插入自定义逻辑。 1234567891011121314151617181920212223242526272829303132333435┌─────────────────────────────────────────────────────────────┐│                    Finisher API                              ││                      db.Find(&amp;users)                         │└────────────────────────┬────────────────────────────────────┘                      ...</div></div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Joohwan.</div><div class="author-info-description">该知道的都知道，不知道的慢慢了解</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">259</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">76</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">60</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/piwriw"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/piwriw" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:piwriw@163.com" target="_blank" title="Email"><i class="fas fa-envelope-open-text"></i></a></div></div><div class="card-widget"><div class="item-headline"><i class="iconfont icat-visitor"></i><span>来访者</span></div><div class="item-content"><div id="welcome-info"></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%9E%84%E5%BB%BA%E6%A8%A1%E5%9D%97%E5%8E%9F%E7%90%86%E8%AF%B4%E6%98%8E"><span class="toc-number">1.</span> <span class="toc-text">查询构建模块原理说明</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E8%AE%BE%E8%AE%A1%E5%8E%9F%E7%90%86"><span class="toc-number">1.1.</span> <span class="toc-text">一、设计原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E6%A8%A1%E5%9D%97%E5%AE%9A%E4%BD%8D"><span class="toc-number">1.1.1.</span> <span class="toc-text">1.1 模块定位</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E8%AE%BE%E8%AE%A1%E7%9B%AE%E7%9A%84"><span class="toc-number">1.1.2.</span> <span class="toc-text">1.2 设计目的</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-%E7%BB%93%E6%9E%84%E5%AE%89%E6%8E%92%E4%BE%9D%E6%8D%AE"><span class="toc-number">1.1.3.</span> <span class="toc-text">1.3 结构安排依据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-%E4%B8%8E%E5%85%B6%E4%BB%96%E6%A8%A1%E5%9D%97%E7%9A%84%E9%80%BB%E8%BE%91%E5%85%B3%E7%B3%BB"><span class="toc-number">1.1.4.</span> <span class="toc-text">1.4 与其他模块的逻辑关系</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86"><span class="toc-number">1.2.</span> <span class="toc-text">二、核心原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E5%85%B3%E9%94%AE%E6%A6%82%E5%BF%B5"><span class="toc-number">1.2.1.</span> <span class="toc-text">2.1 关键概念</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5-1-%E9%93%BE%E5%BC%8F%E8%B0%83%E7%94%A8%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%9C%BA%E5%88%B6"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">概念 1: 链式调用的实现机制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5-2-Statement-%E7%9A%84%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86"><span class="toc-number">1.2.1.2.</span> <span class="toc-text">概念 2: Statement 的状态管理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5-3-BuildCondition-%E6%9D%A1%E4%BB%B6%E6%9E%84%E5%BB%BA"><span class="toc-number">1.2.1.3.</span> <span class="toc-text">概念 3: BuildCondition 条件构建</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5-4-%E9%93%BE%E5%BC%8F-API-%E5%AE%8C%E6%95%B4%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.2.1.4.</span> <span class="toc-text">概念 4: 链式 API 完整实现</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-Model-%E8%AE%BE%E7%BD%AE%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.2.1.4.1.</span> <span class="toc-text">1. Model() - 设置模型</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-Where-%E6%B7%BB%E5%8A%A0-WHERE-%E6%9D%A1%E4%BB%B6"><span class="toc-number">1.2.1.4.2.</span> <span class="toc-text">2. Where() - 添加 WHERE 条件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-Select-%E9%80%89%E6%8B%A9%E5%AD%97%E6%AE%B5"><span class="toc-number">1.2.1.4.3.</span> <span class="toc-text">3. Select() - 选择字段</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-Order-%E6%8E%92%E5%BA%8F"><span class="toc-number">1.2.1.4.4.</span> <span class="toc-text">4. Order() - 排序</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-Limit-Offset-%E5%88%86%E9%A1%B5"><span class="toc-number">1.2.1.4.5.</span> <span class="toc-text">5. Limit() &#x2F; Offset() - 分页</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5-5-Finisher-API-%E5%AE%8C%E6%95%B4%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.2.1.5.</span> <span class="toc-text">概念 5: Finisher API 完整实现</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-Find-%E6%9F%A5%E8%AF%A2%E5%A4%9A%E6%9D%A1%E8%AE%B0%E5%BD%95"><span class="toc-number">1.2.1.5.1.</span> <span class="toc-text">1. Find() - 查询多条记录</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-First-%E6%9F%A5%E8%AF%A2%E5%8D%95%E6%9D%A1%E8%AE%B0%E5%BD%95"><span class="toc-number">1.2.1.5.2.</span> <span class="toc-text">2. First() - 查询单条记录</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-Create-%E5%88%9B%E5%BB%BA%E8%AE%B0%E5%BD%95"><span class="toc-number">1.2.1.5.3.</span> <span class="toc-text">3. Create() - 创建记录</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-Update-%E6%9B%B4%E6%96%B0%E8%AE%B0%E5%BD%95"><span class="toc-number">1.2.1.5.4.</span> <span class="toc-text">4. Update() - 更新记录</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-Delete-%E5%88%A0%E9%99%A4%E8%AE%B0%E5%BD%95"><span class="toc-number">1.2.1.5.5.</span> <span class="toc-text">5. Delete() - 删除记录</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E7%90%86%E8%AE%BA%E5%9F%BA%E7%A1%80"><span class="toc-number">1.2.2.</span> <span class="toc-text">2.2 理论基础</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%90%86%E8%AE%BA-1-Builder-%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">理论 1: Builder 模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%90%86%E8%AE%BA-2-%E5%BB%B6%E8%BF%9F%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">理论 2: 延迟执行模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%90%86%E8%AE%BA-3-%E4%B8%8D%E5%8F%AF%E5%8F%98%E5%AF%B9%E8%B1%A1%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.2.2.3.</span> <span class="toc-text">理论 3: 不可变对象模式</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E5%AD%A6%E4%B9%A0%E6%96%B9%E6%B3%95"><span class="toc-number">1.2.3.</span> <span class="toc-text">2.3 学习方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%B3%95-1-%E8%B0%83%E7%94%A8%E8%BF%BD%E8%B8%AA%E6%B3%95"><span class="toc-number">1.2.3.1.</span> <span class="toc-text">方法 1: 调用追踪法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%B3%95-2-%E5%AF%B9%E6%AF%94%E5%AE%9E%E9%AA%8C%E6%B3%95"><span class="toc-number">1.2.3.2.</span> <span class="toc-text">方法 2: 对比实验法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-%E5%AE%9E%E6%96%BD%E7%AD%96%E7%95%A5"><span class="toc-number">1.2.4.</span> <span class="toc-text">2.4 实施策略</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AD%96%E7%95%A5-1-%E6%B8%90%E8%BF%9B%E5%BC%8F%E5%AD%A6%E4%B9%A0"><span class="toc-number">1.2.4.1.</span> <span class="toc-text">策略 1: 渐进式学习</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AD%96%E7%95%A5-2-%E9%97%AE%E9%A2%98%E9%A9%B1%E5%8A%A8"><span class="toc-number">1.2.4.2.</span> <span class="toc-text">策略 2: 问题驱动</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AD%96%E7%95%A5-3-%E9%AA%8C%E8%AF%81%E5%8F%8D%E9%A6%88"><span class="toc-number">1.2.4.3.</span> <span class="toc-text">策略 3: 验证反馈</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E5%AE%9E%E6%88%98%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.3.</span> <span class="toc-text">四、实战代码示例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E5%9F%BA%E7%A1%80%E6%9F%A5%E8%AF%A2%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.3.1.</span> <span class="toc-text">4.1 基础查询示例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B-1-%E7%AE%80%E5%8D%95%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.3.1.1.</span> <span class="toc-text">示例 1: 简单查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B-2-%E9%93%BE%E5%BC%8F%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.3.1.2.</span> <span class="toc-text">示例 2: 链式查询</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E5%8A%A8%E6%80%81%E6%9F%A5%E8%AF%A2%E6%9E%84%E5%BB%BA"><span class="toc-number">1.3.2.</span> <span class="toc-text">4.2 动态查询构建</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B-3-%E6%9D%A1%E4%BB%B6%E5%BC%8F%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">示例 3: 条件式查询</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-%E9%AB%98%E7%BA%A7%E6%9F%A5%E8%AF%A2%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.3.3.</span> <span class="toc-text">4.3 高级查询示例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B-4-%E4%BD%BF%E7%94%A8-Scopes-%E5%A4%8D%E7%94%A8%E6%9F%A5%E8%AF%A2%E9%80%BB%E8%BE%91"><span class="toc-number">1.3.3.1.</span> <span class="toc-text">示例 4: 使用 Scopes 复用查询逻辑</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B-5-%E5%AD%90%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.3.3.2.</span> <span class="toc-text">示例 5: 子查询</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E4%B8%8E%E6%95%85%E9%9A%9C%E6%8E%92%E6%9F%A5"><span class="toc-number">1.4.</span> <span class="toc-text">五、最佳实践与故障排查</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-%E6%9F%A5%E8%AF%A2%E6%9E%84%E5%BB%BA%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">1.4.1.</span> <span class="toc-text">5.1 查询构建最佳实践</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E4%BD%BF%E7%94%A8-Model-%E6%8C%87%E5%AE%9A%E8%A1%A8"><span class="toc-number">1.4.1.1.</span> <span class="toc-text">1. 使用 Model 指定表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E9%81%BF%E5%85%8D%E5%85%A8%E5%B1%80%E6%9B%B4%E6%96%B0"><span class="toc-number">1.4.1.2.</span> <span class="toc-text">2. 避免全局更新</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E4%BD%BF%E7%94%A8-Preload-%E9%A2%84%E5%8A%A0%E8%BD%BD%E5%85%B3%E8%81%94"><span class="toc-number">1.4.1.3.</span> <span class="toc-text">3. 使用 Preload 预加载关联</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E4%B8%8E%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">1.4.2.</span> <span class="toc-text">5.2 常见问题与解决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%AE%E9%A2%98-1-%E6%9F%A5%E8%AF%A2%E6%9D%A1%E4%BB%B6%E4%B8%8D%E7%94%9F%E6%95%88"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">问题 1: 查询条件不生效</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%AE%E9%A2%98-2-%E6%9B%B4%E6%96%B0%E5%A4%B1%E8%B4%A5"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">问题 2: 更新失败</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%AE%E9%A2%98-3-%E7%BB%93%E6%9E%84%E4%BD%93%E6%9D%A1%E4%BB%B6%E5%8F%AA%E6%9F%A5%E8%AF%A2%E9%9D%9E%E9%9B%B6%E5%80%BC"><span class="toc-number">1.4.2.3.</span> <span class="toc-text">问题 3: 结构体条件只查询非零值</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E3%80%81%E5%AD%A6%E4%B9%A0%E9%AA%8C%E8%AF%81"><span class="toc-number">1.5.</span> <span class="toc-text">六、学习验证</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-%E7%9F%A5%E8%AF%86%E8%87%AA%E6%B5%8B"><span class="toc-number">1.5.1.</span> <span class="toc-text">6.1 知识自测</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E9%A2%98"><span class="toc-number">1.5.1.1.</span> <span class="toc-text">基础题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9B%E9%98%B6%E9%A2%98"><span class="toc-number">1.5.1.2.</span> <span class="toc-text">进阶题</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-%E5%AE%9E%E8%B7%B5%E7%BB%83%E4%B9%A0"><span class="toc-number">1.5.2.</span> <span class="toc-text">6.2 实践练习</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%83%E4%B9%A0-1-%E5%AE%9E%E7%8E%B0%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.5.2.1.</span> <span class="toc-text">练习 1: 实现分页查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%83%E4%B9%A0-2-%E5%AE%9E%E7%8E%B0%E8%BD%AF%E5%88%A0%E9%99%A4%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.5.2.2.</span> <span class="toc-text">练习 2: 实现软删除查询</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E5%AD%A6%E4%B9%A0%E8%B7%AF%E5%BE%84%E5%BB%BA%E8%AE%AE"><span class="toc-number">1.6.</span> <span class="toc-text">三、学习路径建议</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86%E6%A3%80%E6%9F%A5"><span class="toc-number">1.6.1.</span> <span class="toc-text">3.1 前置知识检查</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E5%AD%A6%E4%B9%A0%E6%97%B6%E9%97%B4%E5%88%86%E9%85%8D"><span class="toc-number">1.6.2.</span> <span class="toc-text">3.2 学习时间分配</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E5%AD%A6%E4%B9%A0%E6%88%90%E6%9E%9C%E9%AA%8C%E6%94%B6"><span class="toc-number">1.6.3.</span> <span class="toc-text">3.3 学习成果验收</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2026/01/11/web/gorm/09-logger/" title="Gorm-日志系统模块原理说明"><img src="/img/go.png" onerror="this.onerror=null;this.src='/img/404.png'" alt="Gorm-日志系统模块原理说明"/></a><div class="content"><a class="title" href="/2026/01/11/web/gorm/09-logger/" title="Gorm-日志系统模块原理说明">Gorm-日志系统模块原理说明</a><time datetime="2026-01-11T11:56:27.000Z" title="发表于 2026-01-11 19:56:27">2026-01-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2026/01/11/web/gorm/08-migration/" title="Gorm-迁移功能模块原理说明"><img src="/img/go.png" onerror="this.onerror=null;this.src='/img/404.png'" alt="Gorm-迁移功能模块原理说明"/></a><div class="content"><a class="title" href="/2026/01/11/web/gorm/08-migration/" title="Gorm-迁移功能模块原理说明">Gorm-迁移功能模块原理说明</a><time datetime="2026-01-11T10:56:27.000Z" title="发表于 2026-01-11 18:56:27">2026-01-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2026/01/11/web/gorm/10-plugin/" title="Gorm-插件系统模块原理说明"><img src="/img/go.png" onerror="this.onerror=null;this.src='/img/404.png'" alt="Gorm-插件系统模块原理说明"/></a><div class="content"><a class="title" href="/2026/01/11/web/gorm/10-plugin/" title="Gorm-插件系统模块原理说明">Gorm-插件系统模块原理说明</a><time datetime="2026-01-11T10:56:27.000Z" title="发表于 2026-01-11 18:56:27">2026-01-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2026/01/11/web/gorm/07-transaction/" title="Gorm-事务处理模块原理说明"><img src="/img/go.png" onerror="this.onerror=null;this.src='/img/404.png'" alt="Gorm-事务处理模块原理说明"/></a><div class="content"><a class="title" href="/2026/01/11/web/gorm/07-transaction/" title="Gorm-事务处理模块原理说明">Gorm-事务处理模块原理说明</a><time datetime="2026-01-11T09:56:27.000Z" title="发表于 2026-01-11 17:56:27">2026-01-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2026/01/11/web/gorm/06-associations/" title="Gorm-关联关系模块原理说明"><img src="/img/go.png" onerror="this.onerror=null;this.src='/img/404.png'" alt="Gorm-关联关系模块原理说明"/></a><div class="content"><a class="title" href="/2026/01/11/web/gorm/06-associations/" title="Gorm-关联关系模块原理说明">Gorm-关联关系模块原理说明</a><time datetime="2026-01-11T08:56:27.000Z" title="发表于 2026-01-11 16:56:27">2026-01-11</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2023 - 2026 By Joohwan.</span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
  const option = null

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://piwriw-twikoo-git-main-piwriw.vercel.app/',
      region: 'ap-shanghai',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const init = (el = document, path = location.pathname) => {
    twikoo.init({
      el: el.querySelector('#twikoo-wrap'),
      envId: 'https://piwriw-twikoo-git-main-piwriw.vercel.app/',
      region: 'ap-shanghai',
      onCommentLoaded: () => {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      },
      ...option,
      path: isShuoshuo ? path : (option && option.path) || path
    })

    

    isShuoshuo && (window.shuoshuoComment.destroyTwikoo = () => {
      if (el.children.length) {
        el.innerHTML = ''
        el.classList.add('no-comment')
      }
    })
  }

  const loadTwikoo = (el, path) => {
    if (typeof twikoo === 'object') setTimeout(() => init(el, path), 0)
    else btf.getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(() => init(el, path))
  }

  if (isShuoshuo) {
    'Twikoo' === 'Twikoo'
      ? window.shuoshuoComment = { loadComment: loadTwikoo }
      : window.loadOtherComment = loadTwikoo
    return
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script></div><script src="/js/categories.js" defer></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>