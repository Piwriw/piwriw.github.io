<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Gorm-子句系统模块原理说明 | Joohwan</title><meta name="author" content="Joohwan."><meta name="copyright" content="Joohwan."><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="子句系统模块原理说明 基于1.31 本文档深入解析子句系统模块的设计原理和核心原理，阐述 SQL 组件化构建的理论基础。   一、设计原理1.1 模块定位在整体架构中的位置 子句系统是 GORM SQL 构建的核心组件化引擎，位于 Statement 层之下，直接负责将用户意图转换为 SQL 片段。 1234567891011121314151617181920212223242526┌─────">
<meta property="og:type" content="article">
<meta property="og:title" content="Gorm-子句系统模块原理说明">
<meta property="og:url" content="https://piwriw.github.io/2026/01/11/web/gorm/04-clause/index.html">
<meta property="og:site_name" content="Joohwan">
<meta property="og:description" content="子句系统模块原理说明 基于1.31 本文档深入解析子句系统模块的设计原理和核心原理，阐述 SQL 组件化构建的理论基础。   一、设计原理1.1 模块定位在整体架构中的位置 子句系统是 GORM SQL 构建的核心组件化引擎，位于 Statement 层之下，直接负责将用户意图转换为 SQL 片段。 1234567891011121314151617181920212223242526┌─────">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://piwriw.github.io/img/go.png">
<meta property="article:published_time" content="2026-01-11T07:56:27.000Z">
<meta property="article:modified_time" content="2026-02-28T13:29:12.677Z">
<meta property="article:author" content="Joohwan.">
<meta property="article:tag" content="web">
<meta property="article:tag" content="Gorm">
<meta property="article:tag" content="源码">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://piwriw.github.io/img/go.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Gorm-子句系统模块原理说明",
  "url": "https://piwriw.github.io/2026/01/11/web/gorm/04-clause/",
  "image": "https://piwriw.github.io/img/go.png",
  "datePublished": "2026-01-11T07:56:27.000Z",
  "dateModified": "2026-02-28T13:29:12.677Z",
  "author": [
    {
      "@type": "Person",
      "name": "Joohwan.",
      "url": "https://github.com/Piwriw"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://piwriw.github.io/2026/01/11/web/gorm/04-clause/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Gorm-子句系统模块原理说明',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><script src="/js/welcome.js"></script><script src="https://npm.elemecdn.com/echarts@4.9.0/dist/echarts.min.js"></script><link rel="stylesheet" href="/css/categories.css"><link rel="stylesheet" href="/css/tabs.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">259</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">76</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">60</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/charts/"><i class="fa-fw fas fa-folder-open"></i><span> 文章统计</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div><div class="menus_item"><a class="site-page" href="/wish/"><i class="fa-fw fas fa-tags"></i><span> 许愿墙</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/go.png);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Joohwan</span></a><a class="nav-page-title" href="/"><span class="site-name">Gorm-子句系统模块原理说明</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/charts/"><i class="fa-fw fas fa-folder-open"></i><span> 文章统计</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div><div class="menus_item"><a class="site-page" href="/wish/"><i class="fa-fw fas fa-tags"></i><span> 许愿墙</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Gorm-子句系统模块原理说明</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2026-01-11T07:56:27.000Z" title="发表于 2026-01-11 15:56:27">2026-01-11</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2026-02-28T13:29:12.677Z" title="更新于 2026-02-28 21:29:12">2026-02-28</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/web/">web</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/web/gorm/">gorm</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">8k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>38分钟</span></span><span class="post-meta-separator">|</span><span id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="twikoo_visitors"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><div id="post-outdate-notice" data="{&quot;limitDay&quot;:365,&quot;messagePrev&quot;:&quot;It has been&quot;,&quot;messageNext&quot;:&quot;days since the last update, the content of the article may be outdated.&quot;,&quot;postUpdate&quot;:&quot;2026-02-28 21:29:12&quot;}" hidden></div><h1 id="子句系统模块原理说明"><a href="#子句系统模块原理说明" class="headerlink" title="子句系统模块原理说明"></a>子句系统模块原理说明</h1><blockquote>
<p>基于1.31 本文档深入解析子句系统模块的设计原理和核心原理，阐述 SQL 组件化构建的理论基础。</p>
</blockquote>
<hr>
<h2 id="一、设计原理"><a href="#一、设计原理" class="headerlink" title="一、设计原理"></a>一、设计原理</h2><h3 id="1-1-模块定位"><a href="#1-1-模块定位" class="headerlink" title="1.1 模块定位"></a>1.1 模块定位</h3><p><strong>在整体架构中的位置</strong></p>
<p>子句系统是 GORM SQL 构建的核心组件化引擎，位于 Statement 层之下，直接负责将用户意图转换为 SQL 片段。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│                   用户 API 调用                               │</span><br><span class="line">│  db.Where(&quot;age &gt; ?&quot;, 18).Order(&quot;name&quot;).Limit(10)           │</span><br><span class="line">└────────────────────────┬────────────────────────────────────┘</span><br><span class="line">                         │ 解析意图</span><br><span class="line">                         ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│                   Statement 层                                │</span><br><span class="line">│  Statement.Clauses[&quot;WHERE&quot;] = clause.Where&#123;...&#125;             │</span><br><span class="line">│  Statement.Clauses[&quot;ORDER BY&quot;] = clause.OrderBy&#123;...&#125;        │</span><br><span class="line">└────────────────────────┬────────────────────────────────────┘</span><br><span class="line">                         │ 构建顺序</span><br><span class="line">                         ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│                  子句系统 (本模块) ★                         │</span><br><span class="line">│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │</span><br><span class="line">│  │ SELECT   │  │  WHERE   │  │  JOIN    │  │  ORDER   │   │</span><br><span class="line">│  │ 子句     │  │  子句    │  │  子句    │  │  BY子句  │   │</span><br><span class="line">│  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │</span><br><span class="line">└────────────────────────┬────────────────────────────────────┘</span><br><span class="line">                         │ 拼接 SQL</span><br><span class="line">                         ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│                       完整 SQL                                │</span><br><span class="line">│  SELECT * FROM users WHERE age &gt; 18 ORDER BY name LIMIT 10 │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<p><strong>核心价值</strong></p>
<p>子句系统的核心价值在于将复杂的 SQL 语句分解为可组合、可复用的组件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">传统 SQL 构建:</span><br><span class="line">sql := &quot;SELECT * FROM users WHERE age &gt; 18 ORDER BY name&quot;</span><br><span class="line">// 难以复用、难以维护、容易出错</span><br><span class="line"></span><br><span class="line">子句系统:</span><br><span class="line">select := clause.Select&#123;Columns: []clause.Column&#123;&#123;Name: &quot;*&quot;&#125;&#125;&#125;</span><br><span class="line">where := clause.Where&#123;Exprs: []clause.Expression&#123;...&#125;&#125;</span><br><span class="line">order := clause.OrderBy&#123;Columns: []clause.OrderByColumn&#123;&#123;Column: &quot;name&quot;&#125;&#125;&#125;</span><br><span class="line">// 可组合、可测试、可扩展</span><br></pre></td></tr></table></figure>

<h3 id="1-2-设计目的"><a href="#1-2-设计目的" class="headerlink" title="1.2 设计目的"></a>1.2 设计目的</h3><p><strong>问题 1: 如何将复杂的 SQL 分解为可管理的单元？</strong></p>
<ul>
<li><strong>挑战</strong>: SQL 语句各部分有依赖关系（如 SELECT 后才能用 ORDER BY）</li>
<li><strong>挑战</strong>: 不同数据库的语法差异（如 LIMIT 用法）</li>
<li><strong>解决方案</strong>: 将每个 SQL 关键字抽象为一个 Clause</li>
</ul>
<p><strong>问题 2: 如何支持灵活的组合和扩展？</strong></p>
<ul>
<li><strong>挑战</strong>: 用户可能需要组合任意子句</li>
<li><strong>挑战</strong>: 需要支持数据库特定的语法</li>
<li><strong>解决方案</strong>: 定义统一的 Clause 接口，支持自定义实现</li>
</ul>
<p><strong>问题 3: 如何保证构建顺序的正确性？</strong></p>
<ul>
<li><strong>挑战</strong>: SQL 子句有严格的语法顺序</li>
<li><strong>挑战</strong>: 不同操作的子句需求不同（SELECT vs INSERT）</li>
<li><strong>解决方案</strong>: BuildClauses 数组定义构建顺序</li>
</ul>
<h3 id="1-3-结构安排依据"><a href="#1-3-结构安排依据" class="headerlink" title="1.3 结构安排依据"></a>1.3 结构安排依据</h3><p><strong>3 天学习时间的分配逻辑</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Day 1: Clause 接口体系</span><br><span class="line">  目标: 理解组件化的设计思想</span><br><span class="line">  重点: Interface、Builder、Writer</span><br><span class="line"></span><br><span class="line">Day 2: 常用子句分析</span><br><span class="line">  目标: 理解各类子句的实现</span><br><span class="line">  重点: SELECT、WHERE、JOIN</span><br><span class="line"></span><br><span class="line">Day 3: 高级子句实现</span><br><span class="line">  目标: 理解复杂子句和自定义</span><br><span class="line">  重点: INSERT/UPDATE、自定义子句</span><br></pre></td></tr></table></figure>

<p><strong>由抽象到具体的学习路径</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">第 1 层: 接口抽象</span><br><span class="line">  ├─ Clause Interface</span><br><span class="line">  ├─ Builder Interface</span><br><span class="line">  └─ Expression Interface</span><br><span class="line"></span><br><span class="line">第 2 层: 基础实现</span><br><span class="line">  ├─ Select</span><br><span class="line">  ├─ Where</span><br><span class="line">  └─ Order By</span><br><span class="line"></span><br><span class="line">第 3 层: 复杂实现</span><br><span class="line">  ├─ Join</span><br><span class="line">  ├─ On Conflict</span><br><span class="line">  └─ Locking</span><br><span class="line"></span><br><span class="line">第 4 层: 自定义扩展</span><br><span class="line">  └─ 实现 Clause Interface</span><br></pre></td></tr></table></figure>

<h3 id="1-4-与其他模块的逻辑关系"><a href="#1-4-与其他模块的逻辑关系" class="headerlink" title="1.4 与其他模块的逻辑关系"></a>1.4 与其他模块的逻辑关系</h3><p><strong>依赖关系</strong></p>
<ul>
<li><strong>依赖 Schema</strong>: 子句构建需要字段的数据库列名</li>
<li><strong>依赖 Dialector</strong>: 占位符、引号等需要数据库特定处理</li>
</ul>
<p><strong>支撑关系</strong></p>
<ul>
<li><strong>支撑查询构建</strong>: 查询 API 通过添加子句来构建 SQL</li>
<li><strong>支撑回调系统</strong>: 回调中可以修改子句来影响 SQL</li>
</ul>
<hr>
<h2 id="二、核心原理"><a href="#二、核心原理" class="headerlink" title="二、核心原理"></a>二、核心原理</h2><h3 id="2-1-关键概念"><a href="#2-1-关键概念" class="headerlink" title="2.1 关键概念"></a>2.1 关键概念</h3><h4 id="概念-1-Clause-接口"><a href="#概念-1-Clause-接口" class="headerlink" title="概念 1: Clause 接口"></a>概念 1: Clause 接口</h4><p><strong>定义</strong>: Clause 是所有 SQL 子句的抽象接口，定义了子句的核心行为。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Interface <span class="keyword">interface</span> &#123;</span><br><span class="line">    Name() <span class="type">string</span>           <span class="comment">// 子句名称，如 &quot;WHERE&quot;</span></span><br><span class="line">    Build(Builder)         <span class="comment">// 构建子句 SQL</span></span><br><span class="line">    MergeClause(*Clause)   <span class="comment">// 合并子句配置</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>设计原理</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">接口最小化原则:</span><br><span class="line">┌─────────────────────────────────────┐</span><br><span class="line">│         Clause Interface            │</span><br><span class="line">│  ┌──────────┐  ┌──────────┐        │</span><br><span class="line">│  │  Name()  │  │  Build() │        │  核心方法</span><br><span class="line">│  └──────────┘  └──────────┘        │</span><br><span class="line">│                                     │</span><br><span class="line">│  子类实现:                          │</span><br><span class="line">│  ├─ Where.Name() = &quot;WHERE&quot;         │</span><br><span class="line">│  ├─ Where.Build() = 构建 WHERE 部分 │</span><br><span class="line">│  └─ OrderBy.Name() = &quot;ORDER BY&quot;     │</span><br><span class="line">└─────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<p><strong>Clause 结构体</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Clause <span class="keyword">struct</span> &#123;</span><br><span class="line">    Name                <span class="type">string</span>       <span class="comment">// 子句名称</span></span><br><span class="line">    BeforeExpression    Expression   <span class="comment">// 前置表达式</span></span><br><span class="line">    AfterNameExpression Expression   <span class="comment">// 名称后表达式</span></span><br><span class="line">    AfterExpression     Expression   <span class="comment">// 后置表达式</span></span><br><span class="line">    Expression          Expression   <span class="comment">// 主表达式</span></span><br><span class="line">    Builder             ClauseBuilder <span class="comment">// 自定义构建器</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>学习要点</strong>:</p>
<ul>
<li>Interface 定义契约，具体实现由各子句类型提供</li>
<li>Name() 返回 SQL 关键字（大写）</li>
<li>Build() 负责生成 SQL 字符串和参数</li>
</ul>
<hr>
<h3 id="Clause-接口完整解析-clause-go-3-90"><a href="#Clause-接口完整解析-clause-go-3-90" class="headerlink" title="Clause 接口完整解析 (clause.go:3-90)"></a>Clause 接口完整解析 (clause.go:3-90)</h3><p><strong>完整定义</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Interface 子句接口，定义了所有 SQL 子句必须实现的方法</span></span><br><span class="line"><span class="keyword">type</span> Interface <span class="keyword">interface</span> &#123;</span><br><span class="line">    Name() <span class="type">string</span>           <span class="comment">// 返回子句名称，如 &quot;WHERE&quot;、&quot;SELECT&quot;</span></span><br><span class="line">    Build(Builder)         <span class="comment">// 构建 SQL 子句</span></span><br><span class="line">    MergeClause(*Clause)   <span class="comment">// 合并子句配置</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ClauseBuilder 子句构建器函数类型</span></span><br><span class="line"><span class="comment">// 允许自定义子句的构建逻辑</span></span><br><span class="line"><span class="keyword">type</span> ClauseBuilder <span class="function"><span class="keyword">func</span><span class="params">(Clause, Builder)</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Writer 写入器接口，提供基础的写入能力</span></span><br><span class="line"><span class="keyword">type</span> Writer <span class="keyword">interface</span> &#123;</span><br><span class="line">    WriteByte(<span class="type">byte</span>) <span class="type">error</span>       <span class="comment">// 写入单个字节</span></span><br><span class="line">    WriteString(<span class="type">string</span>) (<span class="type">int</span>, <span class="type">error</span>)  <span class="comment">// 写入字符串，返回写入的字节数</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Builder 构建器接口，继承 Writer 并添加更多功能</span></span><br><span class="line"><span class="keyword">type</span> Builder <span class="keyword">interface</span> &#123;</span><br><span class="line">    Writer                              <span class="comment">// 继承写入接口</span></span><br><span class="line">    WriteQuoted(field <span class="keyword">interface</span>&#123;&#125;)      <span class="comment">// 写入带引号的标识符</span></span><br><span class="line">    AddVar(Writer, ...<span class="keyword">interface</span>&#123;&#125;)      <span class="comment">// 添加变量到参数列表</span></span><br><span class="line">    AddError(<span class="type">error</span>) <span class="type">error</span>               <span class="comment">// 添加错误</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Clause 子句结构体</span></span><br><span class="line"><span class="keyword">type</span> Clause <span class="keyword">struct</span> &#123;</span><br><span class="line">    Name                <span class="type">string</span>       <span class="comment">// 子句名称: &quot;WHERE&quot;</span></span><br><span class="line">    BeforeExpression    Expression   <span class="comment">// 名称前的表达式</span></span><br><span class="line">    AfterNameExpression Expression   <span class="comment">// 名称后的表达式</span></span><br><span class="line">    AfterExpression     Expression   <span class="comment">// 名称后的表达式</span></span><br><span class="line">    Expression          Expression   <span class="comment">// 主表达式</span></span><br><span class="line">    Builder             ClauseBuilder <span class="comment">// 自定义构建器函数</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>接口方法说明</strong>:</p>
<table>
<thead>
<tr>
<th>方法</th>
<th>作用</th>
<th>返回值</th>
<th>使用场景</th>
</tr>
</thead>
<tbody><tr>
<td><code>Name()</code></td>
<td>获取子句名称</td>
<td>string</td>
<td>用于标识和排序子句</td>
</tr>
<tr>
<td><code>Build()</code></td>
<td>构建 SQL</td>
<td>无</td>
<td>生成 SQL 字符串和参数</td>
</tr>
<tr>
<td><code>MergeClause()</code></td>
<td>合并子句</td>
<td>无</td>
<td>合并多个相同类型的子句</td>
</tr>
</tbody></table>
<p><strong>Clause.Build() 完整实现</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Build 构建子句 SQL</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c Clause)</span></span> Build(builder Builder) &#123;</span><br><span class="line">    <span class="comment">// 1. 如果有自定义构建器，优先使用</span></span><br><span class="line">    <span class="keyword">if</span> c.Builder != <span class="literal">nil</span> &#123;</span><br><span class="line">        c.Builder(c, builder)  <span class="comment">// 调用自定义构建函数</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 如果有表达式，按标准流程构建</span></span><br><span class="line">    <span class="keyword">if</span> c.Expression != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="comment">// 2.1 构建名称前的表达式</span></span><br><span class="line">        <span class="keyword">if</span> c.BeforeExpression != <span class="literal">nil</span> &#123;</span><br><span class="line">            c.BeforeExpression.Build(builder)</span><br><span class="line">            builder.WriteByte(<span class="string">&#x27; &#x27;</span>)  <span class="comment">// 添加空格</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.2 写入子句名称</span></span><br><span class="line">        <span class="keyword">if</span> c.Name != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">            builder.WriteString(c.Name)  <span class="comment">// 如 &quot;WHERE&quot;</span></span><br><span class="line">            builder.WriteByte(<span class="string">&#x27; &#x27;</span>)        <span class="comment">// 添加空格</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.3 构建名称后的表达式</span></span><br><span class="line">        <span class="keyword">if</span> c.AfterNameExpression != <span class="literal">nil</span> &#123;</span><br><span class="line">            c.AfterNameExpression.Build(builder)</span><br><span class="line">            builder.WriteByte(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.4 构建主表达式</span></span><br><span class="line">        c.Expression.Build(builder)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.5 构建后置表达式</span></span><br><span class="line">        <span class="keyword">if</span> c.AfterExpression != <span class="literal">nil</span> &#123;</span><br><span class="line">            builder.WriteByte(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">            c.AfterExpression.Build(builder)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Column 和 Table 结构</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Column 列结构，表示数据库中的列</span></span><br><span class="line"><span class="keyword">type</span> Column <span class="keyword">struct</span> &#123;</span><br><span class="line">    Table <span class="type">string</span>        <span class="comment">// 表名</span></span><br><span class="line">    Name  <span class="type">string</span>        <span class="comment">// 列名</span></span><br><span class="line">    Alias <span class="type">string</span>        <span class="comment">// 别名</span></span><br><span class="line">    Raw   <span class="type">bool</span>          <span class="comment">// 是否为原始 SQL (不添加引号)</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Table 表结构，表示数据库中的表</span></span><br><span class="line"><span class="keyword">type</span> Table <span class="keyword">struct</span> &#123;</span><br><span class="line">    Name  <span class="type">string</span>        <span class="comment">// 表名</span></span><br><span class="line">    Alias <span class="type">string</span>        <span class="comment">// 别名</span></span><br><span class="line">    Raw   <span class="type">bool</span>          <span class="comment">// 是否为原始 SQL (不添加引号)</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 特殊常量</span></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    PrimaryKey   <span class="type">string</span> = <span class="string">&quot;~~~py~~~&quot;</span>    <span class="comment">// 主键占位符</span></span><br><span class="line">    CurrentTable <span class="type">string</span> = <span class="string">&quot;~~~ct~~~&quot;</span>    <span class="comment">// 当前表占位符</span></span><br><span class="line">    Associations <span class="type">string</span> = <span class="string">&quot;~~~as~~~&quot;</span>    <span class="comment">// 关联占位符</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 预定义的常用结构</span></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">    currentTable  = Table&#123;Name: CurrentTable&#125;    <span class="comment">// 当前表引用</span></span><br><span class="line">    PrimaryColumn = Column&#123;Table: CurrentTable, Name: PrimaryKey&#125;  <span class="comment">// 主键列引用</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><strong>Clause 构建流程图</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">Clause.Build(builder)</span><br><span class="line">        │</span><br><span class="line">        ▼</span><br><span class="line">   [有自定义构建器?]</span><br><span class="line">   Builder != nil?</span><br><span class="line">        │</span><br><span class="line">        ├─ Yes ──► 调用 c.Builder(c, builder)</span><br><span class="line">        │           返回</span><br><span class="line">        │</span><br><span class="line">        └─ No</span><br><span class="line">            │</span><br><span class="line">            ▼</span><br><span class="line">   [有表达式?]</span><br><span class="line">   Expression != nil?</span><br><span class="line">        │</span><br><span class="line">        ├─ No ──► 返回 (无操作)</span><br><span class="line">        │</span><br><span class="line">        └─ Yes</span><br><span class="line">            │</span><br><span class="line">            ▼</span><br><span class="line">   [构建 BeforeExpression]</span><br><span class="line">   if BeforeExpression != nil</span><br><span class="line">        │</span><br><span class="line">        ├─► Build(builder)</span><br><span class="line">        └─► WriteByte(&#x27; &#x27;)</span><br><span class="line">            │</span><br><span class="line">            ▼</span><br><span class="line">   [写入子句名称]</span><br><span class="line">   if Name != &quot;&quot;</span><br><span class="line">        │</span><br><span class="line">        ├─► WriteString(Name)  // &quot;WHERE&quot;</span><br><span class="line">        └─► WriteByte(&#x27; &#x27;)</span><br><span class="line">            │</span><br><span class="line">            ▼</span><br><span class="line">   [构建 AfterNameExpression]</span><br><span class="line">   if AfterNameExpression != nil</span><br><span class="line">        │</span><br><span class="line">        ├─► Build(builder)</span><br><span class="line">        └─► WriteByte(&#x27; &#x27;)</span><br><span class="line">            │</span><br><span class="line">            ▼</span><br><span class="line">   [构建主表达式]</span><br><span class="line">   Expression.Build(builder)</span><br><span class="line">        │</span><br><span class="line">            ▼</span><br><span class="line">   [构建 AfterExpression]</span><br><span class="line">   if AfterExpression != nil</span><br><span class="line">        │</span><br><span class="line">        ├─► WriteByte(&#x27; &#x27;)</span><br><span class="line">        └─► Build(builder)</span><br><span class="line">            │</span><br><span class="line">            ▼</span><br><span class="line">   返回</span><br></pre></td></tr></table></figure>

<p><strong>MergeClause 的作用</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MergeClause 合并子句配置</span></span><br><span class="line"><span class="comment">// 当多次调用同一个子句时，需要合并配置而不是覆盖</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(where Where)</span></span> MergeClause(clause *Clause) &#123;</span><br><span class="line">    <span class="comment">// 1. 检查是否已存在相同类型的子句</span></span><br><span class="line">    <span class="keyword">if</span> w, ok := clause.Expression.(Where); ok &#123;</span><br><span class="line">        <span class="comment">// 2. 合并表达式列表</span></span><br><span class="line">        exprs := <span class="built_in">make</span>([]Expression, <span class="built_in">len</span>(w.Exprs)+<span class="built_in">len</span>(where.Exprs))</span><br><span class="line">        <span class="built_in">copy</span>(exprs, w.Exprs)              <span class="comment">// 复制原有表达式</span></span><br><span class="line">        <span class="built_in">copy</span>(exprs[<span class="built_in">len</span>(w.Exprs):], where.Exprs)  <span class="comment">// 追加新表达式</span></span><br><span class="line">        where.Exprs = exprs</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 更新子句表达式</span></span><br><span class="line">    clause.Expression = where</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="概念-2-Builder-接口"><a href="#概念-2-Builder-接口" class="headerlink" title="概念 2: Builder 接口"></a>概念 2: Builder 接口</h4><p><strong>定义</strong>: Builder 是 SQL 构建器的抽象，提供写入 SQL 和变量的能力。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Builder <span class="keyword">interface</span> &#123;</span><br><span class="line">    Writer                      <span class="comment">// 继承写入接口</span></span><br><span class="line">    WriteQuoted(field <span class="keyword">interface</span>&#123;&#125;)  <span class="comment">// 写入带引号的标识符</span></span><br><span class="line">    AddVar(Writer, ...<span class="keyword">interface</span>&#123;&#125;)  <span class="comment">// 添加变量</span></span><br><span class="line">    AddError(<span class="type">error</span>) <span class="type">error</span>           <span class="comment">// 添加错误</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Writer <span class="keyword">interface</span> &#123;</span><br><span class="line">    WriteByte(<span class="type">byte</span>) <span class="type">error</span></span><br><span class="line">    WriteString(<span class="type">string</span>) (<span class="type">int</span>, <span class="type">error</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>设计原理</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Builder 的职责分解:</span><br><span class="line"></span><br><span class="line">1. Writer (基础写入)</span><br><span class="line">   └─ 直接写入字符串到 SQL buffer</span><br><span class="line"></span><br><span class="line">2. WriteQuoted (标识符处理)</span><br><span class="line">   └─ 根据数据库规则添加引号</span><br><span class="line">   └─ MySQL: `column`</span><br><span class="line">   └─ PostgreSQL: &quot;column&quot;</span><br><span class="line"></span><br><span class="line">3. AddVar (变量处理)</span><br><span class="line">   └─ 将变量添加到 Vars 数组</span><br><span class="line">   └─ 写入占位符</span><br><span class="line">   └─ MySQL: ?</span><br><span class="line">   └─ PostgreSQL: $1</span><br></pre></td></tr></table></figure>

<p><strong>实现示例</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Statement 实现了 Builder 接口</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(stmt *Statement)</span></span> WriteQuoted(field <span class="keyword">interface</span>&#123;&#125;) &#123;</span><br><span class="line">    <span class="keyword">switch</span> v := field.(<span class="keyword">type</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> clause.Column:</span><br><span class="line">        stmt.QuoteTo(&amp;stmt.SQL, v.Name)</span><br><span class="line">    <span class="keyword">case</span> <span class="type">string</span>:</span><br><span class="line">        stmt.QuoteTo(&amp;stmt.SQL, v)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(stmt *Statement)</span></span> AddVar(writer Writer, vars ...<span class="keyword">interface</span>&#123;&#125;) &#123;</span><br><span class="line">    <span class="keyword">for</span> _, v := <span class="keyword">range</span> vars &#123;</span><br><span class="line">        <span class="keyword">switch</span> val := v.(<span class="keyword">type</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> clause.Expression:</span><br><span class="line">            val.Build(stmt)  <span class="comment">// 表达式直接构建</span></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            stmt.Vars = <span class="built_in">append</span>(stmt.Vars, val)</span><br><span class="line">            stmt.DB.Dialector.BindVarTo(stmt, stmt, val)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="概念-3-Expression-表达式"><a href="#概念-3-Expression-表达式" class="headerlink" title="概念 3: Expression 表达式"></a>概念 3: Expression 表达式</h4><p><strong>定义</strong>: Expression 是 SQL 表达式的抽象，可以是一个值、一个字段、或一个复杂表达式。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Expression <span class="keyword">interface</span> &#123;</span><br><span class="line">    Build(Builder)  <span class="comment">// 构建表达式</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>常用表达式类型</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 原始表达式 (Expr)</span></span><br><span class="line"><span class="keyword">type</span> Expr <span class="keyword">struct</span> &#123;</span><br><span class="line">    SQL  <span class="type">string</span>           <span class="comment">// SQL 模板</span></span><br><span class="line">    Vars []<span class="keyword">interface</span>&#123;&#125;    <span class="comment">// 变量</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(expr Expr)</span></span> Build(builder Builder) &#123;</span><br><span class="line">    <span class="comment">// 替换 SQL 中的占位符</span></span><br><span class="line">    <span class="comment">// 处理变量绑定</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 命名表达式 (NamedExpr)</span></span><br><span class="line"><span class="keyword">type</span> NamedExpr <span class="keyword">struct</span> &#123;</span><br><span class="line">    SQL  <span class="type">string</span></span><br><span class="line">    Vars []<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 等值表达式 (Eq)</span></span><br><span class="line"><span class="keyword">type</span> Eq <span class="keyword">struct</span> &#123;</span><br><span class="line">    Column <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">    Value  <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(eq Eq)</span></span> Build(builder Builder) &#123;</span><br><span class="line">    builder.WriteQuoted(eq.Column)</span><br><span class="line">    builder.WriteString(<span class="string">&quot; = &quot;</span>)</span><br><span class="line">    builder.AddVar(builder, eq.Value)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. 逻辑表达式</span></span><br><span class="line"><span class="keyword">type</span> And []Expression</span><br><span class="line"><span class="keyword">type</span> Or []Expression</span><br><span class="line"><span class="keyword">type</span> Not Expression</span><br></pre></td></tr></table></figure>

<p><strong>表达式组合</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 简单表达式</span></span><br><span class="line">clause.Eq&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;John&quot;</span>&#125;</span><br><span class="line"><span class="comment">// SQL: name = &#x27;John&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 复合表达式</span></span><br><span class="line">clause.And(</span><br><span class="line">    clause.Eq&#123;<span class="string">&quot;age&quot;</span>: <span class="number">18</span>&#125;,</span><br><span class="line">    clause.Gt&#123;<span class="string">&quot;score&quot;</span>: <span class="number">80</span>&#125;,</span><br><span class="line">)</span><br><span class="line"><span class="comment">// SQL: (age = 18) AND (score &gt; 80)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 嵌套表达式</span></span><br><span class="line">clause.Or(</span><br><span class="line">    clause.And(clause.Eq&#123;<span class="string">&quot;age&quot;</span>: <span class="number">18</span>&#125;, clause.Eq&#123;<span class="string">&quot;status&quot;</span>: <span class="string">&quot;active&quot;</span>&#125;),</span><br><span class="line">    clause.Eq&#123;<span class="string">&quot;vip&quot;</span>: <span class="literal">true</span>&#125;,</span><br><span class="line">)</span><br><span class="line"><span class="comment">// SQL: ((age = 18) AND (status = &#x27;active&#x27;)) OR (vip = true)</span></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="Expression-表达式完整解析-expression-go-10-386"><a href="#Expression-表达式完整解析-expression-go-10-386" class="headerlink" title="Expression 表达式完整解析 (expression.go:10-386)"></a>Expression 表达式完整解析 (expression.go:10-386)</h3><p><strong>完整定义</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Expression 表达式接口</span></span><br><span class="line"><span class="keyword">type</span> Expression <span class="keyword">interface</span> &#123;</span><br><span class="line">    Build(builder Builder)  <span class="comment">// 构建表达式</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NegationExpressionBuilder 否定表达式构建器接口</span></span><br><span class="line"><span class="comment">// 用于实现 NOT 逻辑</span></span><br><span class="line"><span class="keyword">type</span> NegationExpressionBuilder <span class="keyword">interface</span> &#123;</span><br><span class="line">    NegationBuild(builder Builder)  <span class="comment">// 构建否定表达式</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Expr 原始表达式</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Expr 原始 SQL 表达式</span></span><br><span class="line"><span class="keyword">type</span> Expr <span class="keyword">struct</span> &#123;</span><br><span class="line">    SQL                <span class="type">string</span>        <span class="comment">// SQL 模板字符串</span></span><br><span class="line">    Vars               []<span class="keyword">interface</span>&#123;&#125; <span class="comment">// 变量列表</span></span><br><span class="line">    WithoutParentheses <span class="type">bool</span>          <span class="comment">// 是否不加括号</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Build 构建原始表达式</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(expr Expr)</span></span> Build(builder Builder) &#123;</span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        afterParenthesis <span class="type">bool</span>  <span class="comment">// 是否在括号后</span></span><br><span class="line">        idx              <span class="type">int</span>   <span class="comment">// 当前变量索引</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. 遍历 SQL 字符串的每个字节</span></span><br><span class="line">    <span class="keyword">for</span> _, v := <span class="keyword">range</span> []<span class="type">byte</span>(expr.SQL) &#123;</span><br><span class="line">        <span class="keyword">if</span> v == <span class="string">&#x27;?&#x27;</span> &amp;&amp; <span class="built_in">len</span>(expr.Vars) &gt; idx &#123;</span><br><span class="line">            <span class="comment">// 2. 遇到占位符，替换为变量</span></span><br><span class="line">            <span class="keyword">if</span> afterParenthesis || expr.WithoutParentheses &#123;</span><br><span class="line">                <span class="comment">// 2.1 特殊处理：展开切片或处理 Valuer</span></span><br><span class="line">                <span class="keyword">if</span> _, ok := expr.Vars[idx].(driver.Valuer); ok &#123;</span><br><span class="line">                    builder.AddVar(builder, expr.Vars[idx])</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">switch</span> rv := reflect.ValueOf(expr.Vars[idx]); rv.Kind() &#123;</span><br><span class="line">                    <span class="keyword">case</span> reflect.Slice, reflect.Array:</span><br><span class="line">                        <span class="comment">// 2.1.1 展开切片为多个变量</span></span><br><span class="line">                        <span class="keyword">if</span> rv.Len() == <span class="number">0</span> &#123;</span><br><span class="line">                            builder.AddVar(builder, <span class="literal">nil</span>)</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; rv.Len(); i++ &#123;</span><br><span class="line">                                <span class="keyword">if</span> i &gt; <span class="number">0</span> &#123;</span><br><span class="line">                                    builder.WriteByte(<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">                                &#125;</span><br><span class="line">                                builder.AddVar(builder, rv.Index(i).Interface())</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    <span class="keyword">default</span>:</span><br><span class="line">                        builder.AddVar(builder, expr.Vars[idx])</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                builder.AddVar(builder, expr.Vars[idx])</span><br><span class="line">            &#125;</span><br><span class="line">            idx++</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 3. 直接写入字符</span></span><br><span class="line">            <span class="keyword">if</span> v == <span class="string">&#x27;(&#x27;</span> &#123;</span><br><span class="line">                afterParenthesis = <span class="literal">true</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                afterParenthesis = <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">            builder.WriteByte(v)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. 处理剩余的变量</span></span><br><span class="line">    <span class="keyword">if</span> idx &lt; <span class="built_in">len</span>(expr.Vars) &#123;</span><br><span class="line">        <span class="keyword">for</span> _, v := <span class="keyword">range</span> expr.Vars[idx:] &#123;</span><br><span class="line">            builder.AddVar(builder, sql.NamedArg&#123;Value: v&#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>比较表达式类型</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Eq 等于表达式</span></span><br><span class="line"><span class="keyword">type</span> Eq <span class="keyword">struct</span> &#123;</span><br><span class="line">    Column <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">    Value  <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(eq Eq)</span></span> Build(builder Builder) &#123;</span><br><span class="line">    builder.WriteQuoted(eq.Column)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> eq.Value.(<span class="keyword">type</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> []<span class="type">string</span>, []<span class="type">int</span>, []<span class="type">int32</span>, []<span class="type">int64</span>, []<span class="type">uint</span>, []<span class="type">uint32</span>, []<span class="type">uint64</span>, []<span class="keyword">interface</span>&#123;&#125;:</span><br><span class="line">        <span class="comment">// 数组值转换为 IN 查询</span></span><br><span class="line">        rv := reflect.ValueOf(eq.Value)</span><br><span class="line">        <span class="keyword">if</span> rv.Len() == <span class="number">0</span> &#123;</span><br><span class="line">            builder.WriteString(<span class="string">&quot; IN (NULL)&quot;</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            builder.WriteString(<span class="string">&quot; IN (&quot;</span>)</span><br><span class="line">            <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; rv.Len(); i++ &#123;</span><br><span class="line">                <span class="keyword">if</span> i &gt; <span class="number">0</span> &#123;</span><br><span class="line">                    builder.WriteByte(<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">                &#125;</span><br><span class="line">                builder.AddVar(builder, rv.Index(i).Interface())</span><br><span class="line">            &#125;</span><br><span class="line">            builder.WriteByte(<span class="string">&#x27;)&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">if</span> eqNil(eq.Value) &#123;</span><br><span class="line">            builder.WriteString(<span class="string">&quot; IS NULL&quot;</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            builder.WriteString(<span class="string">&quot; = &quot;</span>)</span><br><span class="line">            builder.AddVar(builder, eq.Value)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Neq 不等于表达式</span></span><br><span class="line"><span class="keyword">type</span> Neq Eq</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(neq Neq)</span></span> Build(builder Builder) &#123;</span><br><span class="line">    builder.WriteQuoted(neq.Column)</span><br><span class="line">    <span class="comment">// 类似 Eq，但生成 &lt;&gt; 或 IS NOT NULL</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Gt 大于表达式</span></span><br><span class="line"><span class="keyword">type</span> Gt Eq</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(gt Gt)</span></span> Build(builder Builder) &#123;</span><br><span class="line">    builder.WriteQuoted(gt.Column)</span><br><span class="line">    builder.WriteString(<span class="string">&quot; &gt; &quot;</span>)</span><br><span class="line">    builder.AddVar(builder, gt.Value)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Gte 大于等于表达式</span></span><br><span class="line"><span class="keyword">type</span> Gte Eq</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(gte Gte)</span></span> Build(builder Builder) &#123;</span><br><span class="line">    builder.WriteQuoted(gte.Column)</span><br><span class="line">    builder.WriteString(<span class="string">&quot; &gt;= &quot;</span>)</span><br><span class="line">    builder.AddVar(builder, gte.Value)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Lt 小于表达式</span></span><br><span class="line"><span class="keyword">type</span> Lt Eq</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(lt Lt)</span></span> Build(builder Builder) &#123;</span><br><span class="line">    builder.WriteQuoted(lt.Column)</span><br><span class="line">    builder.WriteString(<span class="string">&quot; &lt; &quot;</span>)</span><br><span class="line">    builder.AddVar(builder, lt.Value)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Lte 小于等于表达式</span></span><br><span class="line"><span class="keyword">type</span> Lte Eq</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(lte Lte)</span></span> Build(builder Builder) &#123;</span><br><span class="line">    builder.WriteQuoted(lte.Column)</span><br><span class="line">    builder.WriteString(<span class="string">&quot; &lt;= &quot;</span>)</span><br><span class="line">    builder.AddVar(builder, lte.Value)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Like 模糊匹配表达式</span></span><br><span class="line"><span class="keyword">type</span> Like Eq</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(like Like)</span></span> Build(builder Builder) &#123;</span><br><span class="line">    builder.WriteQuoted(like.Column)</span><br><span class="line">    builder.WriteString(<span class="string">&quot; LIKE &quot;</span>)</span><br><span class="line">    builder.AddVar(builder, like.Value)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// IN 表达式</span></span><br><span class="line"><span class="keyword">type</span> IN <span class="keyword">struct</span> &#123;</span><br><span class="line">    Column <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">    Values []<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(in IN)</span></span> Build(builder Builder) &#123;</span><br><span class="line">    builder.WriteQuoted(in.Column)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> <span class="built_in">len</span>(in.Values) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">        builder.WriteString(<span class="string">&quot; IN (NULL)&quot;</span>)</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        <span class="comment">// 单个值转换为 =</span></span><br><span class="line">        <span class="keyword">if</span> _, ok := in.Values[<span class="number">0</span>].([]<span class="keyword">interface</span>&#123;&#125;); !ok &#123;</span><br><span class="line">            builder.WriteString(<span class="string">&quot; = &quot;</span>)</span><br><span class="line">            builder.AddVar(builder, in.Values[<span class="number">0</span>])</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">fallthrough</span></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        builder.WriteString(<span class="string">&quot; IN (&quot;</span>)</span><br><span class="line">        builder.AddVar(builder, in.Values...)</span><br><span class="line">        builder.WriteByte(<span class="string">&#x27;)&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>逻辑表达式</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// And 逻辑与表达式</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">And</span><span class="params">(exprs ...Expression)</span></span> Expression &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(exprs) == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(exprs) == <span class="number">1</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> _, ok := exprs[<span class="number">0</span>].(OrConditions); !ok &#123;</span><br><span class="line">            <span class="keyword">return</span> exprs[<span class="number">0</span>]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> AndConditions&#123;Exprs: exprs&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> AndConditions <span class="keyword">struct</span> &#123;</span><br><span class="line">    Exprs []Expression</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(and AndConditions)</span></span> Build(builder Builder) &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(and.Exprs) &gt; <span class="number">1</span> &#123;</span><br><span class="line">        builder.WriteByte(<span class="string">&#x27;(&#x27;</span>)</span><br><span class="line">        buildExprs(and.Exprs, builder, <span class="string">&quot; AND &quot;</span>)</span><br><span class="line">        builder.WriteByte(<span class="string">&#x27;)&#x27;</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        buildExprs(and.Exprs, builder, <span class="string">&quot; AND &quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Or 逻辑或表达式</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Or</span><span class="params">(exprs ...Expression)</span></span> Expression &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(exprs) == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> OrConditions&#123;Exprs: exprs&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> OrConditions <span class="keyword">struct</span> &#123;</span><br><span class="line">    Exprs []Expression</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(or OrConditions)</span></span> Build(builder Builder) &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(or.Exprs) &gt; <span class="number">1</span> &#123;</span><br><span class="line">        builder.WriteByte(<span class="string">&#x27;(&#x27;</span>)</span><br><span class="line">        buildExprs(or.Exprs, builder, <span class="string">&quot; OR &quot;</span>)</span><br><span class="line">        builder.WriteByte(<span class="string">&#x27;)&#x27;</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        buildExprs(or.Exprs, builder, <span class="string">&quot; OR &quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Not 逻辑非表达式</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Not</span><span class="params">(exprs ...Expression)</span></span> Expression &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(exprs) == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(exprs) == <span class="number">1</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> andCondition, ok := exprs[<span class="number">0</span>].(AndConditions); ok &#123;</span><br><span class="line">            exprs = andCondition.Exprs</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> NotConditions&#123;Exprs: exprs&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> NotConditions <span class="keyword">struct</span> &#123;</span><br><span class="line">    Exprs []Expression</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(not NotConditions)</span></span> Build(builder Builder) &#123;</span><br><span class="line">    <span class="comment">// 检查是否有实现了 NegationBuild 的表达式</span></span><br><span class="line">    anyNegationBuilder := <span class="literal">false</span></span><br><span class="line">    <span class="keyword">for</span> _, c := <span class="keyword">range</span> not.Exprs &#123;</span><br><span class="line">        <span class="keyword">if</span> _, ok := c.(NegationExpressionBuilder); ok &#123;</span><br><span class="line">            anyNegationBuilder = <span class="literal">true</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> anyNegationBuilder &#123;</span><br><span class="line">        <span class="comment">// 使用 NegationBuild</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(not.Exprs) &gt; <span class="number">1</span> &#123;</span><br><span class="line">            builder.WriteByte(<span class="string">&#x27;(&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> idx, c := <span class="keyword">range</span> not.Exprs &#123;</span><br><span class="line">            <span class="keyword">if</span> idx &gt; <span class="number">0</span> &#123;</span><br><span class="line">                builder.WriteString(<span class="string">&quot; AND &quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> negationBuilder, ok := c.(NegationExpressionBuilder); ok &#123;</span><br><span class="line">                negationBuilder.NegationBuild(builder)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                builder.WriteString(<span class="string">&quot;NOT &quot;</span>)</span><br><span class="line">                c.Build(builder)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(not.Exprs) &gt; <span class="number">1</span> &#123;</span><br><span class="line">            builder.WriteByte(<span class="string">&#x27;)&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 使用 NOT 前缀</span></span><br><span class="line">        builder.WriteString(<span class="string">&quot;NOT &quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(not.Exprs) &gt; <span class="number">1</span> &#123;</span><br><span class="line">            builder.WriteByte(<span class="string">&#x27;(&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> idx, c := <span class="keyword">range</span> not.Exprs &#123;</span><br><span class="line">            <span class="keyword">if</span> idx &gt; <span class="number">0</span> &#123;</span><br><span class="line">                <span class="keyword">switch</span> c.(<span class="keyword">type</span>) &#123;</span><br><span class="line">                <span class="keyword">case</span> OrConditions:</span><br><span class="line">                    builder.WriteString(<span class="string">&quot; OR &quot;</span>)</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    builder.WriteString(<span class="string">&quot; AND &quot;</span>)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            c.Build(builder)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(not.Exprs) &gt; <span class="number">1</span> &#123;</span><br><span class="line">            builder.WriteByte(<span class="string">&#x27;)&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>表达式构建流程图</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">表达式构建流程</span><br><span class="line"></span><br><span class="line">Expression.Build(builder)</span><br><span class="line">        │</span><br><span class="line">        ▼</span><br><span class="line">   [表达式类型判断]</span><br><span class="line">        │</span><br><span class="line">        ├─► Expr (原始 SQL)</span><br><span class="line">        │       │</span><br><span class="line">        │       └─► 遍历 SQL 字符串</span><br><span class="line">        │           ├─► 遇到 &#x27;?&#x27; ──► AddVar(vars[idx++])</span><br><span class="line">        │           └─► 其他字符 ──► WriteByte(c)</span><br><span class="line">        │</span><br><span class="line">        ├─► Eq (等于)</span><br><span class="line">        │       │</span><br><span class="line">        │       ├─► WriteQuoted(Column)</span><br><span class="line">        │       ├─► 检查 Value 类型</span><br><span class="line">        │       │   ├─► 切片 ──► IN (...)</span><br><span class="line">        │       │   ├─► nil ──► IS NULL</span><br><span class="line">        │       │   └─► 其他 ──► = ?</span><br><span class="line">        │       └─► AddVar(Value)</span><br><span class="line">        │</span><br><span class="line">        ├─► AndConditions (逻辑与)</span><br><span class="line">        │       │</span><br><span class="line">        │       ├─► 多个表达式? ──Yes──► WriteByte(&#x27;(&#x27;)</span><br><span class="line">        │       │       │</span><br><span class="line">        │       │       └─► 遍历 Exprs</span><br><span class="line">        │       │           ├─► Build(expr)</span><br><span class="line">        │       │           ├─► i &gt; 0? ──► WriteString(&quot; AND &quot;)</span><br><span class="line">        │       │           └─► i++</span><br><span class="line">        │       │</span><br><span class="line">        │       └─► 多个表达式? ──Yes──► WriteByte(&#x27;)&#x27;)</span><br><span class="line">        │</span><br><span class="line">        ├─► OrConditions (逻辑或)</span><br><span class="line">        │       │ (类似 And，但使用 &quot; OR &quot;)</span><br><span class="line">        │</span><br><span class="line">        └─► NotConditions (逻辑非)</span><br><span class="line">                │ (见上述详细流程)</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="Where-子句完整解析-where-go-12-246"><a href="#Where-子句完整解析-where-go-12-246" class="headerlink" title="Where 子句完整解析 (where.go:12-246)"></a>Where 子句完整解析 (where.go:12-246)</h3><p><strong>完整定义</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Where WHERE 子句</span></span><br><span class="line"><span class="keyword">type</span> Where <span class="keyword">struct</span> &#123;</span><br><span class="line">    Exprs []Expression  <span class="comment">// 条件表达式列表</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Name 返回子句名称</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(where Where)</span></span> Name() <span class="type">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;WHERE&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Build 构建 WHERE 子句</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(where Where)</span></span> Build(builder Builder) &#123;</span><br><span class="line">    <span class="comment">// 1. 如果只有一个表达式且是 AndConditions，展开它</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(where.Exprs) == <span class="number">1</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> andCondition, ok := where.Exprs[<span class="number">0</span>].(AndConditions); ok &#123;</span><br><span class="line">            where.Exprs = andCondition.Exprs</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 调整位置：如果是单个 Or 条件，移到前面</span></span><br><span class="line">    <span class="keyword">for</span> idx, expr := <span class="keyword">range</span> where.Exprs &#123;</span><br><span class="line">        <span class="keyword">if</span> v, ok := expr.(OrConditions); !ok || <span class="built_in">len</span>(v.Exprs) &gt; <span class="number">1</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> idx != <span class="number">0</span> &#123;</span><br><span class="line">                where.Exprs[<span class="number">0</span>], where.Exprs[idx] = where.Exprs[idx], where.Exprs[<span class="number">0</span>]</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 构建表达式列表</span></span><br><span class="line">    buildExprs(where.Exprs, builder, <span class="string">&quot; AND &quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>buildExprs 辅助函数</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// buildExprs 构建表达式列表</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">buildExprs</span><span class="params">(exprs []Expression, builder Builder, joinCond <span class="type">string</span>)</span></span> &#123;</span><br><span class="line">    wrapInParentheses := <span class="literal">false</span>  <span class="comment">// 是否需要括号</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> idx, expr := <span class="keyword">range</span> exprs &#123;</span><br><span class="line">        <span class="comment">// 1. 添加连接符</span></span><br><span class="line">        <span class="keyword">if</span> idx &gt; <span class="number">0</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> v, ok := expr.(OrConditions); ok &amp;&amp; <span class="built_in">len</span>(v.Exprs) == <span class="number">1</span> &#123;</span><br><span class="line">                builder.WriteString(<span class="string">&quot; OR &quot;</span>)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                builder.WriteString(joinCond)  <span class="comment">// 通常是 &quot; AND &quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 判断是否需要括号</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(exprs) &gt; <span class="number">1</span> &#123;</span><br><span class="line">            <span class="keyword">switch</span> v := expr.(<span class="keyword">type</span>) &#123;</span><br><span class="line">            <span class="keyword">case</span> OrConditions:</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">len</span>(v.Exprs) == <span class="number">1</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> e, ok := v.Exprs[<span class="number">0</span>].(Expr); ok &#123;</span><br><span class="line">                        sql := strings.ToUpper(e.SQL)</span><br><span class="line">                        wrapInParentheses = strings.Contains(sql, <span class="string">&quot; AND &quot;</span>) ||</span><br><span class="line">                                            strings.Contains(sql, <span class="string">&quot; OR &quot;</span>)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            <span class="keyword">case</span> AndConditions:</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">len</span>(v.Exprs) == <span class="number">1</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> e, ok := v.Exprs[<span class="number">0</span>].(Expr); ok &#123;</span><br><span class="line">                        sql := strings.ToUpper(e.SQL)</span><br><span class="line">                        wrapInParentheses = strings.Contains(sql, <span class="string">&quot; AND &quot;</span>) ||</span><br><span class="line">                                            strings.Contains(sql, <span class="string">&quot; OR &quot;</span>)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            <span class="keyword">case</span> Expr:</span><br><span class="line">                sql := strings.ToUpper(v.SQL)</span><br><span class="line">                wrapInParentheses = strings.Contains(sql, <span class="string">&quot; AND &quot;</span>) ||</span><br><span class="line">                                    strings.Contains(sql, <span class="string">&quot; OR &quot;</span>)</span><br><span class="line">            <span class="keyword">case</span> NamedExpr:</span><br><span class="line">                sql := strings.ToUpper(v.SQL)</span><br><span class="line">                wrapInParentheses = strings.Contains(sql, <span class="string">&quot; AND &quot;</span>) ||</span><br><span class="line">                                    strings.Contains(sql, <span class="string">&quot; OR &quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 构建表达式</span></span><br><span class="line">        <span class="keyword">if</span> wrapInParentheses &#123;</span><br><span class="line">            builder.WriteByte(<span class="string">&#x27;(&#x27;</span>)</span><br><span class="line">            expr.Build(builder)</span><br><span class="line">            builder.WriteByte(<span class="string">&#x27;)&#x27;</span>)</span><br><span class="line">            wrapInParentheses = <span class="literal">false</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            expr.Build(builder)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Where 子句构建示例</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 示例 1: 简单条件</span></span><br><span class="line">where := clause.Where&#123;</span><br><span class="line">    Exprs: []clause.Expression&#123;</span><br><span class="line">        clause.Eq&#123;<span class="string">&quot;age&quot;</span>: <span class="number">18</span>&#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// SQL: WHERE age = 18</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 示例 2: AND 条件</span></span><br><span class="line">where := clause.Where&#123;</span><br><span class="line">    Exprs: []clause.Expression&#123;</span><br><span class="line">        clause.Eq&#123;<span class="string">&quot;status&quot;</span>: <span class="string">&quot;active&quot;</span>&#125;,</span><br><span class="line">        clause.Gt&#123;<span class="string">&quot;score&quot;</span>: <span class="number">80</span>&#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// SQL: WHERE status = &#x27;active&#x27; AND score &gt; 80</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 示例 3: OR 条件</span></span><br><span class="line">where := clause.Where&#123;</span><br><span class="line">    Exprs: []clause.Expression&#123;</span><br><span class="line">        clause.Or(</span><br><span class="line">            clause.Eq&#123;<span class="string">&quot;status&quot;</span>: <span class="string">&quot;active&quot;</span>&#125;,</span><br><span class="line">            clause.Eq&#123;<span class="string">&quot;vip&quot;</span>: <span class="literal">true</span>&#125;,</span><br><span class="line">        ),</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// SQL: WHERE (status = &#x27;active&#x27; OR vip = true)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 示例 4: 复合条件</span></span><br><span class="line">where := clause.Where&#123;</span><br><span class="line">    Exprs: []clause.Expression&#123;</span><br><span class="line">        clause.And(</span><br><span class="line">            clause.Eq&#123;<span class="string">&quot;age&quot;</span>: <span class="number">18</span>&#125;,</span><br><span class="line">            clause.Gt&#123;<span class="string">&quot;score&quot;</span>: <span class="number">80</span>&#125;,</span><br><span class="line">        ),</span><br><span class="line">        clause.Eq&#123;<span class="string">&quot;status&quot;</span>: <span class="string">&quot;active&quot;</span>&#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// SQL: WHERE (age = 18 AND score &gt; 80) AND status = &#x27;active&#x27;</span></span><br></pre></td></tr></table></figure>

<p><strong>MergeClause 完整实现</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MergeClause 合并 WHERE 子句</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(where Where)</span></span> MergeClause(clause *Clause) &#123;</span><br><span class="line">    <span class="comment">// 1. 检查是否已存在 WHERE 子句</span></span><br><span class="line">    <span class="keyword">if</span> w, ok := clause.Expression.(Where); ok &#123;</span><br><span class="line">        <span class="comment">// 2. 合并表达式列表</span></span><br><span class="line">        exprs := <span class="built_in">make</span>([]Expression, <span class="built_in">len</span>(w.Exprs)+<span class="built_in">len</span>(where.Exprs))</span><br><span class="line">        <span class="built_in">copy</span>(exprs, w.Exprs)              <span class="comment">// 复制原有表达式</span></span><br><span class="line">        <span class="built_in">copy</span>(exprs[<span class="built_in">len</span>(w.Exprs):], where.Exprs)  <span class="comment">// 追加新表达式</span></span><br><span class="line">        where.Exprs = exprs</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 更新子句表达式</span></span><br><span class="line">    clause.Expression = where</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>WHERE 子句流程图</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Where.Build(builder)</span><br><span class="line">        │</span><br><span class="line">        ▼</span><br><span class="line">   [只有一个表达式?]</span><br><span class="line">   len(Exprs) == 1?</span><br><span class="line">        │</span><br><span class="line">        ├─ Yes ──► 是 AndConditions? ──Yes──► 展开为多个表达式</span><br><span class="line">        │</span><br><span class="line">        ▼</span><br><span class="line">   [调整 Or 位置]</span><br><span class="line">   将单个 Or 条件移到前面</span><br><span class="line">        │</span><br><span class="line">        ▼</span><br><span class="line">   [调用 buildExprs]</span><br><span class="line">        │</span><br><span class="line">        ├─► 遍历表达式</span><br><span class="line">        │   │</span><br><span class="line">        │   ├─► 添加连接符 (AND/OR)</span><br><span class="line">        │   │</span><br><span class="line">        │   ├─► 检查是否需要括号</span><br><span class="line">        │   │   └─► 表达式包含 AND/OR ──► wrapInParentheses = true</span><br><span class="line">        │   │</span><br><span class="line">        │   └─► 构建表达式</span><br><span class="line">        │       ├─► wrapInParentheses? ──Yes──► ( expr )</span><br><span class="line">        │       └─► No ──► expr</span><br><span class="line">        │</span><br><span class="line">        ▼</span><br><span class="line">   返回</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="2-2-理论基础"><a href="#2-2-理论基础" class="headerlink" title="2.2 理论基础"></a>2.2 理论基础</h3><h4 id="理论-1-组合模式在子句系统中的应用"><a href="#理论-1-组合模式在子句系统中的应用" class="headerlink" title="理论 1: 组合模式在子句系统中的应用"></a>理论 1: 组合模式在子句系统中的应用</h4><p><strong>模式定义</strong>: 将对象组合成树形结构以表示”部分-整体”的层次结构，使用户对单个对象和组合对象的使用具有一致性。</p>
<p><strong>在子句系统中的体现</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Expression 的组合层次:</span><br><span class="line"></span><br><span class="line">Expression (接口)</span><br><span class="line">    │</span><br><span class="line">    ├─ Expr (叶子)</span><br><span class="line">    │   └─ &quot;age &gt; ?&quot;</span><br><span class="line">    │</span><br><span class="line">    ├─ And (组合)</span><br><span class="line">    │   ├─ Eq&#123;&quot;age&quot;: 18&#125;</span><br><span class="line">    │   └─ Gt&#123;&quot;score&quot;: 80&#125;</span><br><span class="line">    │</span><br><span class="line">    └─ Or (组合)</span><br><span class="line">        ├─ And&#123;...&#125;</span><br><span class="line">        └─ Eq&#123;&quot;vip&quot;: true&#125;</span><br><span class="line"></span><br><span class="line">构建时的递归处理:</span><br><span class="line">Build(Or) &#123;</span><br><span class="line">    Write(&quot;(&quot;)</span><br><span class="line">    Build(And)  // 递归</span><br><span class="line">    Write(&quot;) OR (&quot;)</span><br><span class="line">    Build(Eq)   // 递归</span><br><span class="line">    Write(&quot;)&quot;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>优势</strong>:</p>
<ul>
<li>可以无限嵌套</li>
<li>统一的 Build 接口</li>
<li>类型安全的组合</li>
</ul>
<h4 id="理论-2-访问者模式在构建中的应用"><a href="#理论-2-访问者模式在构建中的应用" class="headerlink" title="理论 2: 访问者模式在构建中的应用"></a>理论 2: 访问者模式在构建中的应用</h4><p><strong>模式定义</strong>: 在不改变集合元素的前提下，为一个对象集合上的元素定义新的操作。</p>
<p><strong>在子句构建中的体现</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Builder 作为访问者:</span><br><span class="line">┌──────────────────────────────────────┐</span><br><span class="line">│           Builder (访问者)             │</span><br><span class="line">│  ┌────────────────────────────────┐  │</span><br><span class="line">│  │ Visit(Clause) → Build()         │  │</span><br><span class="line">│  └────────────────────────────────┘  │</span><br><span class="line">└──────────────────────────────────────┘</span><br><span class="line">                    │ 访问</span><br><span class="line">                    ▼</span><br><span class="line">┌──────────────────────────────────────┐</span><br><span class="line">│         Clause (元素)                 │</span><br><span class="line">│  Accept(Builder) &#123;                   │</span><br><span class="line">│      Build(Builder)                  │</span><br><span class="line">│  &#125;                                   │</span><br><span class="line">└──────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<p><strong>代码体现</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Builder 遍历所有子句</span></span><br><span class="line"><span class="keyword">for</span> _, name := <span class="keyword">range</span> stmt.BuildClauses &#123;</span><br><span class="line">    <span class="keyword">if</span> c, ok := stmt.Clauses[name]; ok &#123;</span><br><span class="line">        c.Build(stmt)  <span class="comment">// 调用子句的 Build 方法</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 每个 Clause 实现自己的 Build 逻辑</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(where Where)</span></span> Build(builder Builder) &#123;</span><br><span class="line">    builder.WriteString(<span class="string">&quot;WHERE &quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> _, expr := <span class="keyword">range</span> where.Exprs &#123;</span><br><span class="line">        expr.Build(builder)  <span class="comment">// 表达式也实现 Build</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="理论-3-模板方法模式"><a href="#理论-3-模板方法模式" class="headerlink" title="理论 3: 模板方法模式"></a>理论 3: 模板方法模式</h4><p><strong>模式定义</strong>: 在父类中定义算法的骨架，将某些步骤延迟到子类实现。</p>
<p><strong>在 Clause.Build 中的体现</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Clause 的 Build 定义了构建框架</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c Clause)</span></span> Build(builder Builder) &#123;</span><br><span class="line">    <span class="keyword">if</span> c.Builder != <span class="literal">nil</span> &#123;</span><br><span class="line">        c.Builder(c, builder)  <span class="comment">// 自定义构建器优先</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> c.Expression != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="comment">// 标准构建流程</span></span><br><span class="line">        <span class="keyword">if</span> c.BeforeExpression != <span class="literal">nil</span> &#123;</span><br><span class="line">            c.BeforeExpression.Build(builder)</span><br><span class="line">            builder.WriteByte(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> c.Name != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">            builder.WriteString(c.Name)</span><br><span class="line">            builder.WriteByte(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        c.Expression.Build(builder)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> c.AfterExpression != <span class="literal">nil</span> &#123;</span><br><span class="line">            builder.WriteByte(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">            c.AfterExpression.Build(builder)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>优势</strong>:</p>
<ul>
<li>统一的构建流程</li>
<li>支持自定义扩展</li>
<li>灵活的位置控制</li>
</ul>
<h3 id="2-3-学习方法"><a href="#2-3-学习方法" class="headerlink" title="2.3 学习方法"></a>2.3 学习方法</h3><h4 id="方法-1-逆向工程法"><a href="#方法-1-逆向工程法" class="headerlink" title="方法 1: 逆向工程法"></a>方法 1: 逆向工程法</h4><p><strong>步骤</strong>:</p>
<ol>
<li>从一个完整的 SQL 开始</li>
<li>分解为子句</li>
<li>找到对应的 Clause 实现</li>
<li>追踪 Build 过程</li>
</ol>
<p><strong>示例</strong>:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 目标 SQL</span></span><br><span class="line"><span class="keyword">SELECT</span> id, name <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> age <span class="operator">&gt;</span> <span class="number">18</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> name <span class="keyword">DESC</span> LIMIT <span class="number">10</span></span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">-- 分解为子句</span><br><span class="line">stmt.Clauses = <span class="keyword">map</span>[<span class="type">string</span>]clause.Clause&#123;</span><br><span class="line">    <span class="string">&quot;SELECT&quot;</span>: &#123;</span><br><span class="line">        Name: <span class="string">&quot;SELECT&quot;</span>,</span><br><span class="line">        Expression: clause.Select&#123;</span><br><span class="line">            Columns: []clause.Column&#123;</span><br><span class="line">                &#123;Name: <span class="string">&quot;id&quot;</span>&#125;,</span><br><span class="line">                &#123;Name: <span class="string">&quot;name&quot;</span>&#125;,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;FROM&quot;</span>: &#123;</span><br><span class="line">        Name: <span class="string">&quot;FROM&quot;</span>,</span><br><span class="line">        Expression: clause.From&#123;Tables: []clause.Table&#123;&#123;Name: <span class="string">&quot;users&quot;</span>&#125;&#125;&#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;WHERE&quot;</span>: &#123;</span><br><span class="line">        Name: <span class="string">&quot;WHERE&quot;</span>,</span><br><span class="line">        Expression: clause.Where&#123;</span><br><span class="line">            Exprs: []clause.Expression&#123;</span><br><span class="line">                clause.Expr&#123;SQL: <span class="string">&quot;age &gt; ?&quot;</span>, Vars: []<span class="keyword">interface</span>&#123;&#125;&#123;<span class="number">18</span>&#125;&#125;,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;ORDER BY&quot;</span>: &#123;</span><br><span class="line">        Name: <span class="string">&quot;ORDER BY&quot;</span>,</span><br><span class="line">        Expression: clause.OrderBy&#123;</span><br><span class="line">            Columns: []clause.OrderByColumn&#123;</span><br><span class="line">                &#123;Column: clause.Column&#123;Name: <span class="string">&quot;name&quot;</span>&#125;, Desc: <span class="literal">true</span>&#125;,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;LIMIT&quot;</span>: &#123;</span><br><span class="line">        Name: <span class="string">&quot;LIMIT&quot;</span>,</span><br><span class="line">        Expression: clause.Limit&#123;Limit: <span class="number">10</span>&#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="方法-2-对比分析法"><a href="#方法-2-对比分析法" class="headerlink" title="方法 2: 对比分析法"></a>方法 2: 对比分析法</h4><p><strong>对比不同子句的构建方式</strong>:</p>
<table>
<thead>
<tr>
<th>子句</th>
<th>结构</th>
<th>关键字段</th>
<th>Build 特点</th>
</tr>
</thead>
<tbody><tr>
<td>SELECT</td>
<td>Select{Columns}</td>
<td>Columns</td>
<td>逗号分隔列名</td>
</tr>
<tr>
<td>WHERE</td>
<td>Where{Exprs}</td>
<td>Exprs</td>
<td>AND 连接表达式</td>
</tr>
<tr>
<td>JOIN</td>
<td>Join{Table, ON}</td>
<td>Table, ON</td>
<td>复杂的 ON 条件</td>
</tr>
<tr>
<td>ORDER BY</td>
<td>OrderBy{Columns}</td>
<td>Columns</td>
<td>支持 ASC&#x2F;DESC</td>
</tr>
<tr>
<td>LIMIT</td>
<td>Limit{Limit, Offset}</td>
<td>Limit, Offset</td>
<td>简单数值</td>
</tr>
</tbody></table>
<p><strong>对比不同数据库的差异</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MySQL 的 LIMIT</span></span><br><span class="line">LIMIT <span class="number">10</span> OFFSET <span class="number">20</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// PostgreSQL 的 LIMIT</span></span><br><span class="line">LIMIT <span class="number">10</span> OFFSET <span class="number">20</span></span><br><span class="line">-- 或</span><br><span class="line">LIMIT <span class="number">10</span> OFFSET <span class="number">20</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// SQL Server 的 LIMIT (TOP)</span></span><br><span class="line">OFFSET <span class="number">20</span> ROWS FETCH NEXT <span class="number">10</span> ROWS ONLY</span><br><span class="line"></span><br><span class="line"><span class="comment">// Oracle 的 LIMIT (ROWNUM)</span></span><br><span class="line">-- 或 FETCH FIRST</span><br><span class="line">OFFSET <span class="number">20</span> ROWS FETCH NEXT <span class="number">10</span> ROWS ONLY</span><br></pre></td></tr></table></figure>

<h4 id="方法-3-实验验证法"><a href="#方法-3-实验验证法" class="headerlink" title="方法 3: 实验验证法"></a>方法 3: 实验验证法</h4><p><strong>实验 1: 追踪 Build 过程</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 自定义 Builder 记录构建过程</span></span><br><span class="line"><span class="keyword">type</span> TracingBuilder <span class="keyword">struct</span> &#123;</span><br><span class="line">    gorm.Statement</span><br><span class="line">    trace []<span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *TracingBuilder)</span></span> WriteString(str <span class="type">string</span>) (<span class="type">int</span>, <span class="type">error</span>) &#123;</span><br><span class="line">    b.trace = <span class="built_in">append</span>(b.trace, fmt.Sprintf(<span class="string">&quot;WriteString: %q&quot;</span>, str))</span><br><span class="line">    <span class="keyword">return</span> b.Statement.WriteString(str)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *TracingBuilder)</span></span> AddVar(writer Writer, vars ...<span class="keyword">interface</span>&#123;&#125;) &#123;</span><br><span class="line">    b.trace = <span class="built_in">append</span>(b.trace, fmt.Sprintf(<span class="string">&quot;AddVar: %v&quot;</span>, vars))</span><br><span class="line">    b.Statement.AddVar(writer, vars...)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用</span></span><br><span class="line">stmt := &amp;TracingBuilder&#123;...&#125;</span><br><span class="line">stmt.Clauses[<span class="string">&quot;WHERE&quot;</span>].Build(stmt)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查看追踪</span></span><br><span class="line"><span class="keyword">for</span> _, entry := <span class="keyword">range</span> stmt.trace &#123;</span><br><span class="line">    fmt.Println(entry)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>实验 2: 自定义子句</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 实现 TOP 子句 (SQL Server)</span></span><br><span class="line"><span class="keyword">type</span> Top <span class="keyword">struct</span> &#123;</span><br><span class="line">    N <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t Top)</span></span> Name() <span class="type">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;TOP&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t Top)</span></span> Build(builder Builder) &#123;</span><br><span class="line">    builder.WriteString(fmt.Sprintf(<span class="string">&quot;TOP (%d) &quot;</span>, t.N))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t Top)</span></span> MergeClause(c *Clause) &#123;</span><br><span class="line">    c.Expression = t</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用</span></span><br><span class="line">db.Clauses(clause.Top&#123;N: <span class="number">10</span>&#125;).Find(&amp;users)</span><br><span class="line"><span class="comment">// 生成: SELECT TOP (10) * FROM users</span></span><br></pre></td></tr></table></figure>

<h3 id="2-4-实施策略"><a href="#2-4-实施策略" class="headerlink" title="2.4 实施策略"></a>2.4 实施策略</h3><h4 id="策略-1-分层学习"><a href="#策略-1-分层学习" class="headerlink" title="策略 1: 分层学习"></a>策略 1: 分层学习</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">第 1 层: 接口层 (Day 1)</span><br><span class="line">  目标: 理解接口设计</span><br><span class="line">  内容:</span><br><span class="line">    - Clause Interface</span><br><span class="line">    - Builder Interface</span><br><span class="line">    - Expression Interface</span><br><span class="line"></span><br><span class="line">第 2 层: 实现层 (Day 2)</span><br><span class="line">  目标: 理解具体实现</span><br><span class="line">  内容:</span><br><span class="line">    - 基础子句 (SELECT, WHERE)</span><br><span class="line">    - 复杂子句 (JOIN, ON CONFLICT)</span><br><span class="line">    - 对比不同实现</span><br><span class="line"></span><br><span class="line">第 3 层: 扩展层 (Day 3)</span><br><span class="line">  目标: 掌握自定义扩展</span><br><span class="line">  内容:</span><br><span class="line">    - 实现自定义子句</span><br><span class="line">    - 实现自定义表达式</span><br><span class="line">    - 集成到查询流程</span><br></pre></td></tr></table></figure>

<h4 id="策略-2-问题驱动"><a href="#策略-2-问题驱动" class="headerlink" title="策略 2: 问题驱动"></a>策略 2: 问题驱动</h4><p><strong>问题序列</strong>:</p>
<ol>
<li><p>为什么需要子句系统？</p>
<ul>
<li>对比字符串拼接和子句系统</li>
<li>理解组件化的价值</li>
</ul>
</li>
<li><p>子句如何组合？</p>
<ul>
<li>测试不同子句的组合</li>
<li>观察构建顺序的影响</li>
</ul>
</li>
<li><p>如何自定义子句？</p>
<ul>
<li>实现一个简单子句</li>
<li>测试与现有子句的协作</li>
</ul>
</li>
</ol>
<h4 id="策略-3-验证反馈"><a href="#策略-3-验证反馈" class="headerlink" title="策略 3: 验证反馈"></a>策略 3: 验证反馈</h4><p><strong>验证点 1: 理解验证</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestClauseBuild</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">    stmt := &amp;gorm.Statement&#123;...&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构建 WHERE 子句</span></span><br><span class="line">    where := clause.Where&#123;</span><br><span class="line">        Exprs: []clause.Expression&#123;</span><br><span class="line">            clause.Expr&#123;SQL: <span class="string">&quot;age &gt; ?&quot;</span>, Vars: []<span class="keyword">interface</span>&#123;&#125;&#123;<span class="number">18</span>&#125;&#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">    where.Build(stmt)</span><br><span class="line"></span><br><span class="line">    assert.Equal(t, <span class="string">&quot;WHERE age &gt; ?&quot;</span>, stmt.SQL.String())</span><br><span class="line">    assert.Equal(t, []<span class="keyword">interface</span>&#123;&#125;&#123;<span class="number">18</span>&#125;, stmt.Vars)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>验证点 2: 组合验证</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestClauseComposition</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">    stmt := &amp;gorm.Statement&#123;...&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 组合多个表达式</span></span><br><span class="line">    expr := clause.And(</span><br><span class="line">        clause.Eq&#123;<span class="string">&quot;status&quot;</span>: <span class="string">&quot;active&quot;</span>&#125;,</span><br><span class="line">        clause.Gt&#123;<span class="string">&quot;score&quot;</span>: <span class="number">80</span>&#125;,</span><br><span class="line">    )</span><br><span class="line">    expr.Build(stmt)</span><br><span class="line"></span><br><span class="line">    expected := <span class="string">&quot;(status = &#x27;active&#x27;) AND (score &gt; 80)&quot;</span></span><br><span class="line">    assert.Equal(t, expected, stmt.SQL.String())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="三、学习路径建议"><a href="#三、学习路径建议" class="headerlink" title="三、学习路径建议"></a>三、学习路径建议</h2><h3 id="3-1-前置知识检查"><a href="#3-1-前置知识检查" class="headerlink" title="3.1 前置知识检查"></a>3.1 前置知识检查</h3><table>
<thead>
<tr>
<th>知识点</th>
<th>要求</th>
<th>检验方式</th>
</tr>
</thead>
<tbody><tr>
<td>SQL 语法</td>
<td>熟悉 DML、DDL</td>
<td>能写出复杂查询</td>
</tr>
<tr>
<td>接口设计</td>
<td>理解接口组合</td>
<td>能设计简单接口</td>
</tr>
<tr>
<td>设计模式</td>
<td>了解组合模式</td>
<td>能识别应用场景</td>
</tr>
<tr>
<td>字符串处理</td>
<td>理解 Builder 模式</td>
<td>能实现简单 Builder</td>
</tr>
</tbody></table>
<h3 id="3-2-学习时间分配"><a href="#3-2-学习时间分配" class="headerlink" title="3.2 学习时间分配"></a>3.2 学习时间分配</h3><table>
<thead>
<tr>
<th>内容</th>
<th>理论</th>
<th>实践</th>
<th>产出</th>
</tr>
</thead>
<tbody><tr>
<td>Day 1: 接口体系</td>
<td>2h</td>
<td>1.5h</td>
<td>接口图</td>
</tr>
<tr>
<td>Day 2: 子句实现</td>
<td>1.5h</td>
<td>2h</td>
<td>对比表</td>
</tr>
<tr>
<td>Day 3: 自定义扩展</td>
<td>1.5h</td>
<td>2h</td>
<td>自定义子句</td>
</tr>
</tbody></table>
<h3 id="3-3-学习成果验收"><a href="#3-3-学习成果验收" class="headerlink" title="3.3 学习成果验收"></a>3.3 学习成果验收</h3><p><strong>理论验收</strong>:</p>
<ul>
<li><input disabled="" type="checkbox"> 能解释 Clause 接口的设计</li>
<li><input disabled="" type="checkbox"> 能说明 Builder 的职责</li>
<li><input disabled="" type="checkbox"> 能区分不同的 Expression 类型</li>
</ul>
<p><strong>实践验收</strong>:</p>
<ul>
<li><input disabled="" type="checkbox"> 能使用子句构建查询</li>
<li><input disabled="" type="checkbox"> 能实现自定义表达式</li>
<li><input disabled="" type="checkbox"> 能实现自定义子句</li>
</ul>
<hr>
<h2 id="四、实战代码示例"><a href="#四、实战代码示例" class="headerlink" title="四、实战代码示例"></a>四、实战代码示例</h2><h3 id="4-1-基础子句使用示例"><a href="#4-1-基础子句使用示例" class="headerlink" title="4.1 基础子句使用示例"></a>4.1 基础子句使用示例</h3><h4 id="示例-1-SELECT-子句"><a href="#示例-1-SELECT-子句" class="headerlink" title="示例 1: SELECT 子句"></a>示例 1: SELECT 子句</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;gorm.io/gorm&quot;</span></span><br><span class="line">    <span class="string">&quot;gorm.io/gorm/clause&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">    ID    <span class="type">uint</span></span><br><span class="line">    Name  <span class="type">string</span></span><br><span class="line">    Email <span class="type">string</span></span><br><span class="line">    Age   <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    db, _ := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. 查询所有列</span></span><br><span class="line">    <span class="keyword">var</span> users1 []User</span><br><span class="line">    db.Find(&amp;users1)</span><br><span class="line">    <span class="comment">// SQL: SELECT * FROM users</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 指定列</span></span><br><span class="line">    <span class="keyword">var</span> users2 []User</span><br><span class="line">    db.Select(<span class="string">&quot;id&quot;</span>, <span class="string">&quot;name&quot;</span>).Find(&amp;users2)</span><br><span class="line">    <span class="comment">// SQL: SELECT id, name FROM users</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 使用子句结构</span></span><br><span class="line">    <span class="keyword">var</span> users3 []User</span><br><span class="line">    db.Clauses(clause.Select&#123;</span><br><span class="line">        Columns: []clause.Column&#123;</span><br><span class="line">            &#123;Name: <span class="string">&quot;id&quot;</span>&#125;,</span><br><span class="line">            &#123;Name: <span class="string">&quot;name&quot;</span>&#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;).Find(&amp;users3)</span><br><span class="line">    <span class="comment">// SQL: SELECT id, name FROM users</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. DISTINCT 查询</span></span><br><span class="line">    <span class="keyword">var</span> ages []<span class="type">int</span></span><br><span class="line">    db.Distinct(<span class="string">&quot;age&quot;</span>).Pluck(<span class="string">&quot;age&quot;</span>, &amp;ages)</span><br><span class="line">    <span class="comment">// SQL: SELECT DISTINCT age FROM users</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5. 带别名的列</span></span><br><span class="line">    <span class="keyword">var</span> users4 []User</span><br><span class="line">    db.Select(<span class="string">&quot;id as user_id&quot;</span>, <span class="string">&quot;name&quot;</span>).Find(&amp;users4)</span><br><span class="line">    <span class="comment">// SQL: SELECT id as user_id, name FROM users</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="示例-2-WHERE-子句"><a href="#示例-2-WHERE-子句" class="headerlink" title="示例 2: WHERE 子句"></a>示例 2: WHERE 子句</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 简单条件</span></span><br><span class="line">db.Where(<span class="string">&quot;age &gt; ?&quot;</span>, <span class="number">18</span>).Find(&amp;users)</span><br><span class="line"><span class="comment">// SQL: SELECT * FROM users WHERE age &gt; 18</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 使用 Eq 表达式</span></span><br><span class="line">db.Where(clause.Eq&#123;<span class="string">&quot;status&quot;</span>: <span class="string">&quot;active&quot;</span>&#125;).Find(&amp;users)</span><br><span class="line"><span class="comment">// SQL: SELECT * FROM users WHERE status = &#x27;active&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 多个条件 (AND)</span></span><br><span class="line">db.Where(</span><br><span class="line">    clause.And(</span><br><span class="line">        clause.Eq&#123;<span class="string">&quot;status&quot;</span>: <span class="string">&quot;active&quot;</span>&#125;,</span><br><span class="line">        clause.Gt&#123;<span class="string">&quot;age&quot;</span>: <span class="number">18</span>&#125;,</span><br><span class="line">    ),</span><br><span class="line">).Find(&amp;users)</span><br><span class="line"><span class="comment">// SQL: SELECT * FROM users WHERE (status = &#x27;active&#x27; AND age &gt; 18)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. OR 条件</span></span><br><span class="line">db.Where(</span><br><span class="line">    clause.Or(</span><br><span class="line">        clause.Eq&#123;<span class="string">&quot;status&quot;</span>: <span class="string">&quot;active&quot;</span>&#125;,</span><br><span class="line">        clause.Eq&#123;<span class="string">&quot;vip&quot;</span>: <span class="literal">true</span>&#125;,</span><br><span class="line">    ),</span><br><span class="line">).Find(&amp;users)</span><br><span class="line"><span class="comment">// SQL: SELECT * FROM users WHERE (status = &#x27;active&#x27; OR vip = true)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 5. 复杂条件</span></span><br><span class="line">db.Where(</span><br><span class="line">    clause.Or(</span><br><span class="line">        clause.And(</span><br><span class="line">            clause.Eq&#123;<span class="string">&quot;age&quot;</span>: <span class="number">18</span>&#125;,</span><br><span class="line">            clause.Eq&#123;<span class="string">&quot;status&quot;</span>: <span class="string">&quot;active&quot;</span>&#125;,</span><br><span class="line">        ),</span><br><span class="line">        clause.Eq&#123;<span class="string">&quot;vip&quot;</span>: <span class="literal">true</span>&#125;,</span><br><span class="line">    ),</span><br><span class="line">).Find(&amp;users)</span><br><span class="line"><span class="comment">// SQL: SELECT * FROM users WHERE ((age = 18 AND status = &#x27;active&#x27;) OR vip = true)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 6. NOT 条件</span></span><br><span class="line">db.Where(</span><br><span class="line">    clause.Not(</span><br><span class="line">        clause.Eq&#123;<span class="string">&quot;status&quot;</span>: <span class="string">&quot;deleted&quot;</span>&#125;,</span><br><span class="line">    ),</span><br><span class="line">).Find(&amp;users)</span><br><span class="line"><span class="comment">// SQL: SELECT * FROM users WHERE NOT (status = &#x27;deleted&#x27;)</span></span><br></pre></td></tr></table></figure>

<h4 id="示例-3-ORDER-BY-子句"><a href="#示例-3-ORDER-BY-子句" class="headerlink" title="示例 3: ORDER BY 子句"></a>示例 3: ORDER BY 子句</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 单列升序</span></span><br><span class="line">db.Order(<span class="string">&quot;name&quot;</span>).Find(&amp;users)</span><br><span class="line"><span class="comment">// SQL: SELECT * FROM users ORDER BY name</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 单列降序</span></span><br><span class="line">db.Order(<span class="string">&quot;name desc&quot;</span>).Find(&amp;users)</span><br><span class="line"><span class="comment">// SQL: SELECT * FROM users ORDER BY name DESC</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 使用子句结构</span></span><br><span class="line">db.Clauses(clause.OrderBy&#123;</span><br><span class="line">    Columns: []clause.OrderByColumn&#123;</span><br><span class="line">        &#123;Column: clause.Column&#123;Name: <span class="string">&quot;age&quot;</span>&#125;, Desc: <span class="literal">true</span>&#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;).Find(&amp;users)</span><br><span class="line"><span class="comment">// SQL: SELECT * FROM users ORDER BY age DESC</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. 多列排序</span></span><br><span class="line">db.Order(<span class="string">&quot;age desc&quot;</span>).Order(<span class="string">&quot;name asc&quot;</span>).Find(&amp;users)</span><br><span class="line"><span class="comment">// SQL: SELECT * FROM users ORDER BY age DESC, name ASC</span></span><br></pre></td></tr></table></figure>

<h3 id="4-2-高级子句示例"><a href="#4-2-高级子句示例" class="headerlink" title="4.2 高级子句示例"></a>4.2 高级子句示例</h3><h4 id="示例-4-JOIN-子句"><a href="#示例-4-JOIN-子句" class="headerlink" title="示例 4: JOIN 子句"></a>示例 4: JOIN 子句</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 内连接</span></span><br><span class="line">db.Table(<span class="string">&quot;users&quot;</span>).</span><br><span class="line">    Joins(<span class="string">&quot;JOIN profiles ON profiles.user_id = users.id&quot;</span>).</span><br><span class="line">    Find(&amp;users)</span><br><span class="line"><span class="comment">// SQL: SELECT * FROM users JOIN profiles ON profiles.user_id = users.id</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 使用子句结构</span></span><br><span class="line">db.Table(<span class="string">&quot;users&quot;</span>).</span><br><span class="line">    Clauses(clause.Join&#123;</span><br><span class="line">        Type:  <span class="string">&quot;LEFT&quot;</span>,</span><br><span class="line">        Table: clause.Table&#123;Name: <span class="string">&quot;profiles&quot;</span>&#125;,</span><br><span class="line">        ON: clause.Where&#123;</span><br><span class="line">            Exprs: []clause.Expression&#123;</span><br><span class="line">                clause.Eq&#123;</span><br><span class="line">                    Column: clause.Column&#123;Table: <span class="string">&quot;profiles&quot;</span>, Name: <span class="string">&quot;user_id&quot;</span>&#125;,</span><br><span class="line">                    Value:  clause.Column&#123;Table: <span class="string">&quot;users&quot;</span>, Name: <span class="string">&quot;id&quot;</span>&#125;,</span><br><span class="line">                &#125;,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;).</span><br><span class="line">    Find(&amp;users)</span><br><span class="line"><span class="comment">// SQL: SELECT * FROM users LEFT JOIN profiles ON profiles.user_id = users.id</span></span><br></pre></td></tr></table></figure>

<h4 id="示例-5-LIMIT-和-OFFSET"><a href="#示例-5-LIMIT-和-OFFSET" class="headerlink" title="示例 5: LIMIT 和 OFFSET"></a>示例 5: LIMIT 和 OFFSET</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 分页查询</span></span><br><span class="line">db.Limit(<span class="number">10</span>).Offset(<span class="number">20</span>).Find(&amp;users)</span><br><span class="line"><span class="comment">// SQL: SELECT * FROM users LIMIT 10 OFFSET 20</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 使用子句结构</span></span><br><span class="line">db.Clauses(clause.Limit&#123;</span><br><span class="line">    Limit:  <span class="number">10</span>,</span><br><span class="line">    Offset: <span class="number">20</span>,</span><br><span class="line">&#125;).Find(&amp;users)</span><br><span class="line"><span class="comment">// SQL: SELECT * FROM users LIMIT 10 OFFSET 20</span></span><br></pre></td></tr></table></figure>

<h4 id="示例-6-IN-查询"><a href="#示例-6-IN-查询" class="headerlink" title="示例 6: IN 查询"></a>示例 6: IN 查询</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 使用切片</span></span><br><span class="line">ids := []<span class="type">uint</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;</span><br><span class="line">db.Where(<span class="string">&quot;id IN ?&quot;</span>, ids).Find(&amp;users)</span><br><span class="line"><span class="comment">// SQL: SELECT * FROM users WHERE id IN (1, 2, 3)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 使用 IN 表达式</span></span><br><span class="line">db.Where(clause.IN&#123;</span><br><span class="line">    Column: <span class="string">&quot;id&quot;</span>,</span><br><span class="line">    Values: []<span class="keyword">interface</span>&#123;&#125;&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;,</span><br><span class="line">&#125;).Find(&amp;users)</span><br><span class="line"><span class="comment">// SQL: SELECT * FROM users WHERE id IN (1, 2, 3)</span></span><br></pre></td></tr></table></figure>

<h3 id="4-3-自定义子句示例"><a href="#4-3-自定义子句示例" class="headerlink" title="4.3 自定义子句示例"></a>4.3 自定义子句示例</h3><h4 id="示例-7-实现-FOR-UPDATE-子句"><a href="#示例-7-实现-FOR-UPDATE-子句" class="headerlink" title="示例 7: 实现 FOR UPDATE 子句"></a>示例 7: 实现 FOR UPDATE 子句</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义 FOR UPDATE 子句</span></span><br><span class="line"><span class="keyword">type</span> ForUpdate <span class="keyword">struct</span> &#123;</span><br><span class="line">    Tables      []<span class="type">string</span></span><br><span class="line">    Wait        <span class="type">bool</span></span><br><span class="line">    SkipLocked  <span class="type">bool</span></span><br><span class="line">    NoWait      <span class="type">bool</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f ForUpdate)</span></span> Name() <span class="type">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;FOR UPDATE&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f ForUpdate)</span></span> Build(builder Builder) &#123;</span><br><span class="line">    builder.WriteString(<span class="string">&quot;FOR UPDATE&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(f.Tables) &gt; <span class="number">0</span> &#123;</span><br><span class="line">        builder.WriteString(<span class="string">&quot; OF &quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> i, table := <span class="keyword">range</span> f.Tables &#123;</span><br><span class="line">            <span class="keyword">if</span> i &gt; <span class="number">0</span> &#123;</span><br><span class="line">                builder.WriteByte(<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            builder.WriteString(table)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> f.NoWait &#123;</span><br><span class="line">        builder.WriteString(<span class="string">&quot; NOWAIT&quot;</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> f.SkipLocked &#123;</span><br><span class="line">        builder.WriteString(<span class="string">&quot; SKIP LOCKED&quot;</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> f.Wait &#123;</span><br><span class="line">        builder.WriteString(<span class="string">&quot; WAIT&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f ForUpdate)</span></span> MergeClause(c *Clause) &#123;</span><br><span class="line">    c.Expression = f</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用</span></span><br><span class="line">db.Clauses(ForUpdate&#123;SkipLocked: <span class="literal">true</span>&#125;).Find(&amp;user)</span><br><span class="line"><span class="comment">// SQL: SELECT * FROM users WHERE id = 1 FOR UPDATE SKIP LOCKED</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="五、最佳实践与故障排查"><a href="#五、最佳实践与故障排查" class="headerlink" title="五、最佳实践与故障排查"></a>五、最佳实践与故障排查</h2><h3 id="5-1-子句使用最佳实践"><a href="#5-1-子句使用最佳实践" class="headerlink" title="5.1 子句使用最佳实践"></a>5.1 子句使用最佳实践</h3><h4 id="1-使用类型安全的表达式"><a href="#1-使用类型安全的表达式" class="headerlink" title="1. 使用类型安全的表达式"></a>1. 使用类型安全的表达式</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 推荐：使用类型安全的表达式</span></span><br><span class="line">db.Where(</span><br><span class="line">    clause.And(</span><br><span class="line">        clause.Eq&#123;<span class="string">&quot;status&quot;</span>: <span class="string">&quot;active&quot;</span>&#125;,</span><br><span class="line">        clause.Gt&#123;<span class="string">&quot;age&quot;</span>: <span class="number">18</span>&#125;,</span><br><span class="line">    ),</span><br><span class="line">).Find(&amp;users)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 不推荐：使用字符串拼接</span></span><br><span class="line">db.Where(<span class="string">&quot;status = ? AND age &gt; ?&quot;</span>, <span class="string">&quot;active&quot;</span>, <span class="number">18</span>).Find(&amp;users)</span><br></pre></td></tr></table></figure>

<h4 id="2-合理使用子句合并"><a href="#2-合理使用子句合并" class="headerlink" title="2. 合理使用子句合并"></a>2. 合理使用子句合并</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 子句会自动合并</span></span><br><span class="line">query := db.Where(<span class="string">&quot;age &gt; ?&quot;</span>, <span class="number">18</span>)</span><br><span class="line">query = query.Where(<span class="string">&quot;status = ?&quot;</span>, <span class="string">&quot;active&quot;</span>)</span><br><span class="line"><span class="comment">// 最终 SQL: WHERE age &gt; 18 AND status = &#x27;active&#x27;</span></span><br></pre></td></tr></table></figure>

<h4 id="3-使用-Distinct-去重"><a href="#3-使用-Distinct-去重" class="headerlink" title="3. 使用 Distinct 去重"></a>3. 使用 Distinct 去重</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查询不重复的值</span></span><br><span class="line"><span class="keyword">var</span> uniqueAges []<span class="type">int</span></span><br><span class="line">db.Model(&amp;User&#123;&#125;).Distinct(<span class="string">&quot;age&quot;</span>).Pluck(<span class="string">&quot;age&quot;</span>, &amp;uniqueAges)</span><br><span class="line"><span class="comment">// SQL: SELECT DISTINCT age FROM users</span></span><br></pre></td></tr></table></figure>

<h3 id="5-2-常见问题与解决方案"><a href="#5-2-常见问题与解决方案" class="headerlink" title="5.2 常见问题与解决方案"></a>5.2 常见问题与解决方案</h3><h4 id="问题-1-表达式括号不正确"><a href="#问题-1-表达式括号不正确" class="headerlink" title="问题 1: 表达式括号不正确"></a>问题 1: 表达式括号不正确</h4><p><strong>症状</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 期望: WHERE (age = 18 AND status = &#x27;active&#x27;) OR vip = true</span></span><br><span class="line"><span class="comment">//实际: WHERE age = 18 AND status = &#x27;active&#x27; OR vip = true</span></span><br></pre></td></tr></table></figure>

<p><strong>解决方案</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用 Or 和 And 明确分组</span></span><br><span class="line">db.Where(</span><br><span class="line">    clause.Or(</span><br><span class="line">        clause.And(</span><br><span class="line">            clause.Eq&#123;<span class="string">&quot;age&quot;</span>: <span class="number">18</span>&#125;,</span><br><span class="line">            clause.Eq&#123;<span class="string">&quot;status&quot;</span>: <span class="string">&quot;active&quot;</span>&#125;,</span><br><span class="line">        ),</span><br><span class="line">        clause.Eq&#123;<span class="string">&quot;vip&quot;</span>: <span class="literal">true</span>&#125;,</span><br><span class="line">    ),</span><br><span class="line">).Find(&amp;users)</span><br></pre></td></tr></table></figure>

<h4 id="问题-2-IN-查询为空"><a href="#问题-2-IN-查询为空" class="headerlink" title="问题 2: IN 查询为空"></a>问题 2: IN 查询为空</h4><p><strong>症状</strong>: 当传入空切片时，IN 查询语法错误</p>
<p><strong>解决方案</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 检查切片是否为空</span></span><br><span class="line">ids := []<span class="type">uint</span>&#123;&#125;</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(ids) &gt; <span class="number">0</span> &#123;</span><br><span class="line">    db.Where(<span class="string">&quot;id IN ?&quot;</span>, ids).Find(&amp;users)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    db.Find(&amp;users)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 或使用条件构建</span></span><br><span class="line">query := db.Where(<span class="string">&quot;1 = 1&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(ids) &gt; <span class="number">0</span> &#123;</span><br><span class="line">    query = query.Where(<span class="string">&quot;id IN ?&quot;</span>, ids)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="问题-3-ORDER-BY-方向错误"><a href="#问题-3-ORDER-BY-方向错误" class="headerlink" title="问题 3: ORDER BY 方向错误"></a>问题 3: ORDER BY 方向错误</h4><p><strong>症状</strong>: 排序结果与预期相反</p>
<p><strong>解决方案</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 明确指定排序方向</span></span><br><span class="line">db.Order(<span class="string">&quot;age DESC&quot;</span>).Find(&amp;users)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 或使用子句结构</span></span><br><span class="line">db.Clauses(clause.OrderBy&#123;</span><br><span class="line">    Columns: []clause.OrderByColumn&#123;</span><br><span class="line">        &#123;Column: clause.Column&#123;Name: <span class="string">&quot;age&quot;</span>&#125;, Desc: <span class="literal">true</span>&#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;).Find(&amp;users)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="六、学习验证"><a href="#六、学习验证" class="headerlink" title="六、学习验证"></a>六、学习验证</h2><h3 id="6-1-知识自测"><a href="#6-1-知识自测" class="headerlink" title="6.1 知识自测"></a>6.1 知识自测</h3><h4 id="基础题"><a href="#基础题" class="headerlink" title="基础题"></a>基础题</h4><ol>
<li><p><strong>Clause 接口必须实现哪些方法？</strong></p>
<ul>
<li>A. Name() 和 Build()</li>
<li>B. Name()、Build() 和 MergeClause()</li>
<li>C. Build() 和 MergeClause()</li>
<li>D. 只有 Build()</li>
</ul>
</li>
<li><p><strong>以下哪个是正确的 WHERE 子句构建方式？</strong></p>
<ul>
<li><code>db.Where(&quot;age &gt; 18&quot;).Where(&quot;status = &#39;active&#39;&quot;)</code></li>
<li><code>db.Where(&quot;age &gt; 18 AND status = &#39;active&#39;&quot;)</code></li>
<li>以上都可以</li>
</ul>
</li>
<li><p><strong>Expression 接口的 Build 方法接收什么参数？</strong></p>
<ul>
<li>A. *Statement</li>
<li>B. Builder</li>
<li>C. *DB</li>
<li>D. Writer</li>
</ul>
</li>
</ol>
<h4 id="进阶题"><a href="#进阶题" class="headerlink" title="进阶题"></a>进阶题</h4><ol start="4">
<li><p><strong>如何实现自定义子句？</strong></p>
<ul>
<li>实现 Clause 接口</li>
<li>实现 Expression 接口</li>
<li>直接嵌入 Clause 结构体</li>
<li>继承现有子句</li>
</ul>
</li>
<li><p><strong>以下代码生成的 SQL 是什么？</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">db.Where(</span><br><span class="line">    clause.Or(</span><br><span class="line">        clause.And(</span><br><span class="line">            clause.Eq&#123;<span class="string">&quot;age&quot;</span>: <span class="number">18</span>&#125;,</span><br><span class="line">            clause.Eq&#123;<span class="string">&quot;status&quot;</span>: <span class="string">&quot;active&quot;</span>&#125;,</span><br><span class="line">        ),</span><br><span class="line">        clause.Eq&#123;<span class="string">&quot;vip&quot;</span>: <span class="literal">true</span>&#125;,</span><br><span class="line">    ),</span><br><span class="line">).Find(&amp;users)</span><br></pre></td></tr></table></figure>
<ul>
<li><code>WHERE age = 18 AND status = &#39;active&#39; OR vip = true</code></li>
<li><code>WHERE ((age = 18 AND status = &#39;active&#39;) OR vip = true)</code></li>
<li><code>WHERE (age = 18 AND status = &#39;active&#39;) OR (vip = true)</code></li>
</ul>
</li>
</ol>
<h3 id="6-2-实践练习"><a href="#6-2-实践练习" class="headerlink" title="6.2 实践练习"></a>6.2 实践练习</h3><h4 id="练习-1-实现自定义表达式"><a href="#练习-1-实现自定义表达式" class="headerlink" title="练习 1: 实现自定义表达式"></a>练习 1: 实现自定义表达式</h4><p>实现一个 <code>Between</code> 表达式，用于生成 <code>BETWEEN</code> SQL：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Between <span class="keyword">struct</span> &#123;</span><br><span class="line">    Column <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">    Min    <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">    Max    <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b Between)</span></span> Build(builder Builder) &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> 实现 Build 方法</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 目标输出:</span></span><br><span class="line"><span class="comment">// db.Where(clause.Between&#123;&quot;age&quot;: 18, 60&#125;).Find(&amp;users)</span></span><br><span class="line"><span class="comment">// SQL: WHERE age BETWEEN 18 AND 60</span></span><br></pre></td></tr></table></figure>

<h4 id="练习-2-实现-FULL-OUTER-JOIN"><a href="#练习-2-实现-FULL-OUTER-JOIN" class="headerlink" title="练习 2: 实现 FULL OUTER JOIN"></a>练习 2: 实现 FULL OUTER JOIN</h4><p>为不支持 FULL OUTER JOIN 的数据库（如 MySQL）实现等价查询：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MySQL 不支持 FULL OUTER JOIN</span></span><br><span class="line"><span class="comment">// 需要使用 UNION 来模拟</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> FullJoin <span class="keyword">struct</span> &#123;</span><br><span class="line">    LeftTable  <span class="type">string</span></span><br><span class="line">    RightTable <span class="type">string</span></span><br><span class="line">    OnClause   <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f FullJoin)</span></span> Build(builder Builder) &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> 实现 FULL OUTER JOIN 的等价查询</span></span><br><span class="line">    <span class="comment">// 使用 LEFT JOIN UNION RIGHT JOIN</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a target="_blank" rel="noopener" href="https://github.com/Piwriw">Joohwan.</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://piwriw.github.io/2026/01/11/web/gorm/04-clause/">https://piwriw.github.io/2026/01/11/web/gorm/04-clause/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://piwriw.github.io" target="_blank">Joohwan</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/web/">web</a><a class="post-meta__tags" href="/tags/Gorm/">Gorm</a><a class="post-meta__tags" href="/tags/%E6%BA%90%E7%A0%81/">源码</a></div><div class="post-share"><div class="social-share" data-image="/img/go.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>赞助</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2026/01/11/web/gorm/05-callback/" title="Gorm-回调钩子模块原理说明"><img class="cover" src="/img/go.png" onerror="onerror=null;src='/img/404.png'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">Gorm-回调钩子模块原理说明</div></div><div class="info-2"><div class="info-item-1">回调钩子模块原理说明 基于1.31 本文档深入解析回调钩子模块的设计原理和核心原理，涵盖事件驱动机制、责任链模式、钩子注册与执行等核心内容。   一、设计原理1.1 模块定位在整体架构中的位置 回调钩子模块是 GORM 的事件驱动层，位于查询构建和 SQL 执行之间，负责在数据操作的生命周期中插入自定义逻辑。 1234567891011121314151617181920212223242526272829303132333435┌─────────────────────────────────────────────────────────────┐│                    Finisher API                              ││                      db.Find(&amp;users)                         │└────────────────────────┬────────────────────────────────────┘                      ...</div></div></div></a><a class="pagination-related" href="/2026/01/11/web/gorm/03-schema/" title="Gorm-Schema 数据映射模块原理说明"><img class="cover" src="/img/go.png" onerror="onerror=null;src='/img/404.png'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">Gorm-Schema 数据映射模块原理说明</div></div><div class="info-2"><div class="info-item-1">Schema 数据映射模块原理说明 基于1.31 本文档深入解析 Schema 数据映射模块的设计原理和核心原理，涵盖元数据管理、类型映射、关系解析等核心概念。   一、设计原理1.1 模块定位在整体架构中的位置 Schema 模块是 GORM 的”元数据层”，位于连接管理之上、查询构建之下，承担着连接 Go 世界与数据库世界的桥梁作用。 12345678910111213141516171819┌─────────────────────────────────────────────────────────────┐│                      Go 语言世界                              ││                   type User struct &#123; ... &#125;                    │└────────────────────────┬────────────────────────────────────┘                         │ 反射解析    ...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2026/01/11/web/gorm/09-logger/" title="Gorm-日志系统模块原理说明"><img class="cover" src="/img/go.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-01-11</div><div class="info-item-2">Gorm-日志系统模块原理说明</div></div><div class="info-2"><div class="info-item-1">日志系统模块原理说明 基于1.31 本文档深入解析日志系统模块的设计原理和核心实现，涵盖 SQL 日志记录、性能分析、调用栈追踪等核心内容。学习完本文档后，您将能够彻底理解 GORM 日志系统的工作机制，并能够实现自定义 Logger 来满足各种日志需求。  文档目录12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394959697989910010110210310410510610710810911011111211311411511611711811912012112212312412512612712812913013113213313413513613713813914009-logger.md├── 一、设计原理│   ├── 1.1 模块定位│   ├── 1.2 设...</div></div></div></a><a class="pagination-related" href="/2026/01/11/web/gorm/08-migration/" title="Gorm-迁移功能模块原理说明"><img class="cover" src="/img/go.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-01-11</div><div class="info-item-2">Gorm-迁移功能模块原理说明</div></div><div class="info-2"><div class="info-item-1">迁移功能模块原理说明 基于1.31 本文档深入解析迁移功能模块的设计原理和核心实现，涵盖数据库结构管理、类型映射、约束管理等核心内容。学习完本文档后，您将能够彻底理解 GORM 迁移系统的工作机制，并能够在实际项目中安全高效地进行数据库迁移。  文档目录1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798991001011021031041051061071081091101111121131141151161171181191201211221231241251261271281291301311321331341351361371381391401411421431441451461471481491501511521531541551561571581591...</div></div></div></a><a class="pagination-related" href="/2026/01/11/web/gorm/10-plugin/" title="Gorm-插件系统模块原理说明"><img class="cover" src="/img/go.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-01-11</div><div class="info-item-2">Gorm-插件系统模块原理说明</div></div><div class="info-2"><div class="info-item-1">插件系统模块原理说明 基于1.31 本文档深入解析插件系统模块的设计原理和核心实现，涵盖扩展机制、插件开发、集成模式等核心内容。  目录 一、设计原理 1.1 模块定位 1.2 设计目的 1.3 结构安排依据 1.4 与其他模块的逻辑关系 1.5 插件类型分类   二、核心数据结构 2.1 Plugin 接口 2.2 Config 插件字段 2.3 Use() 方法   三、核心实现 3.1 插件注册机制 3.2 插件初始化流程 3.3 回调系统集成 3.4 插件状态管理   四、实战代码示例 4.1 基础插件开发 4.2 读写分离插件 4.3 查询缓存插件 4.4 性能监控插件 4.5 数据脱敏插件   五、可视化流程图 5.1 插件注册流程 5.2 插件初始化流程 5.3 回调集成流程 5.4 插件系统架构   六、最佳实践与故障排查 6.1 开发最佳实践 6.2 常见问题与解决方案 6.3 性能优化建议 6.4 安全建议   七、学习验证 7.1 知识自测 7.2 实践练习     一、设计原理1.1 模块定位在整体架构中的位置 插件系统是 GORM 的扩展机制，位于应用层...</div></div></div></a><a class="pagination-related" href="/2026/01/11/web/gorm/07-transaction/" title="Gorm-事务处理模块原理说明"><img class="cover" src="/img/go.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-01-11</div><div class="info-item-2">Gorm-事务处理模块原理说明</div></div><div class="info-2"><div class="info-item-1">事务处理模块原理说明 基于1.31 本文档深入解析事务处理模块的设计原理和核心实现，涵盖事务管理、嵌套事务、保存点机制等核心内容。通过阅读本文档，您将能够完全理解 GORM 事务处理模块的工作原理，无需额外阅读源码。   目录 一、设计原理 1.1 模块定位 1.2 设计目的 1.3 结构安排依据 1.4 与其他模块的逻辑关系   二、核心数据结构 2.1 事务相关接口 2.2 TxOptions 配置   三、事务核心实现 3.1 Transaction 函数完整实现 3.2 Begin 函数完整实现 3.3 Commit 和 Rollback 实现 3.4 SavePoint 和 RollbackTo 实现 3.5 事务执行流程图   四、默认事务机制 4.1 BeginTransaction 实现 4.2 CommitOrRollbackTransaction 实现 4.3 回调注册流程 4.4 默认事务流程图   五、实战代码示例 5.1 基础事务使用 5.2 嵌套事务使用 5.3 手动事务控制 5.4 保存点使用 5.5 隔离级别配置 5.6 复杂业务场景   六、最佳...</div></div></div></a><a class="pagination-related" href="/2026/01/11/web/gorm/06-associations/" title="Gorm-关联关系模块原理说明"><img class="cover" src="/img/go.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-01-11</div><div class="info-item-2">Gorm-关联关系模块原理说明</div></div><div class="info-2"><div class="info-item-1">关联关系模块原理说明  基于1.31 本文档深入解析关联关系模块的设计原理和核心实现，涵盖关系推断、预加载机制、N+1 问题解决、Association API 等核心内容。通过阅读本文档，您将能够完全理解 GORM 关联关系模块的工作原理，无需额外阅读源码。   目录 一、设计原理 1.1 模块定位 1.2 设计目的 1.3 结构安排依据 1.4 与其他模块的逻辑关系   二、核心数据结构 2.1 Relationship 结构完整解析 2.2 Relationships 结构 2.3 Reference 结构 2.4 Polymorphic 结构   三、关系推断机制 3.1 parseRelation 函数完整实现 3.2 guessRelation 函数完整实现 3.3 buildPolymorphicRelation 实现 3.4 buildMany2ManyRelation 实现 3.5 关系推断决策树   四、预加载机制 4.1 preloadEntryPoint 完整实现 4.2 preload 函数完整实现 4.3 Preload 执行流程图 4.4 嵌套预加载...</div></div></div></a><a class="pagination-related" href="/2026/01/11/web/gorm/05-callback/" title="Gorm-回调钩子模块原理说明"><img class="cover" src="/img/go.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-01-11</div><div class="info-item-2">Gorm-回调钩子模块原理说明</div></div><div class="info-2"><div class="info-item-1">回调钩子模块原理说明 基于1.31 本文档深入解析回调钩子模块的设计原理和核心原理，涵盖事件驱动机制、责任链模式、钩子注册与执行等核心内容。   一、设计原理1.1 模块定位在整体架构中的位置 回调钩子模块是 GORM 的事件驱动层，位于查询构建和 SQL 执行之间，负责在数据操作的生命周期中插入自定义逻辑。 1234567891011121314151617181920212223242526272829303132333435┌─────────────────────────────────────────────────────────────┐│                    Finisher API                              ││                      db.Find(&amp;users)                         │└────────────────────────┬────────────────────────────────────┘                      ...</div></div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Joohwan.</div><div class="author-info-description">该知道的都知道，不知道的慢慢了解</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">259</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">76</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">60</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/piwriw"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/piwriw" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:piwriw@163.com" target="_blank" title="Email"><i class="fas fa-envelope-open-text"></i></a></div></div><div class="card-widget"><div class="item-headline"><i class="iconfont icat-visitor"></i><span>来访者</span></div><div class="item-content"><div id="welcome-info"></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AD%90%E5%8F%A5%E7%B3%BB%E7%BB%9F%E6%A8%A1%E5%9D%97%E5%8E%9F%E7%90%86%E8%AF%B4%E6%98%8E"><span class="toc-number">1.</span> <span class="toc-text">子句系统模块原理说明</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E8%AE%BE%E8%AE%A1%E5%8E%9F%E7%90%86"><span class="toc-number">1.1.</span> <span class="toc-text">一、设计原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E6%A8%A1%E5%9D%97%E5%AE%9A%E4%BD%8D"><span class="toc-number">1.1.1.</span> <span class="toc-text">1.1 模块定位</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E8%AE%BE%E8%AE%A1%E7%9B%AE%E7%9A%84"><span class="toc-number">1.1.2.</span> <span class="toc-text">1.2 设计目的</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-%E7%BB%93%E6%9E%84%E5%AE%89%E6%8E%92%E4%BE%9D%E6%8D%AE"><span class="toc-number">1.1.3.</span> <span class="toc-text">1.3 结构安排依据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-%E4%B8%8E%E5%85%B6%E4%BB%96%E6%A8%A1%E5%9D%97%E7%9A%84%E9%80%BB%E8%BE%91%E5%85%B3%E7%B3%BB"><span class="toc-number">1.1.4.</span> <span class="toc-text">1.4 与其他模块的逻辑关系</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86"><span class="toc-number">1.2.</span> <span class="toc-text">二、核心原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E5%85%B3%E9%94%AE%E6%A6%82%E5%BF%B5"><span class="toc-number">1.2.1.</span> <span class="toc-text">2.1 关键概念</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5-1-Clause-%E6%8E%A5%E5%8F%A3"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">概念 1: Clause 接口</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Clause-%E6%8E%A5%E5%8F%A3%E5%AE%8C%E6%95%B4%E8%A7%A3%E6%9E%90-clause-go-3-90"><span class="toc-number">1.2.2.</span> <span class="toc-text">Clause 接口完整解析 (clause.go:3-90)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5-2-Builder-%E6%8E%A5%E5%8F%A3"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">概念 2: Builder 接口</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5-3-Expression-%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">概念 3: Expression 表达式</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Expression-%E8%A1%A8%E8%BE%BE%E5%BC%8F%E5%AE%8C%E6%95%B4%E8%A7%A3%E6%9E%90-expression-go-10-386"><span class="toc-number">1.2.3.</span> <span class="toc-text">Expression 表达式完整解析 (expression.go:10-386)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Where-%E5%AD%90%E5%8F%A5%E5%AE%8C%E6%95%B4%E8%A7%A3%E6%9E%90-where-go-12-246"><span class="toc-number">1.2.4.</span> <span class="toc-text">Where 子句完整解析 (where.go:12-246)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E7%90%86%E8%AE%BA%E5%9F%BA%E7%A1%80"><span class="toc-number">1.2.5.</span> <span class="toc-text">2.2 理论基础</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%90%86%E8%AE%BA-1-%E7%BB%84%E5%90%88%E6%A8%A1%E5%BC%8F%E5%9C%A8%E5%AD%90%E5%8F%A5%E7%B3%BB%E7%BB%9F%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8"><span class="toc-number">1.2.5.1.</span> <span class="toc-text">理论 1: 组合模式在子句系统中的应用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%90%86%E8%AE%BA-2-%E8%AE%BF%E9%97%AE%E8%80%85%E6%A8%A1%E5%BC%8F%E5%9C%A8%E6%9E%84%E5%BB%BA%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8"><span class="toc-number">1.2.5.2.</span> <span class="toc-text">理论 2: 访问者模式在构建中的应用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%90%86%E8%AE%BA-3-%E6%A8%A1%E6%9D%BF%E6%96%B9%E6%B3%95%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.2.5.3.</span> <span class="toc-text">理论 3: 模板方法模式</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E5%AD%A6%E4%B9%A0%E6%96%B9%E6%B3%95"><span class="toc-number">1.2.6.</span> <span class="toc-text">2.3 学习方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%B3%95-1-%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E6%B3%95"><span class="toc-number">1.2.6.1.</span> <span class="toc-text">方法 1: 逆向工程法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%B3%95-2-%E5%AF%B9%E6%AF%94%E5%88%86%E6%9E%90%E6%B3%95"><span class="toc-number">1.2.6.2.</span> <span class="toc-text">方法 2: 对比分析法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%B3%95-3-%E5%AE%9E%E9%AA%8C%E9%AA%8C%E8%AF%81%E6%B3%95"><span class="toc-number">1.2.6.3.</span> <span class="toc-text">方法 3: 实验验证法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-%E5%AE%9E%E6%96%BD%E7%AD%96%E7%95%A5"><span class="toc-number">1.2.7.</span> <span class="toc-text">2.4 实施策略</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AD%96%E7%95%A5-1-%E5%88%86%E5%B1%82%E5%AD%A6%E4%B9%A0"><span class="toc-number">1.2.7.1.</span> <span class="toc-text">策略 1: 分层学习</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AD%96%E7%95%A5-2-%E9%97%AE%E9%A2%98%E9%A9%B1%E5%8A%A8"><span class="toc-number">1.2.7.2.</span> <span class="toc-text">策略 2: 问题驱动</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AD%96%E7%95%A5-3-%E9%AA%8C%E8%AF%81%E5%8F%8D%E9%A6%88"><span class="toc-number">1.2.7.3.</span> <span class="toc-text">策略 3: 验证反馈</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E5%AD%A6%E4%B9%A0%E8%B7%AF%E5%BE%84%E5%BB%BA%E8%AE%AE"><span class="toc-number">1.3.</span> <span class="toc-text">三、学习路径建议</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86%E6%A3%80%E6%9F%A5"><span class="toc-number">1.3.1.</span> <span class="toc-text">3.1 前置知识检查</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E5%AD%A6%E4%B9%A0%E6%97%B6%E9%97%B4%E5%88%86%E9%85%8D"><span class="toc-number">1.3.2.</span> <span class="toc-text">3.2 学习时间分配</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E5%AD%A6%E4%B9%A0%E6%88%90%E6%9E%9C%E9%AA%8C%E6%94%B6"><span class="toc-number">1.3.3.</span> <span class="toc-text">3.3 学习成果验收</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E5%AE%9E%E6%88%98%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.4.</span> <span class="toc-text">四、实战代码示例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E5%9F%BA%E7%A1%80%E5%AD%90%E5%8F%A5%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.4.1.</span> <span class="toc-text">4.1 基础子句使用示例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B-1-SELECT-%E5%AD%90%E5%8F%A5"><span class="toc-number">1.4.1.1.</span> <span class="toc-text">示例 1: SELECT 子句</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B-2-WHERE-%E5%AD%90%E5%8F%A5"><span class="toc-number">1.4.1.2.</span> <span class="toc-text">示例 2: WHERE 子句</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B-3-ORDER-BY-%E5%AD%90%E5%8F%A5"><span class="toc-number">1.4.1.3.</span> <span class="toc-text">示例 3: ORDER BY 子句</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E9%AB%98%E7%BA%A7%E5%AD%90%E5%8F%A5%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.4.2.</span> <span class="toc-text">4.2 高级子句示例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B-4-JOIN-%E5%AD%90%E5%8F%A5"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">示例 4: JOIN 子句</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B-5-LIMIT-%E5%92%8C-OFFSET"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">示例 5: LIMIT 和 OFFSET</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B-6-IN-%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.4.2.3.</span> <span class="toc-text">示例 6: IN 查询</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%AD%90%E5%8F%A5%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.4.3.</span> <span class="toc-text">4.3 自定义子句示例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B-7-%E5%AE%9E%E7%8E%B0-FOR-UPDATE-%E5%AD%90%E5%8F%A5"><span class="toc-number">1.4.3.1.</span> <span class="toc-text">示例 7: 实现 FOR UPDATE 子句</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E4%B8%8E%E6%95%85%E9%9A%9C%E6%8E%92%E6%9F%A5"><span class="toc-number">1.5.</span> <span class="toc-text">五、最佳实践与故障排查</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-%E5%AD%90%E5%8F%A5%E4%BD%BF%E7%94%A8%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">1.5.1.</span> <span class="toc-text">5.1 子句使用最佳实践</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E4%BD%BF%E7%94%A8%E7%B1%BB%E5%9E%8B%E5%AE%89%E5%85%A8%E7%9A%84%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="toc-number">1.5.1.1.</span> <span class="toc-text">1. 使用类型安全的表达式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%90%88%E7%90%86%E4%BD%BF%E7%94%A8%E5%AD%90%E5%8F%A5%E5%90%88%E5%B9%B6"><span class="toc-number">1.5.1.2.</span> <span class="toc-text">2. 合理使用子句合并</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E4%BD%BF%E7%94%A8-Distinct-%E5%8E%BB%E9%87%8D"><span class="toc-number">1.5.1.3.</span> <span class="toc-text">3. 使用 Distinct 去重</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E4%B8%8E%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">1.5.2.</span> <span class="toc-text">5.2 常见问题与解决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%AE%E9%A2%98-1-%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%8B%AC%E5%8F%B7%E4%B8%8D%E6%AD%A3%E7%A1%AE"><span class="toc-number">1.5.2.1.</span> <span class="toc-text">问题 1: 表达式括号不正确</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%AE%E9%A2%98-2-IN-%E6%9F%A5%E8%AF%A2%E4%B8%BA%E7%A9%BA"><span class="toc-number">1.5.2.2.</span> <span class="toc-text">问题 2: IN 查询为空</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%AE%E9%A2%98-3-ORDER-BY-%E6%96%B9%E5%90%91%E9%94%99%E8%AF%AF"><span class="toc-number">1.5.2.3.</span> <span class="toc-text">问题 3: ORDER BY 方向错误</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E3%80%81%E5%AD%A6%E4%B9%A0%E9%AA%8C%E8%AF%81"><span class="toc-number">1.6.</span> <span class="toc-text">六、学习验证</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-%E7%9F%A5%E8%AF%86%E8%87%AA%E6%B5%8B"><span class="toc-number">1.6.1.</span> <span class="toc-text">6.1 知识自测</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E9%A2%98"><span class="toc-number">1.6.1.1.</span> <span class="toc-text">基础题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9B%E9%98%B6%E9%A2%98"><span class="toc-number">1.6.1.2.</span> <span class="toc-text">进阶题</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-%E5%AE%9E%E8%B7%B5%E7%BB%83%E4%B9%A0"><span class="toc-number">1.6.2.</span> <span class="toc-text">6.2 实践练习</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%83%E4%B9%A0-1-%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%AE%9A%E4%B9%89%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="toc-number">1.6.2.1.</span> <span class="toc-text">练习 1: 实现自定义表达式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%83%E4%B9%A0-2-%E5%AE%9E%E7%8E%B0-FULL-OUTER-JOIN"><span class="toc-number">1.6.2.2.</span> <span class="toc-text">练习 2: 实现 FULL OUTER JOIN</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2026/01/11/web/gorm/09-logger/" title="Gorm-日志系统模块原理说明"><img src="/img/go.png" onerror="this.onerror=null;this.src='/img/404.png'" alt="Gorm-日志系统模块原理说明"/></a><div class="content"><a class="title" href="/2026/01/11/web/gorm/09-logger/" title="Gorm-日志系统模块原理说明">Gorm-日志系统模块原理说明</a><time datetime="2026-01-11T11:56:27.000Z" title="发表于 2026-01-11 19:56:27">2026-01-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2026/01/11/web/gorm/08-migration/" title="Gorm-迁移功能模块原理说明"><img src="/img/go.png" onerror="this.onerror=null;this.src='/img/404.png'" alt="Gorm-迁移功能模块原理说明"/></a><div class="content"><a class="title" href="/2026/01/11/web/gorm/08-migration/" title="Gorm-迁移功能模块原理说明">Gorm-迁移功能模块原理说明</a><time datetime="2026-01-11T10:56:27.000Z" title="发表于 2026-01-11 18:56:27">2026-01-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2026/01/11/web/gorm/10-plugin/" title="Gorm-插件系统模块原理说明"><img src="/img/go.png" onerror="this.onerror=null;this.src='/img/404.png'" alt="Gorm-插件系统模块原理说明"/></a><div class="content"><a class="title" href="/2026/01/11/web/gorm/10-plugin/" title="Gorm-插件系统模块原理说明">Gorm-插件系统模块原理说明</a><time datetime="2026-01-11T10:56:27.000Z" title="发表于 2026-01-11 18:56:27">2026-01-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2026/01/11/web/gorm/07-transaction/" title="Gorm-事务处理模块原理说明"><img src="/img/go.png" onerror="this.onerror=null;this.src='/img/404.png'" alt="Gorm-事务处理模块原理说明"/></a><div class="content"><a class="title" href="/2026/01/11/web/gorm/07-transaction/" title="Gorm-事务处理模块原理说明">Gorm-事务处理模块原理说明</a><time datetime="2026-01-11T09:56:27.000Z" title="发表于 2026-01-11 17:56:27">2026-01-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2026/01/11/web/gorm/06-associations/" title="Gorm-关联关系模块原理说明"><img src="/img/go.png" onerror="this.onerror=null;this.src='/img/404.png'" alt="Gorm-关联关系模块原理说明"/></a><div class="content"><a class="title" href="/2026/01/11/web/gorm/06-associations/" title="Gorm-关联关系模块原理说明">Gorm-关联关系模块原理说明</a><time datetime="2026-01-11T08:56:27.000Z" title="发表于 2026-01-11 16:56:27">2026-01-11</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2023 - 2026 By Joohwan.</span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
  const option = null

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://piwriw-twikoo-git-main-piwriw.vercel.app/',
      region: 'ap-shanghai',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const init = (el = document, path = location.pathname) => {
    twikoo.init({
      el: el.querySelector('#twikoo-wrap'),
      envId: 'https://piwriw-twikoo-git-main-piwriw.vercel.app/',
      region: 'ap-shanghai',
      onCommentLoaded: () => {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      },
      ...option,
      path: isShuoshuo ? path : (option && option.path) || path
    })

    

    isShuoshuo && (window.shuoshuoComment.destroyTwikoo = () => {
      if (el.children.length) {
        el.innerHTML = ''
        el.classList.add('no-comment')
      }
    })
  }

  const loadTwikoo = (el, path) => {
    if (typeof twikoo === 'object') setTimeout(() => init(el, path), 0)
    else btf.getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(() => init(el, path))
  }

  if (isShuoshuo) {
    'Twikoo' === 'Twikoo'
      ? window.shuoshuoComment = { loadComment: loadTwikoo }
      : window.loadOtherComment = loadTwikoo
    return
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script></div><script src="/js/categories.js" defer></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>