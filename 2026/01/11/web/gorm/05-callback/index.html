<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Gorm-回调钩子模块原理说明 | Joohwan</title><meta name="author" content="Joohwan."><meta name="copyright" content="Joohwan."><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="回调钩子模块原理说明 基于1.31 本文档深入解析回调钩子模块的设计原理和核心原理，涵盖事件驱动机制、责任链模式、钩子注册与执行等核心内容。   一、设计原理1.1 模块定位在整体架构中的位置 回调钩子模块是 GORM 的事件驱动层，位于查询构建和 SQL 执行之间，负责在数据操作的生命周期中插入自定义逻辑。 12345678910111213141516171819202122232425262">
<meta property="og:type" content="article">
<meta property="og:title" content="Gorm-回调钩子模块原理说明">
<meta property="og:url" content="https://piwriw.github.io/2026/01/11/web/gorm/05-callback/index.html">
<meta property="og:site_name" content="Joohwan">
<meta property="og:description" content="回调钩子模块原理说明 基于1.31 本文档深入解析回调钩子模块的设计原理和核心原理，涵盖事件驱动机制、责任链模式、钩子注册与执行等核心内容。   一、设计原理1.1 模块定位在整体架构中的位置 回调钩子模块是 GORM 的事件驱动层，位于查询构建和 SQL 执行之间，负责在数据操作的生命周期中插入自定义逻辑。 12345678910111213141516171819202122232425262">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://piwriw.github.io/img/go.png">
<meta property="article:published_time" content="2026-01-11T07:57:27.000Z">
<meta property="article:modified_time" content="2026-02-28T13:29:12.678Z">
<meta property="article:author" content="Joohwan.">
<meta property="article:tag" content="web">
<meta property="article:tag" content="Gorm">
<meta property="article:tag" content="源码">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://piwriw.github.io/img/go.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Gorm-回调钩子模块原理说明",
  "url": "https://piwriw.github.io/2026/01/11/web/gorm/05-callback/",
  "image": "https://piwriw.github.io/img/go.png",
  "datePublished": "2026-01-11T07:57:27.000Z",
  "dateModified": "2026-02-28T13:29:12.678Z",
  "author": [
    {
      "@type": "Person",
      "name": "Joohwan.",
      "url": "https://github.com/Piwriw"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://piwriw.github.io/2026/01/11/web/gorm/05-callback/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Gorm-回调钩子模块原理说明',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><script src="/js/welcome.js"></script><script src="https://npm.elemecdn.com/echarts@4.9.0/dist/echarts.min.js"></script><link rel="stylesheet" href="/css/categories.css"><link rel="stylesheet" href="/css/tabs.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">259</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">76</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">60</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/charts/"><i class="fa-fw fas fa-folder-open"></i><span> 文章统计</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div><div class="menus_item"><a class="site-page" href="/wish/"><i class="fa-fw fas fa-tags"></i><span> 许愿墙</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/go.png);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Joohwan</span></a><a class="nav-page-title" href="/"><span class="site-name">Gorm-回调钩子模块原理说明</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/charts/"><i class="fa-fw fas fa-folder-open"></i><span> 文章统计</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div><div class="menus_item"><a class="site-page" href="/wish/"><i class="fa-fw fas fa-tags"></i><span> 许愿墙</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Gorm-回调钩子模块原理说明</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2026-01-11T07:57:27.000Z" title="发表于 2026-01-11 15:57:27">2026-01-11</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2026-02-28T13:29:12.678Z" title="更新于 2026-02-28 21:29:12">2026-02-28</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/web/">web</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/web/gorm/">gorm</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">10.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>46分钟</span></span><span class="post-meta-separator">|</span><span id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="twikoo_visitors"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><div id="post-outdate-notice" data="{&quot;limitDay&quot;:365,&quot;messagePrev&quot;:&quot;It has been&quot;,&quot;messageNext&quot;:&quot;days since the last update, the content of the article may be outdated.&quot;,&quot;postUpdate&quot;:&quot;2026-02-28 21:29:12&quot;}" hidden></div><h1 id="回调钩子模块原理说明"><a href="#回调钩子模块原理说明" class="headerlink" title="回调钩子模块原理说明"></a>回调钩子模块原理说明</h1><blockquote>
<p>基于1.31 本文档深入解析回调钩子模块的设计原理和核心原理，涵盖事件驱动机制、责任链模式、钩子注册与执行等核心内容。</p>
</blockquote>
<hr>
<h2 id="一、设计原理"><a href="#一、设计原理" class="headerlink" title="一、设计原理"></a>一、设计原理</h2><h3 id="1-1-模块定位"><a href="#1-1-模块定位" class="headerlink" title="1.1 模块定位"></a>1.1 模块定位</h3><p><strong>在整体架构中的位置</strong></p>
<p>回调钩子模块是 GORM 的事件驱动层，位于查询构建和 SQL 执行之间，负责在数据操作的生命周期中插入自定义逻辑。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│                    Finisher API                              │</span><br><span class="line">│                      db.Find(&amp;users)                         │</span><br><span class="line">└────────────────────────┬────────────────────────────────────┘</span><br><span class="line">                         │</span><br><span class="line">                         ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│                  回调系统 (本模块) ★                          │</span><br><span class="line">│  ┌────────────────────────────────────────────────────┐     │</span><br><span class="line">│  │              processor.Execute()                    │     │</span><br><span class="line">│  │  ┌──────────────────────────────────────────────┐  │     │</span><br><span class="line">│  │  │  1. 执行 Scopes                                │  │     │</span><br><span class="line">│  │  │  2. 配置 BuildClauses                          │  │     │</span><br><span class="line">│  │  │  3. 应用 StatementModifier                     │  │     │</span><br><span class="line">│  │  │  4. 设置超时                                    │  │     │</span><br><span class="line">│  │  │  5. 解析模型                                    │  │     │</span><br><span class="line">│  │  │  6. 执行回调链                                  │  │     │</span><br><span class="line">│  │  │  7. 记录日志                                    │  │     │</span><br><span class="line">│  │  └──────────────────────────────────────────────┘  │     │</span><br><span class="line">│  └────────────────────────────────────────────────────┘     │</span><br><span class="line">│                                                             │</span><br><span class="line">│  回调链 (责任链模式):                                        │</span><br><span class="line">│  ┌────────┐   ┌────────┐   ┌────────┐   ┌────────┐        │</span><br><span class="line">│  │ Before │ → │ Before │ → │  Core  │ → │ After  │        │</span><br><span class="line">│  │ Query  │   │  Query │   │ Query  │   │ Query  │        │</span><br><span class="line">│  └────────┘   └────────┘   └────────┘   └────────┘        │</span><br><span class="line">│       ↓            ↓            ↓            ↓             │</span><br><span class="line">│  用户钩子    GORM钩子      SQL构建      用户钩子            │</span><br><span class="line">└────────────────────────┬────────────────────────────────────┘</span><br><span class="line">                         │</span><br><span class="line">                         ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│                   SQL 构建与执行                              │</span><br><span class="line">│              生成 SQL → 执行 → 扫描结果                      │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<p><strong>核心价值</strong></p>
<p>回调钩子模块的核心价值在于：</p>
<ol>
<li><strong>扩展性</strong>: 允许在不修改核心代码的情况下插入自定义逻辑</li>
<li><strong>可测试性</strong>: 可以通过模拟钩子来测试边界情况</li>
<li><strong>可维护性</strong>: 将横切关注点（如日志、验证）与业务逻辑分离</li>
<li><strong>灵活性</strong>: 支持 Before&#x2F;After&#x2F;Replace&#x2F;Remove 等多种操作</li>
</ol>
<h3 id="1-2-设计目的"><a href="#1-2-设计目的" class="headerlink" title="1.2 设计目的"></a>1.2 设计目的</h3><p><strong>问题 1: 如何在数据操作的各个阶段插入自定义逻辑，而不修改核心代码？</strong></p>
<ul>
<li><strong>挑战</strong>: 直接修改 GORM 核心代码会导致升级困难</li>
<li><strong>挑战</strong>: 不同项目有不同的需求（验证、日志、审计等）</li>
<li><strong>挑战</strong>: 需要保证执行顺序的正确性</li>
</ul>
<p><strong>解决方案</strong>: 事件驱动模式 + 责任链模式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">传统方式:</span><br><span class="line">修改 GORM 源码</span><br><span class="line">  └─ 在查询函数中添加验证代码</span><br><span class="line">  └─ 在创建函数中添加日志代码</span><br><span class="line">  └─ 升级 GORM 时需要重新合并代码</span><br><span class="line"></span><br><span class="line">回调方式:</span><br><span class="line">注册回调</span><br><span class="line">  ├─ db.Callback().Create().Before(&quot;gorm:create&quot;).Register(&quot;validate&quot;, validateFunc)</span><br><span class="line">  ├─ db.Callback().Query().After(&quot;gorm:query&quot;).Register(&quot;log&quot;, logFunc)</span><br><span class="line">  └─ 升级 GORM 时无需修改</span><br></pre></td></tr></table></figure>

<p><strong>问题 2: 如何保证回调的执行顺序？</strong></p>
<ul>
<li><strong>挑战</strong>: 某些回调必须在其他回调之前&#x2F;之后执行</li>
<li><strong>挑战</strong>: 回调之间可能存在依赖关系</li>
<li><strong>挑战</strong>: 需要支持动态调整顺序</li>
</ul>
<p><strong>解决方案</strong>: Before&#x2F;After 机制 + 拓扑排序</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">回调排序示例:</span><br><span class="line"></span><br><span class="line">注册顺序:</span><br><span class="line">  1. Register(&quot;A&quot;, fnA)</span><br><span class="line">  2. Register(&quot;B&quot;, fnB).After(&quot;A&quot;)</span><br><span class="line">  3. Register(&quot;C&quot;, fnC).Before(&quot;A&quot;)</span><br><span class="line"></span><br><span class="line">执行顺序: C → A → B</span><br><span class="line"></span><br><span class="line">排序算法使用拓扑排序确保依赖关系正确</span><br></pre></td></tr></table></figure>

<p><strong>问题 3: 如何支持不同场景的回调执行？</strong></p>
<ul>
<li><strong>挑战</strong>: 某些回调只在特定条件下执行</li>
<li><strong>挑战</strong>: 需要支持条件性注册</li>
<li><strong>挑战</strong>: 需要支持替换和删除</li>
</ul>
<p><strong>解决方案</strong>: Match 条件 + Replace&#x2F;Remove 机制</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 条件回调</span></span><br><span class="line">db.Callback().Create().Match(<span class="function"><span class="keyword">func</span><span class="params">(db *gorm.DB)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> !db.SkipDefaultTransaction</span><br><span class="line">&#125;).Register(<span class="string">&quot;gorm:begin_transaction&quot;</span>, beginTx)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 替换回调</span></span><br><span class="line">db.Callback().Query().Replace(<span class="string">&quot;gorm:query&quot;</span>, customQuery)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除回调</span></span><br><span class="line">db.Callback().Create().Remove(<span class="string">&quot;gorm:before_create&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="1-3-结构安排依据"><a href="#1-3-结构安排依据" class="headerlink" title="1.3 结构安排依据"></a>1.3 结构安排依据</h3><p><strong>3 天学习时间的科学分配</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Day 1: 回调系统基础 (核心结构)</span><br><span class="line">  目标: 理解回调系统的整体架构</span><br><span class="line">  重点:</span><br><span class="line">    - callbacks 和 processor 结构</span><br><span class="line">    - 回调注册机制</span><br><span class="line">    - 默认回调列表</span><br><span class="line"></span><br><span class="line">Day 2: 回调执行流程 (核心机制)</span><br><span class="line">  目标: 理解回调如何被执行</span><br><span class="line">  重点:</span><br><span class="line">    - processor.Execute() 流程</span><br><span class="line">    - 回调排序算法</span><br><span class="line">    - 回调链执行</span><br><span class="line"></span><br><span class="line">Day 3: 高级特性 (扩展应用)</span><br><span class="line">  目标: 掌握高级回调技巧</span><br><span class="line">  重点:</span><br><span class="line">    - 模型钩子系统</span><br><span class="line">    - 条件回调</span><br><span class="line">    - 自定义回调最佳实践</span><br></pre></td></tr></table></figure>

<p><strong>由浅入深的学习路径</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">第 1 层: 理解层 (知道是什么)</span><br><span class="line">  ├─ 回调是什么</span><br><span class="line">  ├─ 回调什么时候执行</span><br><span class="line">  └─ 回调能做什么</span><br><span class="line"></span><br><span class="line">第 2 层: 机制层 (知道如何工作)</span><br><span class="line">  ├─ 回调如何注册</span><br><span class="line">  ├─ 回调如何排序</span><br><span class="line">  └─ 回调如何执行</span><br><span class="line"></span><br><span class="line">第 3 层: 应用层 (知道如何使用)</span><br><span class="line">  ├─ 如何注册全局回调</span><br><span class="line">  ├─ 如何实现模型钩子</span><br><span class="line">  └─ 如何实现条件回调</span><br><span class="line"></span><br><span class="line">第 4 层: 原理层 (知道为什么这样设计)</span><br><span class="line">  ├─ 事件驱动模式</span><br><span class="line">  ├─ 责任链模式</span><br><span class="line">  └─ 拓扑排序算法</span><br></pre></td></tr></table></figure>

<h3 id="1-4-与其他模块的逻辑关系"><a href="#1-4-与其他模块的逻辑关系" class="headerlink" title="1.4 与其他模块的逻辑关系"></a>1.4 与其他模块的逻辑关系</h3><p><strong>依赖关系</strong></p>
<ul>
<li><strong>被查询构建调用</strong>: Finisher API 触发 processor.Execute()</li>
<li><strong>依赖 Schema</strong>: 模型钩子需要 Schema 信息</li>
<li><strong>依赖 Statement</strong>: 回调通过 Statement 访问查询上下文</li>
</ul>
<p><strong>支撑关系</strong></p>
<ul>
<li><strong>支撑子句系统</strong>: 回调可以修改 Statement.Clauses</li>
<li><strong>支撑事务系统</strong>: 事务回调通过 BeginTransaction&#x2F;CommitOrRollback 实现</li>
<li><strong>支撑关联查询</strong>: Preload 回调实现预加载功能</li>
</ul>
<p><strong>与其他系统的交互</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">回调系统 ↔ 其他模块:</span><br><span class="line"></span><br><span class="line">┌─────────────┐</span><br><span class="line">│  查询构建   │  → 触发回调执行</span><br><span class="line">└──────┬──────┘</span><br><span class="line">       │</span><br><span class="line">       ▼</span><br><span class="line">┌─────────────────────────────┐</span><br><span class="line">│         回调系统            │</span><br><span class="line">│  ┌───────────────────────┐  │</span><br><span class="line">│  │ 用户回调               │  │</span><br><span class="line">│  │ GORM 内部回调          │  │</span><br><span class="line">│  │ 模型钩子               │  │</span><br><span class="line">│  └───────────────────────┘  │</span><br><span class="line">└──────────┬──────────────────┘</span><br><span class="line">           │</span><br><span class="line">           ├─→ 修改子句 (Clause 系统)</span><br><span class="line">           ├─→ 管理事务 (事务系统)</span><br><span class="line">           ├─→ 解析模型 (Schema 系统)</span><br><span class="line">           └─→ 执行 SQL (数据库驱动)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="二、核心原理"><a href="#二、核心原理" class="headerlink" title="二、核心原理"></a>二、核心原理</h2><h3 id="2-1-关键概念"><a href="#2-1-关键概念" class="headerlink" title="2.1 关键概念"></a>2.1 关键概念</h3><h4 id="概念-1-callbacks-结构"><a href="#概念-1-callbacks-结构" class="headerlink" title="概念 1: callbacks 结构"></a>概念 1: callbacks 结构</h4><p><strong>定义</strong>: callbacks 是回调系统的容器，管理所有处理器。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> callbacks <span class="keyword">struct</span> &#123;</span><br><span class="line">    processors <span class="keyword">map</span>[<span class="type">string</span>]*processor</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> processor <span class="keyword">struct</span> &#123;</span><br><span class="line">    db        *DB</span><br><span class="line">    Clauses   []<span class="type">string</span>        <span class="comment">// 构建顺序</span></span><br><span class="line">    fns       []<span class="function"><span class="keyword">func</span><span class="params">(*DB)</span></span>     <span class="comment">// 编译后的函数列表</span></span><br><span class="line">    callbacks []*callback     <span class="comment">// 回调列表</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>设计原理</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">callbacks 结构:</span><br><span class="line"></span><br><span class="line">callbacks (容器)</span><br><span class="line">    │</span><br><span class="line">    ├─► processors[&quot;create&quot;] (创建处理器)</span><br><span class="line">    │       ├─ Clauses: [&quot;INSERT&quot;, &quot;VALUES&quot;, &quot;ON CONFLICT&quot;]</span><br><span class="line">    │       ├─ callbacks: [begin_transaction, before_create, ...]</span><br><span class="line">    │       └─ fns: [编译后的函数]</span><br><span class="line">    │</span><br><span class="line">    ├─► processors[&quot;query&quot;] (查询处理器)</span><br><span class="line">    │       ├─ Clauses: [&quot;SELECT&quot;, &quot;FROM&quot;, &quot;WHERE&quot;, ...]</span><br><span class="line">    │       ├─ callbacks: [query, preload, after_query]</span><br><span class="line">    │       └─ fns: [编译后的函数]</span><br><span class="line">    │</span><br><span class="line">    ├─► processors[&quot;update&quot;] (更新处理器)</span><br><span class="line">    │       ├─ Clauses: [&quot;UPDATE&quot;, &quot;SET&quot;, &quot;WHERE&quot;]</span><br><span class="line">    │       ├─ callbacks: [begin_transaction, before_update, ...]</span><br><span class="line">    │       └─ fns: [编译后的函数]</span><br><span class="line">    │</span><br><span class="line">    ├─► processors[&quot;delete&quot;] (删除处理器)</span><br><span class="line">    │       ├─ Clauses: [&quot;DELETE&quot;, &quot;FROM&quot;, &quot;WHERE&quot;]</span><br><span class="line">    │       ├─ callbacks: [begin_transaction, before_delete, ...]</span><br><span class="line">    │       └─ fns: [编译后的函数]</span><br><span class="line">    │</span><br><span class="line">    ├─► processors[&quot;row&quot;] (行查询处理器)</span><br><span class="line">    │       └─ callbacks: [row]</span><br><span class="line">    │</span><br><span class="line">    └─► processors[&quot;raw&quot;] (原始 SQL 处理器)</span><br><span class="line">            └─ callbacks: [raw]</span><br></pre></td></tr></table></figure>

<p><strong>默认回调列表</strong>:</p>
<table>
<thead>
<tr>
<th>操作</th>
<th>回调名称</th>
<th>位置</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Create</td>
<td>gorm:begin_transaction</td>
<td>首位</td>
<td>开始事务</td>
</tr>
<tr>
<td>Create</td>
<td>gorm:before_create</td>
<td>中间</td>
<td>创建前钩子</td>
</tr>
<tr>
<td>Create</td>
<td>gorm:save_before_associations</td>
<td>中间</td>
<td>保存前置关联</td>
</tr>
<tr>
<td>Create</td>
<td>gorm:create</td>
<td>核心</td>
<td>执行插入</td>
</tr>
<tr>
<td>Create</td>
<td>gorm:save_after_associations</td>
<td>中间</td>
<td>保存后置关联</td>
</tr>
<tr>
<td>Create</td>
<td>gorm:after_create</td>
<td>中间</td>
<td>创建后钩子</td>
</tr>
<tr>
<td>Create</td>
<td>gorm:commit_or_rollback_transaction</td>
<td>末位</td>
<td>提交&#x2F;回滚事务</td>
</tr>
<tr>
<td>Query</td>
<td>gorm:query</td>
<td>核心</td>
<td>执行查询</td>
</tr>
<tr>
<td>Query</td>
<td>gorm:preload</td>
<td>中间</td>
<td>预加载关联</td>
</tr>
<tr>
<td>Query</td>
<td>gorm:after_query</td>
<td>末尾</td>
<td>查询后钩子</td>
</tr>
<tr>
<td>Update</td>
<td>gorm:begin_transaction</td>
<td>首位</td>
<td>开始事务</td>
</tr>
<tr>
<td>Update</td>
<td>gorm:before_update</td>
<td>中间</td>
<td>更新前钩子</td>
</tr>
<tr>
<td>Update</td>
<td>gorm:save_before_associations</td>
<td>中间</td>
<td>保存前置关联</td>
</tr>
<tr>
<td>Update</td>
<td>gorm:update</td>
<td>核心</td>
<td>执行更新</td>
</tr>
<tr>
<td>Update</td>
<td>gorm:save_after_associations</td>
<td>中间</td>
<td>保存后置关联</td>
</tr>
<tr>
<td>Update</td>
<td>gorm:after_update</td>
<td>中间</td>
<td>更新后钩子</td>
</tr>
<tr>
<td>Update</td>
<td>gorm:commit_or_rollback_transaction</td>
<td>末位</td>
<td>提交&#x2F;回滚事务</td>
</tr>
<tr>
<td>Delete</td>
<td>gorm:begin_transaction</td>
<td>首位</td>
<td>开始事务</td>
</tr>
<tr>
<td>Delete</td>
<td>gorm:before_delete</td>
<td>中间</td>
<td>删除前钩子</td>
</tr>
<tr>
<td>Delete</td>
<td>gorm:delete_before_associations</td>
<td>中间</td>
<td>删除前置关联</td>
</tr>
<tr>
<td>Delete</td>
<td>gorm:delete</td>
<td>核心</td>
<td>执行删除</td>
</tr>
<tr>
<td>Delete</td>
<td>gorm:after_delete</td>
<td>中间</td>
<td>删除后钩子</td>
</tr>
<tr>
<td>Delete</td>
<td>gorm:commit_or_rollback_transaction</td>
<td>末位</td>
<td>提交&#x2F;回滚事务</td>
</tr>
</tbody></table>
<h4 id="概念-2-callback-结构"><a href="#概念-2-callback-结构" class="headerlink" title="概念 2: callback 结构"></a>概念 2: callback 结构</h4><p><strong>定义</strong>: callback 是单个回调的元数据和处理器。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> callback <span class="keyword">struct</span> &#123;</span><br><span class="line">    name      <span class="type">string</span>              <span class="comment">// 回调名称</span></span><br><span class="line">    before    <span class="type">string</span>              <span class="comment">// 在此回调之前执行</span></span><br><span class="line">    after     <span class="type">string</span>              <span class="comment">// 在此回调之后执行</span></span><br><span class="line">    remove    <span class="type">bool</span>                <span class="comment">// 是否删除</span></span><br><span class="line">    replace   <span class="type">bool</span>                <span class="comment">// 是否替换</span></span><br><span class="line">    match     <span class="function"><span class="keyword">func</span><span class="params">(*DB)</span></span> <span class="type">bool</span>      <span class="comment">// 匹配条件</span></span><br><span class="line">    handler   <span class="function"><span class="keyword">func</span><span class="params">(*DB)</span></span>           <span class="comment">// 处理函数</span></span><br><span class="line">    processor *processor          <span class="comment">// 所属处理器</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>字段详解</strong>:</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>类型</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>name</td>
<td>string</td>
<td>回调唯一标识</td>
<td>“my_validate”</td>
</tr>
<tr>
<td>before</td>
<td>string</td>
<td>在指定回调之前执行</td>
<td>Before(“gorm:create”)</td>
</tr>
<tr>
<td>after</td>
<td>string</td>
<td>在指定回调之后执行</td>
<td>After(“gorm:query”)</td>
</tr>
<tr>
<td>remove</td>
<td>bool</td>
<td>标记删除</td>
<td>Remove(“gorm:query”)</td>
</tr>
<tr>
<td>replace</td>
<td>bool</td>
<td>标记替换</td>
<td>Replace(“gorm:query”, fn)</td>
</tr>
<tr>
<td>match</td>
<td>func(*DB) bool</td>
<td>条件匹配函数</td>
<td>Match(func(db *DB) bool { return !db.SkipDefaultTransaction })</td>
</tr>
<tr>
<td>handler</td>
<td>func(*DB)</td>
<td>实际执行的函数</td>
<td>func(db *DB) { … }</td>
</tr>
</tbody></table>
<p><strong>回调注册流程</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">注册回调:</span><br><span class="line"></span><br><span class="line">db.Callback().Create().Before(&quot;gorm:create&quot;).Register(&quot;validate&quot;, fn)</span><br><span class="line">    │</span><br><span class="line">    ├─► processor.Before(&quot;gorm:create&quot;)</span><br><span class="line">    │       └─► 返回 callback&#123;before: &quot;gorm:create&quot;&#125;</span><br><span class="line">    │</span><br><span class="line">    ├─► callback.Register(&quot;validate&quot;, fn)</span><br><span class="line">    │       ├─► c.name = &quot;validate&quot;</span><br><span class="line">    │       ├─► c.handler = fn</span><br><span class="line">    │       ├─► processor.callbacks = append(..., c)</span><br><span class="line">    │       └─► processor.compile()  // 编译回调</span><br><span class="line">    │</span><br><span class="line">    └─► compile 过程:</span><br><span class="line">            ├─► 过滤: match 条件检查</span><br><span class="line">            ├─► 删除: 移除标记为 remove 的回调</span><br><span class="line">            ├─► 替换: 替换同名回调</span><br><span class="line">            ├─► 排序: 根据 before/after 排序</span><br><span class="line">            └─► 编译: 生成 fns 列表</span><br></pre></td></tr></table></figure>

<h4 id="概念-3-processor-Execute-执行流程"><a href="#概念-3-processor-Execute-执行流程" class="headerlink" title="概念 3: processor.Execute() 执行流程"></a>概念 3: processor.Execute() 执行流程</h4><p><strong>定义</strong>: Execute 是回调系统的核心执行方法。</p>
<p><strong>完整执行流程</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *processor)</span></span> Execute(db *DB) *DB &#123;</span><br><span class="line">    <span class="comment">// === 第 1 阶段: Scopes 执行 ===</span></span><br><span class="line">    <span class="keyword">for</span> <span class="built_in">len</span>(db.Statement.scopes) &gt; <span class="number">0</span> &#123;</span><br><span class="line">        db = db.executeScopes()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 第 2 阶段: 初始化 ===</span></span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        curTime           = time.Now()</span><br><span class="line">        stmt              = db.Statement</span><br><span class="line">        resetBuildClauses <span class="type">bool</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 第 3 阶段: 配置 BuildClauses ===</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(stmt.BuildClauses) == <span class="number">0</span> &#123;</span><br><span class="line">        stmt.BuildClauses = p.Clauses</span><br><span class="line">        resetBuildClauses = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 第 4 阶段: StatementModifier ===</span></span><br><span class="line">    <span class="keyword">if</span> optimizer, ok := stmt.Dest.(StatementModifier); ok &#123;</span><br><span class="line">        optimizer.ModifyStatement(stmt)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 第 5 阶段: 超时设置 ===</span></span><br><span class="line">    <span class="keyword">if</span> db.DefaultContextTimeout &gt; <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> _, ok := stmt.Context.Deadline(); !ok &#123;</span><br><span class="line">            stmt.Context, _ = context.WithTimeout(stmt.Context, db.DefaultContextTimeout)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 第 6 阶段: 模型解析准备 ===</span></span><br><span class="line">    <span class="keyword">if</span> stmt.Model == <span class="literal">nil</span> &#123;</span><br><span class="line">        stmt.Model = stmt.Dest</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> stmt.Dest == <span class="literal">nil</span> &#123;</span><br><span class="line">        stmt.Dest = stmt.Model</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 第 7 阶段: 解析 Schema ===</span></span><br><span class="line">    <span class="keyword">if</span> stmt.Model != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> err := stmt.Parse(stmt.Model); err != <span class="literal">nil</span> &#123;</span><br><span class="line">            db.AddError(err)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 第 8 阶段: 准备 ReflectValue ===</span></span><br><span class="line">    <span class="keyword">if</span> stmt.Dest != <span class="literal">nil</span> &#123;</span><br><span class="line">        stmt.ReflectValue = reflect.ValueOf(stmt.Dest)</span><br><span class="line">        <span class="keyword">for</span> stmt.ReflectValue.Kind() == reflect.Ptr &#123;</span><br><span class="line">            <span class="keyword">if</span> stmt.ReflectValue.IsNil() &amp;&amp; stmt.ReflectValue.CanAddr() &#123;</span><br><span class="line">                stmt.ReflectValue.Set(reflect.New(stmt.ReflectValue.Type().Elem()))</span><br><span class="line">            &#125;</span><br><span class="line">            stmt.ReflectValue = stmt.ReflectValue.Elem()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> !stmt.ReflectValue.IsValid() &#123;</span><br><span class="line">            db.AddError(ErrInvalidValue)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 第 9 阶段: 执行回调链 ===</span></span><br><span class="line">    <span class="keyword">for</span> _, f := <span class="keyword">range</span> p.fns &#123;</span><br><span class="line">        f(db)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 第 10 阶段: 日志记录 ===</span></span><br><span class="line">    <span class="keyword">if</span> stmt.SQL.Len() &gt; <span class="number">0</span> &#123;</span><br><span class="line">        db.Logger.Trace(stmt.Context, curTime, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> (<span class="type">string</span>, <span class="type">int64</span>) &#123;</span><br><span class="line">            sql, vars := stmt.SQL.String(), stmt.Vars</span><br><span class="line">            <span class="keyword">if</span> filter, ok := db.Logger.(ParamsFilter); ok &#123;</span><br><span class="line">                sql, vars = filter.ParamsFilter(stmt.Context, stmt.SQL.String(), stmt.Vars...)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> db.Dialector.Explain(sql, vars...), db.RowsAffected</span><br><span class="line">        &#125;, db.Error)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 第 11 阶段: 清理 ===</span></span><br><span class="line">    <span class="keyword">if</span> !stmt.DB.DryRun &#123;</span><br><span class="line">        stmt.SQL.Reset()</span><br><span class="line">        stmt.Vars = <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> resetBuildClauses &#123;</span><br><span class="line">        stmt.BuildClauses = <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> db</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>流程图</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│                    processor.Execute()                       │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br><span class="line">                         │</span><br><span class="line">                         ▼</span><br><span class="line">    ┌────────────────────────────────────────────────────┐</span><br><span class="line">    │  第 1 阶段: 执行 Scopes                              │</span><br><span class="line">    │  for len(db.Statement.scopes) &gt; 0 &#123;               │</span><br><span class="line">    │      db = db.executeScopes()                       │</span><br><span class="line">    │  &#125;                                                 │</span><br><span class="line">    └────────────────────────────────────────────────────┘</span><br><span class="line">                         │</span><br><span class="line">                         ▼</span><br><span class="line">    ┌────────────────────────────────────────────────────┐</span><br><span class="line">    │  第 2 阶段: 初始化                                  │</span><br><span class="line">    │  curTime = time.Now()                              │</span><br><span class="line">    │  stmt = db.Statement                               │</span><br><span class="line">    │  resetBuildClauses = false                         │</span><br><span class="line">    └────────────────────────────────────────────────────┘</span><br><span class="line">                         │</span><br><span class="line">                         ▼</span><br><span class="line">    ┌────────────────────────────────────────────────────┐</span><br><span class="line">    │  第 3 阶段: 配置 BuildClauses                       │</span><br><span class="line">    │  if len(stmt.BuildClauses) == 0 &#123;                 │</span><br><span class="line">    │      stmt.BuildClauses = p.Clauses                 │</span><br><span class="line">    │      resetBuildClauses = true                      │</span><br><span class="line">    │  &#125;                                                 │</span><br><span class="line">    └────────────────────────────────────────────────────┘</span><br><span class="line">                         │</span><br><span class="line">                         ▼</span><br><span class="line">    ┌────────────────────────────────────────────────────┐</span><br><span class="line">    │  第 4 阶段: StatementModifier                       │</span><br><span class="line">    │  if optimizer, ok := stmt.Dest.(StatementModifier) │</span><br><span class="line">    │  optimizer.ModifyStatement(stmt)                   │</span><br><span class="line">    └────────────────────────────────────────────────────┘</span><br><span class="line">                         │</span><br><span class="line">                         ▼</span><br><span class="line">    ┌────────────────────────────────────────────────────┐</span><br><span class="line">    │  第 5 阶段: 超时设置                                │</span><br><span class="line">    │  if db.DefaultContextTimeout &gt; 0 &#123;                 │</span><br><span class="line">    │      stmt.Context, _ = context.WithTimeout(...)    │</span><br><span class="line">    │  &#125;                                                 │</span><br><span class="line">    └────────────────────────────────────────────────────┘</span><br><span class="line">                         │</span><br><span class="line">                         ▼</span><br><span class="line">    ┌────────────────────────────────────────────────────┐</span><br><span class="line">    │  第 6 阶段: 模型解析准备                            │</span><br><span class="line">    │  if stmt.Model == nil &#123;                            │</span><br><span class="line">    │      stmt.Model = stmt.Dest                        │</span><br><span class="line">    │  &#125; else if stmt.Dest == nil &#123;                      │</span><br><span class="line">    │      stmt.Dest = stmt.Model                        │</span><br><span class="line">    │  &#125;                                                 │</span><br><span class="line">    └────────────────────────────────────────────────────┘</span><br><span class="line">                         │</span><br><span class="line">                         ▼</span><br><span class="line">    ┌────────────────────────────────────────────────────┐</span><br><span class="line">    │  第 7 阶段: 解析 Schema                             │</span><br><span class="line">    │  if stmt.Model != nil &#123;                            │</span><br><span class="line">    │      stmt.Parse(stmt.Model)                        │</span><br><span class="line">    │  &#125;                                                 │</span><br><span class="line">    └────────────────────────────────────────────────────┘</span><br><span class="line">                         │</span><br><span class="line">                         ▼</span><br><span class="line">    ┌────────────────────────────────────────────────────┐</span><br><span class="line">    │  第 8 阶段: 准备 ReflectValue                       │</span><br><span class="line">    │  if stmt.Dest != nil &#123;                             │</span><br><span class="line">    │      stmt.ReflectValue = reflect.ValueOf(...)      │</span><br><span class="line">    │      // 解引用指针                                  │</span><br><span class="line">    │      // 检查有效性                                 │</span><br><span class="line">    │  &#125;                                                 │</span><br><span class="line">    └────────────────────────────────────────────────────┘</span><br><span class="line">                         │</span><br><span class="line">                         ▼</span><br><span class="line">    ┌────────────────────────────────────────────────────┐</span><br><span class="line">    │  第 9 阶段: 执行回调链 ★核心★                       │</span><br><span class="line">    │  for _, f := range p.fns &#123;                         │</span><br><span class="line">    │      f(db)  // 执行每个回调                         │</span><br><span class="line">    │  &#125;                                                 │</span><br><span class="line">    └────────────────────────────────────────────────────┘</span><br><span class="line">                         │</span><br><span class="line">                         ▼</span><br><span class="line">    ┌────────────────────────────────────────────────────┐</span><br><span class="line">    │  第 10 阶段: 日志记录                               │</span><br><span class="line">    │  if stmt.SQL.Len() &gt; 0 &#123;                           │</span><br><span class="line">    │      db.Logger.Trace(...)                          │</span><br><span class="line">    │  &#125;                                                 │</span><br><span class="line">    └────────────────────────────────────────────────────┘</span><br><span class="line">                         │</span><br><span class="line">                         ▼</span><br><span class="line">    ┌────────────────────────────────────────────────────┐</span><br><span class="line">    │  第 11 阶段: 清理                                   │</span><br><span class="line">    │  if !stmt.DB.DryRun &#123;                              │</span><br><span class="line">    │      stmt.SQL.Reset()                              │</span><br><span class="line">    │      stmt.Vars = nil                               │</span><br><span class="line">    │  &#125;                                                 │</span><br><span class="line">    │  if resetBuildClauses &#123;                            │</span><br><span class="line">    │      stmt.BuildClauses = nil                       │</span><br><span class="line">    │  &#125;                                                 │</span><br><span class="line">    └────────────────────────────────────────────────────┘</span><br><span class="line">                         │</span><br><span class="line">                         ▼</span><br><span class="line">                    return db</span><br></pre></td></tr></table></figure>

<h4 id="概念-4-回调排序算法"><a href="#概念-4-回调排序算法" class="headerlink" title="概念 4: 回调排序算法"></a>概念 4: 回调排序算法</h4><p><strong>定义</strong>: sortCallbacks 使用拓扑排序确保回调顺序正确。</p>
<p><strong>算法详解</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sortCallbacks</span><span class="params">(cs []*callback)</span></span> (fns []<span class="function"><span class="keyword">func</span><span class="params">(*DB)</span></span>, err <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        names, sorted []<span class="type">string</span></span><br><span class="line">        sortCallback  <span class="function"><span class="keyword">func</span><span class="params">(*callback)</span></span> <span class="type">error</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 第 1 步: 特殊排序 ===</span></span><br><span class="line">    <span class="comment">// before=&quot;*&quot; 的排在最前，after=&quot;*&quot; 的排在最后</span></span><br><span class="line">    sort.SliceStable(cs, <span class="function"><span class="keyword">func</span><span class="params">(i, j <span class="type">int</span>)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> cs[j].before == <span class="string">&quot;*&quot;</span> &amp;&amp; cs[i].before != <span class="string">&quot;*&quot;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> cs[j].after == <span class="string">&quot;*&quot;</span> &amp;&amp; cs[i].after != <span class="string">&quot;*&quot;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 第 2 步: 收集名称并检测重复 ===</span></span><br><span class="line">    <span class="keyword">for</span> _, c := <span class="keyword">range</span> cs &#123;</span><br><span class="line">        <span class="keyword">if</span> idx := getRIndex(names, c.name); idx &gt; <span class="number">-1</span> &amp;&amp; !c.replace &amp;&amp; !c.remove &#123;</span><br><span class="line">            <span class="comment">// 警告: 重复的回调名称</span></span><br><span class="line">            c.processor.db.Logger.Warn(context.Background(),</span><br><span class="line">                <span class="string">&quot;duplicated callback `%s` from %s\n&quot;</span>, c.name, utils.FileWithLineNum())</span><br><span class="line">        &#125;</span><br><span class="line">        names = <span class="built_in">append</span>(names, c.name)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 第 3 步: 递归排序函数 ===</span></span><br><span class="line">    sortCallback = <span class="function"><span class="keyword">func</span><span class="params">(c *callback)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">        <span class="comment">// 处理 before 关系</span></span><br><span class="line">        <span class="keyword">if</span> c.before != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> c.before == <span class="string">&quot;*&quot;</span> &#123;  <span class="comment">// 排在最前</span></span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">len</span>(sorted) &gt; <span class="number">0</span> &#123;</span><br><span class="line">                    sorted = <span class="built_in">append</span>([]<span class="type">string</span>&#123;c.name&#125;, sorted...)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> sortedIdx := getRIndex(sorted, c.before); sortedIdx != <span class="number">-1</span> &#123;</span><br><span class="line">                <span class="comment">// 目标已排序，插入到目标前面</span></span><br><span class="line">                <span class="keyword">if</span> curIdx := getRIndex(sorted, c.name); curIdx == <span class="number">-1</span> &#123;</span><br><span class="line">                    sorted = <span class="built_in">append</span>(sorted[:sortedIdx],</span><br><span class="line">                        <span class="built_in">append</span>([]<span class="type">string</span>&#123;c.name&#125;, sorted[sortedIdx:]...)...)</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> curIdx &gt; sortedIdx &#123;</span><br><span class="line">                    <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;conflicting callback %s with before %s&quot;</span>, c.name, c.before)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> idx := getRIndex(names, c.before); idx != <span class="number">-1</span> &#123;</span><br><span class="line">                <span class="comment">// 目标未排序，设置目标 after 当前</span></span><br><span class="line">                cs[idx].after = c.name</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 处理 after 关系</span></span><br><span class="line">        <span class="keyword">if</span> c.after != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> c.after == <span class="string">&quot;*&quot;</span> &#123;  <span class="comment">// 排在最后</span></span><br><span class="line">                sorted = <span class="built_in">append</span>(sorted, c.name)</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> sortedIdx := getRIndex(sorted, c.after); sortedIdx != <span class="number">-1</span> &#123;</span><br><span class="line">                <span class="comment">// 目标已排序，追加到末尾</span></span><br><span class="line">                <span class="keyword">if</span> curIdx := getRIndex(sorted, c.name); curIdx == <span class="number">-1</span> &#123;</span><br><span class="line">                    sorted = <span class="built_in">append</span>(sorted, c.name)</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> curIdx &lt; sortedIdx &#123;</span><br><span class="line">                    <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;conflicting callback %s with before %s&quot;</span>, c.name, c.after)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> idx := getRIndex(names, c.after); idx != <span class="number">-1</span> &#123;</span><br><span class="line">                <span class="comment">// 目标未排序，设置目标 before 当前</span></span><br><span class="line">                after := cs[idx]</span><br><span class="line">                <span class="keyword">if</span> after.before == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">                    after.before = c.name</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> err := sortCallback(after); err != <span class="literal">nil</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> err</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> sortCallback(c)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果未排序，追加到末尾</span></span><br><span class="line">        <span class="keyword">if</span> getRIndex(sorted, c.name) == <span class="number">-1</span> &#123;</span><br><span class="line">            sorted = <span class="built_in">append</span>(sorted, c.name)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 第 4 步: 对所有回调排序 ===</span></span><br><span class="line">    <span class="keyword">for</span> _, c := <span class="keyword">range</span> cs &#123;</span><br><span class="line">        <span class="keyword">if</span> err = sortCallback(c); err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 第 5 步: 生成函数列表 ===</span></span><br><span class="line">    <span class="keyword">for</span> _, name := <span class="keyword">range</span> sorted &#123;</span><br><span class="line">        <span class="keyword">if</span> idx := getRIndex(names, name); !cs[idx].remove &#123;</span><br><span class="line">            fns = <span class="built_in">append</span>(fns, cs[idx].handler)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>排序示例</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">注册顺序:</span><br><span class="line">1. Register(&quot;A&quot;, fnA)</span><br><span class="line">2. Register(&quot;B&quot;, fnB).After(&quot;A&quot;)</span><br><span class="line">3. Register(&quot;C&quot;, fnC).Before(&quot;A&quot;)</span><br><span class="line">4. Register(&quot;D&quot;, fnD).After(&quot;B&quot;)</span><br><span class="line">5. Register(&quot;E&quot;, fnE).Before(&quot;*&quot;)  // 最前</span><br><span class="line">6. Register(&quot;F&quot;, fnF).After(&quot;*&quot;)   // 最后</span><br><span class="line"></span><br><span class="line">排序过程:</span><br><span class="line">初始: []</span><br><span class="line">排序 A: [A]</span><br><span class="line">排序 B: [A, B]</span><br><span class="line">排序 C: [C, A, B]  (C 在 A 之前)</span><br><span class="line">排序 D: [C, A, B, D]  (D 在 B 之后)</span><br><span class="line">排序 E: [E, C, A, B, D]  (E 最前)</span><br><span class="line">排序 F: [E, C, A, B, D, F]  (F 最后)</span><br><span class="line"></span><br><span class="line">最终执行顺序: E → C → A → B → D → F</span><br></pre></td></tr></table></figure>

<h4 id="概念-5-模型钩子系统"><a href="#概念-5-模型钩子系统" class="headerlink" title="概念 5: 模型钩子系统"></a>概念 5: 模型钩子系统</h4><p><strong>定义</strong>: 模型钩子是定义在结构体上的特殊方法，在特定操作时自动调用。</p>
<p><strong>钩子接口定义</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建钩子</span></span><br><span class="line"><span class="keyword">type</span> BeforeCreateInterface <span class="keyword">interface</span> &#123;</span><br><span class="line">    BeforeCreate(*DB) <span class="type">error</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> AfterCreateInterface <span class="keyword">interface</span> &#123;</span><br><span class="line">    AfterCreate(*DB) <span class="type">error</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查询钩子</span></span><br><span class="line"><span class="keyword">type</span> AfterFindInterface <span class="keyword">interface</span> &#123;</span><br><span class="line">    AfterFind(*DB) <span class="type">error</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 更新钩子</span></span><br><span class="line"><span class="keyword">type</span> BeforeUpdateInterface <span class="keyword">interface</span> &#123;</span><br><span class="line">    BeforeUpdate(*DB) <span class="type">error</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> AfterUpdateInterface <span class="keyword">interface</span> &#123;</span><br><span class="line">    AfterUpdate(*DB) <span class="type">error</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除钩子</span></span><br><span class="line"><span class="keyword">type</span> BeforeDeleteInterface <span class="keyword">interface</span> &#123;</span><br><span class="line">    BeforeDelete(*DB) <span class="type">error</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> AfterDeleteInterface <span class="keyword">interface</span> &#123;</span><br><span class="line">    AfterDelete(*DB) <span class="type">error</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>钩子执行机制</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// callMethod 调用模型钩子</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">callMethod</span><span class="params">(db *DB, fc <span class="keyword">func</span>(value <span class="keyword">interface</span>&#123;&#125;, tx *DB)</span></span> <span class="type">bool</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> db.Statement.Schema != <span class="literal">nil</span> &#123;</span><br><span class="line">        callMethodValue := <span class="function"><span class="keyword">func</span><span class="params">(reflectValue reflect.Value)</span></span> &#123;</span><br><span class="line">            <span class="keyword">for</span> _, fc := <span class="keyword">range</span> []<span class="function"><span class="keyword">func</span><span class="params">(*DB)</span></span>&#123;</span><br><span class="line">                <span class="comment">// BeforeCreate</span></span><br><span class="line">                <span class="function"><span class="keyword">func</span><span class="params">(db *DB)</span></span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> i, ok := db.Statement.Dest.(BeforeCreateInterface); ok &#123;</span><br><span class="line">                        db.AddError(i.BeforeCreate(db))</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="comment">// AfterCreate</span></span><br><span class="line">                <span class="function"><span class="keyword">func</span><span class="params">(db *DB)</span></span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> i, ok := db.Statement.Dest.(AfterCreateInterface); ok &#123;</span><br><span class="line">                        db.AddError(i.AfterCreate(db))</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="comment">// ... 其他钩子</span></span><br><span class="line">            &#125; &#123;</span><br><span class="line">                fc(db)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        callMethodValue(db.Statement.ReflectValue)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>钩子执行顺序</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">Create 操作:</span><br><span class="line">  1. BeginTransaction</span><br><span class="line">  2. BeforeCreate (全局回调)</span><br><span class="line">  3. BeforeCreate (模型钩子)  ← 调用 user.BeforeCreate()</span><br><span class="line">  4. SaveBeforeAssociations</span><br><span class="line">  5. Create (执行 INSERT)</span><br><span class="line">  6. SaveAfterAssociations</span><br><span class="line">  7. AfterCreate (模型钩子)    ← 调用 user.AfterCreate()</span><br><span class="line">  8. AfterCreate (全局回调)</span><br><span class="line">  9. CommitOrRollbackTransaction</span><br><span class="line"></span><br><span class="line">Query 操作:</span><br><span class="line">  1. Query (执行 SELECT)</span><br><span class="line">  2. Preload</span><br><span class="line">  3. AfterFind (模型钩子)      ← 调用 user.AfterFind()</span><br><span class="line">  4. AfterQuery (全局回调)</span><br><span class="line"></span><br><span class="line">Update 操作:</span><br><span class="line">  1. BeginTransaction</span><br><span class="line">  2. BeforeUpdate (全局回调)</span><br><span class="line">  3. BeforeUpdate (模型钩子)  ← 调用 user.BeforeUpdate()</span><br><span class="line">  4. SaveBeforeAssociations</span><br><span class="line">  5. Update (执行 UPDATE)</span><br><span class="line">  6. SaveAfterAssociations</span><br><span class="line">  7. AfterUpdate (模型钩子)    ← 调用 user.AfterUpdate()</span><br><span class="line">  8. AfterUpdate (全局回调)</span><br><span class="line">  9. CommitOrRollbackTransaction</span><br><span class="line"></span><br><span class="line">Delete 操作:</span><br><span class="line">  1. BeginTransaction</span><br><span class="line">  2. BeforeDelete (全局回调)</span><br><span class="line">  3. BeforeDelete (模型钩子)  ← 调用 user.BeforeDelete()</span><br><span class="line">  4. DeleteBeforeAssociations</span><br><span class="line">  5. Delete (执行 DELETE)</span><br><span class="line">  6. AfterDelete (模型钩子)    ← 调用 user.AfterDelete()</span><br><span class="line">  7. AfterDelete (全局回调)</span><br><span class="line">  8. CommitOrRollbackTransaction</span><br></pre></td></tr></table></figure>

<h3 id="2-2-理论基础"><a href="#2-2-理论基础" class="headerlink" title="2.2 理论基础"></a>2.2 理论基础</h3><h4 id="理论-1-责任链模式"><a href="#理论-1-责任链模式" class="headerlink" title="理论 1: 责任链模式"></a>理论 1: 责任链模式</h4><p><strong>模式定义</strong>: 为请求创建一个接收者对象链，每个接收者都包含对下一个接收者的引用。</p>
<p><strong>在回调系统中的体现</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">回调链结构:</span><br><span class="line"></span><br><span class="line">┌────────────────────────────────────────────────────────────┐</span><br><span class="line">│                     回调链 (责任链)                         │</span><br><span class="line">└────────────────────────────────────────────────────────────┘</span><br><span class="line"></span><br><span class="line">     回调1           回调2           回调3           回调4</span><br><span class="line">   [validate]  →  [sanitize]  →  [set_default]  →  [log]</span><br><span class="line">        │              │               │               │</span><br><span class="line">        ▼              ▼               ▼               ▼</span><br><span class="line">   检查输入        清理数据          设置默认值       记录日志</span><br><span class="line">        │              │               │               │</span><br><span class="line">        └──────────────┴───────────────┴───────────────┘</span><br><span class="line">                           │</span><br><span class="line">                           ▼</span><br><span class="line">                    核心操作 (SQL)</span><br><span class="line">                           │</span><br><span class="line">                           ▼</span><br><span class="line">                     回调5  →  回调6  →  回调7</span><br><span class="line">                   [audit]  →  [cache]  →  [notify]</span><br><span class="line">                        │        │        │</span><br><span class="line">                        ▼        ▼        ▼</span><br><span class="line">                    审计日志   更新缓存   发送通知</span><br></pre></td></tr></table></figure>

<p><strong>代码实现</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 回调链执行</span></span><br><span class="line"><span class="keyword">for</span> _, f := <span class="keyword">range</span> p.fns &#123;</span><br><span class="line">    f(db)  <span class="comment">// 每个 f 都是一个处理器</span></span><br><span class="line">    <span class="keyword">if</span> db.Error != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="comment">// 可以中断链</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>优势</strong>:</p>
<ol>
<li><strong>解耦</strong>: 每个回调独立，互不依赖</li>
<li><strong>灵活</strong>: 可以动态添加&#x2F;移除回调</li>
<li><strong>可扩展</strong>: 新增功能只需注册新回调</li>
<li><strong>可测试</strong>: 每个回调可以独立测试</li>
</ol>
<p><strong>中断链</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 返回错误可以中断链</span></span><br><span class="line">db.Callback().Create().Register(<span class="string">&quot;validate&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(db *gorm.DB)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> user.Name == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">        db.AddError(errors.New(<span class="string">&quot;name is required&quot;</span>))</span><br><span class="line">        <span class="keyword">return</span>  <span class="comment">// 这将中断后续回调</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="理论-2-事件驱动模式"><a href="#理论-2-事件驱动模式" class="headerlink" title="理论 2: 事件驱动模式"></a>理论 2: 事件驱动模式</h4><p><strong>模式定义</strong>: 当对象的状态改变时，自动通知依赖它的对象。</p>
<p><strong>在回调系统中的体现</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">事件流:</span><br><span class="line"></span><br><span class="line">用户操作                 触发事件                事件处理</span><br><span class="line">    │                       │                       │</span><br><span class="line">    ▼                       ▼                       ▼</span><br><span class="line">db.Create(&amp;user)  →  &quot;before:create&quot;  →  执行 BeforeCreate 回调</span><br><span class="line">    │                       │                       │</span><br><span class="line">    │                       ▼                       ▼</span><br><span class="line">    │                  &quot;create&quot;         →  执行 Create 回调</span><br><span class="line">    │                       │                       │</span><br><span class="line">    │                       ▼                       ▼</span><br><span class="line">    │                  &quot;after:create&quot;   →  执行 AfterCreate 回调</span><br><span class="line">    │                       │                       │</span><br><span class="line">    └───────────────────────┴───────────────────────┘</span><br><span class="line">                            │</span><br><span class="line">                            ▼</span><br><span class="line">                      操作完成</span><br></pre></td></tr></table></figure>

<p><strong>事件类型</strong>:</p>
<table>
<thead>
<tr>
<th>事件类型</th>
<th>时机</th>
<th>用途</th>
</tr>
</thead>
<tbody><tr>
<td>before:create</td>
<td>创建前</td>
<td>验证、设置默认值</td>
</tr>
<tr>
<td>create</td>
<td>创建时</td>
<td>执行 INSERT</td>
</tr>
<tr>
<td>after:create</td>
<td>创建后</td>
<td>更新关联、清理</td>
</tr>
<tr>
<td>before:query</td>
<td>查询前</td>
<td>修改查询条件</td>
</tr>
<tr>
<td>query</td>
<td>查询时</td>
<td>执行 SELECT</td>
</tr>
<tr>
<td>after:query</td>
<td>查询后</td>
<td>数据转换、缓存</td>
</tr>
<tr>
<td>before:update</td>
<td>更新前</td>
<td>验证、记录旧值</td>
</tr>
<tr>
<td>update</td>
<td>更新时</td>
<td>执行 UPDATE</td>
</tr>
<tr>
<td>after:update</td>
<td>更新后</td>
<td>更新关联、通知</td>
</tr>
<tr>
<td>before:delete</td>
<td>删除前</td>
<td>检查依赖、备份</td>
</tr>
<tr>
<td>delete</td>
<td>删除时</td>
<td>执行 DELETE</td>
</tr>
<tr>
<td>after:delete</td>
<td>删除后</td>
<td>清理关联、通知</td>
</tr>
</tbody></table>
<p><strong>事件驱动实现</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 事件发布 (隐式)</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> Create(value <span class="keyword">interface</span>&#123;&#125;) *DB &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">return</span> db.callbacks.Create().Execute(db)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 事件订阅</span></span><br><span class="line">db.Callback().Create().Before(<span class="string">&quot;gorm:create&quot;</span>).Register(<span class="string">&quot;validate&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(db *gorm.DB)</span></span> &#123;</span><br><span class="line">    <span class="comment">// 订阅 before:create 事件</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">db.Callback().Create().After(<span class="string">&quot;gorm:create&quot;</span>).Register(<span class="string">&quot;log&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(db *gorm.DB)</span></span> &#123;</span><br><span class="line">    <span class="comment">// 订阅 after:create 事件</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="理论-3-拓扑排序"><a href="#理论-3-拓扑排序" class="headerlink" title="理论 3: 拓扑排序"></a>理论 3: 拓扑排序</h4><p><strong>定义</strong>: 对有向无环图 (DAG) 的顶点进行排序，使得对于每一条有向边 (u, v)，顶点 u 在排序中都在顶点 v 之前。</p>
<p><strong>在回调排序中的应用</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">回调依赖图:</span><br><span class="line"></span><br><span class="line">    C (before A)</span><br><span class="line">    │</span><br><span class="line">    ▼</span><br><span class="line">    A</span><br><span class="line">    │</span><br><span class="line">    ▼</span><br><span class="line">    B (after A)</span><br><span class="line">    │</span><br><span class="line">    ▼</span><br><span class="line">    D (after B)</span><br><span class="line"></span><br><span class="line">拓扑排序结果: C → A → B → D</span><br><span class="line"></span><br><span class="line">有环情况检测:</span><br><span class="line">    A before B</span><br><span class="line">    B before C</span><br><span class="line">    C before A  ← 环!</span><br><span class="line"></span><br><span class="line">错误: conflicting callback A with before B</span><br></pre></td></tr></table></figure>

<p><strong>算法特点</strong>:</p>
<ol>
<li><strong>依赖优先</strong>: before 优先级高，after 优先级低</li>
<li><strong>冲突检测</strong>: 检测循环依赖并报错</li>
<li><strong>特殊处理</strong>: <code>*</code> 表示最前&#x2F;最后</li>
</ol>
<p><strong>代码实现</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 递归排序</span></span><br><span class="line">sortCallback = <span class="function"><span class="keyword">func</span><span class="params">(c *callback)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    <span class="comment">// 处理 before 关系 (前置依赖)</span></span><br><span class="line">    <span class="keyword">if</span> c.before != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理 after 关系 (后置依赖)</span></span><br><span class="line">    <span class="keyword">if</span> c.after != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果未排序，追加到末尾</span></span><br><span class="line">    <span class="keyword">if</span> getRIndex(sorted, c.name) == <span class="number">-1</span> &#123;</span><br><span class="line">        sorted = <span class="built_in">append</span>(sorted, c.name)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 对所有回调排序</span></span><br><span class="line"><span class="keyword">for</span> _, c := <span class="keyword">range</span> cs &#123;</span><br><span class="line">    <span class="keyword">if</span> err = sortCallback(c); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span>  <span class="comment">// 冲突检测失败</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="理论-4-观察者模式"><a href="#理论-4-观察者模式" class="headerlink" title="理论 4: 观察者模式"></a>理论 4: 观察者模式</h4><p><strong>模式定义</strong>: 定义对象间的一对多依赖关系，当一个对象状态改变时，所有依赖它的对象都会得到通知并自动更新。</p>
<p><strong>在模型钩子中的体现</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">观察者模式应用:</span><br><span class="line"></span><br><span class="line">Subject (被观察者)        Observer (观察者)</span><br><span class="line">    ┌─────────────┐            ┌─────────────┐</span><br><span class="line">    │   User      │            │  Logger     │</span><br><span class="line">    │  (模型)      │  notify →  │ (日志回调)  │</span><br><span class="line">    └─────────────┘            └─────────────┘</span><br><span class="line">           │                           │</span><br><span class="line">           │  notify                   │  update</span><br><span class="line">           ▼                           ▼</span><br><span class="line">    ┌─────────────┐            ┌─────────────┐</span><br><span class="line">    │  Cache      │            │  Auditor    │</span><br><span class="line">    │ (缓存回调)  │  notify →  │ (审计回调)  │</span><br><span class="line">    └─────────────┘            └─────────────┘</span><br></pre></td></tr></table></figure>

<p><strong>接口定义</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 观察者接口</span></span><br><span class="line"><span class="keyword">type</span> BeforeCreateInterface <span class="keyword">interface</span> &#123;</span><br><span class="line">    BeforeCreate(*DB) <span class="type">error</span>  <span class="comment">// 通知方法</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 被观察者 (隐式)</span></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">    gorm.Model</span><br><span class="line">    Name <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 观察者实现</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *User)</span></span> BeforeCreate(tx *gorm.DB) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="comment">// 当 User 被创建时，此方法被调用</span></span><br><span class="line">    log.Printf(<span class="string">&quot;Creating user: %s&quot;</span>, u.Name)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-学习方法"><a href="#2-3-学习方法" class="headerlink" title="2.3 学习方法"></a>2.3 学习方法</h3><h4 id="方法-1-追踪法"><a href="#方法-1-追踪法" class="headerlink" title="方法 1: 追踪法"></a>方法 1: 追踪法</h4><p><strong>步骤</strong>: 从 Finisher API 开始，追踪整个回调执行流程。</p>
<p><strong>示例 - 查询流程追踪</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">1. 用户调用</span><br><span class="line">   db.Find(&amp;users)</span><br><span class="line"></span><br><span class="line">2. 进入 finisher_api.go</span><br><span class="line">   func (db *DB) Find(dest interface&#123;&#125;, conds ...interface&#123;&#125;) *DB &#123;</span><br><span class="line">       tx := db.getInstance()</span><br><span class="line">       tx.Statement.Dest = dest</span><br><span class="line">       // ...</span><br><span class="line">       return tx.callbacks.Query().Execute(tx)  ← 关键调用</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">3. 进入 callbacks.go</span><br><span class="line">   func (p *processor) Execute(db *DB) *DB &#123;</span><br><span class="line">       // 执行 Scopes</span><br><span class="line">       for len(db.Statement.scopes) &gt; 0 &#123;</span><br><span class="line">           db = db.executeScopes()</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       // 配置 BuildClauses</span><br><span class="line">       if len(stmt.BuildClauses) == 0 &#123;</span><br><span class="line">           stmt.BuildClauses = p.Clauses</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       // 解析模型</span><br><span class="line">       if stmt.Model != nil &#123;</span><br><span class="line">           stmt.Parse(stmt.Model)</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       // 执行回调链</span><br><span class="line">       for _, f := range p.fns &#123;</span><br><span class="line">           f(db)  ← 执行每个回调</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       // 记录日志</span><br><span class="line">       if stmt.SQL.Len() &gt; 0 &#123;</span><br><span class="line">           db.Logger.Trace(...)</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       return db</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">4. 默认查询回调</span><br><span class="line">   - gorm:query     → BuildQuerySQL + 执行查询</span><br><span class="line">   - gorm:preload  → 预加载关联</span><br><span class="line">   - gorm:after_query → AfterFind 钩子</span><br><span class="line"></span><br><span class="line">5. query.go 中的 Query 回调</span><br><span class="line">   func Query(db *gorm.DB) &#123;</span><br><span class="line">       if db.Error == nil &#123;</span><br><span class="line">           BuildQuerySQL(db)  ← 构建 SQL</span><br><span class="line"></span><br><span class="line">           if !db.DryRun &amp;&amp; db.Error == nil &#123;</span><br><span class="line">               rows, err := db.Statement.ConnPool.QueryContext(...)</span><br><span class="line">               gorm.Scan(rows, db, 0)  ← 扫描结果</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h4 id="方法-2-对比法"><a href="#方法-2-对比法" class="headerlink" title="方法 2: 对比法"></a>方法 2: 对比法</h4><p><strong>对比模型钩子和全局回调</strong>:</p>
<table>
<thead>
<tr>
<th>特性</th>
<th>模型钩子</th>
<th>全局回调</th>
</tr>
</thead>
<tbody><tr>
<td>定义位置</td>
<td>结构体方法</td>
<td>注册到 DB</td>
</tr>
<tr>
<td>作用范围</td>
<td>只影响该模型</td>
<td>影响所有操作</td>
</tr>
<tr>
<td>灵活性</td>
<td>低（绑定模型）</td>
<td>高（可条件执行）</td>
</tr>
<tr>
<td>性能</td>
<td>需要类型断言</td>
<td>直接函数调用</td>
</tr>
<tr>
<td>适用场景</td>
<td>模型特定逻辑</td>
<td>通用逻辑（日志、验证）</td>
</tr>
</tbody></table>
<p><strong>对比示例</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 模型钩子 - 只影响 User</span></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">    gorm.Model</span><br><span class="line">    Name <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *User)</span></span> BeforeCreate(tx *gorm.DB) <span class="type">error</span> &#123;</span><br><span class="line">    u.Name = strings.TrimSpace(u.Name)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 全局回调 - 影响所有创建操作</span></span><br><span class="line">db.Callback().Create().Before(<span class="string">&quot;gorm:create&quot;</span>).Register(<span class="string">&quot;validate&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(tx *gorm.DB)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> tx.Statement.Schema != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="comment">// 通用验证逻辑</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 条件回调 - 只在特定条件下执行</span></span><br><span class="line">db.Callback().Create().Match(<span class="function"><span class="keyword">func</span><span class="params">(db *gorm.DB)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> !db.SkipDefaultTransaction</span><br><span class="line">&#125;).Register(<span class="string">&quot;begin_transaction&quot;</span>, beginTx)</span><br></pre></td></tr></table></figure>

<p><strong>对比 Before 和 After</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Before: 在核心操作之前</span></span><br><span class="line">db.Callback().Create().Before(<span class="string">&quot;gorm:create&quot;</span>).Register(<span class="string">&quot;validate&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(db *gorm.DB)</span></span> &#123;</span><br><span class="line">    <span class="comment">// 可以修改数据</span></span><br><span class="line">    <span class="keyword">if</span> user.Name == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">        db.AddError(errors.New(<span class="string">&quot;name required&quot;</span>))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// After: 在核心操作之后</span></span><br><span class="line">db.Callback().Create().After(<span class="string">&quot;gorm:create&quot;</span>).Register(<span class="string">&quot;log&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(db *gorm.DB)</span></span> &#123;</span><br><span class="line">    <span class="comment">// 可以访问结果</span></span><br><span class="line">    log.Printf(<span class="string">&quot;Created user with ID: %d&quot;</span>, user.ID)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="方法-3-实践法"><a href="#方法-3-实践法" class="headerlink" title="方法 3: 实践法"></a>方法 3: 实践法</h4><p><strong>实践 1: 实现审计日志</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 目标: 记录所有数据变更</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> AuditLog <span class="keyword">struct</span> &#123;</span><br><span class="line">    ID        <span class="type">uint</span></span><br><span class="line">    Action    <span class="type">string</span>  <span class="comment">// create/update/delete</span></span><br><span class="line">    TableName <span class="type">string</span></span><br><span class="line">    RecordID  <span class="type">uint</span></span><br><span class="line">    OldData   <span class="type">string</span></span><br><span class="line">    NewData   <span class="type">string</span></span><br><span class="line">    CreatedAt time.Time</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册审计回调</span></span><br><span class="line">db.Callback().Create().After(<span class="string">&quot;gorm:create&quot;</span>).Register(<span class="string">&quot;audit:create&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(tx *gorm.DB)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> tx.Error == <span class="literal">nil</span> &amp;&amp; tx.Statement.Schema != <span class="literal">nil</span> &#123;</span><br><span class="line">        data, _ := json.Marshal(tx.Statement.Dest)</span><br><span class="line">        tx.Create(&amp;AuditLog&#123;</span><br><span class="line">            Action:    <span class="string">&quot;create&quot;</span>,</span><br><span class="line">            TableName: tx.Statement.Table,</span><br><span class="line">            RecordID:  tx.Statement.ReflectValue.FieldByName(<span class="string">&quot;ID&quot;</span>).Uint(),</span><br><span class="line">            NewData:   <span class="type">string</span>(data),</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">db.Callback().Update().After(<span class="string">&quot;gorm:update&quot;</span>).Register(<span class="string">&quot;audit:update&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(tx *gorm.DB)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> tx.Error == <span class="literal">nil</span> &amp;&amp; tx.Statement.Schema != <span class="literal">nil</span> &#123;</span><br><span class="line">        oldData, _ := json.Marshal(tx.Statement.Dest)</span><br><span class="line">        newData, _ := json.Marshal(tx.Statement.ReflectValue.Interface())</span><br><span class="line">        tx.Create(&amp;AuditLog&#123;</span><br><span class="line">            Action:    <span class="string">&quot;update&quot;</span>,</span><br><span class="line">            TableName: tx.Statement.Table,</span><br><span class="line">            OldData:   <span class="type">string</span>(oldData),</span><br><span class="line">            NewData:   <span class="type">string</span>(newData),</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><strong>实践 2: 实现软删除</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 目标: 删除时标记删除，而非物理删除</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> SoftDelete <span class="keyword">struct</span> &#123;</span><br><span class="line">    DeletedAt gorm.DeletedAt <span class="string">`gorm:&quot;index&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册软删除回调</span></span><br><span class="line">db.Callback().Delete().Before(<span class="string">&quot;gorm:delete&quot;</span>).Register(<span class="string">&quot;soft_delete&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(tx *gorm.DB)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> tx.Statement.Schema != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="comment">// 检查是否有 DeletedAt 字段</span></span><br><span class="line">        <span class="keyword">if</span> field := tx.Statement.Schema.LookUpField(<span class="string">&quot;DeletedAt&quot;</span>); field != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="comment">// 修改为更新操作</span></span><br><span class="line">            tx.Statement.DB = tx.Model(tx.Statement.Dest).Update(<span class="string">&quot;DeletedAt&quot;</span>, time.Now())</span><br><span class="line">            <span class="comment">// 跳过实际的删除</span></span><br><span class="line">            tx.SkipHooks = <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><strong>实践 3: 实现条件验证</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 目标: 只对特定模型进行验证</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Validatable <span class="keyword">interface</span> &#123;</span><br><span class="line">    Validate() <span class="type">error</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册验证回调</span></span><br><span class="line">db.Callback().Create().Before(<span class="string">&quot;gorm:create&quot;</span>).Register(<span class="string">&quot;validate&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(tx *gorm.DB)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> tx.Statement.Schema != <span class="literal">nil</span> &amp;&amp; !tx.SkipHooks &#123;</span><br><span class="line">        <span class="comment">// 检查是否实现了 Validatable 接口</span></span><br><span class="line">        <span class="keyword">if</span> v, ok := tx.Statement.Dest.(Validatable); ok &#123;</span><br><span class="line">            <span class="keyword">if</span> err := v.Validate(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">                tx.AddError(err)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用</span></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">    gorm.Model</span><br><span class="line">    Name  <span class="type">string</span></span><br><span class="line">    Email <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *User)</span></span> Validate() <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> u.Name == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> errors.New(<span class="string">&quot;name is required&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> u.Email == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> errors.New(<span class="string">&quot;email is required&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-4-实施策略"><a href="#2-4-实施策略" class="headerlink" title="2.4 实施策略"></a>2.4 实施策略</h3><h4 id="策略-1-分层学习"><a href="#策略-1-分层学习" class="headerlink" title="策略 1: 分层学习"></a>策略 1: 分层学习</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">第 1 层: 理解回调基础 (Day 1)</span><br><span class="line">  目标: 理解回调系统的基本概念</span><br><span class="line">  内容:</span><br><span class="line">    - callbacks 和 processor 结构</span><br><span class="line">    - 回调注册方法</span><br><span class="line">    - 默认回调列表</span><br><span class="line">  验证:</span><br><span class="line">    - 能列出 6 种处理器类型</span><br><span class="line">    - 能解释回调的执行顺序</span><br><span class="line">    - 能注册简单回调</span><br><span class="line"></span><br><span class="line">第 2 层: 掌握回调机制 (Day 2)</span><br><span class="line">  目标: 理解回调如何被执行</span><br><span class="line">  内容:</span><br><span class="line">    - processor.Execute() 流程</span><br><span class="line">    - 回调排序算法</span><br><span class="line">    - 回调链执行</span><br><span class="line">  验证:</span><br><span class="line">    - 能画出 Execute 流程图</span><br><span class="line">    - 能解释排序算法</span><br><span class="line">    - 能追踪回调执行</span><br><span class="line"></span><br><span class="line">第 3 层: 应用回调技巧 (Day 3)</span><br><span class="line">  目标: 掌握高级回调用法</span><br><span class="line">  内容:</span><br><span class="line">    - 模型钩子系统</span><br><span class="line">    - 条件回调</span><br><span class="line">    - 回调最佳实践</span><br><span class="line">  验证:</span><br><span class="line">    - 能实现模型钩子</span><br><span class="line">    - 能实现条件回调</span><br><span class="line">    - 能排查回调问题</span><br></pre></td></tr></table></figure>

<h4 id="策略-2-问题驱动"><a href="#策略-2-问题驱动" class="headerlink" title="策略 2: 问题驱动"></a>策略 2: 问题驱动</h4><p><strong>问题序列</strong>:</p>
<ol>
<li><p><strong>为什么需要回调系统？</strong></p>
<ul>
<li>尝试直接修改 GORM 源码添加功能</li>
<li>体验升级时的困难</li>
<li>理解回调系统的价值</li>
</ul>
</li>
<li><p><strong>回调是如何被触发的？</strong></p>
<ul>
<li>设置断点在 Find() 方法</li>
<li>追踪到 Execute()</li>
<li>观察回调链执行</li>
</ul>
</li>
<li><p><strong>如何保证回调顺序？</strong></p>
<ul>
<li>注册多个有依赖关系的回调</li>
<li>观察排序结果</li>
<li>理解 before&#x2F;after 机制</li>
</ul>
</li>
<li><p><strong>模型钩子和全局回调有什么区别？</strong></p>
<ul>
<li>对比两种方式的实现</li>
<li>测试性能差异</li>
<li>选择合适的场景</li>
</ul>
</li>
<li><p><strong>如何实现条件回调？</strong></p>
<ul>
<li>实现 Match 条件</li>
<li>测试不同情况</li>
<li>理解 compile 过程</li>
</ul>
</li>
</ol>
<h4 id="策略-3-验证反馈"><a href="#策略-3-验证反馈" class="headerlink" title="策略 3: 验证反馈"></a>策略 3: 验证反馈</h4><p><strong>验证点 1: 理解验证</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 测试: 回调执行顺序</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestCallbackOrder</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> order []<span class="type">string</span></span><br><span class="line"></span><br><span class="line">    db, _ := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;&#125;)</span><br><span class="line">    db.Callback().Create().Register(<span class="string">&quot;A&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(db *gorm.DB)</span></span> &#123;</span><br><span class="line">        order = <span class="built_in">append</span>(order, <span class="string">&quot;A&quot;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    db.Callback().Create().Register(<span class="string">&quot;B&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(db *gorm.DB)</span></span> &#123;</span><br><span class="line">        order = <span class="built_in">append</span>(order, <span class="string">&quot;B&quot;</span>)</span><br><span class="line">    &#125;).After(<span class="string">&quot;A&quot;</span>)</span><br><span class="line">    db.Callback().Create().Register(<span class="string">&quot;C&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(db *gorm.DB)</span></span> &#123;</span><br><span class="line">        order = <span class="built_in">append</span>(order, <span class="string">&quot;C&quot;</span>)</span><br><span class="line">    &#125;).Before(<span class="string">&quot;A&quot;</span>)</span><br><span class="line"></span><br><span class="line">    db.Create(&amp;User&#123;&#125;)</span><br><span class="line"></span><br><span class="line">    assert.Equal(t, []<span class="type">string</span>&#123;<span class="string">&quot;C&quot;</span>, <span class="string">&quot;A&quot;</span>, <span class="string">&quot;B&quot;</span>&#125;, order)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>验证点 2: 实践验证</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 任务: 实现完整的审计系统</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> AuditService <span class="keyword">struct</span> &#123;</span><br><span class="line">    db *gorm.DB</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *AuditService)</span></span> Register(db *gorm.DB) &#123;</span><br><span class="line">    <span class="comment">// Create 审计</span></span><br><span class="line">    db.Callback().Create().After(<span class="string">&quot;gorm:create&quot;</span>).Register(<span class="string">&quot;audit:create&quot;</span>, s.logCreate)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Update 审计</span></span><br><span class="line">    db.Callback().Update().After(<span class="string">&quot;gorm:update&quot;</span>).Register(<span class="string">&quot;audit:update&quot;</span>, s.logUpdate)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Delete 审计</span></span><br><span class="line">    db.Callback().Delete().After(<span class="string">&quot;gorm:delete&quot;</span>).Register(<span class="string">&quot;audit:delete&quot;</span>, s.logDelete)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *AuditService)</span></span> logCreate(tx *gorm.DB) &#123;</span><br><span class="line">    <span class="comment">// 实现创建审计</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *AuditService)</span></span> logUpdate(tx *gorm.DB) &#123;</span><br><span class="line">    <span class="comment">// 实现更新审计</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *AuditService)</span></span> logDelete(tx *gorm.DB) &#123;</span><br><span class="line">    <span class="comment">// 实现删除审计</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 测试</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestAuditService</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">    db, _ := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;&#125;)</span><br><span class="line">    service := &amp;AuditService&#123;db: db&#125;</span><br><span class="line">    service.Register(db)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行操作</span></span><br><span class="line">    db.Create(&amp;User&#123;Name: <span class="string">&quot;John&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 验证审计日志</span></span><br><span class="line">    <span class="keyword">var</span> logs []AuditLog</span><br><span class="line">    db.Find(&amp;logs)</span><br><span class="line">    assert.Equal(t, <span class="number">1</span>, <span class="built_in">len</span>(logs))</span><br><span class="line">    assert.Equal(t, <span class="string">&quot;create&quot;</span>, logs[<span class="number">0</span>].Action)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="三、学习路径建议"><a href="#三、学习路径建议" class="headerlink" title="三、学习路径建议"></a>三、学习路径建议</h2><h3 id="3-1-前置知识检查"><a href="#3-1-前置知识检查" class="headerlink" title="3.1 前置知识检查"></a>3.1 前置知识检查</h3><table>
<thead>
<tr>
<th>知识点</th>
<th>要求</th>
<th>检验方式</th>
</tr>
</thead>
<tbody><tr>
<td>接口定义</td>
<td>理解接口和方法集</td>
<td>能定义 BeforeCreateInterface</td>
</tr>
<tr>
<td>函数类型</td>
<td>理解函数作为值</td>
<td>能写出 func(*DB) 的签名</td>
</tr>
<tr>
<td>拓扑排序</td>
<td>了解 DAG 排序</td>
<td>能手动排序简单依赖</td>
</tr>
<tr>
<td>设计模式</td>
<td>了解责任链、观察者</td>
<td>能识别应用场景</td>
</tr>
</tbody></table>
<h3 id="3-2-学习时间分配"><a href="#3-2-学习时间分配" class="headerlink" title="3.2 学习时间分配"></a>3.2 学习时间分配</h3><table>
<thead>
<tr>
<th>内容</th>
<th>理论</th>
<th>实践</th>
<th>产出</th>
</tr>
</thead>
<tbody><tr>
<td>Day 1: 回调基础</td>
<td>2h</td>
<td>1.5h</td>
<td>回调注册示例</td>
</tr>
<tr>
<td>Day 2: 执行流程</td>
<td>1.5h</td>
<td>2h</td>
<td>流程图、追踪日志</td>
</tr>
<tr>
<td>Day 3: 高级特性</td>
<td>1.5h</td>
<td>2h</td>
<td>审计系统、软删除</td>
</tr>
</tbody></table>
<h3 id="3-3-学习成果验收"><a href="#3-3-学习成果验收" class="headerlink" title="3.3 学习成果验收"></a>3.3 学习成果验收</h3><p><strong>理论验收</strong>:</p>
<ul>
<li><input disabled="" type="checkbox"> 能解释回调系统的设计目的</li>
<li><input disabled="" type="checkbox"> 能说明 processor.Execute() 的流程</li>
<li><input disabled="" type="checkbox"> 能区分模型钩子和全局回调</li>
<li><input disabled="" type="checkbox"> 能解释回调排序算法</li>
</ul>
<p><strong>实践验收</strong>:</p>
<ul>
<li><input disabled="" type="checkbox"> 能注册全局回调</li>
<li><input disabled="" type="checkbox"> 能实现模型钩子</li>
<li><input disabled="" type="checkbox"> 能实现条件回调</li>
<li><input disabled="" type="checkbox"> 能排查回调顺序问题</li>
</ul>
<p><strong>综合验收</strong>:</p>
<ul>
<li><input disabled="" type="checkbox"> 能实现完整的审计系统</li>
<li><input disabled="" type="checkbox"> 能分析回调执行顺序</li>
<li><input disabled="" type="checkbox"> 能优化回调性能</li>
<li><input disabled="" type="checkbox"> 能向他人讲解回调系统</li>
</ul>
<hr>
<h2 id="四、callbacks-结构完整解析-callbacks-go-29-73"><a href="#四、callbacks-结构完整解析-callbacks-go-29-73" class="headerlink" title="四、callbacks 结构完整解析 (callbacks.go:29-73)"></a>四、callbacks 结构完整解析 (callbacks.go:29-73)</h2><h3 id="callbacks-和-processor-结构体"><a href="#callbacks-和-processor-结构体" class="headerlink" title="callbacks 和 processor 结构体"></a>callbacks 和 processor 结构体</h3><p><strong>完整定义</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// callbacks 回调容器，管理所有操作的处理器</span></span><br><span class="line"><span class="keyword">type</span> callbacks <span class="keyword">struct</span> &#123;</span><br><span class="line">    processors <span class="keyword">map</span>[<span class="type">string</span>]*processor  <span class="comment">// 处理器映射</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// processor 单个操作的处理器</span></span><br><span class="line"><span class="keyword">type</span> processor <span class="keyword">struct</span> &#123;</span><br><span class="line">    db        *gorm.DB        <span class="comment">// DB 实例</span></span><br><span class="line">    Clauses   []<span class="type">string</span>         <span class="comment">// 子句构建顺序</span></span><br><span class="line">    fns       []<span class="function"><span class="keyword">func</span><span class="params">(*gorm.DB)</span></span> <span class="comment">// 编译后的函数列表</span></span><br><span class="line">    callbacks []*callback      <span class="comment">// 回调列表</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// callback 单个回调的定义</span></span><br><span class="line"><span class="keyword">type</span> callback <span class="keyword">struct</span> &#123;</span><br><span class="line">    name      <span class="type">string</span>                <span class="comment">// 回调名称: &quot;gorm:before_create&quot;</span></span><br><span class="line">    before    <span class="type">string</span>                <span class="comment">// 在哪个回调之前执行</span></span><br><span class="line">    after     <span class="type">string</span>                <span class="comment">// 在哪个回调之后执行</span></span><br><span class="line">    remove    <span class="type">bool</span>                  <span class="comment">// 是否移除</span></span><br><span class="line">    replace   <span class="type">bool</span>                  <span class="comment">// 是否替换</span></span><br><span class="line">    match     <span class="function"><span class="keyword">func</span><span class="params">(*gorm.DB)</span></span> <span class="type">bool</span>   <span class="comment">// 匹配条件函数</span></span><br><span class="line">    handler   <span class="function"><span class="keyword">func</span><span class="params">(*gorm.DB)</span></span>        <span class="comment">// 处理函数</span></span><br><span class="line">    processor *processor            <span class="comment">// 所属处理器</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>处理器访问方法</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Create 获取 Create 处理器</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(cs *callbacks)</span></span> Create() *processor &#123;</span><br><span class="line">    <span class="keyword">return</span> cs.processors[<span class="string">&quot;create&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Query 获取 Query 处理器</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(cs *callbacks)</span></span> Query() *processor &#123;</span><br><span class="line">    <span class="keyword">return</span> cs.processors[<span class="string">&quot;query&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Update 获取 Update 处理器</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(cs *callbacks)</span></span> Update() *processor &#123;</span><br><span class="line">    <span class="keyword">return</span> cs.processors[<span class="string">&quot;update&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Delete 获取 Delete 处理器</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(cs *callbacks)</span></span> Delete() *processor &#123;</span><br><span class="line">    <span class="keyword">return</span> cs.processors[<span class="string">&quot;delete&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Row 获取 Row 处理器</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(cs *callbacks)</span></span> Row() *processor &#123;</span><br><span class="line">    <span class="keyword">return</span> cs.processors[<span class="string">&quot;row&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Raw 获取 Raw 处理器</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(cs *callbacks)</span></span> Raw() *processor &#123;</span><br><span class="line">    <span class="keyword">return</span> cs.processors[<span class="string">&quot;raw&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="RegisterDefaultCallbacks-完整实现-callbacks-go-22-83"><a href="#RegisterDefaultCallbacks-完整实现-callbacks-go-22-83" class="headerlink" title="RegisterDefaultCallbacks 完整实现 (callbacks.go:22-83)"></a>RegisterDefaultCallbacks 完整实现 (callbacks.go:22-83)</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Config 回调配置</span></span><br><span class="line"><span class="keyword">type</span> Config <span class="keyword">struct</span> &#123;</span><br><span class="line">    LastInsertIDReversed <span class="type">bool</span>      <span class="comment">// 是否反转 LastInsertID 顺序</span></span><br><span class="line">    CreateClauses        []<span class="type">string</span>  <span class="comment">// Create 操作的子句顺序</span></span><br><span class="line">    QueryClauses         []<span class="type">string</span>  <span class="comment">// Query 操作的子句顺序</span></span><br><span class="line">    UpdateClauses        []<span class="type">string</span>  <span class="comment">// Update 操作的子句顺序</span></span><br><span class="line">    DeleteClauses        []<span class="type">string</span>  <span class="comment">// Delete 操作的子句顺序</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 默认子句顺序</span></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">    createClauses = []<span class="type">string</span>&#123;<span class="string">&quot;INSERT&quot;</span>, <span class="string">&quot;VALUES&quot;</span>, <span class="string">&quot;ON CONFLICT&quot;</span>&#125;</span><br><span class="line">    queryClauses  = []<span class="type">string</span>&#123;<span class="string">&quot;SELECT&quot;</span>, <span class="string">&quot;FROM&quot;</span>, <span class="string">&quot;WHERE&quot;</span>, <span class="string">&quot;GROUP BY&quot;</span>, <span class="string">&quot;ORDER BY&quot;</span>, <span class="string">&quot;LIMIT&quot;</span>, <span class="string">&quot;FOR&quot;</span>&#125;</span><br><span class="line">    updateClauses = []<span class="type">string</span>&#123;<span class="string">&quot;UPDATE&quot;</span>, <span class="string">&quot;SET&quot;</span>, <span class="string">&quot;WHERE&quot;</span>&#125;</span><br><span class="line">    deleteClauses = []<span class="type">string</span>&#123;<span class="string">&quot;DELETE&quot;</span>, <span class="string">&quot;FROM&quot;</span>, <span class="string">&quot;WHERE&quot;</span>&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// RegisterDefaultCallbacks 注册默认回调</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RegisterDefaultCallbacks</span><span class="params">(db *gorm.DB, config *Config)</span></span> &#123;</span><br><span class="line">    <span class="comment">// 1. 定义事务启用条件</span></span><br><span class="line">    enableTransaction := <span class="function"><span class="keyword">func</span><span class="params">(db *gorm.DB)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> !db.SkipDefaultTransaction</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 设置默认子句顺序（如果未指定）</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(config.CreateClauses) == <span class="number">0</span> &#123;</span><br><span class="line">        config.CreateClauses = createClauses</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(config.QueryClauses) == <span class="number">0</span> &#123;</span><br><span class="line">        config.QueryClauses = queryClauses</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(config.DeleteClauses) == <span class="number">0</span> &#123;</span><br><span class="line">        config.DeleteClauses = deleteClauses</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(config.UpdateClauses) == <span class="number">0</span> &#123;</span><br><span class="line">        config.UpdateClauses = updateClauses</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 注册 Create 回调链</span></span><br><span class="line">    createCallback := db.Callback().Create()</span><br><span class="line">    createCallback.Match(enableTransaction).Register(<span class="string">&quot;gorm:begin_transaction&quot;</span>, BeginTransaction)</span><br><span class="line">    createCallback.Register(<span class="string">&quot;gorm:before_create&quot;</span>, BeforeCreate)</span><br><span class="line">    createCallback.Register(<span class="string">&quot;gorm:save_before_associations&quot;</span>, SaveBeforeAssociations(<span class="literal">true</span>))</span><br><span class="line">    createCallback.Register(<span class="string">&quot;gorm:create&quot;</span>, Create(config))</span><br><span class="line">    createCallback.Register(<span class="string">&quot;gorm:save_after_associations&quot;</span>, SaveAfterAssociations(<span class="literal">true</span>))</span><br><span class="line">    createCallback.Register(<span class="string">&quot;gorm:after_create&quot;</span>, AfterCreate)</span><br><span class="line">    createCallback.Match(enableTransaction).Register(<span class="string">&quot;gorm:commit_or_rollback_transaction&quot;</span>, CommitOrRollbackTransaction)</span><br><span class="line">    createCallback.Clauses = config.CreateClauses</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. 注册 Query 回调链</span></span><br><span class="line">    queryCallback := db.Callback().Query()</span><br><span class="line">    queryCallback.Register(<span class="string">&quot;gorm:query&quot;</span>, Query)</span><br><span class="line">    queryCallback.Register(<span class="string">&quot;gorm:preload&quot;</span>, Preload)</span><br><span class="line">    queryCallback.Register(<span class="string">&quot;gorm:after_query&quot;</span>, AfterQuery)</span><br><span class="line">    queryCallback.Clauses = config.QueryClauses</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5. 注册 Delete 回调链</span></span><br><span class="line">    deleteCallback := db.Callback().Delete()</span><br><span class="line">    deleteCallback.Match(enableTransaction).Register(<span class="string">&quot;gorm:begin_transaction&quot;</span>, BeginTransaction)</span><br><span class="line">    deleteCallback.Register(<span class="string">&quot;gorm:before_delete&quot;</span>, BeforeDelete)</span><br><span class="line">    deleteCallback.Register(<span class="string">&quot;gorm:delete_before_associations&quot;</span>, DeleteBeforeAssociations)</span><br><span class="line">    deleteCallback.Register(<span class="string">&quot;gorm:delete&quot;</span>, Delete(config))</span><br><span class="line">    deleteCallback.Register(<span class="string">&quot;gorm:after_delete&quot;</span>, AfterDelete)</span><br><span class="line">    deleteCallback.Match(enableTransaction).Register(<span class="string">&quot;gorm:commit_or_rollback_transaction&quot;</span>, CommitOrRollbackTransaction)</span><br><span class="line">    deleteCallback.Clauses = config.DeleteClauses</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 6. 注册 Update 回调链</span></span><br><span class="line">    updateCallback := db.Callback().Update()</span><br><span class="line">    updateCallback.Match(enableTransaction).Register(<span class="string">&quot;gorm:begin_transaction&quot;</span>, BeginTransaction)</span><br><span class="line">    updateCallback.Register(<span class="string">&quot;gorm:setup_reflect_value&quot;</span>, SetupUpdateReflectValue)</span><br><span class="line">    updateCallback.Register(<span class="string">&quot;gorm:before_update&quot;</span>, BeforeUpdate)</span><br><span class="line">    updateCallback.Register(<span class="string">&quot;gorm:save_before_associations&quot;</span>, SaveBeforeAssociations(<span class="literal">false</span>))</span><br><span class="line">    updateCallback.Register(<span class="string">&quot;gorm:update&quot;</span>, Update(config))</span><br><span class="line">    updateCallback.Register(<span class="string">&quot;gorm:save_after_associations&quot;</span>, SaveAfterAssociations(<span class="literal">false</span>))</span><br><span class="line">    updateCallback.Register(<span class="string">&quot;gorm:after_update&quot;</span>, AfterUpdate)</span><br><span class="line">    updateCallback.Match(enableTransaction).Register(<span class="string">&quot;gorm:commit_or_rollback_transaction&quot;</span>, CommitOrRollbackTransaction)</span><br><span class="line">    updateCallback.Clauses = config.UpdateClauses</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 7. 注册 Row 回调链</span></span><br><span class="line">    rowCallback := db.Callback().Row()</span><br><span class="line">    rowCallback.Register(<span class="string">&quot;gorm:row&quot;</span>, RowQuery)</span><br><span class="line">    rowCallback.Clauses = config.QueryClauses</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 8. 注册 Raw 回调链</span></span><br><span class="line">    rawCallback := db.Callback().Raw()</span><br><span class="line">    rawCallback.Register(<span class="string">&quot;gorm:raw&quot;</span>, RawExec)</span><br><span class="line">    rawCallback.Clauses = config.QueryClauses</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Create-回调流程完整解析-create-go-14-100"><a href="#Create-回调流程完整解析-create-go-14-100" class="headerlink" title="Create 回调流程完整解析 (create.go:14-100+)"></a>Create 回调流程完整解析 (create.go:14-100+)</h3><p><strong>BeforeCreate 回调</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// BeforeCreate 创建前的模型钩子</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BeforeCreate</span><span class="params">(db *gorm.DB)</span></span> &#123;</span><br><span class="line">    <span class="comment">// 1. 检查执行条件</span></span><br><span class="line">    <span class="keyword">if</span> db.Error == <span class="literal">nil</span> &amp;&amp;</span><br><span class="line">       db.Statement.Schema != <span class="literal">nil</span> &amp;&amp;</span><br><span class="line">       !db.Statement.SkipHooks &amp;&amp;</span><br><span class="line">       (db.Statement.Schema.BeforeSave || db.Statement.Schema.BeforeCreate) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 调用模型方法</span></span><br><span class="line">        callMethod(db, <span class="function"><span class="keyword">func</span><span class="params">(value <span class="keyword">interface</span>&#123;&#125;, tx *gorm.DB)</span></span> (called <span class="type">bool</span>) &#123;</span><br><span class="line">            <span class="comment">// 2.1 先调用 BeforeSave</span></span><br><span class="line">            <span class="keyword">if</span> db.Statement.Schema.BeforeSave &#123;</span><br><span class="line">                <span class="keyword">if</span> i, ok := value.(BeforeSaveInterface); ok &#123;</span><br><span class="line">                    called = <span class="literal">true</span></span><br><span class="line">                    db.AddError(i.BeforeSave(tx))</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2.2 再调用 BeforeCreate</span></span><br><span class="line">            <span class="keyword">if</span> db.Statement.Schema.BeforeCreate &#123;</span><br><span class="line">                <span class="keyword">if</span> i, ok := value.(BeforeCreateInterface); ok &#123;</span><br><span class="line">                    called = <span class="literal">true</span></span><br><span class="line">                    db.AddError(i.BeforeCreate(tx))</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> called</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Create 核心回调</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Create 创建回调的核心逻辑</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Create</span><span class="params">(config *Config)</span></span> <span class="function"><span class="keyword">func</span><span class="params">(db *gorm.DB)</span></span> &#123;</span><br><span class="line">    supportReturning := utils.Contains(config.CreateClauses, <span class="string">&quot;RETURNING&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(db *gorm.DB)</span></span> &#123;</span><br><span class="line">        <span class="comment">// 1. 检查错误状态</span></span><br><span class="line">        <span class="keyword">if</span> db.Error != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 添加 Schema 级别的子句</span></span><br><span class="line">        <span class="keyword">if</span> db.Statement.Schema != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> !db.Statement.Unscoped &#123;</span><br><span class="line">                <span class="keyword">for</span> _, c := <span class="keyword">range</span> db.Statement.Schema.CreateClauses &#123;</span><br><span class="line">                    db.Statement.AddClause(c)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2.1 处理 RETURNING 子句</span></span><br><span class="line">            <span class="keyword">if</span> supportReturning &amp;&amp; <span class="built_in">len</span>(db.Statement.Schema.FieldsWithDefaultDBValue) &gt; <span class="number">0</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> _, ok := db.Statement.Clauses[<span class="string">&quot;RETURNING&quot;</span>]; !ok &#123;</span><br><span class="line">                    fromColumns := <span class="built_in">make</span>([]clause.Column, <span class="number">0</span>,</span><br><span class="line">                        <span class="built_in">len</span>(db.Statement.Schema.FieldsWithDefaultDBValue))</span><br><span class="line">                    <span class="keyword">for</span> _, field := <span class="keyword">range</span> db.Statement.Schema.FieldsWithDefaultDBValue &#123;</span><br><span class="line">                        <span class="keyword">if</span> field.Readable &#123;</span><br><span class="line">                            fromColumns = <span class="built_in">append</span>(fromColumns, clause.Column&#123;Name: field.DBName&#125;)</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> <span class="built_in">len</span>(fromColumns) &gt; <span class="number">0</span> &#123;</span><br><span class="line">                        db.Statement.AddClause(clause.Returning&#123;Columns: fromColumns&#125;)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 构建 SQL</span></span><br><span class="line">        <span class="keyword">if</span> db.Statement.SQL.Len() == <span class="number">0</span> &#123;</span><br><span class="line">            db.Statement.SQL.Grow(<span class="number">180</span>)</span><br><span class="line">            db.Statement.AddClauseIfNotExists(clause.Insert&#123;&#125;)</span><br><span class="line">            db.Statement.AddClause(ConvertToCreateValues(db.Statement))</span><br><span class="line">            db.Statement.Build(db.Statement.BuildClauses...)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. 执行 SQL (非 DryRun 模式)</span></span><br><span class="line">        <span class="keyword">if</span> !db.DryRun &amp;&amp; db.Error == <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. 处理 RETURNING 结果</span></span><br><span class="line">        ok, mode := hasReturning(db, supportReturning)</span><br><span class="line">        <span class="keyword">if</span> ok &#123;</span><br><span class="line">            <span class="comment">// 5.1 处理 ON CONFLICT</span></span><br><span class="line">            <span class="keyword">if</span> c, ok := db.Statement.Clauses[<span class="string">&quot;ON CONFLICT&quot;</span>]; ok &#123;</span><br><span class="line">                onConflict, _ := c.Expression.(clause.OnConflict)</span><br><span class="line">                <span class="keyword">if</span> onConflict.DoNothing &#123;</span><br><span class="line">                    mode |= gorm.ScanOnConflictDoNothing</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="built_in">len</span>(onConflict.DoUpdates) &gt; <span class="number">0</span> || onConflict.UpdateAll &#123;</span><br><span class="line">                    mode |= gorm.ScanUpdate</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 5.2 执行查询并扫描结果</span></span><br><span class="line">            rows, err := db.Statement.ConnPool.QueryContext(</span><br><span class="line">                db.Statement.Context,</span><br><span class="line">                db.Statement.SQL.String(),</span><br><span class="line">                db.Statement.Vars...,</span><br><span class="line">            )</span><br><span class="line">            <span class="keyword">if</span> db.AddError(err) == <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">                    db.AddError(rows.Close())</span><br><span class="line">                &#125;()</span><br><span class="line">                gorm.Scan(rows, db, mode)</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 5.3 处理结果</span></span><br><span class="line">                <span class="keyword">if</span> db.Statement.Result != <span class="literal">nil</span> &#123;</span><br><span class="line">                    <span class="comment">// ... 处理结果</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="回调注册-API-完整解析"><a href="#回调注册-API-完整解析" class="headerlink" title="回调注册 API 完整解析"></a>回调注册 API 完整解析</h3><p><strong>回调注册方法</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Register 注册回调</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *processor)</span></span> Register(name <span class="type">string</span>, handler <span class="function"><span class="keyword">func</span><span class="params">(*gorm.DB)</span></span>) *callback &#123;</span><br><span class="line">    <span class="comment">// 1. 创建回调实例</span></span><br><span class="line">    f := &amp;callback&#123;</span><br><span class="line">        name:      name,</span><br><span class="line">        handler:   handler,</span><br><span class="line">        processor: p,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 添加到回调列表</span></span><br><span class="line">    p.callbacks = <span class="built_in">append</span>(p.callbacks, f)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 清空编译的函数列表（需要重新编译）</span></span><br><span class="line">    p.fns = <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> f</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Before 在指定回调之前注册</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *callback)</span></span> Before(name <span class="type">string</span>) *callback &#123;</span><br><span class="line">    f.before = name</span><br><span class="line">    <span class="keyword">return</span> f</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// After 在指定回调之后注册</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *callback)</span></span> After(name <span class="type">string</span>) *callback &#123;</span><br><span class="line">    f.after = name</span><br><span class="line">    <span class="keyword">return</span> f</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Match 设置匹配条件</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *callback)</span></span> Match(match <span class="function"><span class="keyword">func</span><span class="params">(*gorm.DB)</span></span> <span class="type">bool</span>) *callback &#123;</span><br><span class="line">    f.match = match</span><br><span class="line">    <span class="keyword">return</span> f</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Replace 替换指定回调</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *processor)</span></span> Replace(name <span class="type">string</span>, handler <span class="function"><span class="keyword">func</span><span class="params">(*gorm.DB)</span></span>) *callback &#123;</span><br><span class="line">    <span class="comment">// 1. 查找目标回调</span></span><br><span class="line">    <span class="keyword">for</span> _, callback := <span class="keyword">range</span> p.callbacks &#123;</span><br><span class="line">        <span class="keyword">if</span> callback.name == name &#123;</span><br><span class="line">            callback.replace = <span class="literal">true</span></span><br><span class="line">            callback.handler = handler</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 清空编译的函数列表</span></span><br><span class="line">    p.fns = <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Remove 移除指定回调</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *processor)</span></span> Remove(name <span class="type">string</span>) &#123;</span><br><span class="line">    <span class="comment">// 1. 标记要移除的回调</span></span><br><span class="line">    <span class="keyword">for</span> _, callback := <span class="keyword">range</span> p.callbacks &#123;</span><br><span class="line">        <span class="keyword">if</span> callback.name == name &#123;</span><br><span class="line">            callback.remove = <span class="literal">true</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 清空编译的函数列表</span></span><br><span class="line">    p.fns = <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="回调执行流程图"><a href="#回调执行流程图" class="headerlink" title="回调执行流程图"></a>回调执行流程图</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">processor.Execute(db)</span><br><span class="line">        │</span><br><span class="line">        ▼</span><br><span class="line">   [编译回调函数]</span><br><span class="line">   fns == nil? ──Yes──► 编译回调列表</span><br><span class="line">        │ No              │</span><br><span class="line">        ▼                 │</span><br><span class="line">   [遍历函数列表]         │</span><br><span class="line">   for _, fn := range fns</span><br><span class="line">        │</span><br><span class="line">        ├─► 执行 fn(db)</span><br><span class="line">        │</span><br><span class="line">        ├─► 检查错误</span><br><span class="line">        │   db.Error != nil? ──Yes──► 停止执行</span><br><span class="line">        │   │ No</span><br><span class="line">        │   ▼</span><br><span class="line">        └─► 继续</span><br><span class="line">            │</span><br><span class="line">            ▼</span><br><span class="line">       返回 db</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">回调编译流程:</span><br><span class="line"></span><br><span class="line">compileCallbacks()</span><br><span class="line">        │</span><br><span class="line">        ▼</span><br><span class="line">   [收集有效回调]</span><br><span class="line">   for _, callback := range callbacks</span><br><span class="line">        │</span><br><span class="line">        ├─► 跳过已移除 (callback.remove)</span><br><span class="line">        │</span><br><span class="line">        ├─► 跳过被替换 (callback.replace)</span><br><span class="line">        │</span><br><span class="line">        └─► 添加到列表</span><br><span class="line">            │</span><br><span class="line">            ▼</span><br><span class="line">   [拓扑排序]</span><br><span class="line">   根据依赖关系排序</span><br><span class="line">   before/after 关系</span><br><span class="line">        │</span><br><span class="line">        ▼</span><br><span class="line">   [生成函数列表]</span><br><span class="line">   fns = [fn1, fn2, fn3, ...]</span><br><span class="line">        │</span><br><span class="line">        ▼</span><br><span class="line">   返回</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="五、实战代码示例"><a href="#五、实战代码示例" class="headerlink" title="五、实战代码示例"></a>五、实战代码示例</h2><h3 id="5-1-基础回调使用"><a href="#5-1-基础回调使用" class="headerlink" title="5.1 基础回调使用"></a>5.1 基础回调使用</h3><h4 id="示例-1-注册全局回调"><a href="#示例-1-注册全局回调" class="headerlink" title="示例 1: 注册全局回调"></a>示例 1: 注册全局回调</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;gorm.io/gorm&quot;</span></span><br><span class="line">    <span class="string">&quot;gorm.io/gorm/clause&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">    ID    <span class="type">uint</span></span><br><span class="line">    Name  <span class="type">string</span></span><br><span class="line">    Email <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    db, _ := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. 注册 Before 回调</span></span><br><span class="line">    db.Callback().Create().Before(<span class="string">&quot;gorm:create&quot;</span>).Register(<span class="string">&quot;my:before_create&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(db *gorm.DB)</span></span> &#123;</span><br><span class="line">        fmt.Println(<span class="string">&quot;Before create:&quot;</span>, db.Statement.Statement)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 注册 After 回调</span></span><br><span class="line">    db.Callback().Create().After(<span class="string">&quot;gorm:create&quot;</span>).Register(<span class="string">&quot;my:after_create&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(db *gorm.DB)</span></span> &#123;</span><br><span class="line">        fmt.Println(<span class="string">&quot;After create:&quot;</span>, db.Statement.RowsAffected)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 执行创建</span></span><br><span class="line">    db.Create(&amp;User&#123;Name: <span class="string">&quot;John&quot;</span>, Email: <span class="string">&quot;john@example.com&quot;</span>&#125;)</span><br><span class="line">    <span class="comment">// 输出:</span></span><br><span class="line">    <span class="comment">// Before create: ...</span></span><br><span class="line">    <span class="comment">// After create: 1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="示例-2-条件回调"><a href="#示例-2-条件回调" class="headerlink" title="示例 2: 条件回调"></a>示例 2: 条件回调</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 只在特定条件下执行</span></span><br><span class="line">db.Callback().Create().Match(<span class="function"><span class="keyword">func</span><span class="params">(db *gorm.DB)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="comment">// 只在非事务模式下执行</span></span><br><span class="line">    <span class="keyword">return</span> db.SkipDefaultTransaction</span><br><span class="line">&#125;).Register(<span class="string">&quot;my:conditional_callback&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(db *gorm.DB)</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;Conditional callback executed&quot;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="示例-3-替换默认回调"><a href="#示例-3-替换默认回调" class="headerlink" title="示例 3: 替换默认回调"></a>示例 3: 替换默认回调</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 替换默认的创建回调</span></span><br><span class="line">db.Callback().Create().Replace(<span class="string">&quot;gorm:create&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(db *gorm.DB)</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;Custom create logic&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 自定义创建逻辑</span></span><br><span class="line">    db.Statement.SQL.WriteString(<span class="string">&quot;INSERT INTO users (name) VALUES (?)&quot;</span>)</span><br><span class="line">    db.Statement.AddVar(db, <span class="string">&quot;John&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行 SQL</span></span><br><span class="line">    db.Exec(db.Statement.SQL.String(), db.Statement.Vars...)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="5-2-模型钩子示例"><a href="#5-2-模型钩子示例" class="headerlink" title="5.2 模型钩子示例"></a>5.2 模型钩子示例</h3><h4 id="示例-4-实现模型钩子"><a href="#示例-4-实现模型钩子" class="headerlink" title="示例 4: 实现模型钩子"></a>示例 4: 实现模型钩子</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">    ID        <span class="type">uint</span></span><br><span class="line">    Name      <span class="type">string</span></span><br><span class="line">    Email     <span class="type">string</span></span><br><span class="line">    CreatedAt time.Time</span><br><span class="line">    UpdatedAt time.Time</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// BeforeCreate 创建前钩子</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *User)</span></span> BeforeCreate(tx *gorm.DB) <span class="type">error</span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;BeforeCreate hook called&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 验证数据</span></span><br><span class="line">    <span class="keyword">if</span> u.Name == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> errors.New(<span class="string">&quot;name cannot be empty&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置默认值</span></span><br><span class="line">    <span class="keyword">if</span> u.Email == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">        u.Email = <span class="string">&quot;default@example.com&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AfterCreate 创建后钩子</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *User)</span></span> AfterCreate(tx *gorm.DB) <span class="type">error</span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;AfterCreate hook called&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 记录日志</span></span><br><span class="line">    fmt.Printf(<span class="string">&quot;User created with ID: %d\n&quot;</span>, u.ID)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// BeforeUpdate 更新前钩子</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *User)</span></span> BeforeUpdate(tx *gorm.DB) <span class="type">error</span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;BeforeUpdate hook called&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 记录变更</span></span><br><span class="line">    <span class="keyword">if</span> tx.Statement.Changed(<span class="string">&quot;Name&quot;</span>) &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;Name changing from %s to %s\n&quot;</span>,</span><br><span class="line">            tx.Statement.Dest.(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;)[<span class="string">&quot;name_before&quot;</span>],</span><br><span class="line">            u.Name)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用</span></span><br><span class="line">db.Create(&amp;User&#123;Name: <span class="string">&quot;John&quot;</span>&#125;)</span><br><span class="line"><span class="comment">// 输出:</span></span><br><span class="line"><span class="comment">// BeforeCreate hook called</span></span><br><span class="line"><span class="comment">// AfterCreate hook called</span></span><br><span class="line"><span class="comment">// User created with ID: 1</span></span><br></pre></td></tr></table></figure>

<h3 id="5-3-高级回调场景"><a href="#5-3-高级回调场景" class="headerlink" title="5.3 高级回调场景"></a>5.3 高级回调场景</h3><h4 id="示例-5-实现审计日志"><a href="#示例-5-实现审计日志" class="headerlink" title="示例 5: 实现审计日志"></a>示例 5: 实现审计日志</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> AuditLog <span class="keyword">struct</span> &#123;</span><br><span class="line">    ID        <span class="type">uint</span>   <span class="string">`gorm:&quot;primaryKey&quot;`</span></span><br><span class="line">    Action    <span class="type">string</span> <span class="string">`gorm:&quot;size:50&quot;`</span></span><br><span class="line">    TableName <span class="type">string</span> <span class="string">`gorm:&quot;size:50&quot;`</span></span><br><span class="line">    RecordID  <span class="type">uint</span></span><br><span class="line">    Timestamp time.Time</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> AuditService <span class="keyword">struct</span> &#123;</span><br><span class="line">    db *gorm.DB</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *AuditService)</span></span> Register(db *gorm.DB) &#123;</span><br><span class="line">    <span class="comment">// 创建审计</span></span><br><span class="line">    db.Callback().Create().After(<span class="string">&quot;gorm:after_create&quot;</span>).Register(<span class="string">&quot;audit:create&quot;</span>, s.auditCreate)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 更新审计</span></span><br><span class="line">    db.Callback().Update().After(<span class="string">&quot;gorm:after_update&quot;</span>).Register(<span class="string">&quot;audit:update&quot;</span>, s.auditUpdate)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 删除审计</span></span><br><span class="line">    db.Callback().Delete().After(<span class="string">&quot;gorm:after_delete&quot;</span>).Register(<span class="string">&quot;audit:delete&quot;</span>, s.auditDelete)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *AuditService)</span></span> auditCreate(db *gorm.DB) &#123;</span><br><span class="line">    <span class="comment">// 获取创建的记录 ID</span></span><br><span class="line">    <span class="keyword">if</span> db.Statement.RowsAffected &gt; <span class="number">0</span> &#123;</span><br><span class="line">        <span class="comment">// 创建审计日志</span></span><br><span class="line">        s.db.Create(&amp;AuditLog&#123;</span><br><span class="line">            Action:    <span class="string">&quot;create&quot;</span>,</span><br><span class="line">            TableName: db.Statement.Table,</span><br><span class="line">            RecordID:  <span class="comment">// 从结果中获取 ID</span></span><br><span class="line">            Timestamp: time.Now(),</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *AuditService)</span></span> auditUpdate(db *gorm.DB) &#123;</span><br><span class="line">    <span class="comment">// 记录更新操作</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *AuditService)</span></span> auditDelete(db *gorm.DB) &#123;</span><br><span class="line">    <span class="comment">// 记录删除操作</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="示例-6-实现软删除"><a href="#示例-6-实现软删除" class="headerlink" title="示例 6: 实现软删除"></a>示例 6: 实现软删除</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> SoftDelete <span class="keyword">struct</span> &#123;</span><br><span class="line">    DeletedAt *time.Time <span class="string">`gorm:&quot;index&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">    gorm.Model</span><br><span class="line">    SoftDelete</span><br><span class="line">    Name <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// BeforeDelete 删除前钩子</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *User)</span></span> BeforeDelete(tx *gorm.DB) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="comment">// 如果是 Unscoped 操作，执行硬删除</span></span><br><span class="line">    <span class="keyword">if</span> tx.Statement.Unscoped &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 否则执行软删除</span></span><br><span class="line">    now := time.Now()</span><br><span class="line">    tx.Statement.SQL.WriteString(<span class="string">&quot;UPDATE users SET deleted_at = ? WHERE id = ? AND deleted_at IS NULL&quot;</span>)</span><br><span class="line">    tx.Statement.AddVar(tx, now)</span><br><span class="line">    tx.Statement.AddVar(tx, u.ID)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 跳过默认删除</span></span><br><span class="line">    tx.SkipHooks = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用</span></span><br><span class="line">db.Delete(&amp;User&#123;&#125;)  <span class="comment">// 软删除</span></span><br><span class="line">db.Unscoped().Delete(&amp;User&#123;&#125;)  <span class="comment">// 硬删除</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="六、最佳实践与故障排查"><a href="#六、最佳实践与故障排查" class="headerlink" title="六、最佳实践与故障排查"></a>六、最佳实践与故障排查</h2><h3 id="6-1-回调使用最佳实践"><a href="#6-1-回调使用最佳实践" class="headerlink" title="6.1 回调使用最佳实践"></a>6.1 回调使用最佳实践</h3><h4 id="1-合理使用钩子时机"><a href="#1-合理使用钩子时机" class="headerlink" title="1. 合理使用钩子时机"></a>1. 合理使用钩子时机</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 推荐：在合适的时机执行操作</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *User)</span></span> BeforeCreate(tx *gorm.DB) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="comment">// 验证数据</span></span><br><span class="line">    <span class="keyword">if</span> err := validateEmail(u.Email); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置默认值</span></span><br><span class="line">    <span class="keyword">if</span> u.CreatedAt.IsZero() &#123;</span><br><span class="line">        u.CreatedAt = time.Now()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 不推荐：在钩子中执行查询</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *User)</span></span> BeforeCreate(tx *gorm.DB) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="comment">// 避免在钩子中执行查询，会导致 N+1 问题</span></span><br><span class="line">    <span class="keyword">var</span> count <span class="type">int64</span></span><br><span class="line">    tx.Model(&amp;User&#123;&#125;).Count(&amp;count)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-使用条件回调"><a href="#2-使用条件回调" class="headerlink" title="2. 使用条件回调"></a>2. 使用条件回调</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 只在特定条件下注册回调</span></span><br><span class="line">db.Callback().Create().Match(<span class="function"><span class="keyword">func</span><span class="params">(db *gorm.DB)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="comment">// 只在非 DryRun 模式下执行</span></span><br><span class="line">    <span class="keyword">return</span> !db.DryRun</span><br><span class="line">&#125;).Register(<span class="string">&quot;my:dryrun_check&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(db *gorm.DB)</span></span> &#123;</span><br><span class="line">    <span class="comment">// 只在非 DryRun 模式下执行</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="3-回调错误处理"><a href="#3-回调错误处理" class="headerlink" title="3. 回调错误处理"></a>3. 回调错误处理</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在钩子中返回错误会中断操作</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *User)</span></span> BeforeCreate(tx *gorm.DB) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> u.Age &lt; <span class="number">18</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> errors.New(<span class="string">&quot;age must be greater than 18&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用</span></span><br><span class="line">err := db.Create(&amp;User&#123;Age: <span class="number">16</span>&#125;).Error</span><br><span class="line"><span class="comment">// Error: age must be greater than 18</span></span><br></pre></td></tr></table></figure>

<h3 id="6-2-常见问题与解决方案"><a href="#6-2-常见问题与解决方案" class="headerlink" title="6.2 常见问题与解决方案"></a>6.2 常见问题与解决方案</h3><h4 id="问题-1-回调没有被执行"><a href="#问题-1-回调没有被执行" class="headerlink" title="问题 1: 回调没有被执行"></a>问题 1: 回调没有被执行</h4><p><strong>症状</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *User)</span></span> BeforeCreate(tx *gorm.DB) <span class="type">error</span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;BeforeCreate called&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">db.Create(&amp;User&#123;&#125;)  <span class="comment">// 没有输出</span></span><br></pre></td></tr></table></figure>

<p><strong>原因</strong>:</p>
<ol>
<li>SkipHooks 被设置为 true</li>
<li>Schema 没有检测到钩子方法</li>
</ol>
<p><strong>解决方案</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 检查 SkipHooks</span></span><br><span class="line">db.Statement.SkipHooks = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 确保 Schema 正确解析</span></span><br><span class="line">db.AutoMigrate(&amp;User&#123;&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="问题-2-回调执行顺序错误"><a href="#问题-2-回调执行顺序错误" class="headerlink" title="问题 2: 回调执行顺序错误"></a>问题 2: 回调执行顺序错误</h4><p><strong>症状</strong>: 自定义回调在默认回调之前执行</p>
<p><strong>解决方案</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用 Before/After 控制顺序</span></span><br><span class="line">db.Callback().Create().After(<span class="string">&quot;gorm:before_create&quot;</span>).Register(<span class="string">&quot;my:callback&quot;</span>, fn)</span><br><span class="line">db.Callback().Create().Before(<span class="string">&quot;gorm:create&quot;</span>).Register(<span class="string">&quot;my:another&quot;</span>, fn2)</span><br></pre></td></tr></table></figure>

<h4 id="问题-3-钩子中的错误被忽略"><a href="#问题-3-钩子中的错误被忽略" class="headerlink" title="问题 3: 钩子中的错误被忽略"></a>问题 3: 钩子中的错误被忽略</h4><p><strong>症状</strong>: 钩子返回错误但操作继续执行</p>
<p><strong>解决方案</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *User)</span></span> BeforeCreate(tx *gorm.DB) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> err := validate(u); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="comment">// 确保错误被添加到 DB</span></span><br><span class="line">        tx.AddError(err)</span><br><span class="line">        <span class="keyword">return</span> err  <span class="comment">// 返回错误</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="七、学习验证"><a href="#七、学习验证" class="headerlink" title="七、学习验证"></a>七、学习验证</h2><h3 id="7-1-知识自测"><a href="#7-1-知识自测" class="headerlink" title="7.1 知识自测"></a>7.1 知识自测</h3><h4 id="基础题"><a href="#基础题" class="headerlink" title="基础题"></a>基础题</h4><ol>
<li><p><strong>GORM 支持哪些模型钩子？</strong></p>
<ul>
<li>A. BeforeCreate, AfterCreate</li>
<li>B. BeforeUpdate, AfterUpdate</li>
<li>C. BeforeDelete, AfterDelete</li>
<li>D. 以上都是</li>
</ul>
</li>
<li><p><strong>如何注册全局回调？</strong></p>
<ul>
<li>A. 实现 BeforeCreateInterface</li>
<li>B. 使用 db.Callback().Create().Register()</li>
<li>C. 使用 db.Callback().Create().Replace()</li>
<li>D. 以上都可以</li>
</ul>
</li>
<li><p><strong>回调的执行顺序由什么决定？</strong></p>
<ul>
<li>A. 注册顺序</li>
<li>B. before&#x2F;after 关系</li>
<li>C. 回调名称字母顺序</li>
<li>D. 随机顺序</li>
</ul>
</li>
</ol>
<h4 id="进阶题"><a href="#进阶题" class="headerlink" title="进阶题"></a>进阶题</h4><ol start="4">
<li><p><strong>如何让回调只在特定条件下执行？</strong></p>
<ul>
<li>使用 Match 方法</li>
<li>在回调函数内部判断</li>
<li>使用 Replace 方法</li>
<li>使用 Remove 方法</li>
</ul>
</li>
<li><p><strong>以下代码的执行顺序是什么？</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.Callback().Create().Register(<span class="string">&quot;A&quot;</span>, fnA)</span><br><span class="line">db.Callback().Create().Register(<span class="string">&quot;B&quot;</span>, fnB).After(<span class="string">&quot;A&quot;</span>)</span><br><span class="line">db.Callback().Create().Register(<span class="string">&quot;C&quot;</span>, fnC).Before(<span class="string">&quot;A&quot;</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>A → B → C</li>
<li>C → A → B</li>
<li>B → A → C</li>
</ul>
</li>
</ol>
<h3 id="7-2-实践练习"><a href="#7-2-实践练习" class="headerlink" title="7.2 实践练习"></a>7.2 实践练习</h3><h4 id="练习-1-实现数据验证钩子"><a href="#练习-1-实现数据验证钩子" class="headerlink" title="练习 1: 实现数据验证钩子"></a>练习 1: 实现数据验证钩子</h4><p>实现一个创建前的数据验证钩子：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *User)</span></span> BeforeCreate(tx *gorm.DB) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> 实现以下验证</span></span><br><span class="line">    <span class="comment">// 1. Name 不能为空</span></span><br><span class="line">    <span class="comment">// 2. Email 格式必须正确</span></span><br><span class="line">    <span class="comment">// 3. Age 必须 &gt;= 18</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="练习-2-实现自定义日志回调"><a href="#练习-2-实现自定义日志回调" class="headerlink" title="练习 2: 实现自定义日志回调"></a>练习 2: 实现自定义日志回调</h4><p>创建一个记录所有 SQL 操作的回调：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> QueryLogger <span class="keyword">struct</span> &#123;</span><br><span class="line">    logger *log.Logger</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ql *QueryLogger)</span></span> Register(db *gorm.DB) &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> 注册回调记录所有 SQL</span></span><br><span class="line">    <span class="comment">// 1. 记录 SQL 语句</span></span><br><span class="line">    <span class="comment">// 2. 记录执行时间</span></span><br><span class="line">    <span class="comment">// 3. 记录影响行数</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a target="_blank" rel="noopener" href="https://github.com/Piwriw">Joohwan.</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://piwriw.github.io/2026/01/11/web/gorm/05-callback/">https://piwriw.github.io/2026/01/11/web/gorm/05-callback/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://piwriw.github.io" target="_blank">Joohwan</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/web/">web</a><a class="post-meta__tags" href="/tags/Gorm/">Gorm</a><a class="post-meta__tags" href="/tags/%E6%BA%90%E7%A0%81/">源码</a></div><div class="post-share"><div class="social-share" data-image="/img/go.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>赞助</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2026/01/11/web/gorm/06-associations/" title="Gorm-关联关系模块原理说明"><img class="cover" src="/img/go.png" onerror="onerror=null;src='/img/404.png'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">Gorm-关联关系模块原理说明</div></div><div class="info-2"><div class="info-item-1">关联关系模块原理说明  基于1.31 本文档深入解析关联关系模块的设计原理和核心实现，涵盖关系推断、预加载机制、N+1 问题解决、Association API 等核心内容。通过阅读本文档，您将能够完全理解 GORM 关联关系模块的工作原理，无需额外阅读源码。   目录 一、设计原理 1.1 模块定位 1.2 设计目的 1.3 结构安排依据 1.4 与其他模块的逻辑关系   二、核心数据结构 2.1 Relationship 结构完整解析 2.2 Relationships 结构 2.3 Reference 结构 2.4 Polymorphic 结构   三、关系推断机制 3.1 parseRelation 函数完整实现 3.2 guessRelation 函数完整实现 3.3 buildPolymorphicRelation 实现 3.4 buildMany2ManyRelation 实现 3.5 关系推断决策树   四、预加载机制 4.1 preloadEntryPoint 完整实现 4.2 preload 函数完整实现 4.3 Preload 执行流程图 4.4 嵌套预加载...</div></div></div></a><a class="pagination-related" href="/2026/01/11/web/gorm/04-clause/" title="Gorm-子句系统模块原理说明"><img class="cover" src="/img/go.png" onerror="onerror=null;src='/img/404.png'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">Gorm-子句系统模块原理说明</div></div><div class="info-2"><div class="info-item-1">子句系统模块原理说明 基于1.31 本文档深入解析子句系统模块的设计原理和核心原理，阐述 SQL 组件化构建的理论基础。   一、设计原理1.1 模块定位在整体架构中的位置 子句系统是 GORM SQL 构建的核心组件化引擎，位于 Statement 层之下，直接负责将用户意图转换为 SQL 片段。 1234567891011121314151617181920212223242526┌─────────────────────────────────────────────────────────────┐│                   用户 API 调用                               ││  db.Where(&quot;age &gt; ?&quot;, 18).Order(&quot;name&quot;).Limit(10)           │└────────────────────────┬────────────────────────────────────┘                         │ 解析意图...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2026/01/11/web/gorm/09-logger/" title="Gorm-日志系统模块原理说明"><img class="cover" src="/img/go.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-01-11</div><div class="info-item-2">Gorm-日志系统模块原理说明</div></div><div class="info-2"><div class="info-item-1">日志系统模块原理说明 基于1.31 本文档深入解析日志系统模块的设计原理和核心实现，涵盖 SQL 日志记录、性能分析、调用栈追踪等核心内容。学习完本文档后，您将能够彻底理解 GORM 日志系统的工作机制，并能够实现自定义 Logger 来满足各种日志需求。  文档目录12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394959697989910010110210310410510610710810911011111211311411511611711811912012112212312412512612712812913013113213313413513613713813914009-logger.md├── 一、设计原理│   ├── 1.1 模块定位│   ├── 1.2 设...</div></div></div></a><a class="pagination-related" href="/2026/01/11/web/gorm/08-migration/" title="Gorm-迁移功能模块原理说明"><img class="cover" src="/img/go.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-01-11</div><div class="info-item-2">Gorm-迁移功能模块原理说明</div></div><div class="info-2"><div class="info-item-1">迁移功能模块原理说明 基于1.31 本文档深入解析迁移功能模块的设计原理和核心实现，涵盖数据库结构管理、类型映射、约束管理等核心内容。学习完本文档后，您将能够彻底理解 GORM 迁移系统的工作机制，并能够在实际项目中安全高效地进行数据库迁移。  文档目录1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798991001011021031041051061071081091101111121131141151161171181191201211221231241251261271281291301311321331341351361371381391401411421431441451461471481491501511521531541551561571581591...</div></div></div></a><a class="pagination-related" href="/2026/01/11/web/gorm/10-plugin/" title="Gorm-插件系统模块原理说明"><img class="cover" src="/img/go.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-01-11</div><div class="info-item-2">Gorm-插件系统模块原理说明</div></div><div class="info-2"><div class="info-item-1">插件系统模块原理说明 基于1.31 本文档深入解析插件系统模块的设计原理和核心实现，涵盖扩展机制、插件开发、集成模式等核心内容。  目录 一、设计原理 1.1 模块定位 1.2 设计目的 1.3 结构安排依据 1.4 与其他模块的逻辑关系 1.5 插件类型分类   二、核心数据结构 2.1 Plugin 接口 2.2 Config 插件字段 2.3 Use() 方法   三、核心实现 3.1 插件注册机制 3.2 插件初始化流程 3.3 回调系统集成 3.4 插件状态管理   四、实战代码示例 4.1 基础插件开发 4.2 读写分离插件 4.3 查询缓存插件 4.4 性能监控插件 4.5 数据脱敏插件   五、可视化流程图 5.1 插件注册流程 5.2 插件初始化流程 5.3 回调集成流程 5.4 插件系统架构   六、最佳实践与故障排查 6.1 开发最佳实践 6.2 常见问题与解决方案 6.3 性能优化建议 6.4 安全建议   七、学习验证 7.1 知识自测 7.2 实践练习     一、设计原理1.1 模块定位在整体架构中的位置 插件系统是 GORM 的扩展机制，位于应用层...</div></div></div></a><a class="pagination-related" href="/2026/01/11/web/gorm/07-transaction/" title="Gorm-事务处理模块原理说明"><img class="cover" src="/img/go.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-01-11</div><div class="info-item-2">Gorm-事务处理模块原理说明</div></div><div class="info-2"><div class="info-item-1">事务处理模块原理说明 基于1.31 本文档深入解析事务处理模块的设计原理和核心实现，涵盖事务管理、嵌套事务、保存点机制等核心内容。通过阅读本文档，您将能够完全理解 GORM 事务处理模块的工作原理，无需额外阅读源码。   目录 一、设计原理 1.1 模块定位 1.2 设计目的 1.3 结构安排依据 1.4 与其他模块的逻辑关系   二、核心数据结构 2.1 事务相关接口 2.2 TxOptions 配置   三、事务核心实现 3.1 Transaction 函数完整实现 3.2 Begin 函数完整实现 3.3 Commit 和 Rollback 实现 3.4 SavePoint 和 RollbackTo 实现 3.5 事务执行流程图   四、默认事务机制 4.1 BeginTransaction 实现 4.2 CommitOrRollbackTransaction 实现 4.3 回调注册流程 4.4 默认事务流程图   五、实战代码示例 5.1 基础事务使用 5.2 嵌套事务使用 5.3 手动事务控制 5.4 保存点使用 5.5 隔离级别配置 5.6 复杂业务场景   六、最佳...</div></div></div></a><a class="pagination-related" href="/2026/01/11/web/gorm/06-associations/" title="Gorm-关联关系模块原理说明"><img class="cover" src="/img/go.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-01-11</div><div class="info-item-2">Gorm-关联关系模块原理说明</div></div><div class="info-2"><div class="info-item-1">关联关系模块原理说明  基于1.31 本文档深入解析关联关系模块的设计原理和核心实现，涵盖关系推断、预加载机制、N+1 问题解决、Association API 等核心内容。通过阅读本文档，您将能够完全理解 GORM 关联关系模块的工作原理，无需额外阅读源码。   目录 一、设计原理 1.1 模块定位 1.2 设计目的 1.3 结构安排依据 1.4 与其他模块的逻辑关系   二、核心数据结构 2.1 Relationship 结构完整解析 2.2 Relationships 结构 2.3 Reference 结构 2.4 Polymorphic 结构   三、关系推断机制 3.1 parseRelation 函数完整实现 3.2 guessRelation 函数完整实现 3.3 buildPolymorphicRelation 实现 3.4 buildMany2ManyRelation 实现 3.5 关系推断决策树   四、预加载机制 4.1 preloadEntryPoint 完整实现 4.2 preload 函数完整实现 4.3 Preload 执行流程图 4.4 嵌套预加载...</div></div></div></a><a class="pagination-related" href="/2026/01/11/web/gorm/04-clause/" title="Gorm-子句系统模块原理说明"><img class="cover" src="/img/go.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-01-11</div><div class="info-item-2">Gorm-子句系统模块原理说明</div></div><div class="info-2"><div class="info-item-1">子句系统模块原理说明 基于1.31 本文档深入解析子句系统模块的设计原理和核心原理，阐述 SQL 组件化构建的理论基础。   一、设计原理1.1 模块定位在整体架构中的位置 子句系统是 GORM SQL 构建的核心组件化引擎，位于 Statement 层之下，直接负责将用户意图转换为 SQL 片段。 1234567891011121314151617181920212223242526┌─────────────────────────────────────────────────────────────┐│                   用户 API 调用                               ││  db.Where(&quot;age &gt; ?&quot;, 18).Order(&quot;name&quot;).Limit(10)           │└────────────────────────┬────────────────────────────────────┘                         │ 解析意图...</div></div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Joohwan.</div><div class="author-info-description">该知道的都知道，不知道的慢慢了解</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">259</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">76</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">60</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/piwriw"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/piwriw" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:piwriw@163.com" target="_blank" title="Email"><i class="fas fa-envelope-open-text"></i></a></div></div><div class="card-widget"><div class="item-headline"><i class="iconfont icat-visitor"></i><span>来访者</span></div><div class="item-content"><div id="welcome-info"></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9E%E8%B0%83%E9%92%A9%E5%AD%90%E6%A8%A1%E5%9D%97%E5%8E%9F%E7%90%86%E8%AF%B4%E6%98%8E"><span class="toc-number">1.</span> <span class="toc-text">回调钩子模块原理说明</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E8%AE%BE%E8%AE%A1%E5%8E%9F%E7%90%86"><span class="toc-number">1.1.</span> <span class="toc-text">一、设计原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E6%A8%A1%E5%9D%97%E5%AE%9A%E4%BD%8D"><span class="toc-number">1.1.1.</span> <span class="toc-text">1.1 模块定位</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E8%AE%BE%E8%AE%A1%E7%9B%AE%E7%9A%84"><span class="toc-number">1.1.2.</span> <span class="toc-text">1.2 设计目的</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-%E7%BB%93%E6%9E%84%E5%AE%89%E6%8E%92%E4%BE%9D%E6%8D%AE"><span class="toc-number">1.1.3.</span> <span class="toc-text">1.3 结构安排依据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-%E4%B8%8E%E5%85%B6%E4%BB%96%E6%A8%A1%E5%9D%97%E7%9A%84%E9%80%BB%E8%BE%91%E5%85%B3%E7%B3%BB"><span class="toc-number">1.1.4.</span> <span class="toc-text">1.4 与其他模块的逻辑关系</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86"><span class="toc-number">1.2.</span> <span class="toc-text">二、核心原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E5%85%B3%E9%94%AE%E6%A6%82%E5%BF%B5"><span class="toc-number">1.2.1.</span> <span class="toc-text">2.1 关键概念</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5-1-callbacks-%E7%BB%93%E6%9E%84"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">概念 1: callbacks 结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5-2-callback-%E7%BB%93%E6%9E%84"><span class="toc-number">1.2.1.2.</span> <span class="toc-text">概念 2: callback 结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5-3-processor-Execute-%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-number">1.2.1.3.</span> <span class="toc-text">概念 3: processor.Execute() 执行流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5-4-%E5%9B%9E%E8%B0%83%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95"><span class="toc-number">1.2.1.4.</span> <span class="toc-text">概念 4: 回调排序算法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5-5-%E6%A8%A1%E5%9E%8B%E9%92%A9%E5%AD%90%E7%B3%BB%E7%BB%9F"><span class="toc-number">1.2.1.5.</span> <span class="toc-text">概念 5: 模型钩子系统</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E7%90%86%E8%AE%BA%E5%9F%BA%E7%A1%80"><span class="toc-number">1.2.2.</span> <span class="toc-text">2.2 理论基础</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%90%86%E8%AE%BA-1-%E8%B4%A3%E4%BB%BB%E9%93%BE%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">理论 1: 责任链模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%90%86%E8%AE%BA-2-%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">理论 2: 事件驱动模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%90%86%E8%AE%BA-3-%E6%8B%93%E6%89%91%E6%8E%92%E5%BA%8F"><span class="toc-number">1.2.2.3.</span> <span class="toc-text">理论 3: 拓扑排序</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%90%86%E8%AE%BA-4-%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.2.2.4.</span> <span class="toc-text">理论 4: 观察者模式</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E5%AD%A6%E4%B9%A0%E6%96%B9%E6%B3%95"><span class="toc-number">1.2.3.</span> <span class="toc-text">2.3 学习方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%B3%95-1-%E8%BF%BD%E8%B8%AA%E6%B3%95"><span class="toc-number">1.2.3.1.</span> <span class="toc-text">方法 1: 追踪法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%B3%95-2-%E5%AF%B9%E6%AF%94%E6%B3%95"><span class="toc-number">1.2.3.2.</span> <span class="toc-text">方法 2: 对比法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%B3%95-3-%E5%AE%9E%E8%B7%B5%E6%B3%95"><span class="toc-number">1.2.3.3.</span> <span class="toc-text">方法 3: 实践法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-%E5%AE%9E%E6%96%BD%E7%AD%96%E7%95%A5"><span class="toc-number">1.2.4.</span> <span class="toc-text">2.4 实施策略</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AD%96%E7%95%A5-1-%E5%88%86%E5%B1%82%E5%AD%A6%E4%B9%A0"><span class="toc-number">1.2.4.1.</span> <span class="toc-text">策略 1: 分层学习</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AD%96%E7%95%A5-2-%E9%97%AE%E9%A2%98%E9%A9%B1%E5%8A%A8"><span class="toc-number">1.2.4.2.</span> <span class="toc-text">策略 2: 问题驱动</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AD%96%E7%95%A5-3-%E9%AA%8C%E8%AF%81%E5%8F%8D%E9%A6%88"><span class="toc-number">1.2.4.3.</span> <span class="toc-text">策略 3: 验证反馈</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E5%AD%A6%E4%B9%A0%E8%B7%AF%E5%BE%84%E5%BB%BA%E8%AE%AE"><span class="toc-number">1.3.</span> <span class="toc-text">三、学习路径建议</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86%E6%A3%80%E6%9F%A5"><span class="toc-number">1.3.1.</span> <span class="toc-text">3.1 前置知识检查</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E5%AD%A6%E4%B9%A0%E6%97%B6%E9%97%B4%E5%88%86%E9%85%8D"><span class="toc-number">1.3.2.</span> <span class="toc-text">3.2 学习时间分配</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E5%AD%A6%E4%B9%A0%E6%88%90%E6%9E%9C%E9%AA%8C%E6%94%B6"><span class="toc-number">1.3.3.</span> <span class="toc-text">3.3 学习成果验收</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81callbacks-%E7%BB%93%E6%9E%84%E5%AE%8C%E6%95%B4%E8%A7%A3%E6%9E%90-callbacks-go-29-73"><span class="toc-number">1.4.</span> <span class="toc-text">四、callbacks 结构完整解析 (callbacks.go:29-73)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#callbacks-%E5%92%8C-processor-%E7%BB%93%E6%9E%84%E4%BD%93"><span class="toc-number">1.4.1.</span> <span class="toc-text">callbacks 和 processor 结构体</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RegisterDefaultCallbacks-%E5%AE%8C%E6%95%B4%E5%AE%9E%E7%8E%B0-callbacks-go-22-83"><span class="toc-number">1.4.2.</span> <span class="toc-text">RegisterDefaultCallbacks 完整实现 (callbacks.go:22-83)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Create-%E5%9B%9E%E8%B0%83%E6%B5%81%E7%A8%8B%E5%AE%8C%E6%95%B4%E8%A7%A3%E6%9E%90-create-go-14-100"><span class="toc-number">1.4.3.</span> <span class="toc-text">Create 回调流程完整解析 (create.go:14-100+)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9E%E8%B0%83%E6%B3%A8%E5%86%8C-API-%E5%AE%8C%E6%95%B4%E8%A7%A3%E6%9E%90"><span class="toc-number">1.4.4.</span> <span class="toc-text">回调注册 API 完整解析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9E%E8%B0%83%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="toc-number">1.4.5.</span> <span class="toc-text">回调执行流程图</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E5%AE%9E%E6%88%98%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.5.</span> <span class="toc-text">五、实战代码示例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-%E5%9F%BA%E7%A1%80%E5%9B%9E%E8%B0%83%E4%BD%BF%E7%94%A8"><span class="toc-number">1.5.1.</span> <span class="toc-text">5.1 基础回调使用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B-1-%E6%B3%A8%E5%86%8C%E5%85%A8%E5%B1%80%E5%9B%9E%E8%B0%83"><span class="toc-number">1.5.1.1.</span> <span class="toc-text">示例 1: 注册全局回调</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B-2-%E6%9D%A1%E4%BB%B6%E5%9B%9E%E8%B0%83"><span class="toc-number">1.5.1.2.</span> <span class="toc-text">示例 2: 条件回调</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B-3-%E6%9B%BF%E6%8D%A2%E9%BB%98%E8%AE%A4%E5%9B%9E%E8%B0%83"><span class="toc-number">1.5.1.3.</span> <span class="toc-text">示例 3: 替换默认回调</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-%E6%A8%A1%E5%9E%8B%E9%92%A9%E5%AD%90%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.5.2.</span> <span class="toc-text">5.2 模型钩子示例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B-4-%E5%AE%9E%E7%8E%B0%E6%A8%A1%E5%9E%8B%E9%92%A9%E5%AD%90"><span class="toc-number">1.5.2.1.</span> <span class="toc-text">示例 4: 实现模型钩子</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-%E9%AB%98%E7%BA%A7%E5%9B%9E%E8%B0%83%E5%9C%BA%E6%99%AF"><span class="toc-number">1.5.3.</span> <span class="toc-text">5.3 高级回调场景</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B-5-%E5%AE%9E%E7%8E%B0%E5%AE%A1%E8%AE%A1%E6%97%A5%E5%BF%97"><span class="toc-number">1.5.3.1.</span> <span class="toc-text">示例 5: 实现审计日志</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B-6-%E5%AE%9E%E7%8E%B0%E8%BD%AF%E5%88%A0%E9%99%A4"><span class="toc-number">1.5.3.2.</span> <span class="toc-text">示例 6: 实现软删除</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E3%80%81%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E4%B8%8E%E6%95%85%E9%9A%9C%E6%8E%92%E6%9F%A5"><span class="toc-number">1.6.</span> <span class="toc-text">六、最佳实践与故障排查</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-%E5%9B%9E%E8%B0%83%E4%BD%BF%E7%94%A8%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">1.6.1.</span> <span class="toc-text">6.1 回调使用最佳实践</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%90%88%E7%90%86%E4%BD%BF%E7%94%A8%E9%92%A9%E5%AD%90%E6%97%B6%E6%9C%BA"><span class="toc-number">1.6.1.1.</span> <span class="toc-text">1. 合理使用钩子时机</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E4%BD%BF%E7%94%A8%E6%9D%A1%E4%BB%B6%E5%9B%9E%E8%B0%83"><span class="toc-number">1.6.1.2.</span> <span class="toc-text">2. 使用条件回调</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%9B%9E%E8%B0%83%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86"><span class="toc-number">1.6.1.3.</span> <span class="toc-text">3. 回调错误处理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E4%B8%8E%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">1.6.2.</span> <span class="toc-text">6.2 常见问题与解决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%AE%E9%A2%98-1-%E5%9B%9E%E8%B0%83%E6%B2%A1%E6%9C%89%E8%A2%AB%E6%89%A7%E8%A1%8C"><span class="toc-number">1.6.2.1.</span> <span class="toc-text">问题 1: 回调没有被执行</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%AE%E9%A2%98-2-%E5%9B%9E%E8%B0%83%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F%E9%94%99%E8%AF%AF"><span class="toc-number">1.6.2.2.</span> <span class="toc-text">问题 2: 回调执行顺序错误</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%AE%E9%A2%98-3-%E9%92%A9%E5%AD%90%E4%B8%AD%E7%9A%84%E9%94%99%E8%AF%AF%E8%A2%AB%E5%BF%BD%E7%95%A5"><span class="toc-number">1.6.2.3.</span> <span class="toc-text">问题 3: 钩子中的错误被忽略</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83%E3%80%81%E5%AD%A6%E4%B9%A0%E9%AA%8C%E8%AF%81"><span class="toc-number">1.7.</span> <span class="toc-text">七、学习验证</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-%E7%9F%A5%E8%AF%86%E8%87%AA%E6%B5%8B"><span class="toc-number">1.7.1.</span> <span class="toc-text">7.1 知识自测</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E9%A2%98"><span class="toc-number">1.7.1.1.</span> <span class="toc-text">基础题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9B%E9%98%B6%E9%A2%98"><span class="toc-number">1.7.1.2.</span> <span class="toc-text">进阶题</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-%E5%AE%9E%E8%B7%B5%E7%BB%83%E4%B9%A0"><span class="toc-number">1.7.2.</span> <span class="toc-text">7.2 实践练习</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%83%E4%B9%A0-1-%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E9%AA%8C%E8%AF%81%E9%92%A9%E5%AD%90"><span class="toc-number">1.7.2.1.</span> <span class="toc-text">练习 1: 实现数据验证钩子</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%83%E4%B9%A0-2-%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%AE%9A%E4%B9%89%E6%97%A5%E5%BF%97%E5%9B%9E%E8%B0%83"><span class="toc-number">1.7.2.2.</span> <span class="toc-text">练习 2: 实现自定义日志回调</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2026/01/11/web/gorm/09-logger/" title="Gorm-日志系统模块原理说明"><img src="/img/go.png" onerror="this.onerror=null;this.src='/img/404.png'" alt="Gorm-日志系统模块原理说明"/></a><div class="content"><a class="title" href="/2026/01/11/web/gorm/09-logger/" title="Gorm-日志系统模块原理说明">Gorm-日志系统模块原理说明</a><time datetime="2026-01-11T11:56:27.000Z" title="发表于 2026-01-11 19:56:27">2026-01-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2026/01/11/web/gorm/08-migration/" title="Gorm-迁移功能模块原理说明"><img src="/img/go.png" onerror="this.onerror=null;this.src='/img/404.png'" alt="Gorm-迁移功能模块原理说明"/></a><div class="content"><a class="title" href="/2026/01/11/web/gorm/08-migration/" title="Gorm-迁移功能模块原理说明">Gorm-迁移功能模块原理说明</a><time datetime="2026-01-11T10:56:27.000Z" title="发表于 2026-01-11 18:56:27">2026-01-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2026/01/11/web/gorm/10-plugin/" title="Gorm-插件系统模块原理说明"><img src="/img/go.png" onerror="this.onerror=null;this.src='/img/404.png'" alt="Gorm-插件系统模块原理说明"/></a><div class="content"><a class="title" href="/2026/01/11/web/gorm/10-plugin/" title="Gorm-插件系统模块原理说明">Gorm-插件系统模块原理说明</a><time datetime="2026-01-11T10:56:27.000Z" title="发表于 2026-01-11 18:56:27">2026-01-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2026/01/11/web/gorm/07-transaction/" title="Gorm-事务处理模块原理说明"><img src="/img/go.png" onerror="this.onerror=null;this.src='/img/404.png'" alt="Gorm-事务处理模块原理说明"/></a><div class="content"><a class="title" href="/2026/01/11/web/gorm/07-transaction/" title="Gorm-事务处理模块原理说明">Gorm-事务处理模块原理说明</a><time datetime="2026-01-11T09:56:27.000Z" title="发表于 2026-01-11 17:56:27">2026-01-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2026/01/11/web/gorm/06-associations/" title="Gorm-关联关系模块原理说明"><img src="/img/go.png" onerror="this.onerror=null;this.src='/img/404.png'" alt="Gorm-关联关系模块原理说明"/></a><div class="content"><a class="title" href="/2026/01/11/web/gorm/06-associations/" title="Gorm-关联关系模块原理说明">Gorm-关联关系模块原理说明</a><time datetime="2026-01-11T08:56:27.000Z" title="发表于 2026-01-11 16:56:27">2026-01-11</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2023 - 2026 By Joohwan.</span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
  const option = null

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://piwriw-twikoo-git-main-piwriw.vercel.app/',
      region: 'ap-shanghai',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const init = (el = document, path = location.pathname) => {
    twikoo.init({
      el: el.querySelector('#twikoo-wrap'),
      envId: 'https://piwriw-twikoo-git-main-piwriw.vercel.app/',
      region: 'ap-shanghai',
      onCommentLoaded: () => {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      },
      ...option,
      path: isShuoshuo ? path : (option && option.path) || path
    })

    

    isShuoshuo && (window.shuoshuoComment.destroyTwikoo = () => {
      if (el.children.length) {
        el.innerHTML = ''
        el.classList.add('no-comment')
      }
    })
  }

  const loadTwikoo = (el, path) => {
    if (typeof twikoo === 'object') setTimeout(() => init(el, path), 0)
    else btf.getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(() => init(el, path))
  }

  if (isShuoshuo) {
    'Twikoo' === 'Twikoo'
      ? window.shuoshuoComment = { loadComment: loadTwikoo }
      : window.loadOtherComment = loadTwikoo
    return
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script></div><script src="/js/categories.js" defer></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>