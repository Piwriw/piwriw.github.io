<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Gorm-事务处理模块原理说明 | Joohwan</title><meta name="author" content="Joohwan."><meta name="copyright" content="Joohwan."><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="事务处理模块原理说明 基于1.31 本文档深入解析事务处理模块的设计原理和核心实现，涵盖事务管理、嵌套事务、保存点机制等核心内容。通过阅读本文档，您将能够完全理解 GORM 事务处理模块的工作原理，无需额外阅读源码。   目录 一、设计原理 1.1 模块定位 1.2 设计目的 1.3 结构安排依据 1.4 与其他模块的逻辑关系   二、核心数据结构 2.1 事务相关接口 2.2 TxOptions">
<meta property="og:type" content="article">
<meta property="og:title" content="Gorm-事务处理模块原理说明">
<meta property="og:url" content="https://piwriw.github.io/2026/01/11/web/gorm/07-transaction/index.html">
<meta property="og:site_name" content="Joohwan">
<meta property="og:description" content="事务处理模块原理说明 基于1.31 本文档深入解析事务处理模块的设计原理和核心实现，涵盖事务管理、嵌套事务、保存点机制等核心内容。通过阅读本文档，您将能够完全理解 GORM 事务处理模块的工作原理，无需额外阅读源码。   目录 一、设计原理 1.1 模块定位 1.2 设计目的 1.3 结构安排依据 1.4 与其他模块的逻辑关系   二、核心数据结构 2.1 事务相关接口 2.2 TxOptions">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://piwriw.github.io/img/go.png">
<meta property="article:published_time" content="2026-01-11T09:56:27.000Z">
<meta property="article:modified_time" content="2026-02-28T13:29:12.678Z">
<meta property="article:author" content="Joohwan.">
<meta property="article:tag" content="web">
<meta property="article:tag" content="Gorm">
<meta property="article:tag" content="源码">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://piwriw.github.io/img/go.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Gorm-事务处理模块原理说明",
  "url": "https://piwriw.github.io/2026/01/11/web/gorm/07-transaction/",
  "image": "https://piwriw.github.io/img/go.png",
  "datePublished": "2026-01-11T09:56:27.000Z",
  "dateModified": "2026-02-28T13:29:12.678Z",
  "author": [
    {
      "@type": "Person",
      "name": "Joohwan.",
      "url": "https://github.com/Piwriw"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://piwriw.github.io/2026/01/11/web/gorm/07-transaction/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Gorm-事务处理模块原理说明',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><script src="/js/welcome.js"></script><script src="https://npm.elemecdn.com/echarts@4.9.0/dist/echarts.min.js"></script><link rel="stylesheet" href="/css/categories.css"><link rel="stylesheet" href="/css/tabs.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">259</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">76</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">60</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/charts/"><i class="fa-fw fas fa-folder-open"></i><span> 文章统计</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div><div class="menus_item"><a class="site-page" href="/wish/"><i class="fa-fw fas fa-tags"></i><span> 许愿墙</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/go.png);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Joohwan</span></a><a class="nav-page-title" href="/"><span class="site-name">Gorm-事务处理模块原理说明</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/charts/"><i class="fa-fw fas fa-folder-open"></i><span> 文章统计</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div><div class="menus_item"><a class="site-page" href="/wish/"><i class="fa-fw fas fa-tags"></i><span> 许愿墙</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Gorm-事务处理模块原理说明</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2026-01-11T09:56:27.000Z" title="发表于 2026-01-11 17:56:27">2026-01-11</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2026-02-28T13:29:12.678Z" title="更新于 2026-02-28 21:29:12">2026-02-28</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/web/">web</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/web/gorm/">gorm</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">12.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>54分钟</span></span><span class="post-meta-separator">|</span><span id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="twikoo_visitors"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><div id="post-outdate-notice" data="{&quot;limitDay&quot;:365,&quot;messagePrev&quot;:&quot;It has been&quot;,&quot;messageNext&quot;:&quot;days since the last update, the content of the article may be outdated.&quot;,&quot;postUpdate&quot;:&quot;2026-02-28 21:29:12&quot;}" hidden></div><h1 id="事务处理模块原理说明"><a href="#事务处理模块原理说明" class="headerlink" title="事务处理模块原理说明"></a>事务处理模块原理说明</h1><blockquote>
<p>基于1.31 本文档深入解析事务处理模块的设计原理和核心实现，涵盖事务管理、嵌套事务、保存点机制等核心内容。通过阅读本文档，您将能够完全理解 GORM 事务处理模块的工作原理，无需额外阅读源码。</p>
</blockquote>
<hr>
<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ul>
<li><a href="#%E4%B8%80%E8%AE%BE%E8%AE%A1%E5%8E%9F%E7%90%86">一、设计原理</a><ul>
<li><a href="#11-%E6%A8%A1%E5%9D%97%E5%AE%9A%E4%BD%8D">1.1 模块定位</a></li>
<li><a href="#12-%E8%AE%BE%E8%AE%A1%E7%9B%AE%E7%9A%84">1.2 设计目的</a></li>
<li><a href="#13-%E7%BB%93%E6%9E%84%E5%AE%89%E6%8E%92%E4%BE%9D%E6%8D%AE">1.3 结构安排依据</a></li>
<li><a href="#14-%E4%B8%8E%E5%85%B6%E4%BB%96%E6%A8%A1%E5%9D%97%E7%9A%84%E9%80%BB%E8%BE%91%E5%85%B3%E7%B3%BB">1.4 与其他模块的逻辑关系</a></li>
</ul>
</li>
<li><a href="#%E4%BA%8C%E6%A0%B8%E5%BF%83%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84">二、核心数据结构</a><ul>
<li><a href="#21-%E4%BA%8B%E5%8A%A1%E7%9B%B8%E5%85%B3%E6%8E%A5%E5%8F%A3">2.1 事务相关接口</a></li>
<li><a href="#22-txoptions-%E9%85%8D%E7%BD%AE">2.2 TxOptions 配置</a></li>
</ul>
</li>
<li><a href="#%E4%B8%89%E4%BA%8B%E5%8A%A1%E6%A0%B8%E5%BF%83%E5%AE%9E%E7%8E%B0">三、事务核心实现</a><ul>
<li><a href="#31-transaction-%E5%87%BD%E6%95%B0%E5%AE%8C%E6%95%B4%E5%AE%9E%E7%8E%B0">3.1 Transaction 函数完整实现</a></li>
<li><a href="#32-begin-%E5%87%BD%E6%95%B0%E5%AE%8C%E6%95%B4%E5%AE%9E%E7%8E%B0">3.2 Begin 函数完整实现</a></li>
<li><a href="#33-commit-%E5%92%8C-rollback-%E5%AE%9E%E7%8E%B0">3.3 Commit 和 Rollback 实现</a></li>
<li><a href="#34-savepoint-%E5%92%8C-rollbackto-%E5%AE%9E%E7%8E%B0">3.4 SavePoint 和 RollbackTo 实现</a></li>
<li><a href="#35-%E4%BA%8B%E5%8A%A1%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B%E5%9B%BE">3.5 事务执行流程图</a></li>
</ul>
</li>
<li><a href="#%E5%9B%9B%E9%BB%98%E8%AE%A4%E4%BA%8B%E5%8A%A1%E6%9C%BA%E5%88%B6">四、默认事务机制</a><ul>
<li><a href="#41-begintransaction-%E5%AE%9E%E7%8E%B0">4.1 BeginTransaction 实现</a></li>
<li><a href="#42-commitorrollbacktransaction-%E5%AE%9E%E7%8E%B0">4.2 CommitOrRollbackTransaction 实现</a></li>
<li><a href="#43-%E5%9B%9E%E8%B0%83%E6%B3%A8%E5%86%8C%E6%B5%81%E7%A8%8B">4.3 回调注册流程</a></li>
<li><a href="#44-%E9%BB%98%E8%AE%A4%E4%BA%8B%E5%8A%A1%E6%B5%81%E7%A8%8B%E5%9B%BE">4.4 默认事务流程图</a></li>
</ul>
</li>
<li><a href="#%E4%BA%94%E5%AE%9E%E6%88%98%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B">五、实战代码示例</a><ul>
<li><a href="#51-%E5%9F%BA%E7%A1%80%E4%BA%8B%E5%8A%A1%E4%BD%BF%E7%94%A8">5.1 基础事务使用</a></li>
<li><a href="#52-%E5%B5%8C%E5%A5%97%E4%BA%8B%E5%8A%A1%E4%BD%BF%E7%94%A8">5.2 嵌套事务使用</a></li>
<li><a href="#53-%E6%89%8B%E5%8A%A8%E4%BA%8B%E5%8A%A1%E6%8E%A7%E5%88%B6">5.3 手动事务控制</a></li>
<li><a href="#54-%E4%BF%9D%E5%AD%98%E7%82%B9%E4%BD%BF%E7%94%A8">5.4 保存点使用</a></li>
<li><a href="#55-%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB%E9%85%8D%E7%BD%AE">5.5 隔离级别配置</a></li>
<li><a href="#56-%E5%A4%8D%E6%9D%82%E4%B8%9A%E5%8A%A1%E5%9C%BA%E6%99%AF">5.6 复杂业务场景</a></li>
</ul>
</li>
<li><a href="#%E5%85%AD%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E4%B8%8E%E6%95%85%E9%9A%9C%E6%8E%92%E6%9F%A5">六、最佳实践与故障排查</a><ul>
<li><a href="#61-%E9%85%8D%E7%BD%AE%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">6.1 配置最佳实践</a></li>
<li><a href="#62-%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E4%B8%8E%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88">6.2 常见问题与解决方案</a></li>
</ul>
</li>
<li><a href="#%E4%B8%83%E5%AD%A6%E4%B9%A0%E9%AA%8C%E8%AF%81">七、学习验证</a><ul>
<li><a href="#71-%E7%9F%A5%E8%AF%86%E8%87%AA%E6%B5%8B">7.1 知识自测</a></li>
<li><a href="#72-%E5%AE%9E%E8%B7%B5%E7%BB%83%E4%B9%A0">7.2 实践练习</a></li>
</ul>
</li>
</ul>
<hr>
<h2 id="一、设计原理"><a href="#一、设计原理" class="headerlink" title="一、设计原理"></a>一、设计原理</h2><h3 id="1-1-模块定位"><a href="#1-1-模块定位" class="headerlink" title="1.1 模块定位"></a>1.1 模块定位</h3><p><strong>在整体架构中的位置</strong></p>
<p>事务处理模块是 GORM 的数据一致性保障层，负责管理数据库事务的创建、提交和回滚。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│                   用户操作                                   │</span><br><span class="line">│  db.Transaction(func(tx *gorm.DB) error &#123;                   │</span><br><span class="line">│      // 多个数据库操作                                        │</span><br><span class="line">│      tx.Create(&amp;user)                                        │</span><br><span class="line">│      tx.Create(&amp;order)                                       │</span><br><span class="line">│      return nil                                              │</span><br><span class="line">│  &#125;)                                                         │</span><br><span class="line">└────────────────────────┬────────────────────────────────────┘</span><br><span class="line">                         │</span><br><span class="line">                         ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│              事务管理 (本模块) ★                              │</span><br><span class="line">│  ┌────────────────────────────────────────────────────┐     │</span><br><span class="line">│  │  Transaction() - 事务块执行                         │     │</span><br><span class="line">│  │  ├─ 检查连接池类型                                   │     │</span><br><span class="line">│  │  ├─ 创建事务 / 保存点 (嵌套)                          │     │</span><br><span class="line">│  │  ├─ 执行用户函数                                      │     │</span><br><span class="line">│  │  └─ 提交 / 回滚 (根据结果)                             │     │</span><br><span class="line">│  └────────────────────────────────────────────────────┘     │</span><br><span class="line">│                                                             │</span><br><span class="line">│  基础操作:                                                   │</span><br><span class="line">│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │</span><br><span class="line">│  │  Begin   │  │  Commit  │  │ Rollback │  │SavePoint │   │</span><br><span class="line">│  │ (开始)   │  │ (提交)   │  │ (回滚)   │  │ (保存点) │   │</span><br><span class="line">│  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │</span><br><span class="line">└────────────────────────┬────────────────────────────────────┘</span><br><span class="line">                         │</span><br><span class="line">                         ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│                   回调系统集成                               │</span><br><span class="line">│  ┌────────────────────────────────────────────────────┐     │</span><br><span class="line">│  │  BeginTransaction 回调 (create/update/delete)       │     │</span><br><span class="line">│  │  CommitOrRollbackTransaction 回调                   │     │</span><br><span class="line">│  └────────────────────────────────────────────────────┘     │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<p><strong>核心价值</strong></p>
<p>事务处理模块的核心价值在于：</p>
<ol>
<li><strong>数据一致性</strong>: 保证一组操作要么全部成功，要么全部失败</li>
<li><strong>原子性</strong>: 支持复杂业务逻辑的事务性操作</li>
<li><strong>嵌套支持</strong>: 通过保存点实现嵌套事务</li>
<li><strong>错误处理</strong>: 自动处理 panic 和错误，确保资源释放</li>
</ol>
<h3 id="1-2-设计目的"><a href="#1-2-设计目的" class="headerlink" title="1.2 设计目的"></a>1.2 设计目的</h3><p><strong>问题 1: 如何保证多个数据库操作的原子性？</strong></p>
<ul>
<li><strong>挑战</strong>: 多个操作需要作为一个整体执行</li>
<li><strong>挑战</strong>: 中途出错需要撤销所有已执行的操作</li>
<li><strong>挑战</strong>: 需要正确处理 panic 和错误</li>
</ul>
<p><strong>解决方案</strong>: 事务块 + 自动回滚机制</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 问题场景: 转账操作</span></span><br><span class="line"><span class="comment">// 1. 从 A 账户扣款</span></span><br><span class="line"><span class="comment">// 2. 向 B 账户加款</span></span><br><span class="line"><span class="comment">// 如果第 2 步失败，需要回滚第 1 步</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 不使用事务 (不安全)</span></span><br><span class="line">db.Exec(<span class="string">&quot;UPDATE accounts SET balance = balance - 100 WHERE id = ?&quot;</span>, accountA)</span><br><span class="line">db.Exec(<span class="string">&quot;UPDATE accounts SET balance = balance + 100 WHERE id = ?&quot;</span>, accountB)</span><br><span class="line"><span class="comment">// 如果第 2 条执行失败，A 的钱已经被扣除，但 B 没有收到</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用事务 (安全)</span></span><br><span class="line">db.Transaction(<span class="function"><span class="keyword">func</span><span class="params">(tx *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> err := tx.Exec(<span class="string">&quot;UPDATE accounts SET balance = balance - 100 WHERE id = ?&quot;</span>, accountA).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err  <span class="comment">// 自动回滚</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> err := tx.Exec(<span class="string">&quot;UPDATE accounts SET balance = balance + 100 WHERE id = ?&quot;</span>, accountB).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err  <span class="comment">// 自动回滚</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>  <span class="comment">// 自动提交</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><strong>问题 2: 如何支持嵌套事务？</strong></p>
<ul>
<li><strong>挑战</strong>: 数据库不一定支持真正的嵌套事务</li>
<li><strong>挑战</strong>: 需要在外层事务中建立”逻辑上的”嵌套</li>
<li><strong>挑战</strong>: 内层回滚不应影响外层事务</li>
</ul>
<p><strong>解决方案</strong>: 保存点 (SavePoint) 机制</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 嵌套事务实现原理</span></span><br><span class="line">db.Transaction(<span class="function"><span class="keyword">func</span><span class="params">(tx1 *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    <span class="comment">// 外层事务开始</span></span><br><span class="line">    tx1.Create(&amp;user)</span><br><span class="line"></span><br><span class="line">    tx1.Transaction(<span class="function"><span class="keyword">func</span><span class="params">(tx2 *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">        <span class="comment">// 内层事务实际上是保存点</span></span><br><span class="line">        <span class="comment">// SAVEPOINT sp12345</span></span><br><span class="line">        tx2.Create(&amp;order)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> someError &#123;</span><br><span class="line">            <span class="comment">// ROLLBACK TO sp12345</span></span><br><span class="line">            <span class="keyword">return</span> errors.New(<span class="string">&quot;inner error&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// RELEASE SAVEPOINT sp12345</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 外层事务继续</span></span><br><span class="line">    tx1.Create(&amp;log)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><strong>问题 3: 如何默认事务和显式事务的平衡？</strong></p>
<ul>
<li><strong>挑战</strong>: 每个操作都用事务会影响性能</li>
<li><strong>挑战</strong>: 不用事务无法保证一致性</li>
<li><strong>挑战</strong>: 需要灵活的配置选项</li>
</ul>
<p><strong>解决方案</strong>: 可配置的默认事务 + 显式事务 API</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 默认事务 (Create/Update/Delete 自动包装)</span></span><br><span class="line">db.Create(&amp;user)  <span class="comment">// 自动开启和提交事务</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 跳过默认事务 (性能优化)</span></span><br><span class="line">db.Session(&amp;gorm.Session&#123;SkipDefaultTransaction: <span class="literal">true</span>&#125;).Create(&amp;user)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 显式事务 (完全控制)</span></span><br><span class="line">db.Transaction(<span class="function"><span class="keyword">func</span><span class="params">(tx *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    <span class="comment">// 完全控制的事务</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="1-3-结构安排依据"><a href="#1-3-结构安排依据" class="headerlink" title="1.3 结构安排依据"></a>1.3 结构安排依据</h3><p><strong>3 天学习时间的科学分配</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Day 1: 事务基础 (核心概念)</span><br><span class="line">  目标: 理解事务的基本概念和使用</span><br><span class="line">  重点:</span><br><span class="line">    - ACID 特性</span><br><span class="line">    - Transaction API</span><br><span class="line">    - Begin/Commit/Rollback</span><br><span class="line"></span><br><span class="line">Day 2: 嵌套事务 (高级特性)</span><br><span class="line">  目标: 理解嵌套事务的实现</span><br><span class="line">  重点:</span><br><span class="line">    - 保存点机制</span><br><span class="line">    - 嵌套事务规则</span><br><span class="line">    - 错误传播</span><br><span class="line"></span><br><span class="line">Day 3: 实际应用 (最佳实践)</span><br><span class="line">  目标: 掌握事务的实际应用</span><br><span class="line">  重点:</span><br><span class="line">    - 业务场景分析</span><br><span class="line">    - 性能优化</span><br><span class="line">    - 错误处理</span><br></pre></td></tr></table></figure>

<p><strong>由浅入深的学习路径</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">第 1 层: 使用层 (如何使用)</span><br><span class="line">  ├─ Transaction 事务块</span><br><span class="line">  ├─ Begin/Commit/Rollback 手动控制</span><br><span class="line">  └─ SavePoint 保存点</span><br><span class="line"></span><br><span class="line">第 2 层: 机制层 (如何工作)</span><br><span class="line">  ├─ 事务如何开始</span><br><span class="line">  ├─ 嵌套如何实现</span><br><span class="line">  └─ 回滚如何触发</span><br><span class="line"></span><br><span class="line">第 3 层: 原理层 (为什么这样设计)</span><br><span class="line">  ├─ ACID 理论</span><br><span class="line">  ├─ 保存点原理</span><br><span class="line">  └─ 错误处理策略</span><br></pre></td></tr></table></figure>

<h3 id="1-4-与其他模块的逻辑关系"><a href="#1-4-与其他模块的逻辑关系" class="headerlink" title="1.4 与其他模块的逻辑关系"></a>1.4 与其他模块的逻辑关系</h3><p><strong>依赖关系</strong></p>
<ul>
<li><strong>依赖连接池</strong>: 需要支持事务的连接池</li>
<li><strong>依赖回调系统</strong>: 默认事务通过回调实现</li>
<li><strong>依赖查询构建</strong>: 事务内使用链式 API</li>
</ul>
<p><strong>支撑关系</strong></p>
<ul>
<li><strong>支撑所有写操作</strong>: Create&#x2F;Update&#x2F;Delete 的默认事务包装</li>
<li><strong>支撑数据一致性</strong>: 保证操作的原子性</li>
</ul>
<p><strong>模块交互图</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">事务模块 ↔ 其他模块:</span><br><span class="line"></span><br><span class="line">┌─────────────┐</span><br><span class="line">│  连接池     │  → 提供事务连接</span><br><span class="line">│ ConnPool    │    - TxBeginner 接口</span><br><span class="line">└──────┬──────┘    - TxCommitter 接口</span><br><span class="line">       │</span><br><span class="line">       ▼</span><br><span class="line">┌─────────────────────────────┐</span><br><span class="line">│      事务模块                │</span><br><span class="line">│  ┌───────────────────────┐  │</span><br><span class="line">│  │ Transaction()         │  │</span><br><span class="line">│  │ Begin/Commit/Rollback │  │</span><br><span class="line">│  │ SavePoint             │  │</span><br><span class="line">│  └───────────────────────┘  │</span><br><span class="line">└──────────┬──────────────────┘</span><br><span class="line">           │</span><br><span class="line">           ├─→ 回调系统 (默认事务)</span><br><span class="line">           ├─→ 查询构建 (事务内操作)</span><br><span class="line">           └─→ 错误处理 (回滚触发)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="二、核心原理"><a href="#二、核心原理" class="headerlink" title="二、核心原理"></a>二、核心原理</h2><h3 id="2-1-关键概念"><a href="#2-1-关键概念" class="headerlink" title="2.1 关键概念"></a>2.1 关键概念</h3><h4 id="概念-1-Transaction-结构"><a href="#概念-1-Transaction-结构" class="headerlink" title="概念 1: Transaction 结构"></a>概念 1: Transaction 结构</h4><p><strong>定义</strong>: Transaction 是事务的完整执行流程。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> Transaction(fc <span class="function"><span class="keyword">func</span><span class="params">(tx *DB)</span></span> <span class="type">error</span>, opts ...*sql.TxOptions) (err <span class="type">error</span>) &#123;</span><br><span class="line">    panicked := <span class="literal">true</span>  <span class="comment">// 标记是否发生 panic</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 检查连接池类型 ===</span></span><br><span class="line">    <span class="keyword">if</span> committer, ok := db.Statement.ConnPool.(TxCommitter); ok &#123;</span><br><span class="line">        <span class="comment">// === 嵌套事务处理 ===</span></span><br><span class="line">        <span class="keyword">if</span> !db.DisableNestedTransaction &#123;</span><br><span class="line">            spID := <span class="built_in">new</span>(maphash.Hash).Sum64()</span><br><span class="line">            err = db.SavePoint(fmt.Sprintf(<span class="string">&quot;sp%d&quot;</span>, spID)).Error</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">            <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">                <span class="keyword">if</span> panicked || err != <span class="literal">nil</span> &#123;</span><br><span class="line">                    db.RollbackTo(fmt.Sprintf(<span class="string">&quot;sp%d&quot;</span>, spID))</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 执行事务函数</span></span><br><span class="line">        err = fc(db.Session(&amp;Session&#123;NewDB: db.clone == <span class="number">1</span>&#125;))</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// === 新建事务处理 ===</span></span><br><span class="line">        tx := db.Begin(opts...)</span><br><span class="line">        <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">            <span class="keyword">if</span> panicked || err != <span class="literal">nil</span> &#123;</span><br><span class="line">                tx.Rollback()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;()</span><br><span class="line">        <span class="keyword">if</span> err = fc(tx); err == <span class="literal">nil</span> &#123;</span><br><span class="line">            panicked = <span class="literal">false</span></span><br><span class="line">            <span class="keyword">return</span> tx.Commit().Error</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    panicked = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行流程</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Transaction(fc, opts):</span><br><span class="line">    │</span><br><span class="line">    ├─► 1. 检查连接池类型</span><br><span class="line">    │       └─ db.Statement.ConnPool.(TxCommitter)</span><br><span class="line">    │           ├─ 是: 已在事务中 → 嵌套事务</span><br><span class="line">    │           └─ 否: 不在事务中 → 新建事务</span><br><span class="line">    │</span><br><span class="line">    ├─► 2a. 嵌套事务路径</span><br><span class="line">    │       ├─ 创建保存点 (SAVEPOINT spXXX)</span><br><span class="line">    │       ├─ 设置 defer 回滚到保存点</span><br><span class="line">    │       ├─ 执行用户函数 fc(db)</span><br><span class="line">    │       └─ 根据结果释放或回滚保存点</span><br><span class="line">    │</span><br><span class="line">    ├─► 2b. 新建事务路径</span><br><span class="line">    │       ├─ 开始事务 (BEGIN)</span><br><span class="line">    │       ├─ 设置 defer 回滚事务</span><br><span class="line">    │       ├─ 执行用户函数 fc(tx)</span><br><span class="line">    │       └─ 根据结果提交或回滚</span><br><span class="line">    │</span><br><span class="line">    └─► 3. 返回错误</span><br></pre></td></tr></table></figure>

<h4 id="概念-2-Begin-Commit-Rollback"><a href="#概念-2-Begin-Commit-Rollback" class="headerlink" title="概念 2: Begin&#x2F;Commit&#x2F;Rollback"></a>概念 2: Begin&#x2F;Commit&#x2F;Rollback</h4><p><strong>定义</strong>: 手动事务控制的三个核心方法。</p>
<p><strong>Begin 实现</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> Begin(opts ...*sql.TxOptions) *DB &#123;</span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        tx  = db.getInstance().Session(&amp;Session&#123;</span><br><span class="line">            Context: db.Statement.Context,</span><br><span class="line">            NewDB: db.clone == <span class="number">1</span>,</span><br><span class="line">        &#125;)</span><br><span class="line">        opt *sql.TxOptions</span><br><span class="line">        err <span class="type">error</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(opts) &gt; <span class="number">0</span> &#123;</span><br><span class="line">        opt = opts[<span class="number">0</span>]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ctx := tx.Statement.Context</span><br><span class="line">    <span class="keyword">if</span> db.DefaultTransactionTimeout &gt; <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> _, ok := ctx.Deadline(); !ok &#123;</span><br><span class="line">            ctx, _ = context.WithTimeout(ctx, db.DefaultTransactionTimeout)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用底层连接池的 BeginTx</span></span><br><span class="line">    <span class="keyword">switch</span> beginner := tx.Statement.ConnPool.(<span class="keyword">type</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> TxBeginner:</span><br><span class="line">        tx.Statement.ConnPool, err = beginner.BeginTx(ctx, opt)</span><br><span class="line">    <span class="keyword">case</span> ConnPoolBeginner:</span><br><span class="line">        tx.Statement.ConnPool, err = beginner.BeginTx(ctx, opt)</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        err = ErrInvalidTransaction</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        tx.AddError(err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> tx</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Commit 实现</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> Commit() *DB &#123;</span><br><span class="line">    <span class="keyword">if</span> committer, ok := db.Statement.ConnPool.(TxCommitter); ok &amp;&amp; committer != <span class="literal">nil</span> &#123;</span><br><span class="line">        db.AddError(committer.Commit())</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        db.AddError(ErrInvalidTransaction)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> db</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Rollback 实现</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> Rollback() *DB &#123;</span><br><span class="line">    <span class="keyword">if</span> committer, ok := db.Statement.ConnPool.(TxCommitter); ok &amp;&amp; committer != <span class="literal">nil</span> &#123;</span><br><span class="line">        db.AddError(committer.Rollback())</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        db.AddError(ErrInvalidTransaction)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> db</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>使用示例</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 方式 1: 自动事务 (推荐)</span></span><br><span class="line">err := db.Transaction(<span class="function"><span class="keyword">func</span><span class="params">(tx *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> err := tx.Create(&amp;user).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err  <span class="comment">// 自动回滚</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> err := tx.Create(&amp;order).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err  <span class="comment">// 自动回滚</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>  <span class="comment">// 自动提交</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方式 2: 手动控制</span></span><br><span class="line">tx := db.Begin()</span><br><span class="line"><span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> r := <span class="built_in">recover</span>(); r != <span class="literal">nil</span> &#123;</span><br><span class="line">        tx.Rollback()</span><br><span class="line">        <span class="built_in">panic</span>(r)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err := tx.Create(&amp;user).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">    tx.Rollback()</span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err := tx.Create(&amp;order).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">    tx.Rollback()</span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tx.Commit()  <span class="comment">// 提交</span></span><br></pre></td></tr></table></figure>

<h4 id="概念-3-保存点-SavePoint"><a href="#概念-3-保存点-SavePoint" class="headerlink" title="概念 3: 保存点 (SavePoint)"></a>概念 3: 保存点 (SavePoint)</h4><p><strong>定义</strong>: 保存点是事务中的标记点，可以回滚到该点而不影响整个事务。</p>
<p><strong>实现原理</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> SavePoint(name <span class="type">string</span>) *DB &#123;</span><br><span class="line">    <span class="comment">// 执行 SAVEPOINT SQL</span></span><br><span class="line">    db.Exec(<span class="string">&quot;SAVEPOINT ?&quot;</span>, name)</span><br><span class="line">    <span class="keyword">return</span> db</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> RollbackTo(name <span class="type">string</span>) *DB &#123;</span><br><span class="line">    <span class="comment">// 执行 ROLLBACK TO SAVEPOINT SQL</span></span><br><span class="line">    db.Exec(<span class="string">&quot;ROLLBACK TO SAVEPOINT ?&quot;</span>, name)</span><br><span class="line">    <span class="keyword">return</span> db</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>嵌套事务实现</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">外层事务:</span><br><span class="line">  BEGIN</span><br><span class="line">    ┌─────────────────────────────────┐</span><br><span class="line">    │ 内层事务 1                       │</span><br><span class="line">    │   SAVEPOINT sp1                 │</span><br><span class="line">    │   操作 A                        │</span><br><span class="line">    │   操作 B                        │</span><br><span class="line">    │   如果失败: ROLLBACK TO sp1     │</span><br><span class="line">    │   如果成功: RELEASE sp1         │</span><br><span class="line">    └─────────────────────────────────┘</span><br><span class="line">    ┌─────────────────────────────────┐</span><br><span class="line">    │ 内层事务 2                       │</span><br><span class="line">    │   SAVEPOINT sp2                 │</span><br><span class="line">    │   操作 C                        │</span><br><span class="line">    │   操作 D                        │</span><br><span class="line">    │   如果失败: ROLLBACK TO sp2     │</span><br><span class="line">    │   如果成功: RELEASE sp2         │</span><br><span class="line">    └─────────────────────────────────┘</span><br><span class="line">  COMMIT</span><br><span class="line"></span><br><span class="line">关键特性:</span><br><span class="line">- 内层失败不会导致外层回滚</span><br><span class="line">- 每个保存点独立</span><br><span class="line">- 可以部分回滚</span><br></pre></td></tr></table></figure>

<p><strong>代码示例</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">db.Transaction(<span class="function"><span class="keyword">func</span><span class="params">(tx1 *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    <span class="comment">// 外层事务开始</span></span><br><span class="line">    tx1.Create(&amp;User&#123;Name: <span class="string">&quot;Alice&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 内层事务 1</span></span><br><span class="line">    err := tx1.Transaction(<span class="function"><span class="keyword">func</span><span class="params">(tx2 *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">        tx2.Create(&amp;Order&#123;UserID: <span class="number">1</span>, Amount: <span class="number">100</span>&#125;)</span><br><span class="line">        <span class="keyword">if</span> someCondition &#123;</span><br><span class="line">            <span class="keyword">return</span> errors.New(<span class="string">&quot;rollback inner 1&quot;</span>)</span><br><span class="line">            <span class="comment">// 实际执行: ROLLBACK TO SAVEPOINT sp1</span></span><br><span class="line">            <span class="comment">// 结果: Order 不会保存，但 Alice 仍然存在</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 内层事务 2</span></span><br><span class="line">    err = tx1.Transaction(<span class="function"><span class="keyword">func</span><span class="params">(tx2 *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">        tx2.Create(&amp;Payment&#123;UserID: <span class="number">1</span>, Amount: <span class="number">100</span>&#125;)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="概念-4-默认事务机制"><a href="#概念-4-默认事务机制" class="headerlink" title="概念 4: 默认事务机制"></a>概念 4: 默认事务机制</h4><p><strong>定义</strong>: Create&#x2F;Update&#x2F;Delete 操作默认使用事务包装。</p>
<p><strong>回调实现</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// callbacks/transaction.go</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BeginTransaction</span><span class="params">(db *gorm.DB)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> !db.Config.SkipDefaultTransaction &amp;&amp; db.Error == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> tx := db.Begin(); tx.Error == <span class="literal">nil</span> &#123;</span><br><span class="line">            db.Statement.ConnPool = tx.Statement.ConnPool</span><br><span class="line">            db.InstanceSet(<span class="string">&quot;gorm:started_transaction&quot;</span>, <span class="literal">true</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> tx.Error == gorm.ErrInvalidTransaction &#123;</span><br><span class="line">            tx.Error = <span class="literal">nil</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            db.Error = tx.Error</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CommitOrRollbackTransaction</span><span class="params">(db *gorm.DB)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> !db.Config.SkipDefaultTransaction &#123;</span><br><span class="line">        <span class="keyword">if</span> _, ok := db.InstanceGet(<span class="string">&quot;gorm:started_transaction&quot;</span>); ok &#123;</span><br><span class="line">            <span class="keyword">if</span> db.Error != <span class="literal">nil</span> &#123;</span><br><span class="line">                db.Rollback()  <span class="comment">// 有错误，回滚</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                db.Commit()   <span class="comment">// 无错误，提交</span></span><br><span class="line">            &#125;</span><br><span class="line">            db.Statement.ConnPool = db.ConnPool</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>回调注册</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Create 操作的回调链</span></span><br><span class="line">db.Callback().Create().Before(<span class="string">&quot;gorm:create&quot;</span>).Register(<span class="string">&quot;gorm:begin_transaction&quot;</span>, BeginTransaction)</span><br><span class="line">db.Callback().Create().After(<span class="string">&quot;gorm:create&quot;</span>).Register(<span class="string">&quot;gorm:commit_or_rollback_transaction&quot;</span>, CommitOrRollbackTransaction)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Update 操作的回调链</span></span><br><span class="line">db.Callback().Update().Before(<span class="string">&quot;gorm:update&quot;</span>).Register(<span class="string">&quot;gorm:begin_transaction&quot;</span>, BeginTransaction)</span><br><span class="line">db.Callback().Update().After(<span class="string">&quot;gorm:update&quot;</span>).Register(<span class="string">&quot;gorm:commit_or_rollback_transaction&quot;</span>, CommitOrRollbackTransaction)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Delete 操作的回调链</span></span><br><span class="line">db.Callback().Delete().Before(<span class="string">&quot;gorm:delete&quot;</span>).Register(<span class="string">&quot;gorm:begin_transaction&quot;</span>, BeginTransaction)</span><br><span class="line">db.Callback().Delete().After(<span class="string">&quot;gorm:delete&quot;</span>).Register(<span class="string">&quot;gorm:commit_or_rollback_transaction&quot;</span>, CommitOrRollbackTransaction)</span><br></pre></td></tr></table></figure>

<p><strong>执行流程</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">Create(&amp;user) 执行流程:</span><br><span class="line">    │</span><br><span class="line">    ├─► 1. before:create 回调链</span><br><span class="line">    │       └─► BeginTransaction</span><br><span class="line">    │           ├─ 检查 SkipDefaultTransaction</span><br><span class="line">    │           ├─ 如果 false: BEGIN</span><br><span class="line">    │           └─ 设置 started_transaction 标记</span><br><span class="line">    │</span><br><span class="line">    ├─► 2. create 回调</span><br><span class="line">    │       └─► 执行 INSERT 操作</span><br><span class="line">    │           ├─ 成功: 继续</span><br><span class="line">    │           └─ 失败: 设置 db.Error</span><br><span class="line">    │</span><br><span class="line">    ├─► 3. after:create 回调链</span><br><span class="line">    │       └─► CommitOrRollbackTransaction</span><br><span class="line">    │           ├─ 检查 started_transaction 标记</span><br><span class="line">    │           ├─ 检查 db.Error</span><br><span class="line">    │           ├─ 有错误: ROLLBACK</span><br><span class="line">    │           └─ 无错误: COMMIT</span><br><span class="line">    │</span><br><span class="line">    └─► 4. 返回结果</span><br></pre></td></tr></table></figure>

<p><strong>跳过默认事务</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 方式 1: 全局配置</span></span><br><span class="line">db, err := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;</span><br><span class="line">    SkipDefaultTransaction: <span class="literal">true</span>,  <span class="comment">// 全局跳过</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方式 2: Session 配置</span></span><br><span class="line">db.Session(&amp;gorm.Session&#123;</span><br><span class="line">    SkipDefaultTransaction: <span class="literal">true</span>,</span><br><span class="line">&#125;).Create(&amp;user)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 适用场景:</span></span><br><span class="line"><span class="comment">// - 单条记录插入/更新</span></span><br><span class="line"><span class="comment">// - 不需要事务保证原子性</span></span><br><span class="line"><span class="comment">// - 性能敏感场景</span></span><br></pre></td></tr></table></figure>

<h4 id="概念-5-错误处理与-Panic-恢复"><a href="#概念-5-错误处理与-Panic-恢复" class="headerlink" title="概念 5: 错误处理与 Panic 恢复"></a>概念 5: 错误处理与 Panic 恢复</h4><p><strong>定义</strong>: Transaction 函数自动处理错误和 panic。</p>
<p><strong>错误处理机制</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> Transaction(fc <span class="function"><span class="keyword">func</span><span class="params">(tx *DB)</span></span> <span class="type">error</span>, opts ...*sql.TxOptions) (err <span class="type">error</span>) &#123;</span><br><span class="line">    panicked := <span class="literal">true</span>  <span class="comment">// 默认认为会 panic</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ... 事务创建逻辑 ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">// 捕获 panic 或错误</span></span><br><span class="line">        <span class="keyword">if</span> panicked || err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="comment">// 发生了 panic 或返回了错误</span></span><br><span class="line">            <span class="keyword">if</span> committer != <span class="literal">nil</span> &#123;</span><br><span class="line">                committer.Rollback()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行用户函数</span></span><br><span class="line">    err = fc(db.Session(&amp;Session&#123;NewDB: db.clone == <span class="number">1</span>&#125;))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果没有 panic，标记为成功</span></span><br><span class="line">    panicked = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Panic 恢复</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// panic 会被捕获并转换为错误</span></span><br><span class="line">db.Transaction(<span class="function"><span class="keyword">func</span><span class="params">(tx *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    tx.Create(&amp;user)</span><br><span class="line">    <span class="built_in">panic</span>(<span class="string">&quot;something went wrong!&quot;</span>)</span><br><span class="line">    <span class="comment">// 实际执行:</span></span><br><span class="line">    <span class="comment">// 1. 触发 panic</span></span><br><span class="line">    <span class="comment">// 2. defer 捕获 panicked = true</span></span><br><span class="line">    <span class="comment">// 3. 执行 Rollback</span></span><br><span class="line">    <span class="comment">// 4. 返回错误</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 结果: 事务回滚，程序不会崩溃</span></span><br></pre></td></tr></table></figure>

<p><strong>错误传播</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 内层错误会传播到外层</span></span><br><span class="line">db.Transaction(<span class="function"><span class="keyword">func</span><span class="params">(tx1 *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    tx1.Create(&amp;user)</span><br><span class="line"></span><br><span class="line">    err := tx1.Transaction(<span class="function"><span class="keyword">func</span><span class="params">(tx2 *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> errors.New(<span class="string">&quot;inner error&quot;</span>)</span><br><span class="line">        <span class="comment">// 内层保存点回滚</span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// err 不为 nil</span></span><br><span class="line">    <span class="comment">// 外层可以决定是否继续</span></span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err  <span class="comment">// 外层也回滚</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 结果: 所有操作都回滚</span></span><br></pre></td></tr></table></figure>

<h3 id="2-2-理论基础"><a href="#2-2-理论基础" class="headerlink" title="2.2 理论基础"></a>2.2 理论基础</h3><h4 id="理论-1-ACID-特性"><a href="#理论-1-ACID-特性" class="headerlink" title="理论 1: ACID 特性"></a>理论 1: ACID 特性</h4><p><strong>ACID 是事务的四个基本特性</strong>:</p>
<table>
<thead>
<tr>
<th>特性</th>
<th>全称</th>
<th>说明</th>
<th>GORM 实现</th>
</tr>
</thead>
<tbody><tr>
<td>Atomicity</td>
<td>原子性</td>
<td>事务中的操作要么全部成功，要么全部失败</td>
<td>通过 Transaction() + 自动回滚实现</td>
</tr>
<tr>
<td>Consistency</td>
<td>一致性</td>
<td>事务执行前后，数据库从一个一致状态变到另一个一致状态</td>
<td>通过事务保证</td>
</tr>
<tr>
<td>Isolation</td>
<td>隔离性</td>
<td>并发事务之间互不干扰</td>
<td>通过数据库的隔离级别实现</td>
</tr>
<tr>
<td>Durability</td>
<td>持久性</td>
<td>事务提交后，修改永久保存</td>
<td>通过数据库的持久化实现</td>
</tr>
</tbody></table>
<p><strong>原子性实现</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 原子性示例: 转账操作</span></span><br><span class="line">db.Transaction(<span class="function"><span class="keyword">func</span><span class="params">(tx *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    <span class="comment">// 1. 查询账户 A</span></span><br><span class="line">    <span class="keyword">var</span> accountA Account</span><br><span class="line">    <span class="keyword">if</span> err := tx.First(&amp;accountA, <span class="number">1</span>).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 查询账户 B</span></span><br><span class="line">    <span class="keyword">var</span> accountB Account</span><br><span class="line">    <span class="keyword">if</span> err := tx.First(&amp;accountB, <span class="number">2</span>).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 扣除 A 的余额</span></span><br><span class="line">    accountA.Balance -= <span class="number">100</span></span><br><span class="line">    <span class="keyword">if</span> err := tx.Save(&amp;accountA).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err  <span class="comment">// 回滚</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. 增加 B 的余额</span></span><br><span class="line">    accountB.Balance += <span class="number">100</span></span><br><span class="line">    <span class="keyword">if</span> err := tx.Save(&amp;accountB).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err  <span class="comment">// 回滚</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5. 记录交易日志</span></span><br><span class="line">    log := TransactionLog&#123;</span><br><span class="line">        FromAccountID: <span class="number">1</span>,</span><br><span class="line">        ToAccountID:   <span class="number">2</span>,</span><br><span class="line">        Amount:        <span class="number">100</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> err := tx.Create(&amp;log).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err  <span class="comment">// 回滚</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>  <span class="comment">// 提交</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 任何一步失败，所有操作都会回滚</span></span><br></pre></td></tr></table></figure>

<h4 id="理论-2-保存点原理"><a href="#理论-2-保存点原理" class="headerlink" title="理论 2: 保存点原理"></a>理论 2: 保存点原理</h4><p><strong>保存点的作用</strong>:</p>
<ol>
<li><strong>部分回滚</strong>: 允许回滚到事务中的某个点</li>
<li><strong>嵌套事务</strong>: 模拟嵌套事务行为</li>
<li><strong>错误恢复</strong>: 在不放弃整个事务的情况下恢复错误</li>
</ol>
<p><strong>SQL 实现</strong>:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建保存点</span></span><br><span class="line"><span class="keyword">SAVEPOINT</span> sp1;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 回滚到保存点</span></span><br><span class="line"><span class="keyword">ROLLBACK</span> <span class="keyword">TO</span> <span class="keyword">SAVEPOINT</span> sp1;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 释放保存点</span></span><br><span class="line"><span class="keyword">RELEASE</span> <span class="keyword">SAVEPOINT</span> sp1;</span><br></pre></td></tr></table></figure>

<p><strong>GORM 封装</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建保存点</span></span><br><span class="line">db.SavePoint(<span class="string">&quot;my_savepoint&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 回滚到保存点</span></span><br><span class="line">db.RollbackTo(<span class="string">&quot;my_savepoint&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 自动生成的保存点名称</span></span><br><span class="line">spID := <span class="built_in">new</span>(maphash.Hash).Sum64()</span><br><span class="line">savePointName := fmt.Sprintf(<span class="string">&quot;sp%d&quot;</span>, spID)</span><br></pre></td></tr></table></figure>

<p><strong>嵌套层级</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">事务开始</span><br><span class="line">  │</span><br><span class="line">  ├─ 保存点 1 (sp1)</span><br><span class="line">  │   ├─ 操作 A</span><br><span class="line">  │   ├─ 保存点 2 (sp2)</span><br><span class="line">  │   │   ├─ 操作 B</span><br><span class="line">  │   │   ├─ 操作 C</span><br><span class="line">  │   │   └─ 回滚到 sp2  ← B 和 C 被撤销</span><br><span class="line">  │   ├─ 操作 D</span><br><span class="line">  │   └─ 回滚到 sp1      ← A、B、C、D 都被撤销</span><br><span class="line">  │</span><br><span class="line">  └─ 提交</span><br></pre></td></tr></table></figure>

<h4 id="理论-3-隔离级别"><a href="#理论-3-隔离级别" class="headerlink" title="理论 3: 隔离级别"></a>理论 3: 隔离级别</h4><p><strong>数据库隔离级别</strong>:</p>
<table>
<thead>
<tr>
<th>级别</th>
<th>脏读</th>
<th>不可重复读</th>
<th>幻读</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Read Uncommitted</td>
<td>可能</td>
<td>可能</td>
<td>可能</td>
<td>最低隔离，性能最好</td>
</tr>
<tr>
<td>Read Committed</td>
<td>不可能</td>
<td>可能</td>
<td>可能</td>
<td>大多数数据库的默认级别</td>
</tr>
<tr>
<td>Repeatable Read</td>
<td>不可能</td>
<td>不可能</td>
<td>可能</td>
<td>MySQL 的默认级别</td>
</tr>
<tr>
<td>Serializable</td>
<td>不可能</td>
<td>不可能</td>
<td>不可能</td>
<td>最高隔离，性能最差</td>
</tr>
</tbody></table>
<p><strong>设置隔离级别</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 方式 1: 通过 TxOptions</span></span><br><span class="line">db.Transaction(<span class="function"><span class="keyword">func</span><span class="params">(tx *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    <span class="comment">// 使用 Read Committed 隔离级别</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;, &amp;sql.TxOptions&#123;</span><br><span class="line">    Isolation: sql.LevelReadCommitted,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方式 2: 原始 SQL</span></span><br><span class="line">db.Exec(<span class="string">&quot;SET TRANSACTION ISOLATION LEVEL READ COMMITTED&quot;</span>)</span><br><span class="line">db.Transaction(<span class="function"><span class="keyword">func</span><span class="params">(tx *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><strong>隔离级别选择</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Read Uncommitted:</span><br><span class="line">  - 几乎不使用</span><br><span class="line">  - 用于性能要求极高，数据准确性要求低的场景</span><br><span class="line"></span><br><span class="line">Read Committed (推荐):</span><br><span class="line">  - 大多数场景的最佳选择</span><br><span class="line">  - 平衡了性能和一致性</span><br><span class="line">  - 避免脏读</span><br><span class="line"></span><br><span class="line">Repeatable Read:</span><br><span class="line">  - 需要事务内多次读取一致数据的场景</span><br><span class="line">  - 统计查询、报表生成</span><br><span class="line">  - MySQL 默认级别</span><br><span class="line"></span><br><span class="line">Serializable:</span><br><span class="line">  - 高并发写操作且不能有任何不一致</span><br><span class="line">  - 性能开销大</span><br><span class="line">  - 仅在必要时使用</span><br></pre></td></tr></table></figure>

<h3 id="2-3-学习方法"><a href="#2-3-学习方法" class="headerlink" title="2.3 学习方法"></a>2.3 学习方法</h3><h4 id="方法-1-实验法"><a href="#方法-1-实验法" class="headerlink" title="方法 1: 实验法"></a>方法 1: 实验法</h4><p><strong>实验 1: 测试原子性</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 测试: 事务的原子性</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestAtomicity</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">    db.Transaction(<span class="function"><span class="keyword">func</span><span class="params">(tx *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">        <span class="comment">// 创建用户</span></span><br><span class="line">        user := User&#123;Name: <span class="string">&quot;Alice&quot;</span>&#125;</span><br><span class="line">        <span class="keyword">if</span> err := tx.Create(&amp;user).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建订单</span></span><br><span class="line">        order := Order&#123;UserID: user.ID, Amount: <span class="number">100</span>&#125;</span><br><span class="line">        <span class="keyword">if</span> err := tx.Create(&amp;order).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> err  <span class="comment">// 用户也会被回滚</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 触发错误</span></span><br><span class="line">        <span class="keyword">return</span> errors.New(<span class="string">&quot;intentional error&quot;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 验证: 用户和订单都不存在</span></span><br><span class="line">    <span class="keyword">var</span> count <span class="type">int64</span></span><br><span class="line">    db.Model(&amp;User&#123;&#125;).Where(<span class="string">&quot;name = ?&quot;</span>, <span class="string">&quot;Alice&quot;</span>).Count(&amp;count)</span><br><span class="line">    assert.Equal(t, <span class="type">int64</span>(<span class="number">0</span>), count)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>实验 2: 测试嵌套事务</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 测试: 嵌套事务行为</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestNestedTransaction</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> outerSuccess, innerSuccess <span class="type">bool</span></span><br><span class="line"></span><br><span class="line">    db.Transaction(<span class="function"><span class="keyword">func</span><span class="params">(tx1 *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">        tx1.Create(&amp;User&#123;Name: <span class="string">&quot;Bob&quot;</span>&#125;)</span><br><span class="line">        outerSuccess = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">        tx1.Transaction(<span class="function"><span class="keyword">func</span><span class="params">(tx2 *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">            tx2.Create(&amp;Order&#123;UserID: <span class="number">1</span>, Amount: <span class="number">200</span>&#125;)</span><br><span class="line">            innerSuccess = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 内层回滚</span></span><br><span class="line">            <span class="keyword">return</span> errors.New(<span class="string">&quot;inner error&quot;</span>)</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 外层继续</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 结果: Bob 存在，但订单不存在</span></span><br><span class="line">    <span class="keyword">var</span> user User</span><br><span class="line">    <span class="keyword">var</span> order Order</span><br><span class="line"></span><br><span class="line">    err1 := db.First(&amp;user, <span class="string">&quot;name = ?&quot;</span>, <span class="string">&quot;Bob&quot;</span>).Error</span><br><span class="line">    err2 := db.First(&amp;order).Error</span><br><span class="line"></span><br><span class="line">    assert.Nil(t, err1)   <span class="comment">// 用户存在</span></span><br><span class="line">    assert.Error(t, err2)  <span class="comment">// 订单不存在</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="方法-2-对比法"><a href="#方法-2-对比法" class="headerlink" title="方法 2: 对比法"></a>方法 2: 对比法</h4><p><strong>对比手动和自动事务</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 手动控制</span></span><br><span class="line">tx := db.Begin()</span><br><span class="line"><span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> r := <span class="built_in">recover</span>(); r != <span class="literal">nil</span> &#123;</span><br><span class="line">        tx.Rollback()</span><br><span class="line">        <span class="built_in">panic</span>(r)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err := tx.Create(&amp;user).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">    tx.Rollback()</span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err := tx.Create(&amp;order).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">    tx.Rollback()</span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tx.Commit()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 自动控制</span></span><br><span class="line">db.Transaction(<span class="function"><span class="keyword">func</span><span class="params">(tx *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> err := tx.Create(&amp;user).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> err := tx.Create(&amp;order).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 对比:</span></span><br><span class="line"><span class="comment">// - 手动: 需要显式处理每个错误和回滚</span></span><br><span class="line"><span class="comment">// - 自动: 简洁，自动处理错误和回滚</span></span><br></pre></td></tr></table></figure>

<h4 id="方法-3-场景法"><a href="#方法-3-场景法" class="headerlink" title="方法 3: 场景法"></a>方法 3: 场景法</h4><p><strong>场景 1: 转账</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Transfer</span><span class="params">(fromID, toID <span class="type">uint</span>, amount <span class="type">float64</span>)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> db.Transaction(<span class="function"><span class="keyword">func</span><span class="params">(tx *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 锁定转出账户</span></span><br><span class="line">        <span class="keyword">var</span> from Account</span><br><span class="line">        <span class="keyword">if</span> err := tx.Clauses(clause.Locking&#123;Strength: <span class="string">&quot;UPDATE&quot;</span>&#125;).</span><br><span class="line">            First(&amp;from, fromID).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 检查余额</span></span><br><span class="line">        <span class="keyword">if</span> from.Balance &lt; amount &#123;</span><br><span class="line">            <span class="keyword">return</span> errors.New(<span class="string">&quot;insufficient balance&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 锁定转入账户</span></span><br><span class="line">        <span class="keyword">var</span> to Account</span><br><span class="line">        <span class="keyword">if</span> err := tx.Clauses(clause.Locking&#123;Strength: <span class="string">&quot;UPDATE&quot;</span>&#125;).</span><br><span class="line">            First(&amp;to, toID).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. 执行转账</span></span><br><span class="line">        from.Balance -= amount</span><br><span class="line">        to.Balance += amount</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> err := tx.Save(&amp;from).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> err := tx.Save(&amp;to).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. 记录日志</span></span><br><span class="line">        <span class="keyword">return</span> tx.Create(&amp;TransactionLog&#123;</span><br><span class="line">            FromAccountID: fromID,</span><br><span class="line">            ToAccountID:   toID,</span><br><span class="line">            Amount:        amount,</span><br><span class="line">        &#125;).Error</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>场景 2: 订单创建</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CreateOrder</span><span class="params">(order Order, items []OrderItem)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> db.Transaction(<span class="function"><span class="keyword">func</span><span class="params">(tx *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 创建订单</span></span><br><span class="line">        <span class="keyword">if</span> err := tx.Create(&amp;order).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 创建订单项</span></span><br><span class="line">        <span class="keyword">for</span> _, item := <span class="keyword">range</span> items &#123;</span><br><span class="line">            item.OrderID = order.ID</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3. 扣减库存</span></span><br><span class="line">            <span class="keyword">var</span> product Product</span><br><span class="line">            <span class="keyword">if</span> err := tx.First(&amp;product, item.ProductID).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> err</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> product.Stock &lt; item.Quantity &#123;</span><br><span class="line">                <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;insufficient stock for product %d&quot;</span>, item.ProductID)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            product.Stock -= item.Quantity</span><br><span class="line">            <span class="keyword">if</span> err := tx.Save(&amp;product).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> err</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 4. 创建订单项</span></span><br><span class="line">            <span class="keyword">if</span> err := tx.Create(&amp;item).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> err</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-4-实施策略"><a href="#2-4-实施策略" class="headerlink" title="2.4 实施策略"></a>2.4 实施策略</h3><h4 id="策略-1-分层学习"><a href="#策略-1-分层学习" class="headerlink" title="策略 1: 分层学习"></a>策略 1: 分层学习</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">第 1 层: 理解基础概念 (Day 1)</span><br><span class="line">  目标: 理解事务的基本概念</span><br><span class="line">  内容:</span><br><span class="line">    - ACID 特性</span><br><span class="line">    - Transaction API</span><br><span class="line">    - Begin/Commit/Rollback</span><br><span class="line">  验证:</span><br><span class="line">    - 能解释 ACID</span><br><span class="line">    - 能使用 Transaction</span><br><span class="line">    - 能手动控制事务</span><br><span class="line"></span><br><span class="line">第 2 层: 掌握嵌套事务 (Day 2)</span><br><span class="line">  目标: 理解嵌套事务的实现</span><br><span class="line">  内容:</span><br><span class="line">    - 保存点机制</span><br><span class="line">    - 嵌套事务规则</span><br><span class="line">    - 错误传播</span><br><span class="line">  验证:</span><br><span class="line">    - 能使用嵌套事务</span><br><span class="line">    - 能理解保存点</span><br><span class="line">    - 能处理错误传播</span><br><span class="line"></span><br><span class="line">第 3 层: 应用最佳实践 (Day 3)</span><br><span class="line">  目标: 掌握实际应用</span><br><span class="line">  内容:</span><br><span class="line">    - 业务场景分析</span><br><span class="line">    - 性能优化</span><br><span class="line">    - 错误处理</span><br><span class="line">  验证:</span><br><span class="line">    - 能设计业务事务</span><br><span class="line">    - 能优化性能</span><br><span class="line">    - 能处理错误</span><br></pre></td></tr></table></figure>

<h4 id="策略-2-问题驱动"><a href="#策略-2-问题驱动" class="headerlink" title="策略 2: 问题驱动"></a>策略 2: 问题驱动</h4><p><strong>问题序列</strong>:</p>
<ol>
<li><p><strong>为什么需要事务？</strong></p>
<ul>
<li>尝试不用事务的转账</li>
<li>观察数据不一致问题</li>
<li>理解事务的价值</li>
</ul>
</li>
<li><p><strong>嵌套事务如何工作？</strong></p>
<ul>
<li>测试嵌套事务行为</li>
<li>观察保存点 SQL</li>
<li>理解回滚范围</li>
</ul>
</li>
<li><p><strong>如何优化事务性能？</strong></p>
<ul>
<li>测试不同隔离级别</li>
<li>跳过默认事务</li>
<li>减小事务范围</li>
</ul>
</li>
<li><p><strong>如何处理错误？</strong></p>
<ul>
<li>测试不同错误场景</li>
<li>理解 panic 恢复</li>
<li>设计错误处理策略</li>
</ul>
</li>
</ol>
<h4 id="策略-3-验证反馈"><a href="#策略-3-验证反馈" class="headerlink" title="策略 3: 验证反馈"></a>策略 3: 验证反馈</h4><p><strong>验证点 1: 原子性验证</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 测试: 事务原子性</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestTransactionAtomicity</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">    <span class="comment">// 不使用事务</span></span><br><span class="line">    db.Create(&amp;User&#123;Name: <span class="string">&quot;Alice&quot;</span>&#125;)</span><br><span class="line">    db.Create(&amp;Order&#123;UserID: <span class="number">999</span>&#125;)  <span class="comment">// 不存在的用户</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用事务</span></span><br><span class="line">    err := db.Transaction(<span class="function"><span class="keyword">func</span><span class="params">(tx *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">        tx.Create(&amp;User&#123;Name: <span class="string">&quot;Bob&quot;</span>&#125;)</span><br><span class="line">        tx.Create(&amp;Order&#123;UserID: <span class="number">888</span>&#125;)  <span class="comment">// 不存在的用户</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>  <span class="comment">// 即使外键约束失败，也会执行到这里</span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 验证: Bob 不存在（事务回滚）</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>验证点 2: 隔离性验证</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 测试: 事务隔离性</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestTransactionIsolation</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">    done := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">bool</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 事务 1</span></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        db.Transaction(<span class="function"><span class="keyword">func</span><span class="params">(tx1 *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">            <span class="keyword">var</span> user User</span><br><span class="line">            tx1.First(&amp;user, <span class="number">1</span>)</span><br><span class="line">            time.Sleep(<span class="number">100</span> * time.Millisecond)</span><br><span class="line">            user.Name = <span class="string">&quot;Updated by Tx1&quot;</span></span><br><span class="line">            <span class="keyword">return</span> tx1.Save(&amp;user).Error</span><br><span class="line">        &#125;)</span><br><span class="line">        done &lt;- <span class="literal">true</span></span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 事务 2</span></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        time.Sleep(<span class="number">50</span> * time.Millisecond)</span><br><span class="line">        db.Transaction(<span class="function"><span class="keyword">func</span><span class="params">(tx2 *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">            <span class="keyword">var</span> user User</span><br><span class="line">            tx2.First(&amp;user, <span class="number">1</span>)</span><br><span class="line">            user.Name = <span class="string">&quot;Updated by Tx2&quot;</span></span><br><span class="line">            <span class="keyword">return</span> tx2.Save(&amp;user).Error</span><br><span class="line">        &#125;)</span><br><span class="line">        done &lt;- <span class="literal">true</span></span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    &lt;-done</span><br><span class="line">    &lt;-done</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 验证最终结果</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="二、核心数据结构"><a href="#二、核心数据结构" class="headerlink" title="二、核心数据结构"></a>二、核心数据结构</h2><h3 id="2-1-事务相关接口"><a href="#2-1-事务相关接口" class="headerlink" title="2.1 事务相关接口"></a>2.1 事务相关接口</h3><p><strong>源码位置</strong>: <code>interfaces.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ConnPool 数据库连接池基础接口</span></span><br><span class="line"><span class="keyword">type</span> ConnPool <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// TxBeginner 可开始事务的连接池接口</span></span><br><span class="line"><span class="keyword">type</span> TxBeginner <span class="keyword">interface</span> &#123;</span><br><span class="line">    BeginTx(ctx context.Context, opts *sql.TxOptions) (*sql.Tx, <span class="type">error</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ConnPoolBeginner 扩展的连接池接口，包含 BeginTx 方法</span></span><br><span class="line"><span class="keyword">type</span> ConnPoolBeginner <span class="keyword">interface</span> &#123;</span><br><span class="line">    BeginTx(ctx context.Context, opts *sql.TxOptions) (ConnPool, <span class="type">error</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// TxCommitter 可提交或回滚事务的接口</span></span><br><span class="line"><span class="keyword">type</span> TxCommitter <span class="keyword">interface</span> &#123;</span><br><span class="line">    Commit() <span class="type">error</span></span><br><span class="line">    Rollback() <span class="type">error</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>接口关系图</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">                  ┌──────────────────┐</span><br><span class="line">                  │    ConnPool      │</span><br><span class="line">                  │  (基础连接池)      │</span><br><span class="line">                  └────────┬─────────┘</span><br><span class="line">                           │</span><br><span class="line">       ┌───────────────────┼───────────────────┐</span><br><span class="line">       │                   │                   │</span><br><span class="line">       ▼                   ▼                   ▼</span><br><span class="line">┌──────────────┐   ┌──────────────┐   ┌──────────────┐</span><br><span class="line">│ TxBeginner   │   │ConnPoolBegin │   │TxCommitter   │</span><br><span class="line">│ BeginTx()    │   │BeginTx()     │   │Commit()      │</span><br><span class="line">│ → *sql.Tx    │   │ → ConnPool   │   │Rollback()    │</span><br><span class="line">└──────────────┘   └──────────────┘   └──────────────┘</span><br><span class="line">       │                   │                   │</span><br><span class="line">       └───────────────────┼───────────────────┘</span><br><span class="line">                           │</span><br><span class="line">                           ▼</span><br><span class="line">                  ┌──────────────────┐</span><br><span class="line">                  │       Tx          │</span><br><span class="line">                  │  (完整事务接口)    │</span><br><span class="line">                  │  ConnPool +       │</span><br><span class="line">                  │  TxCommitter +    │</span><br><span class="line">                  │  StmtContext      │</span><br><span class="line">                  └──────────────────┘</span><br></pre></td></tr></table></figure>

<p><strong>接口说明</strong>:</p>
<table>
<thead>
<tr>
<th>接口</th>
<th>方法</th>
<th>说明</th>
<th>返回值</th>
</tr>
</thead>
<tbody><tr>
<td>TxBeginner</td>
<td>BeginTx</td>
<td>开始事务</td>
<td><code>*sql.Tx</code></td>
</tr>
<tr>
<td>ConnPoolBeginner</td>
<td>BeginTx</td>
<td>开始事务（扩展版）</td>
<td><code>ConnPool</code></td>
</tr>
<tr>
<td>TxCommitter</td>
<td>Commit</td>
<td>提交事务</td>
<td><code>error</code></td>
</tr>
<tr>
<td>TxCommitter</td>
<td>Rollback</td>
<td>回滚事务</td>
<td><code>error</code></td>
</tr>
</tbody></table>
<h3 id="2-2-TxOptions-配置"><a href="#2-2-TxOptions-配置" class="headerlink" title="2.2 TxOptions 配置"></a>2.2 TxOptions 配置</h3><p><strong>源码位置</strong>: <code>database/sql</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// TxOptions 事务配置选项</span></span><br><span class="line"><span class="keyword">type</span> TxOptions <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// Isolation 隔离级别</span></span><br><span class="line">    Isolation IsolationLevel</span><br><span class="line">    <span class="comment">// ReadOnly 只读事务</span></span><br><span class="line">    ReadOnly <span class="type">bool</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// IsolationLevel 隔离级别类型</span></span><br><span class="line"><span class="keyword">type</span> IsolationLevel <span class="type">int</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    LevelDefault IsolationLevel = <span class="literal">iota</span> <span class="comment">// 数据库默认级别</span></span><br><span class="line">    LevelReadUncommitted               <span class="comment">// 读未提交</span></span><br><span class="line">    LevelReadCommitted                 <span class="comment">// 读已提交</span></span><br><span class="line">    LevelWriteCommitted                <span class="comment">// 写已提交</span></span><br><span class="line">    LevelRepeatableRead                <span class="comment">// 可重复读</span></span><br><span class="line">    LevelSnapshot                      <span class="comment">// 快照隔离</span></span><br><span class="line">    LevelSerializable                  <span class="comment">// 串行化</span></span><br><span class="line">    LevelLinearizable                  <span class="comment">// 线性化</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><strong>使用示例</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置隔离级别为 Read Committed</span></span><br><span class="line">db.Transaction(<span class="function"><span class="keyword">func</span><span class="params">(tx *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    <span class="comment">// 事务操作</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;, &amp;sql.TxOptions&#123;</span><br><span class="line">    Isolation: sql.LevelReadCommitted,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置只读事务</span></span><br><span class="line">db.Transaction(<span class="function"><span class="keyword">func</span><span class="params">(tx *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    <span class="comment">// 只读操作</span></span><br><span class="line">    <span class="keyword">var</span> users []User</span><br><span class="line">    <span class="keyword">return</span> tx.Find(&amp;users).Error</span><br><span class="line">&#125;, &amp;sql.TxOptions&#123;</span><br><span class="line">    ReadOnly: <span class="literal">true</span>,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="三、事务核心实现"><a href="#三、事务核心实现" class="headerlink" title="三、事务核心实现"></a>三、事务核心实现</h2><h3 id="3-1-Transaction-函数完整实现"><a href="#3-1-Transaction-函数完整实现" class="headerlink" title="3.1 Transaction 函数完整实现"></a>3.1 Transaction 函数完整实现</h3><p><strong>源码位置</strong>: <code>finisher_api.go:632-678</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Transaction 以事务块的方式启动事务，返回错误时回滚，否则提交。</span></span><br><span class="line"><span class="comment">// Transaction 在事务内执行任意数量的命令。成功时提交更改；如果发生错误则回滚。</span></span><br><span class="line"><span class="comment">// fc: 事务函数，执行业务逻辑</span></span><br><span class="line"><span class="comment">// opts: 事务选项（隔离级别、只读等）</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> Transaction(fc <span class="function"><span class="keyword">func</span><span class="params">(tx *DB)</span></span> <span class="type">error</span>, opts ...*sql.TxOptions) (err <span class="type">error</span>) &#123;</span><br><span class="line">    panicked := <span class="literal">true</span> <span class="comment">// 标记是否发生了panic，默认为true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 第 1 步: 检查连接池类型 ===</span></span><br><span class="line">    <span class="keyword">if</span> committer, ok := db.Statement.ConnPool.(TxCommitter); ok &amp;&amp; committer != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="comment">// === 嵌套事务路径 ===</span></span><br><span class="line">        <span class="keyword">if</span> !db.DisableNestedTransaction &#123;</span><br><span class="line">            <span class="comment">// 生成唯一的保存点ID（使用hash确保唯一性）</span></span><br><span class="line">            spID := <span class="built_in">new</span>(maphash.Hash).Sum64()</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 创建保存点（相当于嵌套事务的开始）</span></span><br><span class="line">            err = db.SavePoint(fmt.Sprintf(<span class="string">&quot;sp%d&quot;</span>, spID)).Error</span><br><span class="line">            <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">return</span>  <span class="comment">// 保存点创建失败，直接返回</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 设置defer：确保在异常时回滚到保存点</span></span><br><span class="line">            <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">                <span class="comment">// 发生panic、返回错误或提交错误时回滚到保存点</span></span><br><span class="line">                <span class="keyword">if</span> panicked || err != <span class="literal">nil</span> &#123;</span><br><span class="line">                    db.RollbackTo(fmt.Sprintf(<span class="string">&quot;sp%d&quot;</span>, spID))</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;()</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 执行事务函数（嵌套事务中不创建新事务，直接使用现有连接）</span></span><br><span class="line">        err = fc(db.Session(&amp;Session&#123;NewDB: db.clone == <span class="number">1</span>&#125;))</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// === 新建事务路径 ===</span></span><br><span class="line">        <span class="comment">// 调用 Begin() 开始一个新事务</span></span><br><span class="line">        tx := db.Begin(opts...)</span><br><span class="line">        <span class="keyword">if</span> tx.Error != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> tx.Error  <span class="comment">// Begin 失败，直接返回错误</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置defer：确保在异常时回滚事务</span></span><br><span class="line">        <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">            <span class="comment">// 发生panic、返回错误或提交错误时回滚事务</span></span><br><span class="line">            <span class="keyword">if</span> panicked || err != <span class="literal">nil</span> &#123;</span><br><span class="line">                tx.Rollback()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;()</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 执行事务函数</span></span><br><span class="line">        <span class="keyword">if</span> err = fc(tx); err == <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="comment">// 如果执行成功，标记没有panic</span></span><br><span class="line">            panicked = <span class="literal">false</span></span><br><span class="line">            <span class="comment">// 提交事务</span></span><br><span class="line">            <span class="keyword">return</span> tx.Commit().Error</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果执行到这里，说明没有panic</span></span><br><span class="line">    panicked = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行流程图</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">Transaction(fc, opts):</span><br><span class="line">    │</span><br><span class="line">    ├─► 1. 检查连接池类型</span><br><span class="line">    │   db.Statement.ConnPool.(TxCommitter)</span><br><span class="line">    │   │</span><br><span class="line">    │   ├─ 是 TxCommitter?</span><br><span class="line">    │   │   │</span><br><span class="line">    │   │   ├─ YES → 已在事务中</span><br><span class="line">    │   │   │   │</span><br><span class="line">    │   │   │   ├─ DisableNestedTransaction?</span><br><span class="line">    │   │   │   │   │</span><br><span class="line">    │   │   │   │   ├─ NO → 创建保存点</span><br><span class="line">    │   │   │   │   │   ├─ SavePoint(fmt.Sprintf(&quot;sp%d&quot;, spID))</span><br><span class="line">    │   │   │   │   │   └─ defer RollbackTo(spX) if panic/err</span><br><span class="line">    │   │   │   │   │</span><br><span class="line">    │   │   │   │   └─ 执行 fc(db)</span><br><span class="line">    │   │   │   │       └─ 返回错误</span><br><span class="line">    │   │   │   │</span><br><span class="line">    │   │   │   └─ YES → 不创建保存点</span><br><span class="line">    │   │   │       └─ 直接执行 fc(db)</span><br><span class="line">    │   │   │</span><br><span class="line">    │   │   └─ NO → 不在事务中</span><br><span class="line">    │   │       │</span><br><span class="line">    │   │       └─ 开始新事务</span><br><span class="line">    │   │           ├─ Begin(opts...)</span><br><span class="line">    │   │           ├─ defer Rollback() if panic/err</span><br><span class="line">    │   │           ├─ 执行 fc(tx)</span><br><span class="line">    │   │           │   └─ if err == nil: Commit()</span><br><span class="line">    │   │           └─ 返回错误</span><br><span class="line">    │   │</span><br><span class="line">    │   └─ panicked = false</span><br><span class="line">    │</span><br><span class="line">    └─► 2. 返回错误</span><br></pre></td></tr></table></figure>

<h3 id="3-2-Begin-函数完整实现"><a href="#3-2-Begin-函数完整实现" class="headerlink" title="3.2 Begin 函数完整实现"></a>3.2 Begin 函数完整实现</h3><p><strong>源码位置</strong>: <code>finisher_api.go:681-714</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Begin 开始一个新事务，支持事务选项</span></span><br><span class="line"><span class="comment">// opts: 事务选项（隔离级别、只读等）</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> Begin(opts ...*sql.TxOptions) *DB &#123;</span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        <span class="comment">// 创建新的DB实例，配置Session</span></span><br><span class="line">        tx  = db.getInstance().Session(&amp;Session&#123;</span><br><span class="line">            Context: db.Statement.Context,</span><br><span class="line">            NewDB: db.clone == <span class="number">1</span>,</span><br><span class="line">        &#125;)</span><br><span class="line">        opt *sql.TxOptions  <span class="comment">// 事务选项</span></span><br><span class="line">        err <span class="type">error</span>          <span class="comment">// 错误</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取事务选项</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(opts) &gt; <span class="number">0</span> &#123;</span><br><span class="line">        opt = opts[<span class="number">0</span>]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 设置超时 ===</span></span><br><span class="line">    ctx := tx.Statement.Context</span><br><span class="line">    <span class="keyword">if</span> db.DefaultTransactionTimeout &gt; <span class="number">0</span> &#123;</span><br><span class="line">        <span class="comment">// 如果设置了默认事务超时</span></span><br><span class="line">        <span class="keyword">if</span> _, ok := ctx.Deadline(); !ok &#123;</span><br><span class="line">            <span class="comment">// 如果context没有设置deadline，则设置超时</span></span><br><span class="line">            ctx, _ = context.WithTimeout(ctx, db.DefaultTransactionTimeout)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 调用底层BeginTx ===</span></span><br><span class="line">    <span class="keyword">switch</span> beginner := tx.Statement.ConnPool.(<span class="keyword">type</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> TxBeginner:</span><br><span class="line">        <span class="comment">// 标准的 TxBeginner 接口</span></span><br><span class="line">        tx.Statement.ConnPool, err = beginner.BeginTx(ctx, opt)</span><br><span class="line">    <span class="keyword">case</span> ConnPoolBeginner:</span><br><span class="line">        <span class="comment">// 扩展的 ConnPoolBeginner 接口</span></span><br><span class="line">        tx.Statement.ConnPool, err = beginner.BeginTx(ctx, opt)</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="comment">// 不支持事务</span></span><br><span class="line">        err = ErrInvalidTransaction</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 处理错误 ===</span></span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        tx.AddError(err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> tx</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Begin 调用链</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">db.Begin(opts):</span><br><span class="line">    │</span><br><span class="line">    ├─► 1. getInstance()</span><br><span class="line">    │   └─ 创建新的DB实例，克隆配置</span><br><span class="line">    │</span><br><span class="line">    ├─► 2. Session(&amp;Session&#123;...&#125;)</span><br><span class="line">    │   ├─ Context: 复制上下文</span><br><span class="line">    │   └─ NewDB: 是否创建新DB</span><br><span class="line">    │</span><br><span class="line">    ├─► 3. 设置超时</span><br><span class="line">    │   └─ WithTimeout(ctx, DefaultTransactionTimeout)</span><br><span class="line">    │</span><br><span class="line">    ├─► 4. 调用 BeginTx</span><br><span class="line">    │   ├─ TxBeginner.BeginTx() 或</span><br><span class="line">    │   ├─ ConnPoolBeginner.BeginTx()</span><br><span class="line">    │   └─ 更新 ConnPool</span><br><span class="line">    │</span><br><span class="line">    └─► 5. 返回 tx</span><br></pre></td></tr></table></figure>

<h3 id="3-3-Commit-和-Rollback-实现"><a href="#3-3-Commit-和-Rollback-实现" class="headerlink" title="3.3 Commit 和 Rollback 实现"></a>3.3 Commit 和 Rollback 实现</h3><p><strong>源码位置</strong>: <code>finisher_api.go:717-736</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Commit 提交事务</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> Commit() *DB &#123;</span><br><span class="line">    <span class="comment">// 检查连接池是否支持事务提交</span></span><br><span class="line">    <span class="keyword">if</span> committer, ok := db.Statement.ConnPool.(TxCommitter); ok &amp;&amp; committer != <span class="literal">nil</span> &amp;&amp; !reflect.ValueOf(committer).IsNil() &#123;</span><br><span class="line">        <span class="comment">// 调用底层提交方法</span></span><br><span class="line">        db.AddError(committer.Commit())</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 不支持事务提交</span></span><br><span class="line">        db.AddError(ErrInvalidTransaction)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> db</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Rollback 回滚事务</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> Rollback() *DB &#123;</span><br><span class="line">    <span class="comment">// 检查连接池是否支持事务回滚</span></span><br><span class="line">    <span class="keyword">if</span> committer, ok := db.Statement.ConnPool.(TxCommitter); ok &amp;&amp; committer != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="comment">// 检查是否为nil（防止空指针）</span></span><br><span class="line">        <span class="keyword">if</span> !reflect.ValueOf(committer).IsNil() &#123;</span><br><span class="line">            <span class="comment">// 调用底层回滚方法</span></span><br><span class="line">            db.AddError(committer.Rollback())</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 不支持事务回滚</span></span><br><span class="line">        db.AddError(ErrInvalidTransaction)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> db</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Commit&#x2F;Rollback 流程</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">Commit():</span><br><span class="line">    │</span><br><span class="line">    ├─► 1. 检查 ConnPool 类型</span><br><span class="line">    │   └─ ConnPool.(TxCommitter)</span><br><span class="line">    │</span><br><span class="line">    ├─► 2. 检查是否为nil</span><br><span class="line">    │   └─ reflect.ValueOf(committer).IsNil()</span><br><span class="line">    │</span><br><span class="line">    ├─► 3. 调用 Commit()</span><br><span class="line">    │   └─ committer.Commit()</span><br><span class="line">    │</span><br><span class="line">    └─► 4. 记录错误</span><br><span class="line">        └─ db.AddError(err)</span><br><span class="line"></span><br><span class="line">Rollback():</span><br><span class="line">    │</span><br><span class="line">    ├─► 1. 检查 ConnPool 类型</span><br><span class="line">    │   └─ ConnPool.(TxCommitter)</span><br><span class="line">    │</span><br><span class="line">    ├─► 2. 检查是否为nil</span><br><span class="line">    │   └─ reflect.ValueOf(committer).IsNil()</span><br><span class="line">    │</span><br><span class="line">    ├─► 3. 调用 Rollback()</span><br><span class="line">    │   └─ committer.Rollback()</span><br><span class="line">    │</span><br><span class="line">    └─► 4. 记录错误</span><br><span class="line">        └─ db.AddError(err)</span><br></pre></td></tr></table></figure>

<h3 id="3-4-SavePoint-和-RollbackTo-实现"><a href="#3-4-SavePoint-和-RollbackTo-实现" class="headerlink" title="3.4 SavePoint 和 RollbackTo 实现"></a>3.4 SavePoint 和 RollbackTo 实现</h3><p><strong>源码位置</strong>: <code>finisher_api.go:738-782</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SavePoint 创建保存点</span></span><br><span class="line"><span class="comment">// name: 保存点名称</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> SavePoint(name <span class="type">string</span>) *DB &#123;</span><br><span class="line">    <span class="comment">// 检查dialector是否支持保存点</span></span><br><span class="line">    <span class="keyword">if</span> savePointer, ok := db.Dialector.(SavePointerDialectorInterface); ok &#123;</span><br><span class="line">        <span class="keyword">var</span> (</span><br><span class="line">            preparedStmtTx   *PreparedStmtTX  <span class="comment">// 预编译事务</span></span><br><span class="line">            isPreparedStmtTx <span class="type">bool</span>            <span class="comment">// 是否是预编译事务</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment">// === 关闭预编译语句 ===</span></span><br><span class="line">        <span class="comment">// MySQL 8.0 不支持预编译语句中的保存点操作</span></span><br><span class="line">        <span class="comment">// https://dev.mysql.com/doc/refman/8.0/en/sql-prepared-statements.html</span></span><br><span class="line">        <span class="keyword">if</span> preparedStmtTx, isPreparedStmtTx = db.Statement.ConnPool.(*PreparedStmtTX); isPreparedStmtTx &#123;</span><br><span class="line">            <span class="comment">// 临时切换到底层事务</span></span><br><span class="line">            db.Statement.ConnPool = preparedStmtTx.Tx</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// === 调用dialector的SavePoint方法 ===</span></span><br><span class="line">        <span class="comment">// 实际执行: SAVEPOINT name</span></span><br><span class="line">        db.AddError(savePointer.SavePoint(db, name))</span><br><span class="line"></span><br><span class="line">        <span class="comment">// === 恢复预编译语句 ===</span></span><br><span class="line">        <span class="keyword">if</span> isPreparedStmtTx &#123;</span><br><span class="line">            db.Statement.ConnPool = preparedStmtTx</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// dialector不支持保存点</span></span><br><span class="line">        db.AddError(ErrUnsupportedDriver)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> db</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// RollbackTo 回滚到指定的保存点</span></span><br><span class="line"><span class="comment">// name: 保存点名称</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> RollbackTo(name <span class="type">string</span>) *DB &#123;</span><br><span class="line">    <span class="comment">// 检查dialector是否支持保存点</span></span><br><span class="line">    <span class="keyword">if</span> savePointer, ok := db.Dialector.(SavePointerDialectorInterface); ok &#123;</span><br><span class="line">        <span class="keyword">var</span> (</span><br><span class="line">            preparedStmtTx   *PreparedStmtTX  <span class="comment">// 预编译事务</span></span><br><span class="line">            isPreparedStmtTx <span class="type">bool</span>            <span class="comment">// 是否是预编译事务</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment">// === 关闭预编译语句 ===</span></span><br><span class="line">        <span class="keyword">if</span> preparedStmtTx, isPreparedStmtTx = db.Statement.ConnPool.(*PreparedStmtTX); isPreparedStmtTx &#123;</span><br><span class="line">            db.Statement.ConnPool = preparedStmtTx.Tx</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// === 调用dialector的RollbackTo方法 ===</span></span><br><span class="line">        <span class="comment">// 实际执行: ROLLBACK TO SAVEPOINT name</span></span><br><span class="line">        db.AddError(savePointer.RollbackTo(db, name))</span><br><span class="line"></span><br><span class="line">        <span class="comment">// === 恢复预编译语句 ===</span></span><br><span class="line">        <span class="keyword">if</span> isPreparedStmtTx &#123;</span><br><span class="line">            db.Statement.ConnPool = preparedStmtTx</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// dialector不支持保存点</span></span><br><span class="line">        db.AddError(ErrUnsupportedDriver)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> db</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>保存点操作流程</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">SavePoint(name):</span><br><span class="line">    │</span><br><span class="line">    ├─► 1. 检查 Dialector 支持</span><br><span class="line">    │   └─ db.Dialector.(SavePointerDialectorInterface)</span><br><span class="line">    │</span><br><span class="line">    ├─► 2. 处理预编译语句</span><br><span class="line">    │   └─ if ConnPool 是 PreparedStmtTX:</span><br><span class="line">    │       ├─ 临时切换到 Tx</span><br><span class="line">    │       └─ db.Statement.ConnPool = preparedStmtTx.Tx</span><br><span class="line">    │</span><br><span class="line">    ├─► 3. 执行保存点SQL</span><br><span class="line">    │   └─ savePointer.SavePoint(db, name)</span><br><span class="line">    │       实际执行: SAVEPOINT name</span><br><span class="line">    │</span><br><span class="line">    ├─► 4. 恢复预编译语句</span><br><span class="line">    │   └─ db.Statement.ConnPool = preparedStmtTx</span><br><span class="line">    │</span><br><span class="line">    └─► 5. 返回db</span><br><span class="line"></span><br><span class="line">RollbackTo(name):</span><br><span class="line">    │</span><br><span class="line">    ├─► 1. 检查 Dialector 支持</span><br><span class="line">    │   └─ db.Dialector.(SavePointerDialectorInterface)</span><br><span class="line">    │</span><br><span class="line">    ├─► 2. 处理预编译语句</span><br><span class="line">    │   └─ if ConnPool 是 PreparedStmtTX:</span><br><span class="line">    │       ├─ 临时切换到 Tx</span><br><span class="line">    │       └─ db.Statement.ConnPool = preparedStmtTx.Tx</span><br><span class="line">    │</span><br><span class="line">    ├─► 3. 执行回滚SQL</span><br><span class="line">    │   └─ savePointer.RollbackTo(db, name)</span><br><span class="line">    │       实际执行: ROLLBACK TO SAVEPOINT name</span><br><span class="line">    │</span><br><span class="line">    ├─► 4. 恢复预编译语句</span><br><span class="line">    │   └─ db.Statement.ConnPool = preparedStmtTx</span><br><span class="line">    │</span><br><span class="line">    └─► 5. 返回db</span><br></pre></td></tr></table></figure>

<p><strong>SQL 执行示例</strong>:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 外层事务开始</span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建保存点 1</span></span><br><span class="line"><span class="keyword">SAVEPOINT</span> sp1;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> users (name) <span class="keyword">VALUES</span> (<span class="string">&#x27;Alice&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建保存点 2</span></span><br><span class="line"><span class="keyword">SAVEPOINT</span> sp2;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders (user_id, amount) <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="number">100</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 回滚到保存点 1（撤销保存点1和2的所有操作）</span></span><br><span class="line"><span class="keyword">ROLLBACK</span> <span class="keyword">TO</span> <span class="keyword">SAVEPOINT</span> sp1;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 外层事务继续</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> posts (title) <span class="keyword">VALUES</span> (<span class="string">&#x27;Hello&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 提交外层事务</span></span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br></pre></td></tr></table></figure>

<h3 id="3-5-事务执行流程图"><a href="#3-5-事务执行流程图" class="headerlink" title="3.5 事务执行流程图"></a>3.5 事务执行流程图</h3><p><strong>完整事务生命周期</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">用户调用 db.Transaction(fc):</span><br><span class="line">    │</span><br><span class="line">    ├─► [阶段 1] 初始化检查</span><br><span class="line">    │   ├─ 检查 ConnPool 类型</span><br><span class="line">    │   └─ 决定执行路径</span><br><span class="line">    │</span><br><span class="line">    ├─► [阶段 2a] 嵌套事务路径 (已在事务中)</span><br><span class="line">    │   │</span><br><span class="line">    │   ├─ 创建保存点</span><br><span class="line">    │   │   └─ SAVEPOINT spXXX</span><br><span class="line">    │   │</span><br><span class="line">    │   ├─ 设置 defer 回滚</span><br><span class="line">    │   │   └─ defer &#123; if panic || err: ROLLBACK TO spXXX &#125;</span><br><span class="line">    │   │</span><br><span class="line">    │   ├─ 执行用户函数</span><br><span class="line">    │   │   └─ fc(db)</span><br><span class="line">    │   │       ├─ 成功 → 释放保存点</span><br><span class="line">    │   │       └─ 失败 → defer 回滚</span><br><span class="line">    │   │</span><br><span class="line">    │   └─ 返回错误</span><br><span class="line">    │</span><br><span class="line">    ├─► [阶段 2b] 新建事务路径 (不在事务中)</span><br><span class="line">    │   │</span><br><span class="line">    │   ├─ 开始事务</span><br><span class="line">    │   │   └─ BEGIN</span><br><span class="line">    │   │</span><br><span class="line">    │   ├─ 设置 defer 回滚</span><br><span class="line">    │   │   └─ defer &#123; if panic || err: ROLLBACK &#125;</span><br><span class="line">    │   │</span><br><span class="line">    │   ├─ 执行用户函数</span><br><span class="line">    │   │   └─ fc(tx)</span><br><span class="line">    │   │       ├─ 成功 → COMMIT</span><br><span class="line">    │   │       └─ 失败 → defer 回滚</span><br><span class="line">    │   │</span><br><span class="line">    │   └─ 返回错误</span><br><span class="line">    │</span><br><span class="line">    └─► [阶段 3] 返回结果</span><br><span class="line">        └─ err (nil 或 error)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="四、默认事务机制"><a href="#四、默认事务机制" class="headerlink" title="四、默认事务机制"></a>四、默认事务机制</h2><h3 id="4-1-BeginTransaction-实现"><a href="#4-1-BeginTransaction-实现" class="headerlink" title="4.1 BeginTransaction 实现"></a>4.1 BeginTransaction 实现</h3><p><strong>源码位置</strong>: <code>callbacks/transaction.go:7-18</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// BeginTransaction 在create/update/delete操作前开始事务</span></span><br><span class="line"><span class="comment">// 在回调链的 before 阶段执行</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BeginTransaction</span><span class="params">(db *gorm.DB)</span></span> &#123;</span><br><span class="line">    <span class="comment">// === 第 1 步: 检查是否跳过默认事务 ===</span></span><br><span class="line">    <span class="keyword">if</span> !db.Config.SkipDefaultTransaction &amp;&amp; db.Error == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="comment">// === 第 2 步: 调用 Begin() ===</span></span><br><span class="line">        <span class="keyword">if</span> tx := db.Begin(); tx.Error == <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="comment">// === 第 3 步: 更新连接池 ===</span></span><br><span class="line">            <span class="comment">// 将当前连接池替换为事务连接池</span></span><br><span class="line">            db.Statement.ConnPool = tx.Statement.ConnPool</span><br><span class="line"></span><br><span class="line">            <span class="comment">// === 第 4 步: 设置事务标记 ===</span></span><br><span class="line">            <span class="comment">// 标记事务由GORM自动开始</span></span><br><span class="line">            db.InstanceSet(<span class="string">&quot;gorm:started_transaction&quot;</span>, <span class="literal">true</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> tx.Error == gorm.ErrInvalidTransaction &#123;</span><br><span class="line">            <span class="comment">// === 处理无效事务错误 ===</span></span><br><span class="line">            <span class="comment">// 例如：连接池不支持事务</span></span><br><span class="line">            tx.Error = <span class="literal">nil</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 其他错误</span></span><br><span class="line">            db.Error = tx.Error</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行流程</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">BeginTransaction(db):</span><br><span class="line">    │</span><br><span class="line">    ├─► 1. 检查 SkipDefaultTransaction</span><br><span class="line">    │   ├─ true → 跳过，不开始事务</span><br><span class="line">    │   └─ false → 继续</span><br><span class="line">    │</span><br><span class="line">    ├─► 2. 检查 db.Error</span><br><span class="line">    │   ├─ 非 nil → 跳过</span><br><span class="line">    │   └─ nil → 继续</span><br><span class="line">    │</span><br><span class="line">    ├─► 3. 调用 Begin()</span><br><span class="line">    │   └─ tx := db.Begin()</span><br><span class="line">    │</span><br><span class="line">    ├─► 4. 处理结果</span><br><span class="line">    │   ├─ tx.Error == nil</span><br><span class="line">    │   │   ├─ 更新 ConnPool</span><br><span class="line">    │   │   └─ 设置 started_transaction 标记</span><br><span class="line">    │   │</span><br><span class="line">    │   └─ tx.Error != nil</span><br><span class="line">    │       ├─ ErrInvalidTransaction</span><br><span class="line">    │       │   └─ 忽略错误（不支持事务）</span><br><span class="line">    │       └─ 其他错误</span><br><span class="line">    │           └─ 设置到 db.Error</span><br><span class="line">    │</span><br><span class="line">    └─► 5. 返回</span><br></pre></td></tr></table></figure>

<h3 id="4-2-CommitOrRollbackTransaction-实现"><a href="#4-2-CommitOrRollbackTransaction-实现" class="headerlink" title="4.2 CommitOrRollbackTransaction 实现"></a>4.2 CommitOrRollbackTransaction 实现</h3><p><strong>源码位置</strong>: <code>callbacks/transaction.go:20-32</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CommitOrRollbackTransaction 在create/update/delete操作后提交或回滚事务</span></span><br><span class="line"><span class="comment">// 在回调链的 after 阶段执行</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CommitOrRollbackTransaction</span><span class="params">(db *gorm.DB)</span></span> &#123;</span><br><span class="line">    <span class="comment">// === 第 1 步: 检查是否跳过默认事务 ===</span></span><br><span class="line">    <span class="keyword">if</span> !db.Config.SkipDefaultTransaction &#123;</span><br><span class="line">        <span class="comment">// === 第 2 步: 检查事务标记 ===</span></span><br><span class="line">        <span class="keyword">if</span> _, ok := db.InstanceGet(<span class="string">&quot;gorm:started_transaction&quot;</span>); ok &#123;</span><br><span class="line">            <span class="comment">// === 第 3 步: 根据错误决定提交或回滚 ===</span></span><br><span class="line">            <span class="keyword">if</span> db.Error != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="comment">// 有错误：回滚事务</span></span><br><span class="line">                db.Rollback()</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 无错误：提交事务</span></span><br><span class="line">                db.Commit()</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// === 第 4 步: 恢复连接池 ===</span></span><br><span class="line">            <span class="comment">// 将连接池恢复为原始连接池</span></span><br><span class="line">            db.Statement.ConnPool = db.ConnPool</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行流程</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">CommitOrRollbackTransaction(db):</span><br><span class="line">    │</span><br><span class="line">    ├─► 1. 检查 SkipDefaultTransaction</span><br><span class="line">    │   ├─ true → 跳过</span><br><span class="line">    │   └─ false → 继续</span><br><span class="line">    │</span><br><span class="line">    ├─► 2. 检查 started_transaction 标记</span><br><span class="line">    │   ├─ 不存在 → 跳过（事务不是由GORM开始的）</span><br><span class="line">    │   └─ 存在 → 继续</span><br><span class="line">    │</span><br><span class="line">    ├─► 3. 检查 db.Error</span><br><span class="line">    │   ├─ 非 nil → Rollback()</span><br><span class="line">    │   └─ nil → Commit()</span><br><span class="line">    │</span><br><span class="line">    ├─► 4. 恢复连接池</span><br><span class="line">    │   └─ db.Statement.ConnPool = db.ConnPool</span><br><span class="line">    │</span><br><span class="line">    └─► 5. 返回</span><br></pre></td></tr></table></figure>

<h3 id="4-3-回调注册流程"><a href="#4-3-回调注册流程" class="headerlink" title="4.3 回调注册流程"></a>4.3 回调注册流程</h3><p><strong>源码位置</strong>: <code>callbacks/callbacks.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RegisterDefaultCallbacks 注册所有默认回调</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RegisterDefaultCallbacks</span><span class="params">(db *gorm.DB, config *Config)</span></span> &#123;</span><br><span class="line">    <span class="comment">// === Create 回调链 ===</span></span><br><span class="line">    createCallback := db.Callback().Create()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在 create 之前开始事务</span></span><br><span class="line">    createCallback.Match(enableTransaction).Register(<span class="string">&quot;gorm:begin_transaction&quot;</span>, BeginTransaction)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 其他 create 回调...</span></span><br><span class="line">    createCallback.Register(<span class="string">&quot;gorm:create&quot;</span>, Create(config))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在 create 之后提交或回滚事务</span></span><br><span class="line">    createCallback.Register(<span class="string">&quot;gorm:commit_or_rollback_transaction&quot;</span>, CommitOrRollbackTransaction)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === Update 回调链 ===</span></span><br><span class="line">    updateCallback := db.Callback().Update()</span><br><span class="line"></span><br><span class="line">    updateCallback.Match(enableTransaction).Register(<span class="string">&quot;gorm:begin_transaction&quot;</span>, BeginTransaction)</span><br><span class="line">    updateCallback.Register(<span class="string">&quot;gorm:update&quot;</span>, Update(config))</span><br><span class="line">    updateCallback.Register(<span class="string">&quot;gorm:commit_or_rollback_transaction&quot;</span>, CommitOrRollbackTransaction)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === Delete 回调链 ===</span></span><br><span class="line">    deleteCallback := db.Callback().Delete()</span><br><span class="line"></span><br><span class="line">    deleteCallback.Match(enableTransaction).Register(<span class="string">&quot;gorm:begin_transaction&quot;</span>, BeginTransaction)</span><br><span class="line">    deleteCallback.Register(<span class="string">&quot;gorm:delete&quot;</span>, Delete(config))</span><br><span class="line">    deleteCallback.Register(<span class="string">&quot;gorm:commit_or_rollback_transaction&quot;</span>, CommitOrRollbackTransaction)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// enableTransaction 检查是否启用事务</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">enableTransaction</span><span class="params">(db *gorm.DB)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> !db.SkipDefaultTransaction</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>回调执行顺序</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">Create(&amp;user) 执行流程:</span><br><span class="line">    │</span><br><span class="line">    ├─► [before:create 阶段]</span><br><span class="line">    │   │</span><br><span class="line">    │   ├─ gorm:begin_transaction</span><br><span class="line">    │   │   ├─ 检查 SkipDefaultTransaction</span><br><span class="line">    │   │   ├─ 调用 Begin()</span><br><span class="line">    │   │   ├─ 更新 ConnPool</span><br><span class="line">    │   │   └─ 设置 started_transaction 标记</span><br><span class="line">    │   │</span><br><span class="line">    │   └─ 其他 before 回调...</span><br><span class="line">    │</span><br><span class="line">    ├─► [create 阶段]</span><br><span class="line">    │   │</span><br><span class="line">    │   ├─ gorm:create</span><br><span class="line">    │   │   ├─ 构建 SQL</span><br><span class="line">    │   │   ├─ 执行 INSERT</span><br><span class="line">    │   │   └─ 设置 db.Error</span><br><span class="line">    │   │</span><br><span class="line">    │   └─ 其他 create 回调...</span><br><span class="line">    │</span><br><span class="line">    ├─► [after:create 阶段]</span><br><span class="line">    │   │</span><br><span class="line">    │   └─ gorm:commit_or_rollback_transaction</span><br><span class="line">    │       ├─ 检查 started_transaction 标记</span><br><span class="line">    │       ├─ 检查 db.Error</span><br><span class="line">    │       ├─ 有错误 → Rollback()</span><br><span class="line">    │       ├─ 无错误 → Commit()</span><br><span class="line">    │       └─ 恢复 ConnPool</span><br><span class="line">    │</span><br><span class="line">    └─► 返回结果</span><br></pre></td></tr></table></figure>

<h3 id="4-4-默认事务流程图"><a href="#4-4-默认事务流程图" class="headerlink" title="4.4 默认事务流程图"></a>4.4 默认事务流程图</h3><p><strong>Create 操作的完整事务流程</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">db.Create(&amp;user) 调用:</span><br><span class="line">    │</span><br><span class="line">    ├─► 1. 进入 Create 回调链</span><br><span class="line">    │</span><br><span class="line">    ├─► 2. before:create 阶段</span><br><span class="line">    │   │</span><br><span class="line">    │   ├─► gorm:begin_transaction</span><br><span class="line">    │   │   │</span><br><span class="line">    │   │   ├─ SkipDefaultTransaction?</span><br><span class="line">    │   │   │   ├─ YES → 跳过</span><br><span class="line">    │   │   │   └─ NO → 继续</span><br><span class="line">    │   │   │</span><br><span class="line">    │   │   ├─ db.Error == nil?</span><br><span class="line">    │   │   │   ├─ NO → 跳过</span><br><span class="line">    │   │   │   └─ YES → 继续</span><br><span class="line">    │   │   │</span><br><span class="line">    │   │   ├─ db.Begin()</span><br><span class="line">    │   │   │   ├─ 调用 BeginTx()</span><br><span class="line">    │   │   │   └─ 获取 *sql.Tx</span><br><span class="line">    │   │   │</span><br><span class="line">    │   │   ├─ 更新 ConnPool</span><br><span class="line">    │   │   │   └─ db.Statement.ConnPool = tx.ConnPool</span><br><span class="line">    │   │   │</span><br><span class="line">    │   │   └─ 设置标记</span><br><span class="line">    │   │       └─ db.InstanceSet(&quot;gorm:started_transaction&quot;, true)</span><br><span class="line">    │   │</span><br><span class="line">    │   └─ 其他 before 回调...</span><br><span class="line">    │</span><br><span class="line">    ├─► 3. create 阶段</span><br><span class="line">    │   │</span><br><span class="line">    │   ├─► gorm:create</span><br><span class="line">    │   │   │</span><br><span class="line">    │   │   ├─ 构建 INSERT SQL</span><br><span class="line">    │   │   │</span><br><span class="line">    │   │   ├─ 执行 SQL</span><br><span class="line">    │   │   │   ├─ 成功 → 继续</span><br><span class="line">    │   │   │   └─ 失败 → 设置 db.Error</span><br><span class="line">    │   │   │</span><br><span class="line">    │   │   └─ 返回</span><br><span class="line">    │   │</span><br><span class="line">    │   └─ 其他 create 回调...</span><br><span class="line">    │</span><br><span class="line">    ├─► 4. after:create 阶段</span><br><span class="line">    │   │</span><br><span class="line">    │   └─► gorm:commit_or_rollback_transaction</span><br><span class="line">    │       │</span><br><span class="line">    │       ├─ SkipDefaultTransaction?</span><br><span class="line">    │       │   ├─ YES → 跳过</span><br><span class="line">    │       │   └─ NO → 继续</span><br><span class="line">    │       │</span><br><span class="line">    │       ├─ started_transaction 存在?</span><br><span class="line">    │       │   ├─ NO → 跳过</span><br><span class="line">    │       │   └─ YES → 继续</span><br><span class="line">    │       │</span><br><span class="line">    │       ├─ 检查 db.Error</span><br><span class="line">    │       │   │</span><br><span class="line">    │       │   ├─ 有错误 → Rollback()</span><br><span class="line">    │       │   │   ├─ 调用 tx.Rollback()</span><br><span class="line">    │       │   │   └─ 回滚事务</span><br><span class="line">    │       │   │</span><br><span class="line">    │       │   └─ 无错误 → Commit()</span><br><span class="line">    │       │       ├─ 调用 tx.Commit()</span><br><span class="line">    │       │       └─ 提交事务</span><br><span class="line">    │       │</span><br><span class="line">    │       └─ 恢复 ConnPool</span><br><span class="line">    │           └─ db.Statement.ConnPool = db.ConnPool</span><br><span class="line">    │</span><br><span class="line">    └─► 5. 返回结果</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="五、实战代码示例"><a href="#五、实战代码示例" class="headerlink" title="五、实战代码示例"></a>五、实战代码示例</h2><h3 id="5-1-基础事务使用"><a href="#5-1-基础事务使用" class="headerlink" title="5.1 基础事务使用"></a>5.1 基础事务使用</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;gorm.io/driver/mysql&quot;</span></span><br><span class="line">    <span class="string">&quot;gorm.io/gorm&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">    ID    <span class="type">uint</span></span><br><span class="line">    Name  <span class="type">string</span></span><br><span class="line">    Email <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Account <span class="keyword">struct</span> &#123;</span><br><span class="line">    ID     <span class="type">uint</span></span><br><span class="line">    UserID <span class="type">uint</span></span><br><span class="line">    Balance <span class="type">float64</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    dsn := <span class="string">&quot;user:password@tcp(127.0.0.1:3306)/dbname?charset=utf8mb4&amp;parseTime=True&amp;loc=Local&quot;</span></span><br><span class="line">    db, err := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;&#125;)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    db.AutoMigrate(&amp;User&#123;&#125;, &amp;Account&#123;&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 基础事务示例 ===</span></span><br><span class="line">    err = db.Transaction(<span class="function"><span class="keyword">func</span><span class="params">(tx *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 创建用户</span></span><br><span class="line">        user := User&#123;Name: <span class="string">&quot;Alice&quot;</span>, Email: <span class="string">&quot;alice@example.com&quot;</span>&#125;</span><br><span class="line">        <span class="keyword">if</span> err := tx.Create(&amp;user).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> err  <span class="comment">// 自动回滚</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 创建账户</span></span><br><span class="line">        account := Account&#123;</span><br><span class="line">            UserID:  user.ID,</span><br><span class="line">            Balance: <span class="number">1000.0</span>,</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> err := tx.Create(&amp;account).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> err  <span class="comment">// 自动回滚</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        fmt.Printf(<span class="string">&quot;用户 %s 创建成功，账户余额: %.2f\n&quot;</span>, user.Name, account.Balance)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>  <span class="comment">// 自动提交</span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;事务失败: %v\n&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-2-嵌套事务使用"><a href="#5-2-嵌套事务使用" class="headerlink" title="5.2 嵌套事务使用"></a>5.2 嵌套事务使用</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;errors&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;gorm.io/driver/mysql&quot;</span></span><br><span class="line">    <span class="string">&quot;gorm.io/gorm&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">    ID   <span class="type">uint</span></span><br><span class="line">    Name <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Order <span class="keyword">struct</span> &#123;</span><br><span class="line">    ID     <span class="type">uint</span></span><br><span class="line">    UserID <span class="type">uint</span></span><br><span class="line">    Amount <span class="type">float64</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Log <span class="keyword">struct</span> &#123;</span><br><span class="line">    ID     <span class="type">uint</span></span><br><span class="line">    UserID <span class="type">uint</span></span><br><span class="line">    Action <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    dsn := <span class="string">&quot;user:password@tcp(127.0.0.1:3306)/dbname?charset=utf8mb4&amp;parseTime=True&amp;loc=Local&quot;</span></span><br><span class="line">    db, err := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;&#125;)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    db.AutoMigrate(&amp;User&#123;&#125;, &amp;Order&#123;&#125;, &amp;Log&#123;&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 嵌套事务示例 ===</span></span><br><span class="line">    err = db.Transaction(<span class="function"><span class="keyword">func</span><span class="params">(tx1 *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">        fmt.Println(<span class="string">&quot;外层事务开始&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. 创建用户</span></span><br><span class="line">        user := User&#123;Name: <span class="string">&quot;Bob&quot;</span>&#125;</span><br><span class="line">        <span class="keyword">if</span> err := tx1.Create(&amp;user).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;创建用户: %s (ID: %d)\n&quot;</span>, user.Name, user.ID)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 内层事务 1</span></span><br><span class="line">        err = tx1.Transaction(<span class="function"><span class="keyword">func</span><span class="params">(tx2 *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">            fmt.Println(<span class="string">&quot;  内层事务 1 开始&quot;</span>)</span><br><span class="line"></span><br><span class="line">            order := Order&#123;</span><br><span class="line">                UserID: user.ID,</span><br><span class="line">                Amount: <span class="number">100.0</span>,</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> err := tx2.Create(&amp;order).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> err</span><br><span class="line">            &#125;</span><br><span class="line">            fmt.Printf(<span class="string">&quot;  创建订单: 金额 %.2f\n&quot;</span>, order.Amount)</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 模拟错误</span></span><br><span class="line">            <span class="keyword">if</span> order.Amount &gt; <span class="number">50</span> &#123;</span><br><span class="line">                fmt.Println(<span class="string">&quot;  内层事务 1 回滚（金额过大）&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> errors.New(<span class="string">&quot;amount too large&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            fmt.Printf(<span class="string">&quot;  内层事务 1 失败: %v\n&quot;</span>, err)</span><br><span class="line">            <span class="comment">// 内层失败，外层继续</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 内层事务 2</span></span><br><span class="line">        err = tx1.Transaction(<span class="function"><span class="keyword">func</span><span class="params">(tx2 *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">            fmt.Println(<span class="string">&quot;  内层事务 2 开始&quot;</span>)</span><br><span class="line"></span><br><span class="line">            log := Log&#123;</span><br><span class="line">                UserID: user.ID,</span><br><span class="line">                Action: <span class="string">&quot;created&quot;</span>,</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> err := tx2.Create(&amp;log).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> err</span><br><span class="line">            &#125;</span><br><span class="line">            fmt.Printf(<span class="string">&quot;  创建日志: %s\n&quot;</span>, log.Action)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        fmt.Println(<span class="string">&quot;外层事务提交&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;事务失败: %v\n&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-3-手动事务控制"><a href="#5-3-手动事务控制" class="headerlink" title="5.3 手动事务控制"></a>5.3 手动事务控制</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;gorm.io/driver/mysql&quot;</span></span><br><span class="line">    <span class="string">&quot;gorm.io/gorm&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    dsn := <span class="string">&quot;user:password@tcp(127.0.0.1:3306)/dbname?charset=utf8mb4&amp;parseTime=True&amp;loc=Local&quot;</span></span><br><span class="line">    db, err := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;&#125;)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 手动事务控制 ===</span></span><br><span class="line">    tx := db.Begin()</span><br><span class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> r := <span class="built_in">recover</span>(); r != <span class="literal">nil</span> &#123;</span><br><span class="line">            tx.Rollback()</span><br><span class="line">            <span class="built_in">panic</span>(r)  <span class="comment">// 重新抛出panic</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 操作 1: 创建用户</span></span><br><span class="line">    <span class="keyword">if</span> err := tx.Create(&amp;User&#123;Name: <span class="string">&quot;Charlie&quot;</span>&#125;).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">        tx.Rollback()</span><br><span class="line">        fmt.Printf(<span class="string">&quot;创建用户失败: %v\n&quot;</span>, err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 操作 2: 创建订单</span></span><br><span class="line">    <span class="keyword">if</span> err := tx.Create(&amp;Order&#123;Amount: <span class="number">200</span>&#125;).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">        tx.Rollback()</span><br><span class="line">        fmt.Printf(<span class="string">&quot;创建订单失败: %v\n&quot;</span>, err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 提交事务</span></span><br><span class="line">    <span class="keyword">if</span> err := tx.Commit().Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;提交事务失败: %v\n&quot;</span>, err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fmt.Println(<span class="string">&quot;事务提交成功&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-4-保存点使用"><a href="#5-4-保存点使用" class="headerlink" title="5.4 保存点使用"></a>5.4 保存点使用</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;gorm.io/driver/mysql&quot;</span></span><br><span class="line">    <span class="string">&quot;gorm.io/gorm&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    dsn := <span class="string">&quot;user:password@tcp(127.0.0.1:3306)/dbname?charset=utf8mb4&amp;parseTime=True&amp;loc=Local&quot;</span></span><br><span class="line">    db, err := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;&#125;)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 使用嵌套事务（保存点）===</span></span><br><span class="line">    db.Transaction(<span class="function"><span class="keyword">func</span><span class="params">(tx1 *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">        fmt.Println(<span class="string">&quot;外层事务开始&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建用户</span></span><br><span class="line">        user := User&#123;Name: <span class="string">&quot;David&quot;</span>&#125;</span><br><span class="line">        <span class="keyword">if</span> err := tx1.Create(&amp;user).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 手动创建保存点</span></span><br><span class="line">        <span class="keyword">if</span> err := tx1.SavePoint(<span class="string">&quot;sp1&quot;</span>).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 尝试操作</span></span><br><span class="line">        order := Order&#123;UserID: user.ID, Amount: <span class="number">300</span>&#125;</span><br><span class="line">        <span class="keyword">if</span> err := tx1.Create(&amp;order).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">            fmt.Println(<span class="string">&quot;创建订单失败，回滚到保存点 sp1&quot;</span>)</span><br><span class="line">            tx1.RollbackTo(<span class="string">&quot;sp1&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 继续其他操作</span></span><br><span class="line">        log := Log&#123;UserID: user.ID, Action: <span class="string">&quot;completed&quot;</span>&#125;</span><br><span class="line">        <span class="keyword">if</span> err := tx1.Create(&amp;log).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        fmt.Println(<span class="string">&quot;外层事务提交&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-5-隔离级别配置"><a href="#5-5-隔离级别配置" class="headerlink" title="5.5 隔离级别配置"></a>5.5 隔离级别配置</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;context&quot;</span></span><br><span class="line">    <span class="string">&quot;database/sql&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line">    <span class="string">&quot;gorm.io/driver/mysql&quot;</span></span><br><span class="line">    <span class="string">&quot;gorm.io/gorm&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    dsn := <span class="string">&quot;user:password@tcp(127.0.0.1:3306)/dbname?charset=utf8mb4&amp;parseTime=True&amp;loc=Local&quot;</span></span><br><span class="line">    db, err := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;&#125;)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 设置隔离级别 ===</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. Read Committed（读已提交）</span></span><br><span class="line">    err = db.Transaction(<span class="function"><span class="keyword">func</span><span class="params">(tx *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">        fmt.Println(<span class="string">&quot;使用 Read Committed 隔离级别&quot;</span>)</span><br><span class="line">        <span class="keyword">var</span> users []User</span><br><span class="line">        <span class="keyword">return</span> tx.Find(&amp;users).Error</span><br><span class="line">    &#125;, &amp;sql.TxOptions&#123;</span><br><span class="line">        Isolation: sql.LevelReadCommitted,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. Repeatable Read（可重复读）</span></span><br><span class="line">    err = db.Transaction(<span class="function"><span class="keyword">func</span><span class="params">(tx *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">        fmt.Println(<span class="string">&quot;使用 Repeatable Read 隔离级别&quot;</span>)</span><br><span class="line">        <span class="keyword">var</span> users []User</span><br><span class="line">        <span class="keyword">return</span> tx.Find(&amp;users).Error</span><br><span class="line">    &#125;, &amp;sql.TxOptions&#123;</span><br><span class="line">        Isolation: sql.LevelRepeatableRead,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. Serializable（串行化）</span></span><br><span class="line">    err = db.Transaction(<span class="function"><span class="keyword">func</span><span class="params">(tx *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">        fmt.Println(<span class="string">&quot;使用 Serializable 隔离级别&quot;</span>)</span><br><span class="line">        <span class="keyword">var</span> users []User</span><br><span class="line">        <span class="keyword">return</span> tx.Find(&amp;users).Error</span><br><span class="line">    &#125;, &amp;sql.TxOptions&#123;</span><br><span class="line">        Isolation: sql.LevelSerializable,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. 只读事务</span></span><br><span class="line">    err = db.Transaction(<span class="function"><span class="keyword">func</span><span class="params">(tx *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">        fmt.Println(<span class="string">&quot;使用只读事务&quot;</span>)</span><br><span class="line">        <span class="keyword">var</span> users []User</span><br><span class="line">        <span class="keyword">return</span> tx.Find(&amp;users).Error</span><br><span class="line">    &#125;, &amp;sql.TxOptions&#123;</span><br><span class="line">        ReadOnly: <span class="literal">true</span>,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 设置事务超时 ===</span></span><br><span class="line">    db, err = gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;</span><br><span class="line">        DefaultTransactionTimeout: <span class="number">10</span> * time.Second,</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    err = db.Transaction(<span class="function"><span class="keyword">func</span><span class="params">(tx *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">        <span class="comment">// 事务将在10秒后超时</span></span><br><span class="line">        <span class="keyword">var</span> users []User</span><br><span class="line">        <span class="keyword">return</span> tx.Find(&amp;users).Error</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-6-复杂业务场景"><a href="#5-6-复杂业务场景" class="headerlink" title="5.6 复杂业务场景"></a>5.6 复杂业务场景</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;errors&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;gorm.io/driver/mysql&quot;</span></span><br><span class="line">    <span class="string">&quot;gorm.io/gorm&quot;</span></span><br><span class="line">    <span class="string">&quot;gorm.io/gorm/clause&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 转账场景</span></span><br><span class="line"><span class="keyword">type</span> TransferResult <span class="keyword">struct</span> &#123;</span><br><span class="line">    Success <span class="type">bool</span></span><br><span class="line">    Message <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Transfer</span><span class="params">(db *gorm.DB, fromID, toID <span class="type">uint</span>, amount <span class="type">float64</span>)</span></span> (*TransferResult, <span class="type">error</span>) &#123;</span><br><span class="line">    result := &amp;TransferResult&#123;Success: <span class="literal">false</span>&#125;</span><br><span class="line"></span><br><span class="line">    err := db.Transaction(<span class="function"><span class="keyword">func</span><span class="params">(tx *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 查询并锁定转出账户</span></span><br><span class="line">        <span class="keyword">var</span> from Account</span><br><span class="line">        <span class="keyword">if</span> err := tx.Clauses(clause.Locking&#123;Strength: <span class="string">&quot;UPDATE&quot;</span>&#125;).</span><br><span class="line">            First(&amp;from, fromID).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">            result.Message = <span class="string">&quot;转出账户不存在&quot;</span></span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 检查余额</span></span><br><span class="line">        <span class="keyword">if</span> from.Balance &lt; amount &#123;</span><br><span class="line">            result.Message = <span class="string">&quot;余额不足&quot;</span></span><br><span class="line">            <span class="keyword">return</span> errors.New(<span class="string">&quot;insufficient balance&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 查询并锁定转入账户</span></span><br><span class="line">        <span class="keyword">var</span> to Account</span><br><span class="line">        <span class="keyword">if</span> err := tx.Clauses(clause.Locking&#123;Strength: <span class="string">&quot;UPDATE&quot;</span>&#125;).</span><br><span class="line">            First(&amp;to, toID).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">            result.Message = <span class="string">&quot;转入账户不存在&quot;</span></span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. 执行转账</span></span><br><span class="line">        from.Balance -= amount</span><br><span class="line">        <span class="keyword">if</span> err := tx.Save(&amp;from).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">            result.Message = <span class="string">&quot;更新转出账户失败&quot;</span></span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        to.Balance += amount</span><br><span class="line">        <span class="keyword">if</span> err := tx.Save(&amp;to).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">            result.Message = <span class="string">&quot;更新转入账户失败&quot;</span></span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. 记录交易日志</span></span><br><span class="line">        log := TransactionLog&#123;</span><br><span class="line">            FromAccountID: fromID,</span><br><span class="line">            ToAccountID:   toID,</span><br><span class="line">            Amount:        amount,</span><br><span class="line">            Status:        <span class="string">&quot;completed&quot;</span>,</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> err := tx.Create(&amp;log).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">            result.Message = <span class="string">&quot;记录日志失败&quot;</span></span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        result.Success = <span class="literal">true</span></span><br><span class="line">        result.Message = fmt.Sprintf(<span class="string">&quot;转账成功: %.2f&quot;</span>, amount)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 订单创建场景</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CreateOrderWithItems</span><span class="params">(db *gorm.DB, order Order, items []OrderItem)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> db.Transaction(<span class="function"><span class="keyword">func</span><span class="params">(tx *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 创建订单</span></span><br><span class="line">        <span class="keyword">if</span> err := tx.Create(&amp;order).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 创建订单项并扣减库存</span></span><br><span class="line">        <span class="keyword">for</span> i, item := <span class="keyword">range</span> items &#123;</span><br><span class="line">            item.OrderID = order.ID</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2.1 查询并锁定产品</span></span><br><span class="line">            <span class="keyword">var</span> product Product</span><br><span class="line">            <span class="keyword">if</span> err := tx.Clauses(clause.Locking&#123;Strength: <span class="string">&quot;UPDATE&quot;</span>&#125;).</span><br><span class="line">                First(&amp;product, item.ProductID).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;产品 %d 不存在&quot;</span>, item.ProductID)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2.2 检查库存</span></span><br><span class="line">            <span class="keyword">if</span> product.Stock &lt; item.Quantity &#123;</span><br><span class="line">                <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;产品 %s 库存不足&quot;</span>, product.Name)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2.3 扣减库存</span></span><br><span class="line">            product.Stock -= item.Quantity</span><br><span class="line">            <span class="keyword">if</span> err := tx.Save(&amp;product).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> err</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2.4 创建订单项</span></span><br><span class="line">            <span class="keyword">if</span> err := tx.Create(&amp;item).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> err</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            fmt.Printf(<span class="string">&quot;订单项 %d: %s x %d\n&quot;</span>, i+<span class="number">1</span>, product.Name, item.Quantity)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        fmt.Printf(<span class="string">&quot;订单 %d 创建成功\n&quot;</span>, order.ID)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="六、最佳实践与故障排查"><a href="#六、最佳实践与故障排查" class="headerlink" title="六、最佳实践与故障排查"></a>六、最佳实践与故障排查</h2><h3 id="6-1-配置最佳实践"><a href="#6-1-配置最佳实践" class="headerlink" title="6.1 配置最佳实践"></a>6.1 配置最佳实践</h3><h4 id="生产环境配置"><a href="#生产环境配置" class="headerlink" title="生产环境配置"></a>生产环境配置</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 推荐的生产环境配置</span></span><br><span class="line">db, err := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;</span><br><span class="line">    <span class="comment">// 跳过默认事务（性能优化）</span></span><br><span class="line">    SkipDefaultTransaction: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置默认事务超时</span></span><br><span class="line">    DefaultTransactionTimeout: <span class="number">30</span> * time.Second,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启用预编译语句（性能优化）</span></span><br><span class="line">    PrepareStmt: <span class="literal">true</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 批量操作时跳过默认事务</span></span><br><span class="line">db.Session(&amp;gorm.Session&#123;</span><br><span class="line">    SkipDefaultTransaction: <span class="literal">true</span>,</span><br><span class="line">&#125;).CreateInBatches(records, <span class="number">100</span>)</span><br></pre></td></tr></table></figure>

<h4 id="事务使用原则"><a href="#事务使用原则" class="headerlink" title="事务使用原则"></a>事务使用原则</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ✅ 推荐: 事务尽可能短小</span></span><br><span class="line">db.Transaction(<span class="function"><span class="keyword">func</span><span class="params">(tx *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    <span class="comment">// 只包含必要的数据库操作</span></span><br><span class="line">    <span class="keyword">return</span> tx.Create(&amp;user).Error</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ❌ 避免: 事务中包含耗时操作</span></span><br><span class="line">db.Transaction(<span class="function"><span class="keyword">func</span><span class="params">(tx *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> err := tx.Create(&amp;user).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 避免在事务中进行HTTP调用、文件IO等耗时操作</span></span><br><span class="line">    resp, err := http.Get(<span class="string">&quot;http://api.example.com&quot;</span>)</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 正确做法: 将耗时操作放在事务外</span></span><br><span class="line">resp, err := http.Get(<span class="string">&quot;http://api.example.com&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">db.Transaction(<span class="function"><span class="keyword">func</span><span class="params">(tx *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> tx.Create(&amp;user).Error</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="6-2-常见问题与解决方案"><a href="#6-2-常见问题与解决方案" class="headerlink" title="6.2 常见问题与解决方案"></a>6.2 常见问题与解决方案</h3><h4 id="问题-1-事务超时"><a href="#问题-1-事务超时" class="headerlink" title="问题 1: 事务超时"></a>问题 1: 事务超时</h4><p><strong>症状</strong>: 事务执行时间过长导致超时</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 解决方案 1: 增加超时时间</span></span><br><span class="line">db, err := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;</span><br><span class="line">    DefaultTransactionTimeout: <span class="number">5</span> * time.Minute,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 解决方案 2: 使用 context 超时</span></span><br><span class="line">ctx, cancel := context.WithTimeout(context.Background(), <span class="number">30</span>*time.Second)</span><br><span class="line"><span class="keyword">defer</span> cancel()</span><br><span class="line"></span><br><span class="line">err = db.WithContext(ctx).Transaction(<span class="function"><span class="keyword">func</span><span class="params">(tx *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    <span class="comment">// 事务操作</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="问题-2-死锁"><a href="#问题-2-死锁" class="headerlink" title="问题 2: 死锁"></a>问题 2: 死锁</h4><p><strong>症状</strong>: 事务互相等待导致死锁</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 死锁示例:</span></span><br><span class="line"><span class="comment">// 事务1: 锁定A，等待锁定B</span></span><br><span class="line"><span class="comment">// 事务2: 锁定B，等待锁定A</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 解决方案: 按固定顺序获取锁</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Transfer</span><span class="params">(db *gorm.DB, id1, id2 <span class="type">uint</span>, amount <span class="type">float64</span>)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> db.Transaction(<span class="function"><span class="keyword">func</span><span class="params">(tx *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">        <span class="comment">// 总是先锁定ID较小的账户</span></span><br><span class="line">        <span class="keyword">if</span> id1 &gt; id2 &#123;</span><br><span class="line">            id1, id2 = id2, id1</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 锁定账户1</span></span><br><span class="line">        <span class="keyword">var</span> acc1 Account</span><br><span class="line">        <span class="keyword">if</span> err := tx.Clauses(clause.Locking&#123;Strength: <span class="string">&quot;UPDATE&quot;</span>&#125;).</span><br><span class="line">            First(&amp;acc1, id1).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 锁定账户2</span></span><br><span class="line">        <span class="keyword">var</span> acc2 Account</span><br><span class="line">        <span class="keyword">if</span> err := tx.Clauses(clause(clause.Locking&#123;Strength: <span class="string">&quot;UPDATE&quot;</span>&#125;).</span><br><span class="line">            First(&amp;acc2, id2).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 执行转账</span></span><br><span class="line">        acc1.Balance -= amount</span><br><span class="line">        acc2.Balance += amount</span><br><span class="line">        tx.Save(&amp;acc1)</span><br><span class="line">        tx.Save(&amp;acc2)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="问题-3-嵌套事务回滚影响外层"><a href="#问题-3-嵌套事务回滚影响外层" class="headerlink" title="问题 3: 嵌套事务回滚影响外层"></a>问题 3: 嵌套事务回滚影响外层</h4><p><strong>症状</strong>: 内层事务回滚导致外层也回滚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 解决方案: 禁用嵌套事务</span></span><br><span class="line">db.Transaction(<span class="function"><span class="keyword">func</span><span class="params">(tx1 *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    <span class="comment">// 外层事务</span></span><br><span class="line">    tx1.Create(&amp;User&#123;Name: <span class="string">&quot;Alice&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 内层作为独立事务</span></span><br><span class="line">    tx2 := db.Begin()</span><br><span class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> r := <span class="built_in">recover</span>(); r != <span class="literal">nil</span> &#123;</span><br><span class="line">            tx2.Rollback()</span><br><span class="line">            <span class="built_in">panic</span>(r)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    tx2.Create(&amp;Order&#123;UserID: <span class="number">1</span>, Amount: <span class="number">100</span>&#125;)</span><br><span class="line">    <span class="keyword">if</span> someError &#123;</span><br><span class="line">        tx2.Rollback()  <span class="comment">// 只回滚内层</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        tx2.Commit()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 外层继续</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 或使用 Session 配置</span></span><br><span class="line">db.Session(&amp;gorm.Session&#123;DisableNestedTransaction: <span class="literal">true</span>&#125;).Transaction(...)</span><br></pre></td></tr></table></figure>

<h4 id="问题-4-隔离级别导致的并发问题"><a href="#问题-4-隔离级别导致的并发问题" class="headerlink" title="问题 4: 隔离级别导致的并发问题"></a>问题 4: 隔离级别导致的并发问题</h4><p><strong>症状</strong>: 脏读、幻读、不可重复读</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 解决方案: 根据场景选择合适的隔离级别</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 读多写少: Read Committed</span></span><br><span class="line">db.Transaction(<span class="function"><span class="keyword">func</span><span class="params">(tx *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> users []User</span><br><span class="line">    <span class="keyword">return</span> tx.Find(&amp;users).Error</span><br><span class="line">&#125;, &amp;sql.TxOptions&#123;</span><br><span class="line">    Isolation: sql.LevelReadCommitted,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 统计查询: Repeatable Read</span></span><br><span class="line">db.Transaction(<span class="function"><span class="keyword">func</span><span class="params">(tx *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    <span class="comment">// 多次读取结果一致</span></span><br><span class="line">    <span class="keyword">var</span> count <span class="type">int64</span></span><br><span class="line">    tx.Model(&amp;User&#123;&#125;).Count(&amp;count)</span><br><span class="line">    <span class="comment">// ... 其他操作 ...</span></span><br><span class="line">    tx.Model(&amp;User&#123;&#125;).Count(&amp;count)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;, &amp;sql.TxOptions&#123;</span><br><span class="line">    Isolation: sql.LevelRepeatableRead,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 高一致性要求: Serializable</span></span><br><span class="line">db.Transaction(<span class="function"><span class="keyword">func</span><span class="params">(tx *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    <span class="comment">// 需要最高隔离级别</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;, &amp;sql.TxOptions&#123;</span><br><span class="line">    Isolation: sql.LevelSerializable,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="问题-5-预编译语句与保存点冲突"><a href="#问题-5-预编译语句与保存点冲突" class="headerlink" title="问题 5: 预编译语句与保存点冲突"></a>问题 5: 预编译语句与保存点冲突</h4><p><strong>症状</strong>: 使用 Preload 时嵌套事务报错</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 问题: MySQL 8.0 不支持预编译语句中的保存点</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 解决方案 1: 禁用预编译语句</span></span><br><span class="line">db.Session(&amp;gorm.Session&#123;PrepareStmt: <span class="literal">false</span>&#125;).Transaction(<span class="function"><span class="keyword">func</span><span class="params">(tx *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    <span class="comment">// 嵌套事务</span></span><br><span class="line">    tx.Transaction(<span class="function"><span class="keyword">func</span><span class="params">(tx2 *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 解决方案 2: 禁用嵌套事务</span></span><br><span class="line">db.Session(&amp;gorm.Session&#123;DisableNestedTransaction: <span class="literal">true</span>&#125;).Transaction(...)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="七、学习验证"><a href="#七、学习验证" class="headerlink" title="七、学习验证"></a>七、学习验证</h2><h3 id="7-1-知识自测"><a href="#7-1-知识自测" class="headerlink" title="7.1 知识自测"></a>7.1 知识自测</h3><h4 id="基础题"><a href="#基础题" class="headerlink" title="基础题"></a>基础题</h4><ol>
<li><p><strong>GORM 事务的默认行为是什么？</strong></p>
<ul>
<li>A) Create&#x2F;Update&#x2F;Delete 自动使用事务</li>
<li>B) 需要显式调用 Begin()</li>
<li>C) 默认不使用事务</li>
<li>D) 只在嵌套时使用事务</li>
</ul>
</li>
<li><p><strong>Transaction 函数如何处理 panic？</strong></p>
<ul>
<li>A) 忽略 panic</li>
<li>B) 自动回滚并返回错误</li>
<li>C) 直接崩溃</li>
<li>D) 需要手动 recover</li>
</ul>
</li>
<li><p><strong>嵌套事务使用什么机制实现？</strong></p>
<ul>
<li>A) 真正的嵌套事务</li>
<li>B) 保存点</li>
<li>C) 独立事务</li>
<li>D) 不支持嵌套</li>
</ul>
</li>
<li><p><strong>如何跳过默认事务？</strong></p>
<ul>
<li>A) 设置 SkipDefaultTransaction &#x3D; true</li>
<li>B) 使用 Begin() 手动控制</li>
<li>C) 使用 Session 配置</li>
<li>D) 以上都是</li>
</ul>
</li>
<li><p><strong>Commit 什么时候被调用？</strong></p>
<ul>
<li>A) Transaction 函数返回 nil</li>
<li>B) Transaction 函数返回 error</li>
<li>C) 发生 panic</li>
<li>D) 手动调用</li>
</ul>
</li>
</ol>
<h4 id="进阶题"><a href="#进阶题" class="headerlink" title="进阶题"></a>进阶题</h4><ol start="6">
<li><p><strong>以下代码的执行结果是什么？</strong></p>
 <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">db.Transaction(<span class="function"><span class="keyword">func</span><span class="params">(tx1 *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    tx1.Create(&amp;User&#123;Name: <span class="string">&quot;A&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line">    tx1.Transaction(<span class="function"><span class="keyword">func</span><span class="params">(tx2 *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">        tx2.Create(&amp;Order&#123;Amount: <span class="number">100</span>&#125;)</span><br><span class="line">        <span class="keyword">return</span> errors.New(<span class="string">&quot;error&quot;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<ul>
<li>A) 用户和订单都存在</li>
<li>B) 用户存在，订单不存在</li>
<li>C) 用户和订单都不存在</li>
<li>D) 抛出异常</li>
</ul>
</li>
<li><p><strong>DisableNestedTransaction 的作用是什么？</strong></p>
<ul>
<li>A) 禁用所有事务</li>
<li>B) 内层事务不使用保存点</li>
<li>C) 跳过默认事务</li>
<li>D) 禁用事务超时</li>
</ul>
</li>
<li><p><strong>SavePoint 和 RollbackTo 的关系是？</strong></p>
<ul>
<li>A) SavePoint 创建回滚点，RollbackTo 回滚到该点</li>
<li>B) RollbackTo 创建回滚点，SavePoint 回滚</li>
<li>C) 两者独立，没有关系</li>
<li>D) SavePoint 提交，RollbackTo 回滚</li>
</ul>
</li>
<li><p><strong>BeginTransaction 在哪个阶段执行？</strong></p>
<ul>
<li>A) before:create&#x2F;update&#x2F;delete</li>
<li>B) create&#x2F;update&#x2F;delete</li>
<li>C) after:create&#x2F;update&#x2F;delete</li>
<li>D) 任何时候</li>
</ul>
</li>
<li><p><strong>如何实现读写分离的事务？</strong></p>
<ul>
<li>A) 使用不同的连接池</li>
<li>B) 使用不同的隔离级别</li>
<li>C) 使用只读事务</li>
<li>D) 以上都是</li>
</ul>
</li>
</ol>
<h3 id="7-2-实践练习"><a href="#7-2-实践练习" class="headerlink" title="7.2 实践练习"></a>7.2 实践练习</h3><h4 id="练习-1-实现转账功能"><a href="#练习-1-实现转账功能" class="headerlink" title="练习 1: 实现转账功能"></a>练习 1: 实现转账功能</h4><p><strong>需求</strong>: 实现一个安全的转账功能，包括余额检查、锁定、日志记录。</p>
<p><strong>验收标准</strong>:</p>
<ul>
<li><input disabled="" type="checkbox"> 使用事务保证原子性</li>
<li><input disabled="" type="checkbox"> 使用行锁防止并发问题</li>
<li><input disabled="" type="checkbox"> 正确处理余额不足情况</li>
<li><input disabled="" type="checkbox"> 记录交易日志</li>
<li><input disabled="" type="checkbox"> 测试并发转账场景</li>
</ul>
<h4 id="练习-2-实现订单创建"><a href="#练习-2-实现订单创建" class="headerlink" title="练习 2: 实现订单创建"></a>练习 2: 实现订单创建</h4><p><strong>需求</strong>: 实现订单创建功能，包括库存扣减、订单项创建。</p>
<p><strong>验收标准</strong>:</p>
<ul>
<li><input disabled="" type="checkbox"> 使用事务保证数据一致性</li>
<li><input disabled="" type="checkbox"> 使用嵌套事务处理订单项</li>
<li><input disabled="" type="checkbox"> 正确处理库存不足情况</li>
<li><input disabled="" type="checkbox"> 测试订单创建失败回滚</li>
<li><input disabled="" type="checkbox"> 测试并发订单创建</li>
</ul>
<h4 id="练习-3-实现嵌套事务场景"><a href="#练习-3-实现嵌套事务场景" class="headerlink" title="练习 3: 实现嵌套事务场景"></a>练习 3: 实现嵌套事务场景</h4><p><strong>需求</strong>: 实现一个包含多层嵌套的业务场景。</p>
<p><strong>验收标准</strong>:</p>
<ul>
<li><input disabled="" type="checkbox"> 正确使用嵌套事务</li>
<li><input disabled="" type="checkbox"> 测试内层回滚不影响外层</li>
<li><input disabled="" type="checkbox"> 测试保存点机制</li>
<li><input disabled="" type="checkbox"> 理解 DisableNestedTransaction 的作用</li>
</ul>
<hr>
<h2 id="三、学习路径建议"><a href="#三、学习路径建议" class="headerlink" title="三、学习路径建议"></a>三、学习路径建议</h2><h3 id="3-1-前置知识检查"><a href="#3-1-前置知识检查" class="headerlink" title="3.1 前置知识检查"></a>3.1 前置知识检查</h3><table>
<thead>
<tr>
<th>知识点</th>
<th>要求</th>
<th>检验方式</th>
</tr>
</thead>
<tbody><tr>
<td>SQL 事务</td>
<td>理解 BEGIN&#x2F;COMMIT&#x2F;ROLLBACK</td>
<td>能写出基本的事务 SQL</td>
</tr>
<tr>
<td>ACID</td>
<td>理解四个特性</td>
<td>能解释每个特性</td>
</tr>
<tr>
<td>隔离级别</td>
<td>了解不同级别的区别</td>
<td>能对比 Read Committed vs Serializable</td>
</tr>
<tr>
<td>并发控制</td>
<td>了解锁的概念</td>
<td>能解释死锁</td>
</tr>
</tbody></table>
<h3 id="3-2-学习时间分配"><a href="#3-2-学习时间分配" class="headerlink" title="3.2 学习时间分配"></a>3.2 学习时间分配</h3><table>
<thead>
<tr>
<th>内容</th>
<th>理论</th>
<th>实践</th>
<th>产出</th>
</tr>
</thead>
<tbody><tr>
<td>Day 1: 事务基础</td>
<td>2h</td>
<td>1.5h</td>
<td>简单事务示例</td>
</tr>
<tr>
<td>Day 2: 嵌套事务</td>
<td>1.5h</td>
<td>2h</td>
<td>嵌套事务测试</td>
</tr>
<tr>
<td>Day 3: 实际应用</td>
<td>1.5h</td>
<td>2h</td>
<td>业务场景实现</td>
</tr>
</tbody></table>
<h3 id="3-3-学习成果验收"><a href="#3-3-学习成果验收" class="headerlink" title="3.3 学习成果验收"></a>3.3 学习成果验收</h3><p><strong>理论验收</strong>:</p>
<ul>
<li><input disabled="" type="checkbox"> 能解释 ACID 特性</li>
<li><input disabled="" type="checkbox"> 能说明事务的实现原理</li>
<li><input disabled="" type="checkbox"> 能理解嵌套事务机制</li>
<li><input disabled="" type="checkbox"> 能对比不同隔离级别</li>
</ul>
<p><strong>实践验收</strong>:</p>
<ul>
<li><input disabled="" type="checkbox"> 能使用 Transaction API</li>
<li><input disabled="" type="checkbox"> 能手动控制事务</li>
<li><input disabled="" type="checkbox"> 能使用嵌套事务</li>
<li><input disabled="" type="checkbox"> 能处理事务错误</li>
</ul>
<p><strong>综合验收</strong>:</p>
<ul>
<li><input disabled="" type="checkbox"> 能设计业务事务</li>
<li><input disabled="" type="checkbox"> 能优化事务性能</li>
<li><input disabled="" type="checkbox"> 能排查事务问题</li>
<li><input disabled="" type="checkbox"> 能向他人讲解事务系统</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a target="_blank" rel="noopener" href="https://github.com/Piwriw">Joohwan.</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://piwriw.github.io/2026/01/11/web/gorm/07-transaction/">https://piwriw.github.io/2026/01/11/web/gorm/07-transaction/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://piwriw.github.io" target="_blank">Joohwan</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/web/">web</a><a class="post-meta__tags" href="/tags/Gorm/">Gorm</a><a class="post-meta__tags" href="/tags/%E6%BA%90%E7%A0%81/">源码</a></div><div class="post-share"><div class="social-share" data-image="/img/go.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>赞助</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2026/01/11/web/gorm/08-migration/" title="Gorm-迁移功能模块原理说明"><img class="cover" src="/img/go.png" onerror="onerror=null;src='/img/404.png'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">Gorm-迁移功能模块原理说明</div></div><div class="info-2"><div class="info-item-1">迁移功能模块原理说明 基于1.31 本文档深入解析迁移功能模块的设计原理和核心实现，涵盖数据库结构管理、类型映射、约束管理等核心内容。学习完本文档后，您将能够彻底理解 GORM 迁移系统的工作机制，并能够在实际项目中安全高效地进行数据库迁移。  文档目录1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798991001011021031041051061071081091101111121131141151161171181191201211221231241251261271281291301311321331341351361371381391401411421431441451461471481491501511521531541551561571581591...</div></div></div></a><a class="pagination-related" href="/2026/01/11/web/gorm/06-associations/" title="Gorm-关联关系模块原理说明"><img class="cover" src="/img/go.png" onerror="onerror=null;src='/img/404.png'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">Gorm-关联关系模块原理说明</div></div><div class="info-2"><div class="info-item-1">关联关系模块原理说明  基于1.31 本文档深入解析关联关系模块的设计原理和核心实现，涵盖关系推断、预加载机制、N+1 问题解决、Association API 等核心内容。通过阅读本文档，您将能够完全理解 GORM 关联关系模块的工作原理，无需额外阅读源码。   目录 一、设计原理 1.1 模块定位 1.2 设计目的 1.3 结构安排依据 1.4 与其他模块的逻辑关系   二、核心数据结构 2.1 Relationship 结构完整解析 2.2 Relationships 结构 2.3 Reference 结构 2.4 Polymorphic 结构   三、关系推断机制 3.1 parseRelation 函数完整实现 3.2 guessRelation 函数完整实现 3.3 buildPolymorphicRelation 实现 3.4 buildMany2ManyRelation 实现 3.5 关系推断决策树   四、预加载机制 4.1 preloadEntryPoint 完整实现 4.2 preload 函数完整实现 4.3 Preload 执行流程图 4.4 嵌套预加载...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2026/01/11/web/gorm/09-logger/" title="Gorm-日志系统模块原理说明"><img class="cover" src="/img/go.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-01-11</div><div class="info-item-2">Gorm-日志系统模块原理说明</div></div><div class="info-2"><div class="info-item-1">日志系统模块原理说明 基于1.31 本文档深入解析日志系统模块的设计原理和核心实现，涵盖 SQL 日志记录、性能分析、调用栈追踪等核心内容。学习完本文档后，您将能够彻底理解 GORM 日志系统的工作机制，并能够实现自定义 Logger 来满足各种日志需求。  文档目录12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394959697989910010110210310410510610710810911011111211311411511611711811912012112212312412512612712812913013113213313413513613713813914009-logger.md├── 一、设计原理│   ├── 1.1 模块定位│   ├── 1.2 设...</div></div></div></a><a class="pagination-related" href="/2026/01/11/web/gorm/08-migration/" title="Gorm-迁移功能模块原理说明"><img class="cover" src="/img/go.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-01-11</div><div class="info-item-2">Gorm-迁移功能模块原理说明</div></div><div class="info-2"><div class="info-item-1">迁移功能模块原理说明 基于1.31 本文档深入解析迁移功能模块的设计原理和核心实现，涵盖数据库结构管理、类型映射、约束管理等核心内容。学习完本文档后，您将能够彻底理解 GORM 迁移系统的工作机制，并能够在实际项目中安全高效地进行数据库迁移。  文档目录1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798991001011021031041051061071081091101111121131141151161171181191201211221231241251261271281291301311321331341351361371381391401411421431441451461471481491501511521531541551561571581591...</div></div></div></a><a class="pagination-related" href="/2026/01/11/web/gorm/10-plugin/" title="Gorm-插件系统模块原理说明"><img class="cover" src="/img/go.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-01-11</div><div class="info-item-2">Gorm-插件系统模块原理说明</div></div><div class="info-2"><div class="info-item-1">插件系统模块原理说明 基于1.31 本文档深入解析插件系统模块的设计原理和核心实现，涵盖扩展机制、插件开发、集成模式等核心内容。  目录 一、设计原理 1.1 模块定位 1.2 设计目的 1.3 结构安排依据 1.4 与其他模块的逻辑关系 1.5 插件类型分类   二、核心数据结构 2.1 Plugin 接口 2.2 Config 插件字段 2.3 Use() 方法   三、核心实现 3.1 插件注册机制 3.2 插件初始化流程 3.3 回调系统集成 3.4 插件状态管理   四、实战代码示例 4.1 基础插件开发 4.2 读写分离插件 4.3 查询缓存插件 4.4 性能监控插件 4.5 数据脱敏插件   五、可视化流程图 5.1 插件注册流程 5.2 插件初始化流程 5.3 回调集成流程 5.4 插件系统架构   六、最佳实践与故障排查 6.1 开发最佳实践 6.2 常见问题与解决方案 6.3 性能优化建议 6.4 安全建议   七、学习验证 7.1 知识自测 7.2 实践练习     一、设计原理1.1 模块定位在整体架构中的位置 插件系统是 GORM 的扩展机制，位于应用层...</div></div></div></a><a class="pagination-related" href="/2026/01/11/web/gorm/06-associations/" title="Gorm-关联关系模块原理说明"><img class="cover" src="/img/go.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-01-11</div><div class="info-item-2">Gorm-关联关系模块原理说明</div></div><div class="info-2"><div class="info-item-1">关联关系模块原理说明  基于1.31 本文档深入解析关联关系模块的设计原理和核心实现，涵盖关系推断、预加载机制、N+1 问题解决、Association API 等核心内容。通过阅读本文档，您将能够完全理解 GORM 关联关系模块的工作原理，无需额外阅读源码。   目录 一、设计原理 1.1 模块定位 1.2 设计目的 1.3 结构安排依据 1.4 与其他模块的逻辑关系   二、核心数据结构 2.1 Relationship 结构完整解析 2.2 Relationships 结构 2.3 Reference 结构 2.4 Polymorphic 结构   三、关系推断机制 3.1 parseRelation 函数完整实现 3.2 guessRelation 函数完整实现 3.3 buildPolymorphicRelation 实现 3.4 buildMany2ManyRelation 实现 3.5 关系推断决策树   四、预加载机制 4.1 preloadEntryPoint 完整实现 4.2 preload 函数完整实现 4.3 Preload 执行流程图 4.4 嵌套预加载...</div></div></div></a><a class="pagination-related" href="/2026/01/11/web/gorm/05-callback/" title="Gorm-回调钩子模块原理说明"><img class="cover" src="/img/go.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-01-11</div><div class="info-item-2">Gorm-回调钩子模块原理说明</div></div><div class="info-2"><div class="info-item-1">回调钩子模块原理说明 基于1.31 本文档深入解析回调钩子模块的设计原理和核心原理，涵盖事件驱动机制、责任链模式、钩子注册与执行等核心内容。   一、设计原理1.1 模块定位在整体架构中的位置 回调钩子模块是 GORM 的事件驱动层，位于查询构建和 SQL 执行之间，负责在数据操作的生命周期中插入自定义逻辑。 1234567891011121314151617181920212223242526272829303132333435┌─────────────────────────────────────────────────────────────┐│                    Finisher API                              ││                      db.Find(&amp;users)                         │└────────────────────────┬────────────────────────────────────┘                      ...</div></div></div></a><a class="pagination-related" href="/2026/01/11/web/gorm/04-clause/" title="Gorm-子句系统模块原理说明"><img class="cover" src="/img/go.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-01-11</div><div class="info-item-2">Gorm-子句系统模块原理说明</div></div><div class="info-2"><div class="info-item-1">子句系统模块原理说明 基于1.31 本文档深入解析子句系统模块的设计原理和核心原理，阐述 SQL 组件化构建的理论基础。   一、设计原理1.1 模块定位在整体架构中的位置 子句系统是 GORM SQL 构建的核心组件化引擎，位于 Statement 层之下，直接负责将用户意图转换为 SQL 片段。 1234567891011121314151617181920212223242526┌─────────────────────────────────────────────────────────────┐│                   用户 API 调用                               ││  db.Where(&quot;age &gt; ?&quot;, 18).Order(&quot;name&quot;).Limit(10)           │└────────────────────────┬────────────────────────────────────┘                         │ 解析意图...</div></div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Joohwan.</div><div class="author-info-description">该知道的都知道，不知道的慢慢了解</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">259</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">76</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">60</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/piwriw"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/piwriw" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:piwriw@163.com" target="_blank" title="Email"><i class="fas fa-envelope-open-text"></i></a></div></div><div class="card-widget"><div class="item-headline"><i class="iconfont icat-visitor"></i><span>来访者</span></div><div class="item-content"><div id="welcome-info"></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E5%A4%84%E7%90%86%E6%A8%A1%E5%9D%97%E5%8E%9F%E7%90%86%E8%AF%B4%E6%98%8E"><span class="toc-number">1.</span> <span class="toc-text">事务处理模块原理说明</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%AE%E5%BD%95"><span class="toc-number">1.1.</span> <span class="toc-text">目录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E8%AE%BE%E8%AE%A1%E5%8E%9F%E7%90%86"><span class="toc-number">1.2.</span> <span class="toc-text">一、设计原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E6%A8%A1%E5%9D%97%E5%AE%9A%E4%BD%8D"><span class="toc-number">1.2.1.</span> <span class="toc-text">1.1 模块定位</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E8%AE%BE%E8%AE%A1%E7%9B%AE%E7%9A%84"><span class="toc-number">1.2.2.</span> <span class="toc-text">1.2 设计目的</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-%E7%BB%93%E6%9E%84%E5%AE%89%E6%8E%92%E4%BE%9D%E6%8D%AE"><span class="toc-number">1.2.3.</span> <span class="toc-text">1.3 结构安排依据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-%E4%B8%8E%E5%85%B6%E4%BB%96%E6%A8%A1%E5%9D%97%E7%9A%84%E9%80%BB%E8%BE%91%E5%85%B3%E7%B3%BB"><span class="toc-number">1.2.4.</span> <span class="toc-text">1.4 与其他模块的逻辑关系</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86"><span class="toc-number">1.3.</span> <span class="toc-text">二、核心原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E5%85%B3%E9%94%AE%E6%A6%82%E5%BF%B5"><span class="toc-number">1.3.1.</span> <span class="toc-text">2.1 关键概念</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5-1-Transaction-%E7%BB%93%E6%9E%84"><span class="toc-number">1.3.1.1.</span> <span class="toc-text">概念 1: Transaction 结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5-2-Begin-Commit-Rollback"><span class="toc-number">1.3.1.2.</span> <span class="toc-text">概念 2: Begin&#x2F;Commit&#x2F;Rollback</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5-3-%E4%BF%9D%E5%AD%98%E7%82%B9-SavePoint"><span class="toc-number">1.3.1.3.</span> <span class="toc-text">概念 3: 保存点 (SavePoint)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5-4-%E9%BB%98%E8%AE%A4%E4%BA%8B%E5%8A%A1%E6%9C%BA%E5%88%B6"><span class="toc-number">1.3.1.4.</span> <span class="toc-text">概念 4: 默认事务机制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5-5-%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E4%B8%8E-Panic-%E6%81%A2%E5%A4%8D"><span class="toc-number">1.3.1.5.</span> <span class="toc-text">概念 5: 错误处理与 Panic 恢复</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E7%90%86%E8%AE%BA%E5%9F%BA%E7%A1%80"><span class="toc-number">1.3.2.</span> <span class="toc-text">2.2 理论基础</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%90%86%E8%AE%BA-1-ACID-%E7%89%B9%E6%80%A7"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">理论 1: ACID 特性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%90%86%E8%AE%BA-2-%E4%BF%9D%E5%AD%98%E7%82%B9%E5%8E%9F%E7%90%86"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">理论 2: 保存点原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%90%86%E8%AE%BA-3-%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB"><span class="toc-number">1.3.2.3.</span> <span class="toc-text">理论 3: 隔离级别</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E5%AD%A6%E4%B9%A0%E6%96%B9%E6%B3%95"><span class="toc-number">1.3.3.</span> <span class="toc-text">2.3 学习方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%B3%95-1-%E5%AE%9E%E9%AA%8C%E6%B3%95"><span class="toc-number">1.3.3.1.</span> <span class="toc-text">方法 1: 实验法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%B3%95-2-%E5%AF%B9%E6%AF%94%E6%B3%95"><span class="toc-number">1.3.3.2.</span> <span class="toc-text">方法 2: 对比法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%B3%95-3-%E5%9C%BA%E6%99%AF%E6%B3%95"><span class="toc-number">1.3.3.3.</span> <span class="toc-text">方法 3: 场景法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-%E5%AE%9E%E6%96%BD%E7%AD%96%E7%95%A5"><span class="toc-number">1.3.4.</span> <span class="toc-text">2.4 实施策略</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AD%96%E7%95%A5-1-%E5%88%86%E5%B1%82%E5%AD%A6%E4%B9%A0"><span class="toc-number">1.3.4.1.</span> <span class="toc-text">策略 1: 分层学习</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AD%96%E7%95%A5-2-%E9%97%AE%E9%A2%98%E9%A9%B1%E5%8A%A8"><span class="toc-number">1.3.4.2.</span> <span class="toc-text">策略 2: 问题驱动</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AD%96%E7%95%A5-3-%E9%AA%8C%E8%AF%81%E5%8F%8D%E9%A6%88"><span class="toc-number">1.3.4.3.</span> <span class="toc-text">策略 3: 验证反馈</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E6%A0%B8%E5%BF%83%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-number">1.4.</span> <span class="toc-text">二、核心数据结构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E4%BA%8B%E5%8A%A1%E7%9B%B8%E5%85%B3%E6%8E%A5%E5%8F%A3"><span class="toc-number">1.4.1.</span> <span class="toc-text">2.1 事务相关接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-TxOptions-%E9%85%8D%E7%BD%AE"><span class="toc-number">1.4.2.</span> <span class="toc-text">2.2 TxOptions 配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E4%BA%8B%E5%8A%A1%E6%A0%B8%E5%BF%83%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.5.</span> <span class="toc-text">三、事务核心实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-Transaction-%E5%87%BD%E6%95%B0%E5%AE%8C%E6%95%B4%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.5.1.</span> <span class="toc-text">3.1 Transaction 函数完整实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-Begin-%E5%87%BD%E6%95%B0%E5%AE%8C%E6%95%B4%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.5.2.</span> <span class="toc-text">3.2 Begin 函数完整实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-Commit-%E5%92%8C-Rollback-%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.5.3.</span> <span class="toc-text">3.3 Commit 和 Rollback 实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-SavePoint-%E5%92%8C-RollbackTo-%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.5.4.</span> <span class="toc-text">3.4 SavePoint 和 RollbackTo 实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-%E4%BA%8B%E5%8A%A1%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="toc-number">1.5.5.</span> <span class="toc-text">3.5 事务执行流程图</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E9%BB%98%E8%AE%A4%E4%BA%8B%E5%8A%A1%E6%9C%BA%E5%88%B6"><span class="toc-number">1.6.</span> <span class="toc-text">四、默认事务机制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-BeginTransaction-%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.6.1.</span> <span class="toc-text">4.1 BeginTransaction 实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-CommitOrRollbackTransaction-%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.6.2.</span> <span class="toc-text">4.2 CommitOrRollbackTransaction 实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-%E5%9B%9E%E8%B0%83%E6%B3%A8%E5%86%8C%E6%B5%81%E7%A8%8B"><span class="toc-number">1.6.3.</span> <span class="toc-text">4.3 回调注册流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-%E9%BB%98%E8%AE%A4%E4%BA%8B%E5%8A%A1%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="toc-number">1.6.4.</span> <span class="toc-text">4.4 默认事务流程图</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E5%AE%9E%E6%88%98%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.7.</span> <span class="toc-text">五、实战代码示例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-%E5%9F%BA%E7%A1%80%E4%BA%8B%E5%8A%A1%E4%BD%BF%E7%94%A8"><span class="toc-number">1.7.1.</span> <span class="toc-text">5.1 基础事务使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-%E5%B5%8C%E5%A5%97%E4%BA%8B%E5%8A%A1%E4%BD%BF%E7%94%A8"><span class="toc-number">1.7.2.</span> <span class="toc-text">5.2 嵌套事务使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-%E6%89%8B%E5%8A%A8%E4%BA%8B%E5%8A%A1%E6%8E%A7%E5%88%B6"><span class="toc-number">1.7.3.</span> <span class="toc-text">5.3 手动事务控制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-%E4%BF%9D%E5%AD%98%E7%82%B9%E4%BD%BF%E7%94%A8"><span class="toc-number">1.7.4.</span> <span class="toc-text">5.4 保存点使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-5-%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB%E9%85%8D%E7%BD%AE"><span class="toc-number">1.7.5.</span> <span class="toc-text">5.5 隔离级别配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-6-%E5%A4%8D%E6%9D%82%E4%B8%9A%E5%8A%A1%E5%9C%BA%E6%99%AF"><span class="toc-number">1.7.6.</span> <span class="toc-text">5.6 复杂业务场景</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E3%80%81%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E4%B8%8E%E6%95%85%E9%9A%9C%E6%8E%92%E6%9F%A5"><span class="toc-number">1.8.</span> <span class="toc-text">六、最佳实践与故障排查</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-%E9%85%8D%E7%BD%AE%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">1.8.1.</span> <span class="toc-text">6.1 配置最佳实践</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="toc-number">1.8.1.1.</span> <span class="toc-text">生产环境配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E4%BD%BF%E7%94%A8%E5%8E%9F%E5%88%99"><span class="toc-number">1.8.1.2.</span> <span class="toc-text">事务使用原则</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E4%B8%8E%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">1.8.2.</span> <span class="toc-text">6.2 常见问题与解决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%AE%E9%A2%98-1-%E4%BA%8B%E5%8A%A1%E8%B6%85%E6%97%B6"><span class="toc-number">1.8.2.1.</span> <span class="toc-text">问题 1: 事务超时</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%AE%E9%A2%98-2-%E6%AD%BB%E9%94%81"><span class="toc-number">1.8.2.2.</span> <span class="toc-text">问题 2: 死锁</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%AE%E9%A2%98-3-%E5%B5%8C%E5%A5%97%E4%BA%8B%E5%8A%A1%E5%9B%9E%E6%BB%9A%E5%BD%B1%E5%93%8D%E5%A4%96%E5%B1%82"><span class="toc-number">1.8.2.3.</span> <span class="toc-text">问题 3: 嵌套事务回滚影响外层</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%AE%E9%A2%98-4-%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB%E5%AF%BC%E8%87%B4%E7%9A%84%E5%B9%B6%E5%8F%91%E9%97%AE%E9%A2%98"><span class="toc-number">1.8.2.4.</span> <span class="toc-text">问题 4: 隔离级别导致的并发问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%AE%E9%A2%98-5-%E9%A2%84%E7%BC%96%E8%AF%91%E8%AF%AD%E5%8F%A5%E4%B8%8E%E4%BF%9D%E5%AD%98%E7%82%B9%E5%86%B2%E7%AA%81"><span class="toc-number">1.8.2.5.</span> <span class="toc-text">问题 5: 预编译语句与保存点冲突</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83%E3%80%81%E5%AD%A6%E4%B9%A0%E9%AA%8C%E8%AF%81"><span class="toc-number">1.9.</span> <span class="toc-text">七、学习验证</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-%E7%9F%A5%E8%AF%86%E8%87%AA%E6%B5%8B"><span class="toc-number">1.9.1.</span> <span class="toc-text">7.1 知识自测</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E9%A2%98"><span class="toc-number">1.9.1.1.</span> <span class="toc-text">基础题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9B%E9%98%B6%E9%A2%98"><span class="toc-number">1.9.1.2.</span> <span class="toc-text">进阶题</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-%E5%AE%9E%E8%B7%B5%E7%BB%83%E4%B9%A0"><span class="toc-number">1.9.2.</span> <span class="toc-text">7.2 实践练习</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%83%E4%B9%A0-1-%E5%AE%9E%E7%8E%B0%E8%BD%AC%E8%B4%A6%E5%8A%9F%E8%83%BD"><span class="toc-number">1.9.2.1.</span> <span class="toc-text">练习 1: 实现转账功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%83%E4%B9%A0-2-%E5%AE%9E%E7%8E%B0%E8%AE%A2%E5%8D%95%E5%88%9B%E5%BB%BA"><span class="toc-number">1.9.2.2.</span> <span class="toc-text">练习 2: 实现订单创建</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%83%E4%B9%A0-3-%E5%AE%9E%E7%8E%B0%E5%B5%8C%E5%A5%97%E4%BA%8B%E5%8A%A1%E5%9C%BA%E6%99%AF"><span class="toc-number">1.9.2.3.</span> <span class="toc-text">练习 3: 实现嵌套事务场景</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E5%AD%A6%E4%B9%A0%E8%B7%AF%E5%BE%84%E5%BB%BA%E8%AE%AE"><span class="toc-number">1.10.</span> <span class="toc-text">三、学习路径建议</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86%E6%A3%80%E6%9F%A5"><span class="toc-number">1.10.1.</span> <span class="toc-text">3.1 前置知识检查</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E5%AD%A6%E4%B9%A0%E6%97%B6%E9%97%B4%E5%88%86%E9%85%8D"><span class="toc-number">1.10.2.</span> <span class="toc-text">3.2 学习时间分配</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E5%AD%A6%E4%B9%A0%E6%88%90%E6%9E%9C%E9%AA%8C%E6%94%B6"><span class="toc-number">1.10.3.</span> <span class="toc-text">3.3 学习成果验收</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2026/01/11/web/gorm/09-logger/" title="Gorm-日志系统模块原理说明"><img src="/img/go.png" onerror="this.onerror=null;this.src='/img/404.png'" alt="Gorm-日志系统模块原理说明"/></a><div class="content"><a class="title" href="/2026/01/11/web/gorm/09-logger/" title="Gorm-日志系统模块原理说明">Gorm-日志系统模块原理说明</a><time datetime="2026-01-11T11:56:27.000Z" title="发表于 2026-01-11 19:56:27">2026-01-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2026/01/11/web/gorm/08-migration/" title="Gorm-迁移功能模块原理说明"><img src="/img/go.png" onerror="this.onerror=null;this.src='/img/404.png'" alt="Gorm-迁移功能模块原理说明"/></a><div class="content"><a class="title" href="/2026/01/11/web/gorm/08-migration/" title="Gorm-迁移功能模块原理说明">Gorm-迁移功能模块原理说明</a><time datetime="2026-01-11T10:56:27.000Z" title="发表于 2026-01-11 18:56:27">2026-01-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2026/01/11/web/gorm/10-plugin/" title="Gorm-插件系统模块原理说明"><img src="/img/go.png" onerror="this.onerror=null;this.src='/img/404.png'" alt="Gorm-插件系统模块原理说明"/></a><div class="content"><a class="title" href="/2026/01/11/web/gorm/10-plugin/" title="Gorm-插件系统模块原理说明">Gorm-插件系统模块原理说明</a><time datetime="2026-01-11T10:56:27.000Z" title="发表于 2026-01-11 18:56:27">2026-01-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2026/01/11/web/gorm/07-transaction/" title="Gorm-事务处理模块原理说明"><img src="/img/go.png" onerror="this.onerror=null;this.src='/img/404.png'" alt="Gorm-事务处理模块原理说明"/></a><div class="content"><a class="title" href="/2026/01/11/web/gorm/07-transaction/" title="Gorm-事务处理模块原理说明">Gorm-事务处理模块原理说明</a><time datetime="2026-01-11T09:56:27.000Z" title="发表于 2026-01-11 17:56:27">2026-01-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2026/01/11/web/gorm/06-associations/" title="Gorm-关联关系模块原理说明"><img src="/img/go.png" onerror="this.onerror=null;this.src='/img/404.png'" alt="Gorm-关联关系模块原理说明"/></a><div class="content"><a class="title" href="/2026/01/11/web/gorm/06-associations/" title="Gorm-关联关系模块原理说明">Gorm-关联关系模块原理说明</a><time datetime="2026-01-11T08:56:27.000Z" title="发表于 2026-01-11 16:56:27">2026-01-11</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2023 - 2026 By Joohwan.</span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
  const option = null

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://piwriw-twikoo-git-main-piwriw.vercel.app/',
      region: 'ap-shanghai',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const init = (el = document, path = location.pathname) => {
    twikoo.init({
      el: el.querySelector('#twikoo-wrap'),
      envId: 'https://piwriw-twikoo-git-main-piwriw.vercel.app/',
      region: 'ap-shanghai',
      onCommentLoaded: () => {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      },
      ...option,
      path: isShuoshuo ? path : (option && option.path) || path
    })

    

    isShuoshuo && (window.shuoshuoComment.destroyTwikoo = () => {
      if (el.children.length) {
        el.innerHTML = ''
        el.classList.add('no-comment')
      }
    })
  }

  const loadTwikoo = (el, path) => {
    if (typeof twikoo === 'object') setTimeout(() => init(el, path), 0)
    else btf.getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(() => init(el, path))
  }

  if (isShuoshuo) {
    'Twikoo' === 'Twikoo'
      ? window.shuoshuoComment = { loadComment: loadTwikoo }
      : window.loadOtherComment = loadTwikoo
    return
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script></div><script src="/js/categories.js" defer></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>