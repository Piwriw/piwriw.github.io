<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Gorm-迁移功能模块原理说明 | Joohwan</title><meta name="author" content="Joohwan."><meta name="copyright" content="Joohwan."><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="迁移功能模块原理说明 基于1.31 本文档深入解析迁移功能模块的设计原理和核心实现，涵盖数据库结构管理、类型映射、约束管理等核心内容。学习完本文档后，您将能够彻底理解 GORM 迁移系统的工作机制，并能够在实际项目中安全高效地进行数据库迁移。  文档目录1234567891011121314151617181920212223242526272829303132333435363738394041">
<meta property="og:type" content="article">
<meta property="og:title" content="Gorm-迁移功能模块原理说明">
<meta property="og:url" content="https://piwriw.github.io/2026/01/11/web/gorm/08-migration/index.html">
<meta property="og:site_name" content="Joohwan">
<meta property="og:description" content="迁移功能模块原理说明 基于1.31 本文档深入解析迁移功能模块的设计原理和核心实现，涵盖数据库结构管理、类型映射、约束管理等核心内容。学习完本文档后，您将能够彻底理解 GORM 迁移系统的工作机制，并能够在实际项目中安全高效地进行数据库迁移。  文档目录1234567891011121314151617181920212223242526272829303132333435363738394041">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://piwriw.github.io/img/go.png">
<meta property="article:published_time" content="2026-01-11T10:56:27.000Z">
<meta property="article:modified_time" content="2026-02-28T13:29:12.679Z">
<meta property="article:author" content="Joohwan.">
<meta property="article:tag" content="web">
<meta property="article:tag" content="Gorm">
<meta property="article:tag" content="源码">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://piwriw.github.io/img/go.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Gorm-迁移功能模块原理说明",
  "url": "https://piwriw.github.io/2026/01/11/web/gorm/08-migration/",
  "image": "https://piwriw.github.io/img/go.png",
  "datePublished": "2026-01-11T10:56:27.000Z",
  "dateModified": "2026-02-28T13:29:12.679Z",
  "author": [
    {
      "@type": "Person",
      "name": "Joohwan.",
      "url": "https://github.com/Piwriw"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://piwriw.github.io/2026/01/11/web/gorm/08-migration/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Gorm-迁移功能模块原理说明',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><script src="/js/welcome.js"></script><script src="https://npm.elemecdn.com/echarts@4.9.0/dist/echarts.min.js"></script><link rel="stylesheet" href="/css/categories.css"><link rel="stylesheet" href="/css/tabs.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">259</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">76</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">60</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/charts/"><i class="fa-fw fas fa-folder-open"></i><span> 文章统计</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div><div class="menus_item"><a class="site-page" href="/wish/"><i class="fa-fw fas fa-tags"></i><span> 许愿墙</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/go.png);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Joohwan</span></a><a class="nav-page-title" href="/"><span class="site-name">Gorm-迁移功能模块原理说明</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/charts/"><i class="fa-fw fas fa-folder-open"></i><span> 文章统计</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div><div class="menus_item"><a class="site-page" href="/wish/"><i class="fa-fw fas fa-tags"></i><span> 许愿墙</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Gorm-迁移功能模块原理说明</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2026-01-11T10:56:27.000Z" title="发表于 2026-01-11 18:56:27">2026-01-11</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2026-02-28T13:29:12.679Z" title="更新于 2026-02-28 21:29:12">2026-02-28</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/web/">web</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/web/gorm/">gorm</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">13.9k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>64分钟</span></span><span class="post-meta-separator">|</span><span id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="twikoo_visitors"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><div id="post-outdate-notice" data="{&quot;limitDay&quot;:365,&quot;messagePrev&quot;:&quot;It has been&quot;,&quot;messageNext&quot;:&quot;days since the last update, the content of the article may be outdated.&quot;,&quot;postUpdate&quot;:&quot;2026-02-28 21:29:12&quot;}" hidden></div><h1 id="迁移功能模块原理说明"><a href="#迁移功能模块原理说明" class="headerlink" title="迁移功能模块原理说明"></a>迁移功能模块原理说明</h1><blockquote>
<p>基于1.31 本文档深入解析迁移功能模块的设计原理和核心实现，涵盖数据库结构管理、类型映射、约束管理等核心内容。学习完本文档后，您将能够彻底理解 GORM 迁移系统的工作机制，并能够在实际项目中安全高效地进行数据库迁移。</p>
</blockquote>
<h2 id="文档目录"><a href="#文档目录" class="headerlink" title="文档目录"></a>文档目录</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line">08-migration.md</span><br><span class="line">├── 一、设计原理</span><br><span class="line">│   ├── 1.1 模块定位</span><br><span class="line">│   ├── 1.2 设计目的</span><br><span class="line">│   ├── 1.3 结构安排依据</span><br><span class="line">│   └── 1.4 与其他模块的逻辑关系</span><br><span class="line">│</span><br><span class="line">├── 二、核心数据结构</span><br><span class="line">│   ├── 2.1 Migrator 接口 (gorm.go:67-111)</span><br><span class="line">│   │   ├── 接口定义</span><br><span class="line">│   │   ├── 方法分类说明</span><br><span class="line">│   │   └── 接口设计原理</span><br><span class="line">│   ├── 2.2 ColumnType 接口 (gorm.go:34-48)</span><br><span class="line">│   │   ├── 接口定义</span><br><span class="line">│   │   ├── 方法说明</span><br><span class="line">│   │   └── 使用示例</span><br><span class="line">│   ├── 2.3 Index 接口 (gorm.go:50-57)</span><br><span class="line">│   │   ├── 接口定义</span><br><span class="line">│   │   └── 使用场景</span><br><span class="line">│   ├── 2.4 TableType 接口 (gorm.go:59-65)</span><br><span class="line">│   │   ├── 接口定义</span><br><span class="line">│   │   └── 使用场景</span><br><span class="line">│   ├── 2.5 ViewOption 结构体 (gorm.go:27-32)</span><br><span class="line">│   │   ├── 结构体定义</span><br><span class="line">│   │   └── 视图创建配置</span><br><span class="line">│   └── 2.6 Migrator 结构体 (migrator/migrator.go:33-43)</span><br><span class="line">│       │   ├── 结构体定义</span><br><span class="line">│       │   └── 配置说明</span><br><span class="line">│</span><br><span class="line">├── 三、迁移核心实现</span><br><span class="line">│   ├── 3.1 Migrator() 方法 (gorm.go:11-20)</span><br><span class="line">│   │   ├── 完整源码</span><br><span class="line">│   │   ├── 执行流程详解</span><br><span class="line">│   │   └── 调用链路图</span><br><span class="line">│   ├── 3.2 AutoMigrate() 方法 (migrator/migrator.go:120-205)</span><br><span class="line">│   │   ├── 完整源码</span><br><span class="line">│   │   ├── 执行流程详解</span><br><span class="line">│   │   ├── 增量迁移策略</span><br><span class="line">│   │   └── 流程图</span><br><span class="line">│   ├── 3.3 CreateTable() 方法 (migrator/migrator.go:214-316)</span><br><span class="line">│   │   ├── 完整源码</span><br><span class="line">│   │   ├── SQL 生成逻辑</span><br><span class="line">│   │   └── 流程图</span><br><span class="line">│   ├── 3.4 表操作方法</span><br><span class="line">│   │   ├── DropTable() (migrator/migrator.go:318-330)</span><br><span class="line">│   │   ├── HasTable() (migrator/migrator.go:332-342)</span><br><span class="line">│   │   ├── RenameTable() (migrator/migrator.go:344-370)</span><br><span class="line">│   │   └── GetTables() (migrator/migrator.go:207-212)</span><br><span class="line">│   ├── 3.5 列操作方法</span><br><span class="line">│   │   ├── AddColumn() (migrator/migrator.go:372-393)</span><br><span class="line">│   │   ├── DropColumn() (migrator/migrator.go:395-408)</span><br><span class="line">│   │   ├── AlterColumn() (migrator/migrator.go:410-425)</span><br><span class="line">│   │   ├── MigrateColumn() (migrator/migrator.go:468-592)</span><br><span class="line">│   │   ├── HasColumn() (migrator/migrator.go:427-446)</span><br><span class="line">│   │   ├── RenameColumn() (migrator/migrator.go:448-466)</span><br><span class="line">│   │   └── ColumnTypes() (migrator/migrator.go:614-641)</span><br><span class="line">│   ├── 3.6 索引操作方法</span><br><span class="line">│   │   ├── CreateIndex() (migrator/migrator.go:829-862)</span><br><span class="line">│   │   ├── DropIndex() (migrator/migrator.go:864-875)</span><br><span class="line">│   │   ├── HasIndex() (migrator/migrator.go:877-895)</span><br><span class="line">│   │   ├── RenameIndex() (migrator/migrator.go:897-905)</span><br><span class="line">│   │   ├── GetIndexes() (migrator/migrator.go:1025-1028)</span><br><span class="line">│   │   └── BuildIndexOptions() (migrator/migrator.go:802-822)</span><br><span class="line">│   ├── 3.7 约束操作方法</span><br><span class="line">│   │   ├── CreateConstraint() (migrator/migrator.go:756-770)</span><br><span class="line">│   │   ├── DropConstraint() (migrator/migrator.go:772-781)</span><br><span class="line">│   │   ├── HasConstraint() (migrator/migrator.go:783-800)</span><br><span class="line">│   │   └── GuessConstraintInterfaceAndTable() (migrator/migrator.go:698-754)</span><br><span class="line">│   ├── 3.8 视图操作方法</span><br><span class="line">│   │   ├── CreateView() (migrator/migrator.go:655-676)</span><br><span class="line">│   │   └── DropView() (migrator/migrator.go:678-681)</span><br><span class="line">│   └── 3.9 辅助方法</span><br><span class="line">│       ├── RunWithValue() (migrator/migrator.go:60-75)</span><br><span class="line">│       ├── DataTypeOf() (migrator/migrator.go:77-87)</span><br><span class="line">│       ├── FullDataTypeOf() (migrator/migrator.go:89-108)</span><br><span class="line">│       ├── CurrentTable() (migrator/migrator.go:1017-1023)</span><br><span class="line">│       └── ReorderModels() (migrator/migrator.go:913-1015)</span><br><span class="line">│</span><br><span class="line">├── 四、类型映射系统</span><br><span class="line">│   ├── 4.1 Go 类型到数据库类型映射</span><br><span class="line">│   │   ├── 基本类型映射表</span><br><span class="line">│   │   ├── 不同数据库的差异</span><br><span class="line">│   │   └── GORM 标签的影响</span><br><span class="line">│   ├── 4.2 自定义类型映射</span><br><span class="line">│   │   ├── 方式一: GORM 标签</span><br><span class="line">│   │   ├── 方式二: GormDataTypeInterface</span><br><span class="line">│   │   └── 方式三: 自定义 Dialector</span><br><span class="line">│   └── 4.3 类型比较与迁移</span><br><span class="line">│       ├── 类型比较逻辑</span><br><span class="line">│       ├── 大小比较</span><br><span class="line">│       ├── 精度比较</span><br><span class="line">│       └── 可空性比较</span><br><span class="line">│</span><br><span class="line">├── 五、实战代码示例</span><br><span class="line">│   ├── 5.1 基础迁移示例</span><br><span class="line">│   │   ├── 创建表</span><br><span class="line">│   │   ├── 修改表结构</span><br><span class="line">│   │   ├── 删除表</span><br><span class="line">│   │   └── 重命名操作</span><br><span class="line">│   ├── 5.2 列操作示例</span><br><span class="line">│   │   ├── 添加列</span><br><span class="line">│   │   ├── 修改列类型</span><br><span class="line">│   │   ├── 删除列</span><br><span class="line">│   │   └── 重命名列</span><br><span class="line">│   ├── 5.3 索引操作示例</span><br><span class="line">│   │   ├── 创建普通索引</span><br><span class="line">│   │   ├── 创建唯一索引</span><br><span class="line">│   │   ├── 创建复合索引</span><br><span class="line">│   │   └── 删除索引</span><br><span class="line">│   ├── 5.4 约束操作示例</span><br><span class="line">│   │   ├── 外键约束</span><br><span class="line">│   │   ├── 唯一约束</span><br><span class="line">│   │   ├── 检查约束</span><br><span class="line">│   │   └── 删除约束</span><br><span class="line">│   ├── 5.5 视图操作示例</span><br><span class="line">│   │   ├── 创建视图</span><br><span class="line">│   │   ├── 替换视图</span><br><span class="line">│   │   └── 删除视图</span><br><span class="line">│   ├── 5.6 完整迁移流程示例</span><br><span class="line">│   │   ├── 初始化迁移</span><br><span class="line">│   │   ├── 版本化迁移</span><br><span class="line">│   │   └── 回滚迁移</span><br><span class="line">│   └── 5.7 复杂场景示例</span><br><span class="line">│       ├── 大数据表迁移</span><br><span class="line">│       ├── 跨数据库迁移</span><br><span class="line">│       └── 生产环境迁移</span><br><span class="line">│</span><br><span class="line">├── 六、可视化流程图</span><br><span class="line">│   ├── 6.1 AutoMigrate 完整执行流程图</span><br><span class="line">│   ├── 6.2 CreateTable SQL 生成流程图</span><br><span class="line">│   ├── 6.3 MigrateColumn 决策流程图</span><br><span class="line">│   ├── 6.4 ReorderModels 拓扑排序流程图</span><br><span class="line">│   └── 6.5 迁移系统架构图</span><br><span class="line">│</span><br><span class="line">├── 七、最佳实践与故障排查</span><br><span class="line">│   ├── 7.1 配置最佳实践</span><br><span class="line">│   │   ├── 开发环境配置</span><br><span class="line">│   │   ├── 测试环境配置</span><br><span class="line">│   │   └── 生产环境配置</span><br><span class="line">│   ├── 7.2 迁移策略</span><br><span class="line">│   │   ├── 增量迁移策略</span><br><span class="line">│   │   ├── 版本化迁移策略</span><br><span class="line">│   │   └── 零停机迁移策略</span><br><span class="line">│   ├── 7.3 性能优化</span><br><span class="line">│   │   ├── 批量操作优化</span><br><span class="line">│   │   ├── 索引优化建议</span><br><span class="line">│   │   └── 大表迁移优化</span><br><span class="line">│   ├── 7.4 常见问题与解决方案</span><br><span class="line">│   │   ├── 迁移失败问题</span><br><span class="line">│   │   ├── 类型不匹配问题</span><br><span class="line">│   │   ├── 约束冲突问题</span><br><span class="line">│   │   ├── 索引创建问题</span><br><span class="line">│   │   └── 性能问题</span><br><span class="line">│   └── 7.5 安全建议</span><br><span class="line">│       ├── 备份策略</span><br><span class="line">│       ├── 回滚策略</span><br><span class="line">│       └── 权限控制</span><br><span class="line">│</span><br><span class="line">└── 八、学习验证</span><br><span class="line">    ├── 8.1 知识自测</span><br><span class="line">    │   ├── 基础题 (10 道)</span><br><span class="line">    │   ├── 进阶题 (8 道)</span><br><span class="line">    │   └── 实战题 (5 道)</span><br><span class="line">    └── 8.2 实践练习</span><br><span class="line">        ├── 练习 1: 实现自定义迁移工具</span><br><span class="line">        ├── 练习 2: 实现版本化迁移系统</span><br><span class="line">        └── 练习 3: 实现跨数据库迁移工具</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="一、设计原理"><a href="#一、设计原理" class="headerlink" title="一、设计原理"></a>一、设计原理</h2><h3 id="1-1-模块定位"><a href="#1-1-模块定位" class="headerlink" title="1.1 模块定位"></a>1.1 模块定位</h3><p><strong>在整体架构中的位置</strong></p>
<p>迁移功能模块是 GORM 的数据库结构管理层，负责将 Go 模型自动同步到数据库表结构。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│                   Go 模型定义                                │</span><br><span class="line">│  type User struct &#123;                                         │</span><br><span class="line">│      ID        uint      `gorm:&quot;primaryKey&quot;`               │</span><br><span class="line">│      Name      string    `gorm:&quot;size:100;not null&quot;`        │</span><br><span class="line">│      Email     string    `gorm:&quot;uniqueIndex&quot;`               │</span><br><span class="line">│      CreatedAt time.Time `gorm:&quot;autoCreateTime&quot;`            │</span><br><span class="line">│      UpdatedAt time.Time `gorm:&quot;autoUpdateTime&quot;`            │</span><br><span class="line">│  &#125;                                                          │</span><br><span class="line">└────────────────────────┬────────────────────────────────────┘</span><br><span class="line">                         │ Schema 解析</span><br><span class="line">                         ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│              迁移管理 (本模块) ★                              │</span><br><span class="line">│  ┌────────────────────────────────────────────────────┐     │</span><br><span class="line">│  │  AutoMigrate() - 自动迁移                             │     │</span><br><span class="line">│  │  ├─ 解析模型 Schema                                   │     │</span><br><span class="line">│  │  ├─ 对比数据库现有结构                                │     │</span><br><span class="line">│  │  ├─ 生成 DDL 语句                                     │     │</span><br><span class="line">│  │  └─ 执行 CREATE/ALTER/DROP                           │     │</span><br><span class="line">│  └────────────────────────────────────────────────────┘     │</span><br><span class="line">│                                                             │</span><br><span class="line">│  基础操作:                                                   │</span><br><span class="line">│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │</span><br><span class="line">│  │CreateTable│  │AddColumn │  │AlterColumn│  │CreateIndex│  │</span><br><span class="line">│  │ (创建表)  │  │ (添加列)  │  │ (修改列)  │  │ (创建索引)│  │</span><br><span class="line">│  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │</span><br><span class="line">└────────────────────────┬────────────────────────────────────┘</span><br><span class="line">                         │</span><br><span class="line">                         ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│                   DDL 语句执行                                │</span><br><span class="line">│  ┌────────────────────────────────────────────────────┐     │</span><br><span class="line">│  │  CREATE TABLE users (                                │     │</span><br><span class="line">│  │    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,     │     │</span><br><span class="line">│  │    name VARCHAR(100) NOT NULL,                        │     │</span><br><span class="line">│  │    email VARCHAR(255),                                │     │</span><br><span class="line">│  │    created_at TIMESTAMP,                              │     │</span><br><span class="line">│  │    updated_at TIMESTAMP                               │     │</span><br><span class="line">│  │  )                                                     │     │</span><br><span class="line">│  │                                                        │     │</span><br><span class="line">│  │  CREATE UNIQUE INDEX idx_users_email ON users(email)  │     │</span><br><span class="line">│  └────────────────────────────────────────────────────┘     │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<p><strong>核心价值</strong></p>
<p>迁移功能模块的核心价值在于：</p>
<ol>
<li><strong>自动化</strong>: 自动将 Go 结构体映射到数据库表结构</li>
<li><strong>类型安全</strong>: 通过反射保证类型映射的正确性</li>
<li><strong>增量更新</strong>: 支持表结构的增量修改而非重建</li>
<li><strong>数据库兼容</strong>: 通过 Dialector 支持多种数据库</li>
</ol>
<h3 id="1-2-设计目的"><a href="#1-2-设计目的" class="headerlink" title="1.2 设计目的"></a>1.2 设计目的</h3><p><strong>问题 1: 如何将 Go 结构体自动映射到数据库表结构？</strong></p>
<ul>
<li><strong>挑战</strong>: Go 类型与数据库类型存在差异</li>
<li><strong>挑战</strong>: 需要处理字段标签和约束</li>
<li><strong>挑战</strong>: 需要支持不同数据库的方言</li>
</ul>
<p><strong>解决方案</strong>: Schema 解析 + Dialector 适配</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 问题场景: 类型映射</span></span><br><span class="line">Go 类型              MySQL 类型         PostgreSQL 类型</span><br><span class="line"><span class="type">string</span>      →      VARCHAR(<span class="number">255</span>)       VARCHAR(<span class="number">255</span>)</span><br><span class="line"><span class="type">int</span>         →      INT                INTEGER</span><br><span class="line"><span class="type">uint</span>        →      INT UNSIGNED      BIGINT</span><br><span class="line"><span class="type">float64</span>     →      DOUBLE             DOUBLE PRECISION</span><br><span class="line">time.Time   →      TIMESTAMP          TIMESTAMPTZ</span><br><span class="line">[]<span class="type">byte</span>      →      BLOB               BYTEA</span><br><span class="line"><span class="type">bool</span>        →      TINYINT(<span class="number">1</span>)         BOOLEAN</span><br><span class="line"></span><br><span class="line"><span class="comment">// 解决方案: Dialector 接口</span></span><br><span class="line"><span class="keyword">type</span> Dialector <span class="keyword">interface</span> &#123;</span><br><span class="line">    Name() <span class="type">string</span></span><br><span class="line">    DataTypeOf(*schema.Field) <span class="type">string</span>    <span class="comment">// 类型映射</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// MySQL 实现</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d MySQL)</span></span> DataTypeOf(field *schema.Field) <span class="type">string</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> field.DataType &#123;</span><br><span class="line">    <span class="keyword">case</span> schema.String:</span><br><span class="line">        <span class="keyword">return</span> fmt.Sprintf(<span class="string">&quot;varchar(%d)&quot;</span>, field.Size)</span><br><span class="line">    <span class="keyword">case</span> schema.Int:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;int&quot;</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>问题 2: 如何实现增量迁移而不破坏现有数据？</strong></p>
<ul>
<li><strong>挑战</strong>: 生产环境不能随意删除表</li>
<li><strong>挑战</strong>: 需要检测表和列的存在性</li>
<li><strong>挑战</strong>: 需要生成安全的 DDL 语句</li>
</ul>
<p><strong>解决方案</strong>: 存在性检查 + 条件 DDL</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 问题场景: 添加新字段</span></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">    ID       <span class="type">uint</span></span><br><span class="line">    Name     <span class="type">string</span></span><br><span class="line">    Avatar   <span class="type">string</span>  <span class="comment">// 新增字段</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 不安全的迁移</span></span><br><span class="line">db.Exec(<span class="string">&quot;DROP TABLE users&quot;</span>)        <span class="comment">// 删除表！数据丢失</span></span><br><span class="line">db.Exec(<span class="string">&quot;CREATE TABLE users ...&quot;</span>) <span class="comment">// 重新创建</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 安全的增量迁移</span></span><br><span class="line">db.AutoMigrate(&amp;User&#123;&#125;)</span><br><span class="line"><span class="comment">// 实际执行:</span></span><br><span class="line"><span class="comment">// 1. 检查 users 表是否存在</span></span><br><span class="line"><span class="comment">// 2. 如果不存在，创建表</span></span><br><span class="line"><span class="comment">// 3. 如果存在，检查每个字段</span></span><br><span class="line"><span class="comment">// 4. 只添加 avatar 字段: ALTER TABLE users ADD COLUMN avatar VARCHAR(255)</span></span><br></pre></td></tr></table></figure>

<p><strong>问题 3: 如何处理数据库之间的方言差异？</strong></p>
<ul>
<li><strong>挑战</strong>: 不同数据库的 SQL 语法不同</li>
<li><strong>挑战</strong>: 类型映射存在差异</li>
<li><strong>挑战</strong>: 约束语法不同</li>
</ul>
<p><strong>解决方案</strong>: Dialector 抽象层</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 方言差异示例</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 自增主键</span></span><br><span class="line">MySQL:     id BIGINT AUTO_INCREMENT PRIMARY KEY</span><br><span class="line">PostgreSQL: id BIGSERIAL PRIMARY KEY</span><br><span class="line">SQLite:    id INTEGER PRIMARY KEY AUTOINCREMENT</span><br><span class="line"></span><br><span class="line"><span class="comment">// 当前时间</span></span><br><span class="line">MySQL:     DEFAULT CURRENT_TIMESTAMP</span><br><span class="line">PostgreSQL: DEFAULT CURRENT_TIMESTAMP()</span><br><span class="line">SQLite:    DEFAULT (datetime(<span class="string">&#x27;now&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 索引</span></span><br><span class="line">MySQL:     CREATE INDEX idx_name ON table(column)</span><br><span class="line">PostgreSQL: CREATE INDEX idx_name ON table(column)</span><br><span class="line">SQLite:    CREATE INDEX idx_name IF NOT EXISTS ON table(column)</span><br></pre></td></tr></table></figure>

<h3 id="1-3-结构安排依据"><a href="#1-3-结构安排依据" class="headerlink" title="1.3 结构安排依据"></a>1.3 结构安排依据</h3><p><strong>3 天学习时间的科学分配</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Day 1: 迁移基础 (核心概念)</span><br><span class="line">  目标: 理解迁移的基本概念和使用</span><br><span class="line">  重点:</span><br><span class="line">    - AutoMigrate API</span><br><span class="line">    - Migrator 接口</span><br><span class="line">    - 类型映射</span><br><span class="line"></span><br><span class="line">Day 2: 高级迁移 (核心机制)</span><br><span class="line">  目标: 理解迁移的内部实现</span><br><span class="line">  重点:</span><br><span class="line">    - 增量迁移策略</span><br><span class="line">    - 约束管理</span><br><span class="line">    - 索引管理</span><br><span class="line"></span><br><span class="line">Day 3: 生产实践 (最佳实践)</span><br><span class="line">  目标: 掌握生产环境的迁移策略</span><br><span class="line">  重点:</span><br><span class="line">    - 版本化迁移</span><br><span class="line">    - 迁移回滚</span><br><span class="line">    - 安全迁移</span><br></pre></td></tr></table></figure>

<p><strong>由浅入深的学习路径</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">第 1 层: 使用层 (如何使用)</span><br><span class="line">  ├─ AutoMigrate 基本用法</span><br><span class="line">  ├─ Migrator API</span><br><span class="line">  └─ 字段标签配置</span><br><span class="line"></span><br><span class="line">第 2 层: 机制层 (如何工作)</span><br><span class="line">  ├─ Schema 如何解析</span><br><span class="line">  ├─ 类型如何映射</span><br><span class="line">  └─ DDL 如何生成</span><br><span class="line"></span><br><span class="line">第 3 层: 原理层 (为什么这样设计)</span><br><span class="line">  ├─ 数据库方言抽象</span><br><span class="line">  ├─ 增量迁移策略</span><br><span class="line">  └─ 迁移安全性</span><br></pre></td></tr></table></figure>

<h3 id="1-4-与其他模块的逻辑关系"><a href="#1-4-与其他模块的逻辑关系" class="headerlink" title="1.4 与其他模块的逻辑关系"></a>1.4 与其他模块的逻辑关系</h3><p><strong>依赖关系</strong></p>
<ul>
<li><strong>依赖 Schema</strong>: 需要解析模型的元数据</li>
<li><strong>依赖 Dialector</strong>: 需要数据库特定的实现</li>
<li><strong>依赖查询构建</strong>: 执行 DDL 语句</li>
</ul>
<p><strong>支撑关系</strong></p>
<ul>
<li><strong>支撑开发效率</strong>: 简化数据库结构管理</li>
<li><strong>支撑数据库兼容</strong>: 屏蔽数据库差异</li>
</ul>
<p><strong>模块交互图</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">迁移模块 ↔ 其他模块:</span><br><span class="line"></span><br><span class="line">┌─────────────┐</span><br><span class="line">│  Schema     │  → 提供模型元数据</span><br><span class="line">│  模块       │    - 字段信息</span><br><span class="line">└──────┬──────┘    - 关系信息</span><br><span class="line">       │</span><br><span class="line">       ▼</span><br><span class="line">┌─────────────────────────────┐</span><br><span class="line">│      迁移模块                │</span><br><span class="line">│  ┌───────────────────────┐  │</span><br><span class="line">│  │ AutoMigrate           │  │</span><br><span class="line">│  │ CreateTable/AlterTable│  │</span><br><span class="line">│  │ AddColumn/DropColumn  │  │</span><br><span class="line">│  │ CreateIndex/DropIndex │  │</span><br><span class="line">│  └───────────────────────┘  │</span><br><span class="line">└──────────┬──────────────────┘</span><br><span class="line">           │</span><br><span class="line">           ├─→ Dialector (数据库方言)</span><br><span class="line">           ├─→ 查询构建 (执行 DDL)</span><br><span class="line">           └─→ 错误处理 (迁移失败)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="二、核心数据结构"><a href="#二、核心数据结构" class="headerlink" title="二、核心数据结构"></a>二、核心数据结构</h2><h3 id="2-1-Migrator-接口-gorm-go-67-111"><a href="#2-1-Migrator-接口-gorm-go-67-111" class="headerlink" title="2.1 Migrator 接口 (gorm.go:67-111)"></a>2.1 Migrator 接口 (gorm.go:67-111)</h3><h4 id="接口定义"><a href="#接口定义" class="headerlink" title="接口定义"></a>接口定义</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Migrator migrator interface</span></span><br><span class="line"><span class="keyword">type</span> Migrator <span class="keyword">interface</span> &#123;</span><br><span class="line">    <span class="comment">// === 自动迁移 ===</span></span><br><span class="line">    AutoMigrate(dst ...<span class="keyword">interface</span>&#123;&#125;) <span class="type">error</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 数据库 ===</span></span><br><span class="line">    CurrentDatabase() <span class="type">string</span></span><br><span class="line">    FullDataTypeOf(*schema.Field) clause.Expr</span><br><span class="line">    GetTypeAliases(databaseTypeName <span class="type">string</span>) []<span class="type">string</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 表操作 ===</span></span><br><span class="line">    CreateTable(dst ...<span class="keyword">interface</span>&#123;&#125;) <span class="type">error</span></span><br><span class="line">    DropTable(dst ...<span class="keyword">interface</span>&#123;&#125;) <span class="type">error</span></span><br><span class="line">    HasTable(dst <span class="keyword">interface</span>&#123;&#125;) <span class="type">bool</span></span><br><span class="line">    RenameTable(oldName, newName <span class="keyword">interface</span>&#123;&#125;) <span class="type">error</span></span><br><span class="line">    GetTables() (tableList []<span class="type">string</span>, err <span class="type">error</span>)</span><br><span class="line">    TableType(dst <span class="keyword">interface</span>&#123;&#125;) (TableType, <span class="type">error</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 列操作 ===</span></span><br><span class="line">    AddColumn(dst <span class="keyword">interface</span>&#123;&#125;, field <span class="type">string</span>) <span class="type">error</span></span><br><span class="line">    DropColumn(dst <span class="keyword">interface</span>&#123;&#125;, field <span class="type">string</span>) <span class="type">error</span></span><br><span class="line">    AlterColumn(dst <span class="keyword">interface</span>&#123;&#125;, field <span class="type">string</span>) <span class="type">error</span></span><br><span class="line">    MigrateColumn(dst <span class="keyword">interface</span>&#123;&#125;, field *schema.Field, columnType ColumnType) <span class="type">error</span></span><br><span class="line">    MigrateColumnUnique(dst <span class="keyword">interface</span>&#123;&#125;, field *schema.Field, columnType ColumnType) <span class="type">error</span></span><br><span class="line">    HasColumn(dst <span class="keyword">interface</span>&#123;&#125;, field <span class="type">string</span>) <span class="type">bool</span></span><br><span class="line">    RenameColumn(dst <span class="keyword">interface</span>&#123;&#125;, oldName, field <span class="type">string</span>) <span class="type">error</span></span><br><span class="line">    ColumnTypes(dst <span class="keyword">interface</span>&#123;&#125;) ([]ColumnType, <span class="type">error</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 视图操作 ===</span></span><br><span class="line">    CreateView(name <span class="type">string</span>, option ViewOption) <span class="type">error</span></span><br><span class="line">    DropView(name <span class="type">string</span>) <span class="type">error</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 约束操作 ===</span></span><br><span class="line">    CreateConstraint(dst <span class="keyword">interface</span>&#123;&#125;, name <span class="type">string</span>) <span class="type">error</span></span><br><span class="line">    DropConstraint(dst <span class="keyword">interface</span>&#123;&#125;, name <span class="type">string</span>) <span class="type">error</span></span><br><span class="line">    HasConstraint(dst <span class="keyword">interface</span>&#123;&#125;, name <span class="type">string</span>) <span class="type">bool</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 索引操作 ===</span></span><br><span class="line">    CreateIndex(dst <span class="keyword">interface</span>&#123;&#125;, name <span class="type">string</span>) <span class="type">error</span></span><br><span class="line">    DropIndex(dst <span class="keyword">interface</span>&#123;&#125;, name <span class="type">string</span>) <span class="type">error</span></span><br><span class="line">    HasIndex(dst <span class="keyword">interface</span>&#123;&#125;, name <span class="type">string</span>) <span class="type">bool</span></span><br><span class="line">    RenameIndex(dst <span class="keyword">interface</span>&#123;&#125;, oldName, newName <span class="type">string</span>) <span class="type">error</span></span><br><span class="line">    GetIndexes(dst <span class="keyword">interface</span>&#123;&#125;) ([]Index, <span class="type">error</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="方法分类说明"><a href="#方法分类说明" class="headerlink" title="方法分类说明"></a>方法分类说明</h4><p><strong>1. 自动迁移</strong></p>
<ul>
<li><code>AutoMigrate()</code>: 完全自动迁移，自动检测模型变化并更新数据库结构</li>
</ul>
<p><strong>2. 数据库操作</strong></p>
<ul>
<li><code>CurrentDatabase()</code>: 获取当前数据库名称</li>
<li><code>FullDataTypeOf()</code>: 获取字段的完整数据类型定义</li>
<li><code>GetTypeAliases()</code>: 获取数据库类型的别名</li>
</ul>
<p><strong>3. 表操作</strong></p>
<ul>
<li><code>CreateTable()</code>: 创建表</li>
<li><code>DropTable()</code>: 删除表</li>
<li><code>HasTable()</code>: 检查表是否存在</li>
<li><code>RenameTable()</code>: 重命名表</li>
<li><code>GetTables()</code>: 获取所有表名列表</li>
<li><code>TableType()</code>: 获取表的类型信息</li>
</ul>
<p><strong>4. 列操作</strong></p>
<ul>
<li><code>AddColumn()</code>: 添加列</li>
<li><code>DropColumn()</code>: 删除列</li>
<li><code>AlterColumn()</code>: 修改列定义</li>
<li><code>MigrateColumn()</code>: 智能迁移列（包含完整类型检查）</li>
<li><code>MigrateColumnUnique()</code>: 迁移列的 UNIQUE 约束</li>
<li><code>HasColumn()</code>: 检查列是否存在</li>
<li><code>RenameColumn()</code>: 重命名列</li>
<li><code>ColumnTypes()</code>: 获取表的所有列类型信息</li>
</ul>
<p><strong>5. 视图操作</strong></p>
<ul>
<li><code>CreateView()</code>: 创建视图</li>
<li><code>DropView()</code>: 删除视图</li>
</ul>
<p><strong>6. 约束操作</strong></p>
<ul>
<li><code>CreateConstraint()</code>: 创建约束（外键、唯一、检查等）</li>
<li><code>DropConstraint()</code>: 删除约束</li>
<li><code>HasConstraint()</code>: 检查约束是否存在</li>
</ul>
<p><strong>7. 索引操作</strong></p>
<ul>
<li><code>CreateIndex()</code>: 创建索引</li>
<li><code>DropIndex()</code>: 删除索引</li>
<li><code>HasIndex()</code>: 检查索引是否存在</li>
<li><code>RenameIndex()</code>: 重命名索引</li>
<li><code>GetIndexes()</code>: 获取表的所有索引信息</li>
</ul>
<h4 id="接口设计原理"><a href="#接口设计原理" class="headerlink" title="接口设计原理"></a>接口设计原理</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">Migrator 接口设计原理:</span><br><span class="line"></span><br><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│                    Migrator 接口层次                          │</span><br><span class="line">├─────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                               │</span><br><span class="line">│  ┌─────────────────────────────────────────────────────┐    │</span><br><span class="line">│  │             高级 API (便捷操作)                        │    │</span><br><span class="line">│  │  AutoMigrate()       → 一键自动迁移                    │    │</span><br><span class="line">│  │  MigrateColumn()     → 智能列迁移                      │    │</span><br><span class="line">│  └─────────────────────────────────────────────────────┘    │</span><br><span class="line">│                          ↓                                   │</span><br><span class="line">│  ┌─────────────────────────────────────────────────────┐    │</span><br><span class="line">│  │             中级 API (结构操作)                        │    │</span><br><span class="line">│  │  CreateTable/DropTable                              │    │</span><br><span class="line">│  │  AddColumn/DropColumn/AlterColumn                   │    │</span><br><span class="line">│  │  CreateIndex/DropIndex                              │    │</span><br><span class="line">│  │  CreateConstraint/DropConstraint                    │    │</span><br><span class="line">│  └─────────────────────────────────────────────────────┘    │</span><br><span class="line">│                          ↓                                   │</span><br><span class="line">│  ┌─────────────────────────────────────────────────────┐    │</span><br><span class="line">│  │             低级 API (检查操作)                        │    │</span><br><span class="line">│  │  HasTable/HasColumn/HasIndex/HasConstraint          │    │</span><br><span class="line">│  │  ColumnTypes/GetIndexes/GetTables                   │    │</span><br><span class="line">│  └─────────────────────────────────────────────────────┘    │</span><br><span class="line">│                                                               │</span><br><span class="line">│  设计原则:                                                    │</span><br><span class="line">│  1. 高级 API 自动化程度高，适合开发环境                      │</span><br><span class="line">│  2. 中级 API 精细控制，适合生产环境                          │</span><br><span class="line">│  3. 低级 API 用于检查和诊断                                  │</span><br><span class="line">│                                                               │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="2-2-ColumnType-接口-gorm-go-34-48"><a href="#2-2-ColumnType-接口-gorm-go-34-48" class="headerlink" title="2.2 ColumnType 接口 (gorm.go:34-48)"></a>2.2 ColumnType 接口 (gorm.go:34-48)</h3><h4 id="接口定义-1"><a href="#接口定义-1" class="headerlink" title="接口定义"></a>接口定义</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ColumnType column type interface</span></span><br><span class="line"><span class="keyword">type</span> ColumnType <span class="keyword">interface</span> &#123;</span><br><span class="line">    <span class="comment">// 获取列名</span></span><br><span class="line">    Name() <span class="type">string</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取数据库类型名称 (如: varchar)</span></span><br><span class="line">    DatabaseTypeName() <span class="type">string</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取完整列类型 (如: varchar(64))</span></span><br><span class="line">    ColumnType() (columnType <span class="type">string</span>, ok <span class="type">bool</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查是否是主键</span></span><br><span class="line">    PrimaryKey() (isPrimaryKey <span class="type">bool</span>, ok <span class="type">bool</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查是否自增</span></span><br><span class="line">    AutoIncrement() (isAutoIncrement <span class="type">bool</span>, ok <span class="type">bool</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取列长度</span></span><br><span class="line">    Length() (length <span class="type">int64</span>, ok <span class="type">bool</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取精度和小数位数</span></span><br><span class="line">    DecimalSize() (precision <span class="type">int64</span>, scale <span class="type">int64</span>, ok <span class="type">bool</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查是否可为空</span></span><br><span class="line">    Nullable() (nullable <span class="type">bool</span>, ok <span class="type">bool</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查是否唯一</span></span><br><span class="line">    Unique() (unique <span class="type">bool</span>, ok <span class="type">bool</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取 Go 扫描类型</span></span><br><span class="line">    ScanType() reflect.Type</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取注释</span></span><br><span class="line">    Comment() (value <span class="type">string</span>, ok <span class="type">bool</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取默认值</span></span><br><span class="line">    DefaultValue() (value <span class="type">string</span>, ok <span class="type">bool</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="方法说明"><a href="#方法说明" class="headerlink" title="方法说明"></a>方法说明</h4><p><strong>基础信息方法</strong></p>
<ul>
<li><code>Name()</code>: 返回列名</li>
<li><code>DatabaseTypeName()</code>: 返回数据库类型名（如 <code>varchar</code>、<code>int</code>、<code>timestamp</code>）</li>
<li><code>ColumnType()</code>: 返回完整的列类型定义（如 <code>varchar(255)</code>、<code>decimal(10,2)</code>）</li>
</ul>
<p><strong>约束相关方法</strong></p>
<ul>
<li><code>PrimaryKey()</code>: 检查是否是主键</li>
<li><code>AutoIncrement()</code>: 检查是否自增</li>
<li><code>Nullable()</code>: 检查是否可为空</li>
<li><code>Unique()</code>: 检查是否唯一</li>
</ul>
<p><strong>类型特性方法</strong></p>
<ul>
<li><code>Length()</code>: 获取字符串类型的长度</li>
<li><code>DecimalSize()</code>: 获取数值类型的精度和小数位数</li>
<li><code>ScanType()</code>: 获取对应的 Go 类型</li>
</ul>
<p><strong>元数据方法</strong></p>
<ul>
<li><code>Comment()</code>: 获取列的注释</li>
<li><code>DefaultValue()</code>: 获取列的默认值</li>
</ul>
<h4 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取表的所有列类型</span></span><br><span class="line">columnTypes, err := db.Migrator().ColumnTypes(&amp;User&#123;&#125;)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 遍历列信息</span></span><br><span class="line"><span class="keyword">for</span> _, ct := <span class="keyword">range</span> columnTypes &#123;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;列名: %s\n&quot;</span>, ct.Name())</span><br><span class="line">    fmt.Printf(<span class="string">&quot;  数据库类型: %s\n&quot;</span>, ct.DatabaseTypeName())</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> fullType, ok := ct.ColumnType(); ok &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;  完整类型: %s\n&quot;</span>, fullType)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> length, ok := ct.Length(); ok &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;  长度: %d\n&quot;</span>, length)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> precision, scale, ok := ct.DecimalSize(); ok &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;  精度: %d, 小数位: %d\n&quot;</span>, precision, scale)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> nullable, ok := ct.Nullable(); ok &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;  可为空: %v\n&quot;</span>, nullable)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> pk, ok := ct.PrimaryKey(); ok &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;  主键: %v\n&quot;</span>, pk)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> defaultValue, ok := ct.DefaultValue(); ok &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;  默认值: %s\n&quot;</span>, defaultValue)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> comment, ok := ct.Comment(); ok &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;  注释: %s\n&quot;</span>, comment)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="2-3-Index-接口-gorm-go-50-57"><a href="#2-3-Index-接口-gorm-go-50-57" class="headerlink" title="2.3 Index 接口 (gorm.go:50-57)"></a>2.3 Index 接口 (gorm.go:50-57)</h3><h4 id="接口定义-2"><a href="#接口定义-2" class="headerlink" title="接口定义"></a>接口定义</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Index 索引接口</span></span><br><span class="line"><span class="keyword">type</span> Index <span class="keyword">interface</span> &#123;</span><br><span class="line">    <span class="comment">// 获取索引所属的表名</span></span><br><span class="line">    Table() <span class="type">string</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取索引名称</span></span><br><span class="line">    Name() <span class="type">string</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取索引包含的列名列表</span></span><br><span class="line">    Columns() []<span class="type">string</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查是否是主键索引</span></span><br><span class="line">    PrimaryKey() (isPrimaryKey <span class="type">bool</span>, ok <span class="type">bool</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查是否是唯一索引</span></span><br><span class="line">    Unique() (unique <span class="type">bool</span>, ok <span class="type">bool</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取索引选项 (如: WHERE 子句、索引类型等)</span></span><br><span class="line">    Option() <span class="type">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取表的所有索引信息 (需要特定数据库实现)</span></span><br><span class="line">indexes, err := db.Migrator().GetIndexes(&amp;User&#123;&#125;)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Printf(<span class="string">&quot;获取索引失败: %v&quot;</span>, err)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 遍历索引信息</span></span><br><span class="line"><span class="keyword">for</span> _, idx := <span class="keyword">range</span> indexes &#123;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;索引名: %s\n&quot;</span>, idx.Name())</span><br><span class="line">    fmt.Printf(<span class="string">&quot;  表名: %s\n&quot;</span>, idx.Table())</span><br><span class="line">    fmt.Printf(<span class="string">&quot;  列: %v\n&quot;</span>, idx.Columns())</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> unique, ok := idx.Unique(); ok &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;  唯一索引: %v\n&quot;</span>, unique)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> pk, ok := idx.PrimaryKey(); ok &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;  主键索引: %v\n&quot;</span>, pk)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> option := idx.Option(); option != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;  选项: %s\n&quot;</span>, option)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="2-4-TableType-接口-gorm-go-59-65"><a href="#2-4-TableType-接口-gorm-go-59-65" class="headerlink" title="2.4 TableType 接口 (gorm.go:59-65)"></a>2.4 TableType 接口 (gorm.go:59-65)</h3><h4 id="接口定义-3"><a href="#接口定义-3" class="headerlink" title="接口定义"></a>接口定义</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// TableType table type interface</span></span><br><span class="line"><span class="keyword">type</span> TableType <span class="keyword">interface</span> &#123;</span><br><span class="line">    <span class="comment">// 获取 Schema 名称 (如: public, dbo 等)</span></span><br><span class="line">    Schema() <span class="type">string</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取表名</span></span><br><span class="line">    Name() <span class="type">string</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取表类型 (如: BASE TABLE, VIEW 等)</span></span><br><span class="line">    Type() <span class="type">string</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取表注释</span></span><br><span class="line">    Comment() (comment <span class="type">string</span>, ok <span class="type">bool</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="使用场景-1"><a href="#使用场景-1" class="headerlink" title="使用场景"></a>使用场景</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取表的类型信息 (需要特定数据库实现)</span></span><br><span class="line">tableType, err := db.Migrator().TableType(&amp;User&#123;&#125;)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Printf(<span class="string">&quot;获取表类型失败: %v&quot;</span>, err)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fmt.Printf(<span class="string">&quot;Schema: %s\n&quot;</span>, tableType.Schema())</span><br><span class="line">fmt.Printf(<span class="string">&quot;表名: %s\n&quot;</span>, tableType.Name())</span><br><span class="line">fmt.Printf(<span class="string">&quot;类型: %s\n&quot;</span>, tableType.Type())</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> comment, ok := tableType.Comment(); ok &#123;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;注释: %s\n&quot;</span>, comment)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="2-5-ViewOption-结构体-gorm-go-27-32"><a href="#2-5-ViewOption-结构体-gorm-go-27-32" class="headerlink" title="2.5 ViewOption 结构体 (gorm.go:27-32)"></a>2.5 ViewOption 结构体 (gorm.go:27-32)</h3><h4 id="结构体定义"><a href="#结构体定义" class="headerlink" title="结构体定义"></a>结构体定义</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ViewOption view option</span></span><br><span class="line"><span class="keyword">type</span> ViewOption <span class="keyword">struct</span> &#123;</span><br><span class="line">    Replace     <span class="type">bool</span>   <span class="comment">// If true, exec `CREATE OR REPLACE`. If false, exec `CREATE`</span></span><br><span class="line">    CheckOption <span class="type">string</span> <span class="comment">// optional. e.g. `WITH [ CASCADED | LOCAL ] CHECK OPTION`</span></span><br><span class="line">    Query       *DB    <span class="comment">// required subquery.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="视图创建配置"><a href="#视图创建配置" class="headerlink" title="视图创建配置"></a>视图创建配置</h4><p><strong>字段说明</strong></p>
<ul>
<li><code>Replace</code>: 是否使用 <code>CREATE OR REPLACE VIEW</code> 而非 <code>CREATE VIEW</code></li>
<li><code>CheckOption</code>: 可选的检查选项，如 <code>WITH CHECK OPTION</code></li>
<li><code>Query</code>: 必需的子查询，用于定义视图的内容</li>
</ul>
<h4 id="使用示例-1"><a href="#使用示例-1" class="headerlink" title="使用示例"></a>使用示例</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建基本视图</span></span><br><span class="line">q := db.Model(&amp;User&#123;&#125;).Where(<span class="string">&quot;age &gt; ?&quot;</span>, <span class="number">20</span>)</span><br><span class="line">db.Migrator().CreateView(<span class="string">&quot;adult_users&quot;</span>, gorm.ViewOption&#123;Query: q&#125;)</span><br><span class="line"><span class="comment">// 生成: CREATE VIEW `adult_users` AS SELECT * FROM `users` WHERE age &gt; 20</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建或替换视图</span></span><br><span class="line">q := db.Model(&amp;User&#123;&#125;)</span><br><span class="line">db.Migrator().CreateView(<span class="string">&quot;users_view&quot;</span>, gorm.ViewOption&#123;</span><br><span class="line">    Query:   q,</span><br><span class="line">    Replace: <span class="literal">true</span>,</span><br><span class="line">    CheckOption: <span class="string">&quot;WITH CHECK OPTION&quot;</span>,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 生成: CREATE OR REPLACE VIEW `users_view` AS SELECT * FROM `users` WITH CHECK OPTION</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除视图</span></span><br><span class="line">db.Migrator().DropView(<span class="string">&quot;adult_users&quot;</span>)</span><br><span class="line"><span class="comment">// 生成: DROP VIEW IF EXISTS `adult_users`</span></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="2-6-Migrator-结构体-migrator-migrator-go-33-43"><a href="#2-6-Migrator-结构体-migrator-migrator-go-33-43" class="headerlink" title="2.6 Migrator 结构体 (migrator&#x2F;migrator.go:33-43)"></a>2.6 Migrator 结构体 (migrator&#x2F;migrator.go:33-43)</h3><h4 id="结构体定义-1"><a href="#结构体定义-1" class="headerlink" title="结构体定义"></a>结构体定义</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Migrator m struct</span></span><br><span class="line"><span class="keyword">type</span> Migrator <span class="keyword">struct</span> &#123;</span><br><span class="line">    Config</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Config schema config</span></span><br><span class="line"><span class="keyword">type</span> Config <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// 是否在创建表之后创建索引</span></span><br><span class="line">    CreateIndexAfterCreateTable <span class="type">bool</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// GORM DB 实例</span></span><br><span class="line">    DB *gorm.DB</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 数据库方言器</span></span><br><span class="line">    gorm.Dialector</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="配置说明"><a href="#配置说明" class="headerlink" title="配置说明"></a>配置说明</h4><p><strong>CreateIndexAfterCreateTable</strong></p>
<ul>
<li><code>true</code>: 在创建表之后单独创建索引（默认行为）</li>
<li><code>false</code>: 在 CREATE TABLE 语句中包含索引定义</li>
</ul>
<p><strong>DB</strong></p>
<ul>
<li>GORM 数据库实例，用于执行 SQL 语句</li>
</ul>
<p><strong>Dialector</strong></p>
<ul>
<li>数据库方言器，处理数据库特定的语法差异</li>
</ul>
<h4 id="实现接口"><a href="#实现接口" class="headerlink" title="实现接口"></a>实现接口</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> _ gorm.Migrator = (*Migrator)(<span class="literal">nil</span>)</span><br></pre></td></tr></table></figure>

<p>这确保了 <code>migrator.Migrator</code> 实现了完整的 <code>gorm.Migrator</code> 接口。</p>
<hr>
<h2 id="三、迁移核心实现"><a href="#三、迁移核心实现" class="headerlink" title="三、迁移核心实现"></a>三、迁移核心实现</h2><h3 id="3-1-Migrator-方法-gorm-go-11-20"><a href="#3-1-Migrator-方法-gorm-go-11-20" class="headerlink" title="3.1 Migrator() 方法 (gorm.go:11-20)"></a>3.1 Migrator() 方法 (gorm.go:11-20)</h3><h4 id="完整源码"><a href="#完整源码" class="headerlink" title="完整源码"></a>完整源码</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Migrator returns migrator</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> Migrator() Migrator &#123;</span><br><span class="line">    <span class="comment">// === 获取 DB 实例 ===</span></span><br><span class="line">    tx := db.getInstance()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 应用 scopes 到 migrator ===</span></span><br><span class="line">    <span class="keyword">for</span> <span class="built_in">len</span>(tx.Statement.scopes) &gt; <span class="number">0</span> &#123;</span><br><span class="line">        tx = tx.executeScopes()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 返回方言器的 migrator ===</span></span><br><span class="line">    <span class="keyword">return</span> tx.Dialector.Migrator(tx.Session(&amp;Session&#123;&#125;))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="执行流程详解"><a href="#执行流程详解" class="headerlink" title="执行流程详解"></a>执行流程详解</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">db.Migrator() 调用流程:</span><br><span class="line"></span><br><span class="line">db.Migrator()</span><br><span class="line">    │</span><br><span class="line">    ├─► 1. getInstance()</span><br><span class="line">    │   └─ 获取 DB 实例的克隆</span><br><span class="line">    │       ├─ clone == 1: 创建新 Statement</span><br><span class="line">    │       └─ clone == 2: 克隆现有 Statement</span><br><span class="line">    │</span><br><span class="line">    ├─► 2. executeScopes()</span><br><span class="line">    │   └─ 执行所有 pending scopes</span><br><span class="line">    │       └─ 清空 scopes 列表</span><br><span class="line">    │</span><br><span class="line">    └─► 3. Dialector.Migrator()</span><br><span class="line">        └─ 调用方言器的 Migrator() 方法</span><br><span class="line">            ├─ MySQL: 返回 MySQL Migrator</span><br><span class="line">            ├─ PostgreSQL: 返回 PostgreSQL Migrator</span><br><span class="line">            └─ SQLite: 返回 SQLite Migrator</span><br></pre></td></tr></table></figure>

<h4 id="调用链路图"><a href="#调用链路图" class="headerlink" title="调用链路图"></a>调用链路图</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">用户代码</span><br><span class="line">    │</span><br><span class="line">    ▼</span><br><span class="line">db.Migrator()</span><br><span class="line">    │</span><br><span class="line">    ├─► db.getInstance()</span><br><span class="line">    │   └─ 返回 DB 克隆实例</span><br><span class="line">    │</span><br><span class="line">    ├─► executeScopes()</span><br><span class="line">    │   └─ 应用所有 scope</span><br><span class="line">    │</span><br><span class="line">    ├─► tx.Session(&amp;Session&#123;&#125;)</span><br><span class="line">    │   └─ 创建新会话</span><br><span class="line">    │</span><br><span class="line">    └─► tx.Dialector.Migrator()</span><br><span class="line">        └─ 返回数据库特定的 Migrator 实现</span><br><span class="line">            │</span><br><span class="line">            ├─ MySQL Migrator</span><br><span class="line">            ├─ PostgreSQL Migrator</span><br><span class="line">            ├─ SQLite Migrator</span><br><span class="line">            ├─ SQL Server Migrator</span><br><span class="line">            └─ 其他数据库 Migrator</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="3-2-AutoMigrate-方法-migrator-migrator-go-120-205"><a href="#3-2-AutoMigrate-方法-migrator-migrator-go-120-205" class="headerlink" title="3.2 AutoMigrate() 方法 (migrator&#x2F;migrator.go:120-205)"></a>3.2 AutoMigrate() 方法 (migrator&#x2F;migrator.go:120-205)</h3><h4 id="完整源码-1"><a href="#完整源码-1" class="headerlink" title="完整源码"></a>完整源码</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AutoMigrate auto migrate values</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m Migrator)</span></span> AutoMigrate(values ...<span class="keyword">interface</span>&#123;&#125;) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="comment">// === 遍历所有需要迁移的模型 ===</span></span><br><span class="line">    <span class="keyword">for</span> _, value := <span class="keyword">range</span> m.ReorderModels(values, <span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="comment">// === 获取查询和执行事务 ===</span></span><br><span class="line">        queryTx, execTx := m.GetQueryAndExecTx()</span><br><span class="line"></span><br><span class="line">        <span class="comment">// === 检查表是否存在 ===</span></span><br><span class="line">        <span class="keyword">if</span> !queryTx.Migrator().HasTable(value) &#123;</span><br><span class="line">            <span class="comment">// === 表不存在，创建新表 ===</span></span><br><span class="line">            <span class="keyword">if</span> err := execTx.Migrator().CreateTable(value); err != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> err</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// === 表存在，执行增量迁移 ===</span></span><br><span class="line">            <span class="keyword">if</span> err := m.RunWithValue(value, <span class="function"><span class="keyword">func</span><span class="params">(stmt *gorm.Statement)</span></span> <span class="type">error</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 验证 Schema</span></span><br><span class="line">                <span class="keyword">if</span> stmt.Schema == <span class="literal">nil</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> errors.New(<span class="string">&quot;failed to get schema&quot;</span>)</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// === 获取当前列类型 ===</span></span><br><span class="line">                columnTypes, err := queryTx.Migrator().ColumnTypes(value)</span><br><span class="line">                <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> err</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 解析索引和检查约束</span></span><br><span class="line">                <span class="keyword">var</span> (</span><br><span class="line">                    parseIndexes          = stmt.Schema.ParseIndexes()</span><br><span class="line">                    parseCheckConstraints = stmt.Schema.ParseCheckConstraints()</span><br><span class="line">                )</span><br><span class="line"></span><br><span class="line">                <span class="comment">// === 遍历所有字段 ===</span></span><br><span class="line">                <span class="keyword">for</span> _, dbName := <span class="keyword">range</span> stmt.Schema.DBNames &#123;</span><br><span class="line">                    <span class="keyword">var</span> foundColumn gorm.ColumnType</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 在当前列中查找</span></span><br><span class="line">                    <span class="keyword">for</span> _, columnType := <span class="keyword">range</span> columnTypes &#123;</span><br><span class="line">                        <span class="keyword">if</span> columnType.Name() == dbName &#123;</span><br><span class="line">                            foundColumn = columnType</span><br><span class="line">                            <span class="keyword">break</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> foundColumn == <span class="literal">nil</span> &#123;</span><br><span class="line">                        <span class="comment">// === 列不存在，添加新列 ===</span></span><br><span class="line">                        <span class="keyword">if</span> err = execTx.Migrator().AddColumn(value, dbName); err != <span class="literal">nil</span> &#123;</span><br><span class="line">                            <span class="keyword">return</span> err</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">// === 列存在，智能迁移 ===</span></span><br><span class="line">                        field := stmt.Schema.FieldsByDBName[dbName]</span><br><span class="line">                        <span class="keyword">if</span> err = execTx.Migrator().MigrateColumn(value, field, foundColumn); err != <span class="literal">nil</span> &#123;</span><br><span class="line">                            <span class="keyword">return</span> err</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// === 处理关系约束 ===</span></span><br><span class="line">                <span class="keyword">if</span> !m.DB.DisableForeignKeyConstraintWhenMigrating &amp;&amp; !m.DB.IgnoreRelationshipsWhenMigrating &#123;</span><br><span class="line">                    <span class="keyword">for</span> _, rel := <span class="keyword">range</span> stmt.Schema.Relationships.Relations &#123;</span><br><span class="line">                        <span class="keyword">if</span> rel.Field.IgnoreMigration &#123;</span><br><span class="line">                            <span class="keyword">continue</span></span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> constraint := rel.ParseConstraint(); constraint != <span class="literal">nil</span> &amp;&amp;</span><br><span class="line">                            constraint.Schema == stmt.Schema &amp;&amp; !queryTx.Migrator().HasConstraint(value, constraint.Name) &#123;</span><br><span class="line">                            <span class="keyword">if</span> err := execTx.Migrator().CreateConstraint(value, constraint.Name); err != <span class="literal">nil</span> &#123;</span><br><span class="line">                                <span class="keyword">return</span> err</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// === 处理检查约束 ===</span></span><br><span class="line">                <span class="keyword">for</span> _, chk := <span class="keyword">range</span> parseCheckConstraints &#123;</span><br><span class="line">                    <span class="keyword">if</span> !queryTx.Migrator().HasConstraint(value, chk.Name) &#123;</span><br><span class="line">                        <span class="keyword">if</span> err := execTx.Migrator().CreateConstraint(value, chk.Name); err != <span class="literal">nil</span> &#123;</span><br><span class="line">                            <span class="keyword">return</span> err</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// === 处理索引 ===</span></span><br><span class="line">                <span class="keyword">for</span> _, idx := <span class="keyword">range</span> parseIndexes &#123;</span><br><span class="line">                    <span class="keyword">if</span> !queryTx.Migrator().HasIndex(value, idx.Name) &#123;</span><br><span class="line">                        <span class="keyword">if</span> err := execTx.Migrator().CreateIndex(value, idx.Name); err != <span class="literal">nil</span> &#123;</span><br><span class="line">                            <span class="keyword">return</span> err</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">            &#125;); err != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> err</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="执行流程详解-1"><a href="#执行流程详解-1" class="headerlink" title="执行流程详解"></a>执行流程详解</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">AutoMigrate 完整执行流程:</span><br><span class="line"></span><br><span class="line">AutoMigrate(values ...)</span><br><span class="line">    │</span><br><span class="line">    ├─► 1. ReorderModels(values, true)</span><br><span class="line">    │   └─ 按依赖关系排序模型</span><br><span class="line">    │       ├─ 分析外键依赖</span><br><span class="line">    │       ├─ 分析关联关系</span><br><span class="line">    │       └─ 返回拓扑排序后的模型列表</span><br><span class="line">    │</span><br><span class="line">    └─► 2. 遍历每个模型</span><br><span class="line">        │</span><br><span class="line">        ├─► GetQueryAndExecTx()</span><br><span class="line">        │   ├─ queryTx: 用于查询 (检查表/列/索引/约束是否存在)</span><br><span class="line">        │   └─ execTx: 用于执行 (执行 DDL 语句)</span><br><span class="line">        │</span><br><span class="line">        ├─► 3a. 表不存在 → CreateTable()</span><br><span class="line">        │   └─ 创建完整的表结构</span><br><span class="line">        │       ├─ 创建所有列</span><br><span class="line">        │       ├─ 创建主键</span><br><span class="line">        │       ├─ 创建外键约束</span><br><span class="line">        │       └─ 创建索引</span><br><span class="line">        │</span><br><span class="line">        └─► 3b. 表存在 → 增量迁移</span><br><span class="line">            │</span><br><span class="line">            ├─► 3b-1. 获取当前列类型</span><br><span class="line">            │   └─ ColumnTypes(value)</span><br><span class="line">            │</span><br><span class="line">            ├─► 3b-2. 遍历所有字段</span><br><span class="line">            │   │</span><br><span class="line">            │   ├─► 列不存在 → AddColumn()</span><br><span class="line">            │   │   └─ ALTER TABLE ADD COLUMN</span><br><span class="line">            │   │</span><br><span class="line">            │   └─► 列存在 → MigrateColumn()</span><br><span class="line">            │       ├─ 比较类型</span><br><span class="line">            │       ├─ 比较大小</span><br><span class="line">            │       ├─ 比较精度</span><br><span class="line">            │       ├─ 比较可空性</span><br><span class="line">            │       ├─ 比较默认值</span><br><span class="line">            │       └─ 需要时 → AlterColumn()</span><br><span class="line">            │</span><br><span class="line">            ├─► 3b-3. 处理关系约束</span><br><span class="line">            │   └─ 遍历 Relationships.Relations</span><br><span class="line">            │       └─ CreateConstraint()</span><br><span class="line">            │</span><br><span class="line">            ├─► 3b-4. 处理检查约束</span><br><span class="line">            │   └─ 遍历 ParseCheckConstraints()</span><br><span class="line">            │       └─ CreateConstraint()</span><br><span class="line">            │</span><br><span class="line">            └─► 3b-5. 处理索引</span><br><span class="line">                └─ 遍历 ParseIndexes()</span><br><span class="line">                    └─ CreateIndex()</span><br></pre></td></tr></table></figure>

<h4 id="增量迁移策略"><a href="#增量迁移策略" class="headerlink" title="增量迁移策略"></a>增量迁移策略</h4><p><strong>核心原则</strong></p>
<ol>
<li><strong>只添加，不删除</strong>: AutoMigrate 只添加缺失的列&#x2F;索引&#x2F;约束，不会删除任何东西</li>
<li><strong>智能比较</strong>: 在修改前比较现有定义，避免不必要的 ALTER 操作</li>
<li><strong>安全第一</strong>: 使用查询事务先检查，再用执行事务修改</li>
</ol>
<p><strong>增量迁移决策树</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">对于每个字段:</span><br><span class="line">    │</span><br><span class="line">    ├─ 列不存在?</span><br><span class="line">    │   ├─ Yes → AddColumn()</span><br><span class="line">    │   └─ No  → 继续</span><br><span class="line">    │</span><br><span class="line">    ├─ 类型需要修改?</span><br><span class="line">    │   ├─ Yes → AlterColumn()</span><br><span class="line">    │   └─ No  → 继续</span><br><span class="line">    │</span><br><span class="line">    ├─ 大小需要修改?</span><br><span class="line">    │   ├─ Yes → AlterColumn()</span><br><span class="line">    │   └─ No  → 继续</span><br><span class="line">    │</span><br><span class="line">    ├─ 精度需要修改?</span><br><span class="line">    │   ├─ Yes → AlterColumn()</span><br><span class="line">    │   └─ No  → 继续</span><br><span class="line">    │</span><br><span class="line">    ├─ 可空性需要修改?</span><br><span class="line">    │   ├─ Yes → AlterColumn()</span><br><span class="line">    │   └─ No  → 继续</span><br><span class="line">    │</span><br><span class="line">    ├─ 默认值需要修改?</span><br><span class="line">    │   ├─ Yes → AlterColumn()</span><br><span class="line">    │   └─ No  → 继续</span><br><span class="line">    │</span><br><span class="line">    └─ 注释需要修改?</span><br><span class="line">        ├─ Yes → AlterColumn()</span><br><span class="line">        └─ No  → 跳过</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="3-3-CreateTable-方法-migrator-migrator-go-214-316"><a href="#3-3-CreateTable-方法-migrator-migrator-go-214-316" class="headerlink" title="3.3 CreateTable() 方法 (migrator&#x2F;migrator.go:214-316)"></a>3.3 CreateTable() 方法 (migrator&#x2F;migrator.go:214-316)</h3><h4 id="完整源码-2"><a href="#完整源码-2" class="headerlink" title="完整源码"></a>完整源码</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CreateTable create table in database for values</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m Migrator)</span></span> CreateTable(values ...<span class="keyword">interface</span>&#123;&#125;) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> _, value := <span class="keyword">range</span> m.ReorderModels(values, <span class="literal">false</span>) &#123;</span><br><span class="line">        tx := m.DB.Session(&amp;gorm.Session&#123;&#125;)</span><br><span class="line">        <span class="keyword">if</span> err := m.RunWithValue(value, <span class="function"><span class="keyword">func</span><span class="params">(stmt *gorm.Statement)</span></span> (err <span class="type">error</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> stmt.Schema == <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> errors.New(<span class="string">&quot;failed to get schema&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> (</span><br><span class="line">                createTableSQL          = <span class="string">&quot;CREATE TABLE ? (&quot;</span></span><br><span class="line">                values                  = []<span class="keyword">interface</span>&#123;&#125;&#123;m.CurrentTable(stmt)&#125;</span><br><span class="line">                hasPrimaryKeyInDataType <span class="type">bool</span></span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">            <span class="comment">// === 添加所有列定义 ===</span></span><br><span class="line">            <span class="keyword">for</span> _, dbName := <span class="keyword">range</span> stmt.Schema.DBNames &#123;</span><br><span class="line">                field := stmt.Schema.FieldsByDBName[dbName]</span><br><span class="line">                <span class="keyword">if</span> !field.IgnoreMigration &#123;</span><br><span class="line">                    createTableSQL += <span class="string">&quot;? ?&quot;</span></span><br><span class="line">                    <span class="comment">// 检查数据类型中是否包含 PRIMARY KEY</span></span><br><span class="line">                    hasPrimaryKeyInDataType = hasPrimaryKeyInDataType || strings.Contains(strings.ToUpper(m.DataTypeOf(field)), <span class="string">&quot;PRIMARY KEY&quot;</span>)</span><br><span class="line">                    values = <span class="built_in">append</span>(values, clause.Column&#123;Name: dbName&#125;, m.DB.Migrator().FullDataTypeOf(field))</span><br><span class="line">                    createTableSQL += <span class="string">&quot;,&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// === 添加主键定义 (如果数据类型中没有) ===</span></span><br><span class="line">            <span class="keyword">if</span> !hasPrimaryKeyInDataType &amp;&amp; <span class="built_in">len</span>(stmt.Schema.PrimaryFields) &gt; <span class="number">0</span> &#123;</span><br><span class="line">                createTableSQL += <span class="string">&quot;PRIMARY KEY ?,&quot;</span></span><br><span class="line">                primaryKeys := <span class="built_in">make</span>([]<span class="keyword">interface</span>&#123;&#125;, <span class="number">0</span>, <span class="built_in">len</span>(stmt.Schema.PrimaryFields))</span><br><span class="line">                <span class="keyword">for</span> _, field := <span class="keyword">range</span> stmt.Schema.PrimaryFields &#123;</span><br><span class="line">                    primaryKeys = <span class="built_in">append</span>(primaryKeys, clause.Column&#123;Name: field.DBName&#125;)</span><br><span class="line">                &#125;</span><br><span class="line">                values = <span class="built_in">append</span>(values, primaryKeys)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// === 添加索引定义 ===</span></span><br><span class="line">            <span class="keyword">for</span> _, idx := <span class="keyword">range</span> stmt.Schema.ParseIndexes() &#123;</span><br><span class="line">                <span class="keyword">if</span> m.CreateIndexAfterCreateTable &#123;</span><br><span class="line">                    <span class="comment">// 延迟创建索引</span></span><br><span class="line">                    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">(value <span class="keyword">interface</span>&#123;&#125;, name <span class="type">string</span>)</span></span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">                            err = tx.Migrator().CreateIndex(value, name)</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;(value, idx.Name)</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// 在 CREATE TABLE 中定义索引</span></span><br><span class="line">                    <span class="keyword">if</span> idx.Class != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">                        createTableSQL += idx.Class + <span class="string">&quot; &quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    createTableSQL += <span class="string">&quot;INDEX ? ?&quot;</span></span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> idx.Comment != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">                        createTableSQL += fmt.Sprintf(<span class="string">&quot; COMMENT &#x27;%s&#x27;&quot;</span>, idx.Comment)</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> idx.Option != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">                        createTableSQL += <span class="string">&quot; &quot;</span> + idx.Option</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    createTableSQL += <span class="string">&quot;,&quot;</span></span><br><span class="line">                    values = <span class="built_in">append</span>(values, clause.Column&#123;Name: idx.Name&#125;, tx.Migrator().(BuildIndexOptionsInterface).BuildIndexOptions(idx.Fields, stmt))</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// === 添加外键约束 ===</span></span><br><span class="line">            <span class="keyword">if</span> !m.DB.DisableForeignKeyConstraintWhenMigrating &amp;&amp; !m.DB.IgnoreRelationshipsWhenMigrating &#123;</span><br><span class="line">                <span class="keyword">for</span> _, rel := <span class="keyword">range</span> stmt.Schema.Relationships.Relations &#123;</span><br><span class="line">                    <span class="keyword">if</span> rel.Field.IgnoreMigration &#123;</span><br><span class="line">                        <span class="keyword">continue</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> constraint := rel.ParseConstraint(); constraint != <span class="literal">nil</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> constraint.Schema == stmt.Schema &#123;</span><br><span class="line">                            sql, vars := constraint.Build()</span><br><span class="line">                            createTableSQL += sql + <span class="string">&quot;,&quot;</span></span><br><span class="line">                            values = <span class="built_in">append</span>(values, vars...)</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// === 添加唯一约束 ===</span></span><br><span class="line">            <span class="keyword">for</span> _, uni := <span class="keyword">range</span> stmt.Schema.ParseUniqueConstraints() &#123;</span><br><span class="line">                createTableSQL += <span class="string">&quot;CONSTRAINT ? UNIQUE (?),&quot;</span></span><br><span class="line">                values = <span class="built_in">append</span>(values, clause.Column&#123;Name: uni.Name&#125;, clause.Expr&#123;SQL: stmt.Quote(uni.Field.DBName)&#125;)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// === 添加检查约束 ===</span></span><br><span class="line">            <span class="keyword">for</span> _, chk := <span class="keyword">range</span> stmt.Schema.ParseCheckConstraints() &#123;</span><br><span class="line">                createTableSQL += <span class="string">&quot;CONSTRAINT ? CHECK (?),&quot;</span></span><br><span class="line">                values = <span class="built_in">append</span>(values, clause.Column&#123;Name: chk.Name&#125;, clause.Expr&#123;SQL: chk.Constraint&#125;)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// === 移除末尾逗号并闭合括号 ===</span></span><br><span class="line">            createTableSQL = strings.TrimSuffix(createTableSQL, <span class="string">&quot;,&quot;</span>)</span><br><span class="line">            createTableSQL += <span class="string">&quot;)&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// === 添加表选项 ===</span></span><br><span class="line">            <span class="keyword">if</span> tableOption, ok := m.DB.Get(<span class="string">&quot;gorm:table_options&quot;</span>); ok &#123;</span><br><span class="line">                createTableSQL += fmt.Sprint(tableOption)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// === 执行 CREATE TABLE ===</span></span><br><span class="line">            err = tx.Exec(createTableSQL, values...).Error</span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;); err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="SQL-生成逻辑"><a href="#SQL-生成逻辑" class="headerlink" title="SQL 生成逻辑"></a>SQL 生成逻辑</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">CreateTable SQL 生成流程:</span><br><span class="line"></span><br><span class="line">CREATE TABLE ? (</span><br><span class="line">    ? ?,          -- 列定义</span><br><span class="line">    ? ?,          -- 列定义</span><br><span class="line">    ...</span><br><span class="line">    PRIMARY KEY ?,           -- 主键 (如果需要)</span><br><span class="line">    INDEX ? ?,               -- 索引 (如果 CreateIndexAfterCreateTable = false)</span><br><span class="line">    CONSTRAINT ? FOREIGN KEY ...,  -- 外键约束</span><br><span class="line">    CONSTRAINT ? UNIQUE (?),        -- 唯一约束</span><br><span class="line">    CONSTRAINT ? CHECK (?)          -- 检查约束</span><br><span class="line">) [表选项]</span><br><span class="line"></span><br><span class="line">生成的 SQL 示例:</span><br><span class="line"></span><br><span class="line">CREATE TABLE `users` (</span><br><span class="line">    `id` bigint UNSIGNED AUTO_INCREMENT PRIMARY KEY,</span><br><span class="line">    `name` varchar(100) NOT NULL,</span><br><span class="line">    `email` varchar(255) UNIQUE,</span><br><span class="line">    `age` int DEFAULT 0,</span><br><span class="line">    `created_at` timestamp NULL,</span><br><span class="line">    `updated_at` timestamp NULL,</span><br><span class="line">    PRIMARY KEY (`id`),</span><br><span class="line">    UNIQUE INDEX `idx_users_email` (`email`),</span><br><span class="line">    INDEX `idx_users_name` (`name`),</span><br><span class="line">    CONSTRAINT `fk_users_team` FOREIGN KEY (`team_id`) REFERENCES `teams`(`id`) ON DELETE SET NULL</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="3-4-表操作方法"><a href="#3-4-表操作方法" class="headerlink" title="3.4 表操作方法"></a>3.4 表操作方法</h3><h4 id="DropTable-migrator-migrator-go-318-330"><a href="#DropTable-migrator-migrator-go-318-330" class="headerlink" title="DropTable() (migrator&#x2F;migrator.go:318-330)"></a>DropTable() (migrator&#x2F;migrator.go:318-330)</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DropTable drop table for values</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m Migrator)</span></span> DropTable(values ...<span class="keyword">interface</span>&#123;&#125;) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="comment">// 按反向依赖顺序删除</span></span><br><span class="line">    values = m.ReorderModels(values, <span class="literal">false</span>)</span><br><span class="line">    <span class="keyword">for</span> i := <span class="built_in">len</span>(values) - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i-- &#123;</span><br><span class="line">        tx := m.DB.Session(&amp;gorm.Session&#123;&#125;)</span><br><span class="line">        <span class="keyword">if</span> err := m.RunWithValue(values[i], <span class="function"><span class="keyword">func</span><span class="params">(stmt *gorm.Statement)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> tx.Exec(<span class="string">&quot;DROP TABLE IF EXISTS ?&quot;</span>, m.CurrentTable(stmt)).Error</span><br><span class="line">        &#125;); err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>关键点</strong>:</p>
<ul>
<li>使用 <code>ReorderModels()</code> 按依赖关系排序</li>
<li>反向遍历（从后往前），先删除依赖表，再删除被依赖表</li>
<li>使用 <code>IF EXISTS</code> 避免表不存在时报错</li>
</ul>
<h4 id="HasTable-migrator-migrator-go-332-342"><a href="#HasTable-migrator-migrator-go-332-342" class="headerlink" title="HasTable() (migrator&#x2F;migrator.go:332-342)"></a>HasTable() (migrator&#x2F;migrator.go:332-342)</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// HasTable returns table exists or not for value</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m Migrator)</span></span> HasTable(value <span class="keyword">interface</span>&#123;&#125;) <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> count <span class="type">int64</span></span><br><span class="line"></span><br><span class="line">    m.RunWithValue(value, <span class="function"><span class="keyword">func</span><span class="params">(stmt *gorm.Statement)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">        currentDatabase := m.DB.Migrator().CurrentDatabase()</span><br><span class="line">        <span class="keyword">return</span> m.DB.Raw(</span><br><span class="line">            <span class="string">&quot;SELECT count(*) FROM information_schema.tables &quot;</span>+</span><br><span class="line">            <span class="string">&quot;WHERE table_schema = ? AND table_name = ? AND table_type = ?&quot;</span>,</span><br><span class="line">            currentDatabase, stmt.Table, <span class="string">&quot;BASE TABLE&quot;</span>,</span><br><span class="line">        ).Row().Scan(&amp;count)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> count &gt; <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>查询说明</strong>:</p>
<ul>
<li>查询 <code>information_schema.tables</code> 系统表</li>
<li>过滤条件: 数据库名、表名、表类型为 BASE TABLE</li>
<li>返回 <code>count &gt; 0</code></li>
</ul>
<h4 id="RenameTable-migrator-migrator-go-344-370"><a href="#RenameTable-migrator-migrator-go-344-370" class="headerlink" title="RenameTable() (migrator&#x2F;migrator.go:344-370)"></a>RenameTable() (migrator&#x2F;migrator.go:344-370)</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RenameTable rename table from oldName to newName</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m Migrator)</span></span> RenameTable(oldName, newName <span class="keyword">interface</span>&#123;&#125;) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> oldTable, newTable <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理旧表名</span></span><br><span class="line">    <span class="keyword">if</span> v, ok := oldName.(<span class="type">string</span>); ok &#123;</span><br><span class="line">        oldTable = clause.Table&#123;Name: v&#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        stmt := &amp;gorm.Statement&#123;DB: m.DB&#125;</span><br><span class="line">        <span class="keyword">if</span> err := stmt.Parse(oldName); err == <span class="literal">nil</span> &#123;</span><br><span class="line">            oldTable = m.CurrentTable(stmt)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理新表名</span></span><br><span class="line">    <span class="keyword">if</span> v, ok := newName.(<span class="type">string</span>); ok &#123;</span><br><span class="line">        newTable = clause.Table&#123;Name: v&#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        stmt := &amp;gorm.Statement&#123;DB: m.DB&#125;</span><br><span class="line">        <span class="keyword">if</span> err := stmt.Parse(newName); err == <span class="literal">nil</span> &#123;</span><br><span class="line">            newTable = m.CurrentTable(stmt)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> m.DB.Exec(<span class="string">&quot;ALTER TABLE ? RENAME TO ?&quot;</span>, oldTable, newTable).Error</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>灵活性</strong>:</p>
<ul>
<li><code>oldName</code> 和 <code>newName</code> 可以是字符串或结构体</li>
<li>如果是字符串，直接用作表名</li>
<li>如果是结构体，解析其 Schema 获取表名</li>
</ul>
<hr>
<h3 id="3-5-列操作方法"><a href="#3-5-列操作方法" class="headerlink" title="3.5 列操作方法"></a>3.5 列操作方法</h3><h4 id="AddColumn-migrator-migrator-go-372-393"><a href="#AddColumn-migrator-migrator-go-372-393" class="headerlink" title="AddColumn() (migrator&#x2F;migrator.go:372-393)"></a>AddColumn() (migrator&#x2F;migrator.go:372-393)</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AddColumn create `name` column for value</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m Migrator)</span></span> AddColumn(value <span class="keyword">interface</span>&#123;&#125;, name <span class="type">string</span>) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> m.RunWithValue(value, <span class="function"><span class="keyword">func</span><span class="params">(stmt *gorm.Statement)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> stmt.Schema == <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> errors.New(<span class="string">&quot;failed to get schema&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 查找字段定义</span></span><br><span class="line">        f := stmt.Schema.LookUpField(name)</span><br><span class="line">        <span class="keyword">if</span> f == <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to look up field with name: %s&quot;</span>, name)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> !f.IgnoreMigration &#123;</span><br><span class="line">            <span class="keyword">return</span> m.DB.Exec(</span><br><span class="line">                <span class="string">&quot;ALTER TABLE ? ADD ? ?&quot;</span>,</span><br><span class="line">                m.CurrentTable(stmt),</span><br><span class="line">                clause.Column&#123;Name: f.DBName&#125;,</span><br><span class="line">                m.DB.Migrator().FullDataTypeOf(f),</span><br><span class="line">            ).Error</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="DropColumn-migrator-migrator-go-395-408"><a href="#DropColumn-migrator-migrator-go-395-408" class="headerlink" title="DropColumn() (migrator&#x2F;migrator.go:395-408)"></a>DropColumn() (migrator&#x2F;migrator.go:395-408)</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DropColumn drop value&#x27;s `name` column</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m Migrator)</span></span> DropColumn(value <span class="keyword">interface</span>&#123;&#125;, name <span class="type">string</span>) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> m.RunWithValue(value, <span class="function"><span class="keyword">func</span><span class="params">(stmt *gorm.Statement)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> stmt.Schema != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> field := stmt.Schema.LookUpField(name); field != <span class="literal">nil</span> &#123;</span><br><span class="line">                name = field.DBName</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> m.DB.Exec(</span><br><span class="line">            <span class="string">&quot;ALTER TABLE ? DROP COLUMN ?&quot;</span>,</span><br><span class="line">            m.CurrentTable(stmt),</span><br><span class="line">            clause.Column&#123;Name: name&#125;,</span><br><span class="line">        ).Error</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="AlterColumn-migrator-migrator-go-410-425"><a href="#AlterColumn-migrator-migrator-go-410-425" class="headerlink" title="AlterColumn() (migrator&#x2F;migrator.go:410-425)"></a>AlterColumn() (migrator&#x2F;migrator.go:410-425)</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AlterColumn alter value&#x27;s `field` column&#x27; type based on schema definition</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m Migrator)</span></span> AlterColumn(value <span class="keyword">interface</span>&#123;&#125;, field <span class="type">string</span>) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> m.RunWithValue(value, <span class="function"><span class="keyword">func</span><span class="params">(stmt *gorm.Statement)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> stmt.Schema != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> field := stmt.Schema.LookUpField(field); field != <span class="literal">nil</span> &#123;</span><br><span class="line">                fileType := m.FullDataTypeOf(field)</span><br><span class="line">                <span class="keyword">return</span> m.DB.Exec(</span><br><span class="line">                    <span class="string">&quot;ALTER TABLE ? ALTER COLUMN ? TYPE ?&quot;</span>,</span><br><span class="line">                    m.CurrentTable(stmt),</span><br><span class="line">                    clause.Column&#123;Name: field.DBName&#125;,</span><br><span class="line">                    fileType,</span><br><span class="line">                ).Error</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to look up field with name: %s&quot;</span>, field)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="MigrateColumn-migrator-migrator-go-468-592"><a href="#MigrateColumn-migrator-migrator-go-468-592" class="headerlink" title="MigrateColumn() (migrator&#x2F;migrator.go:468-592)"></a>MigrateColumn() (migrator&#x2F;migrator.go:468-592)</h4><p>这是最复杂的方法，实现智能列迁移。完整源码太长，这里重点讲解其决策逻辑：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MigrateColumn migrate column</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m Migrator)</span></span> MigrateColumn(value <span class="keyword">interface</span>&#123;&#125;, field *schema.Field, columnType gorm.ColumnType) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> field.IgnoreMigration &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取完整数据类型</span></span><br><span class="line">    fullDataType := strings.TrimSpace(strings.ToLower(m.DB.Migrator().FullDataTypeOf(field).SQL))</span><br><span class="line">    realDataType := strings.ToLower(columnType.DatabaseTypeName())</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> alterColumn <span class="type">bool</span></span><br><span class="line">    <span class="keyword">var</span> isSameType = fullDataType == realDataType</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 1. 检查类型 ===</span></span><br><span class="line">    <span class="keyword">if</span> !field.PrimaryKey &#123;</span><br><span class="line">        <span class="keyword">if</span> !strings.HasPrefix(fullDataType, realDataType) &#123;</span><br><span class="line">            <span class="comment">// 检查类型别名</span></span><br><span class="line">            aliases := m.DB.Migrator().GetTypeAliases(realDataType)</span><br><span class="line">            <span class="keyword">for</span> _, alias := <span class="keyword">range</span> aliases &#123;</span><br><span class="line">                <span class="keyword">if</span> strings.HasPrefix(fullDataType, alias) &#123;</span><br><span class="line">                    isSameType = <span class="literal">true</span></span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> !isSameType &#123;</span><br><span class="line">                alterColumn = <span class="literal">true</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 2. 检查大小 ===</span></span><br><span class="line">    <span class="keyword">if</span> !isSameType &#123;</span><br><span class="line">        <span class="keyword">if</span> length, ok := columnType.Length(); length != <span class="type">int64</span>(field.Size) &#123;</span><br><span class="line">            <span class="keyword">if</span> length &gt; <span class="number">0</span> &amp;&amp; field.Size &gt; <span class="number">0</span> &#123;</span><br><span class="line">                alterColumn = <span class="literal">true</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 从数据类型中提取大小并比较</span></span><br><span class="line">                matches2 := regFullDataType.FindAllStringSubmatch(fullDataType, <span class="number">-1</span>)</span><br><span class="line">                <span class="keyword">if</span> !field.PrimaryKey &amp;&amp;</span><br><span class="line">                    (<span class="built_in">len</span>(matches2) == <span class="number">1</span> &amp;&amp; matches2[<span class="number">0</span>][<span class="number">1</span>] != fmt.Sprint(length) &amp;&amp; ok) &#123;</span><br><span class="line">                    alterColumn = <span class="literal">true</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 3. 检查精度 (decimal/numeric) ===</span></span><br><span class="line">    <span class="keyword">if</span> realDataType == <span class="string">&quot;decimal&quot;</span> || realDataType == <span class="string">&quot;numeric&quot;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> regexp.MustCompile(realDataType+<span class="string">`\(.*\)`</span>).FindString(fullDataType) != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">            precision, scale, ok := columnType.DecimalSize()</span><br><span class="line">            <span class="keyword">if</span> ok &#123;</span><br><span class="line">                <span class="keyword">if</span> !strings.HasPrefix(fullDataType, fmt.Sprintf(<span class="string">&quot;%s(%d,%d)&quot;</span>, realDataType, precision, scale)) &amp;&amp;</span><br><span class="line">                    !strings.HasPrefix(fullDataType, fmt.Sprintf(<span class="string">&quot;%s(%d)&quot;</span>, realDataType, precision)) &#123;</span><br><span class="line">                    alterColumn = <span class="literal">true</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 4. 检查可空性 ===</span></span><br><span class="line">    <span class="keyword">if</span> nullable, ok := columnType.Nullable(); ok &amp;&amp; nullable == field.NotNull &#123;</span><br><span class="line">        <span class="keyword">if</span> !field.PrimaryKey &amp;&amp; !nullable &#123;</span><br><span class="line">            alterColumn = <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 5. 检查默认值 ===</span></span><br><span class="line">    <span class="keyword">if</span> !field.PrimaryKey &#123;</span><br><span class="line">        currentDefaultNotNull := field.HasDefaultValue &amp;&amp; (field.DefaultValueInterface != <span class="literal">nil</span> || !strings.EqualFold(field.DefaultValue, <span class="string">&quot;NULL&quot;</span>))</span><br><span class="line">        dv, dvNotNull := columnType.DefaultValue()</span><br><span class="line">        <span class="keyword">if</span> dvNotNull &amp;&amp; !currentDefaultNotNull &#123;</span><br><span class="line">            alterColumn = <span class="literal">true</span>  <span class="comment">// 默认值 → null</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> !dvNotNull &amp;&amp; currentDefaultNotNull &#123;</span><br><span class="line">            alterColumn = <span class="literal">true</span>  <span class="comment">// null → 默认值</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> currentDefaultNotNull || dvNotNull &#123;</span><br><span class="line">            <span class="comment">// 根据类型比较默认值</span></span><br><span class="line">            <span class="keyword">switch</span> field.GORMDataType &#123;</span><br><span class="line">            <span class="keyword">case</span> schema.Time:</span><br><span class="line">                <span class="keyword">if</span> !strings.EqualFold(strings.TrimSuffix(dv, <span class="string">&quot;()&quot;</span>), strings.TrimSuffix(field.DefaultValue, <span class="string">&quot;()&quot;</span>)) &#123;</span><br><span class="line">                    alterColumn = <span class="literal">true</span></span><br><span class="line">                &#125;</span><br><span class="line">            <span class="keyword">case</span> schema.Bool:</span><br><span class="line">                v1, _ := strconv.ParseBool(dv)</span><br><span class="line">                v2, _ := strconv.ParseBool(field.DefaultValue)</span><br><span class="line">                alterColumn = v1 != v2</span><br><span class="line">            <span class="keyword">case</span> schema.String:</span><br><span class="line">                <span class="keyword">if</span> dv != field.DefaultValue &amp;&amp; dv != strings.Trim(field.DefaultValue, <span class="string">&quot;&#x27;\&quot;&quot;</span>) &#123;</span><br><span class="line">                    alterColumn = <span class="literal">true</span></span><br><span class="line">                &#125;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                alterColumn = dv != field.DefaultValue</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 6. 检查注释 ===</span></span><br><span class="line">    <span class="keyword">if</span> comment, ok := columnType.Comment(); ok &amp;&amp; comment != field.Comment &#123;</span><br><span class="line">        <span class="keyword">if</span> !field.PrimaryKey &#123;</span><br><span class="line">            alterColumn = <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 执行 ALTER COLUMN (如果需要) ===</span></span><br><span class="line">    <span class="keyword">if</span> alterColumn &#123;</span><br><span class="line">        <span class="keyword">if</span> err := m.DB.Migrator().AlterColumn(value, field.DBName); err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 处理 UNIQUE 约束 ===</span></span><br><span class="line">    <span class="keyword">if</span> err := m.DB.Migrator().MigrateColumnUnique(value, field, columnType); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>检查顺序</strong>:</p>
<ol>
<li>类型检查</li>
<li>大小检查</li>
<li>精度检查</li>
<li>可空性检查</li>
<li>默认值检查</li>
<li>注释检查</li>
<li>UNIQUE 约束检查</li>
</ol>
<hr>
<h2 id="四、类型映射系统"><a href="#四、类型映射系统" class="headerlink" title="四、类型映射系统"></a>四、类型映射系统</h2><h3 id="4-1-Go-类型到数据库类型映射"><a href="#4-1-Go-类型到数据库类型映射" class="headerlink" title="4.1 Go 类型到数据库类型映射"></a>4.1 Go 类型到数据库类型映射</h3><h4 id="基本类型映射表"><a href="#基本类型映射表" class="headerlink" title="基本类型映射表"></a>基本类型映射表</h4><table>
<thead>
<tr>
<th>Go 类型</th>
<th>GORM 数据类型</th>
<th>MySQL</th>
<th>PostgreSQL</th>
<th>SQLite</th>
<th>SQL Server</th>
</tr>
</thead>
<tbody><tr>
<td><code>int</code></td>
<td><code>int</code></td>
<td>INT</td>
<td>INTEGER</td>
<td>INTEGER</td>
<td>INT</td>
</tr>
<tr>
<td><code>int64</code></td>
<td><code>int64</code></td>
<td>BIGINT</td>
<td>BIGINT</td>
<td>INTEGER</td>
<td>BIGINT</td>
</tr>
<tr>
<td><code>uint</code></td>
<td><code>uint</code></td>
<td>INT UNSIGNED</td>
<td>BIGINT</td>
<td>INTEGER</td>
<td>INT</td>
</tr>
<tr>
<td><code>uint64</code></td>
<td><code>uint64</code></td>
<td>BIGINT UNSIGNED</td>
<td>BIGINT</td>
<td>INTEGER</td>
<td>BIGINT</td>
</tr>
<tr>
<td><code>float32</code></td>
<td><code>float</code></td>
<td>FLOAT</td>
<td>REAL</td>
<td>REAL</td>
<td>REAL</td>
</tr>
<tr>
<td><code>float64</code></td>
<td><code>double</code></td>
<td>DOUBLE</td>
<td>DOUBLE PRECISION</td>
<td>REAL</td>
<td>FLOAT</td>
</tr>
<tr>
<td><code>string</code></td>
<td><code>string</code></td>
<td>VARCHAR(255)</td>
<td>VARCHAR(255)</td>
<td>TEXT</td>
<td>NVARCHAR(255)</td>
</tr>
<tr>
<td><code>[]byte</code></td>
<td><code>bytes</code></td>
<td>BLOB</td>
<td>BYTEA</td>
<td>BLOB</td>
<td>VARBINARY(MAX)</td>
</tr>
<tr>
<td><code>bool</code></td>
<td><code>bool</code></td>
<td>TINYINT(1)</td>
<td>BOOLEAN</td>
<td>BOOLEAN</td>
<td>BIT</td>
</tr>
<tr>
<td><code>time.Time</code></td>
<td><code>time</code></td>
<td>TIMESTAMP</td>
<td>TIMESTAMPTZ</td>
<td>DATETIME</td>
<td>DATETIME2</td>
</tr>
</tbody></table>
<h4 id="GORM-标签的影响"><a href="#GORM-标签的影响" class="headerlink" title="GORM 标签的影响"></a>GORM 标签的影响</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// size: 指定字符串长度</span></span><br><span class="line">    Name <span class="type">string</span> <span class="string">`gorm:&quot;size:100&quot;`</span></span><br><span class="line">    <span class="comment">// MySQL: VARCHAR(100)</span></span><br><span class="line">    <span class="comment">// PostgreSQL: VARCHAR(100)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// not null: 非空约束</span></span><br><span class="line">    Name <span class="type">string</span> <span class="string">`gorm:&quot;size:100;not null&quot;`</span></span><br><span class="line">    <span class="comment">// MySQL: VARCHAR(100) NOT NULL</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// default: 默认值</span></span><br><span class="line">    Status <span class="type">string</span> <span class="string">`gorm:&quot;default:&#x27;active&#x27;&quot;`</span></span><br><span class="line">    <span class="comment">// MySQL: VARCHAR(255) DEFAULT &#x27;active&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// unique: 唯一约束</span></span><br><span class="line">    Email <span class="type">string</span> <span class="string">`gorm:&quot;unique&quot;`</span></span><br><span class="line">    <span class="comment">// MySQL: VARCHAR(255) UNIQUE</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// index: 创建索引</span></span><br><span class="line">    Name <span class="type">string</span> <span class="string">`gorm:&quot;index&quot;`</span></span><br><span class="line">    <span class="comment">// 创建索引: idx_users_name</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// uniqueIndex: 唯一索引</span></span><br><span class="line">    Email <span class="type">string</span> <span class="string">`gorm:&quot;uniqueIndex:idx_email&quot;`</span></span><br><span class="line">    <span class="comment">// 创建唯一索引: idx_email</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// type: 指定数据库类型</span></span><br><span class="line">    Data <span class="type">string</span> <span class="string">`gorm:&quot;type:TEXT&quot;`</span></span><br><span class="line">    <span class="comment">// MySQL: TEXT</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// autoCreateTime: 自动创建时间</span></span><br><span class="line">    CreatedAt time.Time <span class="string">`gorm:&quot;autoCreateTime&quot;`</span></span><br><span class="line">    <span class="comment">// MySQL: TIMESTAMP DEFAULT CURRENT_TIMESTAMP</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// autoUpdateTime: 自动更新时间</span></span><br><span class="line">    UpdatedAt time.Time <span class="string">`gorm:&quot;autoUpdateTime&quot;`</span></span><br><span class="line">    <span class="comment">// MySQL: TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// comment: 列注释</span></span><br><span class="line">    Name <span class="type">string</span> <span class="string">`gorm:&quot;comment:用户名称&quot;`</span></span><br><span class="line">    <span class="comment">// MySQL: VARCHAR(255) COMMENT &#x27;用户名称&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="五、实战代码示例"><a href="#五、实战代码示例" class="headerlink" title="五、实战代码示例"></a>五、实战代码示例</h2><h3 id="5-1-基础迁移示例"><a href="#5-1-基础迁移示例" class="headerlink" title="5.1 基础迁移示例"></a>5.1 基础迁移示例</h3><h4 id="创建表"><a href="#创建表" class="headerlink" title="创建表"></a>创建表</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;gorm.io/gorm&quot;</span></span><br><span class="line">    <span class="string">&quot;gorm.io/driver/mysql&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">    ID        <span class="type">uint</span>      <span class="string">`gorm:&quot;primaryKey&quot;`</span></span><br><span class="line">    Name      <span class="type">string</span>    <span class="string">`gorm:&quot;size:100;not null&quot;`</span></span><br><span class="line">    Email     <span class="type">string</span>    <span class="string">`gorm:&quot;size:255;uniqueIndex&quot;`</span></span><br><span class="line">    Age       <span class="type">int</span>       <span class="string">`gorm:&quot;default:0&quot;`</span></span><br><span class="line">    Status    <span class="type">string</span>    <span class="string">`gorm:&quot;size:20;default:&#x27;active&#x27;&quot;`</span></span><br><span class="line">    CreatedAt time.Time <span class="string">`gorm:&quot;autoCreateTime&quot;`</span></span><br><span class="line">    UpdatedAt time.Time <span class="string">`gorm:&quot;autoUpdateTime&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    dsn := <span class="string">&quot;user:password@tcp(127.0.0.1:3306)/dbname?charset=utf8mb4&amp;parseTime=True&amp;loc=Local&quot;</span></span><br><span class="line">    db, err := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;&#125;)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">&quot;连接数据库失败&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 方式 1: 使用 AutoMigrate (推荐)</span></span><br><span class="line">    err = db.AutoMigrate(&amp;User&#123;&#125;)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">&quot;迁移失败&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 方式 2: 使用 Migrator</span></span><br><span class="line">    err = db.Migrator().CreateTable(&amp;User&#123;&#125;)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">&quot;创建表失败&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="修改表结构"><a href="#修改表结构" class="headerlink" title="修改表结构"></a>修改表结构</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 添加新字段</span></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">    ID        <span class="type">uint</span>   <span class="string">`gorm:&quot;primaryKey&quot;`</span></span><br><span class="line">    Name      <span class="type">string</span> <span class="string">`gorm:&quot;size:100;not null&quot;`</span></span><br><span class="line">    Avatar    <span class="type">string</span> <span class="string">`gorm:&quot;size:500&quot;`</span> <span class="comment">// 新增字段</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 运行 AutoMigrate，会自动添加 avatar 列</span></span><br><span class="line">db.AutoMigrate(&amp;User&#123;&#125;)</span><br><span class="line"><span class="comment">// 生成的 SQL: ALTER TABLE `users` ADD COLUMN `avatar` varchar(500)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 修改字段大小</span></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">    Name <span class="type">string</span> <span class="string">`gorm:&quot;size:200&quot;`</span> <span class="comment">// 从 100 改为 200</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 运行 AutoMigrate，会自动修改列类型</span></span><br><span class="line">db.AutoMigrate(&amp;User&#123;&#125;)</span><br><span class="line"><span class="comment">// 生成的 SQL: ALTER TABLE `users` ALTER COLUMN `name` TYPE varchar(200)</span></span><br></pre></td></tr></table></figure>

<h4 id="删除表"><a href="#删除表" class="headerlink" title="删除表"></a>删除表</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 方式 1: 删除单个表</span></span><br><span class="line">db.Migrator().DropTable(&amp;User&#123;&#125;)</span><br><span class="line"><span class="comment">// 生成的 SQL: DROP TABLE IF EXISTS `users`</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 方式 2: 删除多个表</span></span><br><span class="line">db.Migrator().DropTable(&amp;User&#123;&#125;, &amp;Order&#123;&#125;, &amp;Product&#123;&#125;)</span><br><span class="line"><span class="comment">// 依次删除每个表</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 方式 3: 使用表名</span></span><br><span class="line">db.Migrator().DropTable(<span class="string">&quot;users&quot;</span>)</span><br><span class="line"><span class="comment">// 生成的 SQL: DROP TABLE IF EXISTS `users`</span></span><br></pre></td></tr></table></figure>

<h4 id="重命名操作"><a href="#重命名操作" class="headerlink" title="重命名操作"></a>重命名操作</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 重命名表</span></span><br><span class="line">db.Migrator().RenameTable(<span class="string">&quot;users&quot;</span>, <span class="string">&quot;accounts&quot;</span>)</span><br><span class="line"><span class="comment">// 生成的 SQL: ALTER TABLE `users` RENAME TO `accounts`</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用结构体</span></span><br><span class="line">db.Migrator().RenameTable(&amp;User&#123;&#125;, <span class="string">&quot;accounts&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 重命名列</span></span><br><span class="line">db.Migrator().RenameColumn(&amp;User&#123;&#125;, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;username&quot;</span>)</span><br><span class="line"><span class="comment">// 生成的 SQL: ALTER TABLE `users` RENAME COLUMN `name` TO `username`</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 重命名索引</span></span><br><span class="line">db.Migrator().RenameIndex(&amp;User&#123;&#125;, <span class="string">&quot;idx_users_name&quot;</span>, <span class="string">&quot;idx_accounts_username&quot;</span>)</span><br><span class="line"><span class="comment">// 生成的 SQL: ALTER TABLE `users` RENAME INDEX `idx_users_name` TO `idx_accounts_username`</span></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="5-2-列操作示例"><a href="#5-2-列操作示例" class="headerlink" title="5.2 列操作示例"></a>5.2 列操作示例</h3><h4 id="添加列"><a href="#添加列" class="headerlink" title="添加列"></a>添加列</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 添加单个列</span></span><br><span class="line">err := db.Migrator().AddColumn(&amp;User&#123;&#125;, <span class="string">&quot;avatar&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 生成的 SQL: ALTER TABLE `users` ADD COLUMN `avatar` varchar(500)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加多个列</span></span><br><span class="line">columns := []<span class="type">string</span>&#123;<span class="string">&quot;phone&quot;</span>, <span class="string">&quot;address&quot;</span>, <span class="string">&quot;bio&quot;</span>&#125;</span><br><span class="line"><span class="keyword">for</span> _, col := <span class="keyword">range</span> columns &#123;</span><br><span class="line">    <span class="keyword">if</span> err := db.Migrator().AddColumn(&amp;User&#123;&#125;, col); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Printf(<span class="string">&quot;添加列 %s 失败: %v&quot;</span>, col, err)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="修改列类型"><a href="#修改列类型" class="headerlink" title="修改列类型"></a>修改列类型</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 修改列类型</span></span><br><span class="line">err := db.Migrator().AlterColumn(&amp;User&#123;&#125;, <span class="string">&quot;name&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 生成的 SQL: ALTER TABLE `users` ALTER COLUMN `name` TYPE varchar(200)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 AutoMigrate 自动检测并修改</span></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">    Name <span class="type">string</span> <span class="string">`gorm:&quot;size:200;not null;comment:用户名称&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line">db.AutoMigrate(&amp;User&#123;&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="删除列"><a href="#删除列" class="headerlink" title="删除列"></a>删除列</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 删除单个列</span></span><br><span class="line">err := db.Migrator().DropColumn(&amp;User&#123;&#125;, <span class="string">&quot;avatar&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 生成的 SQL: ALTER TABLE `users` DROP COLUMN `avatar`</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除多个列</span></span><br><span class="line">columns := []<span class="type">string</span>&#123;<span class="string">&quot;phone&quot;</span>, <span class="string">&quot;address&quot;</span>, <span class="string">&quot;bio&quot;</span>&#125;</span><br><span class="line"><span class="keyword">for</span> _, col := <span class="keyword">range</span> columns &#123;</span><br><span class="line">    <span class="keyword">if</span> err := db.Migrator().DropColumn(&amp;User&#123;&#125;, col); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Printf(<span class="string">&quot;删除列 %s 失败: %v&quot;</span>, col, err)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="检查列是否存在"><a href="#检查列是否存在" class="headerlink" title="检查列是否存在"></a>检查列是否存在</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 检查列是否存在</span></span><br><span class="line">hasColumn := db.Migrator().HasColumn(&amp;User&#123;&#125;, <span class="string">&quot;email&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> !hasColumn &#123;</span><br><span class="line">    <span class="comment">// 列不存在，添加它</span></span><br><span class="line">    db.Migrator().AddColumn(&amp;User&#123;&#125;, <span class="string">&quot;email&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取列类型信息</span></span><br><span class="line">columnTypes, err := db.Migrator().ColumnTypes(&amp;User&#123;&#125;)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _, ct := <span class="keyword">range</span> columnTypes &#123;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;列名: %s, 类型: %s\n&quot;</span>, ct.Name(), ct.DatabaseTypeName())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="5-3-索引操作示例"><a href="#5-3-索引操作示例" class="headerlink" title="5.3 索引操作示例"></a>5.3 索引操作示例</h3><h4 id="创建普通索引"><a href="#创建普通索引" class="headerlink" title="创建普通索引"></a>创建普通索引</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 方式 1: 使用 GORM 标签 (推荐)</span></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">    Name  <span class="type">string</span> <span class="string">`gorm:&quot;index:idx_name&quot;`</span></span><br><span class="line">    Email <span class="type">string</span> <span class="string">`gorm:&quot;index:idx_email&quot;`</span></span><br><span class="line">    Age   <span class="type">int</span>    <span class="string">`gorm:&quot;index:idx_age&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">db.AutoMigrate(&amp;User&#123;&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方式 2: 手动创建索引</span></span><br><span class="line">db.Migrator().CreateIndex(&amp;User&#123;&#125;, <span class="string">&quot;idx_name&quot;</span>)</span><br><span class="line"><span class="comment">// 生成的 SQL: CREATE INDEX `idx_name` ON `users`(`name`)</span></span><br></pre></td></tr></table></figure>

<h4 id="创建唯一索引"><a href="#创建唯一索引" class="headerlink" title="创建唯一索引"></a>创建唯一索引</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 方式 1: 使用 GORM 标签</span></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">    Email <span class="type">string</span> <span class="string">`gorm:&quot;uniqueIndex:idx_email&quot;`</span></span><br><span class="line">    Phone <span class="type">string</span> <span class="string">`gorm:&quot;uniqueIndex&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">db.AutoMigrate(&amp;User&#123;&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方式 2: 手动创建唯一索引</span></span><br><span class="line">db.Migrator().CreateIndex(&amp;User&#123;&#125;, <span class="string">&quot;idx_email&quot;</span>)</span><br><span class="line"><span class="comment">// 生成的 SQL: CREATE UNIQUE INDEX `idx_email` ON `users`(`email`)</span></span><br></pre></td></tr></table></figure>

<h4 id="创建复合索引"><a href="#创建复合索引" class="headerlink" title="创建复合索引"></a>创建复合索引</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用 GORM 标签创建复合索引</span></span><br><span class="line"><span class="keyword">type</span> Order <span class="keyword">struct</span> &#123;</span><br><span class="line">    UserID    <span class="type">uint</span>      <span class="string">`gorm:&quot;index:idx_user_status,priority:1&quot;`</span></span><br><span class="line">    Status    <span class="type">string</span>    <span class="string">`gorm:&quot;index:idx_user_status,priority:2&quot;`</span></span><br><span class="line">    CreatedAt time.Time <span class="string">`gorm:&quot;index:idx_user_status,priority:3;sort:desc&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">db.AutoMigrate(&amp;Order&#123;&#125;)</span><br><span class="line"><span class="comment">// 生成的 SQL: CREATE INDEX `idx_user_status` ON `orders`(`user_id`, `status`, `created_at` DESC)</span></span><br></pre></td></tr></table></figure>

<h4 id="删除索引"><a href="#删除索引" class="headerlink" title="删除索引"></a>删除索引</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 删除单个索引</span></span><br><span class="line">err := db.Migrator().DropIndex(&amp;User&#123;&#125;, <span class="string">&quot;idx_name&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 生成的 SQL: DROP INDEX `idx_name` ON `users`</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查索引是否存在后再删除</span></span><br><span class="line"><span class="keyword">if</span> db.Migrator().HasIndex(&amp;User&#123;&#125;, <span class="string">&quot;idx_name&quot;</span>) &#123;</span><br><span class="line">    db.Migrator().DropIndex(&amp;User&#123;&#125;, <span class="string">&quot;idx_name&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="5-4-约束操作示例"><a href="#5-4-约束操作示例" class="headerlink" title="5.4 约束操作示例"></a>5.4 约束操作示例</h3><h4 id="外键约束"><a href="#外键约束" class="headerlink" title="外键约束"></a>外键约束</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Team <span class="keyword">struct</span> &#123;</span><br><span class="line">    ID   <span class="type">uint</span>   <span class="string">`gorm:&quot;primaryKey&quot;`</span></span><br><span class="line">    Name <span class="type">string</span> <span class="string">`gorm:&quot;size:100&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">    ID     <span class="type">uint</span>  <span class="string">`gorm:&quot;primaryKey&quot;`</span></span><br><span class="line">    Name   <span class="type">string</span> <span class="string">`gorm:&quot;size:100&quot;`</span></span><br><span class="line">    TeamID <span class="type">uint</span>  <span class="string">`gorm:&quot;not null&quot;`</span></span><br><span class="line">    Team   Team  <span class="string">`gorm:&quot;foreignKey:TeamID;references:ID;constraint:OnDelete:CASCADE&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">db.AutoMigrate(&amp;Team&#123;&#125;, &amp;User&#123;&#125;)</span><br><span class="line"><span class="comment">// 生成的 SQL:</span></span><br><span class="line"><span class="comment">// ALTER TABLE `users` ADD CONSTRAINT `fk_users_team`</span></span><br><span class="line"><span class="comment">// FOREIGN KEY (`team_id`) REFERENCES `teams`(`id`) ON DELETE CASCADE</span></span><br></pre></td></tr></table></figure>

<h4 id="唯一约束"><a href="#唯一约束" class="headerlink" title="唯一约束"></a>唯一约束</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">    Email <span class="type">string</span> <span class="string">`gorm:&quot;unique&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">db.AutoMigrate(&amp;User&#123;&#125;)</span><br><span class="line"><span class="comment">// 生成的 SQL: CREATE UNIQUE INDEX `idx_users_email` ON `users`(`email`)</span></span><br></pre></td></tr></table></figure>

<h4 id="检查约束"><a href="#检查约束" class="headerlink" title="检查约束"></a>检查约束</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">    Age <span class="type">int</span> <span class="string">`gorm:&quot;check:age &gt;= 18&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">db.AutoMigrate(&amp;User&#123;&#125;)</span><br><span class="line"><span class="comment">// 生成的 SQL: ALTER TABLE `users` ADD CONSTRAINT `chk_users_age` CHECK (`age` &gt;= 18)</span></span><br></pre></td></tr></table></figure>

<h4 id="删除约束"><a href="#删除约束" class="headerlink" title="删除约束"></a>删除约束</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 删除外键约束</span></span><br><span class="line">err := db.Migrator().DropConstraint(&amp;User&#123;&#125;, <span class="string">&quot;fk_users_team&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 生成的 SQL: ALTER TABLE `users` DROP CONSTRAINT `fk_users_team`</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查约束是否存在</span></span><br><span class="line"><span class="keyword">if</span> db.Migrator().HasConstraint(&amp;User&#123;&#125;, <span class="string">&quot;fk_users_team&quot;</span>) &#123;</span><br><span class="line">    db.Migrator().DropConstraint(&amp;User&#123;&#125;, <span class="string">&quot;fk_users_team&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="5-5-视图操作示例"><a href="#5-5-视图操作示例" class="headerlink" title="5.5 视图操作示例"></a>5.5 视图操作示例</h3><h4 id="创建视图"><a href="#创建视图" class="headerlink" title="创建视图"></a>创建视图</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建基本视图</span></span><br><span class="line">query := db.Model(&amp;User&#123;&#125;).Where(<span class="string">&quot;age &gt; ?&quot;</span>, <span class="number">18</span>)</span><br><span class="line">err := db.Migrator().CreateView(<span class="string">&quot;adult_users&quot;</span>, gorm.ViewOption&#123;Query: query&#125;)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 生成的 SQL: CREATE VIEW `adult_users` AS SELECT * FROM `users` WHERE age &gt; 18</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用聚合函数</span></span><br><span class="line">query = db.Model(&amp;Order&#123;&#125;).</span><br><span class="line">    Select(<span class="string">&quot;user_id, COUNT(*) as order_count, SUM(total) as total_amount&quot;</span>).</span><br><span class="line">    Group(<span class="string">&quot;user_id&quot;</span>)</span><br><span class="line">err = db.Migrator().CreateView(<span class="string">&quot;user_order_stats&quot;</span>, gorm.ViewOption&#123;Query: query&#125;)</span><br><span class="line"><span class="comment">// 生成的 SQL:</span></span><br><span class="line"><span class="comment">// CREATE VIEW `user_order_stats` AS</span></span><br><span class="line"><span class="comment">// SELECT user_id, COUNT(*) as order_count, SUM(total) as total_amount</span></span><br><span class="line"><span class="comment">// FROM `orders` GROUP BY user_id</span></span><br></pre></td></tr></table></figure>

<h4 id="替换视图"><a href="#替换视图" class="headerlink" title="替换视图"></a>替换视图</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建或替换视图</span></span><br><span class="line">query := db.Model(&amp;User&#123;&#125;)</span><br><span class="line">err := db.Migrator().CreateView(<span class="string">&quot;users_view&quot;</span>, gorm.ViewOption&#123;</span><br><span class="line">    Query:   query,</span><br><span class="line">    Replace: <span class="literal">true</span>,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 生成的 SQL: CREATE OR REPLACE VIEW `users_view` AS SELECT * FROM `users`</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 带检查选项</span></span><br><span class="line">err = db.Migrator().CreateView(<span class="string">&quot;adult_users&quot;</span>, gorm.ViewOption&#123;</span><br><span class="line">    Query:       db.Model(&amp;User&#123;&#125;).Where(<span class="string">&quot;age &gt; ?&quot;</span>, <span class="number">18</span>),</span><br><span class="line">    Replace:     <span class="literal">true</span>,</span><br><span class="line">    CheckOption: <span class="string">&quot;WITH CHECK OPTION&quot;</span>,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 生成的 SQL:</span></span><br><span class="line"><span class="comment">// CREATE OR REPLACE VIEW `adult_users` AS</span></span><br><span class="line"><span class="comment">// SELECT * FROM `users` WHERE age &gt; 18</span></span><br><span class="line"><span class="comment">// WITH CHECK OPTION</span></span><br></pre></td></tr></table></figure>

<h4 id="删除视图"><a href="#删除视图" class="headerlink" title="删除视图"></a>删除视图</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 删除视图</span></span><br><span class="line">err := db.Migrator().DropView(<span class="string">&quot;adult_users&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 生成的 SQL: DROP VIEW IF EXISTS `adult_users`</span></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="5-6-完整迁移流程示例"><a href="#5-6-完整迁移流程示例" class="headerlink" title="5.6 完整迁移流程示例"></a>5.6 完整迁移流程示例</h3><h4 id="版本化迁移系统"><a href="#版本化迁移系统" class="headerlink" title="版本化迁移系统"></a>版本化迁移系统</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;gorm.io/gorm&quot;</span></span><br><span class="line">    <span class="string">&quot;log&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Migration 迁移记录</span></span><br><span class="line"><span class="keyword">type</span> Migration <span class="keyword">struct</span> &#123;</span><br><span class="line">    ID      <span class="type">uint</span>   <span class="string">`gorm:&quot;primaryKey&quot;`</span></span><br><span class="line">    Version <span class="type">string</span> <span class="string">`gorm:&quot;size:20;uniqueIndex&quot;`</span></span><br><span class="line">    Name    <span class="type">string</span> <span class="string">`gorm:&quot;size:255&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// MigrationStep 迁移步骤</span></span><br><span class="line"><span class="keyword">type</span> MigrationStep <span class="keyword">struct</span> &#123;</span><br><span class="line">    Version <span class="type">string</span></span><br><span class="line">    Name    <span class="type">string</span></span><br><span class="line">    Up      <span class="function"><span class="keyword">func</span><span class="params">(*gorm.DB)</span></span> <span class="type">error</span></span><br><span class="line">    Down    <span class="function"><span class="keyword">func</span><span class="params">(*gorm.DB)</span></span> <span class="type">error</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// MigrationRunner 迁移执行器</span></span><br><span class="line"><span class="keyword">type</span> MigrationRunner <span class="keyword">struct</span> &#123;</span><br><span class="line">    db       *gorm.DB</span><br><span class="line">    steps    []MigrationStep</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewMigrationRunner</span><span class="params">(db *gorm.DB, steps []MigrationStep)</span></span> *MigrationRunner &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;MigrationRunner&#123;db: db, steps: steps&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Up 执行所有待执行的迁移</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *MigrationRunner)</span></span> Up() <span class="type">error</span> &#123;</span><br><span class="line">    <span class="comment">// 创建迁移历史表</span></span><br><span class="line">    <span class="keyword">if</span> err := r.db.AutoMigrate(&amp;Migration&#123;&#125;); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;创建迁移历史表失败: %w&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取已执行的迁移</span></span><br><span class="line">    <span class="keyword">var</span> executed []<span class="type">string</span></span><br><span class="line">    r.db.Model(&amp;Migration&#123;&#125;).Pluck(<span class="string">&quot;version&quot;</span>, &amp;executed)</span><br><span class="line">    executedMap := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="type">bool</span>)</span><br><span class="line">    <span class="keyword">for</span> _, v := <span class="keyword">range</span> executed &#123;</span><br><span class="line">        executedMap[v] = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行未执行的迁移</span></span><br><span class="line">    <span class="keyword">for</span> _, step := <span class="keyword">range</span> r.steps &#123;</span><br><span class="line">        <span class="keyword">if</span> !executedMap[step.Version] &#123;</span><br><span class="line">            log.Printf(<span class="string">&quot;执行迁移: %s - %s&quot;</span>, step.Version, step.Name)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> err := step.Up(r.db); err != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;迁移 %s 失败: %w&quot;</span>, step.Version, err)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 记录迁移历史</span></span><br><span class="line">            <span class="keyword">if</span> err := r.db.Create(&amp;Migration&#123;</span><br><span class="line">                Version: step.Version,</span><br><span class="line">                Name:    step.Name,</span><br><span class="line">            &#125;).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;记录迁移历史失败: %w&quot;</span>, err)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            log.Printf(<span class="string">&quot;迁移完成: %s&quot;</span>, step.Version)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Down 回滚指定版本的迁移</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *MigrationRunner)</span></span> Down(version <span class="type">string</span>) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="comment">// 查找迁移步骤</span></span><br><span class="line">    <span class="keyword">var</span> step *MigrationStep</span><br><span class="line">    <span class="keyword">for</span> i := <span class="keyword">range</span> r.steps &#123;</span><br><span class="line">        <span class="keyword">if</span> r.steps[i].Version == version &#123;</span><br><span class="line">            step = &amp;r.steps[i]</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> step == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;未找到版本 %s 的迁移&quot;</span>, version)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    log.Printf(<span class="string">&quot;回滚迁移: %s - %s&quot;</span>, step.Version, step.Name)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行回滚</span></span><br><span class="line">    <span class="keyword">if</span> err := step.Down(r.db); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;回滚失败: %w&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 删除迁移历史</span></span><br><span class="line">    <span class="keyword">if</span> err := r.db.Where(<span class="string">&quot;version = ?&quot;</span>, version).Delete(&amp;Migration&#123;&#125;).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;删除迁移历史失败: %w&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    log.Printf(<span class="string">&quot;回滚完成: %s&quot;</span>, version)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    dsn := <span class="string">&quot;user:password@tcp(127.0.0.1:3306)/dbname?charset=utf8mb4&amp;parseTime=True&amp;loc=Local&quot;</span></span><br><span class="line">    db, err := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;&#125;)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">&quot;连接数据库失败&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 定义迁移步骤</span></span><br><span class="line">    steps := []MigrationStep&#123;</span><br><span class="line">        &#123;</span><br><span class="line">            Version: <span class="string">&quot;20240101_120000&quot;</span>,</span><br><span class="line">            Name:    <span class="string">&quot;create_users_table&quot;</span>,</span><br><span class="line">            Up: <span class="function"><span class="keyword">func</span><span class="params">(db *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> db.Migrator().CreateTable(&amp;User&#123;&#125;)</span><br><span class="line">            &#125;,</span><br><span class="line">            Down: <span class="function"><span class="keyword">func</span><span class="params">(db *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> db.Migrator().DropTable(&amp;User&#123;&#125;)</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            Version: <span class="string">&quot;20240102_120000&quot;</span>,</span><br><span class="line">            Name:    <span class="string">&quot;add_avatar_to_users&quot;</span>,</span><br><span class="line">            Up: <span class="function"><span class="keyword">func</span><span class="params">(db *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> db.Migrator().AddColumn(&amp;User&#123;&#125;, <span class="string">&quot;avatar&quot;</span>)</span><br><span class="line">            &#125;,</span><br><span class="line">            Down: <span class="function"><span class="keyword">func</span><span class="params">(db *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> db.Migrator().DropColumn(&amp;User&#123;&#125;, <span class="string">&quot;avatar&quot;</span>)</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            Version: <span class="string">&quot;20240103_120000&quot;</span>,</span><br><span class="line">            Name:    <span class="string">&quot;create_orders_table&quot;</span>,</span><br><span class="line">            Up: <span class="function"><span class="keyword">func</span><span class="params">(db *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> db.Migrator().CreateTable(&amp;Order&#123;&#125;)</span><br><span class="line">            &#125;,</span><br><span class="line">            Down: <span class="function"><span class="keyword">func</span><span class="params">(db *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> db.Migrator().DropTable(&amp;Order&#123;&#125;)</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建迁移执行器</span></span><br><span class="line">    runner := NewMigrationRunner(db, steps)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行迁移</span></span><br><span class="line">    <span class="keyword">if</span> err := runner.Up(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatalf(<span class="string">&quot;迁移失败: %v&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 回滚特定版本</span></span><br><span class="line">    <span class="comment">// if err := runner.Down(&quot;20240102_120000&quot;); err != nil &#123;</span></span><br><span class="line">    <span class="comment">//     log.Fatalf(&quot;回滚失败: %v&quot;, err)</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="六、可视化流程图"><a href="#六、可视化流程图" class="headerlink" title="六、可视化流程图"></a>六、可视化流程图</h2><h3 id="6-1-AutoMigrate-完整执行流程图"><a href="#6-1-AutoMigrate-完整执行流程图" class="headerlink" title="6.1 AutoMigrate 完整执行流程图"></a>6.1 AutoMigrate 完整执行流程图</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">AutoMigrate(values ...)</span><br><span class="line">        │</span><br><span class="line">        ▼</span><br><span class="line">┌───────────────────────────────┐</span><br><span class="line">│  ReorderModels(values, true)   │</span><br><span class="line">│  按依赖关系排序模型              │</span><br><span class="line">└───────────┬───────────────────┘</span><br><span class="line">            │</span><br><span class="line">            ▼</span><br><span class="line">    ┌───────────────┐</span><br><span class="line">    │ 遍历每个模型   │</span><br><span class="line">    └───────┬───────┘</span><br><span class="line">            │</span><br><span class="line">            ▼</span><br><span class="line">┌───────────────────────────────┐</span><br><span class="line">│  GetQueryAndExecTx()           │</span><br><span class="line">│  queryTx: 用于查询              │</span><br><span class="line">│  execTx:  用于执行              │</span><br><span class="line">└───────────┬───────────────────┘</span><br><span class="line">            │</span><br><span class="line">            ▼</span><br><span class="line">    ┌───────────────┐</span><br><span class="line">    │ HasTable()?   │</span><br><span class="line">    └───┬───────┬───┘</span><br><span class="line">        │       │</span><br><span class="line">       No      Yes</span><br><span class="line">        │       │</span><br><span class="line">        ▼       ▼</span><br><span class="line">┌──────────┐  ┌───────────────────────────────────┐</span><br><span class="line">│CreateTab │  │ 增量迁移                            │</span><br><span class="line">│  le()    │  │ ┌─────────────────────────────┐    │</span><br><span class="line">└──────────┘  │ │  ColumnTypes() 获取当前列类型  │    │</span><br><span class="line">              │ └─────────────┬───────────────┘    │</span><br><span class="line">              │               ▼                     │</span><br><span class="line">              │  ┌─────────────────────────────┐    │</span><br><span class="line">              │  │ 遍历每个字段                  │    │</span><br><span class="line">              │  └──────┬──────────────────┬────┘    │</span><br><span class="line">              │         │                  │          │</span><br><span class="line">              │         ▼                  ▼          │</span><br><span class="line">              │  ┌─────────┐        ┌──────────┐    │</span><br><span class="line">              │  │不存在   │        │  存在    │    │</span><br><span class="line">              │  │AddColumn│        │MigrateCol│    │</span><br><span class="line">              │  └─────────┘        │   umn()   │    │</span><br><span class="line">              │                     └──────────┘    │</span><br><span class="line">              │                              │       │</span><br><span class="line">              │  ┌───────────────────────────┘       │</span><br><span class="line">              │  ▼                                  │</span><br><span class="line">              │  ┌─────────────────────────────┐    │</span><br><span class="line">              │  │ 处理关系约束                  │    │</span><br><span class="line">              │  │ CreateConstraint()          │    │</span><br><span class="line">              │  └─────────────────────────────┘    │</span><br><span class="line">              │                                    │</span><br><span class="line">              │  ┌─────────────────────────────┐    │</span><br><span class="line">              │  │ 处理检查约束                  │    │</span><br><span class="line">              │  │ CreateConstraint()          │    │</span><br><span class="line">              │  └─────────────────────────────┘    │</span><br><span class="line">              │                                    │</span><br><span class="line">              │  ┌─────────────────────────────┐    │</span><br><span class="line">              │  │ 处理索引                      │    │</span><br><span class="line">              │  │ CreateIndex()               │    │</span><br><span class="line">              │  └─────────────────────────────┘    │</span><br><span class="line">              └───────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h3 id="6-2-CreateTable-SQL-生成流程图"><a href="#6-2-CreateTable-SQL-生成流程图" class="headerlink" title="6.2 CreateTable SQL 生成流程图"></a>6.2 CreateTable SQL 生成流程图</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">CreateTable(value)</span><br><span class="line">        │</span><br><span class="line">        ▼</span><br><span class="line">┌───────────────────────────────────┐</span><br><span class="line">│ RunWithValue(value, func(stmt) &#123;&#125;) │</span><br><span class="line">└───────────────┬───────────────────┘</span><br><span class="line">                │</span><br><span class="line">                ▼</span><br><span class="line">┌────────────────────────────────────┐</span><br><span class="line">│ createTableSQL = &quot;CREATE TABLE ? (&quot; │</span><br><span class="line">│ values = [CurrentTable(stmt)]      │</span><br><span class="line">└───────────────┬────────────────────┘</span><br><span class="line">                │</span><br><span class="line">                ▼</span><br><span class="line">┌────────────────────────────────────┐</span><br><span class="line">│ 遍历 stmt.Schema.DBNames          │</span><br><span class="line">│ 添加列定义: &quot;? ?&quot;                   │</span><br><span class="line">│ values += [列名, FullDataTypeOf]   │</span><br><span class="line">└───────────────┬────────────────────┘</span><br><span class="line">                │</span><br><span class="line">                ▼</span><br><span class="line">┌────────────────────────────────────┐</span><br><span class="line">│ 如果没有 PRIMARY KEY 在数据类型中   │</span><br><span class="line">│ 添加: &quot;PRIMARY KEY ?&quot;              │</span><br><span class="line">│ values += [主键列列表]              │</span><br><span class="line">└───────────────┬────────────────────┘</span><br><span class="line">                │</span><br><span class="line">                ▼</span><br><span class="line">┌────────────────────────────────────┐</span><br><span class="line">│ 遍历 ParseIndexes()                │</span><br><span class="line">│ 如果 CreateIndexAfterCreateTable   │</span><br><span class="line">│   → defer CreateIndex()            │</span><br><span class="line">│ 否则                               │</span><br><span class="line">│   → 添加索引定义到 CREATE TABLE     │</span><br><span class="line">└───────────────┬────────────────────┘</span><br><span class="line">                │</span><br><span class="line">                ▼</span><br><span class="line">┌────────────────────────────────────┐</span><br><span class="line">│ 如果未禁用外键约束                   │</span><br><span class="line">│ 遍历 Relationships.Relations       │</span><br><span class="line">│ 添加约束定义到 CREATE TABLE         │</span><br><span class="line">└───────────────┬────────────────────┘</span><br><span class="line">                │</span><br><span class="line">                ▼</span><br><span class="line">┌────────────────────────────────────┐</span><br><span class="line">│ 遍历 ParseUniqueConstraints()      │</span><br><span class="line">│ 添加: &quot;CONSTRAINT ? UNIQUE (?)&quot;    │</span><br><span class="line">└───────────────┬────────────────────┘</span><br><span class="line">                │</span><br><span class="line">                ▼</span><br><span class="line">┌────────────────────────────────────┐</span><br><span class="line">│ 遍历 ParseCheckConstraints()       │</span><br><span class="line">│ 添加: &quot;CONSTRAINT ? CHECK (?)&quot;     │</span><br><span class="line">└───────────────┬────────────────────┘</span><br><span class="line">                │</span><br><span class="line">                ▼</span><br><span class="line">┌────────────────────────────────────┐</span><br><span class="line">│ 移除末尾逗号                        │</span><br><span class="line">│ 添加: &quot;)&quot;                          │</span><br><span class="line">│ 添加表选项 (如果有的话)              │</span><br><span class="line">└───────────────┬────────────────────┘</span><br><span class="line">                │</span><br><span class="line">                ▼</span><br><span class="line">┌────────────────────────────────────┐</span><br><span class="line">│ tx.Exec(createTableSQL, values...) │</span><br><span class="line">└────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h3 id="6-3-MigrateColumn-决策流程图"><a href="#6-3-MigrateColumn-决策流程图" class="headerlink" title="6.3 MigrateColumn 决策流程图"></a>6.3 MigrateColumn 决策流程图</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">MigrateColumn(value, field, columnType)</span><br><span class="line">        │</span><br><span class="line">        ▼</span><br><span class="line">┌───────────────────────────────┐</span><br><span class="line">│ field.IgnoreMigration?        │</span><br><span class="line">└─────────┬───────────────┬─────┘</span><br><span class="line">          │ Yes           │ No</span><br><span class="line">          ▼               ▼</span><br><span class="line">     ┌─────────┐   ┌──────────────────┐</span><br><span class="line">     │ return  │   │ 获取 fullDataType │</span><br><span class="line">     │   nil   │   │ 和 realDataType   │</span><br><span class="line">     └─────────┘   └────────┬─────────┘</span><br><span class="line">                            │</span><br><span class="line">              ┌─────────────┴─────────────┐</span><br><span class="line">              ▼                           ▼</span><br><span class="line">      ┌───────────────────┐      ┌──────────────────┐</span><br><span class="line">      │ 检查类型           │      │ 检查大小          │</span><br><span class="line">      │ alterColumn =    │      │ alterColumn =    │</span><br><span class="line">      │   类型不匹配      │      │   大小不匹配      │</span><br><span class="line">      └─────────┬─────────┘      └────────┬─────────┘</span><br><span class="line">                │                         │</span><br><span class="line">      ┌─────────┴─────────┐             │</span><br><span class="line">      ▼                   ▼             ▼</span><br><span class="line">┌─────────────┐   ┌─────────────┐  ┌──────────────┐</span><br><span class="line">│ 检查精度     │   │ 检查可空性   │  │ 检查默认值    │</span><br><span class="line">│ alterColumn │   │ alterColumn │  │ alterColumn  │</span><br><span class="line">│             │   │             │  │              │</span><br><span class="line">└──────┬──────┘   └──────┬──────┘  └──────┬───────┘</span><br><span class="line">       │                 │                 │</span><br><span class="line">       └─────────────────┴─────────────────┘</span><br><span class="line">                         │</span><br><span class="line">                         ▼</span><br><span class="line">              ┌──────────────────────┐</span><br><span class="line">              │ 检查注释              │</span><br><span class="line">              │ alterColumn =        │</span><br><span class="line">              │   注释不匹配          │</span><br><span class="line">              └──────────┬───────────┘</span><br><span class="line">                         │</span><br><span class="line">                         ▼</span><br><span class="line">              ┌──────────────────────┐</span><br><span class="line">              │ alterColumn?         │</span><br><span class="line">              └──────────┬───────────┘</span><br><span class="line">                         │</span><br><span class="line">                ┌────────┴────────┐</span><br><span class="line">                │                 │</span><br><span class="line">               Yes               No</span><br><span class="line">                │                 │</span><br><span class="line">                ▼                 ▼</span><br><span class="line">        ┌──────────────┐   ┌──────────────┐</span><br><span class="line">        │ AlterColumn()│   │ 跳过          │</span><br><span class="line">        └──────┬───────┘   └──────────────┘</span><br><span class="line">               │</span><br><span class="line">               ▼</span><br><span class="line">        ┌──────────────────┐</span><br><span class="line">        │ MigrateColumn    │</span><br><span class="line">        │ Unique()         │</span><br><span class="line">        └──────────────────┘</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="七、最佳实践与故障排查"><a href="#七、最佳实践与故障排查" class="headerlink" title="七、最佳实践与故障排查"></a>七、最佳实践与故障排查</h2><h3 id="7-1-配置最佳实践"><a href="#7-1-配置最佳实践" class="headerlink" title="7.1 配置最佳实践"></a>7.1 配置最佳实践</h3><h4 id="开发环境配置"><a href="#开发环境配置" class="headerlink" title="开发环境配置"></a>开发环境配置</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">db, err := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;</span><br><span class="line">    <span class="comment">// 开发环境建议配置</span></span><br><span class="line">    SkipDefaultTransaction: <span class="literal">false</span>,  <span class="comment">// 启用默认事务保护</span></span><br><span class="line">    DisableForeignKeyConstraintWhenMigrating: <span class="literal">false</span>,  <span class="comment">// 启用外键约束</span></span><br><span class="line">    IgnoreRelationshipsWhenMigrating: <span class="literal">false</span>,  <span class="comment">// 处理关联关系</span></span><br><span class="line">    Logger: logger.Default.LogMode(logger.Info),  <span class="comment">// 显示 SQL 日志</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="生产环境配置"><a href="#生产环境配置" class="headerlink" title="生产环境配置"></a>生产环境配置</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">db, err := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;</span><br><span class="line">    <span class="comment">// 生产环境建议配置</span></span><br><span class="line">    SkipDefaultTransaction: <span class="literal">true</span>,  <span class="comment">// 禁用默认事务以提升性能</span></span><br><span class="line">    DisableForeignKeyConstraintWhenMigrating: <span class="literal">true</span>,  <span class="comment">// 禁用外键约束</span></span><br><span class="line">    Logger: logger.Default.LogMode(logger.Silent),  <span class="comment">// 静默模式</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用版本化迁移而非 AutoMigrate</span></span><br><span class="line">runner := NewMigrationRunner(db, migrations)</span><br><span class="line"><span class="keyword">if</span> err := runner.Up(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Fatal(<span class="string">&quot;迁移失败:&quot;</span>, err)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="7-2-常见问题与解决方案"><a href="#7-2-常见问题与解决方案" class="headerlink" title="7.2 常见问题与解决方案"></a>7.2 常见问题与解决方案</h3><h4 id="迁移失败问题"><a href="#迁移失败问题" class="headerlink" title="迁移失败问题"></a>迁移失败问题</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 问题: AutoMigrate 失败，错误: &quot;Error 1064: You have an error in your SQL syntax&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 原因: 数据库方言特定语法问题</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 解决方案: 检查表选项设置</span></span><br><span class="line">db.Set(<span class="string">&quot;gorm:table_options&quot;</span>, <span class="string">&quot;ENGINE=InnoDB DEFAULT CHARSET=utf8mb4&quot;</span>).AutoMigrate(&amp;User&#123;&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="类型不匹配问题"><a href="#类型不匹配问题" class="headerlink" title="类型不匹配问题"></a>类型不匹配问题</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 问题: AutoMigrate 反复修改列类型</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 原因: Go 类型定义与数据库类型不完全匹配</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 解决方案: 使用 GORM 标签明确指定类型</span></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">    Status <span class="type">string</span> <span class="string">`gorm:&quot;type:varchar(20);default:&#x27;active&#x27;&quot;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="约束冲突问题"><a href="#约束冲突问题" class="headerlink" title="约束冲突问题"></a>约束冲突问题</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 问题: 创建外键约束失败</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 原因: 引用的表不存在或列不匹配</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 解决方案: 确保先迁移被引用的表</span></span><br><span class="line">db.AutoMigrate(&amp;Team&#123;&#125;, &amp;User&#123;&#125;)  <span class="comment">// Team 必须在 User 之前</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="八、学习验证"><a href="#八、学习验证" class="headerlink" title="八、学习验证"></a>八、学习验证</h2><h3 id="8-1-知识自测"><a href="#8-1-知识自测" class="headerlink" title="8.1 知识自测"></a>8.1 知识自测</h3><h4 id="基础题"><a href="#基础题" class="headerlink" title="基础题"></a>基础题</h4><ol>
<li><p><strong>以下哪个方法用于自动迁移模型？</strong></p>
<ul>
<li>A. db.Create()</li>
<li>B. db.AutoMigrate()</li>
<li>C. db.Migrate()</li>
<li>D. db.Update()</li>
</ul>
<p><strong>答案: B</strong></p>
</li>
<li><p><strong>AutoMigrate 的增量迁移策略包括哪些操作？</strong></p>
<ul>
<li>A. 只添加缺失的列</li>
<li>B. 只修改不匹配的列</li>
<li>C. 删除多余的列</li>
<li>D. A 和 B</li>
</ul>
<p><strong>答案: D</strong></p>
</li>
<li><p><strong>以下哪个 GORM 标签用于创建唯一索引？</strong></p>
<ul>
<li>A. <code>index</code></li>
<li>B. <code>uniqueIndex</code></li>
<li>C. <code>unique</code></li>
<li>D. B 和 C</li>
</ul>
<p><strong>答案: D</strong></p>
</li>
<li><p><strong>如何检查一个表是否存在？</strong></p>
<ul>
<li>A. db.Table(“users”).First()</li>
<li>B. db.Migrator().HasTable(&amp;User{})</li>
<li>C. db.Exec(“SHOW TABLES”)</li>
<li>D. 以上都可以</li>
</ul>
<p><strong>答案: B</strong></p>
</li>
<li><p><strong>MigrateColumn() 方法会检查哪些内容？</strong> (多选)</p>
<ul>
<li>A. 列类型</li>
<li>B. 列大小</li>
<li>C. 可空性</li>
<li>D. 默认值</li>
<li>E. 注释</li>
</ul>
<p><strong>答案: A, B, C, D, E</strong></p>
</li>
</ol>
<h4 id="进阶题"><a href="#进阶题" class="headerlink" title="进阶题"></a>进阶题</h4><ol>
<li><p><strong>分析以下代码的执行流程:</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">    ID   <span class="type">uint</span> <span class="string">`gorm:&quot;primaryKey&quot;`</span></span><br><span class="line">    Name <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line">db.AutoMigrate(&amp;User&#123;&#125;)</span><br></pre></td></tr></table></figure>

<p><strong>答案:</strong></p>
<ol>
<li>ReorderModels 排序模型</li>
<li>HasTable 检查表是否存在</li>
<li>表不存在，调用 CreateTable</li>
<li>生成 CREATE TABLE SQL</li>
<li>执行 SQL 创建表</li>
</ol>
</li>
<li><p><strong>如何实现跨数据库的类型映射？</strong></p>
<p><strong>答案:</strong></p>
<ul>
<li>实现 GormDataTypeInterface 接口</li>
<li>在 Dialector 中实现 DataTypeOf 方法</li>
<li>使用 GORM 标签指定特定类型</li>
</ul>
</li>
</ol>
<h4 id="实战题"><a href="#实战题" class="headerlink" title="实战题"></a>实战题</h4><ol>
<li><strong>实现一个完整的用户表迁移，包含索引和约束</strong></li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">    ID        <span class="type">uint</span>      <span class="string">`gorm:&quot;primaryKey&quot;`</span></span><br><span class="line">    Username  <span class="type">string</span>    <span class="string">`gorm:&quot;size:50;not null;uniqueIndex&quot;`</span></span><br><span class="line">    Email     <span class="type">string</span>    <span class="string">`gorm:&quot;size:100;not null;uniqueIndex&quot;`</span></span><br><span class="line">    Age       <span class="type">int</span>       <span class="string">`gorm:&quot;check:age &gt;= 18&quot;`</span></span><br><span class="line">    Status    <span class="type">string</span>    <span class="string">`gorm:&quot;size:20;default:&#x27;active&#x27;&quot;`</span></span><br><span class="line">    CreatedAt time.Time <span class="string">`gorm:&quot;autoCreateTime&quot;`</span></span><br><span class="line">    UpdatedAt time.Time <span class="string">`gorm:&quot;autoUpdateTime&quot;`</span></span><br><span class="line">    DeletedAt gorm.DeletedAt <span class="string">`gorm:&quot;index&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">db.AutoMigrate(&amp;User&#123;&#125;)</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="8-2-实践练习"><a href="#8-2-实践练习" class="headerlink" title="8.2 实践练习"></a>8.2 实践练习</h3><h4 id="练习-1-实现自定义迁移工具"><a href="#练习-1-实现自定义迁移工具" class="headerlink" title="练习 1: 实现自定义迁移工具"></a>练习 1: 实现自定义迁移工具</h4><p>创建一个支持回滚的迁移工具，要求:</p>
<ul>
<li>支持版本化迁移</li>
<li>支持迁移历史记录</li>
<li>支持回滚到指定版本</li>
</ul>
<p><strong>验收标准:</strong></p>
<ul>
<li>能够正确执行迁移</li>
<li>能够记录迁移历史</li>
<li>能够正确回滚迁移</li>
</ul>
<hr>
<h2 id="二、核心原理"><a href="#二、核心原理" class="headerlink" title="二、核心原理"></a>二、核心原理</h2><h3 id="2-1-关键概念"><a href="#2-1-关键概念" class="headerlink" title="2.1 关键概念"></a>2.1 关键概念</h3><h4 id="概念-2-AutoMigrate-实现"><a href="#概念-2-AutoMigrate-实现" class="headerlink" title="概念 2: AutoMigrate 实现"></a>概念 2: AutoMigrate 实现</h4><p><strong>定义</strong>: AutoMigrate 是自动迁移的核心方法。</p>
<p><strong>实现流程</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">AutoMigrate(dst ...interface&#123;&#125;) error:</span><br><span class="line">    │</span><br><span class="line">    ├─► 1. 解析所有模型的 Schema</span><br><span class="line">    │       └─ db.Statement.Parse(dst)</span><br><span class="line">    │           ├─ 提取字段信息</span><br><span class="line">    │           ├─ 提取关系信息</span><br><span class="line">    │           └─ 构建元数据</span><br><span class="line">    │</span><br><span class="line">    ├─► 2. 遍历每个模型</span><br><span class="line">    │       └─ for _, value := range dst</span><br><span class="line">    │           ├─ 获取表名</span><br><span class="line">    │           ├─ 检查表是否存在</span><br><span class="line">    │           │</span><br><span class="line">    │           ├─► 2a. 表不存在 → CreateTable()</span><br><span class="line">    │           │       └─ CREATE TABLE ...</span><br><span class="line">    │           │</span><br><span class="line">    │           └─► 2b. 表存在 → 增量更新</span><br><span class="line">    │                   ├─ 遍历所有字段</span><br><span class="line">    │                   │   ├─ 字段不存在 → AddColumn()</span><br><span class="line">    │                   │   ├─ 字段类型不同 → AlterColumn()</span><br><span class="line">    │                   │   └─ 字段存在 → 跳过</span><br><span class="line">    │                   │</span><br><span class="line">    │                   ├─ 处理关系 (外键)</span><br><span class="line">    │                   │   └─ CreateConstraint()</span><br><span class="line">    │                   │</span><br><span class="line">    │                   └─ 处理索引</span><br><span class="line">    │                       └─ CreateIndex()</span><br><span class="line">    │</span><br><span class="line">    └─► 3. 返回错误</span><br></pre></td></tr></table></figure>

<p><strong>关键代码</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m Migrator)</span></span> AutoMigrate(dst ...<span class="keyword">interface</span>&#123;&#125;) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> _, value := <span class="keyword">range</span> dst &#123;</span><br><span class="line">        <span class="comment">// === 1. 解析 Schema ===</span></span><br><span class="line">        tx := m.DB.Session(&amp;gorm.Session&#123;SkipDefaultTransaction: <span class="literal">true</span>&#125;)</span><br><span class="line">        <span class="keyword">if</span> err := tx.Statement.Parse(value); err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// === 2. 创建或更新表 ===</span></span><br><span class="line">        <span class="keyword">if</span> !m.HasTable(value) &#123;</span><br><span class="line">            <span class="comment">// 表不存在，创建新表</span></span><br><span class="line">            <span class="keyword">if</span> err := m.CreateTable(value); err != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> err</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 表存在，增量更新</span></span><br><span class="line">            <span class="keyword">for</span> _, field := <span class="keyword">range</span> tx.Statement.Schema.Fields &#123;</span><br><span class="line">                <span class="comment">// 检查列是否存在</span></span><br><span class="line">                <span class="keyword">if</span> !m.HasColumn(value, field.DBName) &#123;</span><br><span class="line">                    <span class="comment">// 添加新列</span></span><br><span class="line">                    <span class="keyword">if</span> err := m.AddColumn(value, field.DBName); err != <span class="literal">nil</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span> err</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// 列存在，检查类型是否匹配</span></span><br><span class="line">                    columnTypes, _ := m.ColumnTypes(value)</span><br><span class="line">                    <span class="keyword">for</span> _, columnType := <span class="keyword">range</span> columnTypes &#123;</span><br><span class="line">                        <span class="keyword">if</span> columnType.Name() == field.DBName &#123;</span><br><span class="line">                            <span class="comment">// 比较类型</span></span><br><span class="line">                            <span class="keyword">if</span> m.DB.Dialector.DataTypeOf(field) != columnType.DatabaseTypeName() &#123;</span><br><span class="line">                                <span class="comment">// 类型不匹配，修改列</span></span><br><span class="line">                                m.AlterColumn(value, field.DBName)</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// === 3. 处理关系 ===</span></span><br><span class="line">        <span class="keyword">for</span> _, rel := <span class="keyword">range</span> tx.Statement.Schema.Relationships.Relations &#123;</span><br><span class="line">            <span class="keyword">if</span> rel.Type == schema.HasMany || rel.Type == schema.Many2Many &#123;</span><br><span class="line">                <span class="comment">// 多对多关系，创建中间表</span></span><br><span class="line">                <span class="keyword">if</span> !m.HasTable(rel.JoinTable) &#123;</span><br><span class="line">                    m.CreateTable(rel.JoinTable)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 一对一、一对多，创建外键约束</span></span><br><span class="line">                <span class="keyword">if</span> !m.HasConstraint(value, rel.Name) &#123;</span><br><span class="line">                    m.CreateConstraint(value, rel.Name)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// === 4. 处理索引 ===</span></span><br><span class="line">        <span class="keyword">for</span> _, index := <span class="keyword">range</span> tx.Statement.Schema.ParseIndexes() &#123;</span><br><span class="line">            <span class="keyword">if</span> !m.HasIndex(value, index.Name) &#123;</span><br><span class="line">                m.CreateIndex(value, index.Name)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="概念-3-类型映射系统"><a href="#概念-3-类型映射系统" class="headerlink" title="概念 3: 类型映射系统"></a>概念 3: 类型映射系统</h4><p><strong>定义</strong>: 类型映射将 Go 类型转换为数据库特定的 SQL 类型。</p>
<p><strong>类型映射表</strong>:</p>
<table>
<thead>
<tr>
<th>Go 类型</th>
<th>MySQL</th>
<th>PostgreSQL</th>
<th>SQLite</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>int</td>
<td>INT</td>
<td>INTEGER</td>
<td>INTEGER</td>
<td>有符号整数</td>
</tr>
<tr>
<td>uint</td>
<td>INT UNSIGNED</td>
<td>BIGINT</td>
<td>INTEGER</td>
<td>无符号整数</td>
</tr>
<tr>
<td>int64</td>
<td>BIGINT</td>
<td>BIGINT</td>
<td>INTEGER</td>
<td>大整数</td>
</tr>
<tr>
<td>uint64</td>
<td>BIGINT UNSIGNED</td>
<td>BIGINT</td>
<td>INTEGER</td>
<td>大整数</td>
</tr>
<tr>
<td>float32</td>
<td>FLOAT</td>
<td>REAL</td>
<td>REAL</td>
<td>浮点数</td>
</tr>
<tr>
<td>float64</td>
<td>DOUBLE</td>
<td>DOUBLE PRECISION</td>
<td>REAL</td>
<td>双精度</td>
</tr>
<tr>
<td>string</td>
<td>VARCHAR(255)</td>
<td>VARCHAR(255)</td>
<td>TEXT</td>
<td>可变长字符串</td>
</tr>
<tr>
<td>[]byte</td>
<td>BLOB</td>
<td>BYTEA</td>
<td>BLOB</td>
<td>二进制数据</td>
</tr>
<tr>
<td>bool</td>
<td>TINYINT(1)</td>
<td>BOOLEAN</td>
<td>BOOLEAN</td>
<td>布尔值</td>
</tr>
<tr>
<td>time.Time</td>
<td>TIMESTAMP</td>
<td>TIMESTAMPTZ</td>
<td>DATETIME</td>
<td>时间戳</td>
</tr>
</tbody></table>
<p><strong>GORM 标签影响</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// size: 指定字符串长度</span></span><br><span class="line">Name <span class="type">string</span> <span class="string">`gorm:&quot;size:100&quot;`</span>  → VARCHAR(<span class="number">100</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// not null: 非空约束</span></span><br><span class="line">Name <span class="type">string</span> <span class="string">`gorm:&quot;not null&quot;`</span>  → VARCHAR(<span class="number">255</span>) NOT NULL</span><br><span class="line"></span><br><span class="line"><span class="comment">// default: 默认值</span></span><br><span class="line">Status <span class="type">string</span> <span class="string">`gorm:&quot;default:&#x27;active&#x27;&quot;`</span>  → VARCHAR(<span class="number">255</span>) DEFAULT <span class="string">&#x27;active&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// unique: 唯一约束</span></span><br><span class="line">Email <span class="type">string</span> <span class="string">`gorm:&quot;unique&quot;`</span>  → VARCHAR(<span class="number">255</span>) UNIQUE</span><br><span class="line"></span><br><span class="line"><span class="comment">// index: 创建索引</span></span><br><span class="line">Name <span class="type">string</span> <span class="string">`gorm:&quot;index&quot;`</span>  → 创建索引 idx_&lt;table&gt;_name</span><br><span class="line"></span><br><span class="line"><span class="comment">// uniqueIndex: 唯一索引</span></span><br><span class="line">Email <span class="type">string</span> <span class="string">`gorm:&quot;uniqueIndex&quot;`</span>  → 创建唯一索引</span><br><span class="line"></span><br><span class="line"><span class="comment">// autoCreateTime: 自动创建时间</span></span><br><span class="line">CreatedAt time.Time <span class="string">`gorm:&quot;autoCreateTime&quot;`</span>  → TIMESTAMP DEFAULT CURRENT_TIMESTAMP</span><br><span class="line"></span><br><span class="line"><span class="comment">// autoUpdateTime: 自动更新时间</span></span><br><span class="line">UpdatedAt time.Time <span class="string">`gorm:&quot;autoUpdateTime&quot;`</span>  → TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP</span><br></pre></td></tr></table></figure>

<p><strong>自定义类型映射</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 方式 1: 使用 GORM 标签</span></span><br><span class="line"><span class="keyword">type</span> CustomType <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">    Data CustomType <span class="string">`gorm:&quot;type:varchar(500)&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方式 2: 实现 GormDataTypeInterface</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(CustomType)</span></span> GormDataType() <span class="type">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;varchar(500)&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方式 3: 自定义 Dialector</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d CustomDialector)</span></span> DataTypeOf(field *schema.Field) <span class="type">string</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> field.DataType == <span class="string">&quot;customtype&quot;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;TEXT&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> d.Dialector.DataTypeOf(field)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="概念-4-约束管理"><a href="#概念-4-约束管理" class="headerlink" title="概念 4: 约束管理"></a>概念 4: 约束管理</h4><p><strong>定义</strong>: 约束管理处理主键、外键、唯一约束等。</p>
<p><strong>主键约束</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">    ID <span class="type">uint</span> <span class="string">`gorm:&quot;primaryKey&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生成的 SQL</span></span><br><span class="line"><span class="comment">// MySQL:     id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY</span></span><br><span class="line"><span class="comment">// PostgreSQL: id BIGSERIAL PRIMARY KEY</span></span><br><span class="line"><span class="comment">// SQLite:    id INTEGER PRIMARY KEY AUTOINCREMENT</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 复合主键</span></span><br><span class="line"><span class="keyword">type</span> OrderItem <span class="keyword">struct</span> &#123;</span><br><span class="line">    OrderID   <span class="type">uint</span> <span class="string">`gorm:&quot;primaryKey&quot;`</span></span><br><span class="line">    ProductID <span class="type">uint</span> <span class="string">`gorm:&quot;primaryKey&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生成的 SQL</span></span><br><span class="line"><span class="comment">// PRIMARY KEY (order_id, product_id)</span></span><br></pre></td></tr></table></figure>

<p><strong>外键约束</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">    ID   <span class="type">uint</span></span><br><span class="line">    Name <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Order <span class="keyword">struct</span> &#123;</span><br><span class="line">    ID     <span class="type">uint</span></span><br><span class="line">    UserID <span class="type">uint</span> <span class="string">`gorm:&quot;not null&quot;`</span></span><br><span class="line">    User   User <span class="string">`gorm:&quot;foreignKey:UserID;references:ID&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生成的 SQL</span></span><br><span class="line"><span class="comment">// ALTER TABLE orders</span></span><br><span class="line"><span class="comment">// ADD CONSTRAINT fk_orders_user</span></span><br><span class="line"><span class="comment">// FOREIGN KEY (user_id) REFERENCES users(id)</span></span><br><span class="line"><span class="comment">// ON DELETE SET NULL</span></span><br><span class="line"><span class="comment">// ON UPDATE CASCADE</span></span><br></pre></td></tr></table></figure>

<p><strong>唯一约束</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">    Email <span class="type">string</span> <span class="string">`gorm:&quot;unique&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生成的 SQL</span></span><br><span class="line"><span class="comment">// UNIQUE INDEX idx_users_email ON users(email)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 复合唯一约束</span></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">    FirstName <span class="type">string</span></span><br><span class="line">    LastName  <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建复合唯一索引</span></span><br><span class="line">db.Migrator().CreateIndex(&amp;User&#123;&#125;, <span class="string">&quot;idx_users_name&quot;</span>)</span><br><span class="line"><span class="comment">// CREATE UNIQUE INDEX idx_users_name ON users(first_name, last_name)</span></span><br></pre></td></tr></table></figure>

<h4 id="概念-5-索引管理"><a href="#概念-5-索引管理" class="headerlink" title="概念 5: 索引管理"></a>概念 5: 索引管理</h4><p><strong>定义</strong>: 索引管理处理普通索引和唯一索引的创建和删除。</p>
<p><strong>索引类型</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">    ID    <span class="type">uint</span></span><br><span class="line">    Name  <span class="type">string</span> <span class="string">`gorm:&quot;index&quot;`</span>          <span class="comment">// 普通索引</span></span><br><span class="line">    Email <span class="type">string</span> <span class="string">`gorm:&quot;uniqueIndex&quot;`</span>    <span class="comment">// 唯一索引</span></span><br><span class="line">    Age   <span class="type">int</span>    <span class="string">`gorm:&quot;index:idx_age&quot;`</span>  <span class="comment">// 命名索引</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>索引策略</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">索引选择原则:</span><br><span class="line"></span><br><span class="line">适合创建索引的列:</span><br><span class="line">┌────────────────────────────────────┐</span><br><span class="line">│ 1. 经常用于 WHERE 查询的列        │</span><br><span class="line">│ 2. 经常用于 JOIN 连接的列          │</span><br><span class="line">│ 3. 经常用于 ORDER BY 的列         │</span><br><span class="line">│ 4. 唯一性约束列                   │</span><br><span class="line">└────────────────────────────────────┘</span><br><span class="line"></span><br><span class="line">不适合创建索引的列:</span><br><span class="line">┌────────────────────────────────────┐</span><br><span class="line">│ 1. 频繁更新的列                  │</span><br><span class="line">│ 2. 区分度低的列 (如性别)          │</span><br><span class="line">│ 3. BLOB/TEXT 大文本列             │</span><br><span class="line">│ 4. 记录很少的表                   │</span><br><span class="line">└────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<p><strong>复合索引</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 复合索引</span></span><br><span class="line"><span class="keyword">type</span> Order <span class="keyword">struct</span> &#123;</span><br><span class="line">    UserID     <span class="type">uint</span></span><br><span class="line">    ProductID  <span class="type">uint</span></span><br><span class="line">    Status     <span class="type">string</span></span><br><span class="line">    CreatedAt  time.Time</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建复合索引</span></span><br><span class="line">db.Migrator().CreateIndex(&amp;Order&#123;&#125;, <span class="string">&quot;idx_user_product_status&quot;</span>)</span><br><span class="line"><span class="comment">// CREATE INDEX idx_user_product_status ON orders(user_id, product_id, status)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 索引顺序很重要</span></span><br><span class="line"><span class="comment">// - 最常用的查询字段放前面</span></span><br><span class="line"><span class="comment">// - 区分度高的字段放前面</span></span><br></pre></td></tr></table></figure>

<h3 id="2-2-理论基础"><a href="#2-2-理论基础" class="headerlink" title="2.2 理论基础"></a>2.2 理论基础</h3><h4 id="理论-1-增量迁移策略"><a href="#理论-1-增量迁移策略" class="headerlink" title="理论 1: 增量迁移策略"></a>理论 1: 增量迁移策略</h4><p><strong>增量迁移 vs 完全重建</strong>:</p>
<table>
<thead>
<tr>
<th>策略</th>
<th>优点</th>
<th>缺点</th>
<th>适用场景</th>
</tr>
</thead>
<tbody><tr>
<td>增量迁移</td>
<td>保留数据、安全</td>
<td>复杂、易出错</td>
<td>生产环境</td>
</tr>
<tr>
<td>完全重建</td>
<td>简单、一致</td>
<td>丢失数据、停机</td>
<td>开发环境</td>
</tr>
</tbody></table>
<p><strong>增量迁移实现</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 安全的增量迁移流程</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SafeMigrate</span><span class="params">(db *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    <span class="comment">// === 1. 检查表是否存在 ===</span></span><br><span class="line">    <span class="keyword">if</span> !db.Migrator().HasTable(&amp;User&#123;&#125;) &#123;</span><br><span class="line">        <span class="keyword">if</span> err := db.Migrator().CreateTable(&amp;User&#123;&#125;); err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 2. 检查列是否存在 ===</span></span><br><span class="line">    <span class="keyword">if</span> !db.Migrator().HasColumn(&amp;User&#123;&#125;, <span class="string">&quot;avatar&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> err := db.Migrator().AddColumn(&amp;User&#123;&#125;, <span class="string">&quot;avatar&quot;</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 3. 检查并修改列类型 ===</span></span><br><span class="line">    columnTypes, _ := db.Migrator().ColumnTypes(&amp;User&#123;&#125;)</span><br><span class="line">    <span class="keyword">for</span> _, ct := <span class="keyword">range</span> columnTypes &#123;</span><br><span class="line">        <span class="keyword">if</span> ct.Name() == <span class="string">&quot;name&quot;</span> &amp;&amp; ct.DatabaseTypeName() != <span class="string">&quot;varchar(100)&quot;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> err := db.Migrator().AlterColumn(&amp;User&#123;&#125;, <span class="string">&quot;name&quot;</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> err</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 4. 检查索引是否存在 ===</span></span><br><span class="line">    <span class="keyword">if</span> !db.Migrator().HasIndex(&amp;User&#123;&#125;, <span class="string">&quot;idx_users_email&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> err := db.Migrator().CreateIndex(&amp;User&#123;&#125;, <span class="string">&quot;idx_users_email&quot;</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="理论-2-版本化迁移"><a href="#理论-2-版本化迁移" class="headerlink" title="理论 2: 版本化迁移"></a>理论 2: 版本化迁移</h4><p><strong>定义</strong>: 版本化迁移为每次迁移分配版本号，支持回滚。</p>
<p><strong>迁移模型</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Migration <span class="keyword">struct</span> &#123;</span><br><span class="line">    Version <span class="type">string</span>    <span class="comment">// 版本号: 20240101_120000</span></span><br><span class="line">    Name    <span class="type">string</span>    <span class="comment">// 迁移名称</span></span><br><span class="line">    Up      <span class="function"><span class="keyword">func</span><span class="params">(*gorm.DB)</span></span> <span class="type">error</span>   <span class="comment">// 向上迁移</span></span><br><span class="line">    Down    <span class="function"><span class="keyword">func</span><span class="params">(*gorm.DB)</span></span> <span class="type">error</span>   <span class="comment">// 向下迁移</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 迁移列表</span></span><br><span class="line"><span class="keyword">var</span> migrations = []Migration&#123;</span><br><span class="line">    &#123;</span><br><span class="line">        Version: <span class="string">&quot;20240101_120000&quot;</span>,</span><br><span class="line">        Name:    <span class="string">&quot;create_users_table&quot;</span>,</span><br><span class="line">        Up: <span class="function"><span class="keyword">func</span><span class="params">(db *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> db.Migrator().CreateTable(&amp;User&#123;&#125;)</span><br><span class="line">        &#125;,</span><br><span class="line">        Down: <span class="function"><span class="keyword">func</span><span class="params">(db *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> db.Migrator().DropTable(&amp;User&#123;&#125;)</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        Version: <span class="string">&quot;20240102_120000&quot;</span>,</span><br><span class="line">        Name:    <span class="string">&quot;add_avatar_to_users&quot;</span>,</span><br><span class="line">        Up: <span class="function"><span class="keyword">func</span><span class="params">(db *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> db.Migrator().AddColumn(&amp;User&#123;&#125;, <span class="string">&quot;avatar&quot;</span>)</span><br><span class="line">        &#125;,</span><br><span class="line">        Down: <span class="function"><span class="keyword">func</span><span class="params">(db *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> db.Migrator().DropColumn(&amp;User&#123;&#125;, <span class="string">&quot;avatar&quot;</span>)</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>迁移执行</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RunMigrations</span><span class="params">(db *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    <span class="comment">// === 1. 创建迁移历史表 ===</span></span><br><span class="line">    db.Migrator().AutoMigrate(&amp;MigrationHistory&#123;&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 2. 获取已执行的迁移 ===</span></span><br><span class="line">    <span class="keyword">var</span> executed []<span class="type">string</span></span><br><span class="line">    db.Model(&amp;MigrationHistory&#123;&#125;).Pluck(<span class="string">&quot;version&quot;</span>, &amp;executed)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 3. 执行未执行的迁移 ===</span></span><br><span class="line">    <span class="keyword">for</span> _, migration := <span class="keyword">range</span> migrations &#123;</span><br><span class="line">        <span class="keyword">if</span> !contains(executed, migration.Version) &#123;</span><br><span class="line">            <span class="comment">// 执行迁移</span></span><br><span class="line">            <span class="keyword">if</span> err := migration.Up(db); err != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> err</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 记录迁移历史</span></span><br><span class="line">            db.Create(&amp;MigrationHistory&#123;</span><br><span class="line">                Version: migration.Version,</span><br><span class="line">                Name:    migration.Name,</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 回滚</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RollbackMigration</span><span class="params">(db *gorm.DB, version <span class="type">string</span>)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> migration Migration</span><br><span class="line">    <span class="keyword">for</span> _, m := <span class="keyword">range</span> migrations &#123;</span><br><span class="line">        <span class="keyword">if</span> m.Version == version &#123;</span><br><span class="line">            migration = m</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行向下迁移</span></span><br><span class="line">    <span class="keyword">if</span> err := migration.Down(db); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 删除迁移历史</span></span><br><span class="line">    db.Where(<span class="string">&quot;version = ?&quot;</span>, version).Delete(&amp;MigrationHistory&#123;&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="理论-3-数据库兼容性"><a href="#理论-3-数据库兼容性" class="headerlink" title="理论 3: 数据库兼容性"></a>理论 3: 数据库兼容性</h4><p><strong>方言差异处理</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MySQL</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m MySQL)</span></span> CreateTable(dst ...<span class="keyword">interface</span>&#123;&#125;) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> m.RunWithValue(dst, <span class="string">&quot;&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(stmt *Statement)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> _, column := <span class="keyword">range</span> stmt.Schema.Fields &#123;</span><br><span class="line">            <span class="comment">// MySQL 特定语法</span></span><br><span class="line">            <span class="keyword">if</span> column.PrimaryKey &#123;</span><br><span class="line">                sql += <span class="string">&quot; AUTO_INCREMENT&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PostgreSQL</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m Postgres)</span></span> CreateTable(dst ...<span class="keyword">interface</span>&#123;&#125;) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> m.RunWithValue(dst, <span class="string">&quot;&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(stmt *Statement)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> _, column := <span class="keyword">range</span> stmt.Schema.Fields &#123;</span><br><span class="line">            <span class="comment">// PostgreSQL 特定语法</span></span><br><span class="line">            <span class="keyword">if</span> column.PrimaryKey &#123;</span><br><span class="line">                sql += <span class="string">&quot; SERIAL&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SQLite</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m SQLite)</span></span> CreateTable(dst ...<span class="keyword">interface</span>&#123;&#125;) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> m.RunWithValue(dst, <span class="string">&quot;&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(stmt *Statement)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> _, column := <span class="keyword">range</span> stmt.Schema.Fields &#123;</span><br><span class="line">            <span class="comment">// SQLite 特定语法</span></span><br><span class="line">            <span class="keyword">if</span> column.PrimaryKey &#123;</span><br><span class="line">                sql += <span class="string">&quot; PRIMARY KEY AUTOINCREMENT&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-学习方法"><a href="#2-3-学习方法" class="headerlink" title="2.3 学习方法"></a>2.3 学习方法</h3><h4 id="方法-1-对比法"><a href="#方法-1-对比法" class="headerlink" title="方法 1: 对比法"></a>方法 1: 对比法</h4><p><strong>对比不同迁移方式</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 方式 1: AutoMigrate (推荐开发环境)</span></span><br><span class="line">db.AutoMigrate(&amp;User&#123;&#125;, &amp;Order&#123;&#125;, &amp;Product&#123;&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 优点:</span></span><br><span class="line"><span class="comment">// - 简单快速</span></span><br><span class="line"><span class="comment">// - 自动处理</span></span><br><span class="line"><span class="comment">// - 适合开发环境</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 缺点:</span></span><br><span class="line"><span class="comment">// - 无法回滚</span></span><br><span class="line"><span class="comment">// - 无法版本控制</span></span><br><span class="line"><span class="comment">// - 可能导致数据丢失</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 方式 2: 版本化迁移 (推荐生产环境)</span></span><br><span class="line">RunMigrations(db)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 优点:</span></span><br><span class="line"><span class="comment">// - 可回滚</span></span><br><span class="line"><span class="comment">// - 版本控制</span></span><br><span class="line"><span class="comment">// - 安全可控</span></span><br><span class="line"><span class="comment">// - 适合生产环境</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 缺点:</span></span><br><span class="line"><span class="comment">// - 需要手动维护</span></span><br><span class="line"><span class="comment">// - 开发速度慢</span></span><br></pre></td></tr></table></figure>

<h4 id="方法-2-实验法"><a href="#方法-2-实验法" class="headerlink" title="方法 2: 实验法"></a>方法 2: 实验法</h4><p><strong>实验 1: 观察迁移 SQL</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 启用 SQL 日志</span></span><br><span class="line">db, _ := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;</span><br><span class="line">    Logger: logger.Default.LogMode(logger.Info),</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行迁移</span></span><br><span class="line">db.AutoMigrate(&amp;User&#123;&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 观察日志:</span></span><br><span class="line"><span class="comment">// [2024-01-01 10:00:00] CREATE TABLE `users` (</span></span><br><span class="line"><span class="comment">//   `id` bigint unsigned AUTO_INCREMENT PRIMARY KEY,</span></span><br><span class="line"><span class="comment">//   `name` varchar(100) NOT NULL,</span></span><br><span class="line"><span class="comment">//   `email` varchar(255),</span></span><br><span class="line"><span class="comment">//   `created_at` timestamp NULL,</span></span><br><span class="line"><span class="comment">//   `updated_at` timestamp NULL</span></span><br><span class="line"><span class="comment">// ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4</span></span><br></pre></td></tr></table></figure>

<p><strong>实验 2: 测试增量迁移</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 初始模型</span></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">    ID   <span class="type">uint</span></span><br><span class="line">    Name <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">db.AutoMigrate(&amp;User&#123;&#125;)</span><br><span class="line"><span class="comment">// 创建表: CREATE TABLE users (id INT, name VARCHAR(255))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 修改模型</span></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">    ID     <span class="type">uint</span></span><br><span class="line">    Name   <span class="type">string</span></span><br><span class="line">    Avatar <span class="type">string</span>  <span class="comment">// 新增字段</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">db.AutoMigrate(&amp;User&#123;&#125;)</span><br><span class="line"><span class="comment">// 增量迁移: ALTER TABLE users ADD COLUMN avatar VARCHAR(255)</span></span><br></pre></td></tr></table></figure>

<h3 id="2-4-实施策略"><a href="#2-4-实施策略" class="headerlink" title="2.4 实施策略"></a>2.4 实施策略</h3><h4 id="策略-1-分层学习"><a href="#策略-1-分层学习" class="headerlink" title="策略 1: 分层学习"></a>策略 1: 分层学习</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">第 1 层: 理解基本概念 (Day 1)</span><br><span class="line">  目标: 理解迁移的基本概念</span><br><span class="line">  内容:</span><br><span class="line">    - AutoMigrate API</span><br><span class="line">    - Migrator 接口</span><br><span class="line">    - 类型映射</span><br><span class="line">  验证:</span><br><span class="line">    - 能使用 AutoMigrate</span><br><span class="line">    - 能理解类型映射</span><br><span class="line">    - 能配置字段标签</span><br><span class="line"></span><br><span class="line">第 2 层: 掌握高级迁移 (Day 2)</span><br><span class="line">  目标: 理解迁移的内部实现</span><br><span class="line">  内容:</span><br><span class="line">    - 增量迁移策略</span><br><span class="line">    - 约束管理</span><br><span class="line">    - 索引管理</span><br><span class="line">  验证:</span><br><span class="line">    - 能实现增量迁移</span><br><span class="line">    - 能管理约束</span><br><span class="line">    - 能优化索引</span><br><span class="line"></span><br><span class="line">第 3 层: 应用最佳实践 (Day 3)</span><br><span class="line">  目标: 掌握生产环境迁移</span><br><span class="line">  内容:</span><br><span class="line">    - 版本化迁移</span><br><span class="line">    - 迁移回滚</span><br><span class="line">    - 安全迁移</span><br><span class="line">  验证:</span><br><span class="line">    - 能实现版本化迁移</span><br><span class="line">    - 能安全回滚</span><br><span class="line">    - 能规划迁移策略</span><br></pre></td></tr></table></figure>

<h4 id="策略-2-场景驱动"><a href="#策略-2-场景驱动" class="headerlink" title="策略 2: 场景驱动"></a>策略 2: 场景驱动</h4><p><strong>场景序列</strong>:</p>
<ol>
<li><p><strong>开发环境快速迭代</strong></p>
<ul>
<li>使用 AutoMigrate</li>
<li>允许删除重建</li>
<li>优先开发速度</li>
</ul>
</li>
<li><p><strong>生产环境零停机</strong></p>
<ul>
<li>使用版本化迁移</li>
<li>增量更新</li>
<li>支持回滚</li>
</ul>
</li>
<li><p><strong>大数据表迁移</strong></p>
<ul>
<li>分批迁移</li>
<li>在线变更</li>
<li>降级策略</li>
</ul>
</li>
</ol>
<hr>
<h2 id="三、学习路径建议"><a href="#三、学习路径建议" class="headerlink" title="三、学习路径建议"></a>三、学习路径建议</h2><h3 id="3-1-前置知识检查"><a href="#3-1-前置知识检查" class="headerlink" title="3.1 前置知识检查"></a>3.1 前置知识检查</h3><table>
<thead>
<tr>
<th>知识点</th>
<th>要求</th>
<th>检验方式</th>
</tr>
</thead>
<tbody><tr>
<td>SQL DDL</td>
<td>理解 CREATE&#x2F;ALTER&#x2F;DROP</td>
<td>能写出基本的 DDL 语句</td>
</tr>
<tr>
<td>数据库类型</td>
<td>了解基本数据类型</td>
<td>能对比 VARCHAR 和 TEXT</td>
</tr>
<tr>
<td>索引原理</td>
<td>理解索引的作用</td>
<td>能解释何时使用索引</td>
</tr>
<tr>
<td>约束概念</td>
<td>了解主键、外键</td>
<td>能解释约束的作用</td>
</tr>
</tbody></table>
<h3 id="3-2-学习时间分配"><a href="#3-2-学习时间分配" class="headerlink" title="3.2 学习时间分配"></a>3.2 学习时间分配</h3><table>
<thead>
<tr>
<th>内容</th>
<th>理论</th>
<th>实践</th>
<th>产出</th>
</tr>
</thead>
<tbody><tr>
<td>Day 1: 迁移基础</td>
<td>2h</td>
<td>1.5h</td>
<td>AutoMigrate 示例</td>
</tr>
<tr>
<td>Day 2: 高级迁移</td>
<td>1.5h</td>
<td>2h</td>
<td>约束和索引示例</td>
</tr>
<tr>
<td>Day 3: 生产实践</td>
<td>1.5h</td>
<td>2h</td>
<td>版本化迁移系统</td>
</tr>
</tbody></table>
<h3 id="3-3-学习成果验收"><a href="#3-3-学习成果验收" class="headerlink" title="3.3 学习成果验收"></a>3.3 学习成果验收</h3><p><strong>理论验收</strong>:</p>
<ul>
<li><input disabled="" type="checkbox"> 能解释 AutoMigrate 的原理</li>
<li><input disabled="" type="checkbox"> 能说明类型映射机制</li>
<li><input disabled="" type="checkbox"> 能理解增量迁移策略</li>
<li><input disabled="" type="checkbox"> 能对比不同迁移方式</li>
</ul>
<p><strong>实践验收</strong>:</p>
<ul>
<li><input disabled="" type="checkbox"> 能使用 AutoMigrate</li>
<li><input disabled="" type="checkbox"> 能使用 Migrator API</li>
<li><input disabled="" type="checkbox"> 能管理约束和索引</li>
<li><input disabled="" type="checkbox"> 能实现版本化迁移</li>
</ul>
<p><strong>综合验收</strong>:</p>
<ul>
<li><input disabled="" type="checkbox"> 能设计迁移策略</li>
<li><input disabled="" type="checkbox"> 能优化迁移性能</li>
<li><input disabled="" type="checkbox"> 能排查迁移问题</li>
<li><input disabled="" type="checkbox"> 能向他人讲解迁移系统</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a target="_blank" rel="noopener" href="https://github.com/Piwriw">Joohwan.</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://piwriw.github.io/2026/01/11/web/gorm/08-migration/">https://piwriw.github.io/2026/01/11/web/gorm/08-migration/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://piwriw.github.io" target="_blank">Joohwan</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/web/">web</a><a class="post-meta__tags" href="/tags/Gorm/">Gorm</a><a class="post-meta__tags" href="/tags/%E6%BA%90%E7%A0%81/">源码</a></div><div class="post-share"><div class="social-share" data-image="/img/go.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>赞助</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2026/01/11/web/gorm/10-plugin/" title="Gorm-插件系统模块原理说明"><img class="cover" src="/img/go.png" onerror="onerror=null;src='/img/404.png'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">Gorm-插件系统模块原理说明</div></div><div class="info-2"><div class="info-item-1">插件系统模块原理说明 基于1.31 本文档深入解析插件系统模块的设计原理和核心实现，涵盖扩展机制、插件开发、集成模式等核心内容。  目录 一、设计原理 1.1 模块定位 1.2 设计目的 1.3 结构安排依据 1.4 与其他模块的逻辑关系 1.5 插件类型分类   二、核心数据结构 2.1 Plugin 接口 2.2 Config 插件字段 2.3 Use() 方法   三、核心实现 3.1 插件注册机制 3.2 插件初始化流程 3.3 回调系统集成 3.4 插件状态管理   四、实战代码示例 4.1 基础插件开发 4.2 读写分离插件 4.3 查询缓存插件 4.4 性能监控插件 4.5 数据脱敏插件   五、可视化流程图 5.1 插件注册流程 5.2 插件初始化流程 5.3 回调集成流程 5.4 插件系统架构   六、最佳实践与故障排查 6.1 开发最佳实践 6.2 常见问题与解决方案 6.3 性能优化建议 6.4 安全建议   七、学习验证 7.1 知识自测 7.2 实践练习     一、设计原理1.1 模块定位在整体架构中的位置 插件系统是 GORM 的扩展机制，位于应用层...</div></div></div></a><a class="pagination-related" href="/2026/01/11/web/gorm/07-transaction/" title="Gorm-事务处理模块原理说明"><img class="cover" src="/img/go.png" onerror="onerror=null;src='/img/404.png'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">Gorm-事务处理模块原理说明</div></div><div class="info-2"><div class="info-item-1">事务处理模块原理说明 基于1.31 本文档深入解析事务处理模块的设计原理和核心实现，涵盖事务管理、嵌套事务、保存点机制等核心内容。通过阅读本文档，您将能够完全理解 GORM 事务处理模块的工作原理，无需额外阅读源码。   目录 一、设计原理 1.1 模块定位 1.2 设计目的 1.3 结构安排依据 1.4 与其他模块的逻辑关系   二、核心数据结构 2.1 事务相关接口 2.2 TxOptions 配置   三、事务核心实现 3.1 Transaction 函数完整实现 3.2 Begin 函数完整实现 3.3 Commit 和 Rollback 实现 3.4 SavePoint 和 RollbackTo 实现 3.5 事务执行流程图   四、默认事务机制 4.1 BeginTransaction 实现 4.2 CommitOrRollbackTransaction 实现 4.3 回调注册流程 4.4 默认事务流程图   五、实战代码示例 5.1 基础事务使用 5.2 嵌套事务使用 5.3 手动事务控制 5.4 保存点使用 5.5 隔离级别配置 5.6 复杂业务场景   六、最佳...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2026/01/11/web/gorm/09-logger/" title="Gorm-日志系统模块原理说明"><img class="cover" src="/img/go.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-01-11</div><div class="info-item-2">Gorm-日志系统模块原理说明</div></div><div class="info-2"><div class="info-item-1">日志系统模块原理说明 基于1.31 本文档深入解析日志系统模块的设计原理和核心实现，涵盖 SQL 日志记录、性能分析、调用栈追踪等核心内容。学习完本文档后，您将能够彻底理解 GORM 日志系统的工作机制，并能够实现自定义 Logger 来满足各种日志需求。  文档目录12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394959697989910010110210310410510610710810911011111211311411511611711811912012112212312412512612712812913013113213313413513613713813914009-logger.md├── 一、设计原理│   ├── 1.1 模块定位│   ├── 1.2 设...</div></div></div></a><a class="pagination-related" href="/2026/01/11/web/gorm/10-plugin/" title="Gorm-插件系统模块原理说明"><img class="cover" src="/img/go.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-01-11</div><div class="info-item-2">Gorm-插件系统模块原理说明</div></div><div class="info-2"><div class="info-item-1">插件系统模块原理说明 基于1.31 本文档深入解析插件系统模块的设计原理和核心实现，涵盖扩展机制、插件开发、集成模式等核心内容。  目录 一、设计原理 1.1 模块定位 1.2 设计目的 1.3 结构安排依据 1.4 与其他模块的逻辑关系 1.5 插件类型分类   二、核心数据结构 2.1 Plugin 接口 2.2 Config 插件字段 2.3 Use() 方法   三、核心实现 3.1 插件注册机制 3.2 插件初始化流程 3.3 回调系统集成 3.4 插件状态管理   四、实战代码示例 4.1 基础插件开发 4.2 读写分离插件 4.3 查询缓存插件 4.4 性能监控插件 4.5 数据脱敏插件   五、可视化流程图 5.1 插件注册流程 5.2 插件初始化流程 5.3 回调集成流程 5.4 插件系统架构   六、最佳实践与故障排查 6.1 开发最佳实践 6.2 常见问题与解决方案 6.3 性能优化建议 6.4 安全建议   七、学习验证 7.1 知识自测 7.2 实践练习     一、设计原理1.1 模块定位在整体架构中的位置 插件系统是 GORM 的扩展机制，位于应用层...</div></div></div></a><a class="pagination-related" href="/2026/01/11/web/gorm/07-transaction/" title="Gorm-事务处理模块原理说明"><img class="cover" src="/img/go.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-01-11</div><div class="info-item-2">Gorm-事务处理模块原理说明</div></div><div class="info-2"><div class="info-item-1">事务处理模块原理说明 基于1.31 本文档深入解析事务处理模块的设计原理和核心实现，涵盖事务管理、嵌套事务、保存点机制等核心内容。通过阅读本文档，您将能够完全理解 GORM 事务处理模块的工作原理，无需额外阅读源码。   目录 一、设计原理 1.1 模块定位 1.2 设计目的 1.3 结构安排依据 1.4 与其他模块的逻辑关系   二、核心数据结构 2.1 事务相关接口 2.2 TxOptions 配置   三、事务核心实现 3.1 Transaction 函数完整实现 3.2 Begin 函数完整实现 3.3 Commit 和 Rollback 实现 3.4 SavePoint 和 RollbackTo 实现 3.5 事务执行流程图   四、默认事务机制 4.1 BeginTransaction 实现 4.2 CommitOrRollbackTransaction 实现 4.3 回调注册流程 4.4 默认事务流程图   五、实战代码示例 5.1 基础事务使用 5.2 嵌套事务使用 5.3 手动事务控制 5.4 保存点使用 5.5 隔离级别配置 5.6 复杂业务场景   六、最佳...</div></div></div></a><a class="pagination-related" href="/2026/01/11/web/gorm/06-associations/" title="Gorm-关联关系模块原理说明"><img class="cover" src="/img/go.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-01-11</div><div class="info-item-2">Gorm-关联关系模块原理说明</div></div><div class="info-2"><div class="info-item-1">关联关系模块原理说明  基于1.31 本文档深入解析关联关系模块的设计原理和核心实现，涵盖关系推断、预加载机制、N+1 问题解决、Association API 等核心内容。通过阅读本文档，您将能够完全理解 GORM 关联关系模块的工作原理，无需额外阅读源码。   目录 一、设计原理 1.1 模块定位 1.2 设计目的 1.3 结构安排依据 1.4 与其他模块的逻辑关系   二、核心数据结构 2.1 Relationship 结构完整解析 2.2 Relationships 结构 2.3 Reference 结构 2.4 Polymorphic 结构   三、关系推断机制 3.1 parseRelation 函数完整实现 3.2 guessRelation 函数完整实现 3.3 buildPolymorphicRelation 实现 3.4 buildMany2ManyRelation 实现 3.5 关系推断决策树   四、预加载机制 4.1 preloadEntryPoint 完整实现 4.2 preload 函数完整实现 4.3 Preload 执行流程图 4.4 嵌套预加载...</div></div></div></a><a class="pagination-related" href="/2026/01/11/web/gorm/05-callback/" title="Gorm-回调钩子模块原理说明"><img class="cover" src="/img/go.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-01-11</div><div class="info-item-2">Gorm-回调钩子模块原理说明</div></div><div class="info-2"><div class="info-item-1">回调钩子模块原理说明 基于1.31 本文档深入解析回调钩子模块的设计原理和核心原理，涵盖事件驱动机制、责任链模式、钩子注册与执行等核心内容。   一、设计原理1.1 模块定位在整体架构中的位置 回调钩子模块是 GORM 的事件驱动层，位于查询构建和 SQL 执行之间，负责在数据操作的生命周期中插入自定义逻辑。 1234567891011121314151617181920212223242526272829303132333435┌─────────────────────────────────────────────────────────────┐│                    Finisher API                              ││                      db.Find(&amp;users)                         │└────────────────────────┬────────────────────────────────────┘                      ...</div></div></div></a><a class="pagination-related" href="/2026/01/11/web/gorm/04-clause/" title="Gorm-子句系统模块原理说明"><img class="cover" src="/img/go.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-01-11</div><div class="info-item-2">Gorm-子句系统模块原理说明</div></div><div class="info-2"><div class="info-item-1">子句系统模块原理说明 基于1.31 本文档深入解析子句系统模块的设计原理和核心原理，阐述 SQL 组件化构建的理论基础。   一、设计原理1.1 模块定位在整体架构中的位置 子句系统是 GORM SQL 构建的核心组件化引擎，位于 Statement 层之下，直接负责将用户意图转换为 SQL 片段。 1234567891011121314151617181920212223242526┌─────────────────────────────────────────────────────────────┐│                   用户 API 调用                               ││  db.Where(&quot;age &gt; ?&quot;, 18).Order(&quot;name&quot;).Limit(10)           │└────────────────────────┬────────────────────────────────────┘                         │ 解析意图...</div></div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Joohwan.</div><div class="author-info-description">该知道的都知道，不知道的慢慢了解</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">259</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">76</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">60</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/piwriw"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/piwriw" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:piwriw@163.com" target="_blank" title="Email"><i class="fas fa-envelope-open-text"></i></a></div></div><div class="card-widget"><div class="item-headline"><i class="iconfont icat-visitor"></i><span>来访者</span></div><div class="item-content"><div id="welcome-info"></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%BF%81%E7%A7%BB%E5%8A%9F%E8%83%BD%E6%A8%A1%E5%9D%97%E5%8E%9F%E7%90%86%E8%AF%B4%E6%98%8E"><span class="toc-number">1.</span> <span class="toc-text">迁移功能模块原理说明</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E6%A1%A3%E7%9B%AE%E5%BD%95"><span class="toc-number">1.1.</span> <span class="toc-text">文档目录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E8%AE%BE%E8%AE%A1%E5%8E%9F%E7%90%86"><span class="toc-number">1.2.</span> <span class="toc-text">一、设计原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E6%A8%A1%E5%9D%97%E5%AE%9A%E4%BD%8D"><span class="toc-number">1.2.1.</span> <span class="toc-text">1.1 模块定位</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E8%AE%BE%E8%AE%A1%E7%9B%AE%E7%9A%84"><span class="toc-number">1.2.2.</span> <span class="toc-text">1.2 设计目的</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-%E7%BB%93%E6%9E%84%E5%AE%89%E6%8E%92%E4%BE%9D%E6%8D%AE"><span class="toc-number">1.2.3.</span> <span class="toc-text">1.3 结构安排依据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-%E4%B8%8E%E5%85%B6%E4%BB%96%E6%A8%A1%E5%9D%97%E7%9A%84%E9%80%BB%E8%BE%91%E5%85%B3%E7%B3%BB"><span class="toc-number">1.2.4.</span> <span class="toc-text">1.4 与其他模块的逻辑关系</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E6%A0%B8%E5%BF%83%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-number">1.3.</span> <span class="toc-text">二、核心数据结构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-Migrator-%E6%8E%A5%E5%8F%A3-gorm-go-67-111"><span class="toc-number">1.3.1.</span> <span class="toc-text">2.1 Migrator 接口 (gorm.go:67-111)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89"><span class="toc-number">1.3.1.1.</span> <span class="toc-text">接口定义</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E5%88%86%E7%B1%BB%E8%AF%B4%E6%98%8E"><span class="toc-number">1.3.1.2.</span> <span class="toc-text">方法分类说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1%E5%8E%9F%E7%90%86"><span class="toc-number">1.3.1.3.</span> <span class="toc-text">接口设计原理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-ColumnType-%E6%8E%A5%E5%8F%A3-gorm-go-34-48"><span class="toc-number">1.3.2.</span> <span class="toc-text">2.2 ColumnType 接口 (gorm.go:34-48)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89-1"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">接口定义</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E8%AF%B4%E6%98%8E"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">方法说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.3.2.3.</span> <span class="toc-text">使用示例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-Index-%E6%8E%A5%E5%8F%A3-gorm-go-50-57"><span class="toc-number">1.3.3.</span> <span class="toc-text">2.3 Index 接口 (gorm.go:50-57)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89-2"><span class="toc-number">1.3.3.1.</span> <span class="toc-text">接口定义</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">1.3.3.2.</span> <span class="toc-text">使用场景</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-TableType-%E6%8E%A5%E5%8F%A3-gorm-go-59-65"><span class="toc-number">1.3.4.</span> <span class="toc-text">2.4 TableType 接口 (gorm.go:59-65)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89-3"><span class="toc-number">1.3.4.1.</span> <span class="toc-text">接口定义</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF-1"><span class="toc-number">1.3.4.2.</span> <span class="toc-text">使用场景</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-ViewOption-%E7%BB%93%E6%9E%84%E4%BD%93-gorm-go-27-32"><span class="toc-number">1.3.5.</span> <span class="toc-text">2.5 ViewOption 结构体 (gorm.go:27-32)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%93%E6%9E%84%E4%BD%93%E5%AE%9A%E4%B9%89"><span class="toc-number">1.3.5.1.</span> <span class="toc-text">结构体定义</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%86%E5%9B%BE%E5%88%9B%E5%BB%BA%E9%85%8D%E7%BD%AE"><span class="toc-number">1.3.5.2.</span> <span class="toc-text">视图创建配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B-1"><span class="toc-number">1.3.5.3.</span> <span class="toc-text">使用示例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-Migrator-%E7%BB%93%E6%9E%84%E4%BD%93-migrator-migrator-go-33-43"><span class="toc-number">1.3.6.</span> <span class="toc-text">2.6 Migrator 结构体 (migrator&#x2F;migrator.go:33-43)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%93%E6%9E%84%E4%BD%93%E5%AE%9A%E4%B9%89-1"><span class="toc-number">1.3.6.1.</span> <span class="toc-text">结构体定义</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E8%AF%B4%E6%98%8E"><span class="toc-number">1.3.6.2.</span> <span class="toc-text">配置说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%8E%A5%E5%8F%A3"><span class="toc-number">1.3.6.3.</span> <span class="toc-text">实现接口</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E8%BF%81%E7%A7%BB%E6%A0%B8%E5%BF%83%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.4.</span> <span class="toc-text">三、迁移核心实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-Migrator-%E6%96%B9%E6%B3%95-gorm-go-11-20"><span class="toc-number">1.4.1.</span> <span class="toc-text">3.1 Migrator() 方法 (gorm.go:11-20)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%8C%E6%95%B4%E6%BA%90%E7%A0%81"><span class="toc-number">1.4.1.1.</span> <span class="toc-text">完整源码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.4.1.2.</span> <span class="toc-text">执行流程详解</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E9%93%BE%E8%B7%AF%E5%9B%BE"><span class="toc-number">1.4.1.3.</span> <span class="toc-text">调用链路图</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-AutoMigrate-%E6%96%B9%E6%B3%95-migrator-migrator-go-120-205"><span class="toc-number">1.4.2.</span> <span class="toc-text">3.2 AutoMigrate() 方法 (migrator&#x2F;migrator.go:120-205)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%8C%E6%95%B4%E6%BA%90%E7%A0%81-1"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">完整源码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B%E8%AF%A6%E8%A7%A3-1"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">执行流程详解</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A2%9E%E9%87%8F%E8%BF%81%E7%A7%BB%E7%AD%96%E7%95%A5"><span class="toc-number">1.4.2.3.</span> <span class="toc-text">增量迁移策略</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-CreateTable-%E6%96%B9%E6%B3%95-migrator-migrator-go-214-316"><span class="toc-number">1.4.3.</span> <span class="toc-text">3.3 CreateTable() 方法 (migrator&#x2F;migrator.go:214-316)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%8C%E6%95%B4%E6%BA%90%E7%A0%81-2"><span class="toc-number">1.4.3.1.</span> <span class="toc-text">完整源码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SQL-%E7%94%9F%E6%88%90%E9%80%BB%E8%BE%91"><span class="toc-number">1.4.3.2.</span> <span class="toc-text">SQL 生成逻辑</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-%E8%A1%A8%E6%93%8D%E4%BD%9C%E6%96%B9%E6%B3%95"><span class="toc-number">1.4.4.</span> <span class="toc-text">3.4 表操作方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#DropTable-migrator-migrator-go-318-330"><span class="toc-number">1.4.4.1.</span> <span class="toc-text">DropTable() (migrator&#x2F;migrator.go:318-330)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HasTable-migrator-migrator-go-332-342"><span class="toc-number">1.4.4.2.</span> <span class="toc-text">HasTable() (migrator&#x2F;migrator.go:332-342)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RenameTable-migrator-migrator-go-344-370"><span class="toc-number">1.4.4.3.</span> <span class="toc-text">RenameTable() (migrator&#x2F;migrator.go:344-370)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-%E5%88%97%E6%93%8D%E4%BD%9C%E6%96%B9%E6%B3%95"><span class="toc-number">1.4.5.</span> <span class="toc-text">3.5 列操作方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#AddColumn-migrator-migrator-go-372-393"><span class="toc-number">1.4.5.1.</span> <span class="toc-text">AddColumn() (migrator&#x2F;migrator.go:372-393)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DropColumn-migrator-migrator-go-395-408"><span class="toc-number">1.4.5.2.</span> <span class="toc-text">DropColumn() (migrator&#x2F;migrator.go:395-408)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AlterColumn-migrator-migrator-go-410-425"><span class="toc-number">1.4.5.3.</span> <span class="toc-text">AlterColumn() (migrator&#x2F;migrator.go:410-425)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MigrateColumn-migrator-migrator-go-468-592"><span class="toc-number">1.4.5.4.</span> <span class="toc-text">MigrateColumn() (migrator&#x2F;migrator.go:468-592)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E7%B1%BB%E5%9E%8B%E6%98%A0%E5%B0%84%E7%B3%BB%E7%BB%9F"><span class="toc-number">1.5.</span> <span class="toc-text">四、类型映射系统</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-Go-%E7%B1%BB%E5%9E%8B%E5%88%B0%E6%95%B0%E6%8D%AE%E5%BA%93%E7%B1%BB%E5%9E%8B%E6%98%A0%E5%B0%84"><span class="toc-number">1.5.1.</span> <span class="toc-text">4.1 Go 类型到数据库类型映射</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E7%B1%BB%E5%9E%8B%E6%98%A0%E5%B0%84%E8%A1%A8"><span class="toc-number">1.5.1.1.</span> <span class="toc-text">基本类型映射表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#GORM-%E6%A0%87%E7%AD%BE%E7%9A%84%E5%BD%B1%E5%93%8D"><span class="toc-number">1.5.1.2.</span> <span class="toc-text">GORM 标签的影响</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E5%AE%9E%E6%88%98%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.6.</span> <span class="toc-text">五、实战代码示例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-%E5%9F%BA%E7%A1%80%E8%BF%81%E7%A7%BB%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.6.1.</span> <span class="toc-text">5.1 基础迁移示例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%A1%A8"><span class="toc-number">1.6.1.1.</span> <span class="toc-text">创建表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E8%A1%A8%E7%BB%93%E6%9E%84"><span class="toc-number">1.6.1.2.</span> <span class="toc-text">修改表结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E8%A1%A8"><span class="toc-number">1.6.1.3.</span> <span class="toc-text">删除表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%87%8D%E5%91%BD%E5%90%8D%E6%93%8D%E4%BD%9C"><span class="toc-number">1.6.1.4.</span> <span class="toc-text">重命名操作</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-%E5%88%97%E6%93%8D%E4%BD%9C%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.6.2.</span> <span class="toc-text">5.2 列操作示例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E5%88%97"><span class="toc-number">1.6.2.1.</span> <span class="toc-text">添加列</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E5%88%97%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.6.2.2.</span> <span class="toc-text">修改列类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E5%88%97"><span class="toc-number">1.6.2.3.</span> <span class="toc-text">删除列</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E5%88%97%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8"><span class="toc-number">1.6.2.4.</span> <span class="toc-text">检查列是否存在</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-%E7%B4%A2%E5%BC%95%E6%93%8D%E4%BD%9C%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.6.3.</span> <span class="toc-text">5.3 索引操作示例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%99%AE%E9%80%9A%E7%B4%A2%E5%BC%95"><span class="toc-number">1.6.3.1.</span> <span class="toc-text">创建普通索引</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%94%AF%E4%B8%80%E7%B4%A2%E5%BC%95"><span class="toc-number">1.6.3.2.</span> <span class="toc-text">创建唯一索引</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%A4%8D%E5%90%88%E7%B4%A2%E5%BC%95"><span class="toc-number">1.6.3.3.</span> <span class="toc-text">创建复合索引</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E7%B4%A2%E5%BC%95"><span class="toc-number">1.6.3.4.</span> <span class="toc-text">删除索引</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-%E7%BA%A6%E6%9D%9F%E6%93%8D%E4%BD%9C%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.6.4.</span> <span class="toc-text">5.4 约束操作示例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%96%E9%94%AE%E7%BA%A6%E6%9D%9F"><span class="toc-number">1.6.4.1.</span> <span class="toc-text">外键约束</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%94%AF%E4%B8%80%E7%BA%A6%E6%9D%9F"><span class="toc-number">1.6.4.2.</span> <span class="toc-text">唯一约束</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E7%BA%A6%E6%9D%9F"><span class="toc-number">1.6.4.3.</span> <span class="toc-text">检查约束</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E7%BA%A6%E6%9D%9F"><span class="toc-number">1.6.4.4.</span> <span class="toc-text">删除约束</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-5-%E8%A7%86%E5%9B%BE%E6%93%8D%E4%BD%9C%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.6.5.</span> <span class="toc-text">5.5 视图操作示例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%A7%86%E5%9B%BE"><span class="toc-number">1.6.5.1.</span> <span class="toc-text">创建视图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9B%BF%E6%8D%A2%E8%A7%86%E5%9B%BE"><span class="toc-number">1.6.5.2.</span> <span class="toc-text">替换视图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E8%A7%86%E5%9B%BE"><span class="toc-number">1.6.5.3.</span> <span class="toc-text">删除视图</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-6-%E5%AE%8C%E6%95%B4%E8%BF%81%E7%A7%BB%E6%B5%81%E7%A8%8B%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.6.6.</span> <span class="toc-text">5.6 完整迁移流程示例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%89%88%E6%9C%AC%E5%8C%96%E8%BF%81%E7%A7%BB%E7%B3%BB%E7%BB%9F"><span class="toc-number">1.6.6.1.</span> <span class="toc-text">版本化迁移系统</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E3%80%81%E5%8F%AF%E8%A7%86%E5%8C%96%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="toc-number">1.7.</span> <span class="toc-text">六、可视化流程图</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-AutoMigrate-%E5%AE%8C%E6%95%B4%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="toc-number">1.7.1.</span> <span class="toc-text">6.1 AutoMigrate 完整执行流程图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-CreateTable-SQL-%E7%94%9F%E6%88%90%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="toc-number">1.7.2.</span> <span class="toc-text">6.2 CreateTable SQL 生成流程图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-MigrateColumn-%E5%86%B3%E7%AD%96%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="toc-number">1.7.3.</span> <span class="toc-text">6.3 MigrateColumn 决策流程图</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83%E3%80%81%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E4%B8%8E%E6%95%85%E9%9A%9C%E6%8E%92%E6%9F%A5"><span class="toc-number">1.8.</span> <span class="toc-text">七、最佳实践与故障排查</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-%E9%85%8D%E7%BD%AE%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">1.8.1.</span> <span class="toc-text">7.1 配置最佳实践</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="toc-number">1.8.1.1.</span> <span class="toc-text">开发环境配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="toc-number">1.8.1.2.</span> <span class="toc-text">生产环境配置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E4%B8%8E%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">1.8.2.</span> <span class="toc-text">7.2 常见问题与解决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%81%E7%A7%BB%E5%A4%B1%E8%B4%A5%E9%97%AE%E9%A2%98"><span class="toc-number">1.8.2.1.</span> <span class="toc-text">迁移失败问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B1%BB%E5%9E%8B%E4%B8%8D%E5%8C%B9%E9%85%8D%E9%97%AE%E9%A2%98"><span class="toc-number">1.8.2.2.</span> <span class="toc-text">类型不匹配问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BA%A6%E6%9D%9F%E5%86%B2%E7%AA%81%E9%97%AE%E9%A2%98"><span class="toc-number">1.8.2.3.</span> <span class="toc-text">约束冲突问题</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AB%E3%80%81%E5%AD%A6%E4%B9%A0%E9%AA%8C%E8%AF%81"><span class="toc-number">1.9.</span> <span class="toc-text">八、学习验证</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-%E7%9F%A5%E8%AF%86%E8%87%AA%E6%B5%8B"><span class="toc-number">1.9.1.</span> <span class="toc-text">8.1 知识自测</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E9%A2%98"><span class="toc-number">1.9.1.1.</span> <span class="toc-text">基础题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9B%E9%98%B6%E9%A2%98"><span class="toc-number">1.9.1.2.</span> <span class="toc-text">进阶题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E9%A2%98"><span class="toc-number">1.9.1.3.</span> <span class="toc-text">实战题</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-%E5%AE%9E%E8%B7%B5%E7%BB%83%E4%B9%A0"><span class="toc-number">1.9.2.</span> <span class="toc-text">8.2 实践练习</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%83%E4%B9%A0-1-%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%AE%9A%E4%B9%89%E8%BF%81%E7%A7%BB%E5%B7%A5%E5%85%B7"><span class="toc-number">1.9.2.1.</span> <span class="toc-text">练习 1: 实现自定义迁移工具</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86"><span class="toc-number">1.10.</span> <span class="toc-text">二、核心原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E5%85%B3%E9%94%AE%E6%A6%82%E5%BF%B5"><span class="toc-number">1.10.1.</span> <span class="toc-text">2.1 关键概念</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5-2-AutoMigrate-%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.10.1.1.</span> <span class="toc-text">概念 2: AutoMigrate 实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5-3-%E7%B1%BB%E5%9E%8B%E6%98%A0%E5%B0%84%E7%B3%BB%E7%BB%9F"><span class="toc-number">1.10.1.2.</span> <span class="toc-text">概念 3: 类型映射系统</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5-4-%E7%BA%A6%E6%9D%9F%E7%AE%A1%E7%90%86"><span class="toc-number">1.10.1.3.</span> <span class="toc-text">概念 4: 约束管理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5-5-%E7%B4%A2%E5%BC%95%E7%AE%A1%E7%90%86"><span class="toc-number">1.10.1.4.</span> <span class="toc-text">概念 5: 索引管理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E7%90%86%E8%AE%BA%E5%9F%BA%E7%A1%80"><span class="toc-number">1.10.2.</span> <span class="toc-text">2.2 理论基础</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%90%86%E8%AE%BA-1-%E5%A2%9E%E9%87%8F%E8%BF%81%E7%A7%BB%E7%AD%96%E7%95%A5"><span class="toc-number">1.10.2.1.</span> <span class="toc-text">理论 1: 增量迁移策略</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%90%86%E8%AE%BA-2-%E7%89%88%E6%9C%AC%E5%8C%96%E8%BF%81%E7%A7%BB"><span class="toc-number">1.10.2.2.</span> <span class="toc-text">理论 2: 版本化迁移</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%90%86%E8%AE%BA-3-%E6%95%B0%E6%8D%AE%E5%BA%93%E5%85%BC%E5%AE%B9%E6%80%A7"><span class="toc-number">1.10.2.3.</span> <span class="toc-text">理论 3: 数据库兼容性</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E5%AD%A6%E4%B9%A0%E6%96%B9%E6%B3%95"><span class="toc-number">1.10.3.</span> <span class="toc-text">2.3 学习方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%B3%95-1-%E5%AF%B9%E6%AF%94%E6%B3%95"><span class="toc-number">1.10.3.1.</span> <span class="toc-text">方法 1: 对比法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%B3%95-2-%E5%AE%9E%E9%AA%8C%E6%B3%95"><span class="toc-number">1.10.3.2.</span> <span class="toc-text">方法 2: 实验法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-%E5%AE%9E%E6%96%BD%E7%AD%96%E7%95%A5"><span class="toc-number">1.10.4.</span> <span class="toc-text">2.4 实施策略</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AD%96%E7%95%A5-1-%E5%88%86%E5%B1%82%E5%AD%A6%E4%B9%A0"><span class="toc-number">1.10.4.1.</span> <span class="toc-text">策略 1: 分层学习</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AD%96%E7%95%A5-2-%E5%9C%BA%E6%99%AF%E9%A9%B1%E5%8A%A8"><span class="toc-number">1.10.4.2.</span> <span class="toc-text">策略 2: 场景驱动</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E5%AD%A6%E4%B9%A0%E8%B7%AF%E5%BE%84%E5%BB%BA%E8%AE%AE"><span class="toc-number">1.11.</span> <span class="toc-text">三、学习路径建议</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86%E6%A3%80%E6%9F%A5"><span class="toc-number">1.11.1.</span> <span class="toc-text">3.1 前置知识检查</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E5%AD%A6%E4%B9%A0%E6%97%B6%E9%97%B4%E5%88%86%E9%85%8D"><span class="toc-number">1.11.2.</span> <span class="toc-text">3.2 学习时间分配</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E5%AD%A6%E4%B9%A0%E6%88%90%E6%9E%9C%E9%AA%8C%E6%94%B6"><span class="toc-number">1.11.3.</span> <span class="toc-text">3.3 学习成果验收</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2026/01/11/web/gorm/09-logger/" title="Gorm-日志系统模块原理说明"><img src="/img/go.png" onerror="this.onerror=null;this.src='/img/404.png'" alt="Gorm-日志系统模块原理说明"/></a><div class="content"><a class="title" href="/2026/01/11/web/gorm/09-logger/" title="Gorm-日志系统模块原理说明">Gorm-日志系统模块原理说明</a><time datetime="2026-01-11T11:56:27.000Z" title="发表于 2026-01-11 19:56:27">2026-01-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2026/01/11/web/gorm/08-migration/" title="Gorm-迁移功能模块原理说明"><img src="/img/go.png" onerror="this.onerror=null;this.src='/img/404.png'" alt="Gorm-迁移功能模块原理说明"/></a><div class="content"><a class="title" href="/2026/01/11/web/gorm/08-migration/" title="Gorm-迁移功能模块原理说明">Gorm-迁移功能模块原理说明</a><time datetime="2026-01-11T10:56:27.000Z" title="发表于 2026-01-11 18:56:27">2026-01-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2026/01/11/web/gorm/10-plugin/" title="Gorm-插件系统模块原理说明"><img src="/img/go.png" onerror="this.onerror=null;this.src='/img/404.png'" alt="Gorm-插件系统模块原理说明"/></a><div class="content"><a class="title" href="/2026/01/11/web/gorm/10-plugin/" title="Gorm-插件系统模块原理说明">Gorm-插件系统模块原理说明</a><time datetime="2026-01-11T10:56:27.000Z" title="发表于 2026-01-11 18:56:27">2026-01-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2026/01/11/web/gorm/07-transaction/" title="Gorm-事务处理模块原理说明"><img src="/img/go.png" onerror="this.onerror=null;this.src='/img/404.png'" alt="Gorm-事务处理模块原理说明"/></a><div class="content"><a class="title" href="/2026/01/11/web/gorm/07-transaction/" title="Gorm-事务处理模块原理说明">Gorm-事务处理模块原理说明</a><time datetime="2026-01-11T09:56:27.000Z" title="发表于 2026-01-11 17:56:27">2026-01-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2026/01/11/web/gorm/06-associations/" title="Gorm-关联关系模块原理说明"><img src="/img/go.png" onerror="this.onerror=null;this.src='/img/404.png'" alt="Gorm-关联关系模块原理说明"/></a><div class="content"><a class="title" href="/2026/01/11/web/gorm/06-associations/" title="Gorm-关联关系模块原理说明">Gorm-关联关系模块原理说明</a><time datetime="2026-01-11T08:56:27.000Z" title="发表于 2026-01-11 16:56:27">2026-01-11</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2023 - 2026 By Joohwan.</span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
  const option = null

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://piwriw-twikoo-git-main-piwriw.vercel.app/',
      region: 'ap-shanghai',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const init = (el = document, path = location.pathname) => {
    twikoo.init({
      el: el.querySelector('#twikoo-wrap'),
      envId: 'https://piwriw-twikoo-git-main-piwriw.vercel.app/',
      region: 'ap-shanghai',
      onCommentLoaded: () => {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      },
      ...option,
      path: isShuoshuo ? path : (option && option.path) || path
    })

    

    isShuoshuo && (window.shuoshuoComment.destroyTwikoo = () => {
      if (el.children.length) {
        el.innerHTML = ''
        el.classList.add('no-comment')
      }
    })
  }

  const loadTwikoo = (el, path) => {
    if (typeof twikoo === 'object') setTimeout(() => init(el, path), 0)
    else btf.getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(() => init(el, path))
  }

  if (isShuoshuo) {
    'Twikoo' === 'Twikoo'
      ? window.shuoshuoComment = { loadComment: loadTwikoo }
      : window.loadOtherComment = loadTwikoo
    return
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script></div><script src="/js/categories.js" defer></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>