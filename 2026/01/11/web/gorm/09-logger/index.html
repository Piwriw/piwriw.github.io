<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Gorm-日志系统模块原理说明 | Joohwan</title><meta name="author" content="Joohwan."><meta name="copyright" content="Joohwan."><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="日志系统模块原理说明 基于1.31 本文档深入解析日志系统模块的设计原理和核心实现，涵盖 SQL 日志记录、性能分析、调用栈追踪等核心内容。学习完本文档后，您将能够彻底理解 GORM 日志系统的工作机制，并能够实现自定义 Logger 来满足各种日志需求。  文档目录123456789101112131415161718192021222324252627282930313233343536373">
<meta property="og:type" content="article">
<meta property="og:title" content="Gorm-日志系统模块原理说明">
<meta property="og:url" content="https://piwriw.github.io/2026/01/11/web/gorm/09-logger/index.html">
<meta property="og:site_name" content="Joohwan">
<meta property="og:description" content="日志系统模块原理说明 基于1.31 本文档深入解析日志系统模块的设计原理和核心实现，涵盖 SQL 日志记录、性能分析、调用栈追踪等核心内容。学习完本文档后，您将能够彻底理解 GORM 日志系统的工作机制，并能够实现自定义 Logger 来满足各种日志需求。  文档目录123456789101112131415161718192021222324252627282930313233343536373">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://piwriw.github.io/img/go.png">
<meta property="article:published_time" content="2026-01-11T11:56:27.000Z">
<meta property="article:modified_time" content="2026-02-28T13:29:12.679Z">
<meta property="article:author" content="Joohwan.">
<meta property="article:tag" content="web">
<meta property="article:tag" content="Gorm">
<meta property="article:tag" content="源码">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://piwriw.github.io/img/go.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Gorm-日志系统模块原理说明",
  "url": "https://piwriw.github.io/2026/01/11/web/gorm/09-logger/",
  "image": "https://piwriw.github.io/img/go.png",
  "datePublished": "2026-01-11T11:56:27.000Z",
  "dateModified": "2026-02-28T13:29:12.679Z",
  "author": [
    {
      "@type": "Person",
      "name": "Joohwan.",
      "url": "https://github.com/Piwriw"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://piwriw.github.io/2026/01/11/web/gorm/09-logger/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Gorm-日志系统模块原理说明',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><script src="/js/welcome.js"></script><script src="https://npm.elemecdn.com/echarts@4.9.0/dist/echarts.min.js"></script><link rel="stylesheet" href="/css/categories.css"><link rel="stylesheet" href="/css/tabs.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">259</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">76</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">60</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/charts/"><i class="fa-fw fas fa-folder-open"></i><span> 文章统计</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div><div class="menus_item"><a class="site-page" href="/wish/"><i class="fa-fw fas fa-tags"></i><span> 许愿墙</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/go.png);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Joohwan</span></a><a class="nav-page-title" href="/"><span class="site-name">Gorm-日志系统模块原理说明</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/charts/"><i class="fa-fw fas fa-folder-open"></i><span> 文章统计</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div><div class="menus_item"><a class="site-page" href="/wish/"><i class="fa-fw fas fa-tags"></i><span> 许愿墙</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Gorm-日志系统模块原理说明</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2026-01-11T11:56:27.000Z" title="发表于 2026-01-11 19:56:27">2026-01-11</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2026-02-28T13:29:12.679Z" title="更新于 2026-02-28 21:29:12">2026-02-28</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/web/">web</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/web/gorm/">gorm</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">12.9k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>59分钟</span></span><span class="post-meta-separator">|</span><span id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="twikoo_visitors"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><div id="post-outdate-notice" data="{&quot;limitDay&quot;:365,&quot;messagePrev&quot;:&quot;It has been&quot;,&quot;messageNext&quot;:&quot;days since the last update, the content of the article may be outdated.&quot;,&quot;postUpdate&quot;:&quot;2026-02-28 21:29:12&quot;}" hidden></div><h1 id="日志系统模块原理说明"><a href="#日志系统模块原理说明" class="headerlink" title="日志系统模块原理说明"></a>日志系统模块原理说明</h1><blockquote>
<p>基于1.31 本文档深入解析日志系统模块的设计原理和核心实现，涵盖 SQL 日志记录、性能分析、调用栈追踪等核心内容。学习完本文档后，您将能够彻底理解 GORM 日志系统的工作机制，并能够实现自定义 Logger 来满足各种日志需求。</p>
</blockquote>
<h2 id="文档目录"><a href="#文档目录" class="headerlink" title="文档目录"></a>文档目录</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line">09-logger.md</span><br><span class="line">├── 一、设计原理</span><br><span class="line">│   ├── 1.1 模块定位</span><br><span class="line">│   ├── 1.2 设计目的</span><br><span class="line">│   ├── 1.3 结构安排依据</span><br><span class="line">│   └── 1.4 与其他模块的逻辑关系</span><br><span class="line">│</span><br><span class="line">├── 二、核心数据结构</span><br><span class="line">│   ├── 2.1 LogLevel 枚举 (logger.go:34-46)</span><br><span class="line">│   │   ├── 枚举定义</span><br><span class="line">│   │   ├── 级别说明</span><br><span class="line">│   │   └── 使用示例</span><br><span class="line">│   ├── 2.2 Interface 接口 (logger.go:62-69)</span><br><span class="line">│   │   ├── 接口定义</span><br><span class="line">│   │   ├── 方法说明</span><br><span class="line">│   │   └── 接口设计原理</span><br><span class="line">│   ├── 2.3 Config 结构体 (logger.go:53-60)</span><br><span class="line">│   │   ├── 结构体定义</span><br><span class="line">│   │   ├── 字段说明</span><br><span class="line">│   │   └── 配置示例</span><br><span class="line">│   ├── 2.4 logger 结构体 (logger.go:122-127)</span><br><span class="line">│   │   ├── 结构体定义</span><br><span class="line">│   │   └── 字段说明</span><br><span class="line">│   ├── 2.5 Writer 接口 (logger.go:48-51)</span><br><span class="line">│   │   ├── 接口定义</span><br><span class="line">│   │   └── 实现示例</span><br><span class="line">│   └── 2.6 traceRecorder 结构体 (logger.go:200-206)</span><br><span class="line">│       │   ├── 结构体定义</span><br><span class="line">│       │   └── 用途说明</span><br><span class="line">│</span><br><span class="line">├── 三、日志核心实现</span><br><span class="line">│   ├── 3.1 New() 函数 (logger.go:90-120)</span><br><span class="line">│   │   ├── 完整源码</span><br><span class="line">│   │   ├── 格式化字符串构建</span><br><span class="line">│   │   └── 颜色配置</span><br><span class="line">│   ├── 3.2 LogMode() 方法 (logger.go:129-134)</span><br><span class="line">│   │   ├── 完整源码</span><br><span class="line">│   │   └── 级别切换机制</span><br><span class="line">│   ├── 3.3 Trace() 方法 (logger.go:157-190)</span><br><span class="line">│   │   ├── 完整源码</span><br><span class="line">│   │   ├── 执行流程详解</span><br><span class="line">│   │   └── 决策逻辑</span><br><span class="line">│   ├── 3.4 Info/Warn/Error() 方法</span><br><span class="line">│   │   ├── Info() (logger.go:136-141)</span><br><span class="line">│   │   ├── Warn() (logger.go:143-148)</span><br><span class="line">│   │   └── Error() (logger.go:150-155)</span><br><span class="line">│   └── 3.5 ParamsFilter() 方法 (logger.go:192-198)</span><br><span class="line">│       ├── 完整源码</span><br><span class="line">│       └── 参数过滤机制</span><br><span class="line">│</span><br><span class="line">├── 四、SQL 解释机制</span><br><span class="line">│   ├── 4.1 Dialector.Explain() 方法</span><br><span class="line">│   │   ├── 方法签名</span><br><span class="line">│   │   ├── 参数占位符</span><br><span class="line">│   │   └── 数据库差异</span><br><span class="line">│   ├── 4.2 参数值格式化</span><br><span class="line">│   │   ├── 字符串格式化</span><br><span class="line">│   │   ├── 时间格式化</span><br><span class="line">│   │   └── NULL 值处理</span><br><span class="line">│   └── 4.3 敏感参数过滤</span><br><span class="line">│       ├── ParamsFilter 接口</span><br><span class="line">│       └── 实现示例</span><br><span class="line">│</span><br><span class="line">├── 五、调用栈追踪</span><br><span class="line">│   ├── 5.1 FileWithLineNum() 实现</span><br><span class="line">│   │   ├── runtime.Caller 原理</span><br><span class="line">│   │   ├── 过滤逻辑</span><br><span class="line">│   │   └── 完整源码</span><br><span class="line">│   ├── 5.2 调用栈追踪配置</span><br><span class="line">│   │   ├── 启用追踪</span><br><span class="line">│   │   └── 禁用追踪</span><br><span class="line">│   └── 5.3 性能考虑</span><br><span class="line">│       ├── 追踪开销</span><br><span class="line">│       └── 优化建议</span><br><span class="line">│</span><br><span class="line">├── 六、实战代码示例</span><br><span class="line">│   ├── 6.1 基础配置示例</span><br><span class="line">│   │   ├── 开发环境配置</span><br><span class="line">│   │   ├── 生产环境配置</span><br><span class="line">│   │   └── 测试环境配置</span><br><span class="line">│   ├── 6.2 自定义 Logger 示例</span><br><span class="line">│   │   ├── 文件 Logger</span><br><span class="line">│   │   ├── JSON Logger</span><br><span class="line">│   │   └── 结构化 Logger</span><br><span class="line">│   ├── 6.3 慢查询检测示例</span><br><span class="line">│   │   ├── 基础配置</span><br><span class="line">│   │   ├── 动态配置</span><br><span class="line">│   │   └── 告警集成</span><br><span class="line">│   ├── 6.4 日志集成示例</span><br><span class="line">│   │   ├── 集成 logrus</span><br><span class="line">│   │   ├── 集成 zap</span><br><span class="line">│   │   └── 集成 fluentd</span><br><span class="line">│   ├── 6.5 Recorder 使用示例</span><br><span class="line">│   │   ├── SQL 记录</span><br><span class="line">│   │   ├── 单元测试</span><br><span class="line">│   │   └── SQL 审计</span><br><span class="line">│   └── 6.6 完整日志系统示例</span><br><span class="line">│       ├── 分环境配置</span><br><span class="line">│       ├── 日志轮转</span><br><span class="line">│       └── 日志聚合</span><br><span class="line">│</span><br><span class="line">├── 七、可视化流程图</span><br><span class="line">│   ├── 7.1 Trace() 完整执行流程图</span><br><span class="line">│   ├── 7.2 日志级别决策树</span><br><span class="line">│   ├── 7.3 SQL 解释流程图</span><br><span class="line">│   ├── 7.4 调用栈追踪流程图</span><br><span class="line">│   └── 7.5 日志系统架构图</span><br><span class="line">│</span><br><span class="line">├── 八、最佳实践与故障排查</span><br><span class="line">│   ├── 8.1 配置最佳实践</span><br><span class="line">│   │   ├── 开发环境最佳实践</span><br><span class="line">│   │   ├── 生产环境最佳实践</span><br><span class="line">│   │   └── 测试环境最佳实践</span><br><span class="line">│   ├── 8.2 性能优化</span><br><span class="line">│   │   ├── 减少日志开销</span><br><span class="line">│   │   ├── 异步日志</span><br><span class="line">│   │   └── 日志采样</span><br><span class="line">│   ├── 8.3 安全建议</span><br><span class="line">│   │   ├── 敏感数据过滤</span><br><span class="line">│   │   ├── SQL 注入防护</span><br><span class="line">│   │   └── 日志脱敏</span><br><span class="line">│   ├── 8.4 常见问题与解决方案</span><br><span class="line">│   │   ├── 日志不输出问题</span><br><span class="line">│   │   ├── 性能问题</span><br><span class="line">│   │   ├── 调用栈不准确问题</span><br><span class="line">│   │   └── 颜色显示问题</span><br><span class="line">│   └── 8.5 日志分析策略</span><br><span class="line">│       ├── 慢查询分析</span><br><span class="line">│       ├── 错误日志分析</span><br><span class="line">│       └── 行为模式分析</span><br><span class="line">│</span><br><span class="line">└── 九、学习验证</span><br><span class="line">    ├── 9.1 知识自测</span><br><span class="line">    │   ├── 基础题 (10 道)</span><br><span class="line">    │   ├── 进阶题 (8 道)</span><br><span class="line">    │   └── 实战题 (5 道)</span><br><span class="line">    └── 9.2 实践练习</span><br><span class="line">        ├── 练习 1: 实现自定义 JSON Logger</span><br><span class="line">        ├── 练习 2: 实现日志聚合系统</span><br><span class="line">        └── 练习 3: 实现 SQL 审计系统</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="一、设计原理"><a href="#一、设计原理" class="headerlink" title="一、设计原理"></a>一、设计原理</h2><h3 id="1-1-模块定位"><a href="#1-1-模块定位" class="headerlink" title="1.1 模块定位"></a>1.1 模块定位</h3><p><strong>在整体架构中的位置</strong></p>
<p>日志系统模块是 GORM 的可观测性层，负责记录 SQL 执行信息、性能指标和调用上下文。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│                   SQL 执行                                   │</span><br><span class="line">│  db.Find(&amp;users).Where(&quot;age &gt; ?&quot;, 18)                       │</span><br><span class="line">└────────────────────────┬────────────────────────────────────┘</span><br><span class="line">                         │</span><br><span class="line">                         ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│              日志记录 (本模块) ★                              │</span><br><span class="line">│  ┌────────────────────────────────────────────────────┐     │</span><br><span class="line">│  │  Trace(ctx, begin, fc, error)                       │     │</span><br><span class="line">│  │  ├─ 计算耗时 elapsed = time.Since(begin)            │     │</span><br><span class="line">│  │  ├─ 获取 SQL 和行数 sql, rows = fc()                │     │</span><br><span class="line">│  │  ├─ 判断日志级别                                    │     │</span><br><span class="line">│  │  ├─ 慢查询检测 elapsed &gt; SlowThreshold               │     │</span><br><span class="line">│  │  └─ 格式化输出                                      │     │</span><br><span class="line">│  └────────────────────────────────────────────────────┘     │</span><br><span class="line">│                                                             │</span><br><span class="line">│  日志组件:                                                   │</span><br><span class="line">│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │</span><br><span class="line">│  │ SQL 记录 │  │参数记录  │  │耗时记录  │  │调用栈记录│   │</span><br><span class="line">│  │          │  │          │  │          │  │          │   │</span><br><span class="line">│  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │</span><br><span class="line">└────────────────────────┬────────────────────────────────────┘</span><br><span class="line">                         │</span><br><span class="line">                         ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│                   日志输出                                    │</span><br><span class="line">│  ┌────────────────────────────────────────────────────┐     │</span><br><span class="line">│  │ [2024-01-01 10:00:00]                                 │     │</span><br><span class="line">│  │ [3.45ms] SELECT * FROM users WHERE age &gt; 18           │     │</span><br><span class="line">│  │ [10 rows affected or returned]                        │     │</span><br><span class="line">│  │ [main.go:45] main.main()                             │     │</span><br><span class="line">│  └────────────────────────────────────────────────────┘     │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<p><strong>核心价值</strong></p>
<p>日志系统模块的核心价值在于：</p>
<ol>
<li><strong>调试支持</strong>: 记录 SQL 语句和参数，便于调试</li>
<li><strong>性能分析</strong>: 记录执行时间，检测慢查询</li>
<li><strong>问题诊断</strong>: 记录错误和调用栈，快速定位问题</li>
<li><strong>可观测性</strong>: 提供运行时行为的完整视图</li>
</ol>
<h3 id="1-2-设计目的"><a href="#1-2-设计目的" class="headerlink" title="1.2 设计目的"></a>1.2 设计目的</h3><p><strong>问题 1: 如何记录 SQL 执行的完整上下文？</strong></p>
<ul>
<li><strong>挑战</strong>: 需要记录 SQL 语句、参数、执行时间、行数等</li>
<li><strong>挑战</strong>: 需要在不显著影响性能的前提下记录</li>
<li><strong>挑战</strong>: 需要支持不同级别的日志详细度</li>
</ul>
<p><strong>解决方案</strong>: Trace 方法 + 延迟计算</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 问题场景: 记录 SQL 执行</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 方案 1: 立即记录 (问题: 性能影响大)</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Execute</span><span class="params">(sql <span class="type">string</span>, params ...<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">    startTime := time.Now()</span><br><span class="line">    <span class="comment">// 执行 SQL</span></span><br><span class="line">    result := db.Exec(sql, params...)</span><br><span class="line">    <span class="comment">// 记录日志</span></span><br><span class="line">    log.Printf(<span class="string">&quot;SQL: %s, Params: %v, Time: %v&quot;</span>, sql, params, time.Since(startTime))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方案 2: 延迟计算 (GORM 方案)</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Execute</span><span class="params">(fc <span class="keyword">func</span>()</span></span> (<span class="type">string</span>, <span class="type">int64</span>)) &#123;</span><br><span class="line">    startTime := time.Now()</span><br><span class="line">    <span class="comment">// 执行 SQL</span></span><br><span class="line">    result := db.Exec(...)</span><br><span class="line">    <span class="comment">// 延迟计算 SQL 和行数</span></span><br><span class="line">    db.Logger.Trace(ctx, startTime, fc, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Trace 方法实现</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *logger)</span></span> Trace(ctx context.Context, begin time.Time, fc <span class="function"><span class="keyword">func</span><span class="params">()</span></span> (<span class="type">string</span>, <span class="type">int64</span>), err <span class="type">error</span>) &#123;</span><br><span class="line">    elapsed := time.Since(begin)  <span class="comment">// 计算耗时</span></span><br><span class="line">    sql, rows := fc()             <span class="comment">// 延迟获取 SQL 和行数</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据日志级别决定输出</span></span><br><span class="line">    <span class="keyword">if</span> l.LogLevel == Silent &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &amp;&amp; l.LogLevel &gt;= Error &#123;</span><br><span class="line">        l.Error(ctx, err, elapsed, sql, rows...)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> elapsed &gt; l.SlowThreshold &amp;&amp; l.SlowThreshold != <span class="number">0</span> &#123;</span><br><span class="line">        l.Slow(ctx, elapsed, sql, rows...)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> l.LogLevel &gt;= Info &#123;</span><br><span class="line">        l.Info(ctx, elapsed, sql, rows...)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>问题 2: 如何实现可配置的日志详细度？</strong></p>
<ul>
<li><strong>挑战</strong>: 不同环境需要不同的日志级别</li>
<li><strong>挑战</strong>: 需要支持动态切换日志级别</li>
<li><strong>挑战</strong>: 需要支持自定义日志格式</li>
</ul>
<p><strong>解决方案</strong>: LogLevel 枚举 + 接口抽象</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 日志级别定义</span></span><br><span class="line"><span class="keyword">type</span> LogLevel <span class="type">int</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    Silent LogLevel = <span class="literal">iota</span> + <span class="number">1</span>  <span class="comment">// 静默，不记录任何日志</span></span><br><span class="line">    Error                        <span class="comment">// 只记录错误</span></span><br><span class="line">    Warn                         <span class="comment">// 记录错误和警告</span></span><br><span class="line">    Info                         <span class="comment">// 记录所有信息</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 日志接口</span></span><br><span class="line"><span class="keyword">type</span> Interface <span class="keyword">interface</span> &#123;</span><br><span class="line">    LogMode(LogLevel) Interface  <span class="comment">// 设置日志级别</span></span><br><span class="line">    Info(context.Context, <span class="type">string</span>, ...<span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line">    Warn(context.Context, <span class="type">string</span>, ...<span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line">    Error(context.Context, <span class="type">string</span>, ...<span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line">    Trace(ctx context.Context, begin time.Time, fc <span class="function"><span class="keyword">func</span><span class="params">()</span></span> (<span class="type">string</span>, <span class="type">int64</span>), err <span class="type">error</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="comment">// 开发环境: 详细日志</span></span><br><span class="line">db, _ := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;</span><br><span class="line">    Logger: logger.Default.LogMode(logger.Info),</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生产环境: 只记录错误和慢查询</span></span><br><span class="line">db, _ := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;</span><br><span class="line">    Logger: logger.Default.LogMode(logger.Error),</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><strong>问题 3: 如何追踪 SQL 的调用来源？</strong></p>
<ul>
<li><strong>挑战</strong>: 需要记录是哪段代码触发了 SQL</li>
<li><strong>挑战</strong>: 需要过滤 GORM 内部调用</li>
<li><strong>挑战</strong>: 需要在不显著影响性能的前提下获取调用栈</li>
</ul>
<p><strong>解决方案</strong>: runtime.Caller + 过滤逻辑</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 调用栈追踪</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *logger)</span></span> Trace(ctx context.Context, begin time.Time, fc <span class="function"><span class="keyword">func</span><span class="params">()</span></span> (<span class="type">string</span>, <span class="type">int64</span>), err <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取调用文件和行号</span></span><br><span class="line">    <span class="keyword">if</span> l.IgnoreRecordNotFoundError &#123;</span><br><span class="line">        <span class="comment">// 使用 FileWithLineNum 获取调用位置</span></span><br><span class="line">        sql += fmt.Sprintf(<span class="string">&quot; [%s]&quot;</span>, utils.FileWithLineNum())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// FileWithLineNum 实现</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">FileWithLineNum</span><span class="params">()</span></span> <span class="type">string</span> &#123;</span><br><span class="line">    <span class="comment">// 跳过 GORM 内部调用</span></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">2</span>; i &lt; <span class="number">15</span>; i++ &#123;</span><br><span class="line">        _, file, line, ok := runtime.Caller(i)</span><br><span class="line">        <span class="keyword">if</span> !ok &#123;</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 过滤 GORM 内部文件</span></span><br><span class="line">        <span class="keyword">if</span> !strings.Contains(file, <span class="string">&quot;/gorm/&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> fmt.Sprintf(<span class="string">&quot;%v:%v&quot;</span>, file, line)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-3-结构安排依据"><a href="#1-3-结构安排依据" class="headerlink" title="1.3 结构安排依据"></a>1.3 结构安排依据</h3><p><strong>3 天学习时间的科学分配</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Day 1: 日志基础 (核心概念)</span><br><span class="line">  目标: 理解日志的基本概念和使用</span><br><span class="line">  重点:</span><br><span class="line">    - Logger 接口</span><br><span class="line">    - 日志级别</span><br><span class="line">    - Trace 方法</span><br><span class="line"></span><br><span class="line">Day 2: 高级日志 (核心机制)</span><br><span class="line">  目标: 理解日志的内部实现</span><br><span class="line">  重点:</span><br><span class="line">    - SQL 解释机制</span><br><span class="line">    - 慢查询检测</span><br><span class="line">    - 调用栈追踪</span><br><span class="line"></span><br><span class="line">Day 3: 扩展应用 (最佳实践)</span><br><span class="line">  目标: 掌握自定义 Logger 实现</span><br><span class="line">  重点:</span><br><span class="line">    - 自定义 Logger</span><br><span class="line">    - 集成日志库</span><br><span class="line">    - 日志聚合分析</span><br></pre></td></tr></table></figure>

<p><strong>由浅入深的学习路径</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">第 1 层: 使用层 (如何使用)</span><br><span class="line">  ├─ 配置日志级别</span><br><span class="line">  ├─ 使用默认 Logger</span><br><span class="line">  └─ 查看日志输出</span><br><span class="line"></span><br><span class="line">第 2 层: 机制层 (如何工作)</span><br><span class="line">  ├─ Trace 方法实现</span><br><span class="line">  ├─ SQL 解释原理</span><br><span class="line">  └─ 调用栈追踪</span><br><span class="line"></span><br><span class="line">第 3 层: 原理层 (为什么这样设计)</span><br><span class="line">  ├─ 日志级别设计</span><br><span class="line">  ├─ 性能考虑</span><br><span class="line">  └─ 可扩展性设计</span><br></pre></td></tr></table></figure>

<h3 id="1-4-与其他模块的逻辑关系"><a href="#1-4-与其他模块的逻辑关系" class="headerlink" title="1.4 与其他模块的逻辑关系"></a>1.4 与其他模块的逻辑关系</h3><p><strong>依赖关系</strong></p>
<ul>
<li><strong>依赖所有模块</strong>: 需要记录所有模块的操作</li>
<li><strong>依赖 Context</strong>: 使用 context 传递日志上下文</li>
</ul>
<p><strong>支撑关系</strong></p>
<ul>
<li><strong>支撑调试</strong>: 提供 SQL 执行的可视化</li>
<li><strong>支撑性能分析</strong>: 记录执行时间</li>
<li><strong>支撑问题诊断</strong>: 记录错误和调用栈</li>
</ul>
<p><strong>模块交互图</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">日志模块 ↔ 其他模块:</span><br><span class="line"></span><br><span class="line">┌─────────────────────────┐</span><br><span class="line">│  所有其他模块            │</span><br><span class="line">│  - 查询构建              │</span><br><span class="line">│  - 回调系统              │</span><br><span class="line">│  - 关联查询              │</span><br><span class="line">└──────────┬──────────────┘</span><br><span class="line">           │</span><br><span class="line">           ▼</span><br><span class="line">┌─────────────────────────────┐</span><br><span class="line">│      日志模块                │</span><br><span class="line">│  ┌───────────────────────┐  │</span><br><span class="line">│  │ Trace()               │  │</span><br><span class="line">│  │ ├─ 记录 SQL            │  │</span><br><span class="line">│  │ ├─ 记录参数            │  │</span><br><span class="line">│  │ ├─ 记录耗时            │  │</span><br><span class="line">│  │ ├─ 记录行数            │  │</span><br><span class="line">│  │ └─ 记录调用栈          │  │</span><br><span class="line">│  └───────────────────────┘  │</span><br><span class="line">└──────────┬──────────────────┘</span><br><span class="line">           │</span><br><span class="line">           ├─→ 标准输出</span><br><span class="line">           ├─→ 文件</span><br><span class="line">           └─→ 日志系统</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="二、核心数据结构"><a href="#二、核心数据结构" class="headerlink" title="二、核心数据结构"></a>二、核心数据结构</h2><h3 id="2-1-LogLevel-枚举-logger-go-34-46"><a href="#2-1-LogLevel-枚举-logger-go-34-46" class="headerlink" title="2.1 LogLevel 枚举 (logger.go:34-46)"></a>2.1 LogLevel 枚举 (logger.go:34-46)</h3><h4 id="枚举定义"><a href="#枚举定义" class="headerlink" title="枚举定义"></a>枚举定义</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LogLevel log level</span></span><br><span class="line"><span class="keyword">type</span> LogLevel <span class="type">int</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	<span class="comment">// Silent silent log level</span></span><br><span class="line">	Silent LogLevel = <span class="literal">iota</span> + <span class="number">1</span></span><br><span class="line">	<span class="comment">// Error error log level</span></span><br><span class="line">	Error</span><br><span class="line">	<span class="comment">// Warn warn log level</span></span><br><span class="line">	Warn</span><br><span class="line">	<span class="comment">// Info info log level</span></span><br><span class="line">	Info</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h4 id="级别说明"><a href="#级别说明" class="headerlink" title="级别说明"></a>级别说明</h4><table>
<thead>
<tr>
<th>级别</th>
<th>值</th>
<th>记录内容</th>
<th>使用场景</th>
<th>性能影响</th>
</tr>
</thead>
<tbody><tr>
<td>Silent</td>
<td>1</td>
<td>不记录任何日志</td>
<td>生产环境、性能敏感场景</td>
<td>无</td>
</tr>
<tr>
<td>Error</td>
<td>2</td>
<td>只记录 SQL 错误</td>
<td>生产环境监控</td>
<td>最小</td>
</tr>
<tr>
<td>Warn</td>
<td>3</td>
<td>记录错误和慢查询</td>
<td>生产环境监控</td>
<td>小</td>
</tr>
<tr>
<td>Info</td>
<td>4</td>
<td>记录所有 SQL</td>
<td>开发环境、调试</td>
<td>较大</td>
</tr>
</tbody></table>
<h4 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;gorm.io/gorm/logger&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Silent 模式：完全静默</span></span><br><span class="line">db, _ := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;</span><br><span class="line">	Logger: logger.Default.LogMode(logger.Silent),</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Error 模式：只记录错误</span></span><br><span class="line">db, _ := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;</span><br><span class="line">	Logger: logger.Default.LogMode(logger.Error),</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Warn 模式：记录错误和慢查询</span></span><br><span class="line">db, _ := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;</span><br><span class="line">	Logger: logger.Default.LogMode(logger.Warn),</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Info 模式：记录所有 SQL</span></span><br><span class="line">db, _ := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;</span><br><span class="line">	Logger: logger.Default.LogMode(logger.Info),</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="2-2-Interface-接口-logger-go-62-69"><a href="#2-2-Interface-接口-logger-go-62-69" class="headerlink" title="2.2 Interface 接口 (logger.go:62-69)"></a>2.2 Interface 接口 (logger.go:62-69)</h3><h4 id="接口定义"><a href="#接口定义" class="headerlink" title="接口定义"></a>接口定义</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Interface logger interface</span></span><br><span class="line"><span class="keyword">type</span> Interface <span class="keyword">interface</span> &#123;</span><br><span class="line">	<span class="comment">// 设置日志级别，返回新的 Logger 实例</span></span><br><span class="line">	LogMode(LogLevel) Interface</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 记录信息级别日志</span></span><br><span class="line">	Info(context.Context, <span class="type">string</span>, ...<span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 记录警告级别日志</span></span><br><span class="line">	Warn(context.Context, <span class="type">string</span>, ...<span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 记录错误级别日志</span></span><br><span class="line">	Error(context.Context, <span class="type">string</span>, ...<span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 追踪 SQL 执行 (核心方法)</span></span><br><span class="line">	Trace(ctx context.Context, begin time.Time, fc <span class="function"><span class="keyword">func</span><span class="params">()</span></span> (sql <span class="type">string</span>, rowsAffected <span class="type">int64</span>), err <span class="type">error</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="方法说明"><a href="#方法说明" class="headerlink" title="方法说明"></a>方法说明</h4><p><strong>LogMode(LogLevel) Interface</strong></p>
<ul>
<li>设置日志级别</li>
<li>返回新的 Logger 实例（不可变模式）</li>
<li>支持链式调用</li>
</ul>
<p><strong>Info&#x2F;Warn&#x2F;Error(context.Context, string, …interface{})</strong></p>
<ul>
<li>基础日志记录方法</li>
<li>第一个参数是 context.Context，用于传递上下文信息</li>
<li>第二个参数是消息</li>
<li>后续参数是格式化参数</li>
</ul>
<p><strong>Trace(ctx context.Context, begin time.Time, fc func() (string, int64), err error)</strong></p>
<ul>
<li>核心 SQL 追踪方法</li>
<li>使用延迟计算函数 <code>fc</code> 获取 SQL 和行数</li>
<li>根据日志级别、错误、耗时决定是否记录</li>
</ul>
<h4 id="接口设计原理"><a href="#接口设计原理" class="headerlink" title="接口设计原理"></a>接口设计原理</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">Logger 接口设计原理:</span><br><span class="line"></span><br><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│                     Logger 接口                               │</span><br><span class="line">├─────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                               │</span><br><span class="line">│  ┌─────────────────────────────────────────────────────┐    │</span><br><span class="line">│  │             配置方法                                  │    │</span><br><span class="line">│  │  LogMode(LogLevel) → 设置日志级别                     │    │</span><br><span class="line">│  │                       返回新实例                       │    │</span><br><span class="line">│  └─────────────────────────────────────────────────────┘    │</span><br><span class="line">│                          ↓                                   │</span><br><span class="line">│  ┌─────────────────────────────────────────────────────┐    │</span><br><span class="line">│  │             基础日志方法                              │    │</span><br><span class="line">│  │  Info()  → 记录信息级别日志                           │    │</span><br><span class="line">│  │  Warn()  → 记录警告级别日志                           │    │</span><br><span class="line">│  │  Error() → 记录错误级别日志                           │    │</span><br><span class="line">│  └─────────────────────────────────────────────────────┘    │</span><br><span class="line">│                          ↓                                   │</span><br><span class="line">│  ┌─────────────────────────────────────────────────────┐    │</span><br><span class="line">│  │             核心 SQL 追踪                             │    │</span><br><span class="line">│  │  Trace() → 追踪 SQL 执行                              │    │</span><br><span class="line">│  │           ├─ 记录 SQL 语句                             │    │</span><br><span class="line">│  │           ├─ 记录执行参数                             │    │</span><br><span class="line">│  │           ├─ 记录执行时间                             │    │</span><br><span class="line">│  │           ├─ 记录影响行数                             │    │</span><br><span class="line">│  │           └─ 记录调用位置                             │    │</span><br><span class="line">│  └─────────────────────────────────────────────────────┘    │</span><br><span class="line">│                                                               │</span><br><span class="line">│  设计原则:                                                    │</span><br><span class="line">│  1. 接口简洁：只有 5 个方法，易于实现                        │</span><br><span class="line">│  2. 不可变性：LogMode 返回新实例，避免副作用                  │</span><br><span class="line">│  3. 延迟计算：Trace 使用函数参数，按需获取 SQL                │</span><br><span class="line">│  4. 上下文传递：所有方法接收 context.Context                  │</span><br><span class="line">│                                                               │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="2-3-Config-结构体-logger-go-53-60"><a href="#2-3-Config-结构体-logger-go-53-60" class="headerlink" title="2.3 Config 结构体 (logger.go:53-60)"></a>2.3 Config 结构体 (logger.go:53-60)</h3><h4 id="结构体定义"><a href="#结构体定义" class="headerlink" title="结构体定义"></a>结构体定义</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Config logger config</span></span><br><span class="line"><span class="keyword">type</span> Config <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// 慢查询阈值，超过此时间的 SQL 会被记录为慢查询</span></span><br><span class="line">	SlowThreshold time.Duration</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 是否启用彩色输出</span></span><br><span class="line">	Colorful <span class="type">bool</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 是否忽略 ErrRecordNotFound 错误</span></span><br><span class="line">	IgnoreRecordNotFoundError <span class="type">bool</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 是否只记录参数化 SQL（不替换参数值）</span></span><br><span class="line">	ParameterizedQueries <span class="type">bool</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 日志级别</span></span><br><span class="line">	LogLevel LogLevel</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="字段说明"><a href="#字段说明" class="headerlink" title="字段说明"></a>字段说明</h4><p><strong>SlowThreshold time.Duration</strong></p>
<ul>
<li>慢查询阈值</li>
<li>默认值: 200ms</li>
<li>设置为 0 表示禁用慢查询检测</li>
</ul>
<p><strong>Colorful bool</strong></p>
<ul>
<li>是否启用彩色输出</li>
<li>使用 ANSI 颜色代码</li>
<li>生产环境建议禁用</li>
</ul>
<p><strong>IgnoreRecordNotFoundError bool</strong></p>
<ul>
<li>是否忽略记录未找到错误</li>
<li>默认值: false</li>
<li>设置为 true 时，ErrRecordNotFound 不会触发 Error 日志</li>
</ul>
<p><strong>ParameterizedQueries bool</strong></p>
<ul>
<li>是否只记录参数化 SQL</li>
<li>设置为 true 时，不替换参数值</li>
<li>格式: <code>SELECT * FROM users WHERE id = ?</code></li>
<li>设置为 false 时，会替换参数值</li>
<li>格式: <code>SELECT * FROM users WHERE id = 1</code></li>
</ul>
<p><strong>LogLevel LogLevel</strong></p>
<ul>
<li>日志级别</li>
<li>默认值: Warn</li>
<li>决定记录哪些日志</li>
</ul>
<h4 id="配置示例"><a href="#配置示例" class="headerlink" title="配置示例"></a>配置示例</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;gorm.io/gorm/logger&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 基础配置</span></span><br><span class="line">db, _ := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;</span><br><span class="line">	Logger: logger.New(log.New(os.Stdout, <span class="string">&quot;\r\n&quot;</span>, log.LstdFlags), logger.Config&#123;</span><br><span class="line">		SlowThreshold: <span class="number">200</span> * time.Millisecond,     <span class="comment">// 慢查询阈值</span></span><br><span class="line">		LogLevel:      logger.Info,                 <span class="comment">// 日志级别</span></span><br><span class="line">		Colorful:      <span class="literal">false</span>,                      <span class="comment">// 禁用彩色</span></span><br><span class="line">	&#125;),</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 开发环境配置</span></span><br><span class="line">db, _ := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;</span><br><span class="line">	Logger: logger.New(log.New(os.Stdout, <span class="string">&quot;\r\n&quot;</span>, log.LstdFlags), logger.Config&#123;</span><br><span class="line">		SlowThreshold:             time.Second,     <span class="comment">// 1 秒</span></span><br><span class="line">		LogLevel:                  logger.Info,     <span class="comment">// 所有 SQL</span></span><br><span class="line">		Colorful:                  <span class="literal">true</span>,           <span class="comment">// 彩色输出</span></span><br><span class="line">		IgnoreRecordNotFoundError: <span class="literal">true</span>,           <span class="comment">// 忽略未找到</span></span><br><span class="line">	&#125;),</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生产环境配置</span></span><br><span class="line">db, _ := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;</span><br><span class="line">	Logger: logger.New(log.New(os.Stdout, <span class="string">&quot;\r\n&quot;</span>, log.LstdFlags), logger.Config&#123;</span><br><span class="line">		SlowThreshold:        <span class="number">500</span> * time.Millisecond,  <span class="comment">// 500ms</span></span><br><span class="line">		LogLevel:             logger.Warn,             <span class="comment">// 错误和慢查询</span></span><br><span class="line">		Colorful:             <span class="literal">false</span>,                  <span class="comment">// 禁用彩色</span></span><br><span class="line">		ParameterizedQueries: <span class="literal">true</span>,                  <span class="comment">// 参数化 SQL</span></span><br><span class="line">	&#125;),</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 只记录参数化 SQL（用于安全审计）</span></span><br><span class="line">db, _ := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;</span><br><span class="line">	Logger: logger.New(log.New(os.Stdout, <span class="string">&quot;\r\n&quot;</span>, log.LstdFlags), logger.Config&#123;</span><br><span class="line">		LogLevel:             logger.Info,</span><br><span class="line">		ParameterizedQueries: <span class="literal">true</span>,  <span class="comment">// 不记录参数值</span></span><br><span class="line">	&#125;),</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="2-4-logger-结构体-logger-go-122-127"><a href="#2-4-logger-结构体-logger-go-122-127" class="headerlink" title="2.4 logger 结构体 (logger.go:122-127)"></a>2.4 logger 结构体 (logger.go:122-127)</h3><h4 id="结构体定义-1"><a href="#结构体定义-1" class="headerlink" title="结构体定义"></a>结构体定义</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> logger <span class="keyword">struct</span> &#123;</span><br><span class="line">	Writer    <span class="comment">// 嵌入 Writer 接口</span></span><br><span class="line">	Config    <span class="comment">// 嵌入 Config</span></span><br><span class="line">	infoStr, warnStr, errStr            <span class="type">string</span>  <span class="comment">// 基础日志格式字符串</span></span><br><span class="line">	traceStr, traceErrStr, traceWarnStr <span class="type">string</span>  <span class="comment">// SQL 追踪格式字符串</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="字段说明-1"><a href="#字段说明-1" class="headerlink" title="字段说明"></a>字段说明</h4><p><strong>Writer</strong></p>
<ul>
<li>嵌入的 Writer 接口</li>
<li>提供 Printf 方法</li>
<li>默认实现: <code>log.New(os.Stdout, &quot;\r\n&quot;, log.LstdFlags)</code></li>
</ul>
<p><strong>Config</strong></p>
<ul>
<li>嵌入的 Config 结构体</li>
<li>包含所有配置选项</li>
</ul>
<p><strong>infoStr, warnStr, errStr</strong></p>
<ul>
<li>基础日志格式字符串</li>
<li>包含颜色代码（如果启用）</li>
<li>示例: <code>&quot;\033[32m%s\n\033[0m\033[32m[info] \033[0m&quot;</code></li>
</ul>
<p><strong>traceStr, traceErrStr, traceWarnStr</strong></p>
<ul>
<li>SQL 追踪格式字符串</li>
<li>包含时间、行数、SQL 的占位符</li>
<li>示例: <code>&quot;\033[32m%s\n\033[0m\033[33m[%.3fms] \033[34;1m[rows:%v]\033[0m %s&quot;</code></li>
</ul>
<hr>
<h3 id="2-5-Writer-接口-logger-go-48-51"><a href="#2-5-Writer-接口-logger-go-48-51" class="headerlink" title="2.5 Writer 接口 (logger.go:48-51)"></a>2.5 Writer 接口 (logger.go:48-51)</h3><h4 id="接口定义-1"><a href="#接口定义-1" class="headerlink" title="接口定义"></a>接口定义</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Writer log writer interface</span></span><br><span class="line"><span class="keyword">type</span> Writer <span class="keyword">interface</span> &#123;</span><br><span class="line">	Printf(<span class="type">string</span>, ...<span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="实现示例"><a href="#实现示例" class="headerlink" title="实现示例"></a>实现示例</h4><p><strong>标准库 log.Logger</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;log&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 标准库 log.Logger 实现了 Writer 接口</span></span><br><span class="line">writer := log.New(os.Stdout, <span class="string">&quot;\r\n&quot;</span>, log.LstdFlags)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用</span></span><br><span class="line">logger.New(writer, logger.Config&#123;&#125;)</span><br></pre></td></tr></table></figure>

<p><strong>自定义 Writer</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 自定义 Writer：写入文件</span></span><br><span class="line"><span class="keyword">type</span> FileWriter <span class="keyword">struct</span> &#123;</span><br><span class="line">	file *os.File</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *FileWriter)</span></span> Printf(format <span class="type">string</span>, args ...<span class="keyword">interface</span>&#123;&#125;) &#123;</span><br><span class="line">	fmt.Fprintf(w.file, format, args...)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用</span></span><br><span class="line">file, _ := os.OpenFile(<span class="string">&quot;gorm.log&quot;</span>, os.O_CREATE|os.O_WRONLY|os.O_APPEND, <span class="number">0644</span>)</span><br><span class="line">writer := &amp;FileWriter&#123;file: file&#125;</span><br><span class="line">logger.New(writer, logger.Config&#123;&#125;)</span><br></pre></td></tr></table></figure>

<p><strong>多输出 Writer</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 多输出 Writer：同时写入多个目标</span></span><br><span class="line"><span class="keyword">type</span> MultiWriter <span class="keyword">struct</span> &#123;</span><br><span class="line">	writers []Writer</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *MultiWriter)</span></span> Printf(format <span class="type">string</span>, args ...<span class="keyword">interface</span>&#123;&#125;) &#123;</span><br><span class="line">	<span class="keyword">for</span> _, writer := <span class="keyword">range</span> w.writers &#123;</span><br><span class="line">		writer.Printf(format, args...)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用</span></span><br><span class="line">multiWriter := &amp;MultiWriter&#123;</span><br><span class="line">	writers: []Writer&#123;</span><br><span class="line">		log.New(os.Stdout, <span class="string">&quot;\r\n&quot;</span>, log.LstdFlags),</span><br><span class="line">		log.New(logFile, <span class="string">&quot;\r\n&quot;</span>, log.LstdFlags),</span><br><span class="line">	&#125;,</span><br><span class="line">&#125;</span><br><span class="line">logger.New(multiWriter, logger.Config&#123;&#125;)</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="2-6-traceRecorder-结构体-logger-go-200-206"><a href="#2-6-traceRecorder-结构体-logger-go-200-206" class="headerlink" title="2.6 traceRecorder 结构体 (logger.go:200-206)"></a>2.6 traceRecorder 结构体 (logger.go:200-206)</h3><h4 id="结构体定义-2"><a href="#结构体定义-2" class="headerlink" title="结构体定义"></a>结构体定义</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> traceRecorder <span class="keyword">struct</span> &#123;</span><br><span class="line">	Interface              <span class="comment">// 嵌入 Logger 接口</span></span><br><span class="line">	BeginAt      time.Time <span class="comment">// 开始时间</span></span><br><span class="line">	SQL          <span class="type">string</span>    <span class="comment">// SQL 语句</span></span><br><span class="line">	RowsAffected <span class="type">int64</span>     <span class="comment">// 影响行数</span></span><br><span class="line">	Err          <span class="type">error</span>     <span class="comment">// 错误</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="用途说明"><a href="#用途说明" class="headerlink" title="用途说明"></a>用途说明</h4><p><strong>SQL 记录</strong></p>
<ul>
<li>记录所有执行的 SQL</li>
<li>用于调试和审计</li>
</ul>
<p><strong>单元测试</strong></p>
<ul>
<li>验证生成的 SQL 是否正确</li>
<li>验证参数是否正确</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用 Recorder 进行单元测试</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestUserQuery</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">	db, _ := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;</span><br><span class="line">		Logger: logger.Recorder,</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 执行查询</span></span><br><span class="line">	<span class="keyword">var</span> users []User</span><br><span class="line">	db.Find(&amp;users)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 获取记录的 SQL</span></span><br><span class="line">	sql := logger.Recorder.SQL</span><br><span class="line">	fmt.Println(sql)</span><br><span class="line">	<span class="comment">// 输出: SELECT * FROM `users`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>SQL 审计</strong></p>
<ul>
<li>记录所有 SQL 操作</li>
<li>用于安全审计</li>
</ul>
<hr>
<h2 id="三、日志核心实现"><a href="#三、日志核心实现" class="headerlink" title="三、日志核心实现"></a>三、日志核心实现</h2><h3 id="3-1-New-函数-logger-go-90-120"><a href="#3-1-New-函数-logger-go-90-120" class="headerlink" title="3.1 New() 函数 (logger.go:90-120)"></a>3.1 New() 函数 (logger.go:90-120)</h3><h4 id="完整源码"><a href="#完整源码" class="headerlink" title="完整源码"></a>完整源码</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// New initialize logger</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(writer Writer, config Config)</span></span> Interface &#123;</span><br><span class="line">	<span class="keyword">var</span> (</span><br><span class="line">		infoStr      = <span class="string">&quot;%s\n[info] &quot;</span></span><br><span class="line">		warnStr      = <span class="string">&quot;%s\n[warn] &quot;</span></span><br><span class="line">		errStr       = <span class="string">&quot;%s\n[error] &quot;</span></span><br><span class="line">		traceStr     = <span class="string">&quot;%s\n[%.3fms] [rows:%v] %s&quot;</span></span><br><span class="line">		traceWarnStr = <span class="string">&quot;%s %s\n[%.3fms] [rows:%v] %s&quot;</span></span><br><span class="line">		traceErrStr  = <span class="string">&quot;%s %s\n[%.3fms] [rows:%v] %s&quot;</span></span><br><span class="line">	)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> config.Colorful &#123;</span><br><span class="line">		<span class="comment">// 彩色格式字符串</span></span><br><span class="line">		infoStr = Green + <span class="string">&quot;%s\n&quot;</span> + Reset + Green + <span class="string">&quot;[info] &quot;</span> + Reset</span><br><span class="line">		warnStr = BlueBold + <span class="string">&quot;%s\n&quot;</span> + Reset + Magenta + <span class="string">&quot;[warn] &quot;</span> + Reset</span><br><span class="line">		errStr = Magenta + <span class="string">&quot;%s\n&quot;</span> + Reset + Red + <span class="string">&quot;[error] &quot;</span> + Reset</span><br><span class="line">		traceStr = Green + <span class="string">&quot;%s\n&quot;</span> + Reset + Yellow + <span class="string">&quot;[%.3fms] &quot;</span> + BlueBold + <span class="string">&quot;[rows:%v]&quot;</span> + Reset + <span class="string">&quot; %s&quot;</span></span><br><span class="line">		traceWarnStr = Green + <span class="string">&quot;%s &quot;</span> + Yellow + <span class="string">&quot;%s\n&quot;</span> + Reset + RedBold + <span class="string">&quot;[%.3fms] &quot;</span> + Yellow + <span class="string">&quot;[rows:%v]&quot;</span> + Magenta + <span class="string">&quot; %s&quot;</span> + Reset</span><br><span class="line">		traceErrStr = RedBold + <span class="string">&quot;%s &quot;</span> + MagentaBold + <span class="string">&quot;%s\n&quot;</span> + Reset + Yellow + <span class="string">&quot;[%.3fms] &quot;</span> + BlueBold + <span class="string">&quot;[rows:%v]&quot;</span> + Reset + <span class="string">&quot; %s&quot;</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> &amp;logger&#123;</span><br><span class="line">		Writer:       writer,</span><br><span class="line">		Config:       config,</span><br><span class="line">		infoStr:      infoStr,</span><br><span class="line">		warnStr:      warnStr,</span><br><span class="line">		errStr:       errStr,</span><br><span class="line">		traceStr:     traceStr,</span><br><span class="line">		traceWarnStr: traceWarnStr,</span><br><span class="line">		traceErrStr:  traceErrStr,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="格式化字符串构建"><a href="#格式化字符串构建" class="headerlink" title="格式化字符串构建"></a>格式化字符串构建</h4><p><strong>非彩色模式</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">infoStr:      &quot;%s\n[info] &quot;</span><br><span class="line">warnStr:      &quot;%s\n[warn] &quot;</span><br><span class="line">errStr:       &quot;%s\n[error] &quot;</span><br><span class="line">traceStr:     &quot;%s\n[%.3fms] [rows:%v] %s&quot;</span><br><span class="line">traceWarnStr: &quot;%s %s\n[%.3fms] [rows:%v] %s&quot;</span><br><span class="line">traceErrStr:  &quot;%s %s\n[%.3fms] [rows:%v] %s&quot;</span><br></pre></td></tr></table></figure>

<p><strong>彩色模式</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">infoStr:      &quot;\033[32m%s\n\033[0m\033[32m[info] \033[0m&quot;</span><br><span class="line">warnStr:      &quot;\033[34;1m%s\n\033[0m\033[35m[warn] \033[0m&quot;</span><br><span class="line">errStr:       &quot;\033[35m%s\n\033[0m\033[31m[error] \033[0m&quot;</span><br><span class="line">traceStr:     &quot;\033[32m%s\n\033[0m\033[33m[%.3fms] \033[34;1m[rows:%v]\033[0m %s&quot;</span><br><span class="line">traceWarnStr: &quot;\033[32m%s \033[33m%s\n\033[0m\033[31;1m[%.3fms] \033[33m[rows:%v]\033[35m %s\033[0m&quot;</span><br><span class="line">traceErrStr:  &quot;\033[31;1m%s \033[35;1m%s\n\033[0m\033[33m[%.3fms] \033[34;1m[rows:%v]\033[0m %s&quot;</span><br></pre></td></tr></table></figure>

<p><strong>ANSI 颜色代码</strong></p>
<table>
<thead>
<tr>
<th>代码</th>
<th>颜色</th>
<th>用途</th>
</tr>
</thead>
<tbody><tr>
<td><code>\033[32m</code></td>
<td>绿色</td>
<td>Info 级别</td>
</tr>
<tr>
<td><code>\033[34;1m</code></td>
<td>蓝色加粗</td>
<td>Warn 级别前缀</td>
</tr>
<tr>
<td><code>\033[35m</code></td>
<td>洋红色</td>
<td>Warn 消息</td>
</tr>
<tr>
<td><code>\033[31m</code></td>
<td>红色</td>
<td>Error 级别</td>
</tr>
<tr>
<td><code>\033[33m</code></td>
<td>黄色</td>
<td>执行时间</td>
</tr>
<tr>
<td><code>\033[0m</code></td>
<td>重置</td>
<td>重置颜色</td>
</tr>
</tbody></table>
<hr>
<h3 id="3-2-LogMode-方法-logger-go-129-134"><a href="#3-2-LogMode-方法-logger-go-129-134" class="headerlink" title="3.2 LogMode() 方法 (logger.go:129-134)"></a>3.2 LogMode() 方法 (logger.go:129-134)</h3><h4 id="完整源码-1"><a href="#完整源码-1" class="headerlink" title="完整源码"></a>完整源码</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LogMode log mode</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *logger)</span></span> LogMode(level LogLevel) Interface &#123;</span><br><span class="line">	newlogger := *l           <span class="comment">// 创建副本</span></span><br><span class="line">	newlogger.LogLevel = level <span class="comment">// 修改日志级别</span></span><br><span class="line">	<span class="keyword">return</span> &amp;newlogger          <span class="comment">// 返回新实例</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="级别切换机制"><a href="#级别切换机制" class="headerlink" title="级别切换机制"></a>级别切换机制</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">LogMode() 调用流程:</span><br><span class="line"></span><br><span class="line">db.Logger.LogMode(logger.Info)</span><br><span class="line">    │</span><br><span class="line">    ├─► 1. 创建 logger 副本</span><br><span class="line">    │   └─ newlogger := *l</span><br><span class="line">    │       └─ 复制所有字段 (Writer, Config, 格式字符串)</span><br><span class="line">    │</span><br><span class="line">    ├─► 2. 修改日志级别</span><br><span class="line">    │   └─ newlogger.LogLevel = level</span><br><span class="line">    │</span><br><span class="line">    └─► 3. 返回新实例</span><br><span class="line">        └─ return &amp;newlogger</span><br><span class="line">            └─ 原实例保持不变</span><br></pre></td></tr></table></figure>

<p><strong>不可变性优势</strong></p>
<ul>
<li>原实例不受影响</li>
<li>线程安全</li>
<li>支持链式调用</li>
</ul>
<hr>
<h3 id="3-3-Trace-方法-logger-go-157-190"><a href="#3-3-Trace-方法-logger-go-157-190" class="headerlink" title="3.3 Trace() 方法 (logger.go:157-190)"></a>3.3 Trace() 方法 (logger.go:157-190)</h3><h4 id="完整源码-2"><a href="#完整源码-2" class="headerlink" title="完整源码"></a>完整源码</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Trace print sql message</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//nolint:cyclop</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *logger)</span></span> Trace(ctx context.Context, begin time.Time, fc <span class="function"><span class="keyword">func</span><span class="params">()</span></span> (<span class="type">string</span>, <span class="type">int64</span>), err <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="comment">// === 1. 检查日志级别 ===</span></span><br><span class="line">	<span class="keyword">if</span> l.LogLevel &lt;= Silent &#123;</span><br><span class="line">		<span class="keyword">return</span>  <span class="comment">// Silent 模式，直接返回</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// === 2. 计算执行耗时 ===</span></span><br><span class="line">	elapsed := time.Since(begin)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// === 3. 根据条件决定记录 ===</span></span><br><span class="line">	<span class="keyword">switch</span> &#123;</span><br><span class="line">	<span class="keyword">case</span> err != <span class="literal">nil</span> &amp;&amp; l.LogLevel &gt;= Error &amp;&amp; (!errors.Is(err, ErrRecordNotFound) || !l.IgnoreRecordNotFoundError):</span><br><span class="line">		<span class="comment">// === 有错误且日志级别 &gt;= Error ===</span></span><br><span class="line">		sql, rows := fc()  <span class="comment">// 延迟获取 SQL 和行数</span></span><br><span class="line">		<span class="keyword">if</span> rows == <span class="number">-1</span> &#123;</span><br><span class="line">			l.Printf(l.traceErrStr, utils.FileWithLineNum(), err, <span class="type">float64</span>(elapsed.Nanoseconds())/<span class="number">1e6</span>, <span class="string">&quot;-&quot;</span>, sql)</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			l.Printf(l.traceErrStr, utils.FileWithLineNum(), err, <span class="type">float64</span>(elapsed.Nanoseconds())/<span class="number">1e6</span>, rows, sql)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">case</span> elapsed &gt; l.SlowThreshold &amp;&amp; l.SlowThreshold != <span class="number">0</span> &amp;&amp; l.LogLevel &gt;= Warn:</span><br><span class="line">		<span class="comment">// === 慢查询 ===</span></span><br><span class="line">		sql, rows := fc()  <span class="comment">// 延迟获取 SQL 和行数</span></span><br><span class="line">		slowLog := fmt.Sprintf(<span class="string">&quot;SLOW SQL &gt;= %v&quot;</span>, l.SlowThreshold)</span><br><span class="line">		<span class="keyword">if</span> rows == <span class="number">-1</span> &#123;</span><br><span class="line">			l.Printf(l.traceWarnStr, utils.FileWithLineNum(), slowLog, <span class="type">float64</span>(elapsed.Nanoseconds())/<span class="number">1e6</span>, <span class="string">&quot;-&quot;</span>, sql)</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			l.Printf(l.traceWarnStr, utils.FileWithLineNum(), slowLog, <span class="type">float64</span>(elapsed.Nanoseconds())/<span class="number">1e6</span>, rows, sql)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">case</span> l.LogLevel == Info:</span><br><span class="line">		<span class="comment">// === Info 级别，记录所有 SQL ===</span></span><br><span class="line">		sql, rows := fc()  <span class="comment">// 延迟获取 SQL 和行数</span></span><br><span class="line">		<span class="keyword">if</span> rows == <span class="number">-1</span> &#123;</span><br><span class="line">			l.Printf(l.traceStr, utils.FileWithLineNum(), <span class="type">float64</span>(elapsed.Nanoseconds())/<span class="number">1e6</span>, <span class="string">&quot;-&quot;</span>, sql)</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			l.Printf(l.traceStr, utils.FileWithLineNum(), <span class="type">float64</span>(elapsed.Nanoseconds())/<span class="number">1e6</span>, rows, sql)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// === 其他情况不记录 ===</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="执行流程详解"><a href="#执行流程详解" class="headerlink" title="执行流程详解"></a>执行流程详解</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">Trace() 完整执行流程:</span><br><span class="line"></span><br><span class="line">Trace(ctx, begin, fc, err)</span><br><span class="line">    │</span><br><span class="line">    ├─► 1. 检查日志级别</span><br><span class="line">    │   └─ if l.LogLevel &lt;= Silent</span><br><span class="line">    │       └─ return (不记录)</span><br><span class="line">    │</span><br><span class="line">    ├─► 2. 计算耗时</span><br><span class="line">    │   └─ elapsed := time.Since(begin)</span><br><span class="line">    │</span><br><span class="line">    ├─► 3. 判断记录条件</span><br><span class="line">    │   │</span><br><span class="line">    │   ├─► 3a. 有错误?</span><br><span class="line">    │   │   └─ err != nil &amp;&amp; l.LogLevel &gt;= Error</span><br><span class="line">    │   │       └─ 是否忽略 ErrRecordNotFound?</span><br><span class="line">    │   │           └─ 调用 fc() 获取 SQL 和行数</span><br><span class="line">    │   │           └─ Printf(traceErrStr, ...)</span><br><span class="line">    │   │</span><br><span class="line">    │   ├─► 3b. 是慢查询?</span><br><span class="line">    │   │   └─ elapsed &gt; l.SlowThreshold &amp;&amp; l.SlowThreshold != 0</span><br><span class="line">    │   │       └─ l.LogLevel &gt;= Warn</span><br><span class="line">    │   │           └─ 调用 fc() 获取 SQL 和行数</span><br><span class="line">    │   │           └─ Printf(traceWarnStr, ...)</span><br><span class="line">    │   │</span><br><span class="line">    │   └─► 3c. Info 级别?</span><br><span class="line">    │       └─ l.LogLevel == Info</span><br><span class="line">    │           └─ 调用 fc() 获取 SQL 和行数</span><br><span class="line">    │           └─ Printf(traceStr, ...)</span><br><span class="line">    │</span><br><span class="line">    └─► 4. 其他情况</span><br><span class="line">        └─ 不记录任何日志</span><br></pre></td></tr></table></figure>

<h4 id="决策逻辑"><a href="#决策逻辑" class="headerlink" title="决策逻辑"></a>决策逻辑</h4><p><strong>优先级</strong></p>
<ol>
<li>错误日志 (最高优先级)</li>
<li>慢查询日志</li>
<li>Info 日志 (最低优先级)</li>
</ol>
<p><strong>条件检查顺序</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">1. err != nil?</span><br><span class="line">   Yes AND l.LogLevel &gt;= Error?</span><br><span class="line">     Yes AND (err != ErrRecordNotFound OR !l.IgnoreRecordNotFoundError)?</span><br><span class="line">       Yes → 记录错误日志</span><br><span class="line">       No  → 继续</span><br><span class="line"></span><br><span class="line">2. elapsed &gt; l.SlowThreshold?</span><br><span class="line">   Yes AND l.SlowThreshold != 0?</span><br><span class="line">     Yes AND l.LogLevel &gt;= Warn?</span><br><span class="line">       Yes → 记录慢查询日志</span><br><span class="line">       No  → 继续</span><br><span class="line"></span><br><span class="line">3. l.LogLevel == Info?</span><br><span class="line">   Yes → 记录所有 SQL</span><br><span class="line">   No  → 不记录</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="二、核心原理"><a href="#二、核心原理" class="headerlink" title="二、核心原理"></a>二、核心原理</h2><h3 id="2-1-关键概念"><a href="#2-1-关键概念" class="headerlink" title="2.1 关键概念"></a>2.1 关键概念</h3><h4 id="概念-1-Logger-接口"><a href="#概念-1-Logger-接口" class="headerlink" title="概念 1: Logger 接口"></a>概念 1: Logger 接口</h4><p><strong>定义</strong>: Logger 是日志系统的核心接口。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Interface <span class="keyword">interface</span> &#123;</span><br><span class="line">    <span class="comment">// 设置日志级别，返回新的 Logger 实例</span></span><br><span class="line">    LogMode(LogLevel) Interface</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 记录信息级别日志</span></span><br><span class="line">    Info(ctx context.Context, msg <span class="type">string</span>, data ...<span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 记录警告级别日志</span></span><br><span class="line">    Warn(ctx context.Context, msg <span class="type">string</span>, data ...<span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 记录错误级别日志</span></span><br><span class="line">    Error(ctx context.Context, msg <span class="type">string</span>, data ...<span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 追踪 SQL 执行</span></span><br><span class="line">    Trace(ctx context.Context, begin time.Time, fc <span class="function"><span class="keyword">func</span><span class="params">()</span></span> (<span class="type">string</span>, <span class="type">int64</span>), err <span class="type">error</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ParamsFilter 接口: 过滤敏感参数</span></span><br><span class="line"><span class="keyword">type</span> ParamsFilter <span class="keyword">interface</span> &#123;</span><br><span class="line">    ParamsFilter(ctx context.Context, sql <span class="type">string</span>, params ...<span class="keyword">interface</span>&#123;&#125;) (<span class="type">string</span>, []<span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>接口设计原理</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">Logger 接口设计:</span><br><span class="line"></span><br><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│                     Logger 接口                               │</span><br><span class="line">├─────────────────────────────────────────────────────────────┤</span><br><span class="line">│  配置方法                                                   │</span><br><span class="line">│  └─ LogMode(LogLevel) → 设置日志级别                       │</span><br><span class="line">├─────────────────────────────────────────────────────────────┤</span><br><span class="line">│  基础日志方法                                               │</span><br><span class="line">│  ├─ Info()  → 记录信息级别日志                               │</span><br><span class="line">│  ├─ Warn()  → 记录警告级别日志                               │</span><br><span class="line">│  └─ Error() → 记录错误级别日志                               │</span><br><span class="line">├─────────────────────────────────────────────────────────────┤</span><br><span class="line">│  核心 SQL 追踪                                              │</span><br><span class="line">│  └─ Trace() → 追踪 SQL 执行                                 │</span><br><span class="line">│              ├─ 记录 SQL 语句                                │</span><br><span class="line">│              ├─ 记录执行参数                                 │</span><br><span class="line">│              ├─ 记录执行时间                                 │</span><br><span class="line">│              ├─ 记录影响行数                                 │</span><br><span class="line">│              └─ 记录调用位置                                 │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h4 id="概念-2-LogLevel-枚举"><a href="#概念-2-LogLevel-枚举" class="headerlink" title="概念 2: LogLevel 枚举"></a>概念 2: LogLevel 枚举</h4><p><strong>定义</strong>: LogLevel 定义了四个日志级别。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> LogLevel <span class="type">int</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    Silent LogLevel = <span class="literal">iota</span> + <span class="number">1</span>  <span class="comment">// 1: 静默模式</span></span><br><span class="line">    Error                        <span class="comment">// 2: 只记录错误</span></span><br><span class="line">    Warn                         <span class="comment">// 3: 记录错误和警告</span></span><br><span class="line">    Info                         <span class="comment">// 4: 记录所有信息</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><strong>日志级别对比</strong>:</p>
<table>
<thead>
<tr>
<th>级别</th>
<th>值</th>
<th>记录内容</th>
<th>使用场景</th>
<th>性能影响</th>
</tr>
</thead>
<tbody><tr>
<td>Silent</td>
<td>1</td>
<td>不记录任何日志</td>
<td>生产环境、性能敏感</td>
<td>无</td>
</tr>
<tr>
<td>Error</td>
<td>2</td>
<td>只记录 SQL 错误</td>
<td>生产环境</td>
<td>最小</td>
</tr>
<tr>
<td>Warn</td>
<td>3</td>
<td>记录错误和慢查询</td>
<td>生产环境、监控</td>
<td>小</td>
</tr>
<tr>
<td>Info</td>
<td>4</td>
<td>记录所有 SQL</td>
<td>开发环境、调试</td>
<td>较大</td>
</tr>
</tbody></table>
<p><strong>日志级别决策树</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Trace 方法执行流程:</span><br><span class="line">    │</span><br><span class="line">    ├─► 1. 检查日志级别</span><br><span class="line">    │       └─ if l.LogLevel == Silent</span><br><span class="line">    │           └─ 直接返回，不记录任何日志</span><br><span class="line">    │</span><br><span class="line">    ├─► 2. 检查是否有错误</span><br><span class="line">    │       └─ if err != nil &amp;&amp; l.LogLevel &gt;= Error</span><br><span class="line">    │           └─ 调用 Error() 记录错误</span><br><span class="line">    │</span><br><span class="line">    ├─► 3. 检查是否是慢查询</span><br><span class="line">    │       └─ if elapsed &gt; l.SlowThreshold &amp;&amp; l.SlowThreshold != 0</span><br><span class="line">    │           └─ 调用 Warn() 记录慢查询</span><br><span class="line">    │</span><br><span class="line">    ├─► 4. 检查是否是 Info 级别</span><br><span class="line">    │       └─ if l.LogLevel &gt;= Info</span><br><span class="line">    │           └─ 调用 Info() 记录所有 SQL</span><br><span class="line">    │</span><br><span class="line">    └─► 5. 否则不记录</span><br></pre></td></tr></table></figure>

<p><strong>使用示例</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 开发环境: 详细日志</span></span><br><span class="line">db, _ := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;</span><br><span class="line">    Logger: logger.Default.LogMode(logger.Info),</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 日志输出:</span></span><br><span class="line"><span class="comment">// [2024-01-01 10:00:00] [3.45ms] SELECT * FROM users WHERE age &gt; 18</span></span><br><span class="line"><span class="comment">// [2024-01-01 10:00:01] [1.23ms] INSERT INTO users (name) VALUES (&#x27;John&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 生产环境: 只记录错误</span></span><br><span class="line">db, _ := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;</span><br><span class="line">    Logger: logger.Default.LogMode(logger.Error),</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 日志输出:</span></span><br><span class="line"><span class="comment">// [2024-01-01 10:00:00] [5.67ms] ERROR: SQL: SELECT * FROM non_existent_table</span></span><br><span class="line"><span class="comment">// Error: Table &#x27;db.non_existent_table&#x27; doesn&#x27;t exist</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 慢查询检测</span></span><br><span class="line">db, _ := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;</span><br><span class="line">    Logger: logger.Default.LogMode(logger.Warn),</span><br><span class="line">&#125;).Set(<span class="string">&quot;gorm:threshold&quot;</span>, <span class="number">200</span> * time.Millisecond)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 日志输出:</span></span><br><span class="line"><span class="comment">// [2024-01-01 10:00:00] [250.45ms] SLOW SQL &gt;= 200ms</span></span><br><span class="line"><span class="comment">// [200.45ms] [rows:1000] SELECT * FROM large_table JOIN another_table</span></span><br></pre></td></tr></table></figure>

<h4 id="概念-3-Trace-方法详解"><a href="#概念-3-Trace-方法详解" class="headerlink" title="概念 3: Trace 方法详解"></a>概念 3: Trace 方法详解</h4><p><strong>定义</strong>: Trace 是记录 SQL 执行的核心方法。</p>
<p><strong>方法签名</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *logger)</span></span> Trace(ctx context.Context, begin time.Time, fc <span class="function"><span class="keyword">func</span><span class="params">()</span></span> (<span class="type">string</span>, <span class="type">int64</span>), err <span class="type">error</span>)</span><br></pre></td></tr></table></figure>

<p><strong>参数说明</strong>:</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>类型</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>ctx</td>
<td>context.Context</td>
<td>上下文，用于传递请求信息</td>
<td>request.Context()</td>
</tr>
<tr>
<td>begin</td>
<td>time.Time</td>
<td>SQL 执行开始时间</td>
<td>time.Now()</td>
</tr>
<tr>
<td>fc</td>
<td>func() (string, int64)</td>
<td>延迟计算函数，返回 SQL 和行数</td>
<td>func() { return sql, rows }</td>
</tr>
<tr>
<td>err</td>
<td>error</td>
<td>SQL 执行错误</td>
<td>sql.ErrNoRows</td>
</tr>
</tbody></table>
<p><strong>实现流程</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l logger)</span></span> Trace(ctx context.Context, begin time.Time, fc <span class="function"><span class="keyword">func</span><span class="params">()</span></span> (<span class="type">string</span>, <span class="type">int64</span>), err <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="comment">// === 1. 计算执行耗时 ===</span></span><br><span class="line">    elapsed := time.Since(begin)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 2. 延迟获取 SQL 和行数 ===</span></span><br><span class="line">    sql, rows := fc()</span><br><span class="line">    <span class="keyword">if</span> sql == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">        sql = <span class="string">&quot;[empty SQL]&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 3. 过滤敏感参数 ===</span></span><br><span class="line">    fields := l.fields</span><br><span class="line">    <span class="keyword">if</span> l.colorful &amp;&amp; l.InfoColor != <span class="literal">nil</span> &#123;</span><br><span class="line">        fields = l.InfoColor</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 4. 根据条件记录日志 ===</span></span><br><span class="line">    <span class="keyword">switch</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> err != <span class="literal">nil</span> &amp;&amp; l.LogLevel &gt;= Error:</span><br><span class="line">        <span class="comment">// 有错误且日志级别 &gt;= Error</span></span><br><span class="line">        <span class="keyword">if</span> l.IgnoreRecordNotFoundError &amp;&amp; errors.Is(err, gorm.ErrRecordNotFound) &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        l.log(ctx, ErrorLevel, err, elapsed, sql, rows, fields...)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> elapsed &gt; l.SlowThreshold &amp;&amp; l.SlowThreshold != <span class="number">0</span> &amp;&amp; l.LogLevel &gt; Silent:</span><br><span class="line">        <span class="comment">// 超过慢查询阈值</span></span><br><span class="line">        l.log(ctx, WarnLevel, err, elapsed, sql, rows, fields...)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> l.LogLevel &gt;= Info:</span><br><span class="line">        <span class="comment">// Info 级别，记录所有 SQL</span></span><br><span class="line">        l.log(ctx, InfoLevel, err, elapsed, sql, rows, fields...)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>延迟计算的优势</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 不使用延迟计算 (性能差)</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Trace</span><span class="params">(ctx context.Context, begin time.Time, sql <span class="type">string</span>, rows <span class="type">int64</span>, err <span class="type">error</span>)</span></span> &#123;</span><br><span class="line">    elapsed := time.Since(begin)</span><br><span class="line">    <span class="comment">// 无论日志级别如何，都已经获取了 sql 和 rows</span></span><br><span class="line">    <span class="comment">// 这可能涉及不必要的字符串格式化</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用延迟计算 (性能好)</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Trace</span><span class="params">(ctx context.Context, begin time.Time, fc <span class="keyword">func</span>()</span></span> (<span class="type">string</span>, <span class="type">int64</span>), err <span class="type">error</span>) &#123;</span><br><span class="line">    elapsed := time.Since(begin)</span><br><span class="line">    <span class="comment">// 只在需要记录日志时才调用 fc()</span></span><br><span class="line">    <span class="keyword">if</span> l.LogLevel &gt;= Info &#123;</span><br><span class="line">        sql, rows := fc()  <span class="comment">// 延迟计算</span></span><br><span class="line">        l.log(sql, rows)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="概念-4-SQL-解释机制"><a href="#概念-4-SQL-解释机制" class="headerlink" title="概念 4: SQL 解释机制"></a>概念 4: SQL 解释机制</h4><p><strong>定义</strong>: SQL 解释将参数化 SQL 转换为可读的完整 SQL。</p>
<p><strong>原始 SQL</strong>:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 参数化 SQL (prepared statement)</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> age <span class="operator">&gt;</span> ? <span class="keyword">AND</span> name <span class="operator">=</span> ?</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 参数值</span></span><br><span class="line">[<span class="number">18</span>, &quot;John&quot;]</span><br></pre></td></tr></table></figure>

<p><strong>解释后的 SQL</strong>:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 可读 SQL (explained SQL)</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> age <span class="operator">&gt;</span> <span class="number">18</span> <span class="keyword">AND</span> name <span class="operator">=</span> <span class="string">&#x27;John&#x27;</span></span><br></pre></td></tr></table></figure>

<p><strong>实现原理</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SQL 解释器</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ExplainSQL</span><span class="params">(sql <span class="type">string</span>, args ...<span class="keyword">interface</span>&#123;&#125;)</span></span> <span class="type">string</span> &#123;</span><br><span class="line">    <span class="comment">// === 1. 参数计数 ===</span></span><br><span class="line">    paramCount := strings.Count(sql, <span class="string">&quot;?&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> paramCount != <span class="built_in">len</span>(args) &#123;</span><br><span class="line">        <span class="keyword">return</span> sql + <span class="string">&quot; [参数数量不匹配]&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 2. 逐个替换参数 ===</span></span><br><span class="line">    result := sql</span><br><span class="line">    <span class="keyword">for</span> _, arg := <span class="keyword">range</span> args &#123;</span><br><span class="line">        <span class="comment">// 查找第一个 &quot;?&quot;</span></span><br><span class="line">        idx := strings.Index(result, <span class="string">&quot;?&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> idx == <span class="number">-1</span> &#123;</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 格式化参数</span></span><br><span class="line">        <span class="keyword">var</span> formatted <span class="type">string</span></span><br><span class="line">        <span class="keyword">switch</span> v := arg.(<span class="keyword">type</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="type">string</span>:</span><br><span class="line">            formatted = fmt.Sprintf(<span class="string">&quot;&#x27;%v&#x27;&quot;</span>, escapeString(v))</span><br><span class="line">        <span class="keyword">case</span> time.Time:</span><br><span class="line">            formatted = fmt.Sprintf(<span class="string">&quot;&#x27;%v&#x27;&quot;</span>, v.Format(<span class="string">&quot;2006-01-02 15:04:05&quot;</span>))</span><br><span class="line">        <span class="keyword">case</span> <span class="literal">nil</span>:</span><br><span class="line">            formatted = <span class="string">&quot;NULL&quot;</span></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            formatted = fmt.Sprintf(<span class="string">&quot;%v&quot;</span>, v)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 替换 &quot;?&quot;</span></span><br><span class="line">        result = result[:idx] + formatted + result[idx+<span class="number">1</span>:]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 字符串转义</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">escapeString</span><span class="params">(s <span class="type">string</span>)</span></span> <span class="type">string</span> &#123;</span><br><span class="line">    s = strings.ReplaceAll(s, <span class="string">&quot;&#x27;&quot;</span>, <span class="string">&quot;&#x27;&#x27;&quot;</span>)</span><br><span class="line">    s = strings.ReplaceAll(s, <span class="string">&quot;\\&quot;</span>, <span class="string">&quot;\\\\&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Dialector.Explain 方法</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Dialector 接口</span></span><br><span class="line"><span class="keyword">type</span> Dialector <span class="keyword">interface</span> &#123;</span><br><span class="line">    Explain(sql <span class="type">string</span>, vars ...<span class="keyword">interface</span>&#123;&#125;) <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// MySQL 实现</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d MySQL)</span></span> Explain(sql <span class="type">string</span>, vars ...<span class="keyword">interface</span>&#123;&#125;) <span class="type">string</span> &#123;</span><br><span class="line">    <span class="comment">// MySQL 特定的参数占位符</span></span><br><span class="line">    <span class="keyword">return</span> d.ExplainSQL(sql, vars...)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PostgreSQL 实现</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d Postgres)</span></span> Explain(sql <span class="type">string</span>, vars ...<span class="keyword">interface</span>&#123;&#125;) <span class="type">string</span> &#123;</span><br><span class="line">    <span class="comment">// PostgreSQL 使用 $1, $2 作为占位符</span></span><br><span class="line">    <span class="keyword">return</span> d.ExplainSQL(sql, vars...)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SQLite 实现</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d SQLite)</span></span> Explain(sql <span class="type">string</span>, vars ...<span class="keyword">interface</span>&#123;&#125;) <span class="type">string</span> &#123;</span><br><span class="line">    <span class="comment">// SQLite 使用 ? 或 $1, $2 作为占位符</span></span><br><span class="line">    <span class="keyword">return</span> d.ExplainSQL(sql, vars...)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>敏感参数过滤</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ParamsFilter 接口</span></span><br><span class="line"><span class="keyword">type</span> ParamsFilter <span class="keyword">interface</span> &#123;</span><br><span class="line">    ParamsFilter(ctx context.Context, sql <span class="type">string</span>, params ...<span class="keyword">interface</span>&#123;&#125;) (<span class="type">string</span>, []<span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实现: 过滤密码字段</span></span><br><span class="line"><span class="keyword">type</span> SensitiveParamsFilter <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f SensitiveParamsFilter)</span></span> ParamsFilter(ctx context.Context, sql <span class="type">string</span>, params ...<span class="keyword">interface</span>&#123;&#125;) (<span class="type">string</span>, []<span class="keyword">interface</span>&#123;&#125;) &#123;</span><br><span class="line">    <span class="comment">// 检测是否是 INSERT/UPDATE 语句</span></span><br><span class="line">    <span class="keyword">if</span> strings.Contains(strings.ToUpper(sql), <span class="string">&quot;INSERT&quot;</span>) || strings.Contains(strings.ToUpper(sql), <span class="string">&quot;UPDATE&quot;</span>) &#123;</span><br><span class="line">        <span class="comment">// 过滤密码参数</span></span><br><span class="line">        <span class="keyword">for</span> i, param := <span class="keyword">range</span> params &#123;</span><br><span class="line">            <span class="keyword">if</span> s, ok := param.(<span class="type">string</span>); ok &amp;&amp; strings.Contains(strings.ToLower(s), <span class="string">&quot;password&quot;</span>) &#123;</span><br><span class="line">                params[i] = <span class="string">&quot;***FILTERED***&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sql, params</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用</span></span><br><span class="line">db, _ := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;</span><br><span class="line">    Logger: logger.Default.LogMode(logger.Info),</span><br><span class="line">&#125;)</span><br><span class="line">db.Use(&amp;SensitiveParamsFilter&#123;&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出:</span></span><br><span class="line"><span class="comment">// INSERT INTO users (name, password) VALUES (&#x27;John&#x27;, &#x27;***FILTERED***&#x27;)</span></span><br></pre></td></tr></table></figure>

<h4 id="概念-5-调用栈追踪"><a href="#概念-5-调用栈追踪" class="headerlink" title="概念 5: 调用栈追踪"></a>概念 5: 调用栈追踪</h4><p><strong>定义</strong>: 调用栈追踪记录 SQL 执行的代码位置。</p>
<p><strong>实现原理</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FileWithLineNum 获取调用文件和行号</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">FileWithLineNum</span><span class="params">()</span></span> <span class="type">string</span> &#123;</span><br><span class="line">    <span class="comment">// === 遍历调用栈 ===</span></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">2</span>; i &lt; <span class="number">15</span>; i++ &#123;</span><br><span class="line">        _, file, line, ok := runtime.Caller(i)</span><br><span class="line">        <span class="keyword">if</span> !ok &#123;</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// === 过滤 GORM 内部调用 ===</span></span><br><span class="line">        <span class="comment">// 过滤条件:</span></span><br><span class="line">        <span class="comment">// 1. 不包含 &quot;/gorm/&quot; 路径</span></span><br><span class="line">        <span class="comment">// 2. 不是测试文件</span></span><br><span class="line">        <span class="comment">// 3. 不是 runtime 主函数</span></span><br><span class="line">        <span class="keyword">if</span> strings.Contains(file, <span class="string">&quot;/gorm/&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// === 返回第一个非 GORM 调用 ===</span></span><br><span class="line">        <span class="keyword">return</span> fmt.Sprintf(<span class="string">&quot;%v:%v&quot;</span>, file, line)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>调用栈示例</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 用户代码</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    db.Find(&amp;users)  <span class="comment">// ← 记录 main.go:45</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GORM 内部调用链:</span></span><br><span class="line"><span class="comment">// main.go:45 (main.main)</span></span><br><span class="line"><span class="comment">//   ↓</span></span><br><span class="line"><span class="comment">// gorm.go:123 (DB.Find)</span></span><br><span class="line"><span class="comment">//   ↓</span></span><br><span class="line"><span class="comment">// finisher_api.go:234 (DB.Find)</span></span><br><span class="line"><span class="comment">//   ↓</span></span><br><span class="line"><span class="comment">// callbacks.go:56 (processor.Execute)</span></span><br><span class="line"><span class="comment">//   ↓</span></span><br><span class="line"><span class="comment">// query.go:78 (Query)</span></span><br><span class="line"><span class="comment">//   ↓</span></span><br><span class="line"><span class="comment">// [记录] main.go:45 (第一个非 GORM 调用)</span></span><br></pre></td></tr></table></figure>

<p><strong>配置调用栈追踪</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 启用调用栈追踪</span></span><br><span class="line">db, _ := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;</span><br><span class="line">    Logger: logger.Default.LogMode(logger.Info),</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 日志输出:</span></span><br><span class="line"><span class="comment">// [2024-01-01 10:00:00] [3.45ms] SELECT * FROM users [main.go:45]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 禁用调用栈追踪 (提高性能)</span></span><br><span class="line">db, _ := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;</span><br><span class="line">    Logger: logger.Default.LogMode(logger.Info).SkipCallerLookup(<span class="literal">true</span>),</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 日志输出:</span></span><br><span class="line"><span class="comment">// [2024-01-01 10:00:00] [3.45ms] SELECT * FROM users</span></span><br></pre></td></tr></table></figure>

<h3 id="2-2-理论基础"><a href="#2-2-理论基础" class="headerlink" title="2.2 理论基础"></a>2.2 理论基础</h3><h4 id="理论-1-结构化日志"><a href="#理论-1-结构化日志" class="headerlink" title="理论 1: 结构化日志"></a>理论 1: 结构化日志</h4><p><strong>定义</strong>: 结构化日志使用机器可读的格式（通常是 JSON）记录日志。</p>
<p><strong>传统日志 vs 结构化日志</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 传统日志 (文本格式)</span></span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-01</span> <span class="number">10</span>:<span class="number">00</span>:<span class="number">00</span>] [<span class="number">3.45</span>ms] SELECT * FROM users WHERE age &gt; <span class="number">18</span> [main.<span class="keyword">go</span>:<span class="number">45</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">// 结构化日志 (JSON 格式)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;timestamp&quot;</span>: <span class="string">&quot;2024-01-01T10:00:00Z&quot;</span>,</span><br><span class="line">  <span class="string">&quot;level&quot;</span>: <span class="string">&quot;info&quot;</span>,</span><br><span class="line">  <span class="string">&quot;duration_ms&quot;</span>: <span class="number">3.45</span>,</span><br><span class="line">  <span class="string">&quot;sql&quot;</span>: <span class="string">&quot;SELECT * FROM users WHERE age &gt; 18&quot;</span>,</span><br><span class="line">  <span class="string">&quot;rows&quot;</span>: <span class="number">10</span>,</span><br><span class="line">  <span class="string">&quot;file&quot;</span>: <span class="string">&quot;main.go:45&quot;</span>,</span><br><span class="line">  <span class="string">&quot;function&quot;</span>: <span class="string">&quot;main.main&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>结构化日志的优势</strong>:</p>
<table>
<thead>
<tr>
<th>优势</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>机器可读</td>
<td>便于日志系统解析和查询</td>
<td>jq ‘.duration_ms &gt; 10’</td>
</tr>
<tr>
<td>结构化</td>
<td>字段含义明确，便于过滤</td>
<td>level&#x3D;”error”</td>
</tr>
<tr>
<td>可扩展</td>
<td>容易添加新字段</td>
<td>添加 request_id 字段</td>
</tr>
<tr>
<td>可聚合</td>
<td>便于日志聚合分析</td>
<td>统计平均响应时间</td>
</tr>
</tbody></table>
<p><strong>实现结构化 Logger</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 结构化日志模型</span></span><br><span class="line"><span class="keyword">type</span> LogEntry <span class="keyword">struct</span> &#123;</span><br><span class="line">    Timestamp time.Time <span class="string">`json:&quot;timestamp&quot;`</span></span><br><span class="line">    Level     <span class="type">string</span>    <span class="string">`json:&quot;level&quot;`</span></span><br><span class="line">    Duration  <span class="type">float64</span>   <span class="string">`json:&quot;duration_ms&quot;`</span></span><br><span class="line">    SQL       <span class="type">string</span>    <span class="string">`json:&quot;sql&quot;`</span></span><br><span class="line">    Rows      <span class="type">int64</span>     <span class="string">`json:&quot;rows,omitempty&quot;`</span></span><br><span class="line">    File      <span class="type">string</span>    <span class="string">`json:&quot;file,omitempty&quot;`</span></span><br><span class="line">    Error     <span class="type">string</span>    <span class="string">`json:&quot;error,omitempty&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// JSON Logger</span></span><br><span class="line"><span class="keyword">type</span> JSONLogger <span class="keyword">struct</span> &#123;</span><br><span class="line">    logger.Interface</span><br><span class="line">    writer io.Writer</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *JSONLogger)</span></span> Trace(ctx context.Context, begin time.Time, fc <span class="function"><span class="keyword">func</span><span class="params">()</span></span> (<span class="type">string</span>, <span class="type">int64</span>), err <span class="type">error</span>) &#123;</span><br><span class="line">    elapsed := time.Since(begin)</span><br><span class="line">    sql, rows := fc()</span><br><span class="line"></span><br><span class="line">    entry := LogEntry&#123;</span><br><span class="line">        Timestamp: time.Now(),</span><br><span class="line">        Level:     <span class="string">&quot;info&quot;</span>,</span><br><span class="line">        Duration:  <span class="type">float64</span>(elapsed.Milliseconds()),</span><br><span class="line">        SQL:       sql,</span><br><span class="line">        Rows:      rows,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        entry.Level = <span class="string">&quot;error&quot;</span></span><br><span class="line">        entry.Error = err.Error()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// JSON 编码并输出</span></span><br><span class="line">    json.NewEncoder(l.writer).Encode(entry)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="理论-2-慢查询检测"><a href="#理论-2-慢查询检测" class="headerlink" title="理论 2: 慢查询检测"></a>理论 2: 慢查询检测</h4><p><strong>定义</strong>: 慢查询检测记录执行时间超过阈值的 SQL。</p>
<p><strong>慢查询阈值配置</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 方式 1: 全局配置</span></span><br><span class="line">db, _ := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;</span><br><span class="line">    Logger: logger.Default.LogMode(logger.Warn),</span><br><span class="line">    SlowThreshold: <span class="number">200</span> * time.Millisecond,  <span class="comment">// 200ms</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方式 2: 动态配置</span></span><br><span class="line">db = db.Session(&amp;gorm.Session&#123;</span><br><span class="line">    Logger: logger.Default.LogMode(logger.Warn).SlowThreshold(<span class="number">200</span> * time.Millisecond),</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方式 3: 全局变量设置</span></span><br><span class="line">logger.Default.SlowThreshold = <span class="number">200</span> * time.Millisecond</span><br></pre></td></tr></table></figure>

<p><strong>慢查询日志输出</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// 慢查询输出格式</span><br><span class="line">[2024-01-01 10:00:00] [250.45ms] SLOW SQL &gt;= 200ms</span><br><span class="line">[250.45ms] [rows:1000] SELECT * FROM large_table JOIN another_table ON large_table.id = another_table.table_id WHERE large_table.created_at &gt; &#x27;2024-01-01&#x27;</span><br></pre></td></tr></table></figure>

<p><strong>慢查询分析策略</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">慢查询优化流程:</span><br><span class="line"></span><br><span class="line">1. 识别慢查询</span><br><span class="line">   ├─ 设置合理阈值 (如 200ms)</span><br><span class="line">   ├─ 记录慢查询日志</span><br><span class="line">   └─ 分析日志找出高频慢查询</span><br><span class="line"></span><br><span class="line">2. 分析执行计划</span><br><span class="line">   ├─ 使用 EXPLAIN 分析 SQL</span><br><span class="line">   ├─ 检查是否使用索引</span><br><span class="line">   └─ 检查扫描行数</span><br><span class="line"></span><br><span class="line">3. 优化 SQL</span><br><span class="line">   ├─ 添加缺失的索引</span><br><span class="line">   ├─ 重写复杂查询</span><br><span class="line">   └─ 使用预加载 (Preload) 代替循环查询</span><br><span class="line"></span><br><span class="line">4. 验证优化效果</span><br><span class="line">   ├─ 对比优化前后执行时间</span><br><span class="line">   ├─ 检查是否还有其他慢查询</span><br><span class="line">   └─ 持续监控</span><br></pre></td></tr></table></figure>

<h4 id="理论-3-日志聚合与分析"><a href="#理论-3-日志聚合与分析" class="headerlink" title="理论 3: 日志聚合与分析"></a>理论 3: 日志聚合与分析</h4><p><strong>定义</strong>: 日志聚是将分散的日志收集到中心化的日志系统。</p>
<p><strong>常用日志系统</strong>:</p>
<table>
<thead>
<tr>
<th>日志系统</th>
<th>特点</th>
<th>适用场景</th>
</tr>
</thead>
<tbody><tr>
<td>ELK Stack</td>
<td>Elasticsearch + Logstash + Kibana</td>
<td>大规模日志分析</td>
</tr>
<tr>
<td>Grafana Loki</td>
<td>轻量级、成本效益高</td>
<td>Kubernetes 环境</td>
</tr>
<tr>
<td>Fluentd</td>
<td>统一日志层</td>
<td>多语言环境</td>
</tr>
<tr>
<td>Sentry</td>
<td>错误追踪</td>
<td>错误监控</td>
</tr>
</tbody></table>
<p><strong>集成示例: Fluentd</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Fluentd Logger</span></span><br><span class="line"><span class="keyword">type</span> FluentdLogger <span class="keyword">struct</span> &#123;</span><br><span class="line">    logger.Interface</span><br><span class="line">    tag   <span class="type">string</span></span><br><span class="line">    host  <span class="type">string</span></span><br><span class="line">    port  <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *FluentdLogger)</span></span> Trace(ctx context.Context, begin time.Time, fc <span class="function"><span class="keyword">func</span><span class="params">()</span></span> (<span class="type">string</span>, <span class="type">int64</span>), err <span class="type">error</span>) &#123;</span><br><span class="line">    elapsed := time.Since(begin)</span><br><span class="line">    sql, rows := fc()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发送到 Fluentd</span></span><br><span class="line">    log := <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">        <span class="string">&quot;timestamp&quot;</span>: time.Now(),</span><br><span class="line">        <span class="string">&quot;sql&quot;</span>:       sql,</span><br><span class="line">        <span class="string">&quot;duration&quot;</span>:  elapsed.Milliseconds(),</span><br><span class="line">        <span class="string">&quot;rows&quot;</span>:      rows,</span><br><span class="line">        <span class="string">&quot;error&quot;</span>:     err,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用 fluentd-go 发送日志</span></span><br><span class="line">    <span class="comment">// fluentd.Post(l.tag, log)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用</span></span><br><span class="line">db, _ := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;</span><br><span class="line">    Logger: &amp;FluentdLogger&#123;</span><br><span class="line">        tag:  <span class="string">&quot;gorm.sql&quot;</span>,</span><br><span class="line">        host: <span class="string">&quot;fluentd&quot;</span>,</span><br><span class="line">        port: <span class="number">24224</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="2-3-学习方法"><a href="#2-3-学习方法" class="headerlink" title="2.3 学习方法"></a>2.3 学习方法</h3><h4 id="方法-1-实验法"><a href="#方法-1-实验法" class="headerlink" title="方法 1: 实验法"></a>方法 1: 实验法</h4><p><strong>实验 1: 观察不同日志级别的输出</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Silent: 无日志</span></span><br><span class="line">db.LogMode(logger.Silent).Find(&amp;users)</span><br><span class="line"><span class="comment">// (无输出)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Error: 只记录错误</span></span><br><span class="line">db.LogMode(logger.Error).Find(&amp;users)</span><br><span class="line"><span class="comment">// (无输出，假设查询成功)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Warn: 记录慢查询</span></span><br><span class="line">db.Set(<span class="string">&quot;gorm:threshold&quot;</span>, <span class="number">1</span>*time.Millisecond).LogMode(logger.Warn).Find(&amp;users)</span><br><span class="line"><span class="comment">// 如果查询时间 &gt; 1ms，会记录</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Info: 记录所有 SQL</span></span><br><span class="line">db.LogMode(logger.Info).Find(&amp;users)</span><br><span class="line"><span class="comment">// [2024-01-01 10:00:00] [3.45ms] SELECT * FROM users</span></span><br></pre></td></tr></table></figure>

<p><strong>实验 2: 测试调用栈追踪</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetUser</span><span class="params">(id <span class="type">uint</span>)</span></span> (User, <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> user User</span><br><span class="line">    <span class="comment">// 这里会记录当前文件和行号</span></span><br><span class="line">    err := db.First(&amp;user, id).Error</span><br><span class="line">    <span class="keyword">return</span> user, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    GetUser(<span class="number">1</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 日志输出:</span></span><br><span class="line"><span class="comment">// [2024-01-01 10:00:00] [2.34ms] SELECT * FROM users WHERE id = 1 AND `users`.`deleted_at` IS NULL ORDER BY `users`.`id` LIMIT 1 [main.go:15]</span></span><br><span class="line"><span class="comment">//                                                                        ↑</span></span><br><span class="line"><span class="comment">//                                                                    调用位置</span></span><br></pre></td></tr></table></figure>

<h4 id="方法-2-对比法"><a href="#方法-2-对比法" class="headerlink" title="方法 2: 对比法"></a>方法 2: 对比法</h4><p><strong>对比不同 Logger 实现</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 默认 Logger (控制台输出)</span></span><br><span class="line">db, _ := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;</span><br><span class="line">    Logger: logger.Default.LogMode(logger.Info),</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 自定义 Logger (JSON 输出到文件)</span></span><br><span class="line"><span class="keyword">type</span> CustomLogger <span class="keyword">struct</span> &#123;</span><br><span class="line">    logger.Interface</span><br><span class="line">    file *os.File</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *CustomLogger)</span></span> Trace(ctx context.Context, begin time.Time, fc <span class="function"><span class="keyword">func</span><span class="params">()</span></span> (<span class="type">string</span>, <span class="type">int64</span>), err <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="comment">// 记录 JSON 格式到文件</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">db, _ := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;</span><br><span class="line">    Logger: &amp;CustomLogger&#123;</span><br><span class="line">        file: logFile,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="2-4-实施策略"><a href="#2-4-实施策略" class="headerlink" title="2.4 实施策略"></a>2.4 实施策略</h3><h4 id="策略-1-分层学习"><a href="#策略-1-分层学习" class="headerlink" title="策略 1: 分层学习"></a>策略 1: 分层学习</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">第 1 层: 理解基本概念 (Day 1)</span><br><span class="line">  目标: 理解日志的基本概念</span><br><span class="line">  内容:</span><br><span class="line">    - Logger 接口</span><br><span class="line">    - 日志级别</span><br><span class="line">    - Trace 方法</span><br><span class="line">  验证:</span><br><span class="line">    - 能配置日志级别</span><br><span class="line">    - 能使用默认 Logger</span><br><span class="line">    - 能查看日志输出</span><br><span class="line"></span><br><span class="line">第 2 层: 掌握高级日志 (Day 2)</span><br><span class="line">  目标: 理解日志的内部实现</span><br><span class="line">  内容:</span><br><span class="line">    - SQL 解释机制</span><br><span class="line">    - 慢查询检测</span><br><span class="line">    - 调用栈追踪</span><br><span class="line">  验证:</span><br><span class="line">    - 能理解 Trace 实现</span><br><span class="line">    - 能配置慢查询阈值</span><br><span class="line">    - 能追踪调用位置</span><br><span class="line"></span><br><span class="line">第 3 层: 应用扩展 (Day 3)</span><br><span class="line">  目标: 掌握自定义 Logger 实现</span><br><span class="line">  内容:</span><br><span class="line">    - 自定义 Logger</span><br><span class="line">    - 集成日志库</span><br><span class="line">    - 日志聚合分析</span><br><span class="line">  验证:</span><br><span class="line">    - 能实现自定义 Logger</span><br><span class="line">    - 能集成第三方日志库</span><br><span class="line">    - 能设计日志策略</span><br></pre></td></tr></table></figure>

<h4 id="策略-2-场景驱动"><a href="#策略-2-场景驱动" class="headerlink" title="策略 2: 场景驱动"></a>策略 2: 场景驱动</h4><p><strong>场景序列</strong>:</p>
<ol>
<li><p><strong>开发调试</strong></p>
<ul>
<li>使用 Info 级别</li>
<li>记录所有 SQL</li>
<li>启用调用栈追踪</li>
</ul>
</li>
<li><p><strong>性能分析</strong></p>
<ul>
<li>配置慢查询阈值</li>
<li>记录执行时间</li>
<li>分析慢查询</li>
</ul>
</li>
<li><p><strong>生产监控</strong></p>
<ul>
<li>使用 Error 级别</li>
<li>集成日志系统</li>
<li>设置告警规则</li>
</ul>
</li>
</ol>
<hr>
<h2 id="六、实战代码示例"><a href="#六、实战代码示例" class="headerlink" title="六、实战代码示例"></a>六、实战代码示例</h2><h3 id="6-1-基础配置示例"><a href="#6-1-基础配置示例" class="headerlink" title="6.1 基础配置示例"></a>6.1 基础配置示例</h3><h4 id="开发环境配置"><a href="#开发环境配置" class="headerlink" title="开发环境配置"></a>开发环境配置</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;gorm.io/gorm&quot;</span></span><br><span class="line">	<span class="string">&quot;gorm.io/driver/mysql&quot;</span></span><br><span class="line">	<span class="string">&quot;gorm.io/gorm/logger&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">	<span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	dsn := <span class="string">&quot;user:password@tcp(127.0.0.1:3306)/dbname?charset=utf8mb4&amp;parseTime=True&amp;loc=Local&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 开发环境配置</span></span><br><span class="line">	db, err := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;</span><br><span class="line">		Logger: logger.New(log.New(os.Stdout, <span class="string">&quot;\r\n&quot;</span>, log.LstdFlags), logger.Config&#123;</span><br><span class="line">			SlowThreshold:             time.Second,      <span class="comment">// 1 秒</span></span><br><span class="line">			LogLevel:                  logger.Info,       <span class="comment">// 记录所有 SQL</span></span><br><span class="line">			Colorful:                  <span class="literal">true</span>,            <span class="comment">// 彩色输出</span></span><br><span class="line">			IgnoreRecordNotFoundError: <span class="literal">true</span>,            <span class="comment">// 忽略未找到</span></span><br><span class="line">		&#125;),</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(<span class="string">&quot;连接数据库失败&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 使用数据库</span></span><br><span class="line">	<span class="keyword">var</span> users []User</span><br><span class="line">	db.Find(&amp;users)</span><br><span class="line">	<span class="comment">// 输出: [32mmain.go:45</span></span><br><span class="line">[<span class="number">0</span>m [<span class="number">32</span>m[info] [<span class="number">0</span>m [<span class="number">32</span>m2024<span class="number">-01</span><span class="number">-01</span> <span class="number">10</span>:<span class="number">00</span>:<span class="number">00</span></span><br><span class="line">[<span class="number">0</span>m [<span class="number">33</span>m[<span class="number">3.45</span>ms] [<span class="number">34</span>;<span class="number">1</span>m[rows:<span class="number">10</span>][<span class="number">0</span>m SELECT * FROM <span class="string">`users`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="生产环境配置"><a href="#生产环境配置" class="headerlink" title="生产环境配置"></a>生产环境配置</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 生产环境配置</span></span><br><span class="line">db, err := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;</span><br><span class="line">	Logger: logger.New(log.New(os.Stdout, <span class="string">&quot;\r\n&quot;</span>, log.LstdFlags), logger.Config&#123;</span><br><span class="line">		SlowThreshold:             <span class="number">500</span> * time.Millisecond,  <span class="comment">// 500ms</span></span><br><span class="line">		LogLevel:                  logger.Warn,              <span class="comment">// 错误和慢查询</span></span><br><span class="line">		Colorful:                  <span class="literal">false</span>,                   <span class="comment">// 禁用彩色</span></span><br><span class="line">		ParameterizedQueries:      <span class="literal">true</span>,                   <span class="comment">// 参数化 SQL</span></span><br><span class="line">		IgnoreRecordNotFoundError: <span class="literal">true</span>,                   <span class="comment">// 忽略未找到</span></span><br><span class="line">	&#125;),</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="测试环境配置"><a href="#测试环境配置" class="headerlink" title="测试环境配置"></a>测试环境配置</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 测试环境配置</span></span><br><span class="line">db, err := gorm.Open(mysql.Open(<span class="string">&quot;test.db&quot;</span>), &amp;gorm.Config&#123;</span><br><span class="line">	Logger: logger.New(log.New(os.Stdout, <span class="string">&quot;\r\n&quot;</span>, log.LstdFlags), logger.Config&#123;</span><br><span class="line">		SlowThreshold:             <span class="number">100</span> * time.Millisecond,  <span class="comment">// 100ms</span></span><br><span class="line">		LogLevel:                  logger.Info,              <span class="comment">// 详细日志</span></span><br><span class="line">		Colorful:                  <span class="literal">false</span>,                   <span class="comment">// 禁用彩色</span></span><br><span class="line">		IgnoreRecordNotFoundError: <span class="literal">false</span>,                  <span class="comment">// 不忽略错误</span></span><br><span class="line">	&#125;),</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="6-2-自定义-Logger-示例"><a href="#6-2-自定义-Logger-示例" class="headerlink" title="6.2 自定义 Logger 示例"></a>6.2 自定义 Logger 示例</h3><h4 id="文件-Logger"><a href="#文件-Logger" class="headerlink" title="文件 Logger"></a>文件 Logger</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 文件 Logger：将日志写入文件</span></span><br><span class="line"><span class="keyword">type</span> FileLogger <span class="keyword">struct</span> &#123;</span><br><span class="line">	logger.Interface</span><br><span class="line">	file *os.File</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewFileLogger</span><span class="params">(filename <span class="type">string</span>)</span></span> logger.Interface &#123;</span><br><span class="line">	file, err := os.OpenFile(filename, os.O_CREATE|os.O_WRONLY|os.O_APPEND, <span class="number">0644</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> &amp;FileLogger&#123;</span><br><span class="line">		Interface: logger.Default,</span><br><span class="line">		file:      file,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *FileLogger)</span></span> Trace(ctx context.Context, begin time.Time, fc <span class="function"><span class="keyword">func</span><span class="params">()</span></span> (<span class="type">string</span>, <span class="type">int64</span>), err <span class="type">error</span>) &#123;</span><br><span class="line">	elapsed := time.Since(begin)</span><br><span class="line">	sql, rows := fc()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 写入文件</span></span><br><span class="line">	logEntry := fmt.Sprintf(<span class="string">&quot;[%s] [%.3fms] [rows:%v] %s\n&quot;</span>,</span><br><span class="line">		time.Now().Format(<span class="string">&quot;2006-01-02 15:04:05&quot;</span>),</span><br><span class="line">		<span class="type">float64</span>(elapsed.Nanoseconds())/<span class="number">1e6</span>,</span><br><span class="line">		rows,</span><br><span class="line">		sql,</span><br><span class="line">	)</span><br><span class="line">	l.file.WriteString(logEntry)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用</span></span><br><span class="line">db, _ := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;</span><br><span class="line">	Logger: NewFileLogger(<span class="string">&quot;gorm.log&quot;</span>),</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="JSON-Logger"><a href="#JSON-Logger" class="headerlink" title="JSON Logger"></a>JSON Logger</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// JSON Logger：输出 JSON 格式日志</span></span><br><span class="line"><span class="keyword">type</span> JSONLogger <span class="keyword">struct</span> &#123;</span><br><span class="line">	logger.Interface</span><br><span class="line">	writer io.Writer</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> LogEntry <span class="keyword">struct</span> &#123;</span><br><span class="line">	Timestamp <span class="type">string</span>  <span class="string">`json:&quot;timestamp&quot;`</span></span><br><span class="line">	Level     <span class="type">string</span>  <span class="string">`json:&quot;level&quot;`</span></span><br><span class="line">	Duration  <span class="type">float64</span> <span class="string">`json:&quot;duration_ms&quot;`</span></span><br><span class="line">	SQL       <span class="type">string</span>  <span class="string">`json:&quot;sql&quot;`</span></span><br><span class="line">	Rows      <span class="type">int64</span>   <span class="string">`json:&quot;rows,omitempty&quot;`</span></span><br><span class="line">	Error     <span class="type">string</span>  <span class="string">`json:&quot;error,omitempty&quot;`</span></span><br><span class="line">	File      <span class="type">string</span>  <span class="string">`json:&quot;file,omitempty&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewJSONLogger</span><span class="params">(writer io.Writer)</span></span> logger.Interface &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;JSONLogger&#123;</span><br><span class="line">		Interface: logger.Discard, <span class="comment">// 不使用默认 logger</span></span><br><span class="line">		writer:    writer,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *JSONLogger)</span></span> Trace(ctx context.Context, begin time.Time, fc <span class="function"><span class="keyword">func</span><span class="params">()</span></span> (<span class="type">string</span>, <span class="type">int64</span>), err <span class="type">error</span>) &#123;</span><br><span class="line">	elapsed := time.Since(begin)</span><br><span class="line">	sql, rows := fc()</span><br><span class="line"></span><br><span class="line">	entry := LogEntry&#123;</span><br><span class="line">		Timestamp: time.Now().Format(time.RFC3339),</span><br><span class="line">		Level:     <span class="string">&quot;info&quot;</span>,</span><br><span class="line">		Duration:  <span class="type">float64</span>(elapsed.Nanoseconds()) / <span class="number">1e6</span>,</span><br><span class="line">		SQL:       sql,</span><br><span class="line">		Rows:      rows,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		entry.Level = <span class="string">&quot;error&quot;</span></span><br><span class="line">		entry.Error = err.Error()</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// JSON 编码并输出</span></span><br><span class="line">	json.NewEncoder(l.writer).Encode(entry)</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用</span></span><br><span class="line">db, _ := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;</span><br><span class="line">	Logger: NewJSONLogger(os.Stdout),</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="结构化-Logger（集成-zap）"><a href="#结构化-Logger（集成-zap）" class="headerlink" title="结构化 Logger（集成 zap）"></a>结构化 Logger（集成 zap）</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;go.uber.org/zap&quot;</span></span><br><span class="line">	<span class="string">&quot;go.uber.org/zap/zapcore&quot;</span></span><br><span class="line">	<span class="string">&quot;gorm.io/gorm/logger&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ZapLogger：集成 uber-go/zap</span></span><br><span class="line"><span class="keyword">type</span> ZapLogger <span class="keyword">struct</span> &#123;</span><br><span class="line">	logger.Interface</span><br><span class="line">	logger *zap.Logger</span><br><span class="line">	sugar  *zap.SugaredLogger</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewZapLogger</span><span class="params">(logLevel zapcore.Level)</span></span> logger.Interface &#123;</span><br><span class="line">	zapLogger, _ := zap.NewProduction()</span><br><span class="line">	<span class="keyword">if</span> logLevel == zapcore.DebugLevel &#123;</span><br><span class="line">		zapLogger, _ = zap.NewDevelopment()</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> &amp;ZapLogger&#123;</span><br><span class="line">		Interface: logger.Discard,</span><br><span class="line">		logger:    zapLogger,</span><br><span class="line">		sugar:     zapLogger.Sugar(),</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *ZapLogger)</span></span> Trace(ctx context.Context, begin time.Time, fc <span class="function"><span class="keyword">func</span><span class="params">()</span></span> (<span class="type">string</span>, <span class="type">int64</span>), err <span class="type">error</span>) &#123;</span><br><span class="line">	elapsed := time.Since(begin)</span><br><span class="line">	sql, rows := fc()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		l.sugar.Errorw(<span class="string">&quot;SQL Error&quot;</span>,</span><br><span class="line">			<span class="string">&quot;duration&quot;</span>, elapsed,</span><br><span class="line">			<span class="string">&quot;sql&quot;</span>, sql,</span><br><span class="line">			<span class="string">&quot;rows&quot;</span>, rows,</span><br><span class="line">			<span class="string">&quot;error&quot;</span>, err,</span><br><span class="line">		)</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> elapsed &gt; <span class="number">200</span>*time.Millisecond &#123;</span><br><span class="line">		l.sugar.Warnw(<span class="string">&quot;Slow SQL&quot;</span>,</span><br><span class="line">			<span class="string">&quot;duration&quot;</span>, elapsed,</span><br><span class="line">			<span class="string">&quot;sql&quot;</span>, sql,</span><br><span class="line">			<span class="string">&quot;rows&quot;</span>, rows,</span><br><span class="line">		)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		l.sugar.Debugw(<span class="string">&quot;SQL&quot;</span>,</span><br><span class="line">			<span class="string">&quot;duration&quot;</span>, elapsed,</span><br><span class="line">			<span class="string">&quot;sql&quot;</span>, sql,</span><br><span class="line">			<span class="string">&quot;rows&quot;</span>, rows,</span><br><span class="line">		)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用</span></span><br><span class="line">db, _ := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;</span><br><span class="line">	Logger: NewZapLogger(zapcore.InfoLevel),</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="6-3-慢查询检测示例"><a href="#6-3-慢查询检测示例" class="headerlink" title="6.3 慢查询检测示例"></a>6.3 慢查询检测示例</h3><h4 id="基础配置"><a href="#基础配置" class="headerlink" title="基础配置"></a>基础配置</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 配置慢查询阈值</span></span><br><span class="line">db, _ := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;</span><br><span class="line">	Logger: logger.New(log.New(os.Stdout, <span class="string">&quot;\r\n&quot;</span>, log.LstdFlags), logger.Config&#123;</span><br><span class="line">		SlowThreshold: <span class="number">200</span> * time.Millisecond,  <span class="comment">// 200ms</span></span><br><span class="line">		LogLevel:      logger.Warn,              <span class="comment">// 记录慢查询</span></span><br><span class="line">	&#125;),</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行查询</span></span><br><span class="line"><span class="keyword">var</span> users []User</span><br><span class="line">db.Find(&amp;users)  <span class="comment">// 如果耗时 &gt; 200ms，会记录为慢查询</span></span><br></pre></td></tr></table></figure>

<h4 id="动态配置"><a href="#动态配置" class="headerlink" title="动态配置"></a>动态配置</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 动态设置慢查询阈值</span></span><br><span class="line">db = db.Session(&amp;gorm.Session&#123;</span><br><span class="line">	Logger: logger.Default.LogMode(logger.Warn).SlowThreshold(<span class="number">200</span> * time.Millisecond),</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 或者直接修改</span></span><br><span class="line">logger.Default.SlowThreshold = <span class="number">200</span> * time.Millisecond</span><br></pre></td></tr></table></figure>

<h4 id="告警集成"><a href="#告警集成" class="headerlink" title="告警集成"></a>告警集成</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 慢查询告警 Logger</span></span><br><span class="line"><span class="keyword">type</span> AlertLogger <span class="keyword">struct</span> &#123;</span><br><span class="line">	logger.Interface</span><br><span class="line">	webhookURL <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *AlertLogger)</span></span> Trace(ctx context.Context, begin time.Time, fc <span class="function"><span class="keyword">func</span><span class="params">()</span></span> (<span class="type">string</span>, <span class="type">int64</span>), err <span class="type">error</span>) &#123;</span><br><span class="line">	elapsed := time.Since(begin)</span><br><span class="line">	sql, rows := fc()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 检查是否是慢查询</span></span><br><span class="line">	<span class="keyword">if</span> elapsed &gt; <span class="number">200</span>*time.Millisecond &#123;</span><br><span class="line">		<span class="comment">// 发送告警</span></span><br><span class="line">		alert := <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">			<span class="string">&quot;timestamp&quot;</span>: time.Now(),</span><br><span class="line">			<span class="string">&quot;duration&quot;</span>:  elapsed.Milliseconds(),</span><br><span class="line">			<span class="string">&quot;sql&quot;</span>:       sql,</span><br><span class="line">			<span class="string">&quot;rows&quot;</span>:      rows,</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 发送到 webhook</span></span><br><span class="line">		http.Post(l.webhookURL, <span class="string">&quot;application/json&quot;</span>, jsonBody(alert))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 调用原始 logger</span></span><br><span class="line">	<span class="keyword">return</span> l.Interface.Trace(ctx, begin, fc, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用</span></span><br><span class="line">db, _ := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;</span><br><span class="line">	Logger: &amp;AlertLogger&#123;</span><br><span class="line">		Interface:  logger.Default.LogMode(logger.Warn),</span><br><span class="line">		webhookURL: <span class="string">&quot;https://hooks.slack.com/...&quot;</span>,</span><br><span class="line">	&#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="6-4-日志集成示例"><a href="#6-4-日志集成示例" class="headerlink" title="6.4 日志集成示例"></a>6.4 日志集成示例</h3><h4 id="集成-logrus"><a href="#集成-logrus" class="headerlink" title="集成 logrus"></a>集成 logrus</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;github.com/sirupsen/logrus&quot;</span></span><br><span class="line">	<span class="string">&quot;gorm.io/gorm/logger&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// LogrusLogger</span></span><br><span class="line"><span class="keyword">type</span> LogrusLogger <span class="keyword">struct</span> &#123;</span><br><span class="line">	logger.Interface</span><br><span class="line">	logger *logrus.Logger</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewLogrusLogger</span><span class="params">(logrusLogger *logrus.Logger)</span></span> logger.Interface &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;LogrusLogger&#123;</span><br><span class="line">		Interface: logger.Discard,</span><br><span class="line">		logger:    logrusLogger,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *LogrusLogger)</span></span> Trace(ctx context.Context, begin time.Time, fc <span class="function"><span class="keyword">func</span><span class="params">()</span></span> (<span class="type">string</span>, <span class="type">int64</span>), err <span class="type">error</span>) &#123;</span><br><span class="line">	elapsed := time.Since(begin)</span><br><span class="line">	sql, rows := fc()</span><br><span class="line"></span><br><span class="line">	fields := logrus.Fields&#123;</span><br><span class="line">		<span class="string">&quot;duration&quot;</span>: elapsed,</span><br><span class="line">		<span class="string">&quot;sql&quot;</span>:      sql,</span><br><span class="line">		<span class="string">&quot;rows&quot;</span>:     rows,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		l.logger.WithFields(fields).WithError(err).Error(<span class="string">&quot;SQL Error&quot;</span>)</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> elapsed &gt; <span class="number">200</span>*time.Millisecond &#123;</span><br><span class="line">		l.logger.WithFields(fields).Warn(<span class="string">&quot;Slow SQL&quot;</span>)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		l.logger.WithFields(fields).Debug(<span class="string">&quot;SQL&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用</span></span><br><span class="line">logrusLogger := logrus.New()</span><br><span class="line">logrusLogger.SetFormatter(&amp;logrus.JSONFormatter&#123;&#125;)</span><br><span class="line"></span><br><span class="line">db, _ := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;</span><br><span class="line">	Logger: NewLogrusLogger(logrusLogger),</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="集成-fluentd"><a href="#集成-fluentd" class="headerlink" title="集成 fluentd"></a>集成 fluentd</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FluentdLogger：发送日志到 fluentd</span></span><br><span class="line"><span class="keyword">type</span> FluentdLogger <span class="keyword">struct</span> &#123;</span><br><span class="line">	logger.Interface</span><br><span class="line">	tag  <span class="type">string</span></span><br><span class="line">	host <span class="type">string</span></span><br><span class="line">	port <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *FluentdLogger)</span></span> Trace(ctx context.Context, begin time.Time, fc <span class="function"><span class="keyword">func</span><span class="params">()</span></span> (<span class="type">string</span>, <span class="type">int64</span>), err <span class="type">error</span>) &#123;</span><br><span class="line">	elapsed := time.Since(begin)</span><br><span class="line">	sql, rows := fc()</span><br><span class="line"></span><br><span class="line">	logData := <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">		<span class="string">&quot;timestamp&quot;</span>: time.Now(),</span><br><span class="line">		<span class="string">&quot;duration&quot;</span>:  elapsed.Milliseconds(),</span><br><span class="line">		<span class="string">&quot;sql&quot;</span>:       sql,</span><br><span class="line">		<span class="string">&quot;rows&quot;</span>:      rows,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		logData[<span class="string">&quot;level&quot;</span>] = <span class="string">&quot;error&quot;</span></span><br><span class="line">		logData[<span class="string">&quot;error&quot;</span>] = err.Error()</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 发送到 fluentd (使用 fluentd-go)</span></span><br><span class="line">	<span class="comment">// fluentd.Post(l.tag, logData)</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用</span></span><br><span class="line">db, _ := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;</span><br><span class="line">	Logger: &amp;FluentdLogger&#123;</span><br><span class="line">		Interface: logger.Default.LogMode(logger.Info),</span><br><span class="line">		tag:       <span class="string">&quot;gorm.sql&quot;</span>,</span><br><span class="line">		host:      <span class="string">&quot;fluentd&quot;</span>,</span><br><span class="line">		port:      <span class="number">24224</span>,</span><br><span class="line">	&#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="6-5-Recorder-使用示例"><a href="#6-5-Recorder-使用示例" class="headerlink" title="6.5 Recorder 使用示例"></a>6.5 Recorder 使用示例</h3><h4 id="SQL-记录"><a href="#SQL-记录" class="headerlink" title="SQL 记录"></a>SQL 记录</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用 Recorder 记录 SQL</span></span><br><span class="line">recorder := logger.Recorder.New()</span><br><span class="line">db, _ := gorm.Open(sqlite.Open(<span class="string">&quot;test.db&quot;</span>), &amp;gorm.Config&#123;</span><br><span class="line">	Logger: recorder,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行查询</span></span><br><span class="line"><span class="keyword">var</span> user User</span><br><span class="line">db.First(&amp;user, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取记录的 SQL</span></span><br><span class="line">fmt.Println(<span class="string">&quot;SQL:&quot;</span>, recorder.SQL)</span><br><span class="line">fmt.Println(<span class="string">&quot;Rows:&quot;</span>, recorder.RowsAffected)</span><br><span class="line">fmt.Println(<span class="string">&quot;Error:&quot;</span>, recorder.Err)</span><br><span class="line">fmt.Println(<span class="string">&quot;Duration:&quot;</span>, time.Since(recorder.BeginAt))</span><br></pre></td></tr></table></figure>

<h4 id="单元测试"><a href="#单元测试" class="headerlink" title="单元测试"></a>单元测试</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestUserQuery</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">	<span class="comment">// 使用 Recorder</span></span><br><span class="line">	recorder := logger.Recorder.New()</span><br><span class="line">	db, _ := gorm.Open(sqlite.Open(<span class="string">&quot;:memory:&quot;</span>), &amp;gorm.Config&#123;</span><br><span class="line">		Logger: recorder,</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 自动迁移</span></span><br><span class="line">	db.AutoMigrate(&amp;User&#123;&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 执行查询</span></span><br><span class="line">	<span class="keyword">var</span> user User</span><br><span class="line">	db.First(&amp;user, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 验证 SQL</span></span><br><span class="line">	assert.Equal(t, <span class="string">&quot;SELECT * FROM `users` WHERE `users`.`id` = ? ORDER BY `users`.`id` LIMIT 1&quot;</span>, recorder.SQL)</span><br><span class="line">	assert.Equal(t, <span class="type">int64</span>(<span class="number">1</span>), recorder.RowsAffected)</span><br><span class="line">	assert.Nil(t, recorder.Err)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="SQL-审计"><a href="#SQL-审计" class="headerlink" title="SQL 审计"></a>SQL 审计</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SQL 审计 Logger</span></span><br><span class="line"><span class="keyword">type</span> AuditLogger <span class="keyword">struct</span> &#123;</span><br><span class="line">	logger.Interface</span><br><span class="line">	auditLog []SQLAudit</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> SQLAudit <span class="keyword">struct</span> &#123;</span><br><span class="line">	Timestamp time.Time</span><br><span class="line">	SQL       <span class="type">string</span></span><br><span class="line">	Rows      <span class="type">int64</span></span><br><span class="line">	Duration  time.Duration</span><br><span class="line">	User      <span class="type">string</span> <span class="comment">// 来自 context</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *AuditLogger)</span></span> Trace(ctx context.Context, begin time.Time, fc <span class="function"><span class="keyword">func</span><span class="params">()</span></span> (<span class="type">string</span>, <span class="type">int64</span>), err <span class="type">error</span>) &#123;</span><br><span class="line">	elapsed := time.Since(begin)</span><br><span class="line">	sql, rows := fc()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 记录审计日志</span></span><br><span class="line">	audit := SQLAudit&#123;</span><br><span class="line">		Timestamp: time.Now(),</span><br><span class="line">		SQL:       sql,</span><br><span class="line">		Rows:      rows,</span><br><span class="line">		Duration:  elapsed,</span><br><span class="line">	&#125;</span><br><span class="line">	l.auditLog = <span class="built_in">append</span>(l.auditLog, audit)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 调用原始 logger</span></span><br><span class="line">	<span class="keyword">return</span> l.Interface.Trace(ctx, begin, fc, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *AuditLogger)</span></span> GetAuditLog() []SQLAudit &#123;</span><br><span class="line">	<span class="keyword">return</span> l.auditLog</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用</span></span><br><span class="line">auditLogger := &amp;AuditLogger&#123;</span><br><span class="line">	Interface: logger.Default.LogMode(logger.Silent),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">db, _ := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;</span><br><span class="line">	Logger: auditLogger,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行操作</span></span><br><span class="line">db.Create(&amp;User&#123;Name: <span class="string">&quot;John&quot;</span>&#125;)</span><br><span class="line">db.Find(&amp;users)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取审计日志</span></span><br><span class="line">audits := auditLogger.GetAuditLog()</span><br><span class="line"><span class="keyword">for</span> _, audit := <span class="keyword">range</span> audits &#123;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;SQL: %s, Duration: %v\n&quot;</span>, audit.SQL, audit.Duration)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="七、可视化流程图"><a href="#七、可视化流程图" class="headerlink" title="七、可视化流程图"></a>七、可视化流程图</h2><h3 id="7-1-Trace-完整执行流程图"><a href="#7-1-Trace-完整执行流程图" class="headerlink" title="7.1 Trace() 完整执行流程图"></a>7.1 Trace() 完整执行流程图</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">Trace(ctx, begin, fc, err)</span><br><span class="line">        │</span><br><span class="line">        ▼</span><br><span class="line">┌───────────────────────────┐</span><br><span class="line">│ 检查日志级别               │</span><br><span class="line">│ LogLevel &lt;= Silent?       │</span><br><span class="line">└──────┬────────────────────┘</span><br><span class="line">       │</span><br><span class="line">       ├─ Yes → return (不记录)</span><br><span class="line">       │</span><br><span class="line">       ▼ No</span><br><span class="line">┌───────────────────────────┐</span><br><span class="line">│ 计算执行耗时               │</span><br><span class="line">│ elapsed = time.Since      │</span><br><span class="line">└──────┬────────────────────┘</span><br><span class="line">       │</span><br><span class="line">       ▼</span><br><span class="line">┌───────────────────────────┐</span><br><span class="line">│ 判断记录条件               │</span><br><span class="line">└──────┬────────────────────┘</span><br><span class="line">       │</span><br><span class="line">       ├─► err != nil &amp;&amp; LogLevel &gt;= Error?</span><br><span class="line">       │   └─ Yes ──────────────┐</span><br><span class="line">       │                       │</span><br><span class="line">       │                       ▼</span><br><span class="line">       │              ┌──────────────────────┐</span><br><span class="line">       │              │ 调用 fc() 获取 SQL    │</span><br><span class="line">       │              │ Printf(traceErrStr)   │</span><br><span class="line">       │              └──────────────────────┘</span><br><span class="line">       │</span><br><span class="line">       ├─► elapsed &gt; SlowThreshold &amp;&amp; SlowThreshold != 0 &amp;&amp; LogLevel &gt;= Warn?</span><br><span class="line">       │   └─ Yes ──────────────┐</span><br><span class="line">       │                       │</span><br><span class="line">       │                       ▼</span><br><span class="line">       │              ┌──────────────────────┐</span><br><span class="line">       │              │ 调用 fc() 获取 SQL    │</span><br><span class="line">       │              │ slowLog = &quot;SLOW SQL&quot; │</span><br><span class="line">       │              │ Printf(traceWarnStr)  │</span><br><span class="line">       │              └──────────────────────┘</span><br><span class="line">       │</span><br><span class="line">       └─► LogLevel == Info?</span><br><span class="line">           └─ Yes ──────────────┐</span><br><span class="line">                                 │</span><br><span class="line">                                 ▼</span><br><span class="line">                        ┌──────────────────────┐</span><br><span class="line">                        │ 调用 fc() 获取 SQL    │</span><br><span class="line">                        │ Printf(traceStr)      │</span><br><span class="line">                        └──────────────────────┘</span><br></pre></td></tr></table></figure>

<h3 id="7-2-日志级别决策树"><a href="#7-2-日志级别决策树" class="headerlink" title="7.2 日志级别决策树"></a>7.2 日志级别决策树</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">SQL 执行完成</span><br><span class="line">    │</span><br><span class="line">    ├─► err != nil?</span><br><span class="line">    │   ├─ Yes → LogLevel &gt;= Error?</span><br><span class="line">    │   │   ├─ Yes → (err != ErrRecordNotFound OR !IgnoreRecordNotFound)?</span><br><span class="line">    │   │   │   ├─ Yes → 记录错误日志</span><br><span class="line">    │   │   │   └─ No  → 继续</span><br><span class="line">    │   │   └─ No  → 继续</span><br><span class="line">    │   │</span><br><span class="line">    ├─► elapsed &gt; SlowThreshold &amp;&amp; SlowThreshold != 0?</span><br><span class="line">    │   ├─ Yes → LogLevel &gt;= Warn?</span><br><span class="line">    │   │   ├─ Yes → 记录慢查询日志</span><br><span class="line">    │   │   └─ No  → 继续</span><br><span class="line">    │   │</span><br><span class="line">    └─► LogLevel == Info?</span><br><span class="line">        ├─ Yes → 记录所有 SQL</span><br><span class="line">        └─ No  → 不记录</span><br></pre></td></tr></table></figure>

<h3 id="7-3-日志系统架构图"><a href="#7-3-日志系统架构图" class="headerlink" title="7.3 日志系统架构图"></a>7.3 日志系统架构图</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">GORM 日志系统架构:</span><br><span class="line"></span><br><span class="line">┌──────────────────────────────────────────────────────────┐</span><br><span class="line">│                        用户代码                             │</span><br><span class="line">│  db.Find(&amp;users)                                         │</span><br><span class="line">└───────────────────────┬──────────────────────────────────┘</span><br><span class="line">                        │</span><br><span class="line">                        ▼</span><br><span class="line">┌──────────────────────────────────────────────────────────┐</span><br><span class="line">│                    GORM Core                              │</span><br><span class="line">│  ┌────────────────────────────────────────────────────┐ │</span><br><span class="line">│  │  callback.Execute()                                 │ │</span><br><span class="line">│  │    │                                                │ │</span><br><span class="line">│  │    ▼                                                │ │</span><br><span class="line">│  │  ┌─────────────────────────────────────────────┐  │ │</span><br><span class="line">│  │  │  开始计时                                    │  │ │</span><br><span class="line">│  │  │  begin := time.Now()                        │  │ │</span><br><span class="line">│  │  │  defer logger.Trace(ctx, begin, fc, err)   │  │ │</span><br><span class="line">│  │  └─────────────────────────────────────────────┘  │ │</span><br><span class="line">│  │                                                     │ │</span><br><span class="line">│  │  ┌─────────────────────────────────────────────┐  │ │</span><br><span class="line">│  │  │  执行 SQL                                   │  │ │</span><br><span class="line">│  │  │  result := db.Exec(...)                      │  │ │</span><br><span class="line">│  │  └─────────────────────────────────────────────┘  │ │</span><br><span class="line">│  └────────────────────────────────────────────────────┘ │</span><br><span class="line">└───────────────────────┬──────────────────────────────────┘</span><br><span class="line">                        │</span><br><span class="line">                        ▼</span><br><span class="line">┌──────────────────────────────────────────────────────────┐</span><br><span class="line">│                  logger.Trace()                           │</span><br><span class="line">│  ┌────────────────────────────────────────────────────┐ │</span><br><span class="line">│  │  1. 计算耗时                                      │ │</span><br><span class="line">│  │     elapsed := time.Since(begin)                 │ │</span><br><span class="line">│  │                                                    │ │</span><br><span class="line">│  │  2. 延迟获取 SQL                                  │ │</span><br><span class="line">│  │     sql, rows := fc()                            │ │</span><br><span class="line">│  │                                                    │ │</span><br><span class="line">│  │  3. 决定是否记录                                  │ │</span><br><span class="line">│  │     ├─ 错误? → Error()                            │ │</span><br><span class="line">│  │     ├─ 慢查询? → Warn()                           │ │</span><br><span class="line">│  │     └─ Info? → Info()                             │ │</span><br><span class="line">│  └────────────────────────────────────────────────────┘ │</span><br><span class="line">└───────────────────────┬──────────────────────────────────┘</span><br><span class="line">                        │</span><br><span class="line">                        ▼</span><br><span class="line">┌──────────────────────────────────────────────────────────┐</span><br><span class="line">│                    Writer                                │</span><br><span class="line">│  ┌────────────────────────────────────────────────────┐ │</span><br><span class="line">│  │  Printf(format, args...)                          │ │</span><br><span class="line">│  │    ↓                                               │ │</span><br><span class="line">│  │  ┌────────────┬────────────┬────────────┐         │ │</span><br><span class="line">│  │  │ 控制台     │ 文件       │ 日志系统    │         │ │</span><br><span class="line">│  │  └────────────┴────────────┴────────────┘         │ │</span><br><span class="line">│  └────────────────────────────────────────────────────┘ │</span><br><span class="line">└──────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="八、最佳实践与故障排查"><a href="#八、最佳实践与故障排查" class="headerlink" title="八、最佳实践与故障排查"></a>八、最佳实践与故障排查</h2><h3 id="8-1-配置最佳实践"><a href="#8-1-配置最佳实践" class="headerlink" title="8.1 配置最佳实践"></a>8.1 配置最佳实践</h3><h4 id="开发环境最佳实践"><a href="#开发环境最佳实践" class="headerlink" title="开发环境最佳实践"></a>开发环境最佳实践</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 开发环境：详细日志，彩色输出</span></span><br><span class="line">db, _ := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;</span><br><span class="line">	Logger: logger.New(log.New(os.Stdout, <span class="string">&quot;\r\n&quot;</span>, log.LstdFlags), logger.Config&#123;</span><br><span class="line">		SlowThreshold:             <span class="number">200</span> * time.Millisecond,  <span class="comment">// 200ms</span></span><br><span class="line">		LogLevel:                  logger.Info,             <span class="comment">// 所有 SQL</span></span><br><span class="line">		Colorful:                  <span class="literal">true</span>,                   <span class="comment">// 彩色</span></span><br><span class="line">		IgnoreRecordNotFoundError: <span class="literal">true</span>,                   <span class="comment">// 忽略未找到</span></span><br><span class="line">		ParameterizedQueries:      <span class="literal">false</span>,                  <span class="comment">// 替换参数</span></span><br><span class="line">	&#125;),</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="生产环境最佳实践"><a href="#生产环境最佳实践" class="headerlink" title="生产环境最佳实践"></a>生产环境最佳实践</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 生产环境：错误和慢查询，禁用彩色</span></span><br><span class="line">db, _ := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;</span><br><span class="line">	Logger: logger.New(log.New(os.Stdout, <span class="string">&quot;\r\n&quot;</span>, log.LstdFlags), logger.Config&#123;</span><br><span class="line">		SlowThreshold:             <span class="number">500</span> * time.Millisecond,  <span class="comment">// 500ms</span></span><br><span class="line">		LogLevel:                  logger.Warn,             <span class="comment">// 错误和慢查询</span></span><br><span class="line">		Colorful:                  <span class="literal">false</span>,                  <span class="comment">// 禁用彩色</span></span><br><span class="line">		IgnoreRecordNotFoundError: <span class="literal">true</span>,                   <span class="comment">// 忽略未找到</span></span><br><span class="line">		ParameterizedQueries:      <span class="literal">true</span>,                   <span class="comment">// 参数化 SQL</span></span><br><span class="line">	&#125;),</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="测试环境最佳实践"><a href="#测试环境最佳实践" class="headerlink" title="测试环境最佳实践"></a>测试环境最佳实践</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 测试环境：Info 级别，禁用彩色</span></span><br><span class="line">db, _ := gorm.Open(sqlite.Open(<span class="string">&quot;:memory:&quot;</span>), &amp;gorm.Config&#123;</span><br><span class="line">	Logger: logger.New(log.New(os.Stdout, <span class="string">&quot;\r\n&quot;</span>, log.LstdFlags), logger.Config&#123;</span><br><span class="line">		SlowThreshold:             <span class="number">100</span> * time.Millisecond,  <span class="comment">// 100ms</span></span><br><span class="line">		LogLevel:                  logger.Info,             <span class="comment">// 详细日志</span></span><br><span class="line">		Colorful:                  <span class="literal">false</span>,                  <span class="comment">// 禁用彩色</span></span><br><span class="line">		IgnoreRecordNotFoundError: <span class="literal">false</span>,                  <span class="comment">// 不忽略错误</span></span><br><span class="line">		ParameterizedQueries:      <span class="literal">false</span>,                  <span class="comment">// 替换参数</span></span><br><span class="line">	&#125;),</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="8-2-性能优化"><a href="#8-2-性能优化" class="headerlink" title="8.2 性能优化"></a>8.2 性能优化</h3><h4 id="减少日志开销"><a href="#减少日志开销" class="headerlink" title="减少日志开销"></a>减少日志开销</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 使用 Silent 模式</span></span><br><span class="line">db, _ := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;</span><br><span class="line">	Logger: logger.Default.LogMode(logger.Silent),</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 禁用调用栈追踪</span></span><br><span class="line">db, _ := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;</span><br><span class="line">	Logger: logger.Default.LogMode(logger.Info),</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过 SkipCallerLookup 禁用（需要实现）</span></span><br><span class="line"><span class="comment">// 注意：标准 Logger 没有此方法，需要自定义实现</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 使用参数化 SQL</span></span><br><span class="line">db, _ := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;</span><br><span class="line">	Logger: logger.New(log.New(os.Stdout, <span class="string">&quot;\r\n&quot;</span>, log.LstdFlags), logger.Config&#123;</span><br><span class="line">		ParameterizedQueries: <span class="literal">true</span>,  <span class="comment">// 不替换参数，减少字符串操作</span></span><br><span class="line">	&#125;),</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="异步日志"><a href="#异步日志" class="headerlink" title="异步日志"></a>异步日志</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 异步 Logger：使用 goroutine 异步写入日志</span></span><br><span class="line"><span class="keyword">type</span> AsyncLogger <span class="keyword">struct</span> &#123;</span><br><span class="line">	logger.Interface</span><br><span class="line">	logChan <span class="keyword">chan</span> <span class="type">string</span></span><br><span class="line">	quit    <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line">	wg      sync.WaitGroup</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewAsyncLogger</span><span class="params">(writer Writer)</span></span> *AsyncLogger &#123;</span><br><span class="line">	al := &amp;AsyncLogger&#123;</span><br><span class="line">		Interface: logger.Default.LogMode(logger.Info),</span><br><span class="line">		logChan:  <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">string</span>, <span class="number">1000</span>),</span><br><span class="line">		quit:     <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;),</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 启动写入 goroutine</span></span><br><span class="line">	al.wg.Add(<span class="number">1</span>)</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">defer</span> al.wg.Done()</span><br><span class="line">		<span class="keyword">for</span> &#123;</span><br><span class="line">			<span class="keyword">select</span> &#123;</span><br><span class="line">			<span class="keyword">case</span> log := &lt;-al.logChan:</span><br><span class="line">				writer.Printf(log)</span><br><span class="line">			<span class="keyword">case</span> &lt;-al.quit:</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> al</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *AsyncLogger)</span></span> Trace(ctx context.Context, begin time.Time, fc <span class="function"><span class="keyword">func</span><span class="params">()</span></span> (<span class="type">string</span>, <span class="type">int64</span>), err <span class="type">error</span>) &#123;</span><br><span class="line">	elapsed := time.Since(begin)</span><br><span class="line">	sql, rows := fc()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 异步写入</span></span><br><span class="line">	l.logChan &lt;- fmt.Sprintf(<span class="string">&quot;[%.3fms] [rows:%v] %s\n&quot;</span>,</span><br><span class="line">		<span class="type">float64</span>(elapsed.Nanoseconds())/<span class="number">1e6</span>, rows, sql)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *AsyncLogger)</span></span> Close() &#123;</span><br><span class="line">	<span class="built_in">close</span>(l.quit)</span><br><span class="line">	l.wg.Wait()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="日志采样"><a href="#日志采样" class="headerlink" title="日志采样"></a>日志采样</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 采样 Logger：只记录部分日志</span></span><br><span class="line"><span class="keyword">type</span> SamplingLogger <span class="keyword">struct</span> &#123;</span><br><span class="line">	logger.Interface</span><br><span class="line">	rate <span class="type">float64</span> <span class="comment">// 采样率 0.0 - 1.0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *SamplingLogger)</span></span> Trace(ctx context.Context, begin time.Time, fc <span class="function"><span class="keyword">func</span><span class="params">()</span></span> (<span class="type">string</span>, <span class="type">int64</span>), err <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="comment">// 随机采样</span></span><br><span class="line">	<span class="keyword">if</span> rand.Float64() &gt; l.rate &#123;</span><br><span class="line">		<span class="keyword">return</span>  <span class="comment">// 不记录</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 记录日志</span></span><br><span class="line">	<span class="keyword">return</span> l.Interface.Trace(ctx, begin, fc, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用：只记录 10% 的日志</span></span><br><span class="line">db, _ := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;</span><br><span class="line">	Logger: &amp;SamplingLogger&#123;</span><br><span class="line">		Interface: logger.Default.LogMode(logger.Info),</span><br><span class="line">		rate:      <span class="number">0.1</span>,  <span class="comment">// 10% 采样率</span></span><br><span class="line">	&#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="8-3-安全建议"><a href="#8-3-安全建议" class="headerlink" title="8.3 安全建议"></a>8.3 安全建议</h3><h4 id="敏感数据过滤"><a href="#敏感数据过滤" class="headerlink" title="敏感数据过滤"></a>敏感数据过滤</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 敏感参数过滤器</span></span><br><span class="line"><span class="keyword">type</span> SensitiveDataFilter <span class="keyword">struct</span> &#123;</span><br><span class="line">	logger.Interface</span><br><span class="line">	sensitiveFields <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">bool</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *SensitiveDataFilter)</span></span> ParamsFilter(ctx context.Context, sql <span class="type">string</span>, params ...<span class="keyword">interface</span>&#123;&#125;) (<span class="type">string</span>, []<span class="keyword">interface</span>&#123;&#125;) &#123;</span><br><span class="line">	<span class="comment">// 检测敏感字段</span></span><br><span class="line">	<span class="keyword">if</span> strings.Contains(strings.ToLower(sql), <span class="string">&quot;password&quot;</span>) &#123;</span><br><span class="line">		<span class="keyword">for</span> i, param := <span class="keyword">range</span> params &#123;</span><br><span class="line">			<span class="keyword">if</span> _, ok := param.(<span class="type">string</span>); ok &#123;</span><br><span class="line">				params[i] = <span class="string">&quot;***&quot;</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> sql, params</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用</span></span><br><span class="line">db, _ := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;</span><br><span class="line">	Logger: &amp;SensitiveDataFilter&#123;</span><br><span class="line">		Interface:        logger.Default.LogMode(logger.Info),</span><br><span class="line">		sensitiveFields: <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">bool</span>&#123;</span><br><span class="line">			<span class="string">&quot;password&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">			<span class="string">&quot;token&quot;</span>:     <span class="literal">true</span>,</span><br><span class="line">			<span class="string">&quot;secret&quot;</span>:    <span class="literal">true</span>,</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="SQL-注入防护"><a href="#SQL-注入防护" class="headerlink" title="SQL 注入防护"></a>SQL 注入防护</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注意：GORM 使用参数化查询，已经防止 SQL 注入</span></span><br><span class="line"><span class="comment">// 但是日志中记录的 SQL 需要确保安全</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 安全的日志记录：始终使用参数化 SQL</span></span><br><span class="line">db, _ := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;</span><br><span class="line">	Logger: logger.New(log.New(os.Stdout, <span class="string">&quot;\r\n&quot;</span>, log.LstdFlags), logger.Config&#123;</span><br><span class="line">		ParameterizedQueries: <span class="literal">true</span>,  <span class="comment">// 只记录参数化 SQL</span></span><br><span class="line">	&#125;),</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="日志脱敏"><a href="#日志脱敏" class="headerlink" title="日志脱敏"></a>日志脱敏</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 脱敏 Logger</span></span><br><span class="line"><span class="keyword">type</span> MaskingLogger <span class="keyword">struct</span> &#123;</span><br><span class="line">	logger.Interface</span><br><span class="line">	maskFunc <span class="function"><span class="keyword">func</span><span class="params">(<span class="type">string</span>)</span></span> <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *MaskingLogger)</span></span> Trace(ctx context.Context, begin time.Time, fc <span class="function"><span class="keyword">func</span><span class="params">()</span></span> (<span class="type">string</span>, <span class="type">int64</span>), err <span class="type">error</span>) &#123;</span><br><span class="line">	elapsed := time.Since(begin)</span><br><span class="line">	sql, rows := fc()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 脱敏处理 SQL</span></span><br><span class="line">	maskedSQL := l.maskFunc(sql)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 记录脱敏后的日志</span></span><br><span class="line">	l.Printf(<span class="string">&quot;[%.3fms] [rows:%v] %s\n&quot;</span>,</span><br><span class="line">		<span class="type">float64</span>(elapsed.Nanoseconds())/<span class="number">1e6</span>, rows, maskedSQL)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 脱敏函数</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">maskSQL</span><span class="params">(sql <span class="type">string</span>)</span></span> <span class="type">string</span> &#123;</span><br><span class="line">	<span class="comment">// 移除敏感数据</span></span><br><span class="line">	<span class="comment">// 例如：移除字符串字面量中的值</span></span><br><span class="line">	<span class="keyword">return</span> sql</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="8-4-常见问题与解决方案"><a href="#8-4-常见问题与解决方案" class="headerlink" title="8.4 常见问题与解决方案"></a>8.4 常见问题与解决方案</h3><h4 id="日志不输出问题"><a href="#日志不输出问题" class="headerlink" title="日志不输出问题"></a>日志不输出问题</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 问题：设置日志级别后没有日志输出</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 原因 1：日志级别设置错误</span></span><br><span class="line">db, _ := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;</span><br><span class="line">	Logger: logger.Default.LogMode(logger.Silent),  <span class="comment">// Silent 模式不会输出任何日志</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 解决方案：使用正确的日志级别</span></span><br><span class="line">db, _ := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;</span><br><span class="line">	Logger: logger.Default.LogMode(logger.Info),</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 原因 2：使用了错误的 logger 实例</span></span><br><span class="line">db.Session(&amp;gorm.Session&#123;</span><br><span class="line">	Logger: logger.Default.LogMode(logger.Silent),  <span class="comment">// Session 级别的 logger</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 解决方案：使用全局 logger</span></span><br><span class="line">db.LogMode(logger.Info)</span><br></pre></td></tr></table></figure>

<h4 id="性能问题"><a href="#性能问题" class="headerlink" title="性能问题"></a>性能问题</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 问题：日志严重影响性能</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 原因 1：Info 级别在高并发场景下</span></span><br><span class="line">db, _ := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;</span><br><span class="line">	Logger: logger.Default.LogMode(logger.Info),  <span class="comment">// 记录所有 SQL</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 解决方案：使用 Warn 级别</span></span><br><span class="line">db, _ := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;</span><br><span class="line">	Logger: logger.Default.LogMode(logger.Warn),  <span class="comment">// 只记录错误和慢查询</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 原因 2：调用栈追踪开销大</span></span><br><span class="line"><span class="comment">// FileWithLineNum() 会遍历调用栈</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 解决方案：自定义 Logger，禁用调用栈追踪</span></span><br><span class="line"><span class="keyword">type</span> NoCallerLogger <span class="keyword">struct</span> &#123;</span><br><span class="line">	logger.Interface</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *NoCallerLogger)</span></span> Trace(ctx context.Context, begin time.Time, fc <span class="function"><span class="keyword">func</span><span class="params">()</span></span> (<span class="type">string</span>, <span class="type">int64</span>), err <span class="type">error</span>) &#123;</span><br><span class="line">	elapsed := time.Since(begin)</span><br><span class="line">	sql, rows := fc()</span><br><span class="line"></span><br><span class="line">	l.Printf(<span class="string">&quot;[%.3fms] [rows:%v] %s\n&quot;</span>,</span><br><span class="line">		<span class="type">float64</span>(elapsed.Nanoseconds())/<span class="number">1e6</span>, rows, sql)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="颜色显示问题"><a href="#颜色显示问题" class="headerlink" title="颜色显示问题"></a>颜色显示问题</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 问题：在 IDE 或日志系统中颜色显示异常</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 原因：某些终端不支持 ANSI 颜色代码</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 解决方案：禁用彩色输出</span></span><br><span class="line">db, _ := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;</span><br><span class="line">	Logger: logger.New(log.New(os.Stdout, <span class="string">&quot;\r\n&quot;</span>, log.LstdFlags), logger.Config&#123;</span><br><span class="line">		Colorful: <span class="literal">false</span>,  <span class="comment">// 禁用彩色</span></span><br><span class="line">	&#125;),</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 或者使用环境变量</span></span><br><span class="line"><span class="comment">// NO_COLOR=1 go run main.go</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="九、学习验证"><a href="#九、学习验证" class="headerlink" title="九、学习验证"></a>九、学习验证</h2><h3 id="9-1-知识自测"><a href="#9-1-知识自测" class="headerlink" title="9.1 知识自测"></a>9.1 知识自测</h3><h4 id="基础题"><a href="#基础题" class="headerlink" title="基础题"></a>基础题</h4><ol>
<li><p><strong>以下哪个是正确的日志级别排序（从低到高）？</strong></p>
<ul>
<li>A. Info, Warn, Error, Silent</li>
<li>B. Silent, Error, Warn, Info</li>
<li>C. Silent, Info, Warn, Error</li>
<li>D. Error, Warn, Info, Silent</li>
</ul>
<p><strong>答案: B</strong></p>
</li>
<li><p><strong>Trace 方法的 fc 参数的作用是什么？</strong></p>
<ul>
<li>A. 直接获取 SQL 和行数</li>
<li>B. 延迟获取 SQL 和行数</li>
<li>C. 执行 SQL 查询</li>
<li>D. 记录日志</li>
</ul>
<p><strong>答案: B</strong></p>
</li>
<li><p><strong>如何启用慢查询检测？</strong></p>
<ul>
<li>A. 设置 LogLevel 为 Info</li>
<li>B. 设置 SlowThreshold 大于 0</li>
<li>C. 设置 Colorful 为 true</li>
<li>D. 设置 IgnoreRecordNotFoundError 为 true</li>
</ul>
<p><strong>答案: B</strong></p>
</li>
<li><p><strong>哪种日志级别对性能影响最小？</strong></p>
<ul>
<li>A. Info</li>
<li>B. Warn</li>
<li>C. Error</li>
<li>D. Silent</li>
</ul>
<p><strong>答案: D</strong></p>
</li>
<li><p><strong>如何只记录参数化 SQL（不替换参数值）？</strong></p>
<ul>
<li>A. 设置 LogLevel 为 Silent</li>
<li>B. 设置 ParameterizedQueries 为 true</li>
<li>C. 设置 IgnoreRecordNotFoundError 为 true</li>
<li>D. 设置 SlowThreshold 为 0</li>
</ul>
<p><strong>答案: B</strong></p>
</li>
</ol>
<h4 id="进阶题"><a href="#进阶题" class="headerlink" title="进阶题"></a>进阶题</h4><ol>
<li><p><strong>分析以下代码的日志输出</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">db, _ := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;</span><br><span class="line">    Logger: logger.New(log.New(os.Stdout, <span class="string">&quot;\r\n&quot;</span>, log.LstdFlags), logger.Config&#123;</span><br><span class="line">        SlowThreshold: <span class="number">100</span> * time.Millisecond,</span><br><span class="line">        LogLevel:      logger.Warn,</span><br><span class="line">        Colorful:      <span class="literal">false</span>,</span><br><span class="line">    &#125;),</span><br><span class="line">&#125;)</span><br><span class="line">db.Find(&amp;users)</span><br></pre></td></tr></table></figure>

<p>假设查询耗时 50ms，是否有日志输出？</p>
<p><strong>答案</strong>: 没有日志输出。虽然设置了 LogLevel 为 Warn，但查询耗时 50ms，小于 SlowThreshold 100ms，且没有错误，所以不会记录日志。</p>
</li>
<li><p><strong>如何实现一个自定义 Logger，将日志写入文件？</strong></p>
<p><strong>答案</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> FileLogger <span class="keyword">struct</span> &#123;</span><br><span class="line">    logger.Interface</span><br><span class="line">    file *os.File</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *FileLogger)</span></span> Trace(ctx context.Context, begin time.Time, fc <span class="function"><span class="keyword">func</span><span class="params">()</span></span> (<span class="type">string</span>, <span class="type">int64</span>), err <span class="type">error</span>) &#123;</span><br><span class="line">    elapsed := time.Since(begin)</span><br><span class="line">    sql, rows := fc()</span><br><span class="line"></span><br><span class="line">    logEntry := fmt.Sprintf(<span class="string">&quot;[%s] [%.3fms] [rows:%v] %s\n&quot;</span>,</span><br><span class="line">        time.Now().Format(<span class="string">&quot;2006-01-02 15:04:05&quot;</span>),</span><br><span class="line">        <span class="type">float64</span>(elapsed.Nanoseconds())/<span class="number">1e6</span>, rows, sql)</span><br><span class="line">    l.file.WriteString(logEntry)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="实战题"><a href="#实战题" class="headerlink" title="实战题"></a>实战题</h4><ol>
<li><strong>实现一个完整的 JSON Logger</strong></li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> JSONLogger <span class="keyword">struct</span> &#123;</span><br><span class="line">	logger.Interface</span><br><span class="line">	writer io.Writer</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *JSONLogger)</span></span> Trace(ctx context.Context, begin time.Time, fc <span class="function"><span class="keyword">func</span><span class="params">()</span></span> (<span class="type">string</span>, <span class="type">int64</span>), err <span class="type">error</span>) &#123;</span><br><span class="line">	elapsed := time.Since(begin)</span><br><span class="line">	sql, rows := fc()</span><br><span class="line"></span><br><span class="line">	entry := <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">		<span class="string">&quot;timestamp&quot;</span>: time.Now().Format(time.RFC3339),</span><br><span class="line">		<span class="string">&quot;duration&quot;</span>:  <span class="type">float64</span>(elapsed.Nanoseconds()) / <span class="number">1e6</span>,</span><br><span class="line">		<span class="string">&quot;sql&quot;</span>:       sql,</span><br><span class="line">		<span class="string">&quot;rows&quot;</span>:      rows,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		entry[<span class="string">&quot;level&quot;</span>] = <span class="string">&quot;error&quot;</span></span><br><span class="line">		entry[<span class="string">&quot;error&quot;</span>] = err.Error()</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		entry[<span class="string">&quot;level&quot;</span>] = <span class="string">&quot;info&quot;</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	json.NewEncoder(l.writer).Encode(entry)</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *JSONLogger)</span></span> LogMode(level logger.LogLevel) logger.Interface &#123;</span><br><span class="line">	newlogger := *l</span><br><span class="line">	newlogger.Interface = l.Interface.LogMode(level)</span><br><span class="line">	<span class="keyword">return</span> &amp;newlogger</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="9-2-实践练习"><a href="#9-2-实践练习" class="headerlink" title="9.2 实践练习"></a>9.2 实践练习</h3><h4 id="练习-1-实现自定义-JSON-Logger"><a href="#练习-1-实现自定义-JSON-Logger" class="headerlink" title="练习 1: 实现自定义 JSON Logger"></a>练习 1: 实现自定义 JSON Logger</h4><p>创建一个输出 JSON 格式日志的 Logger，要求:</p>
<ul>
<li>包含时间戳、日志级别、执行时间、SQL、行数</li>
<li>支持错误日志</li>
<li>输出到标准输出</li>
</ul>
<p><strong>验收标准</strong>:</p>
<ul>
<li>输出格式正确的 JSON</li>
<li>包含所有必需字段</li>
<li>错误时包含错误信息</li>
</ul>
<hr>
<h2 id="三、学习路径建议"><a href="#三、学习路径建议" class="headerlink" title="三、学习路径建议"></a>三、学习路径建议</h2><h3 id="3-1-前置知识检查"><a href="#3-1-前置知识检查" class="headerlink" title="3.1 前置知识检查"></a>3.1 前置知识检查</h3><table>
<thead>
<tr>
<th>知识点</th>
<th>要求</th>
<th>检验方式</th>
</tr>
</thead>
<tbody><tr>
<td>Go 反射</td>
<td>了解 runtime.Caller</td>
<td>能编写简单的反射代码</td>
</tr>
<tr>
<td>Go 接口</td>
<td>理解接口设计</td>
<td>能定义和实现接口</td>
</tr>
<tr>
<td>SQL 基础</td>
<td>理解参数化查询</td>
<td>能区分原始 SQL 和参数化 SQL</td>
</tr>
<tr>
<td>日志系统</td>
<td>了解日志级别</td>
<td>能解释不同级别的用途</td>
</tr>
</tbody></table>
<h3 id="3-2-学习时间分配"><a href="#3-2-学习时间分配" class="headerlink" title="3.2 学习时间分配"></a>3.2 学习时间分配</h3><table>
<thead>
<tr>
<th>内容</th>
<th>理论</th>
<th>实践</th>
<th>产出</th>
</tr>
</thead>
<tbody><tr>
<td>Day 1: 日志基础</td>
<td>2h</td>
<td>1.5h</td>
<td>配置示例</td>
</tr>
<tr>
<td>Day 2: 高级日志</td>
<td>1.5h</td>
<td>2h</td>
<td>慢查询检测</td>
</tr>
<tr>
<td>Day 3: 扩展应用</td>
<td>1.5h</td>
<td>2h</td>
<td>自定义 Logger</td>
</tr>
</tbody></table>
<h3 id="3-3-学习成果验收"><a href="#3-3-学习成果验收" class="headerlink" title="3.3 学习成果验收"></a>3.3 学习成果验收</h3><p><strong>理论验收</strong>:</p>
<ul>
<li><input disabled="" type="checkbox"> 能解释 Logger 接口设计</li>
<li><input disabled="" type="checkbox"> 能说明 Trace 方法实现</li>
<li><input disabled="" type="checkbox"> 能理解 SQL 解释机制</li>
<li><input disabled="" type="checkbox"> 能对比不同日志级别</li>
</ul>
<p><strong>实践验收</strong>:</p>
<ul>
<li><input disabled="" type="checkbox"> 能配置日志级别</li>
<li><input disabled="" type="checkbox"> 能实现自定义 Logger</li>
<li><input disabled="" type="checkbox"> 能检测慢查询</li>
<li><input disabled="" type="checkbox"> 能追踪调用位置</li>
</ul>
<p><strong>综合验收</strong>:</p>
<ul>
<li><input disabled="" type="checkbox"> 能设计日志策略</li>
<li><input disabled="" type="checkbox"> 能集成日志系统</li>
<li><input disabled="" type="checkbox"> 能分析日志数据</li>
<li><input disabled="" type="checkbox"> 能向他人讲解日志系统</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a target="_blank" rel="noopener" href="https://github.com/Piwriw">Joohwan.</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://piwriw.github.io/2026/01/11/web/gorm/09-logger/">https://piwriw.github.io/2026/01/11/web/gorm/09-logger/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://piwriw.github.io" target="_blank">Joohwan</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/web/">web</a><a class="post-meta__tags" href="/tags/Gorm/">Gorm</a><a class="post-meta__tags" href="/tags/%E6%BA%90%E7%A0%81/">源码</a></div><div class="post-share"><div class="social-share" data-image="/img/go.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>赞助</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related full-width" href="/2026/01/11/web/gorm/10-plugin/" title="Gorm-插件系统模块原理说明"><img class="cover" src="/img/go.png" onerror="onerror=null;src='/img/404.png'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">Gorm-插件系统模块原理说明</div></div><div class="info-2"><div class="info-item-1">插件系统模块原理说明 基于1.31 本文档深入解析插件系统模块的设计原理和核心实现，涵盖扩展机制、插件开发、集成模式等核心内容。  目录 一、设计原理 1.1 模块定位 1.2 设计目的 1.3 结构安排依据 1.4 与其他模块的逻辑关系 1.5 插件类型分类   二、核心数据结构 2.1 Plugin 接口 2.2 Config 插件字段 2.3 Use() 方法   三、核心实现 3.1 插件注册机制 3.2 插件初始化流程 3.3 回调系统集成 3.4 插件状态管理   四、实战代码示例 4.1 基础插件开发 4.2 读写分离插件 4.3 查询缓存插件 4.4 性能监控插件 4.5 数据脱敏插件   五、可视化流程图 5.1 插件注册流程 5.2 插件初始化流程 5.3 回调集成流程 5.4 插件系统架构   六、最佳实践与故障排查 6.1 开发最佳实践 6.2 常见问题与解决方案 6.3 性能优化建议 6.4 安全建议   七、学习验证 7.1 知识自测 7.2 实践练习     一、设计原理1.1 模块定位在整体架构中的位置 插件系统是 GORM 的扩展机制，位于应用层...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2026/01/11/web/gorm/08-migration/" title="Gorm-迁移功能模块原理说明"><img class="cover" src="/img/go.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-01-11</div><div class="info-item-2">Gorm-迁移功能模块原理说明</div></div><div class="info-2"><div class="info-item-1">迁移功能模块原理说明 基于1.31 本文档深入解析迁移功能模块的设计原理和核心实现，涵盖数据库结构管理、类型映射、约束管理等核心内容。学习完本文档后，您将能够彻底理解 GORM 迁移系统的工作机制，并能够在实际项目中安全高效地进行数据库迁移。  文档目录1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798991001011021031041051061071081091101111121131141151161171181191201211221231241251261271281291301311321331341351361371381391401411421431441451461471481491501511521531541551561571581591...</div></div></div></a><a class="pagination-related" href="/2026/01/11/web/gorm/10-plugin/" title="Gorm-插件系统模块原理说明"><img class="cover" src="/img/go.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-01-11</div><div class="info-item-2">Gorm-插件系统模块原理说明</div></div><div class="info-2"><div class="info-item-1">插件系统模块原理说明 基于1.31 本文档深入解析插件系统模块的设计原理和核心实现，涵盖扩展机制、插件开发、集成模式等核心内容。  目录 一、设计原理 1.1 模块定位 1.2 设计目的 1.3 结构安排依据 1.4 与其他模块的逻辑关系 1.5 插件类型分类   二、核心数据结构 2.1 Plugin 接口 2.2 Config 插件字段 2.3 Use() 方法   三、核心实现 3.1 插件注册机制 3.2 插件初始化流程 3.3 回调系统集成 3.4 插件状态管理   四、实战代码示例 4.1 基础插件开发 4.2 读写分离插件 4.3 查询缓存插件 4.4 性能监控插件 4.5 数据脱敏插件   五、可视化流程图 5.1 插件注册流程 5.2 插件初始化流程 5.3 回调集成流程 5.4 插件系统架构   六、最佳实践与故障排查 6.1 开发最佳实践 6.2 常见问题与解决方案 6.3 性能优化建议 6.4 安全建议   七、学习验证 7.1 知识自测 7.2 实践练习     一、设计原理1.1 模块定位在整体架构中的位置 插件系统是 GORM 的扩展机制，位于应用层...</div></div></div></a><a class="pagination-related" href="/2026/01/11/web/gorm/07-transaction/" title="Gorm-事务处理模块原理说明"><img class="cover" src="/img/go.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-01-11</div><div class="info-item-2">Gorm-事务处理模块原理说明</div></div><div class="info-2"><div class="info-item-1">事务处理模块原理说明 基于1.31 本文档深入解析事务处理模块的设计原理和核心实现，涵盖事务管理、嵌套事务、保存点机制等核心内容。通过阅读本文档，您将能够完全理解 GORM 事务处理模块的工作原理，无需额外阅读源码。   目录 一、设计原理 1.1 模块定位 1.2 设计目的 1.3 结构安排依据 1.4 与其他模块的逻辑关系   二、核心数据结构 2.1 事务相关接口 2.2 TxOptions 配置   三、事务核心实现 3.1 Transaction 函数完整实现 3.2 Begin 函数完整实现 3.3 Commit 和 Rollback 实现 3.4 SavePoint 和 RollbackTo 实现 3.5 事务执行流程图   四、默认事务机制 4.1 BeginTransaction 实现 4.2 CommitOrRollbackTransaction 实现 4.3 回调注册流程 4.4 默认事务流程图   五、实战代码示例 5.1 基础事务使用 5.2 嵌套事务使用 5.3 手动事务控制 5.4 保存点使用 5.5 隔离级别配置 5.6 复杂业务场景   六、最佳...</div></div></div></a><a class="pagination-related" href="/2026/01/11/web/gorm/06-associations/" title="Gorm-关联关系模块原理说明"><img class="cover" src="/img/go.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-01-11</div><div class="info-item-2">Gorm-关联关系模块原理说明</div></div><div class="info-2"><div class="info-item-1">关联关系模块原理说明  基于1.31 本文档深入解析关联关系模块的设计原理和核心实现，涵盖关系推断、预加载机制、N+1 问题解决、Association API 等核心内容。通过阅读本文档，您将能够完全理解 GORM 关联关系模块的工作原理，无需额外阅读源码。   目录 一、设计原理 1.1 模块定位 1.2 设计目的 1.3 结构安排依据 1.4 与其他模块的逻辑关系   二、核心数据结构 2.1 Relationship 结构完整解析 2.2 Relationships 结构 2.3 Reference 结构 2.4 Polymorphic 结构   三、关系推断机制 3.1 parseRelation 函数完整实现 3.2 guessRelation 函数完整实现 3.3 buildPolymorphicRelation 实现 3.4 buildMany2ManyRelation 实现 3.5 关系推断决策树   四、预加载机制 4.1 preloadEntryPoint 完整实现 4.2 preload 函数完整实现 4.3 Preload 执行流程图 4.4 嵌套预加载...</div></div></div></a><a class="pagination-related" href="/2026/01/11/web/gorm/05-callback/" title="Gorm-回调钩子模块原理说明"><img class="cover" src="/img/go.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-01-11</div><div class="info-item-2">Gorm-回调钩子模块原理说明</div></div><div class="info-2"><div class="info-item-1">回调钩子模块原理说明 基于1.31 本文档深入解析回调钩子模块的设计原理和核心原理，涵盖事件驱动机制、责任链模式、钩子注册与执行等核心内容。   一、设计原理1.1 模块定位在整体架构中的位置 回调钩子模块是 GORM 的事件驱动层，位于查询构建和 SQL 执行之间，负责在数据操作的生命周期中插入自定义逻辑。 1234567891011121314151617181920212223242526272829303132333435┌─────────────────────────────────────────────────────────────┐│                    Finisher API                              ││                      db.Find(&amp;users)                         │└────────────────────────┬────────────────────────────────────┘                      ...</div></div></div></a><a class="pagination-related" href="/2026/01/11/web/gorm/04-clause/" title="Gorm-子句系统模块原理说明"><img class="cover" src="/img/go.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-01-11</div><div class="info-item-2">Gorm-子句系统模块原理说明</div></div><div class="info-2"><div class="info-item-1">子句系统模块原理说明 基于1.31 本文档深入解析子句系统模块的设计原理和核心原理，阐述 SQL 组件化构建的理论基础。   一、设计原理1.1 模块定位在整体架构中的位置 子句系统是 GORM SQL 构建的核心组件化引擎，位于 Statement 层之下，直接负责将用户意图转换为 SQL 片段。 1234567891011121314151617181920212223242526┌─────────────────────────────────────────────────────────────┐│                   用户 API 调用                               ││  db.Where(&quot;age &gt; ?&quot;, 18).Order(&quot;name&quot;).Limit(10)           │└────────────────────────┬────────────────────────────────────┘                         │ 解析意图...</div></div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Joohwan.</div><div class="author-info-description">该知道的都知道，不知道的慢慢了解</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">259</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">76</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">60</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/piwriw"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/piwriw" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:piwriw@163.com" target="_blank" title="Email"><i class="fas fa-envelope-open-text"></i></a></div></div><div class="card-widget"><div class="item-headline"><i class="iconfont icat-visitor"></i><span>来访者</span></div><div class="item-content"><div id="welcome-info"></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F%E6%A8%A1%E5%9D%97%E5%8E%9F%E7%90%86%E8%AF%B4%E6%98%8E"><span class="toc-number">1.</span> <span class="toc-text">日志系统模块原理说明</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E6%A1%A3%E7%9B%AE%E5%BD%95"><span class="toc-number">1.1.</span> <span class="toc-text">文档目录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E8%AE%BE%E8%AE%A1%E5%8E%9F%E7%90%86"><span class="toc-number">1.2.</span> <span class="toc-text">一、设计原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E6%A8%A1%E5%9D%97%E5%AE%9A%E4%BD%8D"><span class="toc-number">1.2.1.</span> <span class="toc-text">1.1 模块定位</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E8%AE%BE%E8%AE%A1%E7%9B%AE%E7%9A%84"><span class="toc-number">1.2.2.</span> <span class="toc-text">1.2 设计目的</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-%E7%BB%93%E6%9E%84%E5%AE%89%E6%8E%92%E4%BE%9D%E6%8D%AE"><span class="toc-number">1.2.3.</span> <span class="toc-text">1.3 结构安排依据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-%E4%B8%8E%E5%85%B6%E4%BB%96%E6%A8%A1%E5%9D%97%E7%9A%84%E9%80%BB%E8%BE%91%E5%85%B3%E7%B3%BB"><span class="toc-number">1.2.4.</span> <span class="toc-text">1.4 与其他模块的逻辑关系</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E6%A0%B8%E5%BF%83%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-number">1.3.</span> <span class="toc-text">二、核心数据结构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-LogLevel-%E6%9E%9A%E4%B8%BE-logger-go-34-46"><span class="toc-number">1.3.1.</span> <span class="toc-text">2.1 LogLevel 枚举 (logger.go:34-46)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9E%9A%E4%B8%BE%E5%AE%9A%E4%B9%89"><span class="toc-number">1.3.1.1.</span> <span class="toc-text">枚举定义</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BA%A7%E5%88%AB%E8%AF%B4%E6%98%8E"><span class="toc-number">1.3.1.2.</span> <span class="toc-text">级别说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.3.1.3.</span> <span class="toc-text">使用示例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-Interface-%E6%8E%A5%E5%8F%A3-logger-go-62-69"><span class="toc-number">1.3.2.</span> <span class="toc-text">2.2 Interface 接口 (logger.go:62-69)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">接口定义</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E8%AF%B4%E6%98%8E"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">方法说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1%E5%8E%9F%E7%90%86"><span class="toc-number">1.3.2.3.</span> <span class="toc-text">接口设计原理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-Config-%E7%BB%93%E6%9E%84%E4%BD%93-logger-go-53-60"><span class="toc-number">1.3.3.</span> <span class="toc-text">2.3 Config 结构体 (logger.go:53-60)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%93%E6%9E%84%E4%BD%93%E5%AE%9A%E4%B9%89"><span class="toc-number">1.3.3.1.</span> <span class="toc-text">结构体定义</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%97%E6%AE%B5%E8%AF%B4%E6%98%8E"><span class="toc-number">1.3.3.2.</span> <span class="toc-text">字段说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.3.3.3.</span> <span class="toc-text">配置示例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-logger-%E7%BB%93%E6%9E%84%E4%BD%93-logger-go-122-127"><span class="toc-number">1.3.4.</span> <span class="toc-text">2.4 logger 结构体 (logger.go:122-127)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%93%E6%9E%84%E4%BD%93%E5%AE%9A%E4%B9%89-1"><span class="toc-number">1.3.4.1.</span> <span class="toc-text">结构体定义</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%97%E6%AE%B5%E8%AF%B4%E6%98%8E-1"><span class="toc-number">1.3.4.2.</span> <span class="toc-text">字段说明</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-Writer-%E6%8E%A5%E5%8F%A3-logger-go-48-51"><span class="toc-number">1.3.5.</span> <span class="toc-text">2.5 Writer 接口 (logger.go:48-51)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89-1"><span class="toc-number">1.3.5.1.</span> <span class="toc-text">接口定义</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.3.5.2.</span> <span class="toc-text">实现示例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-traceRecorder-%E7%BB%93%E6%9E%84%E4%BD%93-logger-go-200-206"><span class="toc-number">1.3.6.</span> <span class="toc-text">2.6 traceRecorder 结构体 (logger.go:200-206)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%93%E6%9E%84%E4%BD%93%E5%AE%9A%E4%B9%89-2"><span class="toc-number">1.3.6.1.</span> <span class="toc-text">结构体定义</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%A8%E9%80%94%E8%AF%B4%E6%98%8E"><span class="toc-number">1.3.6.2.</span> <span class="toc-text">用途说明</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E6%97%A5%E5%BF%97%E6%A0%B8%E5%BF%83%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.4.</span> <span class="toc-text">三、日志核心实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-New-%E5%87%BD%E6%95%B0-logger-go-90-120"><span class="toc-number">1.4.1.</span> <span class="toc-text">3.1 New() 函数 (logger.go:90-120)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%8C%E6%95%B4%E6%BA%90%E7%A0%81"><span class="toc-number">1.4.1.1.</span> <span class="toc-text">完整源码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%9E%84%E5%BB%BA"><span class="toc-number">1.4.1.2.</span> <span class="toc-text">格式化字符串构建</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-LogMode-%E6%96%B9%E6%B3%95-logger-go-129-134"><span class="toc-number">1.4.2.</span> <span class="toc-text">3.2 LogMode() 方法 (logger.go:129-134)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%8C%E6%95%B4%E6%BA%90%E7%A0%81-1"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">完整源码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BA%A7%E5%88%AB%E5%88%87%E6%8D%A2%E6%9C%BA%E5%88%B6"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">级别切换机制</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-Trace-%E6%96%B9%E6%B3%95-logger-go-157-190"><span class="toc-number">1.4.3.</span> <span class="toc-text">3.3 Trace() 方法 (logger.go:157-190)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%8C%E6%95%B4%E6%BA%90%E7%A0%81-2"><span class="toc-number">1.4.3.1.</span> <span class="toc-text">完整源码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.4.3.2.</span> <span class="toc-text">执行流程详解</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%B3%E7%AD%96%E9%80%BB%E8%BE%91"><span class="toc-number">1.4.3.3.</span> <span class="toc-text">决策逻辑</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86"><span class="toc-number">1.5.</span> <span class="toc-text">二、核心原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E5%85%B3%E9%94%AE%E6%A6%82%E5%BF%B5"><span class="toc-number">1.5.1.</span> <span class="toc-text">2.1 关键概念</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5-1-Logger-%E6%8E%A5%E5%8F%A3"><span class="toc-number">1.5.1.1.</span> <span class="toc-text">概念 1: Logger 接口</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5-2-LogLevel-%E6%9E%9A%E4%B8%BE"><span class="toc-number">1.5.1.2.</span> <span class="toc-text">概念 2: LogLevel 枚举</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5-3-Trace-%E6%96%B9%E6%B3%95%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.5.1.3.</span> <span class="toc-text">概念 3: Trace 方法详解</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5-4-SQL-%E8%A7%A3%E9%87%8A%E6%9C%BA%E5%88%B6"><span class="toc-number">1.5.1.4.</span> <span class="toc-text">概念 4: SQL 解释机制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5-5-%E8%B0%83%E7%94%A8%E6%A0%88%E8%BF%BD%E8%B8%AA"><span class="toc-number">1.5.1.5.</span> <span class="toc-text">概念 5: 调用栈追踪</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E7%90%86%E8%AE%BA%E5%9F%BA%E7%A1%80"><span class="toc-number">1.5.2.</span> <span class="toc-text">2.2 理论基础</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%90%86%E8%AE%BA-1-%E7%BB%93%E6%9E%84%E5%8C%96%E6%97%A5%E5%BF%97"><span class="toc-number">1.5.2.1.</span> <span class="toc-text">理论 1: 结构化日志</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%90%86%E8%AE%BA-2-%E6%85%A2%E6%9F%A5%E8%AF%A2%E6%A3%80%E6%B5%8B"><span class="toc-number">1.5.2.2.</span> <span class="toc-text">理论 2: 慢查询检测</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%90%86%E8%AE%BA-3-%E6%97%A5%E5%BF%97%E8%81%9A%E5%90%88%E4%B8%8E%E5%88%86%E6%9E%90"><span class="toc-number">1.5.2.3.</span> <span class="toc-text">理论 3: 日志聚合与分析</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E5%AD%A6%E4%B9%A0%E6%96%B9%E6%B3%95"><span class="toc-number">1.5.3.</span> <span class="toc-text">2.3 学习方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%B3%95-1-%E5%AE%9E%E9%AA%8C%E6%B3%95"><span class="toc-number">1.5.3.1.</span> <span class="toc-text">方法 1: 实验法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%B3%95-2-%E5%AF%B9%E6%AF%94%E6%B3%95"><span class="toc-number">1.5.3.2.</span> <span class="toc-text">方法 2: 对比法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-%E5%AE%9E%E6%96%BD%E7%AD%96%E7%95%A5"><span class="toc-number">1.5.4.</span> <span class="toc-text">2.4 实施策略</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AD%96%E7%95%A5-1-%E5%88%86%E5%B1%82%E5%AD%A6%E4%B9%A0"><span class="toc-number">1.5.4.1.</span> <span class="toc-text">策略 1: 分层学习</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AD%96%E7%95%A5-2-%E5%9C%BA%E6%99%AF%E9%A9%B1%E5%8A%A8"><span class="toc-number">1.5.4.2.</span> <span class="toc-text">策略 2: 场景驱动</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E3%80%81%E5%AE%9E%E6%88%98%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.6.</span> <span class="toc-text">六、实战代码示例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.6.1.</span> <span class="toc-text">6.1 基础配置示例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="toc-number">1.6.1.1.</span> <span class="toc-text">开发环境配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="toc-number">1.6.1.2.</span> <span class="toc-text">生产环境配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="toc-number">1.6.1.3.</span> <span class="toc-text">测试环境配置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-%E8%87%AA%E5%AE%9A%E4%B9%89-Logger-%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.6.2.</span> <span class="toc-text">6.2 自定义 Logger 示例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E4%BB%B6-Logger"><span class="toc-number">1.6.2.1.</span> <span class="toc-text">文件 Logger</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JSON-Logger"><span class="toc-number">1.6.2.2.</span> <span class="toc-text">JSON Logger</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%93%E6%9E%84%E5%8C%96-Logger%EF%BC%88%E9%9B%86%E6%88%90-zap%EF%BC%89"><span class="toc-number">1.6.2.3.</span> <span class="toc-text">结构化 Logger（集成 zap）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-%E6%85%A2%E6%9F%A5%E8%AF%A2%E6%A3%80%E6%B5%8B%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.6.3.</span> <span class="toc-text">6.3 慢查询检测示例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE"><span class="toc-number">1.6.3.1.</span> <span class="toc-text">基础配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E9%85%8D%E7%BD%AE"><span class="toc-number">1.6.3.2.</span> <span class="toc-text">动态配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%91%8A%E8%AD%A6%E9%9B%86%E6%88%90"><span class="toc-number">1.6.3.3.</span> <span class="toc-text">告警集成</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4-%E6%97%A5%E5%BF%97%E9%9B%86%E6%88%90%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.6.4.</span> <span class="toc-text">6.4 日志集成示例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9B%86%E6%88%90-logrus"><span class="toc-number">1.6.4.1.</span> <span class="toc-text">集成 logrus</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9B%86%E6%88%90-fluentd"><span class="toc-number">1.6.4.2.</span> <span class="toc-text">集成 fluentd</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-5-Recorder-%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.6.5.</span> <span class="toc-text">6.5 Recorder 使用示例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#SQL-%E8%AE%B0%E5%BD%95"><span class="toc-number">1.6.5.1.</span> <span class="toc-text">SQL 记录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95"><span class="toc-number">1.6.5.2.</span> <span class="toc-text">单元测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SQL-%E5%AE%A1%E8%AE%A1"><span class="toc-number">1.6.5.3.</span> <span class="toc-text">SQL 审计</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83%E3%80%81%E5%8F%AF%E8%A7%86%E5%8C%96%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="toc-number">1.7.</span> <span class="toc-text">七、可视化流程图</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-Trace-%E5%AE%8C%E6%95%B4%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="toc-number">1.7.1.</span> <span class="toc-text">7.1 Trace() 完整执行流程图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-%E6%97%A5%E5%BF%97%E7%BA%A7%E5%88%AB%E5%86%B3%E7%AD%96%E6%A0%91"><span class="toc-number">1.7.2.</span> <span class="toc-text">7.2 日志级别决策树</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-3-%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E5%9B%BE"><span class="toc-number">1.7.3.</span> <span class="toc-text">7.3 日志系统架构图</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AB%E3%80%81%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E4%B8%8E%E6%95%85%E9%9A%9C%E6%8E%92%E6%9F%A5"><span class="toc-number">1.8.</span> <span class="toc-text">八、最佳实践与故障排查</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-%E9%85%8D%E7%BD%AE%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">1.8.1.</span> <span class="toc-text">8.1 配置最佳实践</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">1.8.1.1.</span> <span class="toc-text">开发环境最佳实践</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">1.8.1.2.</span> <span class="toc-text">生产环境最佳实践</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E7%8E%AF%E5%A2%83%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">1.8.1.3.</span> <span class="toc-text">测试环境最佳实践</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="toc-number">1.8.2.</span> <span class="toc-text">8.2 性能优化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%8F%E5%B0%91%E6%97%A5%E5%BF%97%E5%BC%80%E9%94%80"><span class="toc-number">1.8.2.1.</span> <span class="toc-text">减少日志开销</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5%E6%97%A5%E5%BF%97"><span class="toc-number">1.8.2.2.</span> <span class="toc-text">异步日志</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E9%87%87%E6%A0%B7"><span class="toc-number">1.8.2.3.</span> <span class="toc-text">日志采样</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-3-%E5%AE%89%E5%85%A8%E5%BB%BA%E8%AE%AE"><span class="toc-number">1.8.3.</span> <span class="toc-text">8.3 安全建议</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%8F%E6%84%9F%E6%95%B0%E6%8D%AE%E8%BF%87%E6%BB%A4"><span class="toc-number">1.8.3.1.</span> <span class="toc-text">敏感数据过滤</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SQL-%E6%B3%A8%E5%85%A5%E9%98%B2%E6%8A%A4"><span class="toc-number">1.8.3.2.</span> <span class="toc-text">SQL 注入防护</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E8%84%B1%E6%95%8F"><span class="toc-number">1.8.3.3.</span> <span class="toc-text">日志脱敏</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-4-%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E4%B8%8E%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">1.8.4.</span> <span class="toc-text">8.4 常见问题与解决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E4%B8%8D%E8%BE%93%E5%87%BA%E9%97%AE%E9%A2%98"><span class="toc-number">1.8.4.1.</span> <span class="toc-text">日志不输出问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E9%97%AE%E9%A2%98"><span class="toc-number">1.8.4.2.</span> <span class="toc-text">性能问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A2%9C%E8%89%B2%E6%98%BE%E7%A4%BA%E9%97%AE%E9%A2%98"><span class="toc-number">1.8.4.3.</span> <span class="toc-text">颜色显示问题</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B9%9D%E3%80%81%E5%AD%A6%E4%B9%A0%E9%AA%8C%E8%AF%81"><span class="toc-number">1.9.</span> <span class="toc-text">九、学习验证</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#9-1-%E7%9F%A5%E8%AF%86%E8%87%AA%E6%B5%8B"><span class="toc-number">1.9.1.</span> <span class="toc-text">9.1 知识自测</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E9%A2%98"><span class="toc-number">1.9.1.1.</span> <span class="toc-text">基础题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9B%E9%98%B6%E9%A2%98"><span class="toc-number">1.9.1.2.</span> <span class="toc-text">进阶题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E9%A2%98"><span class="toc-number">1.9.1.3.</span> <span class="toc-text">实战题</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-2-%E5%AE%9E%E8%B7%B5%E7%BB%83%E4%B9%A0"><span class="toc-number">1.9.2.</span> <span class="toc-text">9.2 实践练习</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%83%E4%B9%A0-1-%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%AE%9A%E4%B9%89-JSON-Logger"><span class="toc-number">1.9.2.1.</span> <span class="toc-text">练习 1: 实现自定义 JSON Logger</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E5%AD%A6%E4%B9%A0%E8%B7%AF%E5%BE%84%E5%BB%BA%E8%AE%AE"><span class="toc-number">1.10.</span> <span class="toc-text">三、学习路径建议</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86%E6%A3%80%E6%9F%A5"><span class="toc-number">1.10.1.</span> <span class="toc-text">3.1 前置知识检查</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E5%AD%A6%E4%B9%A0%E6%97%B6%E9%97%B4%E5%88%86%E9%85%8D"><span class="toc-number">1.10.2.</span> <span class="toc-text">3.2 学习时间分配</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E5%AD%A6%E4%B9%A0%E6%88%90%E6%9E%9C%E9%AA%8C%E6%94%B6"><span class="toc-number">1.10.3.</span> <span class="toc-text">3.3 学习成果验收</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2026/01/11/web/gorm/09-logger/" title="Gorm-日志系统模块原理说明"><img src="/img/go.png" onerror="this.onerror=null;this.src='/img/404.png'" alt="Gorm-日志系统模块原理说明"/></a><div class="content"><a class="title" href="/2026/01/11/web/gorm/09-logger/" title="Gorm-日志系统模块原理说明">Gorm-日志系统模块原理说明</a><time datetime="2026-01-11T11:56:27.000Z" title="发表于 2026-01-11 19:56:27">2026-01-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2026/01/11/web/gorm/08-migration/" title="Gorm-迁移功能模块原理说明"><img src="/img/go.png" onerror="this.onerror=null;this.src='/img/404.png'" alt="Gorm-迁移功能模块原理说明"/></a><div class="content"><a class="title" href="/2026/01/11/web/gorm/08-migration/" title="Gorm-迁移功能模块原理说明">Gorm-迁移功能模块原理说明</a><time datetime="2026-01-11T10:56:27.000Z" title="发表于 2026-01-11 18:56:27">2026-01-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2026/01/11/web/gorm/10-plugin/" title="Gorm-插件系统模块原理说明"><img src="/img/go.png" onerror="this.onerror=null;this.src='/img/404.png'" alt="Gorm-插件系统模块原理说明"/></a><div class="content"><a class="title" href="/2026/01/11/web/gorm/10-plugin/" title="Gorm-插件系统模块原理说明">Gorm-插件系统模块原理说明</a><time datetime="2026-01-11T10:56:27.000Z" title="发表于 2026-01-11 18:56:27">2026-01-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2026/01/11/web/gorm/07-transaction/" title="Gorm-事务处理模块原理说明"><img src="/img/go.png" onerror="this.onerror=null;this.src='/img/404.png'" alt="Gorm-事务处理模块原理说明"/></a><div class="content"><a class="title" href="/2026/01/11/web/gorm/07-transaction/" title="Gorm-事务处理模块原理说明">Gorm-事务处理模块原理说明</a><time datetime="2026-01-11T09:56:27.000Z" title="发表于 2026-01-11 17:56:27">2026-01-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2026/01/11/web/gorm/06-associations/" title="Gorm-关联关系模块原理说明"><img src="/img/go.png" onerror="this.onerror=null;this.src='/img/404.png'" alt="Gorm-关联关系模块原理说明"/></a><div class="content"><a class="title" href="/2026/01/11/web/gorm/06-associations/" title="Gorm-关联关系模块原理说明">Gorm-关联关系模块原理说明</a><time datetime="2026-01-11T08:56:27.000Z" title="发表于 2026-01-11 16:56:27">2026-01-11</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2023 - 2026 By Joohwan.</span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
  const option = null

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://piwriw-twikoo-git-main-piwriw.vercel.app/',
      region: 'ap-shanghai',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const init = (el = document, path = location.pathname) => {
    twikoo.init({
      el: el.querySelector('#twikoo-wrap'),
      envId: 'https://piwriw-twikoo-git-main-piwriw.vercel.app/',
      region: 'ap-shanghai',
      onCommentLoaded: () => {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      },
      ...option,
      path: isShuoshuo ? path : (option && option.path) || path
    })

    

    isShuoshuo && (window.shuoshuoComment.destroyTwikoo = () => {
      if (el.children.length) {
        el.innerHTML = ''
        el.classList.add('no-comment')
      }
    })
  }

  const loadTwikoo = (el, path) => {
    if (typeof twikoo === 'object') setTimeout(() => init(el, path), 0)
    else btf.getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(() => init(el, path))
  }

  if (isShuoshuo) {
    'Twikoo' === 'Twikoo'
      ? window.shuoshuoComment = { loadComment: loadTwikoo }
      : window.loadOtherComment = loadTwikoo
    return
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script></div><script src="/js/categories.js" defer></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>