<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Gorm-插件系统模块原理说明 | Joohwan</title><meta name="author" content="Joohwan."><meta name="copyright" content="Joohwan."><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="插件系统模块原理说明 基于1.31 本文档深入解析插件系统模块的设计原理和核心实现，涵盖扩展机制、插件开发、集成模式等核心内容。  目录 一、设计原理 1.1 模块定位 1.2 设计目的 1.3 结构安排依据 1.4 与其他模块的逻辑关系 1.5 插件类型分类   二、核心数据结构 2.1 Plugin 接口 2.2 Config 插件字段 2.3 Use() 方法   三、核心实现 3.1 插件">
<meta property="og:type" content="article">
<meta property="og:title" content="Gorm-插件系统模块原理说明">
<meta property="og:url" content="https://piwriw.github.io/2026/01/11/web/gorm/10-plugin/index.html">
<meta property="og:site_name" content="Joohwan">
<meta property="og:description" content="插件系统模块原理说明 基于1.31 本文档深入解析插件系统模块的设计原理和核心实现，涵盖扩展机制、插件开发、集成模式等核心内容。  目录 一、设计原理 1.1 模块定位 1.2 设计目的 1.3 结构安排依据 1.4 与其他模块的逻辑关系 1.5 插件类型分类   二、核心数据结构 2.1 Plugin 接口 2.2 Config 插件字段 2.3 Use() 方法   三、核心实现 3.1 插件">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://piwriw.github.io/img/go.png">
<meta property="article:published_time" content="2026-01-11T10:56:27.000Z">
<meta property="article:modified_time" content="2026-02-28T13:29:12.680Z">
<meta property="article:author" content="Joohwan.">
<meta property="article:tag" content="web">
<meta property="article:tag" content="Gorm">
<meta property="article:tag" content="源码">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://piwriw.github.io/img/go.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Gorm-插件系统模块原理说明",
  "url": "https://piwriw.github.io/2026/01/11/web/gorm/10-plugin/",
  "image": "https://piwriw.github.io/img/go.png",
  "datePublished": "2026-01-11T10:56:27.000Z",
  "dateModified": "2026-02-28T13:29:12.680Z",
  "author": [
    {
      "@type": "Person",
      "name": "Joohwan.",
      "url": "https://github.com/Piwriw"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://piwriw.github.io/2026/01/11/web/gorm/10-plugin/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Gorm-插件系统模块原理说明',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><script src="/js/welcome.js"></script><script src="https://npm.elemecdn.com/echarts@4.9.0/dist/echarts.min.js"></script><link rel="stylesheet" href="/css/categories.css"><link rel="stylesheet" href="/css/tabs.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">259</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">76</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">60</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/charts/"><i class="fa-fw fas fa-folder-open"></i><span> 文章统计</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div><div class="menus_item"><a class="site-page" href="/wish/"><i class="fa-fw fas fa-tags"></i><span> 许愿墙</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/go.png);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Joohwan</span></a><a class="nav-page-title" href="/"><span class="site-name">Gorm-插件系统模块原理说明</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/charts/"><i class="fa-fw fas fa-folder-open"></i><span> 文章统计</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div><div class="menus_item"><a class="site-page" href="/wish/"><i class="fa-fw fas fa-tags"></i><span> 许愿墙</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Gorm-插件系统模块原理说明</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2026-01-11T10:56:27.000Z" title="发表于 2026-01-11 18:56:27">2026-01-11</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2026-02-28T13:29:12.680Z" title="更新于 2026-02-28 21:29:12">2026-02-28</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/web/">web</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/web/gorm/">gorm</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">8.7k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>38分钟</span></span><span class="post-meta-separator">|</span><span id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="twikoo_visitors"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><div id="post-outdate-notice" data="{&quot;limitDay&quot;:365,&quot;messagePrev&quot;:&quot;It has been&quot;,&quot;messageNext&quot;:&quot;days since the last update, the content of the article may be outdated.&quot;,&quot;postUpdate&quot;:&quot;2026-02-28 21:29:12&quot;}" hidden></div><h1 id="插件系统模块原理说明"><a href="#插件系统模块原理说明" class="headerlink" title="插件系统模块原理说明"></a>插件系统模块原理说明</h1><blockquote>
<p>基于1.31 本文档深入解析插件系统模块的设计原理和核心实现，涵盖扩展机制、插件开发、集成模式等核心内容。</p>
</blockquote>
<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ul>
<li><a href="#%E4%B8%80%E8%AE%BE%E8%AE%A1%E5%8E%9F%E7%90%86">一、设计原理</a><ul>
<li><a href="#11-%E6%A8%A1%E5%9D%97%E5%AE%9A%E4%BD%8D">1.1 模块定位</a></li>
<li><a href="#12-%E8%AE%BE%E8%AE%A1%E7%9B%AE%E7%9A%84">1.2 设计目的</a></li>
<li><a href="#13-%E7%BB%93%E6%9E%84%E5%AE%89%E6%8E%92%E4%BE%9D%E6%8D%AE">1.3 结构安排依据</a></li>
<li><a href="#14-%E4%B8%8E%E5%85%B6%E4%BB%96%E6%A8%A1%E5%9D%97%E7%9A%84%E9%80%BB%E8%BE%91%E5%85%B3%E7%B3%BB">1.4 与其他模块的逻辑关系</a></li>
<li><a href="#15-%E6%8F%92%E4%BB%B6%E7%B1%BB%E5%9E%8B%E5%88%86%E7%B1%BB">1.5 插件类型分类</a></li>
</ul>
</li>
<li><a href="#%E4%BA%8C%E6%A0%B8%E5%BF%83%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84">二、核心数据结构</a><ul>
<li><a href="#21-plugin-%E6%8E%A5%E5%8F%A3">2.1 Plugin 接口</a></li>
<li><a href="#22-config-%E6%8F%92%E4%BB%B6%E5%AD%97%E6%AE%B5">2.2 Config 插件字段</a></li>
<li><a href="#23-use-%E6%96%B9%E6%B3%95">2.3 Use() 方法</a></li>
</ul>
</li>
<li><a href="#%E4%B8%89%E6%A0%B8%E5%BF%83%E5%AE%9E%E7%8E%B0">三、核心实现</a><ul>
<li><a href="#31-%E6%8F%92%E4%BB%B6%E6%B3%A8%E5%86%8C%E6%9C%BA%E5%88%B6">3.1 插件注册机制</a></li>
<li><a href="#32-%E6%8F%92%E4%BB%B6%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B">3.2 插件初始化流程</a></li>
<li><a href="#33-%E5%9B%9E%E8%B0%83%E7%B3%BB%E7%BB%9F%E9%9B%86%E6%88%90">3.3 回调系统集成</a></li>
<li><a href="#34-%E6%8F%92%E4%BB%B6%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86">3.4 插件状态管理</a></li>
</ul>
</li>
<li><a href="#%E5%9B%9B%E5%AE%9E%E6%88%98%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B">四、实战代码示例</a><ul>
<li><a href="#41-%E5%9F%BA%E7%A1%80%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91">4.1 基础插件开发</a></li>
<li><a href="#42-%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB%E6%8F%92%E4%BB%B6">4.2 读写分离插件</a></li>
<li><a href="#43-%E6%9F%A5%E8%AF%A2%E7%BC%93%E5%AD%98%E6%8F%92%E4%BB%B6">4.3 查询缓存插件</a></li>
<li><a href="#44-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E6%8F%92%E4%BB%B6">4.4 性能监控插件</a></li>
<li><a href="#45-%E6%95%B0%E6%8D%AE%E8%84%B1%E6%95%8F%E6%8F%92%E4%BB%B6">4.5 数据脱敏插件</a></li>
</ul>
</li>
<li><a href="#%E4%BA%94%E5%8F%AF%E8%A7%86%E5%8C%96%E6%B5%81%E7%A8%8B%E5%9B%BE">五、可视化流程图</a><ul>
<li><a href="#51-%E6%8F%92%E4%BB%B6%E6%B3%A8%E5%86%8C%E6%B5%81%E7%A8%8B">5.1 插件注册流程</a></li>
<li><a href="#52-%E6%8F%92%E4%BB%B6%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B">5.2 插件初始化流程</a></li>
<li><a href="#53-%E5%9B%9E%E8%B0%83%E9%9B%86%E6%88%90%E6%B5%81%E7%A8%8B">5.3 回调集成流程</a></li>
<li><a href="#54-%E6%8F%92%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84">5.4 插件系统架构</a></li>
</ul>
</li>
<li><a href="#%E5%85%AD%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E4%B8%8E%E6%95%85%E9%9A%9C%E6%8E%92%E6%9F%A5">六、最佳实践与故障排查</a><ul>
<li><a href="#61-%E5%BC%80%E5%8F%91%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">6.1 开发最佳实践</a></li>
<li><a href="#62-%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E4%B8%8E%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88">6.2 常见问题与解决方案</a></li>
<li><a href="#63-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E5%BB%BA%E8%AE%AE">6.3 性能优化建议</a></li>
<li><a href="#64-%E5%AE%89%E5%85%A8%E5%BB%BA%E8%AE%AE">6.4 安全建议</a></li>
</ul>
</li>
<li><a href="#%E4%B8%83%E5%AD%A6%E4%B9%A0%E9%AA%8C%E8%AF%81">七、学习验证</a><ul>
<li><a href="#71-%E7%9F%A5%E8%AF%86%E8%87%AA%E6%B5%8B">7.1 知识自测</a></li>
<li><a href="#72-%E5%AE%9E%E8%B7%B5%E7%BB%83%E4%B9%A0">7.2 实践练习</a></li>
</ul>
</li>
</ul>
<hr>
<h2 id="一、设计原理"><a href="#一、设计原理" class="headerlink" title="一、设计原理"></a>一、设计原理</h2><h3 id="1-1-模块定位"><a href="#1-1-模块定位" class="headerlink" title="1.1 模块定位"></a>1.1 模块定位</h3><p><strong>在整体架构中的位置</strong></p>
<p>插件系统是 GORM 的扩展机制，位于应用层和核心层之间，允许在不修改核心代码的情况下添加功能。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                        应用层 (用户代码)                              │</span><br><span class="line">│  db.Use(&amp;ReadWritePlugin&#123;&#125;)                                         │</span><br><span class="line">│  db.Use(&amp;PrometheusPlugin&#123;&#125;)                                        │</span><br><span class="line">│  db.Use(&amp;CachePlugin&#123;&#125;)                                             │</span><br><span class="line">└──────────────────────────────┬──────────────────────────────────────┘</span><br><span class="line">                               │</span><br><span class="line">                               ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                      插件系统 (本模块) ★                              │</span><br><span class="line">│                                                                     │</span><br><span class="line">│  ┌─────────────────────────────────────────────────────────────┐   │</span><br><span class="line">│  │                   DB.Use() 入口                              │   │</span><br><span class="line">│  │                                                             │   │</span><br><span class="line">│  │    func (db *DB) Use(plugin Plugin) error &#123;                 │   │</span><br><span class="line">│  │        name := plugin.Name()                                │   │</span><br><span class="line">│  │        db.Config.Plugins[name] = plugin                     │   │</span><br><span class="line">│  │        return plugin.Initialize(db)                         │   │</span><br><span class="line">│  │    &#125;                                                        │   │</span><br><span class="line">│  └─────────────────────────────────────────────────────────────┘   │</span><br><span class="line">│                                  │                                  │</span><br><span class="line">│                                  ▼                                  │</span><br><span class="line">│  ┌─────────────────────────────────────────────────────────────┐   │</span><br><span class="line">│  │                  Plugin 接口定义                             │   │</span><br><span class="line">│  │                                                             │   │</span><br><span class="line">│  │    type Plugin interface &#123;                                   │   │</span><br><span class="line">│  │        Name() string                                        │   │</span><br><span class="line">│  │        Initialize(*DB) error                                │   │</span><br><span class="line">│  │    &#125;                                                        │   │</span><br><span class="line">│  └─────────────────────────────────────────────────────────────┘   │</span><br><span class="line">│                                  │                                  │</span><br><span class="line">│                                  ▼                                  │</span><br><span class="line">│  ┌─────────────────────────────────────────────────────────────┐   │</span><br><span class="line">│  │                   插件存储与管理                             │   │</span><br><span class="line">│  │                                                             │   │</span><br><span class="line">│  │    type Config struct &#123;                                     │   │</span><br><span class="line">│  │        Plugins map[string]Plugin  // 插件注册表             │   │</span><br><span class="line">│  │        ...                                                   │   │</span><br><span class="line">│  │    &#125;                                                        │   │</span><br><span class="line">│  └─────────────────────────────────────────────────────────────┘   │</span><br><span class="line">└──────────────────────────────┬──────────────────────────────────────┘</span><br><span class="line">                               │</span><br><span class="line">                               ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                        核心回调系统                                  │</span><br><span class="line">│                      (callbacks/callbacks.go)                       │</span><br><span class="line">│                                                                     │</span><br><span class="line">│  插件通过注册回调实现功能扩展：                                       │</span><br><span class="line">│  - db.Callback().Create().Before(&quot;gorm:create&quot;).Register(...)       │</span><br><span class="line">│  - db.Callback().Query().After(&quot;gorm:query&quot;).Register(...)          │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<p><strong>与其他模块的逻辑关系</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────┐</span><br><span class="line">│   Config 模块    │ ← 存储 Plugins map</span><br><span class="line">│  配置管理        │</span><br><span class="line">└────────┬────────┘</span><br><span class="line">         │</span><br><span class="line">         ▼</span><br><span class="line">┌─────────────────┐</span><br><span class="line">│   Plugin 模块    │ ← 提供扩展接口</span><br><span class="line">│  插件系统        │</span><br><span class="line">└────────┬────────┘</span><br><span class="line">         │</span><br><span class="line">         ├──────────────────┐</span><br><span class="line">         │                  │</span><br><span class="line">         ▼                  ▼</span><br><span class="line">┌─────────────────┐  ┌─────────────────┐</span><br><span class="line">│  Callback 模块  │  │  Statement 模块 │</span><br><span class="line">│  回调钩子        │  │  语句构建        │</span><br><span class="line">└─────────────────┘  └─────────────────┘</span><br><span class="line">         │                  │</span><br><span class="line">         └──────────┬───────┘</span><br><span class="line">                    ▼</span><br><span class="line">         ┌────────────────────┐</span><br><span class="line">         │   插件扩展功能      │</span><br><span class="line">         │  - 读写分离         │</span><br><span class="line">         │  - 查询缓存         │</span><br><span class="line">         │  - 性能监控         │</span><br><span class="line">         │  - 数据脱敏         │</span><br><span class="line">         └────────────────────┘</span><br></pre></td></tr></table></figure>

<h3 id="1-2-设计目的"><a href="#1-2-设计目的" class="headerlink" title="1.2 设计目的"></a>1.2 设计目的</h3><p><strong>核心问题</strong>: 如何在不修改核心代码的情况下扩展 GORM 功能？</p>
<p><strong>问题分析</strong>:</p>
<ol>
<li><strong>封闭性问题</strong>: GORM 核心代码需要保持稳定，不能频繁修改</li>
<li><strong>扩展性问题</strong>: 不同用户有不同的功能需求</li>
<li><strong>集成性问题</strong>: 扩展功能需要与核心系统无缝集成</li>
<li><strong>维护性问题</strong>: 扩展代码应该易于开发和维护</li>
</ol>
<p><strong>解决方案</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                     问题 1: 封闭性                               │</span><br><span class="line">├─────────────────────────────────────────────────────────────────┤</span><br><span class="line">│ 解决方案: 定义稳定的 Plugin 接口                                 │</span><br><span class="line">│                                                                  │</span><br><span class="line">│   type Plugin interface &#123;                                        │</span><br><span class="line">│       Name() string        // 插件标识                           │</span><br><span class="line">│       Initialize(*DB) error // 初始化入口                        │</span><br><span class="line">│   &#125;                                                             │</span><br><span class="line">│                                                                  │</span><br><span class="line">│ 优势:                                                            │</span><br><span class="line">│ • 核心代码只依赖接口，不依赖具体实现                               │</span><br><span class="line">│ • 接口定义稳定，向后兼容                                           │</span><br><span class="line">│ • 插件开发遵循统一规范                                            │</span><br><span class="line">└─────────────────────────────────────────────────────────────────┘</span><br><span class="line"></span><br><span class="line">┌─────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                     问题 2: 扩展性                               │</span><br><span class="line">├─────────────────────────────────────────────────────────────────┤</span><br><span class="line">│ 解决方案: 支持注册多个插件                                        │</span><br><span class="line">│                                                                  │</span><br><span class="line">│   db.Use(&amp;ReadWritePlugin&#123;&#125;)                                     │</span><br><span class="line">│   db.Use(&amp;CachePlugin&#123;&#125;)                                         │</span><br><span class="line">│   db.Use(&amp;PrometheusPlugin&#123;&#125;)                                    │</span><br><span class="line">│                                                                  │</span><br><span class="line">│ 优势:                                                            │</span><br><span class="line">│ • 可以同时使用多个插件                                             │</span><br><span class="line">│ • 插件之间相互独立                                                │</span><br><span class="line">│ • 插件可以灵活组合                                                │</span><br><span class="line">└─────────────────────────────────────────────────────────────────┘</span><br><span class="line"></span><br><span class="line">┌─────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                     问题 3: 集成性                               │</span><br><span class="line">├─────────────────────────────────────────────────────────────────┤</span><br><span class="line">│ 解决方案: 通过回调系统集成                                         │</span><br><span class="line">│                                                                  │</span><br><span class="line">│   func (p *MyPlugin) Initialize(db *gorm.DB) error &#123;             │</span><br><span class="line">│       db.Callback().Query().Before(&quot;gorm:query&quot;)                 │</span><br><span class="line">│           .Register(&quot;myplugin:cache&quot;, p.cacheHandler)            │</span><br><span class="line">│       return nil                                                 │</span><br><span class="line">│   &#125;                                                              │</span><br><span class="line">│                                                                  │</span><br><span class="line">│ 优势:                                                            │</span><br><span class="line">│ • 无缝集成到 GORM 执行流程                                         │</span><br><span class="line">│ • 可以拦截和修改任何操作                                           │</span><br><span class="line">│ • 支持before/after/replace 等多种集成方式                          │</span><br><span class="line">└─────────────────────────────────────────────────────────────────┘</span><br><span class="line"></span><br><span class="line">┌─────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                     问题 4: 维护性                               │</span><br><span class="line">├─────────────────────────────────────────────────────────────────┤</span><br><span class="line">│ 解决方案: 提供清晰的开发模式和最佳实践                              │</span><br><span class="line">│                                                                  │</span><br><span class="line">│ 1. 明确的插件生命周期                                              │</span><br><span class="line">│ 2. 可靠的初始化机制                                                │</span><br><span class="line">│ 3. 灵活的配置方式                                                 │</span><br><span class="line">│ 4. 完善的错误处理                                                 │</span><br><span class="line">└─────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h3 id="1-3-结构安排依据"><a href="#1-3-结构安排依据" class="headerlink" title="1.3 结构安排依据"></a>1.3 结构安排依据</h3><p><strong>模块职责划分</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">插件系统的职责边界：</span><br><span class="line"></span><br><span class="line">┌────────────────────────────────────────────────────────────┐</span><br><span class="line">│                  插件系统负责                               │</span><br><span class="line">│  ┌──────────────────────────────────────────────────────┐  │</span><br><span class="line">│  │ 1. 插件接口定义 (Plugin interface)                    │  │</span><br><span class="line">│  │ 2. 插件注册机制 (DB.Use)                              │  │</span><br><span class="line">│  │ 3. 插件存储管理 (Config.Plugins)                      │  │</span><br><span class="line">│  │ 4. 插件初始化流程 (Initialize)                        │  │</span><br><span class="line">│  └──────────────────────────────────────────────────────┘  │</span><br><span class="line">└────────────────────────────────────────────────────────────┘</span><br><span class="line"></span><br><span class="line">┌────────────────────────────────────────────────────────────┐</span><br><span class="line">│                回调系统负责 (不归插件系统)                   │</span><br><span class="line">│  ┌──────────────────────────────────────────────────────┐  │</span><br><span class="line">│  │ 1. 回调注册 (Callback.Register)                       │  │</span><br><span class="line">│  │ 2. 回调执行 (Processor.Execute)                       │  │</span><br><span class="line">│  │ 3. 回调排序 (before/after/replace)                    │  │</span><br><span class="line">│  │ 4. 回调链管理                                          │  │</span><br><span class="line">│  └──────────────────────────────────────────────────────┘  │</span><br><span class="line">└────────────────────────────────────────────────────────────┘</span><br><span class="line"></span><br><span class="line">┌────────────────────────────────────────────────────────────┐</span><br><span class="line">│                具体插件负责 (不归插件系统)                   │</span><br><span class="line">│  ┌──────────────────────────────────────────────────────┐  │</span><br><span class="line">│  │ 1. 具体功能实现                                        │  │</span><br><span class="line">│  │ 2. 业务逻辑处理                                        │  │</span><br><span class="line">│  │ 3. 数据存储管理                                        │  │</span><br><span class="line">│  │ 4. 错误处理恢复                                        │  │</span><br><span class="line">│  └──────────────────────────────────────────────────────┘  │</span><br><span class="line">└────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<p><strong>关键数据结构</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 插件接口定义 (gorm.go)</span></span><br><span class="line"><span class="keyword">type</span> Plugin <span class="keyword">interface</span> &#123;</span><br><span class="line">    Name() <span class="type">string</span>        <span class="comment">// 插件唯一标识</span></span><br><span class="line">    Initialize(*DB) <span class="type">error</span> <span class="comment">// 插件初始化</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置结构 (gorm.go)</span></span><br><span class="line"><span class="keyword">type</span> Config <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// ... 其他配置</span></span><br><span class="line"></span><br><span class="line">    Plugins <span class="keyword">map</span>[<span class="type">string</span>]Plugin <span class="comment">// 插件注册表</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// DB 结构 (gorm.go)</span></span><br><span class="line"><span class="keyword">type</span> DB <span class="keyword">struct</span> &#123;</span><br><span class="line">    Config *Config <span class="comment">// 嵌入配置</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ... 其他字段</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 插件注册方法 (finisher_api.go)</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> Use(plugin Plugin) <span class="type">error</span> &#123;</span><br><span class="line">    name := plugin.Name()</span><br><span class="line">    <span class="keyword">if</span> db.Config.Plugins == <span class="literal">nil</span> &#123;</span><br><span class="line">        db.Config.Plugins = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]Plugin)</span><br><span class="line">    &#125;</span><br><span class="line">    db.Config.Plugins[name] = plugin</span><br><span class="line">    <span class="keyword">return</span> plugin.Initialize(db)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>依赖关系分析</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">插件系统的依赖：</span><br><span class="line"></span><br><span class="line">                ┌──────────┐</span><br><span class="line">                │  Config  │ ← 被依赖</span><br><span class="line">                └────┬─────┘</span><br><span class="line">                     │</span><br><span class="line">        ┌────────────┴────────────┐</span><br><span class="line">        │                         │</span><br><span class="line">        ▼                         ▼</span><br><span class="line">┌───────────────┐         ┌───────────────┐</span><br><span class="line">│    Plugin     │         │      DB       │</span><br><span class="line">│   (interface) │────────▶│   (struct)    │</span><br><span class="line">└───────────────┘         └───────┬───────┘</span><br><span class="line">                                 │</span><br><span class="line">                                 ▼</span><br><span class="line">                        ┌───────────────┐</span><br><span class="line">                        │ DB.Use()      │</span><br><span class="line">                        │  方法         │</span><br><span class="line">                        └───────┬───────┘</span><br><span class="line">                                │</span><br><span class="line">                                ▼</span><br><span class="line">                        ┌───────────────┐</span><br><span class="line">                        │  Initialize   │</span><br><span class="line">                        │   调用        │</span><br><span class="line">                        └───────────────┘</span><br><span class="line"></span><br><span class="line">插件系统被依赖：</span><br><span class="line"></span><br><span class="line">                ┌──────────┐</span><br><span class="line">                │  Plugin  │ ← 接口被实现</span><br><span class="line">                └────┬─────┘</span><br><span class="line">                     │</span><br><span class="line">                     ▼</span><br><span class="line">        ┌────────────────────────────┐</span><br><span class="line">        │     各种具体插件实现         │</span><br><span class="line">        │  - ReadWritePlugin         │</span><br><span class="line">        │  - CachePlugin             │</span><br><span class="line">        │  - PrometheusPlugin        │</span><br><span class="line">        │  - ...                     │</span><br><span class="line">        └────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h3 id="1-4-与其他模块的逻辑关系"><a href="#1-4-与其他模块的逻辑关系" class="headerlink" title="1.4 与其他模块的逻辑关系"></a>1.4 与其他模块的逻辑关系</h3><p><strong>与 Callback 模块的关系</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│                    关系: 协作集成                            │</span><br><span class="line">├─────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                              │</span><br><span class="line">│  Plugin 模块                Callback 模块                   │</span><br><span class="line">│  ┌──────────────┐           ┌──────────────┐               │</span><br><span class="line">│  │   Plugin     │           │  Callback    │               │</span><br><span class="line">│  │  接口定义     │           │  系统实现     │               │</span><br><span class="line">│  └──────┬───────┘           └──────▲───────┘               │</span><br><span class="line">│         │                           │                        │</span><br><span class="line">│         │ Initialize()              │                        │</span><br><span class="line">│         │    中                     │                        │</span><br><span class="line">│         │    注册回调 ───────────────┘                        │</span><br><span class="line">│         │                           │                        │</span><br><span class="line">│         │                   ┌───────┴────────┐              │</span><br><span class="line">│         │                   │                │              │</span><br><span class="line">│         ▼                   ▼                ▼              │</span><br><span class="line">│  ┌──────────────┐   ┌──────────────┐ ┌──────────────┐     │</span><br><span class="line">│  │ 插件 A       │   │ Create回调   │ │ Query回调    │     │</span><br><span class="line">│  │ (功能实现)   │   │              │ │              │     │</span><br><span class="line">│  └──────────────┘   └──────────────┘ └──────────────┘     │</span><br><span class="line">│                                                              │</span><br><span class="line">│  协作模式: Plugin 通过 Callback 实现                          │</span><br><span class="line">│  1. Plugin.Initialize() 获取 DB 实例                          │</span><br><span class="line">│  2. 通过 db.Callback() 注册回调                               │</span><br><span class="line">│  3. 回调执行时调用 Plugin 的处理逻辑                           │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<p><strong>与 Statement 模块的关系</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│                    关系: 数据访问                            │</span><br><span class="line">├─────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                              │</span><br><span class="line">│  Plugin 模块                Statement 模块                  │</span><br><span class="line">│  ┌──────────────┐           ┌──────────────┐               │</span><br><span class="line">│  │   Plugin    │           │  Statement   │               │</span><br><span class="line">│  │  (扩展逻辑)  │           │ (查询上下文)  │               │</span><br><span class="line">│  └──────┬───────┘           └──────▲───────┘               │</span><br><span class="line">│         │                           │                        │</span><br><span class="line">│         │ 回调中访问                 │                        │</span><br><span class="line">│         │    ◀──────────────────────┘                        │</span><br><span class="line">│         │                           │                        │</span><br><span class="line">│         │                   ┌───────┴────────┐              │</span><br><span class="line">│         │                   │                │              │</span><br><span class="line">│         ▼                   ▼                ▼              │</span><br><span class="line">│  ┌──────────────┐   ┌──────────────┐ ┌──────────────┐     │</span><br><span class="line">│  │ 读取 Statement│  │ SQL.Builder  │ │  Vars        │     │</span><br><span class="line">│  │ 修改查询参数  │   │              │ │              │     │</span><br><span class="line">│  └──────────────┘   └──────────────┘ └──────────────┘     │</span><br><span class="line">│                                                              │</span><br><span class="line">│  访问模式:                                                    │</span><br><span class="line">│  func (p *MyPlugin) handler(db *gorm.DB) &#123;                   │</span><br><span class="line">│      stmt := db.Statement                                     │</span><br><span class="line">│      // 访问 stmt.Table, stmt.Model, stmt.Clauses 等          │</span><br><span class="line">│  &#125;                                                            │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<p><strong>与 Logger 模块的关系</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│                    关系: 辅助调试                            │</span><br><span class="line">├─────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                              │</span><br><span class="line">│  Plugin 模块                Logger 模块                     │</span><br><span class="line">│  ┌──────────────┐           ┌──────────────┐               │</span><br><span class="line">│  │   Plugin    │           │   Logger     │               │</span><br><span class="line">│  │  (业务逻辑)  │           │  (日志记录)   │               │</span><br><span class="line">│  └──────┬───────┘           └──────▲───────┘               │</span><br><span class="line">│         │                           │                        │</span><br><span class="line">│         │ 调用 logger               │                        │</span><br><span class="line">│         │    ──────────────────────┘                         │</span><br><span class="line">│         │                           │                        │</span><br><span class="line">│         │                   ┌───────┴────────┐              │</span><br><span class="line">│         │                   │                │              │</span><br><span class="line">│         ▼                   ▼                ▼              │</span><br><span class="line">│  ┌──────────────┐   ┌──────────────┐ ┌──────────────┐     │</span><br><span class="line">│  │ 记录插件状态  │   │ Info/Error   │ │ Slow Query   │     │</span><br><span class="line">│  │ 调试插件行为  │   │              │ │              │     │</span><br><span class="line">│  └──────────────┘   └──────────────┘ └──────────────┘     │</span><br><span class="line">│                                                              │</span><br><span class="line">│  使用模式:                                                    │</span><br><span class="line">│  func (p *MyPlugin) Initialize(db *gorm.DB) error &#123;           │</span><br><span class="line">│      logger := db.Logger                                      │</span><br><span class="line">│      logger.Info(context.Background(), &quot;plugin initialized&quot;)  │</span><br><span class="line">│      return nil                                               │</span><br><span class="line">│  &#125;                                                            │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h3 id="1-5-插件类型分类"><a href="#1-5-插件类型分类" class="headerlink" title="1.5 插件类型分类"></a>1.5 插件类型分类</h3><p><strong>按功能分类</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│                      功能增强型插件                           │</span><br><span class="line">├─────────────────────────────────────────────────────────────┤</span><br><span class="line">│  目的: 添加 GORM 核心没有的功能                               │</span><br><span class="line">│                                                              │</span><br><span class="line">│  示例:                                                       │</span><br><span class="line">│  ┌─────────────────────────────────────────────────────┐    │</span><br><span class="line">│  │ 读写分离插件 (ReadWritePlugin)                        │    │</span><br><span class="line">│  │ • 自动路由读操作到从库                                  │    │</span><br><span class="line">│  │ • 路由写操作到主库                                      │    │</span><br><span class="line">│  │ • 支持负载均衡                                          │    │</span><br><span class="line">│  └─────────────────────────────────────────────────────┘    │</span><br><span class="line">│  ┌─────────────────────────────────────────────────────┐    │</span><br><span class="line">│  │ 查询缓存插件 (CachePlugin)                            │    │</span><br><span class="line">│  │ • 缓存查询结果                                          │    │</span><br><span class="line">│  │ • 自动失效管理                                          │    │</span><br><span class="line">│  │ • 支持分布式缓存                                        │    │</span><br><span class="line">│  └─────────────────────────────────────────────────────┘    │</span><br><span class="line">│  ┌─────────────────────────────────────────────────────┐    │</span><br><span class="line">│  │ 软删除插件 (SoftDeletePlugin)                         │    │</span><br><span class="line">│  │ • 自动过滤已删除记录                                    │    │</span><br><span class="line">│  │ • 支持恢复操作                                          │    │</span><br><span class="line">│  │ • 记录删除时间                                          │    │</span><br><span class="line">│  └─────────────────────────────────────────────────────┘    │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br><span class="line"></span><br><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│                      行为修改型插件                           │</span><br><span class="line">├─────────────────────────────────────────────────────────────┤</span><br><span class="line">│  目的: 修改 GORM 的默认行为                                   │</span><br><span class="line">│                                                              │</span><br><span class="line">│  示例:                                                       │</span><br><span class="line">│  ┌─────────────────────────────────────────────────────┐    │</span><br><span class="line">│  │ SQL 重写插件 (SQLRewritePlugin)                       │    │</span><br><span class="line">│  │ • 修改生成的 SQL                                        │    │</span><br><span class="line">│  │ • 添加查询提示                                          │    │</span><br><span class="line">│  │ • 优化执行计划                                          │    │</span><br><span class="line">│  └─────────────────────────────────────────────────────┘    │</span><br><span class="line">│  ┌─────────────────────────────────────────────────────┐    │</span><br><span class="line">│  │ 数据脱敏插件 (DataMaskingPlugin)                      │    │</span><br><span class="line">│  │ • 自动脱敏敏感字段                                      │    │</span><br><span class="line">│  │ • 基于角色的脱敏                                        │    │</span><br><span class="line">│  │ • 审计日志记录                                          │    │</span><br><span class="line">│  └─────────────────────────────────────────────────────┘    │</span><br><span class="line">│  ┌─────────────────────────────────────────────────────┐    │</span><br><span class="line">│  │ 字段加密插件 (FieldEncryptionPlugin)                   │    │</span><br><span class="line">│  │ • 自动加密敏感字段                                      │    │</span><br><span class="line">│  │ • 透明解密读取                                          │    │</span><br><span class="line">│  │ • 支持多种加密算法                                      │    │</span><br><span class="line">│  └─────────────────────────────────────────────────────┘    │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br><span class="line"></span><br><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│                      监控审计型插件                           │</span><br><span class="line">├─────────────────────────────────────────────────────────────┤</span><br><span class="line">│  目的: 记录和分析数据库操作                                   │</span><br><span class="line">│                                                              │</span><br><span class="line">│  示例:                                                       │</span><br><span class="line">│  ┌─────────────────────────────────────────────────────┐    │</span><br><span class="line">│  │ 性能监控插件 (PrometheusPlugin)                       │    │</span><br><span class="line">│  │ • 记录查询耗时                                          │    │</span><br><span class="line">│  │ • 统计慢查询                                            │    │</span><br><span class="line">│  │ • 导出监控指标                                          │    │</span><br><span class="line">│  └─────────────────────────────────────────────────────┘    │</span><br><span class="line">│  ┌─────────────────────────────────────────────────────┐    │</span><br><span class="line">│  │ 审计日志插件 (AuditLogPlugin)                         │    │</span><br><span class="line">│  │ • 记录所有操作                                          │    │</span><br><span class="line">│  │ • 追踪数据变更                                          │    │</span><br><span class="line">│  │ • 支持合规要求                                          │    │</span><br><span class="line">│  └─────────────────────────────────────────────────────┘    │</span><br><span class="line">│  ┌─────────────────────────────────────────────────────┐    │</span><br><span class="line">│  │ 慢查询分析插件 (SlowQueryPlugin)                      │    │</span><br><span class="line">│  │ • 检测慢查询                                            │    │</span><br><span class="line">│  │ • 分析执行计划                                          │    │</span><br><span class="line">│  │ • 提供优化建议                                          │    │</span><br><span class="line">│  └─────────────────────────────────────────────────────┘    │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br><span class="line"></span><br><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│                      性能优化型插件                           │</span><br><span class="line">├─────────────────────────────────────────────────────────────┤</span><br><span class="line">│  目的: 提升数据库操作性能                                     │</span><br><span class="line">│                                                              │</span><br><span class="line">│  示例:                                                       │</span><br><span class="line">│  ┌─────────────────────────────────────────────────────┐    │</span><br><span class="line">│  │ 批量操作插件 (BatchPlugin)                            │    │</span><br><span class="line">│  │ • 自动批量插入                                          │    │</span><br><span class="line">│  │ • 批量更新优化                                          │    │</span><br><span class="line">│  │ • 减少网络往返                                          │    │</span><br><span class="line">│  └─────────────────────────────────────────────────────┘    │</span><br><span class="line">│  ┌─────────────────────────────────────────────────────┐    │</span><br><span class="line">│  │ 连接池优化插件 (ConnPoolPlugin)                       │    │</span><br><span class="line">│  │ • 动态调整连接池大小                                    │    │</span><br><span class="line">│  │ • 连接预热                                              │    │</span><br><span class="line">│  │ • 连接健康检查                                          │    │</span><br><span class="line">│  └─────────────────────────────────────────────────────┘    │</span><br><span class="line">│  ┌─────────────────────────────────────────────────────┐    │</span><br><span class="line">│  │ 查询优化插件 (QueryOptimizerPlugin)                   │    │</span><br><span class="line">│  │ • 自动添加索引提示                                      │    │</span><br><span class="line">│  │ • 优化 JOIN 顺序                                        │    │</span><br><span class="line">│  │ • 减少子查询                                            │    │</span><br><span class="line">│  └─────────────────────────────────────────────────────┘    │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<p><strong>按集成方式分类</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│                    Before 回调插件                           │</span><br><span class="line">├─────────────────────────────────────────────────────────────┤</span><br><span class="line">│  在 GORM 操作之前执行                                         │</span><br><span class="line">│                                                              │</span><br><span class="line">│  func (p *Plugin) Initialize(db *gorm.DB) error &#123;            │</span><br><span class="line">│      db.Callback().Create().Before(&quot;gorm:create&quot;)            │</span><br><span class="line">│          .Register(&quot;plugin:before&quot;, p.beforeCreate)          │</span><br><span class="line">│      return nil                                              │</span><br><span class="line">│  &#125;                                                            │</span><br><span class="line">│                                                              │</span><br><span class="line">│  用途: 参数验证、数据预处理、权限检查                          │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br><span class="line"></span><br><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│                    After 回调插件                            │</span><br><span class="line">├─────────────────────────────────────────────────────────────┤</span><br><span class="line">│  在 GORM 操作之后执行                                         │</span><br><span class="line">│                                                              │</span><br><span class="line">│  func (p *Plugin) Initialize(db *gorm.DB) error &#123;            │</span><br><span class="line">│      db.Callback().Query().After(&quot;gorm:query&quot;)               │</span><br><span class="line">│          .Register(&quot;plugin:after&quot;, p.afterQuery)             │</span><br><span class="line">│      return nil                                              │</span><br><span class="line">│  &#125;                                                            │</span><br><span class="line">│                                                              │</span><br><span class="line">│  用途: 结果处理、缓存更新、日志记录                            │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br><span class="line"></span><br><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│                   Replace 回调插件                           │</span><br><span class="line">├─────────────────────────────────────────────────────────────┤</span><br><span class="line">│  替换 GORM 的默认操作                                         │</span><br><span class="line">│                                                              │</span><br><span class="line">│  func (p *Plugin) Initialize(db *gorm.DB) error &#123;            │</span><br><span class="line">│      db.Callback().Create().Replace(&quot;gorm:create&quot;)           │</span><br><span class="line">│          .Register(&quot;plugin:replace&quot;, p.replaceCreate)        │</span><br><span class="line">│      return nil                                              │</span><br><span class="line">│  &#125;                                                            │</span><br><span class="line">│                                                              │</span><br><span class="line">│  用途: 自定义实现、功能替换、性能优化                          │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="二、核心数据结构"><a href="#二、核心数据结构" class="headerlink" title="二、核心数据结构"></a>二、核心数据结构</h2><h3 id="2-1-Plugin-接口"><a href="#2-1-Plugin-接口" class="headerlink" title="2.1 Plugin 接口"></a>2.1 Plugin 接口</h3><p><strong>源码定义</strong> (interfaces.go:23-27)</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Plugin GORM plugin interface</span></span><br><span class="line"><span class="comment">// Plugin 是 GORM 插件的接口定义</span></span><br><span class="line"><span class="keyword">type</span> Plugin <span class="keyword">interface</span> &#123;</span><br><span class="line">    Name() <span class="type">string</span>        <span class="comment">// 返回插件唯一标识</span></span><br><span class="line">    Initialize(*DB) <span class="type">error</span> <span class="comment">// 插件初始化</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>接口设计原则</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│                    Name() 方法                               │</span><br><span class="line">├─────────────────────────────────────────────────────────────┤</span><br><span class="line">│  目的: 提供插件的唯一标识                                      │</span><br><span class="line">│                                                              │</span><br><span class="line">│  设计要求:                                                   │</span><br><span class="line">│  1. 必须唯一 - 同名插件会被覆盖                                │</span><br><span class="line">│  2. 应当有意义 - 反映插件功能                                  │</span><br><span class="line">│  3. 使用命名空间 - 避免冲突 (如 &quot;cache:redis&quot;)                │</span><br><span class="line">│                                                              │</span><br><span class="line">│  示例:                                                       │</span><br><span class="line">│  func (p *CachePlugin) Name() string &#123;                       │</span><br><span class="line">│      return &quot;cache:redis&quot;                                    │</span><br><span class="line">│  &#125;                                                            │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br><span class="line"></span><br><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│                  Initialize() 方法                           │</span><br><span class="line">├─────────────────────────────────────────────────────────────┤</span><br><span class="line">│  目的: 初始化插件并与 GORM 集成                                │</span><br><span class="line">│                                                              │</span><br><span class="line">│  设计要求:                                                   │</span><br><span class="line">│  1. 接收 *DB 参数 - 访问 GORM 实例                            │</span><br><span class="line">│  2. 返回 error - 初始化失败时报告错误                          │</span><br><span class="line">│  3. 幂等性 - 多次调用不会产生副作用                            │</span><br><span class="line">│                                                              │</span><br><span class="line">│  常见操作:                                                   │</span><br><span class="line">│  • 注册回调                                                   │</span><br><span class="line">│  • 初始化插件状态                                              │</span><br><span class="line">│  • 配置插件参数                                                │</span><br><span class="line">│  • 建立外部连接                                                │</span><br><span class="line">│                                                              │</span><br><span class="line">│  示例:                                                       │</span><br><span class="line">│  func (p *CachePlugin) Initialize(db *gorm.DB) error &#123;       │</span><br><span class="line">│      // 注册 Query 回调                                        │</span><br><span class="line">│      db.Callback().Query().Before(&quot;gorm:query&quot;)              │</span><br><span class="line">│          .Register(&quot;cache:query&quot;, p.queryHandler)            │</span><br><span class="line">│                                                              │</span><br><span class="line">│      // 注册 Create 回调                                      │</span><br><span class="line">│      db.Callback().Create().After(&quot;gorm:create&quot;)             │</span><br><span class="line">│          .Register(&quot;cache:invalidate&quot;, p.invalidateHandler)  │</span><br><span class="line">│                                                              │</span><br><span class="line">│      // 初始化缓存客户端                                       │</span><br><span class="line">│      p.client = redis.NewClient(p.redisConfig)               │</span><br><span class="line">│                                                              │</span><br><span class="line">│      return nil                                              │</span><br><span class="line">│  &#125;                                                            │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h4 id="概念-2-插件注册"><a href="#概念-2-插件注册" class="headerlink" title="概念 2: 插件注册"></a>概念 2: 插件注册</h4><p><strong>注册流程</strong> (finisher_api.go:799-806)</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Use 注册插件到 GORM</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> Use(plugin Plugin) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="comment">// 1. 获取插件名称</span></span><br><span class="line">    name := plugin.Name()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 初始化插件存储</span></span><br><span class="line">    <span class="keyword">if</span> db.Config.Plugins == <span class="literal">nil</span> &#123;</span><br><span class="line">        db.Config.Plugins = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]Plugin)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 存储插件</span></span><br><span class="line">    db.Config.Plugins[name] = plugin</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. 初始化插件</span></span><br><span class="line">    <span class="keyword">return</span> plugin.Initialize(db)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>详细流程图</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">                用户代码</span><br><span class="line">                   │</span><br><span class="line">                   ▼</span><br><span class="line">          ┌────────────────┐</span><br><span class="line">          │  db.Use(&amp;...)  │</span><br><span class="line">          └────────┬───────┘</span><br><span class="line">                   │</span><br><span class="line">                   ▼</span><br><span class="line">    ┌────────────────────────────┐</span><br><span class="line">    │   1. 获取插件名称           │</span><br><span class="line">    │   name := plugin.Name()    │</span><br><span class="line">    └─────────────┬──────────────┘</span><br><span class="line">                  │</span><br><span class="line">                  ▼</span><br><span class="line">    ┌────────────────────────────┐</span><br><span class="line">    │   2. 检查/创建存储         │</span><br><span class="line">    │   if Plugins == nil &#123;      │</span><br><span class="line">    │       Plugins = make(...)  │</span><br><span class="line">    │   &#125;                        │</span><br><span class="line">    └─────────────┬──────────────┘</span><br><span class="line">                  │</span><br><span class="line">                  ▼</span><br><span class="line">    ┌────────────────────────────┐</span><br><span class="line">    │   3. 存储插件实例           │</span><br><span class="line">    │   Plugins[name] = plugin   │</span><br><span class="line">    └─────────────┬──────────────┘</span><br><span class="line">                  │</span><br><span class="line">                  ▼</span><br><span class="line">    ┌────────────────────────────┐</span><br><span class="line">    │   4. 调用 Initialize       │</span><br><span class="line">    │   return plugin.Initialize │</span><br><span class="line">    └─────────────┬──────────────┘</span><br><span class="line">                  │</span><br><span class="line">          ┌───────┴────────┐</span><br><span class="line">          │                │</span><br><span class="line">          ▼                ▼</span><br><span class="line">     成功                失败</span><br><span class="line">          │                │</span><br><span class="line">          ▼                ▼</span><br><span class="line">┌──────────────┐    ┌──────────────┐</span><br><span class="line">│ 插件可用     │    │ 返回 error   │</span><br><span class="line">└──────────────┘    └──────────────┘</span><br></pre></td></tr></table></figure>

<p><strong>注册时机</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│                      推荐时机                                │</span><br><span class="line">├─────────────────────────────────────────────────────────────┤</span><br><span class="line">│  1. 数据库打开之后立即注册                                     │</span><br><span class="line">│                                                              │</span><br><span class="line">│     db, err := gorm.Open(postgres.Open(dsn), &amp;gorm.Config&#123;&#125;) │</span><br><span class="line">│     if err != nil &#123;                                          │</span><br><span class="line">│         panic(err)                                           │</span><br><span class="line">│     &#125;                                                        │</span><br><span class="line">│                                                              │</span><br><span class="line">│     // 立即注册插件                                           │</span><br><span class="line">│     db.Use(&amp;ReadWritePlugin&#123;&#125;)                               │</span><br><span class="line">│     db.Use(&amp;CachePlugin&#123;&#125;)                                   │</span><br><span class="line">│                                                              │</span><br><span class="line">│  优势:                                                       │</span><br><span class="line">│  • 确保所有操作都受插件影响                                    │</span><br><span class="line">│  • 插件状态在整个生命周期中一致                                │</span><br><span class="line">│  • 避免遗漏某些操作                                           │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br><span class="line"></span><br><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│                      需要注意                                │</span><br><span class="line">├─────────────────────────────────────────────────────────────┤</span><br><span class="line">│  1. 插件注册顺序                                              │</span><br><span class="line">│     • 后注册的插件可能覆盖先注册的回调                         │</span><br><span class="line">│     • 需要考虑插件之间的依赖关系                               │</span><br><span class="line">│                                                              │</span><br><span class="line">│  2. Session 和 Clone                                         │</span><br><span class="line">│     • 插件注册会影响整个 DB 实例                              │</span><br><span class="line">│     • db.Session() 创建的新 session 继承插件                   │</span><br><span class="line">│     • db.Clone() 保持插件配置                                 │</span><br><span class="line">│                                                              │</span><br><span class="line">│  3. 插件冲突                                                  │</span><br><span class="line">│     • 相同名称的插件会被覆盖                                   │</span><br><span class="line">│     • 回调名称冲突需要谨慎处理                                 │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h4 id="概念-3-回调集成"><a href="#概念-3-回调集成" class="headerlink" title="概念 3: 回调集成"></a>概念 3: 回调集成</h4><p><strong>集成方式</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 方式 1: Before 回调 - 在操作前执行</span></span><br><span class="line">db.Callback().Create().Before(<span class="string">&quot;gorm:create&quot;</span>)</span><br><span class="line">    .Register(<span class="string">&quot;plugin:before&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(db *gorm.DB)</span></span> &#123;</span><br><span class="line">        <span class="comment">// 在创建前执行</span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方式 2: After 回调 - 在操作后执行</span></span><br><span class="line">db.Callback().Query().After(<span class="string">&quot;gorm:query&quot;</span>)</span><br><span class="line">    .Register(<span class="string">&quot;plugin:after&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(db *gorm.DB)</span></span> &#123;</span><br><span class="line">        <span class="comment">// 在查询后执行</span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方式 3: Replace 回调 - 替换默认操作</span></span><br><span class="line">db.Callback().Update().Replace(<span class="string">&quot;gorm:update&quot;</span>)</span><br><span class="line">    .Register(<span class="string">&quot;plugin:replace&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(db *gorm.DB)</span></span> &#123;</span><br><span class="line">        <span class="comment">// 自定义更新逻辑</span></span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>

<p><strong>集成流程图</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│                   插件回调集成流程                            │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br><span class="line"></span><br><span class="line">    用户代码                   GORM 核心                    插件实现</span><br><span class="line">       │                         │                            │</span><br><span class="line">       │ db.Use(&amp;Plugin&#123;&#125;)       │                            │</span><br><span class="line">       ├────────────────────────►│                            │</span><br><span class="line">       │                         │                            │</span><br><span class="line">       │                    Initialize()                       │</span><br><span class="line">       │                         ├──────────────────────────►│</span><br><span class="line">       │                         │                            │</span><br><span class="line">       │                         │  db.Callback().Query()     │</span><br><span class="line">       │                         │  .Before(&quot;gorm:query&quot;)     │</span><br><span class="line">       │                         │  .Register(&quot;plugin&quot;, fn)   │</span><br><span class="line">       │                         │◄───────────────────────────┤</span><br><span class="line">       │                         │                            │</span><br><span class="line">       │  返回 success            │                            │</span><br><span class="line">       │◄─────────────────────────┤                            │</span><br><span class="line">       │                         │                            │</span><br><span class="line">       │                         │                            │</span><br><span class="line">    查询执行时:                  │                            │</span><br><span class="line">       │                         │                            │</span><br><span class="line">       │ db.Find(...)            │                            │</span><br><span class="line">       ├────────────────────────►│                            │</span><br><span class="line">       │                         │                            │</span><br><span class="line">       │                    开始执行 Query                      │</span><br><span class="line">       │                         │                            │</span><br><span class="line">       │              ┌──────────┴──────────┐                 │</span><br><span class="line">       │              ▼                     ▼                 │</span><br><span class="line">       │        Before 回调              GORM 操作            │</span><br><span class="line">       │              │                     │                 │</span><br><span class="line">       │      ┌───────┴───────┐            │                 │</span><br><span class="line">       │      ▼               ▼            │                 │</span><br><span class="line">       │  gorm:query     plugin:callback   │                 │</span><br><span class="line">       │      │               │            │                 │</span><br><span class="line">       │      └───────┬───────┘            │                 │</span><br><span class="line">       │              │                    │                 │</span><br><span class="line">       │              └────────┬───────────┘                 │</span><br><span class="line">       │                       ▼                              │</span><br><span class="line">       │                 After 回调                           │</span><br><span class="line">       │                       │                              │</span><br><span class="line">       │              ┌────────┴────────┐                     │</span><br><span class="line">       │              ▼                 ▼                     │</span><br><span class="line">       │        gorm:query       plugin:callback              │</span><br><span class="line">       │                       │                              │</span><br><span class="line">       │                       ▼                              │</span><br><span class="line">       │                  返回结果                            │</span><br><span class="line">       │◄──────────────────────┤                             │</span><br></pre></td></tr></table></figure>

<p><strong>回调集成示例 - 查询缓存插件</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> CachePlugin <span class="keyword">struct</span> &#123;</span><br><span class="line">    cache CacheClient</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *CachePlugin)</span></span> Name() <span class="type">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;cache:redis&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *CachePlugin)</span></span> Initialize(db *gorm.DB) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="comment">// 注册查询前回调 - 尝试从缓存获取</span></span><br><span class="line">    db.Callback().Query().Before(<span class="string">&quot;gorm:query&quot;</span>)</span><br><span class="line">        .Register(<span class="string">&quot;cache:before&quot;</span>, p.beforeQuery)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册查询后回调 - 更新缓存</span></span><br><span class="line">    db.Callback().Query().After(<span class="string">&quot;gorm:query&quot;</span>)</span><br><span class="line">        .Register(<span class="string">&quot;cache:after&quot;</span>, p.afterQuery)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册创建后回调 - 失效相关缓存</span></span><br><span class="line">    db.Callback().Create().After(<span class="string">&quot;gorm:create&quot;</span>)</span><br><span class="line">        .Register(<span class="string">&quot;cache:invalidate&quot;</span>, p.invalidateCache)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查询前 - 尝试从缓存获取</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *CachePlugin)</span></span> beforeQuery(db *gorm.DB) &#123;</span><br><span class="line">    <span class="comment">// 生成缓存键</span></span><br><span class="line">    key := p.generateCacheKey(db)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 尝试从缓存获取</span></span><br><span class="line">    <span class="keyword">if</span> data, found := p.cache.Get(key); found &#123;</span><br><span class="line">        <span class="comment">// 设置到 Statement 中</span></span><br><span class="line">        db.Statement.Dest = data</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 跳过数据库查询</span></span><br><span class="line">        db.SkipRemaining()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查询后 - 写入缓存</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *CachePlugin)</span></span> afterQuery(db *gorm.DB) &#123;</span><br><span class="line">    <span class="keyword">if</span> db.Error == <span class="literal">nil</span> &#123;</span><br><span class="line">        key := p.generateCacheKey(db)</span><br><span class="line">        p.cache.Set(key, db.Statement.Dest, <span class="number">5</span>*time.Minute)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建后 - 失效缓存</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *CachePlugin)</span></span> invalidateCache(db *gorm.DB) &#123;</span><br><span class="line">    pattern := fmt.Sprintf(<span class="string">&quot;table:%s:*&quot;</span>, db.Statement.Table)</span><br><span class="line">    p.cache.DelPattern(pattern)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="概念-4-插件状态管理"><a href="#概念-4-插件状态管理" class="headerlink" title="概念 4: 插件状态管理"></a>概念 4: 插件状态管理</h4><p><strong>状态存储模式</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 方式 1: 插件内部存储</span></span><br><span class="line"><span class="keyword">type</span> CachePlugin <span class="keyword">struct</span> &#123;</span><br><span class="line">    cache    *redis.Client</span><br><span class="line">    ttl      time.Duration</span><br><span class="line">    keyFunc  <span class="function"><span class="keyword">func</span><span class="params">(*gorm.DB)</span></span> <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *CachePlugin)</span></span> Initialize(db *gorm.DB) <span class="type">error</span> &#123;</span><br><span class="line">    p.cache = redis.NewClient(&amp;redis.Options&#123;</span><br><span class="line">        Addr: <span class="string">&quot;localhost:6379&quot;</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">    p.ttl = <span class="number">5</span> * time.Minute</span><br><span class="line">    p.keyFunc = defaultKeyFunc</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方式 2: 利用 Context</span></span><br><span class="line"><span class="keyword">type</span> ContextKey <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> PluginStateKey ContextKey = <span class="string">&quot;plugin:state&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Plugin)</span></span> beforeQuery(db *gorm.DB) &#123;</span><br><span class="line">    state := &amp;PluginState&#123;</span><br><span class="line">        StartTime: time.Now(),</span><br><span class="line">        QueryHash:  hashQuery(db),</span><br><span class="line">    &#125;</span><br><span class="line">    context.WithValue(db.Statement.Context, PluginStateKey, state)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Plugin)</span></span> afterQuery(db *gorm.DB) &#123;</span><br><span class="line">    state := db.Statement.Context.Value(PluginStateKey).(*PluginState)</span><br><span class="line">    duration := time.Since(state.StartTime)</span><br><span class="line">    <span class="comment">// 记录执行时间...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方式 3: 利用 Statement 中的 Dest</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Plugin)</span></span> beforeQuery(db *gorm.DB) &#123;</span><br><span class="line">    <span class="comment">// 保存原始 Dest</span></span><br><span class="line">    originalDest := db.Statement.Dest</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置回调函数在之后恢复</span></span><br><span class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        db.Statement.Dest = originalDest</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 插件逻辑...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-理论基础"><a href="#2-2-理论基础" class="headerlink" title="2.2 理论基础"></a>2.2 理论基础</h3><h4 id="理论-1-开闭原则-Open-Closed-Principle"><a href="#理论-1-开闭原则-Open-Closed-Principle" class="headerlink" title="理论 1: 开闭原则 (Open-Closed Principle)"></a>理论 1: 开闭原则 (Open-Closed Principle)</h4><p><strong>定义</strong>: 软件实体应该对扩展开放，对修改封闭。</p>
<p><strong>在 GORM 插件系统中的应用</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│                    传统修改方式 (不推荐)                       │</span><br><span class="line">├─────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                              │</span><br><span class="line">│    // 直接修改 GORM 核心代码                                  │</span><br><span class="line">│    func (db *DB) Find(dest interface&#123;&#125;, conds ...interface&#123;&#125;) &#123; │</span><br><span class="line">│        // ... 原有代码 ...                                    │</span><br><span class="line">│                                                              │</span><br><span class="line">│        // 添加缓存逻辑 (修改核心代码!)                         │</span><br><span class="line">│        if cacheData := getFromCache(key); cacheData != nil &#123; │</span><br><span class="line">│            return cacheData                                   │</span><br><span class="line">│        &#125;                                                      │</span><br><span class="line">│    &#125;                                                          │</span><br><span class="line">│                                                              │</span><br><span class="line">│    问题:                                                      │</span><br><span class="line">│    1. 核心代码变得复杂                                         │</span><br><span class="line">│    2. 每个功能都要修改核心                                     │</span><br><span class="line">│    3. 难以维护和升级                                          │</span><br><span class="line">│    4. 无法选择性启用功能                                       │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br><span class="line"></span><br><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│                   插件扩展方式 (推荐)                         │</span><br><span class="line">├─────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                              │</span><br><span class="line">│    // GORM 核心代码保持不变                                   │</span><br><span class="line">│    func (db *DB) Find(dest interface&#123;&#125;, conds ...interface&#123;&#125;) &#123; │</span><br><span class="line">│        // ... 原有代码 ...                                    │</span><br><span class="line">│    &#125;                                                          │</span><br><span class="line">│                                                              │</span><br><span class="line">│    // 通过插件扩展                                            │</span><br><span class="line">│    type CachePlugin struct &#123;&#125;                                │</span><br><span class="line">│                                                              │</span><br><span class="line">│    func (p *CachePlugin) Initialize(db *gorm.DB) error &#123;     │</span><br><span class="line">│        db.Callback().Query().Before(&quot;gorm:query&quot;)            │</span><br><span class="line">│            .Register(&quot;cache&quot;, p.cacheHandler)                │</span><br><span class="line">│        return nil                                            │</span><br><span class="line">│    &#125;                                                          │</span><br><span class="line">│                                                              │</span><br><span class="line">│    // 使用时注册插件                                          │</span><br><span class="line">│    db.Use(&amp;CachePlugin&#123;&#125;)                                    │</span><br><span class="line">│                                                              │</span><br><span class="line">│    优势:                                                      │</span><br><span class="line">│    1. 核心代码保持稳定                                         │</span><br><span class="line">│    2. 功能独立开发                                            │</span><br><span class="line">│    3. 易于维护和升级                                          │</span><br><span class="line">│    4. 可选择性启用                                            │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<p><strong>架构对比</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">违反开闭原则的架构:</span><br><span class="line"></span><br><span class="line">┌──────────────────────────────────────┐</span><br><span class="line">│         应用程序                      │</span><br><span class="line">│  ┌────────┐  ┌────────┐  ┌────────┐  │</span><br><span class="line">│  │ 功能 A │  │ 功能 B │  │ 功能 C │  │</span><br><span class="line">│  └────┬───┘  └────┬───┘  └────┬───┘  │</span><br><span class="line">└───────┼────────────┼────────────┼─────┘</span><br><span class="line">        │            │            │</span><br><span class="line">        ▼            ▼            ▼</span><br><span class="line">┌──────────────────────────────────────┐</span><br><span class="line">│      GORM 核心 (需要修改)              │</span><br><span class="line">│  ┌──────────────────────────────┐   │</span><br><span class="line">│  │  混合了各种功能的代码          │   │</span><br><span class="line">│  │  难以维护和测试                │   │</span><br><span class="line">│  └──────────────────────────────┘   │</span><br><span class="line">└──────────────────────────────────────┘</span><br><span class="line"></span><br><span class="line">符合开闭原则的架构:</span><br><span class="line"></span><br><span class="line">┌──────────────────────────────────────┐</span><br><span class="line">│         应用程序                      │</span><br><span class="line">└───────────────┬──────────────────────┘</span><br><span class="line">                │</span><br><span class="line">                ▼</span><br><span class="line">┌──────────────────────────────────────┐</span><br><span class="line">│      GORM 核心 (稳定不变)              │</span><br><span class="line">│  ┌──────────────────────────────┐   │</span><br><span class="line">│  │  Plugin 接口定义              │   │</span><br><span class="line">│  └───────────┬──────────────────┘   │</span><br><span class="line">└──────────────┼──────────────────────┘</span><br><span class="line">                │</span><br><span class="line">       ┌────────┼────────┐</span><br><span class="line">       ▼        ▼        ▼</span><br><span class="line">   ┌──────┐ ┌──────┐ ┌──────┐</span><br><span class="line">   │插件 A│ │插件 B│ │插件 C│</span><br><span class="line">   └──────┘ └──────┘ └──────┘</span><br></pre></td></tr></table></figure>

<h4 id="理论-2-依赖注入-Dependency-Injection"><a href="#理论-2-依赖注入-Dependency-Injection" class="headerlink" title="理论 2: 依赖注入 (Dependency Injection)"></a>理论 2: 依赖注入 (Dependency Injection)</h4><p><strong>定义</strong>: 将依赖关系的创建和使用分离，通过接口注入依赖。</p>
<p><strong>在 GORM 插件中的应用</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 示例: 读写分离插件</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义数据源接口</span></span><br><span class="line"><span class="keyword">type</span> DataSource <span class="keyword">interface</span> &#123;</span><br><span class="line">    Master() gorm.ConnPool</span><br><span class="line">    Slave() gorm.ConnPool</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 插件实现</span></span><br><span class="line"><span class="keyword">type</span> ReadWritePlugin <span class="keyword">struct</span> &#123;</span><br><span class="line">    dataSource DataSource  <span class="comment">// 依赖接口，不依赖具体实现</span></span><br><span class="line">    selector   *Selector   <span class="comment">// 内部依赖</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过构造函数注入依赖</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewReadWritePlugin</span><span class="params">(ds DataSource)</span></span> *ReadWritePlugin &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;ReadWritePlugin&#123;</span><br><span class="line">        dataSource: ds,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Initialize 接收 DB 实例</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *ReadWritePlugin)</span></span> Initialize(db *gorm.DB) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="comment">// 注入到回调中</span></span><br><span class="line">    db.Callback().Query().Before(<span class="string">&quot;gorm:query&quot;</span>)</span><br><span class="line">        .Register(<span class="string">&quot;rw:select&quot;</span>, p.selectSlave)</span><br><span class="line"></span><br><span class="line">    db.Callback().Create().Before(<span class="string">&quot;gorm:create&quot;</span>)</span><br><span class="line">        .Register(<span class="string">&quot;rw:select&quot;</span>, p.selectMaster)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *ReadWritePlugin)</span></span> selectSlave(db *gorm.DB) &#123;</span><br><span class="line">    db.Statement.ConnPool = p.dataSource.Slave()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *ReadWritePlugin)</span></span> selectMaster(db *gorm.DB) &#123;</span><br><span class="line">    db.Statement.ConnPool = p.dataSource.Master()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>依赖注入的好处</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│                    没有依赖注入                              │</span><br><span class="line">├─────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                              │</span><br><span class="line">│  type Plugin struct &#123;                                        │</span><br><span class="line">│      db *gorm.DB  // 直接依赖具体的 DB                       │</span><br><span class="line">│  &#125;                                                           │</span><br><span class="line">│                                                              │</span><br><span class="line">│  func (p *Plugin) Initialize(db *gorm.DB) error &#123;            │</span><br><span class="line">│      p.db = db  // 存储 DB 引用                              │</span><br><span class="line">│      // 问题: 难以测试，依赖具体实例                          │</span><br><span class="line">│  &#125;                                                            │</span><br><span class="line">│                                                              │</span><br><span class="line">│  测试困难:                                                    │</span><br><span class="line">│  • 需要创建真实的 DB 连接                                     │</span><br><span class="line">│  • 难以模拟不同的场景                                          │</span><br><span class="line">│  • 测试速度慢                                                 │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br><span class="line"></span><br><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│                    有依赖注入                                │</span><br><span class="line">├─────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                              │</span><br><span class="line">│  // 定义接口                                                  │</span><br><span class="line">│  type Database interface &#123;                                   │</span><br><span class="line">│      Query(query string, args ...interface&#123;&#125;)               │</span><br><span class="line">│      Exec(query string, args ...interface&#123;&#125;)                │</span><br><span class="line">│  &#125;                                                           │</span><br><span class="line">│                                                              │</span><br><span class="line">│  type Plugin struct &#123;                                        │</span><br><span class="line">│      db Database  // 依赖接口                                │</span><br><span class="line">│  &#125;                                                           │</span><br><span class="line">│                                                              │</span><br><span class="line">│  func (p *Plugin) Initialize(db *gorm.DB) error &#123;            │</span><br><span class="line">│      // 使用接口包装                                         │</span><br><span class="line">│      p.db = &amp;DatabaseWrapper&#123;db: db&#125;                        │</span><br><span class="line">│  &#125;                                                            │</span><br><span class="line">│                                                              │</span><br><span class="line">│  测试容易:                                                    │</span><br><span class="line">│  • 可以轻松创建 Mock 实现                                     │</span><br><span class="line">│  • 可以控制测试场景                                           │</span><br><span class="line">│  • 测试速度快                                                │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h4 id="理论-3-责任链模式-Chain-of-Responsibility"><a href="#理论-3-责任链模式-Chain-of-Responsibility" class="headerlink" title="理论 3: 责任链模式 (Chain of Responsibility)"></a>理论 3: 责任链模式 (Chain of Responsibility)</h4><p><strong>定义</strong>: 将多个处理器连成一条链，沿着链传递请求，直到有处理器处理它。</p>
<p><strong>在 GORM 回调中的应用</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">回调执行的责任链:</span><br><span class="line"></span><br><span class="line">┌────────────────────────────────────────────────────────────┐</span><br><span class="line">│                      Query 操作                            │</span><br><span class="line">└────────────────────┬───────────────────────────────────────┘</span><br><span class="line">                     │</span><br><span class="line">                     ▼</span><br><span class="line">        ┌──────────────────────────────────┐</span><br><span class="line">        │       Before: Query 回调链         │</span><br><span class="line">        └────────────┬─────────────────────┘</span><br><span class="line">                     │</span><br><span class="line">        ┌────────────┴────────────┐</span><br><span class="line">        │                         │</span><br><span class="line">        ▼                         ▼</span><br><span class="line">┌──────────────┐          ┌──────────────┐</span><br><span class="line">│ plugin:cache │          │ plugin:auth  │</span><br><span class="line">│              │          │              │</span><br><span class="line">│ 1. 检查缓存  │          │ 1. 验证权限  │</span><br><span class="line">│ 2. 命中则跳过 │          │ 2. 通过则继续│</span><br><span class="line">└──────┬───────┘          └──────┬───────┘</span><br><span class="line">       │                         │</span><br><span class="line">       │ [命中]                  │</span><br><span class="line">       ▼                         │</span><br><span class="line">   跳过后续                       │</span><br><span class="line">       │                         │</span><br><span class="line">       │          [未命中/通过]   │</span><br><span class="line">       │                         │</span><br><span class="line">       └────────────┬────────────┘</span><br><span class="line">                    │</span><br><span class="line">                    ▼</span><br><span class="line">        ┌──────────────────────────────────┐</span><br><span class="line">        │     gorm:query (核心查询)          │</span><br><span class="line">        └────────────┬─────────────────────┘</span><br><span class="line">                     │</span><br><span class="line">                     ▼</span><br><span class="line">        ┌──────────────────────────────────┐</span><br><span class="line">        │       After: Query 回调链          │</span><br><span class="line">        └────────────┬─────────────────────┘</span><br><span class="line">                     │</span><br><span class="line">        ┌────────────┴────────────┐</span><br><span class="line">        │                         │</span><br><span class="line">        ▼                         ▼</span><br><span class="line">┌──────────────┐          ┌──────────────┐</span><br><span class="line">│plugin:logger │          │plugin:metric │</span><br><span class="line">│              │          │              │</span><br><span class="line">│ 1. 记录日志  │          │ 1. 收集指标  │</span><br><span class="line">│ 2. 继续传递  │          │ 2. 继续传递  │</span><br><span class="line">└──────┬───────┘          └──────┬───────┘</span><br><span class="line">       │                         │</span><br><span class="line">       └────────────┬────────────┘</span><br><span class="line">                    │</span><br><span class="line">                    ▼</span><br><span class="line">              返回结果</span><br></pre></td></tr></table></figure>

<p><strong>插件协作示例</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 插件 1: 缓存插件</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *CachePlugin)</span></span> Initialize(db *gorm.DB) <span class="type">error</span> &#123;</span><br><span class="line">    db.Callback().Query().Before(<span class="string">&quot;gorm:query&quot;</span>)</span><br><span class="line">        .Register(<span class="string">&quot;cache:check&quot;</span>, p.checkCache)</span><br><span class="line">    db.Callback().Query().After(<span class="string">&quot;gorm:query&quot;</span>)</span><br><span class="line">        .Register(<span class="string">&quot;cache:update&quot;</span>, p.updateCache)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 插件 2: 权限插件</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *AuthPlugin)</span></span> Initialize(db *gorm.DB) <span class="type">error</span> &#123;</span><br><span class="line">    db.Callback().Query().Before(<span class="string">&quot;gorm:query&quot;</span>)</span><br><span class="line">        .Register(<span class="string">&quot;auth:check&quot;</span>, <span class="string">&quot;cache:check&quot;</span>)  <span class="comment">// 在缓存检查之后</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 插件 3: 日志插件</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *LogPlugin)</span></span> Initialize(db *gorm.DB) <span class="type">error</span> &#123;</span><br><span class="line">    db.Callback().Query().After(<span class="string">&quot;gorm:query&quot;</span>)</span><br><span class="line">        .Register(<span class="string">&quot;log:query&quot;</span>, p.logQuery)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行顺序:</span></span><br><span class="line"><span class="comment">// 1. cache:check (检查缓存)</span></span><br><span class="line"><span class="comment">// 2. auth:check (检查权限，缓存未命中时)</span></span><br><span class="line"><span class="comment">// 3. gorm:query (执行查询，权限通过且缓存未命中)</span></span><br><span class="line"><span class="comment">// 4. cache:update (更新缓存，查询成功后)</span></span><br><span class="line"><span class="comment">// 5. log:query (记录日志)</span></span><br></pre></td></tr></table></figure>

<h3 id="2-3-学习方法"><a href="#2-3-学习方法" class="headerlink" title="2.3 学习方法"></a>2.3 学习方法</h3><p><strong>方法 1: 分析现有插件</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">推荐学习路径:</span><br><span class="line"></span><br><span class="line">1. GORM 官方插件</span><br><span class="line">   ├─ gorm-prometheus (性能监控)</span><br><span class="line">   ├─ gorm-redis (缓存集成)</span><br><span class="line">   ├─ gorm-encrypt (字段加密)</span><br><span class="line">   └─ gorm-soft-delete (软删除)</span><br><span class="line"></span><br><span class="line">2. 社区插件</span><br><span class="line">   ├─ 读写分离插件</span><br><span class="line">   ├─ 分库分表插件</span><br><span class="line">   ├─ 审计日志插件</span><br><span class="line">   └─ 数据脱敏插件</span><br><span class="line"></span><br><span class="line">3. 学习重点</span><br><span class="line">   ├─ 插件接口实现</span><br><span class="line">   ├─ 回调注册策略</span><br><span class="line">   ├─ 状态管理方式</span><br><span class="line">   └─ 错误处理机制</span><br></pre></td></tr></table></figure>

<p><strong>方法 2: 实践插件开发</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">渐进式开发路径:</span><br><span class="line"></span><br><span class="line">阶段 1: 简单观察者插件</span><br><span class="line">├─ 目标: 记录所有 SQL 查询</span><br><span class="line">├─ 技术: After 回调</span><br><span class="line">├─ 难度: ★☆☆</span><br><span class="line">└─ 验收: 能够正确记录所有查询</span><br><span class="line"></span><br><span class="line">阶段 2: 功能增强插件</span><br><span class="line">├─ 目标: 实现查询缓存</span><br><span class="line">├─ 技术: Before + After 回调</span><br><span class="line">├─ 难度: ★★☆</span><br><span class="line">└─ 验收: 缓存命中率和正确性</span><br><span class="line"></span><br><span class="line">阶段 3: 行为修改插件</span><br><span class="line">├─ 目标: 实现数据脱敏</span><br><span class="line">├─ 技术: Before + After 回调</span><br><span class="line">├─ 难度: ★★★</span><br><span class="line">└─ 验收: 敏感字段自动脱敏</span><br><span class="line"></span><br><span class="line">阶段 4: 复杂功能插件</span><br><span class="line">├─ 目标: 实现读写分离</span><br><span class="line">├─ 技术: Replace 回调 + 连接池管理</span><br><span class="line">├─ 难度: ★★★</span><br><span class="line">└─ 验收: 读写正确路由和负载均衡</span><br></pre></td></tr></table></figure>

<p><strong>方法 3: 调试和测试</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">调试技巧:</span><br><span class="line"></span><br><span class="line">1. 使用 Logger 跟踪</span><br><span class="line">   type DebugPlugin struct &#123;</span><br><span class="line">       name string</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   func (p *DebugPlugin) Initialize(db *gorm.DB) error &#123;</span><br><span class="line">       logger := db.Logger</span><br><span class="line">       logger.Info(context.Background(),</span><br><span class="line">           fmt.Sprintf(&quot;plugin %s initializing&quot;, p.name))</span><br><span class="line"></span><br><span class="line">       db.Callback().Query().Before(&quot;gorm:query&quot;)</span><br><span class="line">           .Register(&quot;debug:before&quot;, func(db *gorm.DB) &#123;</span><br><span class="line">               logger.Info(context.Background(),</span><br><span class="line">                   fmt.Sprintf(&quot;plugin %s: before query&quot;, p.name))</span><br><span class="line">           &#125;)</span><br><span class="line">       return nil</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">2. 打印回调注册顺序</span><br><span class="line">   func printCallbacks(db *gorm.DB, op string) &#123;</span><br><span class="line">       processor := db.Callback().Query()</span><br><span class="line">       // 打印所有注册的回调和它们的顺序</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">3. 使用断言和日志</span><br><span class="line">   func (p *Plugin) handler(db *gorm.DB) &#123;</span><br><span class="line">       fmt.Printf(&quot;Plugin called, SQL: %s\n&quot;, db.Statement.SQL.String())</span><br><span class="line">       // ... 处理逻辑</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">测试策略:</span><br><span class="line"></span><br><span class="line">1. 单元测试</span><br><span class="line">   func TestCachePlugin(t *testing.T) &#123;</span><br><span class="line">       db := setupTestDB()</span><br><span class="line">       plugin := &amp;CachePlugin&#123;&#125;</span><br><span class="line"></span><br><span class="line">       err := plugin.Initialize(db)</span><br><span class="line">       assert.Nil(t, err)</span><br><span class="line"></span><br><span class="line">       // 测试缓存功能...</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">2. 集成测试</span><br><span class="line">   func TestPluginIntegration(t *testing.T) &#123;</span><br><span class="line">       db := setupTestDB()</span><br><span class="line">       db.Use(&amp;CachePlugin&#123;&#125;)</span><br><span class="line">       db.Use(&amp;LogPlugin&#123;&#125;)</span><br><span class="line"></span><br><span class="line">       // 测试插件协作...</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">3. 性能测试</span><br><span class="line">   func BenchmarkPlugin(b *testing.B) &#123;</span><br><span class="line">       db := setupTestDB()</span><br><span class="line">       db.Use(&amp;CachePlugin&#123;&#125;)</span><br><span class="line"></span><br><span class="line">       b.ResetTimer()</span><br><span class="line">       for i := 0; i &lt; b.N; i++ &#123;</span><br><span class="line">           var results []Model</span><br><span class="line">           db.Find(&amp;results)</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-4-实施策略"><a href="#2-4-实施策略" class="headerlink" title="2.4 实施策略"></a>2.4 实施策略</h3><p><strong>策略 1: 插件开发检查清单</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">开发前:</span><br><span class="line">□ 确定插件功能和范围</span><br><span class="line">□ 分析需要的回调点</span><br><span class="line">□ 设计插件状态管理</span><br><span class="line">□ 规划测试策略</span><br><span class="line"></span><br><span class="line">开发中:</span><br><span class="line">□ 实现 Name() 方法</span><br><span class="line">□ 实现 Initialize() 方法</span><br><span class="line">□ 注册必要的回调</span><br><span class="line">□ 实现核心逻辑</span><br><span class="line">□ 添加错误处理</span><br><span class="line"></span><br><span class="line">开发后:</span><br><span class="line">□ 单元测试</span><br><span class="line">□ 集成测试</span><br><span class="line">□ 性能测试</span><br><span class="line">□ 文档编写</span><br><span class="line">□ 示例代码</span><br></pre></td></tr></table></figure>

<p><strong>策略 2: 回调选择指南</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">选择合适的回调点:</span><br><span class="line"></span><br><span class="line">┌────────────────────────────────────────────────────────────┐</span><br><span class="line">│ Create 操作                                                │</span><br><span class="line">├────────────────────────────────────────────────────────────┤</span><br><span class="line">│ Before &quot;gorm:create&quot;                                       │</span><br><span class="line">│ • 数据验证                                                  │</span><br><span class="line">│ • 默认值设置                                                │</span><br><span class="line">│ • 字段自动填充                                              │</span><br><span class="line">│ • 权限检查                                                  │</span><br><span class="line">│                                                            │</span><br><span class="line">│ After &quot;gorm:create&quot;                                        │</span><br><span class="line">│ • 缓存失效                                                  │</span><br><span class="line">│ • 日志记录                                                  │</span><br><span class="line">│ • 事件通知                                                  │</span><br><span class="line">│ • 关联数据创建                                              │</span><br><span class="line">└────────────────────────────────────────────────────────────┘</span><br><span class="line"></span><br><span class="line">┌────────────────────────────────────────────────────────────┐</span><br><span class="line">│ Query 操作                                                 │</span><br><span class="line">├────────────────────────────────────────────────────────────┤</span><br><span class="line">│ Before &quot;gorm:query&quot;                                        │</span><br><span class="line">│ • 缓存检查                                                  │</span><br><span class="line">│ • 查询权限验证                                              │</span><br><span class="line">│ • 查询条件修改                                              │</span><br><span class="line">│ • 分页参数处理                                              │</span><br><span class="line">│                                                            │</span><br><span class="line">│ After &quot;gorm:query&quot;                                         │</span><br><span class="line">│ • 缓存更新                                                  │</span><br><span class="line">│ • 结果脱敏                                                  │</span><br><span class="line">│ • 性能指标收集                                              │</span><br><span class="line">│ • 日志记录                                                  │</span><br><span class="line">└────────────────────────────────────────────────────────────┘</span><br><span class="line"></span><br><span class="line">┌────────────────────────────────────────────────────────────┐</span><br><span class="line">│ Update 操作                                                │</span><br><span class="line">├────────────────────────────────────────────────────────────┤</span><br><span class="line">│ Before &quot;gorm:update&quot;                                       │</span><br><span class="line">│ • 版本号检查                                                │</span><br><span class="line">│ • 更新权限验证                                              │</span><br><span class="line">│ • 变更记录准备                                              │</span><br><span class="line">│ • 字段过滤                                                  │</span><br><span class="line">│                                                            │</span><br><span class="line">│ After &quot;gorm:update&quot;                                        │</span><br><span class="line">│ • 缓存失效                                                  │</span><br><span class="line">│ • 变更日志记录                                              │</span><br><span class="line">│ • 事件触发                                                  │</span><br><span class="line">│ • 关联数据更新                                              │</span><br><span class="line">└────────────────────────────────────────────────────────────┘</span><br><span class="line"></span><br><span class="line">┌────────────────────────────────────────────────────────────┐</span><br><span class="line">│ Delete 操作                                                │</span><br><span class="line">├────────────────────────────────────────────────────────────┤</span><br><span class="line">│ Before &quot;gorm:delete&quot;                                       │</span><br><span class="line">│ • 删除权限检查                                              │</span><br><span class="line">│ • 关联数据检查                                              │</span><br><span class="line">│ • 软删除处理                                                │</span><br><span class="line">│ • 级联删除验证                                              │</span><br><span class="line">│                                                            │</span><br><span class="line">│ After &quot;gorm:delete&quot;                                        │</span><br><span class="line">│ • 缓存失效                                                  │</span><br><span class="line">│ • 删除日志记录                                              │</span><br><span class="line">│ • 关联数据清理                                              │</span><br><span class="line">│ • 存储空间回收                                              │</span><br><span class="line">└────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<p><strong>策略 3: 错误处理最佳实践</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. Initialize 错误处理</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Plugin)</span></span> Initialize(db *gorm.DB) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="comment">// 验证配置</span></span><br><span class="line">    <span class="keyword">if</span> p.config == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;plugin: config is required&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化外部依赖</span></span><br><span class="line">    client, err := NewClient(p.config.Endpoint)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;plugin: failed to create client: %w&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line">    p.client = client</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册回调</span></span><br><span class="line">    db.Callback().Query().Before(<span class="string">&quot;gorm:query&quot;</span>)</span><br><span class="line">        .Register(<span class="string">&quot;plugin&quot;</span>, p.handler)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 回调错误处理</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Plugin)</span></span> handler(db *gorm.DB) &#123;</span><br><span class="line">    <span class="comment">// 不修改 db.Error，避免覆盖原有错误</span></span><br><span class="line">    <span class="keyword">if</span> err := p.process(db); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="comment">// 记录错误但继续执行</span></span><br><span class="line">        db.Logger.Error(context.Background(),</span><br><span class="line">            <span class="string">&quot;plugin handler failed&quot;</span>,</span><br><span class="line">            <span class="string">&quot;error&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 恢复机制</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Plugin)</span></span> handler(db *gorm.DB) &#123;</span><br><span class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> r := <span class="built_in">recover</span>(); r != <span class="literal">nil</span> &#123;</span><br><span class="line">            db.Logger.Error(context.Background(),</span><br><span class="line">                <span class="string">&quot;plugin panic recovered&quot;</span>,</span><br><span class="line">                <span class="string">&quot;panic&quot;</span>, r)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 插件逻辑...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>策略 4: 性能优化建议</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 避免重复初始化</span></span><br><span class="line"><span class="keyword">type</span> Plugin <span class="keyword">struct</span> &#123;</span><br><span class="line">    initialized <span class="type">bool</span></span><br><span class="line">    mu          sync.RWMutex</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Plugin)</span></span> Initialize(db *gorm.DB) <span class="type">error</span> &#123;</span><br><span class="line">    p.mu.Lock()</span><br><span class="line">    <span class="keyword">defer</span> p.mu.Unlock()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> p.initialized &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化逻辑...</span></span><br><span class="line"></span><br><span class="line">    p.initialized = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 缓存频繁访问的数据</span></span><br><span class="line"><span class="keyword">type</span> Plugin <span class="keyword">struct</span> &#123;</span><br><span class="line">    tableCache <span class="keyword">map</span>[<span class="type">string</span>]*TableInfo</span><br><span class="line">    cacheMu    sync.RWMutex</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Plugin)</span></span> getTableInfo(table <span class="type">string</span>) *TableInfo &#123;</span><br><span class="line">    p.cacheMu.RLock()</span><br><span class="line">    info, ok := p.tableCache[table]</span><br><span class="line">    p.cacheMu.RUnlock()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ok &#123;</span><br><span class="line">        <span class="keyword">return</span> info</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    p.cacheMu.Lock()</span><br><span class="line">    <span class="keyword">defer</span> p.cacheMu.Unlock()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 双重检查</span></span><br><span class="line">    <span class="keyword">if</span> info, ok := p.tableCache[table]; ok &#123;</span><br><span class="line">        <span class="keyword">return</span> info</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    info = p.fetchTableInfo(table)</span><br><span class="line">    p.tableCache[table] = info</span><br><span class="line">    <span class="keyword">return</span> info</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 使用对象池</span></span><br><span class="line"><span class="keyword">var</span> bufferPool = sync.Pool&#123;</span><br><span class="line">    New: <span class="function"><span class="keyword">func</span><span class="params">()</span></span> <span class="keyword">interface</span>&#123;&#125; &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">new</span>(bytes.Buffer)</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Plugin)</span></span> process(db *gorm.DB) &#123;</span><br><span class="line">    buf := bufferPool.Get().(*bytes.Buffer)</span><br><span class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        buf.Reset()</span><br><span class="line">        bufferPool.Put(buf)</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用 buf 处理数据...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="三、核心实现"><a href="#三、核心实现" class="headerlink" title="三、核心实现"></a>三、核心实现</h2><h3 id="3-1-插件注册机制"><a href="#3-1-插件注册机制" class="headerlink" title="3.1 插件注册机制"></a>3.1 插件注册机制</h3><p><strong>Use() 方法完整实现</strong> (gorm.go:575-585)</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Use use plugin</span></span><br><span class="line"><span class="comment">// Use 方法用于注册插件到 GORM</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> Use(plugin Plugin) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="comment">// === 第 1 步: 获取插件名称 ===</span></span><br><span class="line">    name := plugin.Name()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 第 2 步: 检查插件是否已注册 ===</span></span><br><span class="line">    <span class="keyword">if</span> _, ok := db.Plugins[name]; ok &#123;</span><br><span class="line">        <span class="comment">// 插件已存在，返回错误</span></span><br><span class="line">        <span class="keyword">return</span> ErrRegistered</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 第 3 步: 调用 Initialize 方法初始化插件 ===</span></span><br><span class="line">    <span class="comment">// 注意：先调用 Initialize，成功后才存储插件</span></span><br><span class="line">    <span class="comment">// 这样如果初始化失败，不会留下不完整的插件</span></span><br><span class="line">    <span class="keyword">if</span> err := plugin.Initialize(db); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 第 4 步: 存储插件到 Plugins map ===</span></span><br><span class="line">    db.Plugins[name] = plugin</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-插件初始化流程"><a href="#3-2-插件初始化流程" class="headerlink" title="3.2 插件初始化流程"></a>3.2 插件初始化流程</h3><p><strong>Initialize() 方法职责</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Initialize 是插件初始化的入口点</span></span><br><span class="line"><span class="comment">// 插件开发者在此方法中完成以下工作：</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *MyPlugin)</span></span> Initialize(db *gorm.DB) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="comment">// === 职责 1: 验证配置 ===</span></span><br><span class="line">    <span class="keyword">if</span> p.config == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;plugin: config is required&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 职责 2: 初始化内部状态 ===</span></span><br><span class="line">    <span class="keyword">if</span> err := p.setup(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;plugin: setup failed: %w&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 职责 3: 注册回调 ===</span></span><br><span class="line">    db.Callback().Query().Before(<span class="string">&quot;gorm:query&quot;</span>)</span><br><span class="line">        .Register(<span class="string">&quot;plugin:before&quot;</span>, p.beforeQuery)</span><br><span class="line"></span><br><span class="line">    db.Callback().Query().After(<span class="string">&quot;gorm:query&quot;</span>)</span><br><span class="line">        .Register(<span class="string">&quot;plugin:after&quot;</span>, p.afterQuery)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-回调系统集成"><a href="#3-3-回调系统集成" class="headerlink" title="3.3 回调系统集成"></a>3.3 回调系统集成</h3><p><strong>回调注册方式</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 方式 1: Before 回调 - 在操作前执行</span></span><br><span class="line">db.Callback().Create().Before(<span class="string">&quot;gorm:create&quot;</span>)</span><br><span class="line">    .Register(<span class="string">&quot;plugin:before&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(db *gorm.DB)</span></span> &#123;</span><br><span class="line">        <span class="comment">// 参数验证、数据预处理</span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方式 2: After 回调 - 在操作后执行</span></span><br><span class="line">db.Callback().Query().After(<span class="string">&quot;gorm:query&quot;</span>)</span><br><span class="line">    .Register(<span class="string">&quot;plugin:after&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(db *gorm.DB)</span></span> &#123;</span><br><span class="line">        <span class="comment">// 结果处理、缓存更新、日志记录</span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方式 3: Replace 回调 - 替换默认操作</span></span><br><span class="line">db.Callback().Update().Replace(<span class="string">&quot;gorm:update&quot;</span>)</span><br><span class="line">    .Register(<span class="string">&quot;plugin:replace&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(db *gorm.DB)</span></span> &#123;</span><br><span class="line">        <span class="comment">// 完全自定义的更新逻辑</span></span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>

<h3 id="3-4-插件状态管理"><a href="#3-4-插件状态管理" class="headerlink" title="3.4 插件状态管理"></a>3.4 插件状态管理</h3><p><strong>状态存储模式</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 模式 1: 插件内部存储</span></span><br><span class="line"><span class="keyword">type</span> CachePlugin <span class="keyword">struct</span> &#123;</span><br><span class="line">    mu     sync.RWMutex</span><br><span class="line">    cache  *redis.Client</span><br><span class="line">    ttl    time.Duration</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 模式 2: 利用 Context</span></span><br><span class="line"><span class="keyword">type</span> contextKey <span class="type">string</span></span><br><span class="line"><span class="keyword">const</span> pluginStateKey contextKey = <span class="string">&quot;plugin:state&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Plugin)</span></span> beforeQuery(db *gorm.DB) &#123;</span><br><span class="line">    state := &amp;PluginState&#123;StartTime: time.Now()&#125;</span><br><span class="line">    ctx := context.WithValue(db.Statement.Context, pluginStateKey, state)</span><br><span class="line">    db.Statement.Context = ctx</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 模式 3: 利用 Statement.Settings</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Plugin)</span></span> beforeQuery(db *gorm.DB) &#123;</span><br><span class="line">    db.Statement.Settings.Store(<span class="string">&quot;key&quot;</span>, <span class="string">&quot;value&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="四、实战代码示例"><a href="#四、实战代码示例" class="headerlink" title="四、实战代码示例"></a>四、实战代码示例</h2><h3 id="4-1-基础插件开发"><a href="#4-1-基础插件开发" class="headerlink" title="4.1 基础插件开发"></a>4.1 基础插件开发</h3><p><strong>查询日志插件</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> plugin</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;context&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;gorm.io/gorm&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> QueryLoggerPlugin <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *QueryLoggerPlugin)</span></span> Name() <span class="type">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;query:logger&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *QueryLoggerPlugin)</span></span> Initialize(db *gorm.DB) <span class="type">error</span> &#123;</span><br><span class="line">    db.Callback().Query().After(<span class="string">&quot;gorm:query&quot;</span>)</span><br><span class="line">        .Register(<span class="string">&quot;query:logger&quot;</span>, p.logQuery)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *QueryLoggerPlugin)</span></span> logQuery(db *gorm.DB) &#123;</span><br><span class="line">    db.Logger.Info(</span><br><span class="line">        db.Statement.Context,</span><br><span class="line">        fmt.Sprintf(<span class="string">&quot;[QUERY] %s - Rows: %d&quot;</span>,</span><br><span class="line">            db.Statement.SQL.String(),</span><br><span class="line">            db.RowsAffected),</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-2-读写分离插件"><a href="#4-2-读写分离插件" class="headerlink" title="4.2 读写分离插件"></a>4.2 读写分离插件</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> plugin</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;gorm.io/gorm&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> DataSource <span class="keyword">interface</span> &#123;</span><br><span class="line">    Master() gorm.ConnPool</span><br><span class="line">    Slave() gorm.ConnPool</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> ReadWritePlugin <span class="keyword">struct</span> &#123;</span><br><span class="line">    dataSource DataSource</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewReadWritePlugin</span><span class="params">(ds DataSource)</span></span> *ReadWritePlugin &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;ReadWritePlugin&#123;dataSource: ds&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *ReadWritePlugin)</span></span> Name() <span class="type">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;read:write:separation&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *ReadWritePlugin)</span></span> Initialize(db *gorm.DB) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="comment">// 读操作路由到从库</span></span><br><span class="line">    db.Callback().Query().Before(<span class="string">&quot;gorm:query&quot;</span>)</span><br><span class="line">        .Register(<span class="string">&quot;rw:slave&quot;</span>, p.selectSlave)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 写操作路由到主库</span></span><br><span class="line">    db.Callback().Create().Before(<span class="string">&quot;gorm:create&quot;</span>)</span><br><span class="line">        .Register(<span class="string">&quot;rw:master&quot;</span>, p.selectMaster)</span><br><span class="line"></span><br><span class="line">    db.Callback().Update().Before(<span class="string">&quot;gorm:update&quot;</span>)</span><br><span class="line">        .Register(<span class="string">&quot;rw:master&quot;</span>, p.selectMaster)</span><br><span class="line"></span><br><span class="line">    db.Callback().Delete().Before(<span class="string">&quot;gorm:delete&quot;</span>)</span><br><span class="line">        .Register(<span class="string">&quot;rw:master&quot;</span>, p.selectMaster)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *ReadWritePlugin)</span></span> selectSlave(db *gorm.DB) &#123;</span><br><span class="line">    <span class="keyword">if</span> slave := p.dataSource.Slave(); slave != <span class="literal">nil</span> &#123;</span><br><span class="line">        db.Statement.ConnPool = slave</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *ReadWritePlugin)</span></span> selectMaster(db *gorm.DB) &#123;</span><br><span class="line">    db.Statement.ConnPool = p.dataSource.Master()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-3-查询缓存插件"><a href="#4-3-查询缓存插件" class="headerlink" title="4.3 查询缓存插件"></a>4.3 查询缓存插件</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> plugin</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;context&quot;</span></span><br><span class="line">    <span class="string">&quot;encoding/json&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line">    <span class="string">&quot;gorm.io/gorm&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> CachePlugin <span class="keyword">struct</span> &#123;</span><br><span class="line">    cache CacheClient</span><br><span class="line">    ttl   time.Duration</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> CacheClient <span class="keyword">interface</span> &#123;</span><br><span class="line">    Get(ctx context.Context, key <span class="type">string</span>, dest <span class="keyword">interface</span>&#123;&#125;) (<span class="type">bool</span>, <span class="type">error</span>)</span><br><span class="line">    Set(ctx context.Context, key <span class="type">string</span>, value <span class="keyword">interface</span>&#123;&#125;, ttl time.Duration) <span class="type">error</span></span><br><span class="line">    Del(ctx context.Context, key <span class="type">string</span>) <span class="type">error</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewCachePlugin</span><span class="params">(client CacheClient, ttl time.Duration)</span></span> *CachePlugin &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;CachePlugin&#123;cache: client, ttl: ttl&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *CachePlugin)</span></span> Name() <span class="type">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;cache:redis&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *CachePlugin)</span></span> Initialize(db *gorm.DB) <span class="type">error</span> &#123;</span><br><span class="line">    db.Callback().Query().Before(<span class="string">&quot;gorm:query&quot;</span>)</span><br><span class="line">        .Register(<span class="string">&quot;cache:before&quot;</span>, p.beforeQuery)</span><br><span class="line"></span><br><span class="line">    db.Callback().Query().After(<span class="string">&quot;gorm:query&quot;</span>)</span><br><span class="line">        .Register(<span class="string">&quot;cache:after&quot;</span>, p.afterQuery)</span><br><span class="line"></span><br><span class="line">    db.Callback().Create().After(<span class="string">&quot;gorm:create&quot;</span>)</span><br><span class="line">        .Register(<span class="string">&quot;cache:invalidate&quot;</span>, p.invalidate)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *CachePlugin)</span></span> beforeQuery(db *gorm.DB) &#123;</span><br><span class="line">    key := p.cacheKey(db)</span><br><span class="line">    <span class="keyword">var</span> data <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">    <span class="keyword">if</span> found, _ := p.cache.Get(db.Statement.Context, key, &amp;data); found &#123;</span><br><span class="line">        json.Unmarshal(data.([]<span class="type">byte</span>), db.Statement.Dest)</span><br><span class="line">        db.SkipRemaining()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *CachePlugin)</span></span> afterQuery(db *gorm.DB) &#123;</span><br><span class="line">    <span class="keyword">if</span> db.Error != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    data, _ := json.Marshal(db.Statement.Dest)</span><br><span class="line">    p.cache.Set(db.Statement.Context, p.cacheKey(db), data, p.ttl)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *CachePlugin)</span></span> invalidate(db *gorm.DB) &#123;</span><br><span class="line">    pattern := fmt.Sprintf(<span class="string">&quot;%s:*&quot;</span>, db.Statement.Table)</span><br><span class="line">    p.cache.Del(db.Statement.Context, pattern)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *CachePlugin)</span></span> cacheKey(db *gorm.DB) <span class="type">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> fmt.Sprintf(<span class="string">&quot;%v:%v&quot;</span>, db.Statement.SQL.String(), db.Statement.Vars)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-4-性能监控插件"><a href="#4-4-性能监控插件" class="headerlink" title="4.4 性能监控插件"></a>4.4 性能监控插件</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> plugin</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;sync&quot;</span></span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line">    <span class="string">&quot;gorm.io/gorm&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> MetricsPlugin <span class="keyword">struct</span> &#123;</span><br><span class="line">    metrics *MetricsCollector</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> MetricsCollector <span class="keyword">struct</span> &#123;</span><br><span class="line">    mu            sync.RWMutex</span><br><span class="line">    queryCount    <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">int64</span></span><br><span class="line">    queryDuration <span class="keyword">map</span>[<span class="type">string</span>]time.Duration</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewMetricsPlugin</span><span class="params">()</span></span> *MetricsPlugin &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;MetricsPlugin&#123;</span><br><span class="line">        metrics: &amp;MetricsCollector&#123;</span><br><span class="line">            queryCount:    <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="type">int64</span>),</span><br><span class="line">            queryDuration: <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]time.Duration),</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *MetricsPlugin)</span></span> Name() <span class="type">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;metrics:collector&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *MetricsPlugin)</span></span> Initialize(db *gorm.DB) <span class="type">error</span> &#123;</span><br><span class="line">    ops := []<span class="keyword">struct</span> &#123;</span><br><span class="line">        name    <span class="type">string</span></span><br><span class="line">        prepare <span class="function"><span class="keyword">func</span><span class="params">(gorm.Callback)</span></span> *gorm.Callback</span><br><span class="line">    &#125;&#123;</span><br><span class="line">        &#123;<span class="string">&quot;query&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c gorm.Callback)</span></span> *gorm.Callback &#123; <span class="keyword">return</span> c.Query() &#125;&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;create&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c gorm.Callback)</span></span> *gorm.Callback &#123; <span class="keyword">return</span> c.Create() &#125;&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;update&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c gorm.Callback)</span></span> *gorm.Callback &#123; <span class="keyword">return</span> c.Update() &#125;&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;delete&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c gorm.Callback)</span></span> *gorm.Callback &#123; <span class="keyword">return</span> c.Delete() &#125;&#125;,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> _, op := <span class="keyword">range</span> ops &#123;</span><br><span class="line">        opName := op.name</span><br><span class="line">        prepare := op.prepare</span><br><span class="line"></span><br><span class="line">        prepare(db.Callback()).Before(<span class="string">&quot;gorm:&quot;</span>+opName)</span><br><span class="line">            .Register(<span class="string">&quot;metrics:before:&quot;</span>+opName, <span class="function"><span class="keyword">func</span><span class="params">(db *gorm.DB)</span></span> &#123;</span><br><span class="line">                db.Statement.Settings.Store(<span class="string">&quot;metrics:start&quot;</span>, time.Now())</span><br><span class="line">            &#125;)</span><br><span class="line"></span><br><span class="line">        prepare(db.Callback()).After(<span class="string">&quot;gorm:&quot;</span>+opName)</span><br><span class="line">            .Register(<span class="string">&quot;metrics:after:&quot;</span>+opName, <span class="function"><span class="keyword">func</span><span class="params">(db *gorm.DB)</span></span> &#123;</span><br><span class="line">                <span class="keyword">if</span> start, ok := db.Statement.Settings.Load(<span class="string">&quot;metrics:start&quot;</span>); ok &#123;</span><br><span class="line">                    duration := time.Since(start.(time.Time))</span><br><span class="line">                    p.metrics.mu.Lock()</span><br><span class="line">                    p.metrics.queryCount[opName]++</span><br><span class="line">                    p.metrics.queryDuration[opName] += duration</span><br><span class="line">                    p.metrics.mu.Unlock()</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *MetricsPlugin)</span></span> GetMetrics() *MetricsCollector &#123;</span><br><span class="line">    <span class="keyword">return</span> p.metrics</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-5-数据脱敏插件"><a href="#4-5-数据脱敏插件" class="headerlink" title="4.5 数据脱敏插件"></a>4.5 数据脱敏插件</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> plugin</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;strings&quot;</span></span><br><span class="line">    <span class="string">&quot;gorm.io/gorm&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> DataMaskingPlugin <span class="keyword">struct</span> &#123;</span><br><span class="line">    rules <span class="keyword">map</span>[<span class="type">string</span>]<span class="function"><span class="keyword">func</span><span class="params">(<span class="type">string</span>)</span></span> <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewDataMaskingPlugin</span><span class="params">()</span></span> *DataMaskingPlugin &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;DataMaskingPlugin&#123;</span><br><span class="line">        rules: <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="function"><span class="keyword">func</span><span class="params">(<span class="type">string</span>)</span></span> <span class="type">string</span>),</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *DataMaskingPlugin)</span></span> Name() <span class="type">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;data:masking&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *DataMaskingPlugin)</span></span> Initialize(db *gorm.DB) <span class="type">error</span> &#123;</span><br><span class="line">    db.Callback().Query().After(<span class="string">&quot;gorm:query&quot;</span>)</span><br><span class="line">        .Register(<span class="string">&quot;masking:after&quot;</span>, p.maskResult)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *DataMaskingPlugin)</span></span> AddRule(field <span class="type">string</span>, fn <span class="function"><span class="keyword">func</span><span class="params">(<span class="type">string</span>)</span></span> <span class="type">string</span>) &#123;</span><br><span class="line">    p.rules[field] = fn</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *DataMaskingPlugin)</span></span> maskResult(db *gorm.DB) &#123;</span><br><span class="line">    <span class="comment">// 实现脱敏逻辑...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 脱敏函数</span></span><br><span class="line"><span class="keyword">var</span> MaskPhone = <span class="function"><span class="keyword">func</span><span class="params">(s <span class="type">string</span>)</span></span> <span class="type">string</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(s) != <span class="number">11</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> s</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> s[:<span class="number">3</span>] + <span class="string">&quot;****&quot;</span> + s[<span class="number">7</span>:]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> MaskEmail = <span class="function"><span class="keyword">func</span><span class="params">(s <span class="type">string</span>)</span></span> <span class="type">string</span> &#123;</span><br><span class="line">    parts := strings.Split(s, <span class="string">&quot;@&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(parts) != <span class="number">2</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> s</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">string</span>(parts[<span class="number">0</span>][<span class="number">0</span>]) + <span class="string">&quot;***@&quot;</span> + parts[<span class="number">1</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="五、可视化流程图"><a href="#五、可视化流程图" class="headerlink" title="五、可视化流程图"></a>五、可视化流程图</h2><h3 id="5-1-插件注册流程"><a href="#5-1-插件注册流程" class="headerlink" title="5.1 插件注册流程"></a>5.1 插件注册流程</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">    用户代码</span><br><span class="line">       │</span><br><span class="line">       │ db.Use(plugin)</span><br><span class="line">       │</span><br><span class="line">       ▼</span><br><span class="line">┌──────────────────┐</span><br><span class="line">│ 获取插件名称       │</span><br><span class="line">│ name=plugin.Name()│</span><br><span class="line">└────────┬─────────┘</span><br><span class="line">         │</span><br><span class="line">         ▼</span><br><span class="line">┌──────────────────┐     ┌──────────────┐</span><br><span class="line">│ 检查是否已注册     │────▶│ 返回错误       │</span><br><span class="line">│ Plugins[name]    │     │ ErrRegistered│</span><br><span class="line">└────────┬─────────┘     └──────────────┘</span><br><span class="line">         │ No</span><br><span class="line">         ▼</span><br><span class="line">┌──────────────────┐</span><br><span class="line">│ 调用 Initialize  │</span><br><span class="line">└────────┬─────────┘</span><br><span class="line">         │</span><br><span class="line">    ┌────┴────┐</span><br><span class="line">    │         │</span><br><span class="line">    ▼         ▼</span><br><span class="line">  成功       失败</span><br><span class="line">    │         │</span><br><span class="line">    │         ▼</span><br><span class="line">    │  ┌──────────────┐</span><br><span class="line">    │  │ 返回错误      │</span><br><span class="line">    │  └──────────────┘</span><br><span class="line">    ▼</span><br><span class="line">┌──────────────────┐</span><br><span class="line">│ 存储插件         │</span><br><span class="line">│ Plugins[name]=p  │</span><br><span class="line">└────────┬─────────┘</span><br><span class="line">         │</span><br><span class="line">         ▼</span><br><span class="line">┌──────────────────┐</span><br><span class="line">│ 返回成功         │</span><br><span class="line">└──────────────────┘</span><br></pre></td></tr></table></figure>

<h3 id="5-2-插件初始化流程"><a href="#5-2-插件初始化流程" class="headerlink" title="5.2 插件初始化流程"></a>5.2 插件初始化流程</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">    plugin.Initialize(db)</span><br><span class="line">            │</span><br><span class="line">            ▼</span><br><span class="line">┌───────────────────────┐</span><br><span class="line">│ 1. 验证配置            │</span><br><span class="line">└───────────┬───────────┘</span><br><span class="line">            │</span><br><span class="line">            ▼</span><br><span class="line">┌───────────────────────┐</span><br><span class="line">│ 2. 初始化状态          │</span><br><span class="line">└───────────┬───────────┘</span><br><span class="line">            │</span><br><span class="line">            ▼</span><br><span class="line">┌───────────────────────┐</span><br><span class="line">│ 3. 注册回调            │</span><br><span class="line">│ ├─ Query.Before       │</span><br><span class="line">│ ├─ Query.After        │</span><br><span class="line">│ ├─ Create.Before      │</span><br><span class="line">│ └─ ...                │</span><br><span class="line">└───────────┬───────────┘</span><br><span class="line">            │</span><br><span class="line">            ▼</span><br><span class="line">┌───────────────────────┐</span><br><span class="line">│ 4. 建立外部连接        │</span><br><span class="line">└───────────┬───────────┘</span><br><span class="line">            │</span><br><span class="line">            ▼</span><br><span class="line">┌───────────────────────┐</span><br><span class="line">│ 5. 返回成功            │</span><br><span class="line">└───────────────────────┘</span><br></pre></td></tr></table></figure>

<h3 id="5-3-回调集成流程"><a href="#5-3-回调集成流程" class="headerlink" title="5.3 回调集成流程"></a>5.3 回调集成流程</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">db.Use(plugin)</span><br><span class="line">       │</span><br><span class="line">       ▼</span><br><span class="line">Initialize(db)</span><br><span class="line">       │</span><br><span class="line">       ├─ db.Callback().Query()</span><br><span class="line">       │   .Before(&quot;gorm:query&quot;)</span><br><span class="line">       │   .Register(&quot;plugin&quot;, fn)</span><br><span class="line">       │</span><br><span class="line">       ▼</span><br><span class="line">执行查询时:</span><br><span class="line">       │</span><br><span class="line">       ▼</span><br><span class="line">┌──────────────┐</span><br><span class="line">│ Before 回调链 │</span><br><span class="line">│              │</span><br><span class="line">│ gorm:query   │</span><br><span class="line">│ plugin:fn    │</span><br><span class="line">└──────┬───────┘</span><br><span class="line">       │</span><br><span class="line">       ▼</span><br><span class="line">┌──────────────┐</span><br><span class="line">│ 执行查询      │</span><br><span class="line">└──────┬───────┘</span><br><span class="line">       │</span><br><span class="line">       ▼</span><br><span class="line">┌──────────────┐</span><br><span class="line">│ After 回调链  │</span><br><span class="line">│              │</span><br><span class="line">│ gorm:query   │</span><br><span class="line">│ plugin:fn    │</span><br><span class="line">└──────┬───────┘</span><br><span class="line">       │</span><br><span class="line">       ▼</span><br><span class="line">   返回结果</span><br></pre></td></tr></table></figure>

<h3 id="5-4-插件系统架构"><a href="#5-4-插件系统架构" class="headerlink" title="5.4 插件系统架构"></a>5.4 插件系统架构</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────┐</span><br><span class="line">│        应用层                   │</span><br><span class="line">│  db.Use(&amp;Plugin&#123;&#125;)              │</span><br><span class="line">└────────────┬────────────────────┘</span><br><span class="line">             │</span><br><span class="line">             ▼</span><br><span class="line">┌─────────────────────────────────┐</span><br><span class="line">│       插件注册层                 │</span><br><span class="line">│  DB.Use(plugin)                 │</span><br><span class="line">│  - plugin.Name()                │</span><br><span class="line">│  - plugin.Initialize(db)        │</span><br><span class="line">│  - Plugins[name]=plugin         │</span><br><span class="line">└────────────┬────────────────────┘</span><br><span class="line">             │</span><br><span class="line">             ▼</span><br><span class="line">┌─────────────────────────────────┐</span><br><span class="line">│       插件接口层                 │</span><br><span class="line">│  type Plugin interface &#123;         │</span><br><span class="line">│      Name() string              │</span><br><span class="line">│      Initialize(*DB) error      │</span><br><span class="line">│  &#125;                             │</span><br><span class="line">└────────────┬────────────────────┘</span><br><span class="line">             │</span><br><span class="line">             ▼</span><br><span class="line">┌─────────────────────────────────┐</span><br><span class="line">│       插件实现层                 │</span><br><span class="line">│  CachePlugin  RWPlugin  Log...  │</span><br><span class="line">└────────────┬────────────────────┘</span><br><span class="line">             │</span><br><span class="line">             ▼</span><br><span class="line">┌─────────────────────────────────┐</span><br><span class="line">│       回调集成层                 │</span><br><span class="line">│  db.Callback().Query()          │</span><br><span class="line">│    .Before(&quot;gorm:query&quot;)        │</span><br><span class="line">│    .Register(&quot;plugin&quot;, fn)      │</span><br><span class="line">└────────────┬────────────────────┘</span><br><span class="line">             │</span><br><span class="line">             ▼</span><br><span class="line">┌─────────────────────────────────┐</span><br><span class="line">│       核心执行层                 │</span><br><span class="line">│  Query  Create  Update  Delete  │</span><br><span class="line">└─────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="六、最佳实践与故障排查"><a href="#六、最佳实践与故障排查" class="headerlink" title="六、最佳实践与故障排查"></a>六、最佳实践与故障排查</h2><h3 id="6-1-开发最佳实践"><a href="#6-1-开发最佳实践" class="headerlink" title="6.1 开发最佳实践"></a>6.1 开发最佳实践</h3><p><strong>插件开发检查清单</strong></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">开发前:</span><br><span class="line">□ 明确插件功能和边界</span><br><span class="line">□ 分析需要拦截的回调点</span><br><span class="line">□ 设计插件状态管理</span><br><span class="line">□ 规划测试策略</span><br><span class="line"></span><br><span class="line">开发中:</span><br><span class="line">□ 实现 Name() 方法</span><br><span class="line">□ 实现 Initialize() 方法</span><br><span class="line">□ 注册必要的回调</span><br><span class="line">□ 添加错误处理</span><br><span class="line">□ 确保幂等性</span><br><span class="line"></span><br><span class="line">开发后:</span><br><span class="line">□ 单元测试</span><br><span class="line">□ 集成测试</span><br><span class="line">□ 性能测试</span><br><span class="line">□ 文档完整</span><br></pre></td></tr></table></figure>

<p><strong>回调选择指南</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Create.Before: 数据验证、默认值、权限检查</span></span><br><span class="line"><span class="comment">// Create.After: 缓存失效、日志记录、事件通知</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Query.Before: 缓存检查、权限验证、条件修改</span></span><br><span class="line"><span class="comment">// Query.After: 缓存更新、结果脱敏、指标收集</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Update.Before: 版本检查、权限验证、变更记录</span></span><br><span class="line"><span class="comment">// Update.After: 缓存失效、变更日志</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Delete.Before: 权限检查、关联检查、软删除</span></span><br><span class="line"><span class="comment">// Delete.After: 缓存失效、删除日志</span></span><br></pre></td></tr></table></figure>

<p><strong>错误处理最佳实践</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Initialize 错误处理</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Plugin)</span></span> Initialize(db *gorm.DB) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> p.config == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;plugin: config required&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    client, err := NewClient(p.config.Endpoint)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;plugin: client: %w&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line">    p.client = client</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 回调错误处理</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Plugin)</span></span> handler(db *gorm.DB) &#123;</span><br><span class="line">    <span class="keyword">if</span> err := p.process(db); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="comment">// 不覆盖 db.Error</span></span><br><span class="line">        db.Logger.Error(context.Background(), <span class="string">&quot;plugin: %v&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Panic 恢复</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Plugin)</span></span> handler(db *gorm.DB) &#123;</span><br><span class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> r := <span class="built_in">recover</span>(); r != <span class="literal">nil</span> &#123;</span><br><span class="line">            db.Logger.Error(context.Background(), <span class="string">&quot;panic: %v&quot;</span>, r)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line">    <span class="comment">// 插件逻辑...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-2-常见问题与解决方案"><a href="#6-2-常见问题与解决方案" class="headerlink" title="6.2 常见问题与解决方案"></a>6.2 常见问题与解决方案</h3><p><strong>问题 1: 插件初始化失败</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 错误</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Plugin)</span></span> Initialize(db *gorm.DB) <span class="type">error</span> &#123;</span><br><span class="line">    db.Callback().Query().Before(<span class="string">&quot;gorm:query&quot;</span>)</span><br><span class="line">        .Register(<span class="string">&quot;plugin&quot;</span>, p.handler)</span><br><span class="line">    <span class="comment">// 忘记 return nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 正确</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Plugin)</span></span> Initialize(db *gorm.DB) <span class="type">error</span> &#123;</span><br><span class="line">    db.Callback().Query().Before(<span class="string">&quot;gorm:query&quot;</span>)</span><br><span class="line">        .Register(<span class="string">&quot;plugin&quot;</span>, p.handler)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>  <span class="comment">// 必须返回</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>问题 2: 插件冲突</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用命名空间避免冲突</span></span><br><span class="line">db.Callback().Query().Before(<span class="string">&quot;gorm:query&quot;</span>)</span><br><span class="line">    .Register(<span class="string">&quot;cache:plugin&quot;</span>, handlerA)</span><br><span class="line"></span><br><span class="line">db.Callback().Query().Before(<span class="string">&quot;gorm:query&quot;</span>)</span><br><span class="line">    .Register(<span class="string">&quot;log:plugin&quot;</span>, handlerB)</span><br></pre></td></tr></table></figure>

<p><strong>问题 3: 并发安全</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用互斥锁</span></span><br><span class="line"><span class="keyword">type</span> Plugin <span class="keyword">struct</span> &#123;</span><br><span class="line">    mu   sync.RWMutex</span><br><span class="line">    data <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Plugin)</span></span> handler(db *gorm.DB) &#123;</span><br><span class="line">    p.mu.Lock()</span><br><span class="line">    p.data[<span class="string">&quot;key&quot;</span>]++</span><br><span class="line">    p.mu.Unlock()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-3-性能优化建议"><a href="#6-3-性能优化建议" class="headerlink" title="6.3 性能优化建议"></a>6.3 性能优化建议</h3><p><strong>避免重复初始化</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Plugin <span class="keyword">struct</span> &#123;</span><br><span class="line">    initialized <span class="type">bool</span></span><br><span class="line">    mu          sync.Mutex</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Plugin)</span></span> Initialize(db *gorm.DB) <span class="type">error</span> &#123;</span><br><span class="line">    p.mu.Lock()</span><br><span class="line">    <span class="keyword">defer</span> p.mu.Unlock()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> p.initialized &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化逻辑...</span></span><br><span class="line">    p.initialized = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>使用对象池</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> bufferPool = sync.Pool&#123;</span><br><span class="line">    New: <span class="function"><span class="keyword">func</span><span class="params">()</span></span> <span class="keyword">interface</span>&#123;&#125; &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">new</span>(bytes.Buffer)</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Plugin)</span></span> process(db *gorm.DB) &#123;</span><br><span class="line">    buf := bufferPool.Get().(*bytes.Buffer)</span><br><span class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        buf.Reset()</span><br><span class="line">        bufferPool.Put(buf)</span><br><span class="line">    &#125;()</span><br><span class="line">    <span class="comment">// 使用 buf...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-4-安全建议"><a href="#6-4-安全建议" class="headerlink" title="6.4 安全建议"></a>6.4 安全建议</h3><p><strong>敏感数据过滤</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Plugin)</span></span> logQuery(db *gorm.DB) &#123;</span><br><span class="line">    vars := p.filterSensitive(db.Statement.Vars)</span><br><span class="line">    db.Logger.Info(context.Background(),</span><br><span class="line">        db.Statement.SQL.String(), vars...)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>权限验证</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Plugin)</span></span> beforeQuery(db *gorm.DB) &#123;</span><br><span class="line">    user := getCurrentUser(db.Statement.Context)</span><br><span class="line">    <span class="keyword">if</span> !p.hasPermission(user, db.Statement.Table) &#123;</span><br><span class="line">        db.Error = ErrPermissionDenied</span><br><span class="line">        db.SkipRemaining()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="七、学习验证"><a href="#七、学习验证" class="headerlink" title="七、学习验证"></a>七、学习验证</h2><h3 id="7-1-知识自测"><a href="#7-1-知识自测" class="headerlink" title="7.1 知识自测"></a>7.1 知识自测</h3><p><strong>基础题</strong></p>
<ol>
<li><p>Plugin 接口包含哪两个方法？</p>
<ul>
<li>A. Name() 和 Initialize()</li>
<li>B. Name() 和 Setup()</li>
<li>C. Init() 和 Start()</li>
</ul>
</li>
<li><p>插件注册使用哪个方法？</p>
<ul>
<li>A. db.Register()</li>
<li>B. db.Use()</li>
<li>C. db.Add()</li>
</ul>
</li>
<li><p>Before、After 和 Replace 回调的主要区别是什么？</p>
<ul>
<li>A. 执行时机和行为不同</li>
<li>B. 参数不同</li>
<li>C. 返回值不同</li>
</ul>
</li>
<li><p>如何避免插件名称冲突？</p>
<ul>
<li>A. 使用命名空间</li>
<li>B. 使用随机名称</li>
<li>C. 不需要避免</li>
</ul>
</li>
<li><p>插件初始化失败会怎样？</p>
<ul>
<li>A. 忽略错误继续</li>
<li>B. 返回错误，插件不注册</li>
<li>C. 自动重试</li>
</ul>
</li>
</ol>
<p><strong>进阶题</strong></p>
<ol>
<li><p>如何实现查询缓存插件？需要注册哪些回调？</p>
<ul>
<li>Query.Before (检查缓存)</li>
<li>Query.After (更新缓存)</li>
<li>Write.After (失效缓存)</li>
</ul>
</li>
<li><p>读写分离插件如何区分读写操作？</p>
<ul>
<li>Query → 从库</li>
<li>Create&#x2F;Update&#x2F;Delete → 主库</li>
</ul>
</li>
<li><p>如何处理插件间的依赖关系？</p>
<ul>
<li>控制注册顺序</li>
<li>使用回调排序</li>
<li>使用共享状态</li>
</ul>
</li>
<li><p>如何实现并发安全？</p>
<ul>
<li>使用 sync.Mutex</li>
<li>使用 sync.RWMutex</li>
<li>使用 atomic</li>
</ul>
</li>
<li><p>如何调试插件？</p>
<ul>
<li>使用 Logger</li>
<li>打印回调顺序</li>
<li>使用断点</li>
</ul>
</li>
</ol>
<p><strong>实战题</strong></p>
<ol>
<li>实现慢查询日志插件</li>
<li>实现审计日志插件</li>
<li>实现查询结果缓存插件</li>
</ol>
<h3 id="7-2-实践练习"><a href="#7-2-实践练习" class="headerlink" title="7.2 实践练习"></a>7.2 实践练习</h3><p><strong>练习 1: 查询计数插件</strong></p>
<p>统计每种操作的执行次数。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> CountPlugin <span class="keyword">struct</span> &#123;</span><br><span class="line">    mu    sync.RWMutex</span><br><span class="line">    counts <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">int64</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *CountPlugin)</span></span> Name() <span class="type">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;query:counter&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *CountPlugin)</span></span> Initialize(db *gorm.DB) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="comment">// 实现...</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *CountPlugin)</span></span> GetStats() <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">int64</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> p.counts</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>练习 2: 查询超时插件</strong></p>
<p>为查询设置超时时间。</p>
<p><strong>练习 3: 数据加密插件</strong></p>
<p>自动加密敏感字段。</p>
<pre><code>
</code></pre>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a target="_blank" rel="noopener" href="https://github.com/Piwriw">Joohwan.</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://piwriw.github.io/2026/01/11/web/gorm/10-plugin/">https://piwriw.github.io/2026/01/11/web/gorm/10-plugin/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://piwriw.github.io" target="_blank">Joohwan</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/web/">web</a><a class="post-meta__tags" href="/tags/Gorm/">Gorm</a><a class="post-meta__tags" href="/tags/%E6%BA%90%E7%A0%81/">源码</a></div><div class="post-share"><div class="social-share" data-image="/img/go.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>赞助</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2026/01/11/web/gorm/09-logger/" title="Gorm-日志系统模块原理说明"><img class="cover" src="/img/go.png" onerror="onerror=null;src='/img/404.png'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">Gorm-日志系统模块原理说明</div></div><div class="info-2"><div class="info-item-1">日志系统模块原理说明 基于1.31 本文档深入解析日志系统模块的设计原理和核心实现，涵盖 SQL 日志记录、性能分析、调用栈追踪等核心内容。学习完本文档后，您将能够彻底理解 GORM 日志系统的工作机制，并能够实现自定义 Logger 来满足各种日志需求。  文档目录12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394959697989910010110210310410510610710810911011111211311411511611711811912012112212312412512612712812913013113213313413513613713813914009-logger.md├── 一、设计原理│   ├── 1.1 模块定位│   ├── 1.2 设...</div></div></div></a><a class="pagination-related" href="/2026/01/11/web/gorm/08-migration/" title="Gorm-迁移功能模块原理说明"><img class="cover" src="/img/go.png" onerror="onerror=null;src='/img/404.png'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">Gorm-迁移功能模块原理说明</div></div><div class="info-2"><div class="info-item-1">迁移功能模块原理说明 基于1.31 本文档深入解析迁移功能模块的设计原理和核心实现，涵盖数据库结构管理、类型映射、约束管理等核心内容。学习完本文档后，您将能够彻底理解 GORM 迁移系统的工作机制，并能够在实际项目中安全高效地进行数据库迁移。  文档目录1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798991001011021031041051061071081091101111121131141151161171181191201211221231241251261271281291301311321331341351361371381391401411421431441451461471481491501511521531541551561571581591...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2026/01/11/web/gorm/09-logger/" title="Gorm-日志系统模块原理说明"><img class="cover" src="/img/go.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-01-11</div><div class="info-item-2">Gorm-日志系统模块原理说明</div></div><div class="info-2"><div class="info-item-1">日志系统模块原理说明 基于1.31 本文档深入解析日志系统模块的设计原理和核心实现，涵盖 SQL 日志记录、性能分析、调用栈追踪等核心内容。学习完本文档后，您将能够彻底理解 GORM 日志系统的工作机制，并能够实现自定义 Logger 来满足各种日志需求。  文档目录12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394959697989910010110210310410510610710810911011111211311411511611711811912012112212312412512612712812913013113213313413513613713813914009-logger.md├── 一、设计原理│   ├── 1.1 模块定位│   ├── 1.2 设...</div></div></div></a><a class="pagination-related" href="/2026/01/11/web/gorm/08-migration/" title="Gorm-迁移功能模块原理说明"><img class="cover" src="/img/go.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-01-11</div><div class="info-item-2">Gorm-迁移功能模块原理说明</div></div><div class="info-2"><div class="info-item-1">迁移功能模块原理说明 基于1.31 本文档深入解析迁移功能模块的设计原理和核心实现，涵盖数据库结构管理、类型映射、约束管理等核心内容。学习完本文档后，您将能够彻底理解 GORM 迁移系统的工作机制，并能够在实际项目中安全高效地进行数据库迁移。  文档目录1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798991001011021031041051061071081091101111121131141151161171181191201211221231241251261271281291301311321331341351361371381391401411421431441451461471481491501511521531541551561571581591...</div></div></div></a><a class="pagination-related" href="/2026/01/11/web/gorm/07-transaction/" title="Gorm-事务处理模块原理说明"><img class="cover" src="/img/go.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-01-11</div><div class="info-item-2">Gorm-事务处理模块原理说明</div></div><div class="info-2"><div class="info-item-1">事务处理模块原理说明 基于1.31 本文档深入解析事务处理模块的设计原理和核心实现，涵盖事务管理、嵌套事务、保存点机制等核心内容。通过阅读本文档，您将能够完全理解 GORM 事务处理模块的工作原理，无需额外阅读源码。   目录 一、设计原理 1.1 模块定位 1.2 设计目的 1.3 结构安排依据 1.4 与其他模块的逻辑关系   二、核心数据结构 2.1 事务相关接口 2.2 TxOptions 配置   三、事务核心实现 3.1 Transaction 函数完整实现 3.2 Begin 函数完整实现 3.3 Commit 和 Rollback 实现 3.4 SavePoint 和 RollbackTo 实现 3.5 事务执行流程图   四、默认事务机制 4.1 BeginTransaction 实现 4.2 CommitOrRollbackTransaction 实现 4.3 回调注册流程 4.4 默认事务流程图   五、实战代码示例 5.1 基础事务使用 5.2 嵌套事务使用 5.3 手动事务控制 5.4 保存点使用 5.5 隔离级别配置 5.6 复杂业务场景   六、最佳...</div></div></div></a><a class="pagination-related" href="/2026/01/11/web/gorm/06-associations/" title="Gorm-关联关系模块原理说明"><img class="cover" src="/img/go.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-01-11</div><div class="info-item-2">Gorm-关联关系模块原理说明</div></div><div class="info-2"><div class="info-item-1">关联关系模块原理说明  基于1.31 本文档深入解析关联关系模块的设计原理和核心实现，涵盖关系推断、预加载机制、N+1 问题解决、Association API 等核心内容。通过阅读本文档，您将能够完全理解 GORM 关联关系模块的工作原理，无需额外阅读源码。   目录 一、设计原理 1.1 模块定位 1.2 设计目的 1.3 结构安排依据 1.4 与其他模块的逻辑关系   二、核心数据结构 2.1 Relationship 结构完整解析 2.2 Relationships 结构 2.3 Reference 结构 2.4 Polymorphic 结构   三、关系推断机制 3.1 parseRelation 函数完整实现 3.2 guessRelation 函数完整实现 3.3 buildPolymorphicRelation 实现 3.4 buildMany2ManyRelation 实现 3.5 关系推断决策树   四、预加载机制 4.1 preloadEntryPoint 完整实现 4.2 preload 函数完整实现 4.3 Preload 执行流程图 4.4 嵌套预加载...</div></div></div></a><a class="pagination-related" href="/2026/01/11/web/gorm/05-callback/" title="Gorm-回调钩子模块原理说明"><img class="cover" src="/img/go.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-01-11</div><div class="info-item-2">Gorm-回调钩子模块原理说明</div></div><div class="info-2"><div class="info-item-1">回调钩子模块原理说明 基于1.31 本文档深入解析回调钩子模块的设计原理和核心原理，涵盖事件驱动机制、责任链模式、钩子注册与执行等核心内容。   一、设计原理1.1 模块定位在整体架构中的位置 回调钩子模块是 GORM 的事件驱动层，位于查询构建和 SQL 执行之间，负责在数据操作的生命周期中插入自定义逻辑。 1234567891011121314151617181920212223242526272829303132333435┌─────────────────────────────────────────────────────────────┐│                    Finisher API                              ││                      db.Find(&amp;users)                         │└────────────────────────┬────────────────────────────────────┘                      ...</div></div></div></a><a class="pagination-related" href="/2026/01/11/web/gorm/04-clause/" title="Gorm-子句系统模块原理说明"><img class="cover" src="/img/go.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-01-11</div><div class="info-item-2">Gorm-子句系统模块原理说明</div></div><div class="info-2"><div class="info-item-1">子句系统模块原理说明 基于1.31 本文档深入解析子句系统模块的设计原理和核心原理，阐述 SQL 组件化构建的理论基础。   一、设计原理1.1 模块定位在整体架构中的位置 子句系统是 GORM SQL 构建的核心组件化引擎，位于 Statement 层之下，直接负责将用户意图转换为 SQL 片段。 1234567891011121314151617181920212223242526┌─────────────────────────────────────────────────────────────┐│                   用户 API 调用                               ││  db.Where(&quot;age &gt; ?&quot;, 18).Order(&quot;name&quot;).Limit(10)           │└────────────────────────┬────────────────────────────────────┘                         │ 解析意图...</div></div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Joohwan.</div><div class="author-info-description">该知道的都知道，不知道的慢慢了解</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">259</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">76</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">60</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/piwriw"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/piwriw" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:piwriw@163.com" target="_blank" title="Email"><i class="fas fa-envelope-open-text"></i></a></div></div><div class="card-widget"><div class="item-headline"><i class="iconfont icat-visitor"></i><span>来访者</span></div><div class="item-content"><div id="welcome-info"></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%8F%92%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%A8%A1%E5%9D%97%E5%8E%9F%E7%90%86%E8%AF%B4%E6%98%8E"><span class="toc-number">1.</span> <span class="toc-text">插件系统模块原理说明</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%AE%E5%BD%95"><span class="toc-number">1.1.</span> <span class="toc-text">目录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E8%AE%BE%E8%AE%A1%E5%8E%9F%E7%90%86"><span class="toc-number">1.2.</span> <span class="toc-text">一、设计原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E6%A8%A1%E5%9D%97%E5%AE%9A%E4%BD%8D"><span class="toc-number">1.2.1.</span> <span class="toc-text">1.1 模块定位</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E8%AE%BE%E8%AE%A1%E7%9B%AE%E7%9A%84"><span class="toc-number">1.2.2.</span> <span class="toc-text">1.2 设计目的</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-%E7%BB%93%E6%9E%84%E5%AE%89%E6%8E%92%E4%BE%9D%E6%8D%AE"><span class="toc-number">1.2.3.</span> <span class="toc-text">1.3 结构安排依据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-%E4%B8%8E%E5%85%B6%E4%BB%96%E6%A8%A1%E5%9D%97%E7%9A%84%E9%80%BB%E8%BE%91%E5%85%B3%E7%B3%BB"><span class="toc-number">1.2.4.</span> <span class="toc-text">1.4 与其他模块的逻辑关系</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5-%E6%8F%92%E4%BB%B6%E7%B1%BB%E5%9E%8B%E5%88%86%E7%B1%BB"><span class="toc-number">1.2.5.</span> <span class="toc-text">1.5 插件类型分类</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E6%A0%B8%E5%BF%83%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-number">1.3.</span> <span class="toc-text">二、核心数据结构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-Plugin-%E6%8E%A5%E5%8F%A3"><span class="toc-number">1.3.1.</span> <span class="toc-text">2.1 Plugin 接口</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5-2-%E6%8F%92%E4%BB%B6%E6%B3%A8%E5%86%8C"><span class="toc-number">1.3.1.1.</span> <span class="toc-text">概念 2: 插件注册</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5-3-%E5%9B%9E%E8%B0%83%E9%9B%86%E6%88%90"><span class="toc-number">1.3.1.2.</span> <span class="toc-text">概念 3: 回调集成</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5-4-%E6%8F%92%E4%BB%B6%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86"><span class="toc-number">1.3.1.3.</span> <span class="toc-text">概念 4: 插件状态管理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E7%90%86%E8%AE%BA%E5%9F%BA%E7%A1%80"><span class="toc-number">1.3.2.</span> <span class="toc-text">2.2 理论基础</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%90%86%E8%AE%BA-1-%E5%BC%80%E9%97%AD%E5%8E%9F%E5%88%99-Open-Closed-Principle"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">理论 1: 开闭原则 (Open-Closed Principle)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%90%86%E8%AE%BA-2-%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5-Dependency-Injection"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">理论 2: 依赖注入 (Dependency Injection)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%90%86%E8%AE%BA-3-%E8%B4%A3%E4%BB%BB%E9%93%BE%E6%A8%A1%E5%BC%8F-Chain-of-Responsibility"><span class="toc-number">1.3.2.3.</span> <span class="toc-text">理论 3: 责任链模式 (Chain of Responsibility)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E5%AD%A6%E4%B9%A0%E6%96%B9%E6%B3%95"><span class="toc-number">1.3.3.</span> <span class="toc-text">2.3 学习方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-%E5%AE%9E%E6%96%BD%E7%AD%96%E7%95%A5"><span class="toc-number">1.3.4.</span> <span class="toc-text">2.4 实施策略</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E6%A0%B8%E5%BF%83%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.4.</span> <span class="toc-text">三、核心实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E6%8F%92%E4%BB%B6%E6%B3%A8%E5%86%8C%E6%9C%BA%E5%88%B6"><span class="toc-number">1.4.1.</span> <span class="toc-text">3.1 插件注册机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E6%8F%92%E4%BB%B6%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B"><span class="toc-number">1.4.2.</span> <span class="toc-text">3.2 插件初始化流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E5%9B%9E%E8%B0%83%E7%B3%BB%E7%BB%9F%E9%9B%86%E6%88%90"><span class="toc-number">1.4.3.</span> <span class="toc-text">3.3 回调系统集成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-%E6%8F%92%E4%BB%B6%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86"><span class="toc-number">1.4.4.</span> <span class="toc-text">3.4 插件状态管理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E5%AE%9E%E6%88%98%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.5.</span> <span class="toc-text">四、实战代码示例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E5%9F%BA%E7%A1%80%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91"><span class="toc-number">1.5.1.</span> <span class="toc-text">4.1 基础插件开发</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB%E6%8F%92%E4%BB%B6"><span class="toc-number">1.5.2.</span> <span class="toc-text">4.2 读写分离插件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-%E6%9F%A5%E8%AF%A2%E7%BC%93%E5%AD%98%E6%8F%92%E4%BB%B6"><span class="toc-number">1.5.3.</span> <span class="toc-text">4.3 查询缓存插件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E6%8F%92%E4%BB%B6"><span class="toc-number">1.5.4.</span> <span class="toc-text">4.4 性能监控插件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-%E6%95%B0%E6%8D%AE%E8%84%B1%E6%95%8F%E6%8F%92%E4%BB%B6"><span class="toc-number">1.5.5.</span> <span class="toc-text">4.5 数据脱敏插件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E5%8F%AF%E8%A7%86%E5%8C%96%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="toc-number">1.6.</span> <span class="toc-text">五、可视化流程图</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-%E6%8F%92%E4%BB%B6%E6%B3%A8%E5%86%8C%E6%B5%81%E7%A8%8B"><span class="toc-number">1.6.1.</span> <span class="toc-text">5.1 插件注册流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-%E6%8F%92%E4%BB%B6%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B"><span class="toc-number">1.6.2.</span> <span class="toc-text">5.2 插件初始化流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-%E5%9B%9E%E8%B0%83%E9%9B%86%E6%88%90%E6%B5%81%E7%A8%8B"><span class="toc-number">1.6.3.</span> <span class="toc-text">5.3 回调集成流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-%E6%8F%92%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84"><span class="toc-number">1.6.4.</span> <span class="toc-text">5.4 插件系统架构</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E3%80%81%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E4%B8%8E%E6%95%85%E9%9A%9C%E6%8E%92%E6%9F%A5"><span class="toc-number">1.7.</span> <span class="toc-text">六、最佳实践与故障排查</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-%E5%BC%80%E5%8F%91%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">1.7.1.</span> <span class="toc-text">6.1 开发最佳实践</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E4%B8%8E%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">1.7.2.</span> <span class="toc-text">6.2 常见问题与解决方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E5%BB%BA%E8%AE%AE"><span class="toc-number">1.7.3.</span> <span class="toc-text">6.3 性能优化建议</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4-%E5%AE%89%E5%85%A8%E5%BB%BA%E8%AE%AE"><span class="toc-number">1.7.4.</span> <span class="toc-text">6.4 安全建议</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83%E3%80%81%E5%AD%A6%E4%B9%A0%E9%AA%8C%E8%AF%81"><span class="toc-number">1.8.</span> <span class="toc-text">七、学习验证</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-%E7%9F%A5%E8%AF%86%E8%87%AA%E6%B5%8B"><span class="toc-number">1.8.1.</span> <span class="toc-text">7.1 知识自测</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-%E5%AE%9E%E8%B7%B5%E7%BB%83%E4%B9%A0"><span class="toc-number">1.8.2.</span> <span class="toc-text">7.2 实践练习</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2026/01/11/web/gorm/09-logger/" title="Gorm-日志系统模块原理说明"><img src="/img/go.png" onerror="this.onerror=null;this.src='/img/404.png'" alt="Gorm-日志系统模块原理说明"/></a><div class="content"><a class="title" href="/2026/01/11/web/gorm/09-logger/" title="Gorm-日志系统模块原理说明">Gorm-日志系统模块原理说明</a><time datetime="2026-01-11T11:56:27.000Z" title="发表于 2026-01-11 19:56:27">2026-01-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2026/01/11/web/gorm/08-migration/" title="Gorm-迁移功能模块原理说明"><img src="/img/go.png" onerror="this.onerror=null;this.src='/img/404.png'" alt="Gorm-迁移功能模块原理说明"/></a><div class="content"><a class="title" href="/2026/01/11/web/gorm/08-migration/" title="Gorm-迁移功能模块原理说明">Gorm-迁移功能模块原理说明</a><time datetime="2026-01-11T10:56:27.000Z" title="发表于 2026-01-11 18:56:27">2026-01-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2026/01/11/web/gorm/10-plugin/" title="Gorm-插件系统模块原理说明"><img src="/img/go.png" onerror="this.onerror=null;this.src='/img/404.png'" alt="Gorm-插件系统模块原理说明"/></a><div class="content"><a class="title" href="/2026/01/11/web/gorm/10-plugin/" title="Gorm-插件系统模块原理说明">Gorm-插件系统模块原理说明</a><time datetime="2026-01-11T10:56:27.000Z" title="发表于 2026-01-11 18:56:27">2026-01-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2026/01/11/web/gorm/07-transaction/" title="Gorm-事务处理模块原理说明"><img src="/img/go.png" onerror="this.onerror=null;this.src='/img/404.png'" alt="Gorm-事务处理模块原理说明"/></a><div class="content"><a class="title" href="/2026/01/11/web/gorm/07-transaction/" title="Gorm-事务处理模块原理说明">Gorm-事务处理模块原理说明</a><time datetime="2026-01-11T09:56:27.000Z" title="发表于 2026-01-11 17:56:27">2026-01-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2026/01/11/web/gorm/06-associations/" title="Gorm-关联关系模块原理说明"><img src="/img/go.png" onerror="this.onerror=null;this.src='/img/404.png'" alt="Gorm-关联关系模块原理说明"/></a><div class="content"><a class="title" href="/2026/01/11/web/gorm/06-associations/" title="Gorm-关联关系模块原理说明">Gorm-关联关系模块原理说明</a><time datetime="2026-01-11T08:56:27.000Z" title="发表于 2026-01-11 16:56:27">2026-01-11</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2023 - 2026 By Joohwan.</span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
  const option = null

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://piwriw-twikoo-git-main-piwriw.vercel.app/',
      region: 'ap-shanghai',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const init = (el = document, path = location.pathname) => {
    twikoo.init({
      el: el.querySelector('#twikoo-wrap'),
      envId: 'https://piwriw-twikoo-git-main-piwriw.vercel.app/',
      region: 'ap-shanghai',
      onCommentLoaded: () => {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      },
      ...option,
      path: isShuoshuo ? path : (option && option.path) || path
    })

    

    isShuoshuo && (window.shuoshuoComment.destroyTwikoo = () => {
      if (el.children.length) {
        el.innerHTML = ''
        el.classList.add('no-comment')
      }
    })
  }

  const loadTwikoo = (el, path) => {
    if (typeof twikoo === 'object') setTimeout(() => init(el, path), 0)
    else btf.getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(() => init(el, path))
  }

  if (isShuoshuo) {
    'Twikoo' === 'Twikoo'
      ? window.shuoshuoComment = { loadComment: loadTwikoo }
      : window.loadOtherComment = loadTwikoo
    return
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script></div><script src="/js/categories.js" defer></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>